{
    "src/ai/genkit.ts": "import {genkit} from 'genkit';\nimport {googleAI} from '@genkit-ai/google-genai';\n\nexport const ai = genkit({\n  plugins: [googleAI()],\n  model: 'googleai/gemini-pro',\n});\n",
    "src/ai/genkit.config.ts": "import { genkit } from 'genkit';\nimport { googleAI } from '@genkit-ai/google-genai';\n\n// Adapting configuration to Genkit v1.25+ structure\n// Note: gemini15Flash export not found, using string identifier\nexport default genkit({\n  plugins: [googleAI()],\n  model: 'gemini-1.5-flash',\n});\n",
    "src/ai/dev.ts": "// Flows will be imported for their side effects in this file.\n",
    "src/data/room_types_data.json": "[\n  {\n      \"id\": \"almacen_de_alcohol\",\n      \"nombre\": \"Almacén de alcohol\",\n      \"descripcion\": \"Ya que la destilación de alcohol es bastante sencilla, la producción es alta. Para poder almacenarlo sin perder el exceso de producción, necesitas construir un almacén de alcohol. En el mismo, estará a salvo de los enemigos.\",\n      \"urlImagen\": \"/img/hab/almacen_alc.webp\",\n      \"costoArmas\": 200,\n      \"costoMunicion\": 200,\n      \"costoDolares\": 0,\n      \"duracion\": 750,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 7,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 11:08:00.923125+00\"\n  },\n  {\n      \"id\": \"almacen_de_armas\",\n      \"nombre\": \"Almacén de armas\",\n      \"descripcion\": \"En el almacén de armas, se guarda todo el armamento que no se necesita de inmediato. El proceso es automático, y se mantienen allí hasta que sean necesarias. Además, ningún enemigo podrá robártelas de este almacén.\",\n      \"urlImagen\": \"/img/hab/almacen_arm.webp\",\n      \"costoArmas\": 100,\n      \"costoMunicion\": 500,\n      \"costoDolares\": 0,\n      \"duracion\": 1150,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 12,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:25:38.508797+00\"\n  },\n  {\n      \"id\": \"almacen_de_municion\",\n      \"nombre\": \"Almacén de munición\",\n      \"descripcion\": \"El almacén de munición es similar a la armería. Aquí, se manufactura la munición importante. Es necesaria, en grandes cantidades, al ocupar áreas, así como para su uso en entrenamientos. A diferencia de las armas, la munición se usa mucho más rápido.\",\n      \"urlImagen\": \"/img/hab/municion.webp\",\n      \"costoArmas\": 9,\n      \"costoMunicion\": 15,\n      \"costoDolares\": 0,\n      \"duracion\": 300,\n      \"produccionBase\": 20,\n      \"produccionRecurso\": \"municion\",\n      \"puntos\": 1.39,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:23:17.387717+00\"\n  },\n  {\n      \"id\": \"armeria\",\n      \"nombre\": \"Armería\",\n      \"descripcion\": \"Aquí, en la Armería, como dice el nombre, se guardan armas. Serán de gran necesidad para ocupar nuevos lugares, y para entrenamientos en combate. Cuanto mejor desarrollada esté, más armas podrás hacer al mismo tiempo.\",\n      \"urlImagen\": \"/img/hab/armeria.webp\",\n      \"costoArmas\": 12,\n      \"costoMunicion\": 60,\n      \"costoDolares\": 0,\n      \"duracion\": 250,\n      \"produccionBase\": 10,\n      \"produccionRecurso\": \"armas\",\n      \"puntos\": 2.32,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:22:51.480552+00\"\n  },\n  {\n      \"id\": \"caja_fuerte\",\n      \"nombre\": \"Caja fuerte\",\n      \"descripcion\": \"Después de realizar un contrabando con éxito, conseguirás una buena cantidad de dólares. Pero, ¡presta atención!. Si no quieres tirar el dinero, debes usar esta caja, para prevenir que desaparezca, y para asegurarte liquidez.\",\n      \"urlImagen\": \"/img/hab/caja.webp\",\n      \"costoArmas\": 1000,\n      \"costoMunicion\": 1000,\n      \"costoDolares\": 500,\n      \"duracion\": 8000,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 91,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:27:13.382884+00\"\n  },\n  {\n      \"id\": \"campo_de_entrenamiento\",\n      \"nombre\": \"Campo de entrenamiento\",\n      \"descripcion\": \"Tal y como dice el nombre, en el campo de entrenamiento, tus \\\"chicos\\\" entrenarán. El mismo, dependerá según el tipo de unidades que puedas producir, por ejemplo, simples delincuentes, asesinos, profesionales, a los que tus enemigos tendrán un respeto extremo. Dependiendo del nivel, las unidades serán creadas en menor tiempo.\",\n      \"urlImagen\": \"/img/hab/campo.webp\",\n      \"costoArmas\": 1000,\n      \"costoMunicion\": 2500,\n      \"costoDolares\": 0,\n      \"duracion\": 5600,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 61,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:27:36.166028+00\"\n  },\n  {\n      \"id\": \"cerveceria\",\n      \"nombre\": \"Cervecería\",\n      \"descripcion\": \"Esta habitación manufactura alcohol. Desgraciadamente (¿o afortunadamente?) está prohibido y por tanto, muy demandado por la población, así que es un negocio próspero. Sin embargo, necesitarás ciertas estrategias para poder llevarlo hasta los ciudadanos.\",\n      \"urlImagen\": \"/img/hab/cerveceria.webp\",\n      \"costoArmas\": 20,\n      \"costoMunicion\": 20,\n      \"costoDolares\": 0,\n      \"duracion\": 500,\n      \"produccionBase\": 50,\n      \"produccionRecurso\": \"alcohol\",\n      \"puntos\": 1.6,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:23:42.8865+00\"\n  },\n  {\n      \"id\": \"contrabando\",\n      \"nombre\": \"Contrabando\",\n      \"descripcion\": \"Mejor que la taberna funciona el contrabando, podrás vender alcohol con un impacto mucho mayor, lo que naturalmente, beneficia a la caja de los gángsters. Desgraciadamente, esta táctica es arriesgada, y mucho más costosa.\",\n      \"urlImagen\": \"/img/hab/contrabando.webp\",\n      \"costoArmas\": 2000,\n      \"costoMunicion\": 5000,\n      \"costoDolares\": 500,\n      \"duracion\": 2000,\n      \"produccionBase\": 21,\n      \"produccionRecurso\": \"dolares_por_alcohol\",\n      \"puntos\": 136,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:25:00.822658+00\"\n  },\n  {\n      \"id\": \"deposito_de_municion\",\n      \"nombre\": \"Depósito de munición\",\n      \"descripcion\": \"El depósito de munición funciona de forma similar al almacén de armas. Se guardan cajas de munición y granadas que no se vayan a usar de inmediato. Además, aquí están más seguras, a salvo del enemigo.\",\n      \"urlImagen\": \"/img/hab/deposito.webp\",\n      \"costoArmas\": 500,\n      \"costoMunicion\": 600,\n      \"costoDolares\": 0,\n      \"duracion\": 1350,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 18,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:26:04.305882+00\"\n  },\n  {\n      \"id\": \"escuela_especializacion\",\n      \"nombre\": \"Escuela de especialización\",\n      \"descripcion\": \"Permite el entrenamiento de nuevas técnicas y habilidades.\",\n      \"urlImagen\": \"/img/hab/escuela.webp\",\n      \"costoArmas\": 1000,\n      \"costoMunicion\": 1000,\n      \"costoDolares\": 0,\n      \"duracion\": 2000,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 31.75,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:15:01.443959+00\"\n  },\n  {\n      \"id\": \"minas_ocultas\",\n      \"nombre\": \"Minas ocultas\",\n      \"descripcion\": \"Estas minas son una ayuda incluso más \\\"agradable\\\". Tus chicos las repartirán a lo largo de la casa. Cuando algún enemigo la pise sin darse cuenta... ¡Buenas noches!\",\n      \"urlImagen\": \"/img/hab/minas.webp\",\n      \"costoArmas\": 2000,\n      \"costoMunicion\": 2000,\n      \"costoDolares\": 150,\n      \"duracion\": 7200,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 65.5,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:28:40.985267+00\"\n  },\n  {\n      \"id\": \"oficina_del_jefe\",\n      \"nombre\": \"Oficina del Jefe\",\n      \"descripcion\": \"El Jefe se encuentra en esta oficina, y aquí, se toman todas las las decisiones. Coordina el desarrollo y la velocidad de construcción de las otras áreas. Cuando más nivel, más rápido se desarrollan el resto.\",\n      \"urlImagen\": \"/img/hab/oficina.webp\",\n      \"costoArmas\": 100,\n      \"costoMunicion\": 200,\n      \"costoDolares\": 0,\n      \"duracion\": 450,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 6,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:22:24.527889+00\"\n  },\n  {\n      \"id\": \"seguridad\",\n      \"nombre\": \"Seguridad\",\n      \"descripcion\": \"Al igual que el entrenamiento de luchadores en el campo de entrenamiento, aquí podrás entrenar a los más jóvenes en defensa. En principio, se quedarán permanentemente, siempre en el hogar, y protegiendo sus habitaciones contra enemigos. Si tus gángsters están de vuelta, automáticamente luchan juntos.\",\n      \"urlImagen\": \"/img/hab/seguridad.webp\",\n      \"costoArmas\": 900,\n      \"costoMunicion\": 1600,\n      \"costoDolares\": 100,\n      \"duracion\": 6300,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 45,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:28:01.749774+00\"\n  },\n  {\n      \"id\": \"taberna\",\n      \"nombre\": \"Taberna\",\n      \"descripcion\": \"En la taberna se consume alcohol. Aquí es donde traficas con Alcohol. Ten cuidado de no ser detectado por la Policia, o te saldrá caro. Dado que la taberna se supervisa batante mal, la conversión de alcohol es moderada.\",\n      \"urlImagen\": \"/img/hab/taberna.webp\",\n      \"costoArmas\": 10,\n      \"costoMunicion\": 50,\n      \"costoDolares\": 0,\n      \"duracion\": 750,\n      \"produccionBase\": 2,\n      \"produccionRecurso\": \"dolares_por_alcohol\",\n      \"puntos\": 2.1,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:24:07.212676+00\"\n  },\n  {\n      \"id\": \"torreta_de_fuego_automatico\",\n      \"nombre\": \"Torreta de fuego automático\",\n      \"descripcion\": \"A fin de aliviar un poco el trabajo de los defensores, dispones de ciertas construcciones, como esta torreta de fuego automático. Técnicamente, son muy avanzadas, y en el momento en que detecten a un enemigo, abrirán fuego de golpe.\",\n      \"urlImagen\": \"/img/hab/torreta.webp\",\n      \"costoArmas\": 1000,\n      \"costoMunicion\": 2000,\n      \"costoDolares\": 200,\n      \"duracion\": 4500,\n      \"produccionBase\": 0,\n      \"produccionRecurso\": null,\n      \"puntos\": 57,\n      \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n      \"updated_at\": \"2025-12-12 06:28:21.387232+00\"\n  }\n]",
    "src/data/room_scaling_rules_updated.json": "{\n    \"armeria\": {\n      \"produccion_recurso\": \"armas\",\n      \"formula_aumento_produccion\": \"Math.trunc(Math.pow((nivel + 1) / 2, 2) * 10)\",\n      \"factor_costo_por_nivel\": 1.15,\n      \"formula_tiempo\": \"((nivel * nivel) * 250) / nivel_oficina_jefe\"\n    },\n    \"almacen_de_municion\": {\n      \"produccion_recurso\": \"municion\",\n      \"formula_aumento_produccion\": \"Math.trunc(Math.pow((nivel + 1) / 2, 2) * 10 + 10)\",\n      \"factor_costo_por_nivel\": 1.15,\n      \"formula_tiempo\": \"((nivel * nivel) * 300) / nivel_oficina_jefe\"\n    },\n    \"cerveceria\": {\n      \"produccion_recurso\": \"alcohol\",\n      \"formula_aumento_produccion\": \"Math.trunc(produccion_base * Math.pow(1.2, nivel - 1))\",\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 500) / nivel_oficina_jefe\"\n    },\n    \"taberna\": {\n      \"produccion_recurso\": \"dolares_por_alcohol\",\n      \"formula_aumento_produccion\": \"Math.trunc(Math.pow((nivel + 1) / 2, 2) * 2)\",\n      \"factor_costo_por_nivel\": 1.18,\n      \"formula_tiempo\": \"((nivel * nivel) * 750) / nivel_oficina_jefe\"\n    },\n    \"contrabando\": {\n      \"produccion_recurso\": \"dolares\",\n      \"formula_aumento_produccion\": \"Math.trunc(Math.pow((nivel + 1) / 2, 2) * 21)\",\n      \"factor_costo_por_nivel\": 1.25,\n      \"formula_tiempo\": \"((nivel * nivel) * 1500) / nivel_oficina_jefe\"\n    },\n    \"oficina_del_jefe\": {\n      \"factor_costo_por_nivel\": 1.3,\n      \"formula_tiempo\": \"tiempo_base * 1.5\"\n    },\n    \"escuela_especializacion\": {\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 1000) / nivel_oficina_jefe\"\n    },\n    \"almacen_de_armas\": {\n      \"factor_costo_por_nivel\": 1.1,\n      \"formula_tiempo\": \"((nivel * nivel) * 1150) / nivel_oficina_jefe\"\n    },\n    \"deposito_de_municion\": {\n      \"factor_costo_por_nivel\": 1.1,\n      \"formula_tiempo\": \"((nivel * nivel) * 1350) / nivel_oficina_jefe\"\n    },\n    \"almacen_de_alcohol\": {\n      \"factor_costo_por_nivel\": 1.1,\n      \"formula_tiempo\": \"((nivel * nivel) * 750) / nivel_oficina_jefe\"\n    },\n    \"caja_fuerte\": {\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 800) / nivel_oficina_jefe\"\n    },\n    \"campo_de_entrenamiento\": {\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 7200) / nivel_oficina_jefe\"\n    },\n    \"seguridad\": {\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 6300) / nivel_oficina_jefe\"\n    },\n    \"torreta_de_fuego_automatico\": {\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 10800) / nivel_oficina_jefe\"\n    },\n    \"minas_ocultas\": {\n      \"factor_costo_por_nivel\": 1.2,\n      \"formula_tiempo\": \"((nivel * nivel) * 7200) / nivel_oficina_jefe\"\n    }\n  }",
    "src/tests/integration/user-creation.test.ts": "import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport { registerUser, login } from '@/lib/actions/auth.actions';\n\n// Mocks\nconst mockHeaders = {\n  get: vi.fn(),\n};\n\nconst mockSupabase = {\n  rpc: vi.fn(),\n  auth: {\n    signUp: vi.fn(),\n    signInWithPassword: vi.fn(),\n    signOut: vi.fn(),\n  },\n  from: vi.fn(),\n};\n\nvi.mock('next/headers', () => ({\n  headers: vi.fn(() => Promise.resolve(mockHeaders)),\n}));\n\nvi.mock('next/cache', () => ({\n  revalidatePath: vi.fn(),\n}));\n\nvi.mock('@/utils/supabase/server', () => ({\n  createClient: vi.fn(() => Promise.resolve(mockSupabase)),\n}));\n\ndescribe('Integration: User Creation & Auth Flow', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n    mockHeaders.get.mockReturnValue('http://localhost:3000');\n  });\n\n  describe('registerUser', () => {\n    it('should successfully register a new user', async () => {\n      // Mock username check (rpc) -> Available\n      mockSupabase.rpc.mockResolvedValueOnce({ data: true, error: null });\n\n      // Mock auth.signUp -> Success\n      mockSupabase.auth.signUp.mockResolvedValueOnce({\n        data: { user: { id: 'new-user-id' }, session: {} },\n        error: null,\n      });\n\n      const input = {\n        email: 'test@example.com',\n        username: 'NewUser',\n        password: 'password123',\n        locationMode: 'random' as const,\n      };\n\n      const result = await registerUser(input);\n\n      // Verifications\n      expect(result).toEqual({ success: true, sessionCreated: true });\n\n      // Verify username availability check\n      expect(mockSupabase.rpc).toHaveBeenCalledWith('check_username_availability', {\n        p_username: 'NewUser',\n      });\n\n      // Verify signUp call with emailRedirectTo\n      expect(mockSupabase.auth.signUp).toHaveBeenCalledWith({\n        email: 'test@example.com',\n        password: 'password123',\n        options: {\n          emailRedirectTo: 'http://localhost:3000/auth/confirm',\n          data: {\n            username: 'NewUser',\n            name: 'NewUser',\n            title: 'Novato',\n            avatar_url: 'https://placehold.co/128x128.png',\n            location_mode: 'random',\n            manual_coords: null,\n          },\n        },\n      });\n    });\n\n    it('should fail if username is taken', async () => {\n      // Mock username check -> Not Available\n      mockSupabase.rpc.mockResolvedValueOnce({ data: false, error: null });\n\n      const input = {\n        email: 'test@example.com',\n        username: 'TakenUser',\n        password: 'password123',\n        locationMode: 'random' as const,\n      };\n\n      const result = await registerUser(input);\n\n      expect(result).toEqual({ error: 'El nombre de usuario ya está en uso.' });\n      expect(mockSupabase.auth.signUp).not.toHaveBeenCalled();\n    });\n\n    it('should handle database errors during sign up', async () => {\n      // Mock username check -> Available\n      mockSupabase.rpc.mockResolvedValueOnce({ data: true, error: null });\n\n      // Mock auth.signUp -> 500 Error (Trigger failure)\n      mockSupabase.auth.signUp.mockResolvedValueOnce({\n        data: { user: null, session: null },\n        error: { message: 'Database error saving new user', status: 500 },\n      });\n\n      const input = {\n        email: 'fail@example.com',\n        username: 'FailUser',\n        password: 'password123',\n        locationMode: 'random' as const,\n      };\n\n      const result = await registerUser(input);\n\n      expect(result).toEqual({ error: 'Database error saving new user' });\n    });\n  });\n\n  describe('login (Self-Repair Flow)', () => {\n    it('should login and trigger self-repair if user data is incomplete', async () => {\n        // Mock auth.signInWithPassword -> Success\n        mockSupabase.auth.signInWithPassword.mockResolvedValueOnce({\n            data: { user: { id: 'existing-user-id' } },\n            error: null,\n        });\n\n        // Mock User table check -> Missing property (trigger repair)\n        // returns data: { ... } but hasProperty check fails if Propiedad is empty\n        mockSupabase.from.mockReturnValue({\n            select: vi.fn().mockReturnValue({\n                eq: vi.fn().mockReturnValue({\n                    single: vi.fn().mockResolvedValue({\n                        data: {\n                            id: 'existing-user-id',\n                            Propiedad: [] // Empty array = missing property\n                        },\n                        error: null\n                    })\n                })\n            }),\n            insert: vi.fn().mockResolvedValue({}), // for LogLoginHistory\n        });\n\n        // Mock RPC repair -> Success\n        mockSupabase.rpc.mockResolvedValueOnce({ data: 'Reparación exitosa', error: null });\n\n        const result = await login({ email: 'test@example.com', password: 'password123' });\n\n        expect(result).toEqual({ success: true });\n\n        // Verify RPC call for self-repair\n        // Note: rpc is called twice here? No, check_username_availability is not called in login.\n        // But rpc is called in repair.\n        expect(mockSupabase.rpc).toHaveBeenCalledWith('rpc_setup_user', {\n            target_user_id: 'existing-user-id'\n        });\n    });\n\n    it('should login without repair if user data is complete', async () => {\n        // Mock auth.signInWithPassword -> Success\n        mockSupabase.auth.signInWithPassword.mockResolvedValueOnce({\n            data: { user: { id: 'complete-user-id' } },\n            error: null,\n        });\n\n        // Mock User table check -> Complete\n        mockSupabase.from.mockReturnValue({\n            select: vi.fn().mockReturnValue({\n                eq: vi.fn().mockReturnValue({\n                    single: vi.fn().mockResolvedValue({\n                        data: {\n                            id: 'complete-user-id',\n                            Propiedad: [{ id: 'prop-1' }] // Has property\n                        },\n                        error: null\n                    })\n                })\n            }),\n            insert: vi.fn().mockResolvedValue({}),\n        });\n\n        const result = await login({ email: 'test@example.com', password: 'password123' });\n\n        expect(result).toEqual({ success: true });\n\n        // Verify RPC was NOT called\n        expect(mockSupabase.rpc).not.toHaveBeenCalled();\n    });\n  });\n});\n",
    "src/tests/integration/game-flow.test.ts": "import { describe, it, expect, vi, beforeEach, type MockInstance } from 'vitest';\n\nconst mocks = vi.hoisted(() => ({\n  revalidatePath: vi.fn(),\n  getSessionUser: vi.fn(),\n  rpc: vi.fn(),\n  createClient: vi.fn(),\n}));\n\nvi.mock('next/cache', () => ({\n  revalidatePath: mocks.revalidatePath,\n}));\n\nvi.mock('@/lib/auth', () => ({\n  getSessionUser: mocks.getSessionUser,\n}));\n\nvi.mock('@/utils/supabase/server', () => ({\n  createClient: mocks.createClient,\n}));\n\nimport { iniciarAmpliacion, cancelarConstruccion } from '@/lib/actions/room.actions';\n\ndescribe('Integration: Game Flow (Construction)', () => {\n  const validUUID = '123e4567-e89b-12d3-a456-426614174000';\n  const mockUser = { id: 'user-123', email: 'test@example.com' };\n\n  beforeEach(() => {\n    vi.clearAllMocks();\n    mocks.getSessionUser.mockResolvedValue(mockUser);\n\n    // Setup Supabase Mock\n    mocks.createClient.mockResolvedValue({\n      rpc: mocks.rpc,\n      from: vi.fn().mockReturnValue({\n          select: vi.fn().mockReturnValue({\n              data: [], error: null\n          }),\n          upsert: vi.fn().mockReturnValue({\n              error: null\n          })\n      })\n    });\n  });\n\n  it('should successfully start and then cancel a construction (Happy Path)', async () => {\n    // 1. Iniciar Ampliacion\n    mocks.rpc.mockResolvedValueOnce({\n      data: { success: 'Iniciado', nivelDestino: 2 },\n      error: null\n    });\n\n    const startResult = await iniciarAmpliacion({\n      propiedadId: validUUID,\n      habitacionId: 'room-1'\n    });\n\n    if (startResult?.serverError) {\n        console.error('Start Server Error:', startResult.serverError);\n    }\n    if (startResult?.validationErrors) {\n        console.error('Start Validation Error:', startResult.validationErrors);\n    }\n\n    expect(startResult?.data).toBeDefined();\n    expect(startResult?.data?.success).toBe('Iniciado');\n    expect(mocks.rpc).toHaveBeenCalledWith('iniciar_construccion_habitacion', {\n      p_propiedad_id: validUUID,\n      p_habitacion_id: 'room-1'\n    });\n\n    // 2. Cancelar Construccion\n    mocks.rpc.mockResolvedValueOnce({\n      data: { success: 'Cancelado' },\n      error: null\n    });\n\n    // Assuming we have a construction ID or queue ID.\n    // The action takes `colaId`.\n    const colaId = '123e4567-e89b-12d3-a456-426614174001'; // Valid UUID\n\n    const cancelResult = await cancelarConstruccion({\n      colaId: colaId\n    });\n\n    if (cancelResult?.serverError) {\n        console.error('Cancel Server Error:', cancelResult.serverError);\n    }\n\n    expect(cancelResult?.data).toBeDefined();\n    expect(cancelResult?.data?.success).toBe('Cancelado');\n    expect(mocks.rpc).toHaveBeenCalledWith('cancelar_construccion_habitacion', {\n      p_cola_id: colaId\n    });\n  });\n});\n",
    "src/proxy.ts": "import { type NextRequest } from \"next/server\"\nimport { updateSession } from \"@/utils/supabase/middleware\"\n\nexport async function proxy(request: NextRequest) {\n  return await updateSession(request)\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - /login\n     * - /auth/confirm\n     * - /verify\n     * - extension regex (svg, png, etc)\n     */\n    \"/((?!_next/static|_next/image|favicon.ico|login|auth/confirm|verify|admin|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\n  ],\n}\n",
    "src/contexts/property-context.tsx": "'use client'\n\nimport { createContext, useContext, useState, useEffect, ReactNode, useMemo, Suspense, useCallback } from 'react';\nimport { usePathname, useRouter, useSearchParams } from 'next/navigation';\nimport type { FullPropiedad } from '@/types';\n\ninterface PropertyContextType {\n  properties: FullPropiedad[];\n  selectedProperty: FullPropiedad | null;\n  setSelectedPropertyById: (id: string) => void;\n}\n\nconst PropertyContext = createContext<PropertyContextType | undefined>(undefined);\n\nfunction PropertyProviderClient({ children, initialProperties }: { children: ReactNode, initialProperties: FullPropiedad[] }) {\n  const router = useRouter();\n  const pathname = usePathname();\n  const searchParams = useSearchParams();\n\n  const [properties, setProperties] = useState<FullPropiedad[]>(initialProperties);\n\n  // Initialize selectedProperty based on URL or default to first property.\n  // We use state so we can maintain the selection even if the URL param is removed.\n  const [selectedProperty, setSelectedProperty] = useState<FullPropiedad | null>(() => {\n    const propertyId = searchParams.get('propertyId');\n    if (propertyId) {\n      return initialProperties.find(p => p.id === propertyId) || (initialProperties.length > 0 ? initialProperties[0] : null);\n    }\n    return initialProperties.length > 0 ? initialProperties[0] : null;\n  });\n\n  // Update local properties state if the initial server-fetched properties change\n  useEffect(() => {\n    setProperties(initialProperties);\n  }, [initialProperties]);\n\n  // Sync state with URL propertyId changes.\n  // ONLY update if the URL has a specific propertyId.\n  // If the URL does not have a propertyId, we KEEP the current selection (persistence).\n  useEffect(() => {\n    const propertyId = searchParams.get('propertyId');\n    if (propertyId) {\n        const propertyToSelect = properties.find(p => p.id === propertyId);\n        if (propertyToSelect && propertyToSelect.id !== selectedProperty?.id) {\n            setSelectedProperty(propertyToSelect);\n        }\n    }\n  }, [searchParams, properties, selectedProperty]);\n\n  const setSelectedPropertyById = useCallback((id: string) => {\n    const property = properties.find(p => p.id === id);\n    if (property) {\n        // Create a new URLSearchParams object based on the current one\n        const params = new URLSearchParams(searchParams.toString());\n        // Set the new propertyId\n        params.set('propertyId', id);\n        // Use router.push to navigate to the new URL, triggering a re-render\n        // with the updated search param. This makes the URL the source of truth.\n        router.push(`${pathname}?${params.toString()}`);\n    }\n  }, [properties, pathname, router, searchParams]);\n  \n  const value = useMemo(() => ({\n    properties,\n    selectedProperty,\n    setSelectedPropertyById,\n  }), [properties, selectedProperty, setSelectedPropertyById]);\n\n  return (\n    <PropertyContext.Provider value={value}>\n      {children}\n    </PropertyContext.Provider>\n  );\n}\n\nexport function PropertyProvider({ children, initialProperties }: { children: ReactNode, initialProperties: FullPropiedad[] }) {\n    return (\n        <Suspense fallback={<div>Loading properties...</div>}>\n            <PropertyProviderClient initialProperties={initialProperties}>\n                {children}\n            </PropertyProviderClient>\n        </Suspense>\n    )\n}\n\nexport function useProperty() {\n  const context = useContext(PropertyContext);\n  if (context === undefined) {\n    throw new Error('useProperty must be used within a PropertyProvider');\n  }\n  return context;\n}\n",
    "src/contexts/GameConfigContext.tsx": "'use client'\n\nimport { createContext, useContext, ReactNode } from 'react';\nimport type { FullConfiguracionHabitacion, FullConfiguracionTropa } from '@/types';\n\ninterface GameConfig {\n  allRooms: FullConfiguracionHabitacion[];\n  allTroops: FullConfiguracionTropa[];\n}\n\nconst GameConfigContext = createContext<GameConfig | null>(null);\n\nexport function GameConfigProvider({ children, value }: { children: ReactNode; value: GameConfig }) {\n  return (\n    <GameConfigContext.Provider value={value}>\n      {children}\n    </GameConfigContext.Provider>\n  );\n}\n\nexport function useGameConfig() {\n  const context = useContext(GameConfigContext);\n  if (!context) {\n    throw new Error('useGameConfig must be used within a GameConfigProvider');\n  }\n  return context;\n}\n",
    "src/contexts/pruebas/ConfiguracionHabitacion_rows.json": "[\n    {\n        \"id\": \"almacen_de_alcohol\",\n        \"nombre\": \"Almacén de alcohol\",\n        \"descripcion\": \"Ya que la destilación de alcohol es bastante sencilla, la producción es alta. Para poder almacenarlo sin perder el exceso de producción, necesitas construir un almacén de alcohol. En el mismo, estará a salvo de los enemigos.\",\n        \"urlImagen\": \"/img/hab/almacen_alc.webp\",\n        \"costoArmas\": 200,\n        \"costoMunicion\": 200,\n        \"costoDolares\": 0,\n        \"duracion\": 750,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 7,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 11:08:00.923125+00\"\n    },\n    {\n        \"id\": \"almacen_de_armas\",\n        \"nombre\": \"Almacén de armas\",\n        \"descripcion\": \"En el almacén de armas, se guarda todo el armamento que no se necesita de inmediato. El proceso es automático, y se mantienen allí hasta que sean necesarias. Además, ningún enemigo podrá robártelas de este almacén.\",\n        \"urlImagen\": \"/img/hab/almacen_arm.webp\",\n        \"costoArmas\": 100,\n        \"costoMunicion\": 500,\n        \"costoDolares\": 0,\n        \"duracion\": 1150,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 12,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:25:38.508797+00\"\n    },\n    {\n        \"id\": \"almacen_de_municion\",\n        \"nombre\": \"Almacén de munición\",\n        \"descripcion\": \"El almacén de munición es similar a la armería. Aquí, se manufactura la munición importante. Es necesaria, en grandes cantidades, al ocupar áreas, así como para su uso en entrenamientos. A diferencia de las armas, la munición se usa mucho más rápido.\",\n        \"urlImagen\": \"/img/hab/municion.webp\",\n        \"costoArmas\": 9,\n        \"costoMunicion\": 15,\n        \"costoDolares\": 0,\n        \"duracion\": 300,\n        \"produccionBase\": 20,\n        \"produccionRecurso\": \"municion\",\n        \"puntos\": 1.39,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:23:17.387717+00\"\n    },\n    {\n        \"id\": \"armeria\",\n        \"nombre\": \"Armería\",\n        \"descripcion\": \"Aquí, en la Armería, como dice el nombre, se guardan armas. Serán de gran necesidad para ocupar nuevos lugares, y para entrenamientos en combate. Cuanto mejor desarrollada esté, más armas podrás hacer al mismo tiempo.\",\n        \"urlImagen\": \"/img/hab/armeria.webp\",\n        \"costoArmas\": 12,\n        \"costoMunicion\": 60,\n        \"costoDolares\": 0,\n        \"duracion\": 250,\n        \"produccionBase\": 10,\n        \"produccionRecurso\": \"armas\",\n        \"puntos\": 2.32,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:22:51.480552+00\"\n    },\n    {\n        \"id\": \"caja_fuerte\",\n        \"nombre\": \"Caja fuerte\",\n        \"descripcion\": \"Después de realizar un contrabando con éxito, conseguirás una buena cantidad de dólares. Pero, ¡presta atención!. Si no quieres tirar el dinero, debes usar esta caja, para prevenir que desaparezca, y para asegurarte liquidez.\",\n        \"urlImagen\": \"/img/hab/caja.webp\",\n        \"costoArmas\": 1000,\n        \"costoMunicion\": 1000,\n        \"costoDolares\": 500,\n        \"duracion\": 8000,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 91,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:27:13.382884+00\"\n    },\n    {\n        \"id\": \"campo_de_entrenamiento\",\n        \"nombre\": \"Campo de entrenamiento\",\n        \"descripcion\": \"Tal y como dice el nombre, en el campo de entrenamiento, tus \\\"chicos\\\" entrenarán. El mismo, dependerá según el tipo de unidades que puedas producir, por ejemplo, simples delincuentes, asesinos, profesionales, a los que tus enemigos tendrán un respeto extremo. Dependiendo del nivel, las unidades serán creadas en menor tiempo.\",\n        \"urlImagen\": \"/img/hab/campo.webp\",\n        \"costoArmas\": 1000,\n        \"costoMunicion\": 2500,\n        \"costoDolares\": 0,\n        \"duracion\": 5600,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 61,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:27:36.166028+00\"\n    },\n    {\n        \"id\": \"cerveceria\",\n        \"nombre\": \"Cervecería\",\n        \"descripcion\": \"Esta habitación manufactura alcohol. Desgraciadamente (¿o afortunadamente?) está prohibido y por tanto, muy demandado por la población, así que es un negocio próspero. Sin embargo, necesitarás ciertas estrategias para poder llevarlo hasta los ciudadanos.\",\n        \"urlImagen\": \"/img/hab/cerveceria.webp\",\n        \"costoArmas\": 20,\n        \"costoMunicion\": 20,\n        \"costoDolares\": 0,\n        \"duracion\": 500,\n        \"produccionBase\": 50,\n        \"produccionRecurso\": \"alcohol\",\n        \"puntos\": 1.6,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:23:42.8865+00\"\n    },\n    {\n        \"id\": \"contrabando\",\n        \"nombre\": \"Contrabando\",\n        \"descripcion\": \"Mejor que la taberna funciona el contrabando, podrás vender alcohol con un impacto mucho mayor, lo que naturalmente, beneficia a la caja de los gángsters. Desgraciadamente, esta táctica es arriesgada, y mucho más costosa.\",\n        \"urlImagen\": \"/img/hab/contrabando.webp\",\n        \"costoArmas\": 2000,\n        \"costoMunicion\": 5000,\n        \"costoDolares\": 500,\n        \"duracion\": 2000,\n        \"produccionBase\": 21,\n        \"produccionRecurso\": \"dolares_por_alcohol\",\n        \"puntos\": 136,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:25:00.822658+00\"\n    },\n    {\n        \"id\": \"deposito_de_municion\",\n        \"nombre\": \"Depósito de munición\",\n        \"descripcion\": \"El depósito de munición funciona de forma similar al almacén de armas. Se guardan cajas de munición y granadas que no se vayan a usar de inmediato. Además, aquí están más seguras, a salvo del enemigo.\",\n        \"urlImagen\": \"/img/hab/deposito.webp\",\n        \"costoArmas\": 500,\n        \"costoMunicion\": 600,\n        \"costoDolares\": 0,\n        \"duracion\": 1350,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 18,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:26:04.305882+00\"\n    },\n    {\n        \"id\": \"escuela_especializacion\",\n        \"nombre\": \"Escuela de especialización\",\n        \"descripcion\": \"Permite el entrenamiento de nuevas técnicas y habilidades.\",\n        \"urlImagen\": \"/img/hab/escuela.webp\",\n        \"costoArmas\": 1000,\n        \"costoMunicion\": 1000,\n        \"costoDolares\": 0,\n        \"duracion\": 2000,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 31.75,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:15:01.443959+00\"\n    },\n    {\n        \"id\": \"minas_ocultas\",\n        \"nombre\": \"Minas ocultas\",\n        \"descripcion\": \"Estas minas son una ayuda incluso más \\\"agradable\\\". Tus chicos las repartirán a lo largo de la casa. Cuando algún enemigo la pise sin darse cuenta... ¡Buenas noches!\",\n        \"urlImagen\": \"/img/hab/minas.webp\",\n        \"costoArmas\": 2000,\n        \"costoMunicion\": 2000,\n        \"costoDolares\": 150,\n        \"duracion\": 7200,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 65.5,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:28:40.985267+00\"\n    },\n    {\n        \"id\": \"oficina_del_jefe\",\n        \"nombre\": \"Oficina del Jefe\",\n        \"descripcion\": \"El Jefe se encuentra en esta oficina, y aquí, se toman todas las las decisiones. Coordina el desarrollo y la velocidad de construcción de las otras áreas. Cuando más nivel, más rápido se desarrollan el resto.\",\n        \"urlImagen\": \"/img/hab/oficina.webp\",\n        \"costoArmas\": 100,\n        \"costoMunicion\": 200,\n        \"costoDolares\": 0,\n        \"duracion\": 450,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 6,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:22:24.527889+00\"\n    },\n    {\n        \"id\": \"seguridad\",\n        \"nombre\": \"Seguridad\",\n        \"descripcion\": \"Al igual que el entrenamiento de luchadores en el campo de entrenamiento, aquí podrás entrenar a los más jóvenes en defensa. En principio, se quedarán permanentemente, siempre en el hogar, y protegiendo sus habitaciones contra enemigos. Si tus gángsters están de vuelta, automáticamente luchan juntos.\",\n        \"urlImagen\": \"/img/hab/seguridad.webp\",\n        \"costoArmas\": 900,\n        \"costoMunicion\": 1600,\n        \"costoDolares\": 100,\n        \"duracion\": 6300,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 45,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:28:01.749774+00\"\n    },\n    {\n        \"id\": \"taberna\",\n        \"nombre\": \"Taberna\",\n        \"descripcion\": \"En la taberna se consume alcohol. Aquí es donde traficas con Alcohol. Ten cuidado de no ser detectado por la Policia, o te saldrá caro. Dado que la taberna se supervisa batante mal, la conversión de alcohol es moderada.\",\n        \"urlImagen\": \"/img/hab/taberna.webp\",\n        \"costoArmas\": 10,\n        \"costoMunicion\": 50,\n        \"costoDolares\": 0,\n        \"duracion\": 750,\n        \"produccionBase\": 2,\n        \"produccionRecurso\": \"dolares_por_alcohol\",\n        \"puntos\": 2.1,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:24:07.212676+00\"\n    },\n    {\n        \"id\": \"torreta_de_fuego_automatico\",\n        \"nombre\": \"Torreta de fuego automático\",\n        \"descripcion\": \"A fin de aliviar un poco el trabajo de los defensores, dispones de ciertas construcciones, como esta torreta de fuego automático. Técnicamente, son muy avanzadas, y en el momento en que detecten a un enemigo, abrirán fuego de golpe.\",\n        \"urlImagen\": \"/img/hab/torreta.webp\",\n        \"costoArmas\": 1000,\n        \"costoMunicion\": 2000,\n        \"costoDolares\": 200,\n        \"duracion\": 4500,\n        \"produccionBase\": 0,\n        \"produccionRecurso\": null,\n        \"puntos\": 57,\n        \"created_at\": \"2025-12-12 06:01:43.971604+00\",\n        \"updated_at\": \"2025-12-12 06:28:21.387232+00\"\n    }\n]",
    "src/contexts/pruebas/ConfiguracionTropa_rows.json": "[{\"id\":\"acuchillador\",\"nombre\":\"Acuchillador\",\"descripcion\":\"Para ser más efectivos en llegar tan rápido como sea posible al objetivo, tus chicos deberían hacer este entrenamiento. Aquí aprenderán a planear rutas, viajar silenciosamente, y aproximarse al objetivo sin ser detectados, para llevar a cabo su trabajo tan efectivamente como sea posible.\",\"urlImagen\":\"/img/trp/acuchillador.webp\",\"costoArmas\":1000,\"costoMunicion\":200,\"costoDolares\":0,\"duracion\":2000,\"ataque\":10,\"defensa\":8,\"capacidad\":300,\"velocidad\":3000,\"salario\":1,\"puntos\":4,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[\\\"extorsion\\\"]\",\"bonusDefensa\":\"[\\\"extorsion\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-13 06:25:56.987723+00\"},{\"id\":\"asesino\",\"nombre\":\"Asesino\",\"descripcion\":\"Un profesional del combate cercano y el sigilo, el asesino es una herramienta mortal en las manos adecuadas.\",\"urlImagen\":\"/img/trp/asesino.webp\",\"costoArmas\":10000,\"costoMunicion\":15000,\"costoDolares\":10000,\"duracion\":6000,\"ataque\":300,\"defensa\":200,\"capacidad\":2000,\"velocidad\":6500,\"salario\":50,\"puntos\":176,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[\\\"seguridad\\\"]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-13 06:36:43.702586+00\"},{\"id\":\"centinela\",\"nombre\":\"Centinela\",\"descripcion\":\"Vigilante entrenado para la defensa perimetral.\",\"urlImagen\":\"/img/trp/centinela.webp\",\"costoArmas\":30,\"costoMunicion\":50,\"costoDolares\":0,\"duracion\":130,\"ataque\":5,\"defensa\":25,\"capacidad\":0,\"velocidad\":0,\"salario\":3,\"puntos\":1.5,\"tipo\":\"DEFENSA\",\"requisitos\":\"[\\\"seguridad\\\"]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[\\\"seguridad\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"cia\",\"nombre\":\"Agente CIA\",\"descripcion\":\"Agencia de inteligencia.\",\"urlImagen\":\"/img/trp/cia.webp\",\"costoArmas\":250,\"costoMunicion\":300,\"costoDolares\":50,\"duracion\":400,\"ataque\":60,\"defensa\":40,\"capacidad\":10,\"velocidad\":130,\"salario\":30,\"puntos\":12,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"demoliciones\",\"nombre\":\"Experto en Demoliciones\",\"descripcion\":\"Destrucción estructural.\",\"urlImagen\":\"/img/trp/demolicion.webp\",\"costoArmas\":400,\"costoMunicion\":500,\"costoDolares\":100,\"duracion\":600,\"ataque\":70,\"defensa\":30,\"capacidad\":15,\"velocidad\":90,\"salario\":35,\"puntos\":25,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"espia\",\"nombre\":\"Espía\",\"descripcion\":\"Infiltración y recopilación de información.\",\"urlImagen\":\"/img/trp/espia.webp\",\"costoArmas\":0,\"costoMunicion\":0,\"costoDolares\":200,\"duracion\":300,\"ataque\":1,\"defensa\":1,\"capacidad\":0,\"velocidad\":200,\"salario\":30,\"puntos\":5,\"tipo\":\"ESPIONAJE\",\"requisitos\":\"[\\\"espionaje\\\"]\",\"bonusAtaque\":\"[\\\"espionaje\\\"]\",\"bonusDefensa\":\"[\\\"espionaje\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"fbi\",\"nombre\":\"Agente FBI\",\"descripcion\":\"Investigación federal.\",\"urlImagen\":\"/img/trp/fbi.webp\",\"costoArmas\":240,\"costoMunicion\":280,\"costoDolares\":40,\"duracion\":380,\"ataque\":55,\"defensa\":45,\"capacidad\":10,\"velocidad\":125,\"salario\":28,\"puntos\":11,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"francotirador\",\"nombre\":\"Francotirador\",\"descripcion\":\"Muerte a distancia.\",\"urlImagen\":\"/img/trp/francotirador.webp\",\"costoArmas\":350,\"costoMunicion\":200,\"costoDolares\":50,\"duracion\":550,\"ataque\":90,\"defensa\":10,\"capacidad\":2,\"velocidad\":140,\"salario\":45,\"puntos\":22,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"guardaespaldas\",\"nombre\":\"Guardaespaldas\",\"descripcion\":\"Protección de élite para activos importantes.\",\"urlImagen\":\"/img/trp/guardaespaldas.webp\",\"costoArmas\":150,\"costoMunicion\":200,\"costoDolares\":50,\"duracion\":350,\"ataque\":30,\"defensa\":80,\"capacidad\":0,\"velocidad\":0,\"salario\":25,\"puntos\":8,\"tipo\":\"DEFENSA\",\"requisitos\":\"[\\\"combate\\\",\\\"proteccion\\\"]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[\\\"proteccion\\\",\\\"combate\\\",\\\"tiro\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"guardia_de_honor\",\"nombre\":\"Guardia de Honor\",\"descripcion\":\"La unidad defensiva definitiva.\",\"urlImagen\":\"/img/trp/guardia.webp\",\"costoArmas\":300,\"costoMunicion\":400,\"costoDolares\":100,\"duracion\":600,\"ataque\":50,\"defensa\":120,\"capacidad\":0,\"velocidad\":0,\"salario\":50,\"puntos\":15,\"tipo\":\"DEFENSA\",\"requisitos\":\"[\\\"combate\\\",\\\"tiro\\\",\\\"psicologico\\\"]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[\\\"proteccion\\\",\\\"combate\\\",\\\"tiro\\\",\\\"psicologico\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"maton\",\"nombre\":\"Matón\",\"descripcion\":\"Para ser más efectivos en llegar tan rápido como sea posible al objetivo, tus chicos deberían hacer este entrenamiento. Aquí aprenderán a planear rutas, viajar silenciosamente, y aproximarse al objetivo sin ser detectados, para llevar a cabo su trabajo tan efectivamente como sea posible.\",\"urlImagen\":\"/img/trp/maton.webp\",\"costoArmas\":200,\"costoMunicion\":1000,\"costoDolares\":0,\"duracion\":1400,\"ataque\":5,\"defensa\":10,\"capacidad\":200,\"velocidad\":1920,\"salario\":1,\"puntos\":6,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-13 06:24:50.460394+00\"},{\"id\":\"mercenario\",\"nombre\":\"Mercenario\",\"descripcion\":\"Un soldado de fortuna que lucha por el mejor postor. Equipado con lo mejor, es una fuerza a tener en cuenta en el campo de batalla.\",\"urlImagen\":\"/img/trp/mercenario.webp\",\"costoArmas\":80000,\"costoMunicion\":120000,\"costoDolares\":50000,\"duracion\":144000,\"ataque\":1000,\"defensa\":2400,\"capacidad\":12000,\"velocidad\":3000,\"salario\":300,\"puntos\":1176,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[\\\"espionaje\\\",\\\"seguridad\\\",\\\"proteccion\\\",\\\"combate\\\",\\\"armas\\\",\\\"tiro\\\",\\\"guerrilla\\\",\\\"psicologico\\\"]\",\"bonusDefensa\":\"[\\\"espionaje\\\",\\\"seguridad\\\",\\\"proteccion\\\",\\\"combate\\\",\\\"armas\\\",\\\"tiro\\\",\\\"guerrilla\\\",\\\"psicologico\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:20:26.706459+00\"},{\"id\":\"ninja\",\"nombre\":\"Ninja\",\"descripcion\":\"Sigilo y artes marciales.\",\"urlImagen\":\"/img/trp/ninja.webp\",\"costoArmas\":200,\"costoMunicion\":100,\"costoDolares\":50,\"duracion\":480,\"ataque\":75,\"defensa\":40,\"capacidad\":10,\"velocidad\":160,\"salario\":38,\"puntos\":18,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"ocupacion\",\"nombre\":\"Tropa de Ocupación\",\"descripcion\":\"Experto en tomar y mantener el control de propiedades.\",\"urlImagen\":\"/img/trp/ocupacion.webp\",\"costoArmas\":50,\"costoMunicion\":50,\"costoDolares\":100,\"duracion\":180,\"ataque\":5,\"defensa\":5,\"capacidad\":0,\"velocidad\":20000000,\"salario\":15,\"puntos\":2.5,\"tipo\":\"OCUPAR\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 12:07:13.650399+00\"},{\"id\":\"pistolero\",\"nombre\":\"Pistolero\",\"descripcion\":\"Preciso y mortal a distancia.\",\"urlImagen\":\"/img/trp/pistolero.webp\",\"costoArmas\":100,\"costoMunicion\":100,\"costoDolares\":0,\"duracion\":200,\"ataque\":40,\"defensa\":20,\"capacidad\":5,\"velocidad\":110,\"salario\":20,\"puntos\":3,\"tipo\":\"ATAQUE\",\"requisitos\":\"[\\\"tiro\\\"]\",\"bonusAtaque\":\"[\\\"tiro\\\"]\",\"bonusDefensa\":\"[\\\"seguridad\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"policia\",\"nombre\":\"Policía\",\"descripcion\":\"Defensor bien equipado y entrenado.\",\"urlImagen\":\"/img/trp/policia.webp\",\"costoArmas\":80,\"costoMunicion\":120,\"costoDolares\":0,\"duracion\":220,\"ataque\":15,\"defensa\":50,\"capacidad\":0,\"velocidad\":0,\"salario\":10,\"puntos\":4,\"tipo\":\"DEFENSA\",\"requisitos\":\"[\\\"proteccion\\\"]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[\\\"proteccion\\\",\\\"combate\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"porteador\",\"nombre\":\"Porteador\",\"descripcion\":\"Capaz de transportar grandes cantidades de recursos.\",\"urlImagen\":\"/img/trp/porteador.webp\",\"costoArmas\":10,\"costoMunicion\":10,\"costoDolares\":0,\"duracion\":80,\"ataque\":2,\"defensa\":10,\"capacidad\":500,\"velocidad\":70,\"salario\":3,\"puntos\":0.5,\"tipo\":\"TRANSPORTE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"portero\",\"nombre\":\"Portero\",\"descripcion\":\"Grande y malo, perfecto para intimidar.\",\"urlImagen\":\"/img/trp/portero.webp\",\"costoArmas\":20,\"costoMunicion\":50,\"costoDolares\":0,\"duracion\":120,\"ataque\":5,\"defensa\":15,\"capacidad\":20,\"velocidad\":80,\"salario\":8,\"puntos\":1.2,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[\\\"proteccion\\\"]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"tactico\",\"nombre\":\"Experto Táctico\",\"descripcion\":\"Estratega de combate.\",\"urlImagen\":\"/img/trp/tactico.webp\",\"costoArmas\":220,\"costoMunicion\":220,\"costoDolares\":80,\"duracion\":420,\"ataque\":40,\"defensa\":60,\"capacidad\":20,\"velocidad\":110,\"salario\":30,\"puntos\":15,\"tipo\":\"ATAQUE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"trabajador_ilegal\",\"nombre\":\"Trabajador Ilegal\",\"descripcion\":\"Defensa básica y barata.\",\"urlImagen\":\"/img/trp/ilegal.webp\",\"costoArmas\":10,\"costoMunicion\":10,\"costoDolares\":0,\"duracion\":90,\"ataque\":1,\"defensa\":10,\"capacidad\":0,\"velocidad\":0,\"salario\":1,\"puntos\":0.8,\"tipo\":\"DEFENSA\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"transportista\",\"nombre\":\"Transportista\",\"descripcion\":\"Transporte pesado.\",\"urlImagen\":\"/img/trp/transportista.webp\",\"costoArmas\":50,\"costoMunicion\":50,\"costoDolares\":200,\"duracion\":250,\"ataque\":5,\"defensa\":20,\"capacidad\":2000,\"velocidad\":60,\"salario\":15,\"puntos\":5,\"tipo\":\"TRANSPORTE\",\"requisitos\":\"[]\",\"bonusAtaque\":\"[]\",\"bonusDefensa\":\"[]\",\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"}]",
    "src/contexts/pruebas/ConfiguracionEntrenamiento_rows.json": "[{\"id\":\"administracion\",\"nombre\":\"Administración\",\"urlImagen\":\"/img/ent/administracion.webp\",\"costoArmas\":800,\"costoMunicion\":0,\"costoDolares\":800,\"duracion\":10000,\"puntos\":23.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"armas\",\"nombre\":\"Armas\",\"urlImagen\":\"/img/ent/armas.webp\",\"costoArmas\":0,\"costoMunicion\":10000,\"costoDolares\":0,\"duracion\":60000,\"puntos\":45.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"combate\",\"nombre\":\"Combate\",\"urlImagen\":\"/img/ent/combate.webp\",\"costoArmas\":4000,\"costoMunicion\":4000,\"costoDolares\":0,\"duracion\":40000,\"puntos\":60,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"contrabando\",\"nombre\":\"Contrabando\",\"urlImagen\":\"/img/ent/contrabando.webp\",\"costoArmas\":2000,\"costoMunicion\":2000,\"costoDolares\":2000,\"duracion\":20000,\"puntos\":69.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"encargos\",\"nombre\":\"Encargos\",\"urlImagen\":\"/img/ent/encargos.webp\",\"costoArmas\":200,\"costoMunicion\":200,\"costoDolares\":200,\"duracion\":4000,\"puntos\":13,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"espionaje\",\"nombre\":\"Espionaje\",\"urlImagen\":\"/img/ent/espionaje.webp\",\"costoArmas\":0,\"costoMunicion\":0,\"costoDolares\":500,\"duracion\":8000,\"puntos\":15,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"explosivos\",\"nombre\":\"Explosivos\",\"urlImagen\":\"/img/ent/explosivos.webp\",\"costoArmas\":50000,\"costoMunicion\":50000,\"costoDolares\":0,\"duracion\":200000,\"puntos\":220.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"extorsion\",\"nombre\":\"Extorsión\",\"urlImagen\":\"/img/ent/extorsion.webp\",\"costoArmas\":400,\"costoMunicion\":400,\"costoDolares\":0,\"duracion\":5000,\"puntos\":16.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"guerrilla\",\"nombre\":\"Guerrilla\",\"urlImagen\":\"/img/ent/guerrilla.webp\",\"costoArmas\":100000,\"costoMunicion\":200000,\"costoDolares\":0,\"duracion\":500000,\"puntos\":650.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"honor\",\"nombre\":\"Honor\",\"urlImagen\":\"/img/ent/honor.webp\",\"costoArmas\":5000,\"costoMunicion\":5000,\"costoDolares\":5000,\"duracion\":3600,\"puntos\":100,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"proteccion\",\"nombre\":\"Protección\",\"urlImagen\":\"/img/ent/proteccion.webp\",\"costoArmas\":0,\"costoMunicion\":0,\"costoDolares\":3000,\"duracion\":30000,\"puntos\":35.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"psicologico\",\"nombre\":\"Psicológico\",\"urlImagen\":\"/img/ent/psicologico.webp\",\"costoArmas\":500000,\"costoMunicion\":500000,\"costoDolares\":200000,\"duracion\":1000000,\"puntos\":2300.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"quimico\",\"nombre\":\"Químico\",\"urlImagen\":\"/img/ent/quimico.webp\",\"costoArmas\":1000000,\"costoMunicion\":2000000,\"costoDolares\":500000,\"duracion\":2000000,\"puntos\":7000.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"rutas\",\"nombre\":\"Rutas\",\"urlImagen\":\"/img/ent/rutas.webp\",\"costoArmas\":0,\"costoMunicion\":0,\"costoDolares\":200,\"duracion\":3000,\"puntos\":10.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"seguridad\",\"nombre\":\"Seguridad\",\"urlImagen\":\"/img/ent/seguridad.webp\",\"costoArmas\":2000,\"costoMunicion\":2000,\"costoDolares\":0,\"duracion\":20000,\"puntos\":31.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"},{\"id\":\"tiro\",\"nombre\":\"Tiro\",\"urlImagen\":\"/img/ent/tiro.webp\",\"costoArmas\":10000,\"costoMunicion\":10000,\"costoDolares\":0,\"duracion\":100000,\"puntos\":85.5,\"created_at\":\"2025-12-12 06:01:43.971604+00\",\"updated_at\":\"2025-12-12 06:01:43.971604+00\"}]",
    "src/contexts/pruebas/usuario.json": "[\n    {\n        \"idx\": 0,\n        \"id\": \"a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11\",\n        \"username\": \"Bomberox\",\n        \"pass\":\"password123\",\n        \"email\": \"profematiasprestes@gmail.com\",\n        \"avatarUrl\": \"https://svphlavqptjgyygspmdt.supabase.co/storage/v1/object/public/vendettagame/a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11/1765539726499_badboys_nueva.jpg\",\n        \"name\": \"Bomberox\",\n        \"title\": \"El Padrino\",\n        \"created_at\": \"2025-12-12 10:39:28.326751+00\",\n        \"updated_at\": \"2025-12-12 11:42:07.189593+00\",\n        \"lastSeen\": \"2025-12-12 10:39:28.326751+00\"\n    }\n]",
    "src/components/dashboard/incoming-attacks.tsx": "\n'use client'\n\nimport type { IncomingAttack } from \"@/types\";\nimport { useRouter } from \"next/navigation\";\nimport { useEffect, useState } from \"react\";\nimport { Swords, Users } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"../ui/card\";\n\ntype IncomingAttacksProps = {\n    attacks: IncomingAttack[];\n};\n\nfunction formatTime(totalSeconds: number): string {\n    if (totalSeconds < 0) totalSeconds = 0;\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = Math.floor(totalSeconds % 60);\n    return [hours, minutes, seconds]\n        .map(v => v.toString().padStart(2, '0'))\n        .join(':');\n}\n\nfunction CountdownTimer({ label, endDate, onFinish }: {label: string, endDate: string | Date, onFinish: () => void}) {\n    const [timeLeft, setTimeLeft] = useState('');\n\n    useEffect(() => {\n        const end = new Date(endDate).getTime();\n        const intervalId = setInterval(() => {\n            const now = new Date().getTime();\n            const difference = Math.floor((end - now) / 1000);\n\n            if (difference < -1) { \n                setTimeLeft('00:00:00');\n                clearInterval(intervalId);\n                onFinish();\n            } else {\n                setTimeLeft(formatTime(difference));\n            }\n        }, 1000);\n        \n        const now = new Date().getTime();\n        const difference = Math.floor((end - now) / 1000);\n        setTimeLeft(formatTime(difference > 0 ? difference : 0));\n\n        return () => clearInterval(intervalId);\n    }, [endDate, onFinish]);\n\n    return (\n        <div className=\"flex justify-between items-center text-sm\">\n            <span>{label}</span>\n            <span className=\"font-mono text-destructive\">{timeLeft}</span>\n        </div>\n    );\n}\n\nexport function IncomingAttacks({ attacks }: IncomingAttacksProps) {\n    const router = useRouter();\n\n    const handleRefresh = () => {\n        router.refresh();\n    };\n\n    if (!attacks || attacks.length === 0) {\n         return (\n             <div className=\"border border-green-500/20 bg-green-500/5 rounded-md p-3 flex items-center gap-3 text-green-500/80\">\n                 <Swords className=\"h-5 w-5\" />\n                 <span className=\"text-sm font-medium tracking-wide\">SIN AMENAZAS ACTIVAS</span>\n             </div>\n         );\n    }\n\n    return (\n        <Card className=\"border-destructive/50 animate-pulse-border shadow-[0_0_15px_-3px_rgba(239,68,68,0.2)]\">\n            <CardHeader className=\"flex-row items-center space-x-3 space-y-0 p-4 bg-destructive/20 text-destructive-foreground animate-pulse\">\n                <Swords className=\"h-6 w-6 text-destructive\"/>\n                <CardTitle className=\"font-heading tracking-wider\">ATAQUES ENTRANTES ({attacks.length})</CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-0\">\n                 <div className=\"bg-card text-card-foreground px-4 py-3 rounded-b-md space-y-2\">\n                    {attacks.map(attack => (\n                        <div key={attack.id} className=\"text-sm\">\n                           <div className=\"flex justify-between items-center\">\n                                <span>{attack.attackerName} &rarr; {attack.targetProperty}</span>\n                                <div className=\"flex items-center gap-1\">\n                                    <Users className=\"h-4 w-4 text-muted-foreground\"/>\n                                    <span className=\"font-mono\">{attack.totalTroops}</span>\n                                </div>\n                           </div>\n                           <CountdownTimer \n                                label=\"Tiempo de llegada:\"\n                                endDate={attack.arrivalTime}\n                                onFinish={handleRefresh}\n                           />\n                        </div>\n                    ))}\n                 </div>\n            </CardContent>\n        </Card>\n    )\n}\n",
    "src/components/dashboard/construction-queue.tsx": "'use client';\n\nimport { useEffect, useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport type { FullPropiedad, ColaConstruccion } from '@/types';\nimport { useRouter } from 'next/navigation';\nimport { Clock, Loader2, Timer, X } from 'lucide-react';\nimport { TooltipProvider, Tooltip, TooltipTrigger, TooltipContent } from '../ui/tooltip';\nimport Image from 'next/image';\nimport { MAX_CONSTRUCTION_QUEUE_SIZE } from '@/lib/constants';\nimport { Button } from '../ui/button';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '../ui/alert-dialog';\nimport { useToast } from '@/hooks/use-toast';\nimport { cancelarConstruccion } from '@/lib/actions/room.actions';\n\nfunction formatTime(totalSeconds: number) {\n    if (totalSeconds < 0) totalSeconds = 0;\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = Math.floor(totalSeconds % 60);\n    return [hours, minutes, seconds]\n        .map(v => v.toString().padStart(2, '0'))\n        .join(':');\n}\n\n// Componente hijo para manejar el countdown solo en el cliente\nfunction ClientCountdown({ endDate, onFinish }: { endDate: string | null, onFinish: () => void }) {\n    const [timeLeft, setTimeLeft] = useState<number | null>(null);\n\n    useEffect(() => {\n        if (!endDate) return;\n        \n        const calculateTimeLeft = () => {\n            const endTime = new Date(endDate).getTime();\n            const now = new Date().getTime();\n            return Math.max(0, Math.floor((endTime - now) / 1000));\n        }\n\n        setTimeLeft(calculateTimeLeft());\n\n        const intervalId = setInterval(() => {\n            const newTimeLeft = calculateTimeLeft();\n            setTimeLeft(newTimeLeft);\n\n            if (newTimeLeft === 0) {\n                clearInterval(intervalId);\n                onFinish();\n            }\n        }, 1000);\n\n        return () => clearInterval(intervalId);\n    }, [endDate, onFinish]);\n    \n    if (timeLeft === null) {\n        return <span>--:--:--</span>;\n    }\n\n    return <span>{formatTime(timeLeft)}</span>;\n}\n\nexport function ConstructionQueue({ propiedad, allRooms }: { propiedad: FullPropiedad, allRooms: { id: string; nombre: string; urlImagen: string | null }[] }) {\n    const router = useRouter();\n    const { toast } = useToast();\n    const [pendingAction, setPendingAction] = useState<string | null>(null);\n    \n    const handleCancel = async (colaId: string) => {\n        setPendingAction(colaId);\n        const result = await cancelarConstruccion({ colaId });\n\n        if (result.serverError || result.validationErrors) {\n            const msg = result.serverError || (result.validationErrors ? Object.values(result.validationErrors).flat().join(', ') : 'Error desconocido');\n            toast({ variant: 'destructive', title: 'Error', description: msg });\n        } else if (result.data?.success) {\n            toast({ title: 'Construcción Cancelada', description: result.data.success });\n            router.refresh(); \n        }\n        setPendingAction(null);\n    }\n    \n    const construccionesEnCola = propiedad.colaConstruccion;\n\n    if (construccionesEnCola.length === 0) {\n        return null;\n    }\n\n    return (\n        <Card className=\"mb-4\">\n            <CardHeader>\n                <CardTitle className=\"text-primary flex items-center gap-2\">\n                    <Timer className=\"h-5 w-5\" />\n                    Cola de Construcción ({propiedad.nombre})\n                    <span className='ml-auto text-sm text-muted-foreground'>\n                        ({construccionesEnCola.length}/{MAX_CONSTRUCTION_QUEUE_SIZE})\n                    </span>\n                </CardTitle>\n            </CardHeader>\n            <CardContent className=\"flex flex-wrap gap-2\">\n                {construccionesEnCola.map((colaItem: ColaConstruccion, index: number) => {\n                    const roomConfig = allRooms.find(r => r.id === colaItem.habitacionId);\n                    const esActiva = index === 0 && colaItem.fechaFinalizacion && new Date(colaItem.fechaFinalizacion) > new Date();\n                    const tooltipText = `${roomConfig?.nombre || 'Habitación'} (Nivel ${colaItem.nivelDestino}) ${colaItem.fechaFinalizacion ? ` - Finaliza a las: ${new Date(colaItem.fechaFinalizacion).toLocaleTimeString()}`: ''}`;\n\n                    return (\n                        <div key={colaItem.id} className=\"group flex items-center gap-2 border rounded-full p-1 pr-2 bg-muted/50 hover:bg-muted transition-colors\">\n                            <TooltipProvider delayDuration={0}>\n                                <Tooltip>\n                                    <TooltipTrigger asChild>\n                                        <div\n                                            className=\"flex items-center gap-2 rounded-md px-1 cursor-help focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\"\n                                            tabIndex={0}\n                                            role=\"button\"\n                                            aria-label={`Ver estado de construcción: ${roomConfig?.nombre || 'Habitación'}`}\n                                        >\n                                            <div className=\"w-8 h-8 relative rounded-full overflow-hidden border-2 border-primary/50 flex-shrink-0\">\n                                                <Image\n                                                    src={roomConfig?.urlImagen || \"https://placehold.co/80x56.png\"}\n                                                    alt={roomConfig?.nombre || 'Habitación'}\n                                                    fill\n                                                    className=\"object-cover\"\n                                                />\n                                            </div>\n                                            <div className='flex flex-col items-start'>\n                                                <span className='text-xs font-semibold leading-tight'>{roomConfig?.nombre} (Nvl {colaItem.nivelDestino})</span>\n                                                <div className=\"flex items-center gap-1 font-mono text-sm font-semibold\">\n                                                    <Clock className={`h-4 w-4 ${esActiva ? 'text-green-500 animate-pulse' : 'text-amber-500'}`} />\n                                                    <ClientCountdown endDate={colaItem.fechaFinalizacion} onFinish={() => router.refresh()} />\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </TooltipTrigger>\n                                    <TooltipContent>\n                                        <p>{tooltipText}</p>\n                                    </TooltipContent>\n                                </Tooltip>\n                            </TooltipProvider>\n                             <AlertDialog>\n                                <AlertDialogTrigger asChild>\n                                    <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6 rounded-full opacity-50 group-hover:opacity-100 hover:bg-destructive/20 hover:text-destructive\">\n                                        <X className=\"h-4 w-4\"/>\n                                        <span className=\"sr-only\">Cancelar construcción</span>\n                                    </Button>\n                                </AlertDialogTrigger>\n                                <AlertDialogContent>\n                                    <AlertDialogHeader>\n                                        <AlertDialogTitle>¿Cancelar Construcción?</AlertDialogTitle>\n                                        <AlertDialogDescription>\n                                            Se te devolverán los recursos invertidos. ¿Estás seguro de que quieres cancelar la construcción de {roomConfig?.nombre} Nivel {colaItem.nivelDestino}?\n                                        </AlertDialogDescription>\n                                    </AlertDialogHeader>\n                                    <AlertDialogFooter>\n                                        <AlertDialogCancel>No</AlertDialogCancel>\n                                        <AlertDialogAction onClick={() => handleCancel(colaItem.id)} disabled={pendingAction === colaItem.id}>\n                                            {pendingAction === colaItem.id && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/>}\n                                            Sí, cancelar\n                                        </AlertDialogAction>\n                                    </AlertDialogFooter>\n                                </AlertDialogContent>\n                            </AlertDialog>\n                        </div>\n                    );\n                })}\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/queue-status-card.tsx": "'use client';\n\nimport type { UserWithProgress, UserForOverview } from '@/types';\nimport { ConstructionStatus } from './construction-status';\nimport { Hammer } from 'lucide-react';\nimport { Card, CardHeader, CardTitle } from '../ui/card';\nimport { memo } from 'react';\nimport { useGameConfig } from '@/contexts/GameConfigContext';\nimport { QueueCard } from './queue-card';\n\ntype QueueStatusCardProps = {\n    user: UserWithProgress | UserForOverview;\n};\n\nexport const QueueStatusCard = memo(function QueueStatusCard({ user }: QueueStatusCardProps) {\n    const { allRooms } = useGameConfig();\n    \n    // --- Preparación de datos para Construcción ---\n    const activeConstructionsPerProperty = user.propiedades\n        .map((p) => {\n            const activeConstruction = p.colaConstruccion.find((c) => c.fechaFinalizacion && new Date(c.fechaFinalizacion) > new Date());\n            const roomConfig = allRooms.find(r => r.id === activeConstruction?.habitacionId);\n            return activeConstruction ? { \n                ...activeConstruction, \n                propiedadNombre: roomConfig?.nombre || 'Edificio',\n                ciudad: p.ciudad,\n                barrio: p.barrio,\n                edificio: p.edificio,\n                urlImagen: roomConfig?.urlImagen || null\n            } : null;\n        })\n        .filter((c): c is NonNullable<typeof c> => c !== null)\n        .sort((a, b) => new Date(a.fechaFinalizacion!).getTime() - new Date(b.fechaFinalizacion!).getTime());\n\n    const propertiesWithActiveConstruction = user.propiedades.filter((p) =>\n        p.colaConstruccion.some((c) => c.fechaFinalizacion && new Date(c.fechaFinalizacion) > new Date())\n    ).length;\n    \n    const totalProperties = user.propiedades.length;\n\n    // --- Preparación de datos para Reclutamiento (con coordenadas) ---\n    const activeRecruitments = user.propiedades\n        .flatMap(p => {\n            // CORRECCIÓN: Asegurar que p.colaReclutamiento es un array antes de mapear.\n            const recruitmentQueue = Array.isArray(p.colaReclutamiento) ? p.colaReclutamiento : (p.colaReclutamiento ? [p.colaReclutamiento] : []);\n            return recruitmentQueue.map(r => ({ \n                ...r, \n                coords: `${p.ciudad}:${p.barrio}:${p.edificio}`,\n                propertyName: p.nombre \n            }));\n        })\n        .filter(r => r.fechaFinalizacion && new Date(r.fechaFinalizacion) > new Date())\n        .sort((a, b) => new Date(a.fechaFinalizacion).getTime() - new Date(b.fechaFinalizacion).getTime());\n\n    // --- Preparación de datos para Entrenamiento (con coordenadas) ---\n    const activeTrainings = user.colaEntrenamientos.map(t => {\n        const prop = user.propiedades.find(p => p.id === t.propiedadId);\n        return {\n            ...t,\n            coords: prop ? `${prop.ciudad}:${prop.barrio}:${prop.edificio}` : '???'\n        }\n    });\n\n    return (\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n            <Card className=\"md:col-span-1\">\n                 <CardHeader className=\"flex-row items-center space-x-3 space-y-0 p-3 bg-muted/20\">\n                    <Hammer className=\"h-6 w-6 text-primary\"/>\n                    <CardTitle className=\"font-heading tracking-wider text-primary\">CONSTRUCCIÓN ({propertiesWithActiveConstruction}/{totalProperties})</CardTitle>\n                </CardHeader>\n                <ConstructionStatus constructions={activeConstructionsPerProperty} />\n            </Card>\n            \n            <QueueCard \n                queueType=\"training\"\n                activeTrainings={activeTrainings}\n                className=\"md:col-span-1\"\n            />\n            \n            <QueueCard \n                queueType=\"recruitment\"\n                activeRecruitments={activeRecruitments}\n                className=\"md:col-span-1\"\n            />\n        </div>\n    );\n})\n",
    "src/components/dashboard/mafia-room-card.tsx": "// This component has been replaced by the more generic GameCard component\n// and is no longer needed. It is being deleted.\n",
    "src/components/dashboard/construction-status.tsx": "\n'use client';\n\nimport { useRouter } from \"next/navigation\";\nimport { QueueItem } from \"./queue-item\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { cancelarConstruccion } from \"@/lib/actions/room.actions\";\n\ntype ActiveConstruction = {\n    id: string;\n    habitacionId: string;\n    nivelDestino: number;\n    fechaFinalizacion: string | null;\n    propiedadNombre: string;\n    ciudad: number;\n    barrio: number;\n    edificio: number;\n    urlImagen: string | null;\n}\n\ntype ConstructionStatusProps = {\n    constructions: ActiveConstruction[];\n};\n\nexport function ConstructionStatus({ constructions }: ConstructionStatusProps) {\n    const router = useRouter();\n    const { toast } = useToast();\n\n    const handleRefresh = () => {\n        router.refresh();\n    };\n\n    const handleCancel = async (colaId: string) => {\n        const result = await cancelarConstruccion({ colaId });\n\n        if (result.serverError || result.validationErrors) {\n             const msg = result.serverError || (result.validationErrors ? Object.values(result.validationErrors).flat().join(', ') : 'Error desconocido');\n            toast({ variant: 'destructive', title: 'Error', description: msg });\n        } else if (result.data?.success) {\n            toast({ title: 'Construcción Cancelada', description: result.data.success });\n        }\n    };\n\n    if (constructions.length === 0) {\n        return (\n             <p className=\"text-muted-foreground text-center text-xs py-2\">No hay construcciones en cola.</p>\n        );\n    }\n\n    return (\n        <div className=\"bg-card text-card-foreground px-2 py-2 rounded-b-md space-y-1\">\n            {constructions.map(queueItem => {\n                if (!queueItem.fechaFinalizacion) return null;\n                \n                return (\n                     <QueueItem\n                        key={queueItem.id}\n                        label={queueItem.propiedadNombre}\n                        info={`N${queueItem.nivelDestino}`}\n                        coords={`${queueItem.ciudad}:${queueItem.barrio}:${queueItem.edificio}`}\n                        endDate={queueItem.fechaFinalizacion}\n                        image={queueItem.urlImagen}\n                        onCancel={() => handleCancel(queueItem.id)}\n                        onFinish={handleRefresh}\n                     />\n                )\n            })}\n        </div>\n    );\n}\n",
    "src/components/dashboard/messages/compose-message.tsx": "'use client';\n\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Plus } from \"lucide-react\";\nimport { useTransition, useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2 } from \"lucide-react\";\nimport { sendMessage } from \"@/lib/actions/message.actions\";\nimport type { UserWithProgress } from \"@/types\";\n\ninterface ComposeMessageProps {\n    allUsers: { id: string; name: string }[];\n    currentUser: UserWithProgress;\n}\n\nexport function ComposeMessage({ allUsers, currentUser }: ComposeMessageProps) {\n    const [isOpen, setIsOpen] = useState(false);\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n\n    const otherUsers = allUsers.filter(u => u.id !== currentUser.id);\n\n    const handleSubmit = async (formData: FormData) => {\n        startTransition(async () => {\n            const result = await sendMessage(formData);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Mensaje enviado correctamente.' });\n                setIsOpen(false);\n            }\n        });\n    }\n\n    return (\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\n            <DialogTrigger asChild>\n                <Button>\n                    <Plus className=\"mr-2 h-4 w-4\" />\n                    Nuevo Mensaje\n                </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[625px]\">\n                <DialogHeader>\n                    <DialogTitle>Enviar Nuevo Mensaje</DialogTitle>\n                    <DialogDescription>\n                        Contacta con otros jugadores de Vendetta.\n                    </DialogDescription>\n                </DialogHeader>\n                <form action={handleSubmit} className=\"space-y-4\">\n                     <div className=\"space-y-2\">\n                        <Label htmlFor=\"recipientId\">Destinatario</Label>\n                        <Select name=\"recipientId\" required>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"Selecciona un jugador...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {otherUsers.map(user => (\n                                    <SelectItem key={user.id} value={user.id}>{user.name}</SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                     <div className=\"space-y-2\">\n                        <Label htmlFor=\"subject\">Asunto</Label>\n                        <Input id=\"subject\" name=\"subject\" placeholder=\"Asunto del mensaje\" required />\n                    </div>\n                     <div className=\"space-y-2\">\n                        <Label htmlFor=\"content\">Mensaje</Label>\n                        <Textarea id=\"content\" name=\"content\" placeholder=\"Escribe tu mensaje aquí...\" required />\n                    </div>\n                    <DialogFooter>\n                        <Button type=\"submit\" disabled={isPending}>\n                             {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                             Enviar Mensaje\n                        </Button>\n                    </DialogFooter>\n                </form>\n            </DialogContent>\n        </Dialog>\n    );\n}\n",
    "src/components/dashboard/messages/message-folder-list.tsx": "\n'use client';\n\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { Hammer, Settings, Shield, Users } from \"lucide-react\";\nimport { useRouter, usePathname, useSearchParams } from \"next/navigation\";\n\nconst folders = [\n    { name: \"Mensajes Jugadores\", category: \"JUGADOR\", icon: <Users className=\"h-5 w-5\" /> },\n    { name: \"Informes de Batalla\", category: \"BATALLA\", icon: <Shield className=\"h-5 w-5\" /> },\n    { name: \"Construcciones y Tropas\", category: \"CONSTRUCCION\", icon: <Hammer className=\"h-5 w-5\" /> },\n    { name: \"Sistema\", category: \"SISTEMA\", icon: <Settings className=\"h-5 w-5\" /> },\n];\n\ninterface MessageFolderListProps {\n    selectedCategory: string;\n    setSelectedCategory: (category: string) => void;\n}\n\nexport function MessageFolderList({ selectedCategory, setSelectedCategory }: MessageFolderListProps) {\n    const router = useRouter();\n    const pathname = usePathname();\n    const searchParams = useSearchParams();\n\n    const handleClick = (category: string) => {\n        setSelectedCategory(category);\n        const params = new URLSearchParams(searchParams);\n        params.set('categoria', category);\n        router.push(`${pathname}?${params.toString()}`);\n    };\n\n    return (\n        <div className=\"space-y-2\">\n            <h3 className=\"text-lg font-semibold px-2\">Carpetas</h3>\n            <div className=\"flex flex-col gap-1\">\n                {folders.map(folder => (\n                    <Button\n                        key={folder.category}\n                        variant={selectedCategory === folder.category ? \"default\" : \"ghost\"}\n                        className=\"w-full justify-start gap-3 px-4 py-6 text-base\"\n                        onClick={() => handleClick(folder.category)}\n                    >\n                        {folder.icon}\n                        <span>{folder.name}</span>\n                    </Button>\n                ))}\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/messages/messages-view.tsx": "'use client';\n\nimport { useState } from \"react\";\nimport { MessageList } from \"./message-list\";\nimport { MessageFolderList } from \"./message-folder-list\";\nimport type { FullMessage, UserWithProgress, FullBattleReport, FullEspionageReport } from \"@/types\";\nimport { ComposeMessage } from \"./compose-message\";\nimport { MessageDetail } from \"./message-detail\";\nimport { cn } from \"@/lib/utils\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { BrawlsView } from \"../brawls/brawls-view\";\nimport { EspionageListView } from \"../espionage/espionage-list-view\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\n\ntype FeedItem = (FullMessage & { type: 'message' }) \n                | (FullBattleReport & { type: 'battle' }) \n                | (FullEspionageReport & { type: 'espionage' });\n\ninterface MessagesViewProps {\n    currentUser: UserWithProgress;\n    initialFeed: FeedItem[];\n    allUsers: { id: string; name: string }[];\n}\n\nexport function MessagesView({ currentUser, initialFeed, allUsers }: MessagesViewProps) {\n    const [selectedMessage, setSelectedMessage] = useState<FullMessage | null>(null);\n\n    const messages = initialFeed.filter(item => item.type === 'message') as (FullMessage & {type: 'message'})[];\n    const battleReports = initialFeed.filter(item => item.type === 'battle') as (FullBattleReport & {type: 'battle'})[];\n    const espionageReports = initialFeed.filter(item => item.type === 'espionage') as (FullEspionageReport & {type: 'espionage'})[];\n\n    const handleSelectMessage = (message: FullMessage) => {\n        setSelectedMessage(message);\n    }\n    \n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Centro de Notificaciones</h2>\n                    <p className=\"text-muted-foreground\">\n                        Comunícate y mantente al tanto de las novedades.\n                    </p>\n                </div>\n                 <div className=\"flex items-center gap-2\">\n                    <Button asChild variant=\"outline\">\n                        <Link href=\"/brawls\">Ver Historial de Batallas Global</Link>\n                    </Button>\n                    <ComposeMessage allUsers={allUsers} currentUser={currentUser} />\n                </div>\n            </div>\n             <Tabs defaultValue=\"messages\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-3\">\n                    <TabsTrigger value=\"messages\">Mensajes ({messages.length})</TabsTrigger>\n                    <TabsTrigger value=\"battles\">Batallas ({battleReports.length})</TabsTrigger>\n                    <TabsTrigger value=\"espionage\">Espionaje ({espionageReports.length})</TabsTrigger>\n                </TabsList>\n                <TabsContent value=\"messages\">\n                    <div className=\"border rounded-lg md:grid md:grid-cols-[250px_1fr] lg:grid-cols-[250px_minmax(0,1fr)_minmax(0,2fr)] h-[calc(100vh-280px)] overflow-hidden\">\n                        <div className={cn(\"p-4 border-r\", selectedMessage && \"hidden md:block\")}>\n                             <MessageFolderList \n                                selectedCategory={\"JUGADOR\"} \n                                setSelectedCategory={() => {}} \n                            />\n                        </div>\n\n                        <div className={cn(\"border-r\", selectedMessage && \"hidden md:block\")}>\n                             <MessageList \n                                messages={messages}\n                                selectedMessageId={selectedMessage?.id || null}\n                                onSelectMessage={handleSelectMessage}\n                            />\n                        </div>\n\n                        <div className={cn(\"lg:col-span-1\", !selectedMessage && \"hidden md:block\")}>\n                            {selectedMessage ? (\n                                 <MessageDetail \n                                    key={selectedMessage.id}\n                                    message={selectedMessage}\n                                    onBack={() => setSelectedMessage(null)}\n                                />\n                            ) : (\n                                <div className=\"flex items-center justify-center h-full text-muted-foreground p-8 text-center\">\n                                    <p>Selecciona un mensaje para leerlo o explora las otras pestañas para ver tus informes.</p>\n                                </div>\n                            )}\n                        </div>\n                    </div>\n                </TabsContent>\n                 <TabsContent value=\"battles\">\n                     <BrawlsView initialReports={battleReports} currentUserId={currentUser.id} />\n                </TabsContent>\n                <TabsContent value=\"espionage\">\n                    <EspionageListView initialReports={espionageReports} currentUserId={currentUser.id} />\n                </TabsContent>\n            </Tabs>\n        </div>\n    );\n}\n",
    "src/components/dashboard/messages/message-detail.tsx": "'use client';\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { FullMessage } from \"@/types\";\nimport { ArrowLeft, Reply, Trash2, Swords } from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Shield } from \"lucide-react\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport Link from \"next/link\";\n\n\ninterface MessageDetailProps {\n    message: FullMessage;\n    onBack: () => void;\n}\n\nexport function MessageDetail({ message, onBack }: MessageDetailProps) {\n    return (\n       <div className=\"flex flex-col h-full\">\n            <div className=\"p-4 border-b flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 flex-shrink-0 md:hidden\" onClick={onBack}>\n                        <ArrowLeft className=\"h-5 w-5\" />\n                    </Button>\n                    <Avatar className=\"h-10 w-10\">\n                         {message.sender ? (\n                            <AvatarImage src={message.sender.avatarUrl || ''} />\n                        ) : (\n                            <Shield className=\"h-full w-full p-2 text-muted-foreground\"/>\n                        )}\n                        <AvatarFallback>{message.sender?.name?.[0] || 'S'}</AvatarFallback>\n                    </Avatar>\n                     <div className=\"overflow-hidden\">\n                        <p className=\"font-semibold truncate\">{message.sender?.name || \"Sistema\"}</p>\n                        <p className=\"text-xs text-muted-foreground\">Recibido: {new Date(message.created_at).toLocaleString('es-ES')}</p>\n                    </div>\n                </div>\n                 <div className=\"flex items-center gap-2\">\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                        <Reply className=\"h-4 w-4\" />\n                        <span className=\"sr-only\">Responder</span>\n                    </Button>\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-destructive hover:text-destructive\">\n                        <Trash2 className=\"h-4 w-4\" />\n                         <span className=\"sr-only\">Eliminar</span>\n                    </Button>\n                 </div>\n            </div>\n             <div className=\"p-6 border-b\">\n                 <h2 className=\"text-xl font-bold\">{message.subject}</h2>\n            </div>\n             {message.battleReportId && (\n                <div className=\"p-4 border-b\">\n                    <Button asChild className=\"w-full\">\n                        <Link href={`/brawls/${message.battleReportId}`}>\n                            <Swords className=\"mr-2 h-4 w-4\" />\n                            Ver Informe de Batalla\n                        </Link>\n                    </Button>\n                </div>\n            )}\n            <ScrollArea className=\"flex-grow\">\n                 <div className=\"p-6 whitespace-pre-wrap text-sm leading-relaxed\">\n                    {message.content}\n                </div>\n            </ScrollArea>\n       </div>\n    );\n}\n",
    "src/components/dashboard/messages/message-list.tsx": "'use client';\n\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport type { FullMessage } from \"@/types\";\nimport { Inbox, Trash2, Shield, User } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { deleteMessage, markMessageAsRead } from \"@/lib/actions/message.actions\";\nimport { useTransition } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\n\n\ninterface MessageListProps {\n    messages: FullMessage[];\n    selectedMessageId: string | null;\n    onSelectMessage: (message: FullMessage) => void;\n}\n\nexport function MessageList({ messages, selectedMessageId, onSelectMessage }: MessageListProps) {\n    const [isDeleting, startDeleteTransition] = useTransition();\n    const { toast } = useToast();\n\n    const handleSelectAndRead = (message: FullMessage) => {\n        onSelectMessage(message);\n        if (!message.isRead) {\n            // Optimistically mark as read on the client\n            message.isRead = true; \n            markMessageAsRead(message.id);\n        }\n    }\n\n    const handleDelete = (e: React.MouseEvent, messageId: string) => {\n        e.stopPropagation(); // Prevent message selection\n        startDeleteTransition(async () => {\n            const result = await deleteMessage(messageId);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Mensaje eliminado' });\n                if (selectedMessageId === messageId) {\n                    onSelectMessage(null as any); // Clear selection\n                }\n            }\n        });\n    }\n\n    return (\n        <ScrollArea className=\"h-full\">\n            <div className=\"p-2 space-y-1\">\n                {messages.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center h-full text-muted-foreground p-8\">\n                        <Inbox className=\"h-16 w-16\" />\n                        <p className=\"mt-4 text-lg\">No hay mensajes</p>\n                    </div>\n                ) : (\n                    messages.map(message => (\n                        <div \n                            key={message.id} \n                            className={cn(\n                                \"group p-3 rounded-lg flex items-start gap-3 cursor-pointer hover:bg-muted/50 transition-colors\",\n                                selectedMessageId === message.id ? \"bg-muted\" : \"bg-transparent\",\n                                !message.isRead && \"font-bold\"\n                            )}\n                            onClick={() => handleSelectAndRead(message)}\n                        >\n                            <div className=\"flex-shrink-0 pt-1\">\n                                {!message.isRead && (\n                                     <span className=\"block h-2.5 w-2.5 rounded-full bg-blue-500\" title=\"No leído\"></span>\n                                )}\n                            </div>\n                            <Avatar className=\"h-9 w-9\">\n                                {message.sender ? (\n                                    <AvatarImage src={message.sender.avatarUrl || ''} />\n                                ) : (\n                                    <Shield className=\"h-full w-full p-2 text-muted-foreground\"/>\n                                )}\n                                <AvatarFallback>{message.sender?.name?.[0] || 'S'}</AvatarFallback>\n                            </Avatar>\n                            <div className=\"flex-grow overflow-hidden\">\n                                <div className=\"flex justify-between items-baseline\">\n                                     <p className=\"font-semibold truncate\">{message.sender?.name || \"Sistema\"}</p>\n                                      <p className=\"text-xs text-muted-foreground flex-shrink-0\">\n                                        {new Date(message.created_at).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })}\n                                      </p>\n                                </div>\n                                <p className=\"font-medium truncate text-sm\">{message.subject}</p>\n                                <p className=\"text-xs text-muted-foreground truncate\">{message.content}</p>\n                            </div>\n                            <Button \n                                variant=\"ghost\" \n                                size=\"icon\" \n                                className=\"h-8 w-8 text-muted-foreground opacity-100 transition-opacity md:opacity-0 md:group-hover:opacity-100\" \n                                onClick={(e) => handleDelete(e, message.id)} \n                                disabled={isDeleting}\n                                aria-label=\"Eliminar mensaje\"\n                            >\n                                <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                        </div>\n                    ))\n                )}\n            </div>\n        </ScrollArea>\n    );\n}\n",
    "src/components/dashboard/profile/profile-view.tsx": "\n'use client';\n\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { UserProfileData } from \"@/types\";\nimport { Building, Send } from \"lucide-react\";\nimport { useRouter } from \"next/navigation\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\n\ninterface ProfileViewProps {\n    user: UserProfileData;\n    resources?: { id: string; nombre: string; alcohol: number; armas: number; dolares: number; municion: number }[];\n    activeMissionsCount?: number;\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nexport function ProfileView({ user, resources, activeMissionsCount }: ProfileViewProps) {\n    const router = useRouter();\n\n    const handleSendMission = (ciudad: number, barrio: number, edificio: number) => {\n        const params = new URLSearchParams();\n        params.set('ciudad', ciudad.toString());\n        params.set('barrio', barrio.toString());\n        params.set('edificio', edificio.toString());\n        router.push(`/missions?${params.toString()}`);\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <Card className=\"overflow-hidden\">\n                <div className=\"relative h-40 bg-muted\">\n                    <Image \n                        src=\"/img/general/fondo.jpg\" \n                        alt=\"Profile Banner\" \n                        fill \n                        sizes=\"100vw\"\n                        className=\"object-cover\"\n                        data-ai-hint=\"dark city skyline\"\n                    />\n                     <div className=\"absolute inset-0 bg-gradient-to-t from-black/80 to-transparent\" />\n                </div>\n                <div className=\"p-4 flex flex-col items-center sm:flex-row sm:items-end gap-4 -mt-16 sm:-mt-20 z-10 relative\">\n                     <Avatar className=\"h-32 w-32 border-4 border-background shadow-lg\">\n                        <AvatarImage src={user.avatarUrl || ''} alt={user.name} data-ai-hint=\"mafia boss\" />\n                        <AvatarFallback className=\"text-4xl\">{user.name?.charAt(0).toUpperCase()}</AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-grow text-center sm:text-left\">\n                        {user.familyMember && (\n                             <Link href={`/family/members?id=${user.familyMember.family.id}`} className=\"flex items-center gap-2 hover:underline justify-center sm:justify-start\">\n                                 <Avatar className=\"h-6 w-6\">\n                                    <AvatarImage src={user.familyMember.family.avatarUrl || ''} />\n                                    <AvatarFallback>{user.familyMember.family.tag.charAt(0)}</AvatarFallback>\n                                </Avatar>\n                                <span className=\"font-semibold text-primary\">[{user.familyMember.family.tag}] {user.familyMember.family.name}</span>\n                             </Link>\n                        )}\n                        <h2 className=\"text-4xl font-bold tracking-tight font-heading\">{user.name}</h2>\n                        <p className=\"text-lg text-muted-foreground\">{user.title || 'Jefe Mafioso'}</p>\n                    </div>\n                    <div className=\"text-center sm:text-right\">\n                        <p className=\"text-xs text-muted-foreground\">Puntos Totales</p>\n                        <p className=\"text-4xl font-bold text-primary font-mono\">{formatPoints(user.puntuacion?.puntosTotales)}</p>\n                        {typeof activeMissionsCount === 'number' && (\n                             <p className=\"text-xs text-muted-foreground mt-2\">Misiones Activas: <span className=\"text-foreground font-semibold\">{activeMissionsCount}</span></p>\n                        )}\n                    </div>\n                </div>\n            </Card>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <div className=\"md:col-span-2 space-y-6\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Estadísticas de Puntuación</CardTitle>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                            <div className=\"flex justify-between items-baseline\"><span className=\"text-muted-foreground\">Puntos de Edificios</span><span className=\"font-semibold font-mono\">{formatPoints(user.puntuacion?.puntosHabitaciones)}</span></div>\n                            <Separator />\n                            <div className=\"flex justify-between items-baseline\"><span className=\"text-muted-foreground\">Puntos de Tropas</span><span className=\"font-semibold font-mono\">{formatPoints(user.puntuacion?.puntosTropas)}</span></div>\n                            <Separator />\n                            <div className=\"flex justify-between items-baseline\"><span className=\"text-muted-foreground\">Puntos de Entrenamiento</span><span className=\"font-semibold font-mono\">{formatPoints(user.puntuacion?.puntosEntrenamientos)}</span></div>\n                            <Separator />\n                             <div className=\"flex justify-between items-baseline\"><span className=\"text-muted-foreground font-bold\">Puntos de Honor (Total)</span><span className=\"font-semibold font-mono text-primary\">{formatPoints(user.puntuacion?.puntosHonorTotales)}</span></div>\n                            <Separator />\n                             <div className=\"flex justify-between text-xs text-muted-foreground pt-2\">\n                                <span>Miembro desde</span>\n                                <span>{new Date(user.created_at).toLocaleDateString('es-ES')}</span>\n                            </div>\n                        </CardContent>\n                    </Card>\n                </div>\n\n                <Card className=\"md:col-span-1\">\n                    <CardHeader>\n                        <CardTitle>Propiedades</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                        <div className=\"space-y-2 max-h-96 overflow-y-auto pr-2\">\n                            {user.propiedades.map(prop => (\n                                <div key={prop.id} className=\"flex justify-between items-center p-2 rounded-md hover:bg-muted/50\">\n                                    <div>\n                                        <p className=\"font-semibold\">{prop.nombre}</p>\n                                        <p className=\"text-sm text-muted-foreground\">[{prop.ciudad}:{prop.barrio}:{prop.edificio}]</p>\n                                        {resources?.find(r => r.id === prop.id) && (\n                                            <div className=\"text-xs text-muted-foreground mt-1 grid grid-cols-2 gap-x-2\">\n                                                <span title=\"Dólares\">💵 {resources.find(r => r.id === prop.id)?.dolares}</span>\n                                                <span title=\"Armas\">🔫 {resources.find(r => r.id === prop.id)?.armas}</span>\n                                                <span title=\"Alcohol\">🥃 {resources.find(r => r.id === prop.id)?.alcohol}</span>\n                                                <span title=\"Munición\">💣 {resources.find(r => r.id === prop.id)?.municion}</span>\n                                            </div>\n                                        )}\n                                    </div>\n                                    <div className=\"flex items-center\">\n                                        <Button asChild size=\"sm\" variant=\"ghost\">\n                                            <Link href=\"/rooms\">\n                                                <Building className=\"mr-2 h-4 w-4\" />\n                                                Gestionar\n                                            </Link>\n                                        </Button>\n                                    </div>\n                                </div>\n                            ))}\n                        </div>\n                    </CardContent>\n                </Card>\n            </div>\n        </div>\n    )\n}\n",
    "src/components/dashboard/espionage/espionage-detail-view.tsx": "\n'use client';\n\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { cn } from \"@/lib/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ArrowLeft, CheckCircle, Eye, XCircle } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport type { FullEspionageReport, EspionageReportDetails } from \"@/types\";\nimport { resourceIcons, ROOM_ORDER } from \"@/lib/constants\";\nimport Image from \"next/image\";\nimport { useMemo } from \"react\";\n\ninterface EspionageDetailViewProps {\n    report: FullEspionageReport;\n}\n\nfunction formatNumber(num: number): string {\n    if(num === undefined || num === null) return \"0\";\n    return Math.floor(num).toLocaleString('de-DE');\n}\n\nexport function EspionageDetailView({ report }: EspionageDetailViewProps) {\n    const router = useRouter();\n    const details = report.details as EspionageReportDetails;\n    const combat = details.combat;\n    const intel = details.intel;\n\n    const sortedBuildings = useMemo(() => {\n        if (!intel?.buildings) return [];\n        return [...intel.buildings].sort((a, b) => {\n            const indexA = ROOM_ORDER.indexOf(a.id);\n            const indexB = ROOM_ORDER.indexOf(b.id);\n            if (indexA === -1) return 1;\n            if (indexB === -1) return -1;\n            return indexA - indexB;\n        });\n    }, [intel?.buildings]);\n\n    return (\n        <div className=\"w-full max-w-4xl mx-auto bg-black/80 border-primary border text-white font-mono flex flex-col h-full rounded-lg\">\n            <div className=\"p-6 pb-2 shrink-0 text-center\">\n                <h2 className=\"text-2xl text-primary tracking-widest font-heading\">\n                    INFORME DE ESPIONAJE\n                </h2>\n                <p className=\"text-sm text-muted-foreground\">\n                    {new Date(report.created_at).toLocaleString('es-ES')}\n                </p>\n            </div>\n             <div className=\"flex flex-row items-center justify-around p-4 border-y border-dashed border-white/20 gap-4 shrink-0\">\n                <Link href={`/profile/${report.attacker.id}`} className=\"flex flex-col items-center gap-2\">\n                    <Avatar className=\"h-16 w-16 md:h-20 md:w-20\"><AvatarImage src={report.attacker.avatarUrl || ''} /><AvatarFallback>{report.attacker.name.charAt(0)}</AvatarFallback></Avatar>\n                    <span className=\"font-bold text-base md:text-lg\">{report.attacker.name}</span>\n                </Link>\n                <Eye className=\"h-10 w-10 text-destructive\" />\n                <Link href={`/profile/${report.defender.id}`} className=\"flex flex-col items-center gap-2\">\n                    <Avatar className=\"h-16 w-16 md:h-20 md:w-20\"><AvatarImage src={report.defender.avatarUrl || ''} /><AvatarFallback>{report.defender.name.charAt(0)}</AvatarFallback></Avatar>\n                    <span className=\"font-bold text-base md:text-lg\">{report.defender.name}</span>\n                </Link>\n            </div>\n            <ScrollArea className=\"flex-grow min-h-0\">\n                <div className=\"space-y-4 p-4\">\n                     <Card className={cn(\"p-4 text-center\", intel ? \"bg-green-900/50 border-green-500/50\" : \"bg-red-900/50 border-red-500/50\")}>\n                        <h3 className={cn(\"text-xl font-bold flex items-center justify-center gap-2\", intel ? \"text-green-400\" : \"text-red-400\")}>\n                            {intel ? <CheckCircle /> : <XCircle />}\n                            {intel ? \"Misión de Espionaje Exitosa\" : \"Misión de Espionaje Fallida\"}\n                        </h3>\n                    </Card>\n                    \n                    {intel ? (\n                        <Card>\n                            <CardHeader><CardTitle>Intel Recopilada</CardTitle></CardHeader>\n                            <CardContent className=\"space-y-6\">\n                                <div>\n                                    <h4 className=\"font-semibold text-lg mb-2\">Recursos</h4>\n                                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                                        {Object.entries(intel.resources).map(([key, value]) => (\n                                            <div key={key} className=\"flex items-center gap-3 bg-muted/50 p-3 rounded-md\">\n                                                <Image src={resourceIcons[key]} alt={key} width={24} height={24} />\n                                                <div>\n                                                    <p className=\"text-xs capitalize text-muted-foreground\">{key}</p>\n                                                    <p className=\"font-bold font-mono text-lg\">{formatNumber(Number(value))}</p>\n                                                </div>\n                                            </div>\n                                        ))}\n                                    </div>\n                                </div>\n                                <Separator />\n                                <div>\n                                     <h4 className=\"font-semibold text-lg mb-2\">Edificios</h4>\n                                     <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm\">\n                                        {sortedBuildings.map(b => (\n                                            <div key={b.id} className=\"flex justify-between items-baseline p-2 border-b\">\n                                                <span className=\"truncate pr-2\">{b.name}</span>\n                                                <span className=\"font-bold\">Nvl {b.level}</span>\n                                            </div>\n                                        ))}\n                                     </div>\n                                </div>\n                            </CardContent>\n                        </Card>\n                    ) : (\n                         <p className=\"text-center text-muted-foreground p-6 border rounded-lg\">Tus espías fueron detectados y no se pudo obtener información de la propiedad.</p>\n                    )}\n\n                </div>\n            </ScrollArea>\n             <div className=\"p-4 pt-4 border-t shrink-0\">\n                <Button onClick={() => router.back()} className=\"w-full\" variant=\"outline\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\"/>\n                    Volver\n                </Button>\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/espionage/espionage-list-view.tsx": "\n'use client';\n\nimport { useState } from 'react';\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { cn } from '@/lib/utils';\nimport { Eye, ChevronsRight, CheckCircle, XCircle } from \"lucide-react\";\nimport { Button } from '@/components/ui/button';\nimport type { FullEspionageReport } from '@/types';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { useRouter } from 'next/navigation';\n\ninterface EspionageListViewProps {\n    initialReports: FullEspionageReport[];\n    currentUserId: string;\n}\n\nexport function EspionageListView({ initialReports, currentUserId }: EspionageListViewProps) {\n    const router = useRouter();\n\n    const sortedReports = initialReports.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n\n    return (\n        <Card>\n             <ScrollArea className=\"h-[calc(100vh-340px)]\">\n                <CardContent className=\"p-0\">\n                    <div className=\"divide-y divide-border\">\n                        {sortedReports.length > 0 ? (\n                            sortedReports.map(report => {\n                                const isAttacker = report.attackerId === currentUserId;\n                                const opponent = isAttacker ? report.defender : report.attacker;\n                                const wasSuccess = !!report.details.intel;\n\n                                return (\n                                    <div\n                                        key={report.id}\n                                        className={cn(\n                                            \"p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 cursor-pointer hover:bg-muted/50 transition-colors ease-in-out\",\n                                            wasSuccess ? \"border-l-4 border-green-500/70\" : \"border-l-4 border-destructive/70\"\n                                        )}\n                                        onClick={() => router.push(`/espionage/${report.id}`)}\n                                    >\n                                        <div className=\"flex items-center gap-4\">\n                                            <div className=\"flex-shrink-0\">\n                                                {wasSuccess ? (\n                                                    <CheckCircle className=\"h-8 w-8 text-green-500\" />\n                                                ) : (\n                                                    <XCircle className=\"h-8 w-8 text-destructive\" />\n                                                )}\n                                            </div>\n                                            <div>\n                                                <p className=\"font-bold\">\n                                                    {isAttacker ? \"Espionaje a\" : \"Espionaje de\"} {opponent.name}\n                                                </p>\n                                                <p className=\"text-xs text-muted-foreground\">\n                                                    {new Date(report.created_at).toLocaleString('es-ES')}\n                                                </p>\n                                            </div>\n                                        </div>\n                                        <div className=\"sm:ml-auto\">\n                                            <Button variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto\">\n                                                Ver Informe\n                                                <ChevronsRight className=\"ml-2 h-4 w-4\" />\n                                            </Button>\n                                        </div>\n                                    </div>\n                                );\n                            })\n                        ) : (\n                            <div className=\"p-8 text-center text-muted-foreground\">\n                                No tienes informes de espionaje.\n                            </div>\n                        )}\n                    </div>\n                </CardContent>\n             </ScrollArea>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/troop-details-modal.tsx": "\n'use client';\n\nimport Image from 'next/image';\nimport { DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogClose, DialogFooter } from '@/components/ui/dialog';\nimport { ScrollArea } from '../ui/scroll-area';\nimport { Button } from '../ui/button';\nimport type { ConfiguracionTropa, UserWithProgress } from '@/types';\n\ninterface TroopDetailsModalProps {\n  troop: ConfiguracionTropa;\n  user: UserWithProgress;\n  ataqueActual: number;\n  defensaActual: number;\n  capacidadActual: number;\n  velocidadActual: number;\n  salarioActual: number;\n}\n\nfunction formatNumber(num: number): string {\n    if (num === null || num === undefined) return \"0\";\n    return num.toLocaleString('de-DE');\n}\n\nexport function TroopDetailsModal({ troop, user, ataqueActual, defensaActual, capacidadActual, velocidadActual, salarioActual }: TroopDetailsModalProps) {\n    const stats = [\n        { label: 'Ataque', base: troop.ataque, actual: ataqueActual },\n        { label: 'Defensa', base: troop.defensa, actual: defensaActual },\n        { label: 'Capacidad', base: troop.capacidad, actual: capacidadActual },\n        { label: 'Velocidad', base: Number(troop.velocidad), actual: velocidadActual },\n        { label: 'Salario', base: troop.salario, actual: salarioActual },\n        { label: 'Puntos', base: troop.puntos, actual: troop.puntos },\n    ];\n  return (\n    <DialogContent className=\"max-w-3xl w-full p-0 flex flex-col h-full sm:h-auto max-h-screen\">\n        <DialogHeader className=\"p-6 pb-4 shrink-0\">\n            <div className=\"flex flex-col sm:flex-row items-start gap-4\">\n            <div className=\"w-24 h-20 relative rounded-md overflow-hidden border flex-shrink-0\">\n                <Image src={troop.urlImagen} alt={troop.nombre} fill className=\"object-contain\" data-ai-hint=\"mafia character icon\" />\n            </div>\n            <div>\n                <DialogTitle className=\"text-2xl\">{troop.nombre}</DialogTitle>\n                <DialogDescription className=\"text-sm text-muted-foreground mt-2\">{troop.descripcion}</DialogDescription>\n            </div>\n            </div>\n        </DialogHeader>\n\n        <ScrollArea className=\"flex-grow min-h-0 px-6\">\n            <h3 className=\"font-semibold mb-4 text-lg\">Estadísticas de la Tropa</h3>\n            \n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4\">\n                 {stats.map(stat => (\n                     <div key={stat.label} className=\"flex justify-between items-center p-3 rounded-md bg-secondary/10 border border-white/5\">\n                         <span className=\"text-sm text-muted-foreground\">{stat.label}</span>\n                         <div className=\"font-mono text-sm\">\n                             {stat.actual > Number(stat.base) ? (\n                                 <>\n                                     <span className=\"text-muted-foreground\">{formatNumber(Number(stat.base))}</span>\n                                     <span className=\"mx-2 text-muted-foreground\">➝</span>\n                                     <span className=\"font-bold text-primary\">{formatNumber(stat.actual)}</span>\n                                 </>\n                             ) : (\n                                 <span>{formatNumber(Number(stat.base))}</span>\n                             )}\n                         </div>\n                     </div>\n                 ))}\n            </div>\n        </ScrollArea>\n        <DialogFooter className=\"p-6 pt-4 border-t shrink-0\">\n             <DialogClose asChild>\n                <Button type=\"button\" variant=\"secondary\" className=\"w-full\">\n                    Cerrar\n                </Button>\n            </DialogClose>\n        </DialogFooter>\n    </DialogContent>\n  );\n}\n",
    "src/components/dashboard/resource-bar.tsx": "\n'use client'\n\nimport * as React from 'react';\nimport { calculateStorageCapacity, calcularProduccionTotalPorSegundo, ProductionData } from \"@/lib/formulas/room-formulas\";\nimport { cn } from \"@/lib/utils\";\nimport { Dialog, DialogClose, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Button } from \"../ui/button\";\nimport { Separator } from \"../ui/separator\";\nimport { Progress } from \"../ui/progress\";\nimport { LiveClock } from \"./live-clock\";\nimport Image from \"next/image\";\nimport { resourceIcons } from \"@/lib/constants\";\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { motion, useSpring, useTransform } from \"framer-motion\";\nimport { useEffect }from \"react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\n// Jotai Imports\nimport { useAtomValue } from 'jotai';\nimport { userProfileAtom, activePropertyAtom } from '@/store/atoms';\n\n// --- Helpers ---\n\nfunction formatNumber(num: number | bigint | undefined) {\n    if (typeof num === 'undefined') return '0';\n    const numberValue = Number(num);\n    return Math.floor(numberValue).toLocaleString('de-DE');\n}\n\nfunction formatDuration(totalSeconds: number): string {\n    if (!isFinite(totalSeconds) || totalSeconds === Infinity) return \"∞\";\n    if (totalSeconds <= 0) return \"0m\";\n\n    const d = Math.floor(totalSeconds / (3600 * 24));\n    const h = Math.floor(totalSeconds % (3600 * 24) / 3600);\n    const m = Math.floor(totalSeconds % 3600 / 60);\n\n    let result = '';\n    if (d > 0) result += `${d}d `;\n    if (h > 0) result += `${h}h `;\n    if (m > 0 && d === 0) result += `${m}`;\n    \n    return result.trim() || \"< 1m\";\n}\n\nconst resourceAbbreviations: { [key: string]: string } = {\n    armas: \"ARM\",\n    municion: \"MUN\",\n    alcohol: \"ALC\",\n    dolares: \"DOL\",\n};\n\n// --- Sub-components ---\n\nconst LiveResourceCounter = ({ value, isMobile }: { value: number, isMobile: boolean }) => {\n    const spring = useSpring(value, { stiffness: 100, damping: 20 });\n    const displayValue = useTransform(spring, (current) => {\n        const numberValue = Math.floor(current);\n        if (isMobile) {\n            return numberValue.toString();\n        }\n        return numberValue.toLocaleString('de-DE');\n    });\n\n    useEffect(() => {\n        spring.set(value);\n    }, [value, spring]);\n\n    return <motion.span>{displayValue}</motion.span>;\n}\n\nconst ResourceTooltipContent = ({ resource, capacity, production, safeStorage, resourceName }: { resource: any, capacity: number, production: ProductionData, safeStorage: number, resourceName: string }) => {\n    const currentValue = Number(resource.value) || 0;\n    const maxCapacity = Number(capacity) || 0;\n    const netProd = Number(production.produccionNeta) || 0;\n    \n    let timeToFill = Infinity;\n    const isFull = currentValue >= maxCapacity;\n\n    if (!isFull && netProd > 0) {\n        timeToFill = (maxCapacity - currentValue) / (netProd / 3600);\n    } else if (!isFull && netProd <= 0) {\n        timeToFill = Infinity;\n    } else {\n        timeToFill = 0;\n    }\n\n    return (\n        <div className=\"space-y-2 text-sm p-1\">\n             <div className=\"flex justify-between items-center\">\n                <span className=\"text-muted-foreground\">Producción:</span>\n                <span className=\"font-mono text-green-500\">+{formatNumber(production.produccionBruta)}/h</span>\n            </div>\n             {production.consumoTotal > 0 && (\n                <div className=\"flex justify-between items-center\">\n                    <span className=\"text-muted-foreground\">Consumo:</span>\n                    <span className=\"font-mono text-destructive\">-{formatNumber(production.consumoTotal)}/h</span>\n                </div>\n            )}\n             {production.consumoTotal > 0 && (\n                 <>\n                    <Separator className=\"my-1\"/>\n                     <div className=\"flex justify-between items-center font-bold\">\n                        <span>Balance final:</span>\n                        <span className={`font-mono ${netProd >= 0 ? 'text-green-500' : 'text-destructive'}`}>\n                            {netProd >= 0 ? '+' : ''}{formatNumber(netProd)}/h\n                        </span>\n                    </div>\n                 </>\n             )}\n            <Separator className=\"my-2\"/>\n             <div className=\"flex justify-between items-center\">\n                <span className=\"text-muted-foreground\">Almacenamiento:</span>\n                <span className=\"font-mono\">{formatNumber(maxCapacity)}</span>\n            </div>\n             <div className=\"flex justify-between items-center\">\n                <span className=\"text-muted-foreground\">Seguro:</span>\n                <span className=\"font-mono\">{formatNumber(safeStorage)}</span>\n            </div>\n             <div className=\"flex justify-between items-center\">\n                <span className=\"text-muted-foreground\">Tiempo hasta llenar:</span>\n                <span className=\"font-mono\">\n                    {isFull ? \"Lleno\" : formatDuration(timeToFill)}\n                </span>\n            </div>\n        </div>\n    )\n}\n\nconst ResourceItem = ({ res, isMobile, onClick }: { res: any, isMobile: boolean, onClick: () => void }) => {\n    const value = Number(res.value) || 0;\n    const capacity = Number(res.capacity) || 0;\n    const percentage = capacity > 0 ? (value / capacity) * 100 : 0;\n    const isFull = value >= capacity && capacity > 0;\n    const isWarning = percentage > 80;\n\n    let indicatorClassName = \"bg-primary\";\n    if (isFull) indicatorClassName = \"bg-destructive\";\n    else if (isWarning) indicatorClassName = \"bg-yellow-500\";\n    \n    const content = (\n         <div \n            className=\"flex flex-col items-center gap-0.5 w-full p-1 cursor-pointer\"\n            onClick={onClick}\n            onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') onClick(); }}\n            role=\"button\"\n            tabIndex={0}\n        >\n            <div className=\"flex items-center justify-center gap-1 text-xs text-muted-foreground h-5\">\n                <div className=\"relative h-3 w-3 md:h-4 md:w-4\">\n                    <Image src={resourceIcons[res.key]} alt={res.name} fill sizes=\"16px\" className=\"object-contain\" />\n                </div>\n                <span className=\"text-xs font-bold tracking-widest text-muted-foreground md:hidden\">\n                    {resourceAbbreviations[res.key]}\n                </span>\n                <span className=\"hidden md:inline text-xs font-bold tracking-widest text-muted-foreground\">\n                    {res.name.toUpperCase()}\n                </span>\n            </div>\n             <span className={cn(\n                \"font-bold font-mono transition-all duration-300\",\n                isFull ? 'text-destructive' : (isWarning ? 'text-amber-500' : 'text-foreground'),\n                \"text-base md:text-lg lg:text-xl\"\n            )}>\n                <LiveResourceCounter value={value} isMobile={isMobile} />\n            </span>\n             {!isMobile && (\n                <Progress value={percentage} className=\"h-1.5 w-full bg-black/50 mt-1\" indicatorClassName={indicatorClassName} />\n            )}\n        </div>\n    );\n    \n    if (isMobile) return content;\n\n    return (\n        <TooltipProvider delayDuration={0}>\n            <Tooltip>\n                <TooltipTrigger asChild>{content}</TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"w-64 p-3\">\n                     <ResourceTooltipContent resource={res} capacity={res.capacity} production={res.production} safeStorage={res.safe} resourceName={res.name} />\n                </TooltipContent>\n            </Tooltip>\n        </TooltipProvider>\n    );\n};\n\n\n// --- Main Component ---\n\nexport function ResourceBar() {\n    // REFACTORED: Use Jotai Atoms instead of Context\n    const user = useAtomValue(userProfileAtom);\n    const selectedProperty = useAtomValue(activePropertyAtom);\n\n    const isMobile = useIsMobile();\n    const [selectedResourceKey, setSelectedResourceKey] = React.useState<string | null>(null);\n\n    if (!user || !selectedProperty) {\n        return (\n            <nav className=\"w-full bg-background/95 backdrop-blur shadow-md z-20 border-b\">\n                 <div className=\"mx-auto flex h-16 items-center justify-center px-4\">\n                    <p>Selecciona una propiedad para ver tus recursos.</p>\n                </div>\n            </nav>\n        );\n    }\n    \n    const capacity = calculateStorageCapacity(selectedProperty);\n    const production = calcularProduccionTotalPorSegundo(selectedProperty);\n\n    const resources = [\n        { name: 'Armas', key: 'armas', value: selectedProperty.armas, capacity: capacity.armas, production: production.armas, safe: Math.floor(capacity.armas * 0.1) },\n        { name: 'Munición', key: 'municion', value: selectedProperty.municion, capacity: capacity.municion, production: production.municion, safe: Math.floor(capacity.municion * 0.1) },\n        { name: 'Alcohol', key: 'alcohol', value: selectedProperty.alcohol, capacity: capacity.alcohol, production: production.alcohol, safe: Math.floor(capacity.alcohol * 0.1) },\n        { name: 'Dólares', key: 'dolares', value: selectedProperty.dolares, capacity: capacity.dolares, production: production.dolares, safe: Math.floor(capacity.dolares * 0.1) },\n    ];\n    \n    const selectedResourceData = resources.find(r => r.key === selectedResourceKey);\n\n    return (\n        <>\n            <nav className=\"w-full bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 shadow-md z-20 border-b\">\n                <div className=\"mx-auto flex h-16 items-center justify-between px-2 md:px-4 gap-2\">\n                    <div className=\"flex-1 grid grid-cols-4 items-center justify-around gap-1 md:gap-2\">\n                        {resources.map((res) => (\n                            <div key={res.key} className=\"flex items-center justify-center\">\n                                <ResourceItem \n                                    res={res}\n                                    isMobile={isMobile}\n                                    onClick={() => isMobile && setSelectedResourceKey(res.key)}\n                                />\n                                {res.key !== 'dolares' && <Separator orientation=\"vertical\" className=\"h-10 ml-1 md:ml-2\" />}\n                            </div>\n                        ))}\n                    </div>\n\n                    <div className=\"hidden lg:flex shrink-0\">\n                        <LiveClock />\n                    </div>\n                </div>\n            </nav>\n            \n            {isMobile && selectedResourceData && (\n                <Dialog open={!!selectedResourceKey} onOpenChange={(isOpen) => !isOpen && setSelectedResourceKey(null)}>\n                    <DialogContent>\n                        <DialogHeader>\n                            <DialogTitle className=\"flex items-center gap-2 text-primary\">\n                                 <div className=\"relative h-6 w-6\">\n                                     <Image src={resourceIcons[selectedResourceData.key]} alt={selectedResourceData.name} fill sizes=\"24px\" className=\"object-contain\" />\n                                 </div>\n                                {selectedResourceData.name}\n                            </DialogTitle>\n                            <DialogDescription>Detalles de producción y almacenamiento.</DialogDescription>\n                        </DialogHeader>\n                        <ResourceTooltipContent \n                            resource={selectedResourceData} \n                            capacity={selectedResourceData.capacity} \n                            production={selectedResourceData.production} \n                            safeStorage={selectedResourceData.safe}\n                            resourceName={selectedResourceData.name} \n                        />\n                        <DialogFooter>\n                            <DialogClose asChild>\n                                <Button className=\"w-full\">Cerrar</Button>\n                            </DialogClose>\n                        </DialogFooter>\n                    </DialogContent>\n                </Dialog>\n            )}\n        </>\n    );\n}\n",
    "src/components/dashboard/mission-status.tsx": "\n'use client'\n\nimport { useRouter } from \"next/navigation\";\nimport { useEffect, useState, useTransition } from \"react\";\nimport { ArrowLeftRight, Check, Shield, Swords, Undo2, X, Loader2 } from \"lucide-react\";\nimport { cancelarMision } from \"@/lib/actions/cancel-mission.action\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { IncomingAttack, ColaMisiones, FullConfiguracionTropa as ConfiguracionTropa } from \"@/types\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"../ui/alert-dialog\";\nimport { Button } from \"../ui/button\";\n\ntype MissionStatusProps = {\n    missions: ColaMisiones[];\n    incomingAttacks: IncomingAttack[];\n    allTroops: ConfiguracionTropa[];\n};\n\nconst missionIcons: { [key: string]: React.ReactNode } = {\n    ATAQUE: <Swords className=\"h-4 w-4 text-destructive\" />,\n    DEFENDER: <Shield className=\"h-4 w-4 text-blue-500\" />,\n    TRANSPORTE: <ArrowLeftRight className=\"h-4 w-4 text-green-500\" />,\n    ESPIONAJE: <ArrowLeftRight className=\"h-4 w-4 text-yellow-500\" />,\n    OCUPAR: <Check className=\"h-4 w-4 text-primary\" />,\n    REGRESO: <Undo2 className=\"h-4 w-4 text-gray-400\" />,\n};\n\nfunction formatTime(totalSeconds: number): string {\n    if (totalSeconds < 0) totalSeconds = 0;\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = Math.floor(totalSeconds % 60);\n    return [hours, minutes, seconds]\n        .map(v => v.toString().padStart(2, '0'))\n        .join(':');\n}\n\nfunction CountdownTimer({ label, endDate, onFinish, className }: {label: string, endDate: Date | string, onFinish: () => void, className?: string}) {\n    const [timeLeft, setTimeLeft] = useState('');\n\n    useEffect(() => {\n        const end = new Date(endDate).getTime();\n        const intervalId = setInterval(() => {\n            const now = new Date().getTime();\n            const difference = Math.floor((end - now) / 1000);\n\n            if (difference < -1) { \n                setTimeLeft('00:00:00');\n                clearInterval(intervalId);\n                onFinish();\n            } else {\n                setTimeLeft(formatTime(difference));\n            }\n        }, 1000);\n        \n        const now = new Date().getTime();\n        const difference = Math.floor((end - now) / 1000);\n        setTimeLeft(formatTime(difference > 0 ? difference : 0));\n\n        return () => clearInterval(intervalId);\n    }, [endDate, onFinish]);\n\n    return (\n        <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center text-sm\">\n            <span>{label}</span>\n            <span className={`font-mono font-bold ${className}`}>{timeLeft}</span>\n        </div>\n    );\n}\n\nfunction OutgoingMission({ mission, allTroops }: { mission: ColaMisiones, allTroops: ConfiguracionTropa[] }) {\n    const router = useRouter();\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const [status, setStatus] = useState<{label: string, endDate: Date | null}>({\n        label: \"Calculando...\",\n        endDate: null,\n    });\n    \n    useEffect(() => {\n        const updateTimer = () => {\n            const now = new Date().getTime();\n            \n            let currentLabel = \"Llegando\";\n            let currentEndDate: Date | null = mission.fechaLlegada ? new Date(mission.fechaLlegada) : null;\n\n            if (mission.tipoMision === 'REGRESO') {\n                currentLabel = \"Regresando\";\n                currentEndDate = mission.fechaRegreso ? new Date(mission.fechaRegreso) : null;\n            } else if (mission.fechaLlegada && now > new Date(mission.fechaLlegada).getTime()) {\n                if (mission.fechaRegreso) {\n                    currentLabel = \"Regresando\";\n                    currentEndDate = mission.fechaRegreso ? new Date(mission.fechaRegreso) : null;\n                } else {\n                    setStatus({ label: \"Finalizada\", endDate: null });\n                    router.refresh();\n                    return;\n                }\n            }\n            \n            if (!currentEndDate || now > new Date(currentEndDate).getTime()) {\n                setStatus({ label: \"Completada\", endDate: null });\n                router.refresh();\n                return;\n            }\n            setStatus({ label: currentLabel, endDate: currentEndDate });\n        };\n\n        updateTimer();\n        const intervalId = setInterval(updateTimer, 1000);\n        return () => clearInterval(intervalId);\n\n    }, [mission, router]);\n    \n    if (!status.endDate) return null;\n\n    const handleCancel = () => {\n        startTransition(async () => {\n            const result = await cancelarMision(mission.id);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Misión cancelada', description: result.success });\n            }\n        });\n    };\n\n    const canCancel = mission.tipoMision !== 'REGRESO' && new Date() < new Date(mission.fechaLlegada);\n\n    return (\n        <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center text-sm group\">\n            <div className=\"flex items-center gap-2\">\n                {missionIcons[mission.tipoMision]}\n                <span className={mission.tipoMision === 'REGRESO' ? 'text-green-400' : ''}>\n                    {mission.tipoMision} a {mission.destinoCiudad}:{mission.destinoBarrio}:{mission.destinoEdificio}\n                </span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n                {status.endDate && (\n                    <CountdownTimer \n                        label=''\n                        endDate={status.endDate}\n                        onFinish={() => router.refresh()}\n                        className={mission.tipoMision === 'REGRESO' ? 'text-green-400' : 'text-accent'}\n                    />\n                )}\n                {canCancel && (\n                    <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" aria-label=\"Cancelar misión\" className=\"h-6 w-6 rounded-full transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 md:focus:opacity-100 text-muted-foreground hover:bg-destructive hover:text-destructive-foreground\">\n                                <X className=\"h-4 w-4\" />\n                            </Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                            <AlertDialogHeader>\n                                <AlertDialogTitle>¿Cancelar Misión?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                    Tu flota regresará inmediatamente. El tiempo de regreso será igual al tiempo que ha estado en viaje. ¿Estás seguro?\n                                </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                                <AlertDialogCancel>No</AlertDialogCancel>\n                                <AlertDialogAction onClick={handleCancel} disabled={isPending}>\n                                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/>}\n                                    Sí, cancelar misión\n                                </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                    </AlertDialog>\n                )}\n            </div>\n        </div>\n    );\n}\n\n\nexport function MissionStatus({ missions, incomingAttacks, allTroops }: MissionStatusProps) {\n    const router = useRouter();\n\n    // Combine and sort missions and attacks\n    const combinedMovements = [\n        ...missions.map(m => ({ ...m, type: 'mission' as const })),\n        ...incomingAttacks.map(a => ({ ...a, type: 'attack' as const }))\n    ].sort((a, b) => {\n        const timeA = a.type === 'mission' ? a.fechaLlegada : a.arrivalTime;\n        const timeB = b.type === 'mission' ? b.fechaLlegada : b.arrivalTime;\n        return new Date(timeA).getTime() - new Date(timeB).getTime();\n    });\n\n    return (\n        <div className=\"bg-card text-card-foreground px-4 py-3 rounded-b-md space-y-2\">\n            {combinedMovements.length > 0 ? (\n                combinedMovements.map(movement => {\n                    if (movement.type === 'mission') { // Es una ColaMisiones (saliente o de regreso)\n                        return <OutgoingMission key={movement.id} mission={movement} allTroops={allTroops} />\n                    } else { // Es un IncomingAttack\n                        return (\n                             <div key={movement.id} className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center text-sm text-destructive\">\n                                <div className=\"flex items-center gap-2\">\n                                    <Swords className=\"h-4 w-4\"/>\n                                    <span>Ataque de {movement.attackerName}</span>\n                                </div>\n                                <CountdownTimer \n                                    label=''\n                                    endDate={movement.arrivalTime}\n                                    onFinish={() => router.refresh()}\n                                    className='text-destructive'\n                                />\n                            </div>\n                        )\n                    }\n                })\n            ) : (\n                <p className=\"text-muted-foreground text-center text-sm py-2\">Ninguna unidad en movimiento</p>\n            )}\n        </div>\n    )\n}\n",
    "src/components/dashboard/vision/global-view.tsx": "\n'use client';\n\nimport { useMemo } from \"react\";\nimport type { FullPropiedad, FullTropaUsuario, FullTropaSeguridadUsuario, UserWithProgress } from \"@/types\";\nimport { calcularProduccionTotalPorSegundo } from \"@/lib/formulas/room-formulas\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\nimport { Building, Users, Box, Factory, DollarSign, Clock, ArrowRight } from \"lucide-react\";\nimport { resourceIcons } from \"@/lib/constants\";\n\ninterface GlobalVisionViewProps {\n    user: UserWithProgress;\n}\n\nfunction formatNumber(num: number): string {\n    if (num === null || num === undefined) return \"0\";\n    return Math.floor(num).toLocaleString('de-DE');\n}\n\nfunction ResourceDisplay({ icon, label, value, production, small = false }: { icon: string, label: string, value: number, production?: number, small?: boolean }) {\n    return (\n        <div className=\"flex items-center gap-3\">\n            <Image src={icon} alt={label} width={small ? 24 : 32} height={small ? 24 : 32} />\n            <div>\n                <p className={`font-bold ${small ? 'text-lg' : 'text-xl'}`}>{formatNumber(value)}</p>\n                {production !== undefined && <p className=\"text-xs text-green-400 font-mono\">+{formatNumber(production)}/h</p>}\n            </div>\n        </div>\n    )\n}\n\nfunction TroopDisplay({ troops }: { troops: Map<string, number> }) {\n    const sortedTroops = Array.from(troops.entries())\n        .filter(([, count]) => count > 0)\n        .sort((a,b) => b[1] - a[1]);\n\n    if(sortedTroops.length === 0) {\n        return <p className=\"text-sm text-muted-foreground\">Sin tropas en esta propiedad.</p>\n    }\n\n    return (\n        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm\">\n            {sortedTroops.map(([id, count]) => (\n                <div key={id} className=\"flex justify-between items-center\">\n                    <span className=\"text-muted-foreground\">{id}</span>\n                    <span className=\"font-bold\">{formatNumber(count)}</span>\n                </div>\n            ))}\n        </div>\n    )\n}\n\n\nexport function GlobalVisionView({ user }: GlobalVisionViewProps) {\n\n    const empireTotals = useMemo(() => {\n        const totals = {\n            resources: { armas: 0, municion: 0, alcohol: 0, dolares: 0 },\n            production: { armas: 0, municion: 0, alcohol: 0, dolares: 0 },\n            troops: new Map<string, number>(),\n        };\n\n        user.propiedades.forEach(p => {\n            totals.resources.armas += Number(p.armas);\n            totals.resources.municion += Number(p.municion);\n            totals.resources.alcohol += Number(p.alcohol);\n            totals.resources.dolares += Number(p.dolares);\n\n            const productionPerSecond = calcularProduccionTotalPorSegundo(p);\n            totals.production.armas += productionPerSecond.armas.produccionNeta;\n            totals.production.municion += productionPerSecond.municion.produccionNeta;\n            totals.production.alcohol += productionPerSecond.alcohol.produccionNeta;\n            totals.production.dolares += productionPerSecond.dolares.produccionNeta;\n\n            [...p.TropaUsuario, ...p.TropaSeguridadUsuario].forEach(t => {\n                const currentCount = totals.troops.get(t.configuracionTropa.nombre) || 0;\n                totals.troops.set(t.configuracionTropa.nombre, currentCount + t.cantidad);\n            });\n        });\n        return totals;\n    }, [user.propiedades]);\n\n\n    return (\n        <div className=\"space-y-6\">\n            <div>\n                <h2 className=\"text-3xl font-bold tracking-tight\">Visión Global del Imperio</h2>\n                <p className=\"text-muted-foreground\">Resumen de todas tus operaciones y propiedades.</p>\n            </div>\n            \n            <Card className=\"animate-fade-in-up\">\n                <CardHeader>\n                    <CardTitle className=\"text-2xl font-heading tracking-wider text-primary\">Resumen del Imperio</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                     <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                        <div>\n                             <h3 className=\"font-semibold mb-3 flex items-center gap-2\"><Box className=\"h-5 w-5\" /> Recursos Totales</h3>\n                             <div className=\"grid grid-cols-2 gap-4\">\n                                <ResourceDisplay icon={resourceIcons.armas} label=\"Armas\" value={empireTotals.resources.armas} />\n                                <ResourceDisplay icon={resourceIcons.municion} label=\"Munición\" value={empireTotals.resources.municion} />\n                                <ResourceDisplay icon={resourceIcons.alcohol} label=\"Alcohol\" value={empireTotals.resources.alcohol} />\n                                <ResourceDisplay icon={resourceIcons.dolares} label=\"Dólares\" value={empireTotals.resources.dolares} />\n                            </div>\n                        </div>\n                        <div>\n                             <h3 className=\"font-semibold mb-3 flex items-center gap-2\"><Factory className=\"h-5 w-5\" /> Producción Total por Hora</h3>\n                              <div className=\"grid grid-cols-2 gap-4\">\n                                <p className=\"flex items-center gap-2 font-mono text-green-400\">\n                                    <Image src={resourceIcons.armas} alt=\"Armas\" width={20} height={20} /> +{formatNumber(empireTotals.production.armas)}/h\n                                </p>\n                                <p className=\"flex items-center gap-2 font-mono text-green-400\">\n                                    <Image src={resourceIcons.municion} alt=\"Munición\" width={20} height={20} /> +{formatNumber(empireTotals.production.municion)}/h\n                                </p>\n                                 <p className=\"flex items-center gap-2 font-mono text-green-400\">\n                                    <Image src={resourceIcons.alcohol} alt=\"Alcohol\" width={20} height={20} /> +{formatNumber(empireTotals.production.alcohol)}/h\n                                </p>\n                                 <p className=\"flex items-center gap-2 font-mono text-green-400\">\n                                    <Image src={resourceIcons.dolares} alt=\"Dólares\" width={20} height={20} /> +{formatNumber(empireTotals.production.dolares)}/h\n                                </p>\n                            </div>\n                        </div>\n                     </div>\n                      <Separator className=\"my-4\"/>\n                       <div>\n                            <h3 className=\"font-semibold mb-3 flex items-center gap-2\"><Users className=\"h-5 w-5\" /> Ejército Total</h3>\n                            <TroopDisplay troops={empireTotals.troops} />\n                       </div>\n                </CardContent>\n            </Card>\n\n             <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                {user.propiedades.map((prop, index) => {\n                     const production = calcularProduccionTotalPorSegundo(prop);\n                     const troops = new Map<string, number>();\n                     [...prop.TropaUsuario, ...prop.TropaSeguridadUsuario].forEach(t => {\n                        troops.set(t.configuracionTropa.nombre, (troops.get(t.configuracionTropa.nombre) || 0) + t.cantidad);\n                    });\n\n                     return (\n                        <Card key={prop.id} className=\"animate-fade-in-up\" style={{ animationDelay: `${100 + index * 100}ms`}}>\n                             <CardHeader>\n                                <CardTitle className=\"flex items-center gap-2\">\n                                    <Building />\n                                    {prop.nombre}\n                                    <span className=\"text-muted-foreground font-mono text-base ml-auto\">[{prop.ciudad}:{prop.barrio}:{prop.edificio}]</span>\n                                </CardTitle>\n                            </CardHeader>\n                            <CardContent className=\"space-y-4\">\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                    <ResourceDisplay icon={resourceIcons.armas} label=\"Armas\" value={Number(prop.armas)} production={production.armas.produccionNeta} small />\n                                    <ResourceDisplay icon={resourceIcons.municion} label=\"Munición\" value={Number(prop.municion)} production={production.municion.produccionNeta} small />\n                                    <ResourceDisplay icon={resourceIcons.alcohol} label=\"Alcohol\" value={Number(prop.alcohol)} production={production.alcohol.produccionNeta} small />\n                                    <ResourceDisplay icon={resourceIcons.dolares} label=\"Dólares\" value={Number(prop.dolares)} production={production.dolares.produccionNeta} small />\n                                </div>\n                                <Separator />\n                                <TroopDisplay troops={troops} />\n                                <Button asChild variant=\"outline\" className=\"w-full mt-4\">\n                                    <Link href={`/rooms/${prop.ciudad}:${prop.barrio}:${prop.edificio}`}>\n                                        Gestionar Propiedad <ArrowRight className=\"ml-2 h-4 w-4\"/>\n                                    </Link>\n                                </Button>\n                            </CardContent>\n                        </Card>\n                    )\n                })}\n             </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/simulator-view.tsx": "\n'use client';\n\nimport { useState, useTransition } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { Separator } from '@/components/ui/separator';\nimport { runBattleSimulation } from '@/lib/actions/simulation.actions';\nimport type { BattleSimulationResult, SimulationInput } from '@/types/simulation.types';\nimport type { ConfiguracionTropa, ConfiguracionEntrenamiento, ConfiguracionHabitacion } from '@/types';\nimport { Loader2, Trash2, Upload, Swords, CheckCircle, XCircle } from 'lucide-react';\nimport {\n    Dialog,\n    DialogContent,\n    DialogHeader,\n    DialogTitle,\n    DialogFooter,\n    DialogClose,\n} from \"@/components/ui/dialog\"\nimport { ScrollArea } from '../ui/scroll-area';\nimport { UserWithProgress } from '@/types';\nimport { useProperty } from '@/contexts/property-context';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '../ui/table';\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '../ui/accordion';\nimport { cn } from '@/lib/utils';\nimport { BattleReportDisplay } from '../dashboard/brawls/battle-report-display';\n\n\ninterface SimulatorViewProps {\n    user: UserWithProgress;\n    troopConfigs: ConfiguracionTropa[];\n    trainingConfigs: ConfiguracionEntrenamiento[];\n    defenseConfigs: ConfiguracionHabitacion[];\n    onSimulationComplete: (report: BattleSimulationResult | null) => void;\n}\n\ninterface SimulatorColumnState {\n    troops: Record<string, number>;\n    trainings: Record<string, number>;\n    defenses: Record<string, number>;\n    buildingsLevel: number;\n    propertyCount: number;\n}\n\nconst initialColumnState: SimulatorColumnState = {\n    troops: {},\n    trainings: {},\n    defenses: {},\n    buildingsLevel: 1,\n    propertyCount: 1,\n};\n\nconst Section = ({ title, children, value }: { title: string; children: React.ReactNode; value: string }) => (\n    <AccordionItem value={value}>\n        <AccordionTrigger className=\"text-lg font-semibold text-primary\">{title}</AccordionTrigger>\n        <AccordionContent>\n            <div className=\"space-y-2 pt-2\">\n                {children}\n            </div>\n        </AccordionContent>\n    </AccordionItem>\n);\n\nconst InputRow = ({ label, value, onChange }: { label: string; value: number; onChange: (value: number) => void }) => {\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const val = e.target.value;\n        onChange(parseInt(val, 10) || 0);\n    };\n\n    return (\n        <div className=\"flex items-center justify-between\">\n            <Label htmlFor={label} className=\"text-sm truncate pr-2\">{label}</Label>\n            <Input\n                id={label}\n                type=\"number\"\n                min=\"0\"\n                value={value || ''}\n                onChange={handleInputChange}\n                placeholder=\"0\"\n                className=\"w-24 h-8 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none\"\n            />\n        </div>\n    );\n};\n\nfunction SimulatorColumn({\n    title,\n    state,\n    setState,\n    troopConfigs,\n    trainingConfigs,\n    defenseConfigs,\n    onLoadData,\n    isDefender = false,\n}: {\n    title: string;\n    state: SimulatorColumnState;\n    setState: React.Dispatch<React.SetStateAction<SimulatorColumnState>>;\n    troopConfigs: ConfiguracionTropa[];\n    trainingConfigs: ConfiguracionEntrenamiento[];\n    defenseConfigs: ConfiguracionHabitacion[];\n    onLoadData: () => void;\n    isDefender?: boolean;\n}) {\n\n    const handleStateChange = (\n        section: keyof Omit<SimulatorColumnState, 'buildingsLevel' | 'propertyCount'>,\n        id: string,\n        value: number\n    ) => {\n        setState(prev => ({\n            ...prev,\n            [section]: {\n                ...prev[section],\n                [id]: value\n            }\n        }));\n    };\n\n     const handleGeneralValueChange = (field: 'buildingsLevel' | 'propertyCount', value: number) => {\n         setState(prev => ({ ...prev, [field]: value }));\n    }\n\n    const handleClear = () => {\n        setState(initialColumnState);\n    }\n    \n    const troopsToShow = isDefender ? troopConfigs : troopConfigs.filter(t => t.tipo !== 'DEFENSA');\n\n\n    return (\n        <Card>\n            <CardHeader className=\"flex-row items-center justify-between\">\n                <CardTitle>{title}</CardTitle>\n                <div className=\"flex items-center gap-2\">\n                     <Button variant=\"outline\" size=\"sm\" onClick={onLoadData}>\n                        <Upload className=\"mr-2 h-4 w-4\" />\n                        Cargar mis datos\n                    </Button>\n                    <Button variant=\"ghost\" size=\"icon\" onClick={handleClear} className=\"h-8 w-8\">\n                        <Trash2 className=\"h-4 w-4\" />\n                        <span className=\"sr-only\">Limpiar {title}</span>\n                    </Button>\n                </div>\n            </CardHeader>\n            <CardContent>\n                 <ScrollArea className=\"h-96 pr-4\">\n                    <Accordion type=\"multiple\" defaultValue={['troops']} className=\"w-full\">\n                        <Section title=\"Tropas\" value=\"troops\">\n                             {troopsToShow.map(t => (\n                                <InputRow\n                                    key={`${title}-troop-${t.id}`}\n                                    label={t.nombre}\n                                    value={state.troops[t.id] || 0}\n                                    onChange={(val) => handleStateChange('troops', t.id, val)}\n                                />\n                             ))}\n                        </Section>\n                        {isDefender && (\n                            <Section title=\"Defensas Estructurales\" value=\"defenses\">\n                                {defenseConfigs.map(d => (\n                                    <InputRow\n                                        key={`${title}-defense-${d.id}`}\n                                        label={d.nombre}\n                                        value={state.defenses[d.id] || 0}\n                                        onChange={(val) => handleStateChange('defenses', d.id, val)}\n                                    />\n                                ))}\n                            </Section>\n                        )}\n                        <Section title=\"Entrenamientos\" value=\"trainings\">\n                            {trainingConfigs.map(t => (\n                                <InputRow\n                                    key={`${title}-training-${t.id}`}\n                                    label={t.nombre}\n                                    value={state.trainings[t.id] || 0}\n                                    onChange={(val) => handleStateChange('trainings', t.id, val)}\n                                />\n                            ))}\n                        </Section>\n                        <Section title=\"General\" value=\"general\">\n                             <InputRow\n                                label=\"Nº Propiedades\"\n                                value={state.propertyCount}\n                                onChange={(val) => handleGeneralValueChange('propertyCount', val)}\n                            />\n                            {isDefender && (\n                                <InputRow\n                                    label=\"Nivel Edificios (Defensa)\"\n                                    value={state.buildingsLevel}\n                                    onChange={(val) => handleGeneralValueChange('buildingsLevel', val)}\n                                />\n                            )}\n                        </Section>\n                    </Accordion>\n                </ScrollArea>\n            </CardContent>\n        </Card>\n    )\n}\n\nexport function SimulatorView({ user, troopConfigs, trainingConfigs, defenseConfigs, onSimulationComplete }: SimulatorViewProps) {\n    const { selectedProperty } = useProperty();\n    const [isPending, startTransition] = useTransition();\n    const [attackerState, setAttackerState] = useState<SimulatorColumnState>(initialColumnState);\n    const [defenderState, setDefenderState] = useState<SimulatorColumnState>(initialColumnState);\n    const [dialogReport, setDialogReport] = useState<BattleSimulationResult | null>(null);\n\n    const formatSimulationInput = (state: SimulatorColumnState): SimulationInput => {\n        return {\n            troops: Object.entries(state.troops).filter(([,qty]) => qty > 0).map(([id, quantity]) => ({ id, quantity })),\n            trainings: Object.entries(state.trainings).filter(([,lvl]) => lvl > 0).map(([id, level]) => ({ id, level })),\n            defenses: Object.entries(state.defenses).filter(([,lvl]) => lvl > 0).map(([id, level]) => ({ id, level })),\n            buildingsLevel: state.buildingsLevel,\n            propertyCount: state.propertyCount\n        };\n    };\n\n    const handleLoadUserData = (column: 'attacker' | 'defender') => {\n        if (!selectedProperty) return;\n\n        const troops = Object.fromEntries(\n            selectedProperty.TropaUsuario.map(t => [t.configuracionTropaId, t.cantidad])\n        );\n\n        const trainings = Object.fromEntries(\n            user.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel])\n        );\n\n        const defenses = Object.fromEntries(\n            selectedProperty.habitaciones.filter(h => defenseConfigs.some(dc => dc.id === h.configuracionHabitacionId))\n            .map(h => [h.configuracionHabitacionId, h.nivel])\n        );\n\n        const newState: SimulatorColumnState = {\n            troops,\n            trainings,\n            defenses: column === 'defender' ? defenses : {},\n            buildingsLevel: 1, \n            propertyCount: user.propiedades.length || 1,\n        };\n\n        if (column === 'attacker') {\n            setAttackerState(newState);\n        } else {\n            setDefenderState(newState);\n        }\n    }\n\n    const handleSimulate = (detailed: boolean) => {\n        const attackerInput = formatSimulationInput(attackerState);\n        const defenderInput = formatSimulationInput(defenderState);\n        \n        startTransition(async () => {\n            const report = await runBattleSimulation(attackerInput, defenderInput);\n            if (detailed) {\n                onSimulationComplete(report);\n                setDialogReport(null);\n            } else {\n                setDialogReport(report);\n                onSimulationComplete(null);\n            }\n        });\n    };\n    \n    const handleResetAll = () => {\n        setAttackerState(initialColumnState);\n        setDefenderState(initialColumnState);\n        onSimulationComplete(null);\n        setDialogReport(null);\n    }\n\n    return (\n        <div>\n            <div className=\"flex flex-wrap items-center justify-between mb-4 gap-4\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Simulador de Batalla</h2>\n                    <p className=\"text-muted-foreground\">\n                        Calcula los resultados de posibles enfrentamientos.\n                    </p>\n                </div>\n                 <Button onClick={handleResetAll} variant=\"outline\">\n                    <Trash2 className=\"mr-2 h-4 w-4\" />\n                    Reiniciar Simulador\n                </Button>\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <SimulatorColumn \n                    title=\"Atacante\"\n                    state={attackerState}\n                    setState={setAttackerState}\n                    troopConfigs={troopConfigs}\n                    trainingConfigs={trainingConfigs}\n                    defenseConfigs={defenseConfigs}\n                    onLoadData={() => handleLoadUserData('attacker')}\n                />\n                <SimulatorColumn \n                    title=\"Defensor\"\n                    state={defenderState}\n                    setState={setDefenderState}\n                    troopConfigs={troopConfigs}\n                    trainingConfigs={trainingConfigs}\n                    defenseConfigs={defenseConfigs}\n                    isDefender\n                    onLoadData={() => handleLoadUserData('defender')}\n                />\n            </div>\n            <div className=\"mt-6 grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <Button onClick={() => handleSimulate(false)} disabled={isPending} size=\"lg\">\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Simular (Vista Rápida)\n                </Button>\n                 <Button onClick={() => handleSimulate(true)} disabled={isPending} size=\"lg\" variant=\"secondary\">\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Simular (Vista Detallada)\n                </Button>\n            </div>\n\n            {dialogReport && (\n                 <Dialog open={!!dialogReport} onOpenChange={(isOpen) => !isOpen && setDialogReport(null)}>\n                    <DialogContent className=\"max-w-4xl bg-black/80 border-primary text-white\">\n                         <DialogHeader>\n                            <DialogTitle className=\"text-2xl text-center text-primary tracking-widest font-heading\">\n                                INFORME DE BATALLA\n                            </DialogTitle>\n                        </DialogHeader>\n                        <BattleReportDisplay report={dialogReport} />\n                        <DialogFooter>\n                            <DialogClose asChild>\n                                <Button className=\"w-full bg-red-800 hover:bg-red-700 text-white\">Cerrar</Button>\n                            </DialogClose>\n                        </DialogFooter>\n                    </DialogContent>\n                </Dialog>\n            )}\n        </div>\n    );\n}\n",
    "src/components/dashboard/resources-view.tsx": "\n\n'use client'\n\nimport { useState, useMemo } from \"react\";\nimport { calcularProduccionTotalPorSegundo } from \"@/lib/formulas/room-formulas\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport Image from \"next/image\";\nimport { Separator } from \"../ui/separator\";\nimport type { UserWithProgress, FullPropiedad } from \"@/types\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"../ui/select\";\nimport { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from \"recharts\";\nimport { resourceIcons } from \"@/lib/constants\";\nimport { useAtomValue } from 'jotai';\nimport { userProfileAtom } from '@/store/atoms';\n\n\nconst resourceNames: { [key: string]: string } = {\n    armas: \"Armas\",\n    municion: \"Munición\",\n    alcohol: \"Alcohol\",\n    dolares: \"Dólares\",\n};\n\nfunction formatProduction(num: number): string {\n    return `+${Math.floor(num).toLocaleString('de-DE')}/h`;\n}\n\nconst ChartTooltipContent = ({ active, payload, label }: any) => {\n  if (active && payload && payload.length) {\n    return (\n      <div className=\"rounded-lg border bg-background p-2 shadow-sm\">\n        <div className=\"grid grid-cols-2 gap-2\">\n          <div className=\"flex flex-col\">\n            <span className=\"text-[0.70rem] uppercase text-muted-foreground\">\n              Hora\n            </span>\n            <span className=\"font-bold text-muted-foreground\">\n              {label}\n            </span>\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"text-[0.70rem] uppercase text-muted-foreground\">\n              Producido\n            </span>\n            <span className=\"font-bold text-foreground\">\n              {payload[0].value.toLocaleString('de-DE')}\n            </span>\n          </div>\n        </div>\n      </div>\n    )\n  }\n  return null\n}\n\nfunction ResourceCard({ resourceKey, name, icon, productionPerHour }: { resourceKey: string, name: string, icon: string, productionPerHour: number }) {\n    \n    const chartData = useMemo(() => {\n        if (productionPerHour <= 0) return [];\n        return Array.from({ length: 24 }, (_, i) => ({\n            hour: `${i + 1}h`,\n            produccion: Math.floor(productionPerHour * (i + 1)),\n        }));\n    }, [productionPerHour]);\n\n    return (\n        <Card>\n            <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                    <Image src={icon} alt={name} width={24} height={24} />\n                    <CardTitle>{name}</CardTitle>\n                </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n                <p className=\"text-2xl font-bold text-green-400 font-mono\">{formatProduction(productionPerHour)}</p>\n                \n                {chartData.length > 0 && (\n                    <div className=\"h-40\">\n                         <ResponsiveContainer width=\"100%\" height=\"100%\">\n                            <LineChart data={chartData} margin={{ top: 5, right: 10, left: -20, bottom: 0 }}>\n                                <XAxis dataKey=\"hour\" stroke=\"#888888\" fontSize={10} tickLine={false} axisLine={false} />\n                                <YAxis stroke=\"#888888\" fontSize={10} tickLine={false} axisLine={false} tickFormatter={(value) => `${Number(value) / 1000}K`} />\n                                <Tooltip content={<ChartTooltipContent />} />\n                                <Line type=\"monotone\" dataKey=\"produccion\" stroke=\"hsl(var(--primary))\" strokeWidth={2} dot={false} />\n                            </LineChart>\n                        </ResponsiveContainer>\n                    </div>\n                )}\n            </CardContent>\n        </Card>\n    )\n}\n\nexport function ResourcesView() {\n    const user = useAtomValue(userProfileAtom);\n    const [selectedPropertyId, setSelectedPropertyId] = useState('all');\n\n    const productionData = useMemo(() => {\n        if (!user) return [];\n        const propertiesToCalc = selectedPropertyId === 'all' \n            ? user.propiedades\n            : user.propiedades.filter((p: FullPropiedad) => p.id === selectedPropertyId);\n        \n        const produccionPorSegundo = propertiesToCalc.reduce((acc: { armas: number; municion: number; alcohol: number; dolares: number; }, propiedad: FullPropiedad) => {\n            const prod = calcularProduccionTotalPorSegundo(propiedad);\n            acc.armas += prod.armas.produccionNeta;\n            acc.municion += prod.municion.produccionNeta;\n            acc.alcohol += prod.alcohol.produccionNeta;\n            acc.dolares += prod.dolares.produccionNeta;\n            return acc;\n        }, { armas: 0, municion: 0, alcohol: 0, dolares: 0 });\n\n        return Object.keys(produccionPorSegundo).map(key => ({\n            key,\n            name: resourceNames[key],\n            icon: resourceIcons[key],\n            perHour: produccionPorSegundo[key as keyof typeof produccionPorSegundo],\n        }));\n    }, [user, selectedPropertyId]);\n    \n    if (!user) {\n        return null;\n    }\n\n    return (\n        <div className=\"space-y-4 mt-4\">\n            <Select value={selectedPropertyId} onValueChange={setSelectedPropertyId}>\n                <SelectTrigger className=\"w-full md:w-[280px]\">\n                    <SelectValue placeholder=\"Filtrar por propiedad...\" />\n                </SelectTrigger>\n                <SelectContent>\n                    <SelectItem value=\"all\">Todas las propiedades</SelectItem>\n                    {user.propiedades.map((prop: FullPropiedad) => (\n                        <SelectItem key={prop.id} value={prop.id}>{prop.nombre}</SelectItem>\n                    ))}\n                </SelectContent>\n            </Select>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {productionData.map(res => (\n                    <ResourceCard\n                        key={res.key}\n                        resourceKey={res.key}\n                        name={res.name}\n                        icon={res.icon}\n                        productionPerHour={res.perHour}\n                    />\n                ))}\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/overview/player-card.tsx": "\n'use client'\n\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Eye, Swords, Building2, Target, Crown, Trophy, ArrowRight } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { memo } from \"react\";\nimport type { FullTropaUsuario, UserWithProgress } from \"@/types\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Image from \"next/image\";\n\ninterface PlayerCardProps {\n    user: UserWithProgress;\n    lealtad: number;\n    troops: FullTropaUsuario[];\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nfunction StatItem({ label, value, icon, isPercent, href }: { label: string, value: number, icon: React.ReactNode, isPercent?: boolean, href?: string }) {\n    const content = (\n         <div className=\"flex justify-between items-center text-sm py-1.5\">\n            <div className=\"flex items-center gap-2 text-muted-foreground\">\n                {icon}\n                <span>{label}</span>\n            </div>\n            <span className=\"font-bold font-mono\">\n                {formatPoints(value)}\n                {isPercent && '%'}\n            </span>\n         </div>\n    );\n\n    if (href) {\n        return <Link href={href} className=\"hover:bg-muted/50 -mx-2 px-2 rounded-md transition-colors\">{content}</Link>\n    }\n    return content;\n}\n\nfunction formatNumber(num: number): string {\n    if (num === null || num === undefined) return \"0\";\n    return num.toLocaleString('de-DE');\n}\n\n// Optimized with React.memo to prevent unnecessary re-renders\nexport const PlayerCard = memo(function PlayerCard({ user, lealtad, troops }: PlayerCardProps) {\n    const { puntuacion } = user;\n    const allTroops = troops.filter(t => t.cantidad > 0);\n    const displayedTroops = allTroops.slice(0, 8);\n    const hasMoreTroops = allTroops.length > 8;\n\n    return (\n        <Card className=\"lg:col-span-2 flex flex-col h-full\">\n            <CardHeader className=\"flex flex-row items-center gap-4\">\n                 <Avatar className=\"h-16 w-16 border-2 border-primary group-hover:border-accent transition-colors\">\n                    <AvatarImage src={user.avatarUrl || ''} alt={user.name} data-ai-hint=\"mafia boss\" />\n                    <AvatarFallback>{user.name?.charAt(0).toUpperCase()}</AvatarFallback>\n                </Avatar>\n                <div>\n                    <p className=\"text-sm text-muted-foreground\">Jugador</p>\n                    <p className=\"text-2xl font-bold font-heading tracking-wider\">{user.name}</p>\n                </div>\n                 <TooltipProvider>\n                    <Tooltip>\n                        <TooltipTrigger asChild>\n                            <Link href=\"/vision/global\" className=\"ml-auto\">\n                                <Button variant=\"ghost\" size=\"icon\">\n                                    <Eye />\n                                </Button>\n                            </Link>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                            <p>Ver Visión Global</p>\n                        </TooltipContent>\n                    </Tooltip>\n                 </TooltipProvider>\n            </CardHeader>\n            <CardContent className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 flex-grow\">\n                <div className=\"space-y-2\">\n                    <h4 className=\"font-semibold text-primary\">Estadísticas</h4>\n                    <Separator />\n                    <StatItem label=\"Puntos Totales\" value={puntuacion?.puntosTotales || 0} icon={<Trophy className=\"h-4 w-4\" />} />\n                    <StatItem label=\"Puntos Edificios\" value={puntuacion?.puntosHabitaciones || 0} icon={<Building2 className=\"h-4 w-4\" />} />\n                    <StatItem label=\"Puntos Tropas\" value={puntuacion?.puntosTropas || 0} icon={<Swords className=\"h-4 w-4\" />} />\n                    <StatItem label=\"Puntos Entrenamiento\" value={puntuacion?.puntosEntrenamientos || 0} icon={<Target className=\"h-4 w-4\" />} />\n                    <StatItem label=\"Lealtad\" value={lealtad} icon={<Crown className=\"h-4 w-4\" />} isPercent href=\"/powerattack\"/>\n                </div>\n                <div className=\"space-y-2\">\n                     <h4 className=\"font-semibold text-primary\">Tropas en Edificio</h4>\n                     <Separator />\n                      {displayedTroops.length === 0 ? (\n                        <div className=\"text-center text-sm text-muted-foreground py-4\">\n                           <p>No hay tropas en este edificio.</p>\n                        </div>\n                    ) : (\n                        <div className=\"grid grid-cols-4 gap-2\">\n                            {displayedTroops.map(troop => (\n                                <TooltipProvider key={troop.configuracionTropaId}>\n                                    <Tooltip>\n                                        <TooltipTrigger asChild>\n                                             <div className=\"flex flex-col items-center justify-start text-center p-1 rounded-md hover:bg-muted/50\">\n                                                <div className=\"relative h-12 w-12\">\n                                                    <Image\n                                                        src={troop.configuracionTropa.urlImagen || \"https://placehold.co/64x64.png\"}\n                                                        alt={troop.configuracionTropa.nombre}\n                                                        fill\n                                                        sizes=\"48px\"\n                                                        className=\"object-contain\"\n                                                        data-ai-hint=\"mafia unit character\"\n                                                    />\n                                                </div>\n                                                <p className=\"text-xs font-bold text-foreground mt-1\">{formatNumber(troop.cantidad)}</p>\n                                            </div>\n                                        </TooltipTrigger>\n                                        <TooltipContent>\n                                            <p>{troop.configuracionTropa.nombre}</p>\n                                        </TooltipContent>\n                                    </Tooltip>\n                                </TooltipProvider>\n                            ))}\n                        </div>\n                    )}\n                    {hasMoreTroops && (\n                        <Button asChild variant=\"outline\" size=\"sm\" className=\"w-full mt-2\">\n                            <Link href=\"/missions\">\n                                Ver Todas las Tropas\n                                <ArrowRight className=\"ml-2 h-4 w-4\"/>\n                            </Link>\n                        </Button>\n                    )}\n                </div>\n            </CardContent>\n        </Card>\n    )\n})\n",
    "src/components/dashboard/overview/mission-overview.tsx": "\n'use client';\n\nimport { useState, useEffect, useMemo, useTransition } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport type { ColaMisiones, IncomingAttack } from '@/types';\nimport { ArrowLeftRight, Check, Loader2, Shield, Swords, Undo2, Users, X } from 'lucide-react';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from '@/hooks/use-toast';\nimport { cancelarMision } from '@/lib/actions/cancel-mission.action';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { cn } from '@/lib/utils';\nimport { useGameConfig } from '@/contexts/GameConfigContext';\nimport Image from 'next/image';\n\nconst missionIcons: { [key: string]: React.ReactNode } = {\n    ATAQUE: <Swords className=\"h-4 w-4 text-destructive\" />,\n    DEFENDER: <Shield className=\"h-4 w-4 text-blue-500\" />,\n    TRANSPORTE: <ArrowLeftRight className=\"h-4 w-4 text-green-500\" />,\n    ESPIONAJE: <ArrowLeftRight className=\"h-4 w-4 text-yellow-500\" />,\n    OCUPAR: <Check className=\"h-4 w-4 text-primary\" />,\n    REGRESO: <Undo2 className=\"h-4 w-4 text-gray-400\" />,\n};\n\nfunction formatTime(totalSeconds: number): string {\n    if (totalSeconds < 0) totalSeconds = 0;\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = Math.floor(totalSeconds % 60);\n    return [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');\n}\n\nfunction Countdown({ endDate, onFinish }: { endDate: Date | string; onFinish: () => void }) {\n    const [timeLeft, setTimeLeft] = useState<number | null>(null);\n\n    useEffect(() => {\n        const interval = setInterval(() => {\n            const diff = new Date(endDate).getTime() - new Date().getTime();\n            const secondsLeft = Math.max(0, Math.floor(diff / 1000));\n            setTimeLeft(secondsLeft);\n            if (secondsLeft <= 0) {\n                clearInterval(interval);\n                onFinish();\n            }\n        }, 1000);\n\n        const initialDiff = new Date(endDate).getTime() - new Date().getTime();\n        setTimeLeft(Math.max(0, Math.floor(initialDiff / 1000)));\n\n        return () => clearInterval(interval);\n    }, [endDate, onFinish]);\n\n    if (timeLeft === null) {\n        return <span className=\"font-mono\">--:--:--</span>;\n    }\n\n    return <span className=\"font-mono\">{formatTime(timeLeft)}</span>;\n}\n\nfunction ClientSideDate({ date }: { date: Date | string }) {\n    const [formattedDate, setFormattedDate] = useState('');\n\n    useEffect(() => {\n        setFormattedDate(new Date(date).toLocaleString('es-ES'));\n    }, [date]);\n\n    return <>{formattedDate}</>;\n}\n\ninterface MissionOverviewProps {\n    missions: ColaMisiones[];\n    incomingAttacks: IncomingAttack[];\n}\n\nconst MissionRow = ({ mission, type }: { mission: ColaMisiones | IncomingAttack, type: 'outgoing' | 'incoming' | 'returning' }) => {\n    const { toast } = useToast();\n    const router = useRouter();\n    const [isPending, startTransition] = useTransition();\n    const { allTroops } = useGameConfig();\n\n    const handleCancel = (missionId: string) => {\n        startTransition(async () => {\n            const result = await cancelarMision(missionId);\n            if(result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n            else toast({ title: 'Éxito', description: result.success });\n        })\n    }\n\n    const isOutgoing = 'userId' in mission;\n    const from = isOutgoing ? `${mission.origenCiudad}:${mission.origenBarrio}` : mission.attackerName;\n    const to = isOutgoing ? `${mission.destinoCiudad}:${mission.destinoBarrio}` : mission.targetProperty;\n    \n    const troops = isOutgoing \n        ? (Array.isArray(mission.tropas) ? (mission.tropas as ({id: string, cantidad: number} | null)[]).filter(Boolean).reduce((sum, t) => sum + (t!.cantidad || 0), 0) : 0)\n        : mission.totalTroops;\n\n    const missionType = isOutgoing ? mission.tipoMision : 'ATAQUE';\n    const arrivalDate = isOutgoing ? mission.fechaLlegada : mission.arrivalTime;\n    const returnDate = isOutgoing ? mission.fechaRegreso : null;\n\n    const finalDate = type === 'returning' && returnDate ? returnDate : arrivalDate;\n\n    return (\n        <TableRow className=\"animate-fade-in-up\">\n            <TableCell><div className=\"flex items-center gap-2\">{missionIcons[missionType]} <span className=\"hidden sm:inline\">{missionType}</span></div></TableCell>\n            <TableCell>\n                <p className=\"font-semibold\">{isOutgoing ? `a ${to}` : `de ${from}`}</p>\n                <p className=\"text-xs text-muted-foreground\">\n                    <ClientSideDate date={finalDate} />\n                </p>\n            </TableCell>\n            <TableCell className=\"text-center\">\n                 <TooltipProvider>\n                    <Tooltip>\n                        <TooltipTrigger asChild><Button variant=\"ghost\" size=\"sm\" className=\"font-mono\">{troops}</Button></TooltipTrigger>\n                        <TooltipContent>\n                           <div className=\"p-2 space-y-1\">\n                                {isOutgoing && Array.isArray(mission.tropas) && (mission.tropas as {id: string; cantidad: number}[]).filter(Boolean).map(t => (\n                                    <div key={t.id} className=\"flex justify-between gap-4\">\n                                        <span>{allTroops.find(c => c.id === t.id)?.nombre || t.id}</span>\n                                        <span className=\"font-bold\">{(t.cantidad ?? 0).toLocaleString()}</span>\n                                    </div>\n                                ))}\n                           </div>\n                        </TooltipContent>\n                    </Tooltip>\n                </TooltipProvider>\n            </TableCell>\n            <TableCell className=\"text-right font-mono\"><Countdown endDate={finalDate} onFinish={() => router.refresh()} /></TableCell>\n            <TableCell className=\"text-right\">\n                {isOutgoing && missionType !== 'REGRESO' && (\n                    <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-destructive/80 hover:text-destructive\"><X/></Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                            <AlertDialogHeader>\n                                <AlertDialogTitle>¿Cancelar misión?</AlertDialogTitle>\n                                <AlertDialogDescription>La flota regresará inmediatamente. Esta acción no se puede deshacer.</AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                                <AlertDialogCancel>No</AlertDialogCancel>\n                                <AlertDialogAction onClick={() => handleCancel(mission.id)} disabled={isPending}>\n                                    {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/> : <X className=\"mr-2\"/>}\n                                    Confirmar\n                                </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                    </AlertDialog>\n                )}\n            </TableCell>\n        </TableRow>\n    );\n}\n\nexport function MissionOverview({ missions, incomingAttacks }: MissionOverviewProps) {\n    const isMobile = useIsMobile();\n\n    const getFinalTime = (item: ColaMisiones | IncomingAttack): number => {\n        if ('tipoMision' in item) { // ColaMisiones\n            return new Date(item.tipoMision === 'REGRESO' && item.fechaRegreso ? item.fechaRegreso : item.fechaLlegada).getTime();\n        }\n        return new Date(item.arrivalTime).getTime(); // IncomingAttack\n    };\n\n    const allMovements = useMemo(() => {\n        const now = new Date().getTime();\n        return [...missions, ...incomingAttacks]\n            .filter(mov => getFinalTime(mov) > now) // Solo misiones/ataques activos\n            .sort((a, b) => getFinalTime(a) - getFinalTime(b));\n    }, [missions, incomingAttacks]);\n\n\n    if (allMovements.length === 0) return null;\n\n    if (isMobile) {\n        return (\n             <div className=\"space-y-3\">\n                 <h3 className=\"text-lg font-semibold px-4\">Movimiento de Flotas</h3>\n                {allMovements.map((mov) => {\n                    const isOutgoing = 'userId' in mov;\n                    const missionType = isOutgoing ? mov.tipoMision : 'ATAQUE';\n                    const from = isOutgoing ? `${mov.origenCiudad}:${mov.origenBarrio}` : mov.attackerName;\n                    const to = isOutgoing ? `${mov.destinoCiudad}:${mov.destinoBarrio}` : mov.targetProperty;\n                    const finalDate = 'fechaRegreso' in mov && mov.fechaRegreso && mov.tipoMision === 'REGRESO' \n                                        ? mov.fechaRegreso \n                                        : ('fechaLlegada' in mov ? mov.fechaLlegada : mov.arrivalTime);\n\n                    return (\n                        <Card key={mov.id} className={cn(\"p-4\", missionType === 'ATAQUE' && !isOutgoing && 'border-destructive/50')}>\n                           <div className=\"flex items-start justify-between\">\n                                <div className=\"flex items-center gap-3\">\n                                    {missionIcons[missionType]}\n                                    <div>\n                                        <p className=\"font-bold\">{missionType}</p>\n                                        <p className=\"text-xs text-muted-foreground\">{isOutgoing ? `Hacia ${to}` : `Desde ${from}`}</p>\n                                    </div>\n                                </div>\n                                 <div className=\"text-right\">\n                                    <p className=\"font-mono text-lg\"><Countdown endDate={finalDate} onFinish={() => {}} /></p>\n                                    <p className=\"text-xs text-muted-foreground\">Tiempo Restante</p>\n                                </div>\n                           </div>\n                        </Card>\n                    )\n                })}\n            </div>\n        )\n    }\n\n    return (\n        <Card className=\"animate-fade-in-up\" style={{ animationDelay: '500ms'}}>\n            <CardHeader>\n                <CardTitle>Movimiento de Flotas</CardTitle>\n            </CardHeader>\n            <CardContent>\n                <ScrollArea className=\"h-64\">\n                    <Table>\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead>Tipo</TableHead>\n                                <TableHead>Origen/Destino</TableHead>\n                                <TableHead className=\"text-center\">Tropas</TableHead>\n                                <TableHead className=\"text-right\">Tiempo Restante</TableHead>\n                                <TableHead className=\"w-[50px]\"></TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {allMovements.map(mov => <MissionRow key={mov.id} mission={mov} type={('userId' in mov) ? (mov.tipoMision === 'REGRESO' ? 'returning' : 'outgoing') : 'incoming'} />)}\n                        </TableBody>\n                    </Table>\n                </ScrollArea>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/queue-item.tsx": "'use client';\n\nimport { useEffect, useState, useTransition } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport Image from \"next/image\";\nimport { Button } from \"../ui/button\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '../ui/alert-dialog';\nimport { Clock, Loader2, X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nfunction formatTime(totalSeconds: number): string {\n    if (totalSeconds < 0) totalSeconds = 0;\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = Math.floor(totalSeconds % 60);\n    return [hours, minutes, seconds]\n        .map(v => v.toString().padStart(2, '0'))\n        .join(':');\n}\n\nfunction CountdownTimer({ endDate, onFinish }: { endDate: string, onFinish: () => void }) {\n    const [timeLeft, setTimeLeft] = useState<number | null>(null);\n\n    useEffect(() => {\n        const calculateTimeLeft = () => {\n            const endTime = new Date(endDate).getTime();\n            const now = new Date().getTime();\n            return Math.max(0, Math.floor((endTime - now) / 1000));\n        }\n\n        setTimeLeft(calculateTimeLeft());\n\n        const intervalId = setInterval(() => {\n            const newTimeLeft = calculateTimeLeft();\n            setTimeLeft(newTimeLeft);\n\n            if (newTimeLeft === 0) {\n                clearInterval(intervalId);\n                onFinish();\n            }\n        }, 1000);\n\n        return () => clearInterval(intervalId);\n    }, [endDate, onFinish]);\n    \n    if (timeLeft === null) {\n        return <span>--:--:--</span>;\n    }\n\n    return <span>{formatTime(timeLeft)}</span>;\n}\n\n\ninterface QueueItemProps {\n    label: string;\n    info: string;\n    coords: string;\n    endDate: string;\n    image: string | null;\n    onCancel?: () => void;\n    onFinish: () => void;\n}\n\nexport function QueueItem({ label, info, coords, endDate, image, onCancel, onFinish }: QueueItemProps) {\n    const [isPending, startTransition] = useTransition();\n\n    const handleCancel = () => {\n        if (onCancel) {\n            startTransition(async () => {\n                await onCancel();\n            });\n        }\n    };\n    \n    return (\n        <div className=\"group flex justify-between items-center text-sm w-full gap-2 p-1 border-b border-border/40 last:border-0 hover:bg-muted/50 transition-colors\">\n            <div className=\"flex items-center gap-2 overflow-hidden flex-1\">\n                <div className=\"relative w-8 h-8 rounded border border-white/10 overflow-hidden shrink-0\">\n                    <Image src={image || \"https://placehold.co/80x56.png\"} alt={label} fill className=\"object-cover\" />\n                </div>\n                <div className=\"flex flex-col min-w-0\">\n                     <span className=\"font-semibold truncate text-xs\">{label} <span className=\"text-primary font-bold\">{info}</span></span>\n                     <span className=\"text-[10px] text-muted-foreground font-mono\">[{coords}]</span>\n                </div>\n            </div>\n            <div className=\"flex items-center gap-1 sm:gap-2\">\n                <div className=\"font-mono text-foreground font-bold text-xs bg-accent/10 px-1.5 py-0.5 rounded flex items-center gap-1\">\n                    <Clock className=\"h-3 w-3 text-amber-500\" />\n                    <CountdownTimer endDate={endDate} onFinish={onFinish} />\n                </div>\n                 {onCancel && (\n                    <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" className={cn(\"h-6 w-6 rounded-full opacity-50 group-hover:opacity-100 hover:bg-destructive/20 hover:text-destructive\", isPending && \"opacity-100\")}>\n                                {isPending ? <Loader2 className=\"h-4 w-4 animate-spin\"/> : <X className=\"h-4 w-4\"/>}\n                            </Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                            <AlertDialogHeader>\n                                <AlertDialogTitle>¿Cancelar Acción?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                    Esta acción cancelará el proceso en curso y devolverá los recursos invertidos. ¿Estás seguro?\n                                </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                                <AlertDialogCancel>No</AlertDialogCancel>\n                                <AlertDialogAction onClick={handleCancel} disabled={isPending}>\n                                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/>}\n                                    Sí, cancelar\n                                </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                    </AlertDialog>\n                )}\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/powerattack-view.tsx": "\n'use client';\n\nimport { useMemo } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport type { UserWithProgress } from '@/types';\nimport { cn } from '@/lib/utils';\nimport { Target } from 'lucide-react';\n\ninterface PowerAttackViewProps {\n    user: UserWithProgress;\n}\n\n// Function to calculate power based on the provided formula\nconst calculatePower = (propertyCount: number, honorLevel: number): number => {\n    if (propertyCount < 1) propertyCount = 1;\n    if (honorLevel < 0) honorLevel = 0;\n    const power = 1 / (1 + (Math.pow((propertyCount - 1), (4.5 - (honorLevel / 10)))) / 10000000);\n    return power * 100;\n};\n\nexport function PowerAttackView({ user }: PowerAttackViewProps) {\n    const userHonorLevel = user.entrenamientos.find(t => t.configuracionEntrenamientoId === 'honor')?.nivel || 0;\n    const userPropertyCount = user.propiedades.length;\n    const currentUserPower = calculatePower(userPropertyCount, userHonorLevel);\n\n    const tableData = useMemo(() => {\n        const data = [];\n        for (let i = 1; i <= 100; i++) {\n            const row: (string | number)[] = [i];\n            for (let j = 0; j <= 10; j++) {\n                const power = calculatePower(i, j);\n                row.push(Math.round(power) + '%');\n            }\n            data.push(row);\n        }\n        return data;\n    }, []);\n\n    const headers = [\"C.Edis\", ...Array.from({ length: 11 }, (_, i) => `H ${i}`)];\n\n    return (\n        <div className=\"space-y-6\">\n            <div>\n                <h2 className=\"text-3xl font-bold tracking-tight\">Tabla de Poder de Ataque</h2>\n                <p className=\"text-muted-foreground\">\n                    Tu poder de ataque aumenta con el honor y disminuye con el número de propiedades.\n                </p>\n            </div>\n\n            <Card className=\"border-primary/50 animate-fade-in-up\">\n                <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                        <Target className=\"h-6 w-6 text-primary\" />\n                        Tu Poder de Ataque Actual\n                    </CardTitle>\n                </CardHeader>\n                <CardContent>\n                    <p className=\"text-3xl sm:text-4xl font-bold font-mono text-primary\">{currentUserPower.toFixed(2)}%</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                        Calculado con {userPropertyCount} propiedades y Honor nivel {userHonorLevel}.\n                    </p>\n                </CardContent>\n            </Card>\n\n            <Card className=\"animate-fade-in-up\" style={{ animationDelay: '100ms' }}>\n                <CardContent className=\"p-0\">\n                    <ScrollArea className=\"h-[70vh] w-full whitespace-nowrap rounded-md border\">\n                        <Table className=\"min-w-full\">\n                            <TableHeader>\n                                <TableRow>\n                                    {headers.map((header, index) => (\n                                        <TableHead \n                                            key={header} \n                                            className={cn(\n                                                \"sticky top-0 z-20 bg-muted/95 backdrop-blur-sm\", \n                                                index === 0 && \"sticky left-0 z-30\",\n                                                (index - 1) === userHonorLevel && \"bg-primary/30 text-primary-foreground\"\n                                            )}\n                                        >\n                                            {header}\n                                        </TableHead>\n                                    ))}\n                                </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                                {tableData.map((row, rowIndex) => (\n                                    <TableRow key={rowIndex} className={cn(\"hover:bg-muted/40\", (rowIndex + 1) === userPropertyCount && \"bg-primary/20 hover:bg-primary/30\")}>\n                                        {row.map((cell, cellIndex) => (\n                                            <TableCell \n                                                key={cellIndex} \n                                                className={cn(\n                                                    \"font-mono text-xs sm:text-sm p-1 sm:p-2 text-center\",\n                                                    cellIndex === 0 && \"sticky left-0 bg-muted/95 backdrop-blur-sm font-semibold\",\n                                                    cellIndex === userHonorLevel + 1 && \"bg-primary/20\"\n                                                )}\n                                            >\n                                                {cell}\n                                            </TableCell>\n                                        ))}\n                                    </TableRow>\n                                ))}\n                            </TableBody>\n                        </Table>\n                    </ScrollArea>\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n",
    "src/components/dashboard/family/create-or-join-family-view.tsx": "'use client'\n\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { createFamily } from \"@/lib/actions/family.actions\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useRef, useState, useTransition } from \"react\";\nimport { Loader2, Search, UploadCloud, Users } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\nexport function CreateOrJoinFamilyView() {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const fileInputRef = useRef<HTMLInputElement>(null);\n    const [previewUrl, setPreviewUrl] = useState<string | null>(null);\n\n    const handleCreateFamily = async (formData: FormData) => {\n        startTransition(async () => {\n            const result = await createFamily(formData);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: '¡Éxito!', description: result.success });\n            }\n        });\n    };\n    \n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (file) {\n            setPreviewUrl(URL.createObjectURL(file));\n        }\n    };\n\n\n    return (\n        <div className=\"main-view\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Únete a la Familia</h2>\n                    <p className=\"text-muted-foreground\">\n                        Crea tu propio clan o únete a uno existente para dominar la ciudad.\n                    </p>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 items-start\">\n                 <Card>\n                    <form action={handleCreateFamily}>\n                        <CardHeader>\n                            <CardTitle>Funda tu Propia Familia</CardTitle>\n                            <CardDescription>Define el nombre, el tag y los símbolos de tu nuevo imperio.</CardDescription>\n                        </CardHeader>\n                        <CardContent className=\"space-y-4\">\n                            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                                <div className=\"space-y-2 sm:col-span-2\">\n                                    <Label htmlFor=\"name\">Nombre de la Familia</Label>\n                                    <Input id=\"name\" name=\"name\" placeholder=\"Los Corleone\" required disabled={isPending} />\n                                </div>\n                                <div className=\"space-y-2\">\n                                    <Label htmlFor=\"tag\">Tag (3-4 letras)</Label>\n                                    <Input id=\"tag\" name=\"tag\" placeholder=\"CRL\" required minLength={3} maxLength={4} disabled={isPending} />\n                                </div>\n                            </div>\n                            <div className=\"space-y-2\">\n                                <Label htmlFor=\"description\">Descripción Pública</Label>\n                                <Textarea id=\"description\" name=\"description\" placeholder=\"Una oferta que no podrán rechazar...\" disabled={isPending} />\n                            </div>\n                            <div className=\"space-y-2\">\n                                <Label htmlFor=\"avatarUrl\">Emblema de la Familia</Label>\n                                 <div className=\"flex items-start gap-4\">\n                                    <div className=\"flex-grow space-y-2\">\n                                        <Input id=\"avatarUrl\" name=\"avatarUrl\" placeholder=\"https://... o sube una imagen\" disabled={isPending} />\n                                        <input \n                                            type=\"file\" \n                                            name=\"avatarFile\"\n                                            ref={fileInputRef} \n                                            className=\"hidden\" \n                                            onChange={handleFileChange}\n                                            accept=\"image/png, image/jpeg, image/gif\"\n                                        />\n                                        <Button type=\"button\" variant=\"outline\" onClick={() => fileInputRef.current?.click()} disabled={isPending}>\n                                            <UploadCloud className=\"mr-2 h-4 w-4\" />\n                                            Subir Imagen\n                                        </Button>\n                                    </div>\n                                     <Avatar className=\"h-24 w-24 flex-shrink-0 rounded-md\">\n                                        <AvatarImage src={previewUrl || ''} alt=\"Previsualización del emblema\" />\n                                        <AvatarFallback className=\"rounded-md\">Emblema</AvatarFallback>\n                                    </Avatar>\n                                </div>\n                            </div>\n                        </CardContent>\n                        <CardFooter>\n                            <Button type=\"submit\" disabled={isPending}>\n                                {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                                Fundar Familia\n                            </Button>\n                        </CardFooter>\n                    </form>\n                </Card>\n\n                 <div className=\"flex flex-col items-center justify-center gap-4 text-center p-8 border rounded-lg h-full\">\n                    <Users className=\"h-16 w-16 text-muted-foreground\" />\n                    <h3 className=\"text-xl font-bold\">¿Prefieres Unirte a un Clan?</h3>\n                    <p className=\"text-muted-foreground\">\n                        Busca entre las familias existentes, conoce a sus miembros y envía una solicitud para unirte a la que más te guste.\n                    </p>\n                    <Button size=\"lg\" asChild>\n                        <Link href=\"/family/find\">\n                            <Search className=\"mr-2 h-5 w-5\" />\n                            Buscar Familias Existentes\n                        </Link>\n                    </Button>\n                 </div>\n            </div>\n        </div>\n    )\n}\n",
    "src/components/dashboard/family/invite-member-dialog.tsx": "\n'use client';\n\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { MailPlus, Loader2 } from \"lucide-react\";\nimport { useState, useTransition } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { inviteUserToFamily } from \"@/lib/actions/family.actions\";\n\ninterface InviteMemberDialogProps {\n    familyId: string;\n    allUsers: { id: string; name: string }[];\n}\n\nexport function InviteMemberDialog({ familyId, allUsers }: InviteMemberDialogProps) {\n    const [isOpen, setIsOpen] = useState(false);\n    const [selectedUser, setSelectedUser] = useState<string | null>(null);\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n\n    const handleInvite = async () => {\n        if (!selectedUser) {\n            toast({ variant: 'destructive', title: 'Error', description: 'Debes seleccionar a un jugador.' });\n            return;\n        }\n\n        startTransition(async () => {\n            const result = await inviteUserToFamily(selectedUser, familyId);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Invitación enviada correctamente.' });\n                setIsOpen(false);\n                setSelectedUser(null);\n            }\n        });\n    }\n\n    return (\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\n            <DialogTrigger asChild>\n                <Button size=\"sm\">\n                    <MailPlus className=\"mr-2 h-4 w-4\" />\n                    Invitar Miembro\n                </Button>\n            </DialogTrigger>\n            <DialogContent>\n                <DialogHeader>\n                    <DialogTitle>Invitar a un Jugador</DialogTitle>\n                    <DialogDescription>\n                        Selecciona a un jugador sin familia para enviarle una invitación.\n                    </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-2 py-4\">\n                    <Label htmlFor=\"user-select\">Jugador</Label>\n                    <Select onValueChange={setSelectedUser}>\n                        <SelectTrigger id=\"user-select\">\n                            <SelectValue placeholder=\"Selecciona un jugador...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                            {allUsers.length > 0 ? (\n                                allUsers.map(user => (\n                                    <SelectItem key={user.id} value={user.id}>{user.name}</SelectItem>\n                                ))\n                            ) : (\n                                <SelectItem value=\"none\" disabled>No hay jugadores para invitar.</SelectItem>\n                            )}\n                        </SelectContent>\n                    </Select>\n                </div>\n                <DialogFooter>\n                    <Button variant=\"ghost\" onClick={() => setIsOpen(false)}>Cancelar</Button>\n                    <Button onClick={handleInvite} disabled={isPending || !selectedUser}>\n                         {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                         Enviar Invitación\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    );\n}\n",
    "src/components/dashboard/family/family-announcement-card.tsx": "\n'use client';\nimport {\n    Card,\n    CardContent,\n    CardDescription,\n    CardHeader,\n    CardTitle,\n  } from '@/components/ui/card'\nimport {\n    Avatar,\n    AvatarFallback,\n    AvatarImage,\n  } from \"@/components/ui/avatar\"\nimport type { FullFamilyAnnouncement } from '@/types';\n  \ninterface FamilyAnnouncementCardProps {\n    announcements: FullFamilyAnnouncement[]\n}\nexport const FamilyAnnouncementCard = ({announcements}: FamilyAnnouncementCardProps) => {\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle>Tablón de Anuncios</CardTitle>\n                <CardDescription>\n                    Últimas noticias y directivas de la familia.\n                </CardDescription>\n            </CardHeader>\n            <CardContent>\n                {announcements.length === 0 ? (\n                <p className=\"text-sm text-center text-muted-foreground py-8\">\n                    El tablón de anuncios está vacío.\n                </p>\n                ) : (\n                    <div className=\"space-y-4\">\n                        {announcements.map((announcement) => (\n                            <div key={announcement.id} className=\"p-4 border rounded-md\">\n                                <div className=\"flex items-center gap-3 mb-2\">\n                                    <Avatar className=\"h-8 w-8\">\n                                        <AvatarImage src={announcement.author.avatarUrl || ''} />\n                                        <AvatarFallback>{announcement.author.name.charAt(0)}</AvatarFallback>\n                                    </Avatar>\n                                    <div>\n                                        <p className=\"font-semibold text-sm\">{announcement.author.name}</p>\n                                        <p className=\"text-xs text-muted-foreground\">{new Date(announcement.created_at).toLocaleString()}</p>\n                                    </div>\n                                </div>\n                                <p className=\"text-sm whitespace-pre-wrap\">{announcement.content}</p>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </CardContent>\n        </Card>\n    )\n}\n",
    "src/components/dashboard/family/family-members-view.tsx": "\n'use client'\n\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport type { FullFamily, FullFamilyMember } from \"@/types\";\nimport { FamilyRole } from \"@/types\";\nimport { useEffect, useState } from \"react\";\nimport { cn, getLastSeenStatus } from \"@/lib/utils\";\nimport Link from \"next/link\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowLeft, ArrowUpDown, Crown, Shield, User as UserIcon } from \"lucide-react\";\nimport { Separator } from \"@/components/ui/separator\";\n\ninterface FamilyMembersViewProps {\n    family: FullFamily;\n}\n\ntype SortKey = 'name' | 'points' | 'status';\ntype SortDirection = 'asc' | 'desc';\n\nconst roleTranslations: Record<FamilyRole, string> = {\n    [FamilyRole.LEADER]: \"Líder\",\n    [FamilyRole.CO_LEADER]: \"Co-Líder\",\n    [FamilyRole.MEMBER]: \"Miembro\",\n};\n\nconst roleIcons: Record<FamilyRole, React.ReactNode> = {\n    [FamilyRole.LEADER]: <Crown className=\"h-4 w-4 text-amber-400\" />,\n    [FamilyRole.CO_LEADER]: <Shield className=\"h-4 w-4 text-blue-400\" />,\n    [FamilyRole.MEMBER]: <UserIcon className=\"h-4 w-4 text-muted-foreground\" />,\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nexport function FamilyMembersView({ family }: FamilyMembersViewProps) {\n    const [, setTick] = useState(0);\n    const [sortKey, setSortKey] = useState<SortKey>('points');\n    const [sortDirection, setSortDirection] = useState<SortDirection>('desc');\n\n    useEffect(() => {\n        const timer = setInterval(() => setTick(t => t + 1), 60000); \n        return () => clearInterval(timer);\n    }, []);\n\n    const handleSort = (key: SortKey) => {\n        if (sortKey === key) {\n            setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');\n        } else {\n            setSortKey(key);\n            setSortDirection('asc');\n        }\n    }\n    \n    const sortedMembers = [...family.members].sort((a, b) => {\n        const statusA = getLastSeenStatus(a.user.lastSeen);\n        const statusB = getLastSeenStatus(b.user.lastSeen);\n\n        let compareA: string | number;\n        let compareB: string | number;\n\n        switch (sortKey) {\n            case 'name':\n                compareA = a.user.name.toLowerCase();\n                compareB = b.user.name.toLowerCase();\n                break;\n            case 'points':\n                compareA = b.user.puntuacion?.puntosTotales ?? 0; // Default desc\n                compareB = a.user.puntuacion?.puntosTotales ?? 0;\n                break;\n            case 'status':\n                compareA = statusA.minutesAgo; // Online first\n                compareB = statusB.minutesAgo;\n                break;\n            default:\n                return 0;\n        }\n\n        if (compareA > compareB) return sortDirection === 'asc' ? 1 : -1;\n        if (compareA < compareB) return sortDirection === 'asc' ? -1 : 1;\n        return 0;\n    });\n\n    return (\n        <div className=\"space-y-4\">\n             <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Miembros de {family.name}</h2>\n                    <p className=\"text-muted-foreground\">\n                        Lista de todos los jugadores de tu familia.\n                    </p>\n                </div>\n                <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/family\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver a la Familia\n                    </Link>\n                </Button>\n            </div>\n            <Card>\n                <CardContent className=\"p-0\">\n                     {/* Desktop Table */}\n                    <Table className=\"hidden md:table\">\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead className=\"w-[80px]\">#</TableHead>\n                                <TableHead>\n                                     <Button variant=\"ghost\" onClick={() => handleSort('name')}>Jugador <ArrowUpDown className=\"ml-2 h-4 w-4 inline\" /></Button>\n                                </TableHead>\n                                <TableHead>Posición</TableHead>\n                                <TableHead className=\"text-right\">\n                                     <Button variant=\"ghost\" onClick={() => handleSort('points')}>Puntos <ArrowUpDown className=\"ml-2 h-4 w-4 inline\" /></Button>\n                                </TableHead>\n                                <TableHead className=\"text-right\">\n                                    <Button variant=\"ghost\" onClick={() => handleSort('status')}>Estado <ArrowUpDown className=\"ml-2 h-4 w-4 inline\" /></Button>\n                                </TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {sortedMembers.map((member, index) => {\n                                const status = getLastSeenStatus(member.user.lastSeen);\n                                return (\n                                    <TableRow key={member.user.id}>\n                                        <TableCell className=\"font-medium text-muted-foreground\">{index + 1}</TableCell>\n                                        <TableCell>\n                                            <Link href={`/profile/${member.user.id}`} className=\"font-semibold hover:underline\">{member.user.name}</Link>\n                                        </TableCell>\n                                        <TableCell>\n                                            <div className=\"flex items-center gap-2\">\n                                                {roleIcons[member.role]}\n                                                <span>{roleTranslations[member.role]}</span>\n                                            </div>\n                                        </TableCell>\n                                        <TableCell className=\"text-right font-mono\">{formatPoints(member.user.puntuacion?.puntosTotales)}</TableCell>\n                                        <TableCell className=\"text-right\">\n                                            <div className=\"flex items-center justify-end gap-2\">\n                                                <div className={cn(\"h-2.5 w-2.5 rounded-full\", status.isOnline ? \"bg-green-500\" : \"bg-muted\")} />\n                                                <span className={cn(\"font-mono text-sm\", status.isOnline ? \"text-green-400\" : \"text-muted-foreground\")}>\n                                                    {status.text}\n                                                </span>\n                                            </div>\n                                        </TableCell>\n                                    </TableRow>\n                                )\n                            })}\n                        </TableBody>\n                    </Table>\n                     {/* Mobile Cards */}\n                    <div className=\"md:hidden p-2 space-y-2\">\n                        {sortedMembers.map((member, index) => {\n                             const status = getLastSeenStatus(member.user.lastSeen);\n                             return (\n                                <Card key={member.user.id} className=\"p-4\">\n                                    <div className=\"flex items-start justify-between\">\n                                        <div className=\"flex items-center gap-3\">\n                                            <span className=\"text-lg font-bold text-muted-foreground\">#{index + 1}</span>\n                                            <div>\n                                                 <Link href={`/profile/${member.user.id}`} className=\"font-semibold hover:underline\">{member.user.name}</Link>\n                                                 <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n                                                    {roleIcons[member.role]}\n                                                    <span>{roleTranslations[member.role]}</span>\n                                                </div>\n                                            </div>\n                                        </div>\n                                         <div className={cn(\"text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1.5\", status.isOnline ? \"bg-green-500/20 text-green-400\" : \"bg-muted\")}>\n                                             <div className={cn(\"h-2 w-2 rounded-full\", status.isOnline ? \"bg-green-500\" : \"bg-muted-foreground\")} />\n                                            {status.text}\n                                        </div>\n                                    </div>\n                                    <Separator className=\"my-3\"/>\n                                    <div className=\"text-center\">\n                                        <p className=\"text-xl font-bold font-mono text-primary\">{formatPoints(member.user.puntuacion?.puntosTotales)}</p>\n                                        <p className=\"text-xs text-muted-foreground\">Puntos</p>\n                                    </div>\n                                </Card>\n                             )\n                        })}\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n",
    "src/components/dashboard/family/find-family-view.tsx": "'use client'\n\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FullFamily, FullFamilyInvitation } from \"@/types\";\nimport { Button } from \"@/components/ui/button\";\nimport { applyToFamily, cancelInvitation, rejectInvitation } from \"@/lib/actions/family.actions\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useState, useTransition } from \"react\";\nimport { Check, Hourglass, Loader2, Send, X } from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { InvitationStatus, InvitationType } from \"@/types\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { acceptFamilyInvitation } from \"@/lib/actions/family.actions\";\n\ninterface FindFamilyViewProps {\n    families: FullFamily[];\n    userInvitations: FullFamilyInvitation[];\n    currentUserId: string;\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nfunction ActionButton({ familyId, userInvitations }: { familyId: string, userInvitations: FullFamilyInvitation[] }) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const existingRequest = userInvitations.find(inv => inv.familyId === familyId && inv.type === InvitationType.REQUEST);\n\n    const handleApply = () => {\n        startTransition(async () => {\n            const result = await applyToFamily(familyId);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Solicitud enviada correctamente.' });\n            }\n        });\n    }\n\n    if (existingRequest) {\n        return (\n            <Button size=\"sm\" variant=\"secondary\" disabled>\n                <Hourglass className=\"mr-2 h-4 w-4\" />\n                Pendiente\n            </Button>\n        )\n    }\n\n    return (\n        <Button size=\"sm\" onClick={handleApply} disabled={isPending}>\n            {isPending ? <Loader2 className=\"animate-spin mr-2 h-4 w-4\" /> : <Send className=\"mr-2 h-4 w-4\" />}\n            Enviar Solicitud\n        </Button>\n    )\n}\n\nexport function FindFamilyView({ families, userInvitations, currentUserId }: FindFamilyViewProps) {\n    const [searchTerm, setSearchTerm] = useState(\"\");\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const filteredFamilies = families.filter(family =>\n        family.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        family.tag.toLowerCase().includes(searchTerm.toLowerCase())\n    );\n\n    const handleInvitationAction = (action: 'accept' | 'reject', invitationId: string) => {\n        startTransition(async () => {\n            const result = action === 'accept'\n                ? await acceptFamilyInvitation(invitationId)\n                : await rejectInvitation(invitationId);\n\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: result.success });\n            }\n        })\n    }\n\n    const familyInvitations = userInvitations.filter(inv => inv.type === 'INVITATION');\n\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <Button asChild variant=\"outline\" size=\"sm\">\n                        <Link href=\"/family\">\n                            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                            Volver\n                        </Link>\n                    </Button>\n                </div>\n            </div>\n            <Tabs defaultValue=\"search\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-2\">\n                    <TabsTrigger value=\"search\">Buscar Familia</TabsTrigger>\n                    <TabsTrigger value=\"invitations\">\n                        Invitaciones\n                        {familyInvitations.length > 0 && <Badge variant=\"destructive\" className=\"ml-2\">{familyInvitations.length}</Badge>}\n                    </TabsTrigger>\n                </TabsList>\n                <TabsContent value=\"search\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Buscar Familias</CardTitle>\n                            <CardDescription>Encuentra y solicita unirte a una familia existente.</CardDescription>\n                            <Input\n                                placeholder=\"Buscar por nombre o tag...\"\n                                value={searchTerm}\n                                onChange={(e) => setSearchTerm(e.target.value)}\n                                className=\"mt-2\"\n                            />\n                        </CardHeader>\n                        <CardContent className=\"p-0\">\n                            <div className=\"md:grid md:grid-cols-2 lg:grid-cols-3 gap-4 p-4\">\n                                {filteredFamilies.map(family => (\n                                    <Card key={family.id} className=\"flex flex-col\">\n                                        <CardHeader className=\"flex flex-row items-center gap-4\">\n                                            <Avatar className=\"h-16 w-16\">\n                                                <AvatarImage src={family.avatarUrl || ''} />\n                                                <AvatarFallback>{family.tag}</AvatarFallback>\n                                            </Avatar>\n                                            <div>\n                                                <CardTitle>[{family.tag}] {family.name}</CardTitle>\n                                                <CardDescription>{family.members.length} miembros</CardDescription>\n                                            </div>\n                                        </CardHeader>\n                                        <CardContent className=\"text-sm text-muted-foreground flex-grow\">\n                                            <p className=\"line-clamp-2\">{family.description || \"Esta familia no tiene descripción.\"}</p>\n                                        </CardContent>\n                                        <CardFooter className=\"flex justify-between items-center\">\n                                            <span className=\"text-xs font-bold\">Puntos: --</span>\n                                            <ActionButton familyId={family.id} userInvitations={userInvitations} />\n                                        </CardFooter>\n                                    </Card>\n                                ))}\n                            </div>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n                <TabsContent value=\"invitations\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Invitaciones Recibidas</CardTitle>\n                            <CardDescription>Otras familias te quieren en sus filas. ¡Decide tu futuro!</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            {familyInvitations.length > 0 ? (\n                                <div className=\"space-y-4\">\n                                    {familyInvitations.map(inv => (\n                                        <div key={inv.id} className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border rounded-lg gap-4\">\n                                            <div className=\"flex items-center gap-4\">\n                                                <Avatar>\n                                                    <AvatarImage src={inv.family!.avatarUrl || ''} />\n                                                    <AvatarFallback>{inv.family!.tag}</AvatarFallback>\n                                                </Avatar>\n                                                <div>\n                                                    <p className=\"font-semibold\">[{inv.family!.tag}] {inv.family!.name}</p>\n                                                    <p className=\"text-xs text-muted-foreground\">Te ha invitado a unirte.</p>\n                                                </div>\n                                            </div>\n                                            <div className=\"flex gap-2 shrink-0\">\n                                                <Button size=\"sm\" className=\"bg-green-600 hover:bg-green-700\" onClick={() => handleInvitationAction('accept', inv.id)} disabled={isPending}>\n                                                    <Check className=\"mr-2 h-4 w-4\" /> Aceptar\n                                                </Button>\n                                                <Button size=\"sm\" variant=\"destructive\" onClick={() => handleInvitationAction('reject', inv.id)} disabled={isPending}>\n                                                    <X className=\"mr-2 h-4 w-4\" /> Rechazar\n                                                </Button>\n                                            </div>\n                                        </div>\n                                    ))}\n                                </div>\n                            ) : (\n                                <p className=\"text-center text-muted-foreground py-8\">No tienes invitaciones pendientes.</p>\n                            )}\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n            </Tabs>\n        </div>\n    );\n}",
    "src/components/dashboard/family/family-management-view.tsx": "\n'use client';\n\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport type { FullFamily, FullFamilyMember } from \"@/types\";\nimport { FamilyRole } from \"@/types\";\nimport { useTransition } from \"react\";\nimport Link from \"next/link\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowLeft, Crown, Shield, User as UserIcon, AlertCircle, Trash2, Loader2, Check, MoreVertical } from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { updateMemberRole, transferLeadership, expelMember } from \"@/lib/actions/family.actions\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\nimport { Separator } from \"@/components/ui/separator\";\n\ninterface FamilyManagementViewProps {\n    family: FullFamily;\n    currentUserId: string;\n}\n\nconst roleTranslations: Record<FamilyRole, string> = {\n    [FamilyRole.LEADER]: \"Líder\",\n    [FamilyRole.CO_LEADER]: \"Co-Líder\",\n    [FamilyRole.MEMBER]: \"Miembro\",\n};\n\nconst roleColors: Record<FamilyRole, string> = {\n    [FamilyRole.LEADER]: \"bg-amber-500 text-amber-900\",\n    [FamilyRole.CO_LEADER]: \"bg-blue-500 text-blue-900\",\n    [FamilyRole.MEMBER]: \"bg-gray-500 text-gray-100\",\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\n\nfunction MemberActions({ member, familyId, currentUserId }: { member: FullFamilyMember, familyId: string, currentUserId: string }) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const isMobile = useIsMobile();\n    \n    if (member.userId === currentUserId) return null;\n\n    const handleRoleChange = (newRole: FamilyRole) => {\n        startTransition(async () => {\n            const result = await updateMemberRole(member.userId, familyId, newRole);\n            if (result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n            else toast({ title: 'Éxito', description: result.success });\n        });\n    }\n    \n    const handleTransferLeadership = () => {\n        startTransition(async () => {\n            const result = await transferLeadership(member.userId, familyId);\n            if (result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n            else toast({ title: 'Éxito', description: result.success });\n        });\n    }\n\n    const handleExpel = () => {\n         startTransition(async () => {\n            const result = await expelMember(member.userId, familyId);\n            if (result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n            else toast({ title: 'Éxito', description: result.success });\n        });\n    }\n    \n    const roleSelect = (\n        <Select onValueChange={(role) => handleRoleChange(role as FamilyRole)} defaultValue={member.role} disabled={isPending}>\n            <SelectTrigger className=\"w-[150px] h-9\">\n                <SelectValue placeholder=\"Cambiar Rango\" />\n            </SelectTrigger>\n            <SelectContent>\n                <SelectItem value={FamilyRole.CO_LEADER}>Co-Líder</SelectItem>\n                <SelectItem value={FamilyRole.MEMBER}>Miembro</SelectItem>\n            </SelectContent>\n        </Select>\n    );\n\n    const transferDialog = (\n        <AlertDialog>\n            <AlertDialogTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\">Transferir Liderazgo</Button>\n            </AlertDialogTrigger>\n            <AlertDialogContent>\n                <AlertDialogHeader>\n                    <AlertDialogTitle>¿Transferir el liderazgo?</AlertDialogTitle>\n                    <AlertDialogDescription>\n                        Esta acción es irreversible. Cederás tu rango de Líder a {member.user.name}. ¿Estás seguro?\n                    </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                    <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                    <AlertDialogAction onClick={handleTransferLeadership} disabled={isPending}>\n                        {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Check />}\n                        Confirmar\n                    </AlertDialogAction>\n                </AlertDialogFooter>\n            </AlertDialogContent>\n        </AlertDialog>\n    );\n\n    const expelDialog = (\n        <AlertDialog>\n            <AlertDialogTrigger asChild>\n                 <Button variant=\"destructive\" size=\"sm\">\n                    <Trash2 className=\"mr-2 h-4 w-4\" />\n                    Expulsar\n                </Button>\n            </AlertDialogTrigger>\n            <AlertDialogContent>\n                <AlertDialogHeader>\n                    <AlertDialogTitle>¿Expulsar a {member.user.name}?</AlertDialogTitle>\n                    <AlertDialogDescription>\n                        El jugador será eliminado de la familia permanentemente.\n                    </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                    <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                    <AlertDialogAction onClick={handleExpel} className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\" disabled={isPending}>\n                        {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Trash2 />}\n                        Expulsar\n                    </AlertDialogAction>\n                </AlertDialogFooter>\n            </AlertDialogContent>\n        </AlertDialog>\n    );\n\n\n    if (isMobile) {\n        return (\n             <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                    <Button variant=\"ghost\" size=\"icon\"><MoreVertical className=\"h-5 w-5\"/></Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                    <DropdownMenuItem onSelect={(e) => e.preventDefault()}>\n                         <Select onValueChange={(role) => handleRoleChange(role as FamilyRole)} defaultValue={member.role} disabled={isPending}>\n                            <SelectTrigger className=\"w-full border-none h-auto p-0 justify-start gap-2 focus:ring-0\">\n                                <SelectValue placeholder=\"Cambiar Rango\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                <SelectItem value={FamilyRole.CO_LEADER}>Co-Líder</SelectItem>\n                                <SelectItem value={FamilyRole.MEMBER}>Miembro</SelectItem>\n                            </SelectContent>\n                        </Select>\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator/>\n                    <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <DropdownMenuItem onSelect={(e) => e.preventDefault()}>Transferir Liderazgo</DropdownMenuItem>\n                        </AlertDialogTrigger>\n                         <AlertDialogContent>\n                            <AlertDialogHeader>\n                                <AlertDialogTitle>¿Transferir el liderazgo?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                    Esta acción es irreversible. Cederás tu rango de Líder a {member.user.name}. ¿Estás seguro?\n                                </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                                <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                                <AlertDialogAction onClick={handleTransferLeadership} disabled={isPending}>\n                                    {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Check />}\n                                    Confirmar\n                                </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                    </AlertDialog>\n                     <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <DropdownMenuItem onSelect={(e) => e.preventDefault()} className=\"text-destructive focus:bg-destructive/10 focus:text-destructive\">Expulsar Miembro</DropdownMenuItem>\n                        </AlertDialogTrigger>\n                         <AlertDialogContent>\n                             <AlertDialogHeader>\n                                <AlertDialogTitle>¿Expulsar a {member.user.name}?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                    El jugador será eliminado de la familia permanentemente.\n                                </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                                <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                                <AlertDialogAction onClick={handleExpel} className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\" disabled={isPending}>\n                                    {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Trash2 />}\n                                    Expulsar\n                                </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                     </AlertDialog>\n                </DropdownMenuContent>\n            </DropdownMenu>\n        )\n    }\n\n    return (\n        <div className=\"flex items-center gap-2\">\n            {roleSelect}\n            {transferDialog}\n            {expelDialog}\n        </div>\n    );\n}\n\n\nexport function FamilyManagementView({ family, currentUserId }: FamilyManagementViewProps) {\n    const isMobile = useIsMobile();\n    \n    const sortedMembers = [...family.members].sort((a, b) => {\n        if (a.role === FamilyRole.LEADER) return -1;\n        if (b.role === FamilyRole.LEADER) return 1;\n        if (a.role === FamilyRole.CO_LEADER) return -1;\n        if (b.role === FamilyRole.CO_LEADER) return 1;\n        return (b.user.puntuacion?.puntosTotales ?? 0) - (a.user.puntuacion?.puntosTotales ?? 0);\n    });\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Administrar Rangos</h2>\n                    <p className=\"text-muted-foreground\">Familia: {family.name} [{family.tag}]</p>\n                </div>\n                <div className=\"flex gap-2\">\n                     <Button asChild>\n                        <Link href=\"/family\">\n                            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                            Volver\n                        </Link>\n                    </Button>\n                </div>\n            </div>\n            \n            <Card className=\"bg-primary/5 border-primary/20\">\n                <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\"><AlertCircle className=\"text-primary\"/>Permisos del Líder</CardTitle>\n                </CardHeader>\n                <CardContent>\n                    <ul className=\"list-disc pl-5 text-muted-foreground space-y-1 text-sm\">\n                        <li>Cambiar rangos de miembros a Co-Líder o Miembro.</li>\n                        <li>Transferir el liderazgo a otro miembro (esta acción es irreversible).</li>\n                        <li>Expulsar miembros de la familia.</li>\n                    </ul>\n                </CardContent>\n            </Card>\n\n            <Card>\n                <CardHeader>\n                    <CardTitle>Miembros de la Familia</CardTitle>\n                    <CardDescription>Gestiona los rangos y permisos de los miembros.</CardDescription>\n                </CardHeader>\n                <CardContent>\n                     {/* Vista de tabla para escritorio */}\n                    <div className=\"hidden md:block border rounded-lg overflow-hidden\">\n                        <Table>\n                            <TableHeader>\n                                <TableRow>\n                                    <TableHead>Miembro</TableHead>\n                                    <TableHead>Rango Actual</TableHead>\n                                    <TableHead className=\"text-right\">Puntos</TableHead>\n                                    <TableHead className=\"text-right\">Acciones</TableHead>\n                                </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                                {sortedMembers.map(member => (\n                                    <TableRow key={member.userId}>\n                                        <TableCell>\n                                            <div className=\"flex items-center gap-3\">\n                                                <Avatar>\n                                                    <AvatarImage src={member.user.avatarUrl || ''} />\n                                                    <AvatarFallback>{member.user.name.charAt(0)}</AvatarFallback>\n                                                </Avatar>\n                                                <span className=\"font-semibold\">{member.user.name}</span>\n                                            </div>\n                                        </TableCell>\n                                        <TableCell>\n                                            <Badge className={roleColors[member.role]}>{roleTranslations[member.role]}</Badge>\n                                        </TableCell>\n                                        <TableCell className=\"text-right font-mono\">{formatPoints(member.user.puntuacion?.puntosTotales)}</TableCell>\n                                        <TableCell className=\"text-right\">\n                                            <MemberActions member={member} familyId={family.id} currentUserId={currentUserId} />\n                                        </TableCell>\n                                    </TableRow>\n                                ))}\n                            </TableBody>\n                        </Table>\n                    </div>\n                     {/* Vista de tarjetas para móvil */}\n                    <div className=\"md:hidden space-y-3\">\n                         {sortedMembers.map(member => (\n                            <Card key={member.userId} className=\"p-4\">\n                                 <div className=\"flex items-start justify-between gap-4\">\n                                     <div className=\"flex items-center gap-3\">\n                                        <Avatar>\n                                            <AvatarImage src={member.user.avatarUrl || ''} />\n                                            <AvatarFallback>{member.user.name.charAt(0)}</AvatarFallback>\n                                        </Avatar>\n                                        <div>\n                                            <p className=\"font-semibold\">{member.user.name}</p>\n                                            <Badge className={`${roleColors[member.role]} text-xs`}>{roleTranslations[member.role]}</Badge>\n                                        </div>\n                                    </div>\n                                    <MemberActions member={member} familyId={family.id} currentUserId={currentUserId} />\n                                </div>\n                                <Separator className=\"my-3\"/>\n                                <div className=\"flex justify-between items-center text-sm\">\n                                    <span className=\"text-muted-foreground\">Puntos</span>\n                                    <span className=\"font-mono font-semibold\">{formatPoints(member.user.puntuacion?.puntosTotales)}</span>\n                                </div>\n                            </Card>\n                         ))}\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n",
    "src/components/dashboard/family/family-global-view.tsx": "\n'use client'\n\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport type { FullFamily } from \"@/types\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport { ArrowLeft, Crown, Shield, User as UserIcon } from \"lucide-react\";\nimport { FamilyRole } from \"@/types\";\nimport { calcularProduccionTotalPorSegundo } from \"@/lib/formulas/room-formulas\";\nimport { ROOM_ORDER, TRAINING_ORDER, RECRUITMENT_TROOP_ORDER, SECURITY_TROOP_ORDER } from \"@/lib/constants\";\nimport { useMemo, useState } from \"react\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { cn } from \"@/lib/utils\";\n\ninterface FamilyGlobalViewProps {\n    family: FullFamily;\n}\n\nconst roleIcons: Record<FamilyRole, React.ReactNode> = {\n    [FamilyRole.LEADER]: <Crown className=\"h-4 w-4 text-amber-400\" />,\n    [FamilyRole.CO_LEADER]: <Shield className=\"h-4 w-4 text-blue-400\" />,\n    [FamilyRole.MEMBER]: <UserIcon className=\"h-4 w-4 text-muted-foreground\" />,\n}\n\nfunction formatNumber(num: number | bigint): string {\n  if (num === null || num === undefined) return \"0\";\n  return Number(num).toLocaleString('de-DE');\n}\n\nexport function FamilyGlobalView({ family }: FamilyGlobalViewProps) {\n    const isMobile = useIsMobile();\n    const [openAccordions, setOpenAccordions] = useState<string[]>(['puntos']);\n\n    const toggleAccordion = (value: string) => {\n        setOpenAccordions(prev => \n            prev.includes(value) ? prev.filter(v => v !== value) : [...prev, value]\n        );\n    }\n    \n    const membersData = useMemo(() => {\n        return family.members.map(member => {\n            const production = member.user.propiedades.reduce((acc, p) => {\n                const prod = calcularProduccionTotalPorSegundo(p);\n                acc.armas += prod.armas.produccionNeta;\n                acc.municion += prod.municion.produccionNeta;\n                acc.alcohol += prod.alcohol.produccionNeta;\n                acc.dolares += prod.dolares.produccionNeta;\n                return acc;\n            }, { armas: 0, municion: 0, alcohol: 0, dolares: 0 });\n\n            const roomLevels = new Map<string, number>();\n            member.user.propiedades.forEach(p => {\n                p.habitaciones.forEach(h => {\n                    const currentLevel = roomLevels.get(h.configuracionHabitacionId) || 0;\n                    if (h.nivel > currentLevel) {\n                        roomLevels.set(h.configuracionHabitacionId, h.nivel);\n                    }\n                });\n            });\n\n            const trainingLevels = new Map(member.user.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel]));\n            \n            const troops = new Map<string, number>();\n             member.user.propiedades.forEach(p => {\n                [...p.TropaUsuario, ...p.TropaSeguridadUsuario].forEach(t => {\n                    troops.set(t.configuracionTropaId, (troops.get(t.configuracionTropaId) || 0) + t.cantidad);\n                })\n            });\n\n            return {\n                ...member,\n                production: {\n                    armas: production.armas,\n                    municion: production.municion,\n                    alcohol: production.alcohol,\n                    dolares: production.dolares,\n                },\n                roomLevels,\n                trainingLevels,\n                troops,\n                totalResources: member.user.propiedades.reduce((acc, p) => {\n                    acc.armas += Number(p.armas);\n                    acc.municion += Number(p.municion);\n                    acc.alcohol += Number(p.alcohol);\n                    acc.dolares += Number(p.dolares);\n                    return acc;\n                }, { armas: 0, municion: 0, alcohol: 0, dolares: 0 }),\n            }\n        });\n    }, [family.members]);\n\n    const familyTotals = useMemo(() => {\n        return membersData.reduce((acc, member) => {\n            acc.puntos += member.user.puntuacion?.puntosTotales ?? 0;\n            acc.edificios += member.user.propiedades.length;\n            acc.armas += member.totalResources.armas;\n            acc.municion += member.totalResources.municion;\n            acc.alcohol += member.totalResources.alcohol;\n            acc.dolares += member.totalResources.dolares;\n            acc.produccionArmas += member.production.armas;\n            acc.produccionMunicion += member.production.municion;\n            acc.produccionAlcohol += member.production.alcohol;\n            acc.produccionDolares += member.production.dolares;\n\n            member.troops.forEach((count, id) => {\n                acc.troops[id] = (acc.troops[id] || 0) + count;\n            });\n\n            return acc;\n        }, {\n            puntos: 0, edificios: 0, armas: 0, municion: 0, alcohol: 0, dolares: 0,\n            produccionArmas: 0, produccionMunicion: 0, produccionAlcohol: 0, produccionDolares: 0,\n            troops: {} as Record<string, number>\n        });\n    }, [membersData]);\n    \n    const { roomNames, trainingNames, troopNames } = useMemo(() => {\n        const roomNames = new Map<string, string>();\n        const trainingNames = new Map<string, string>();\n        const troopNames = new Map<string, string>();\n    \n        family.members.forEach(member => {\n            member.user.propiedades.forEach(p => {\n                p.habitaciones.forEach(h => {\n                    if (!roomNames.has(h.configuracionHabitacionId)) {\n                        roomNames.set(h.configuracionHabitacionId, h.configuracionHabitacion.nombre);\n                    }\n                });\n                [...p.TropaUsuario, ...p.TropaSeguridadUsuario].forEach(t => {\n                    if (!troopNames.has(t.configuracionTropaId)) {\n                        troopNames.set(t.configuracionTropaId, t.configuracionTropa.nombre);\n                    }\n                });\n            });\n            member.user.entrenamientos.forEach(t => {\n                if (!trainingNames.has(t.configuracionEntrenamientoId)) {\n                    trainingNames.set(t.configuracionEntrenamientoId, t.configuracionEntrenamiento.nombre);\n                }\n            });\n        });\n    \n        return { roomNames, trainingNames, troopNames };\n    }, [family.members]);\n\n    const resourceRows = [\n        { label: \"Puntos\", getValue: (m: any) => formatNumber(m.user.puntuacion?.puntosTotales ?? 0), getTotal: () => formatNumber(familyTotals.puntos), positive: false },\n        { label: \"Edificios\", getValue: (m: any) => formatNumber(m.user.propiedades.length), getTotal: () => formatNumber(familyTotals.edificios), positive: false },\n        { label: \"Armas\", getValue: (m: any) => formatNumber(m.totalResources.armas), getTotal: () => formatNumber(familyTotals.armas), positive: false },\n        { label: \"Municion\", getValue: (m: any) => formatNumber(m.totalResources.municion), getTotal: () => formatNumber(familyTotals.municion), positive: false },\n        { label: \"Alcohol\", getValue: (m: any) => formatNumber(m.totalResources.alcohol), getTotal: () => formatNumber(familyTotals.alcohol), positive: false },\n        { label: \"Dolares\", getValue: (m: any) => formatNumber(m.totalResources.dolares), getTotal: () => formatNumber(familyTotals.dolares), positive: false },\n        { label: \"Armas/Hora\", getValue: (m: any) => `+${formatNumber(m.production.armas)}`, getTotal: () => `+${formatNumber(familyTotals.produccionArmas)}`, positive: true },\n        { label: \"Municion/Hora\", getValue: (m: any) => `+${formatNumber(m.production.municion)}`, getTotal: () => `+${formatNumber(familyTotals.produccionMunicion)}`, positive: true },\n        { label: \"Alcohol/Hora\", getValue: (m: any) => `${m.production.alcohol >= 0 ? '+' : ''}${formatNumber(m.production.alcohol)}`, getTotal: () => `${familyTotals.produccionAlcohol >= 0 ? '+' : ''}${formatNumber(familyTotals.produccionAlcohol)}`, positive: true },\n        { label: \"Dolares/Hora\", getValue: (m: any) => `+${formatNumber(m.production.dolares)}`, getTotal: () => `+${formatNumber(familyTotals.produccionDolares)}`, positive: true },\n    ];\n    \n    const renderDesktopTable = () => (\n         <Card>\n            <CardContent className=\"p-0\">\n                <ScrollArea className=\"w-full whitespace-nowrap\">\n                    <Table className=\"min-w-full\">\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead className=\"sticky left-0 bg-background/95 z-10 w-[180px]\">Jugador</TableHead>\n                                {membersData.map(member => (\n                                    <TableHead key={member.userId} className=\"text-center\">\n                                        <div className=\"flex flex-col items-center gap-1\">\n                                            <div className=\"flex items-center gap-1\">{roleIcons[member.role]}<span className=\"font-bold\">{member.user.name}</span></div>\n                                            <span className=\"text-xs text-muted-foreground\">({member.role})</span>\n                                            <Avatar className=\"h-12 w-12 mt-1\"><AvatarImage src={member.user.avatarUrl || ''} /><AvatarFallback>{member.user.name.charAt(0)}</AvatarFallback></Avatar>\n                                        </div>\n                                    </TableHead>\n                                ))}\n                                <TableHead className=\"text-center\">Total Familia</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {resourceRows.map(row => (\n                                 <TableRow key={row.label}>\n                                    <TableCell className=\"sticky left-0 bg-background/95 font-semibold\">{row.label}</TableCell>\n                                    {membersData.map(member => (\n                                        <TableCell key={member.userId} className={`text-center font-mono ${row.positive ? 'text-green-400' : 'text-foreground'}`}>\n                                            {row.getValue(member)}\n                                        </TableCell>\n                                    ))}\n                                    <TableCell className={`text-center font-mono font-bold ${row.positive ? 'text-green-400' : 'text-primary'}`}>{row.getTotal()}</TableCell>\n                                </TableRow>\n                            ))}\n                            \n                            <TableRow><TableCell colSpan={membersData.length + 2} className=\"h-2 bg-muted/50 p-0\"></TableCell></TableRow>\n                            \n                            {TRAINING_ORDER.map(trainingId => {\n                                const trainingName = trainingNames.get(trainingId);\n                                if (!trainingName) return null;\n\n                                const maxLevel = Math.max(...membersData.map(m => m.trainingLevels.get(trainingId) || 0));\n\n                                return (\n                                    <TableRow key={trainingId}>\n                                        <TableCell className=\"sticky left-0 bg-background/95 font-semibold\">{trainingName}</TableCell>\n                                        {membersData.map(member => (\n                                            <TableCell key={member.userId} className=\"text-center font-mono\">\n                                                {member.trainingLevels.get(trainingId) || 0}\n                                            </TableCell>\n                                        ))}\n                                        <TableCell className=\"text-center font-mono font-bold text-primary\">{maxLevel}</TableCell>\n                                    </TableRow>\n                                )\n                            })}\n\n                            <TableRow><TableCell colSpan={membersData.length + 2} className=\"h-2 bg-muted/50 p-0\"></TableCell></TableRow>\n\n                            {RECRUITMENT_TROOP_ORDER.concat(SECURITY_TROOP_ORDER).map(troopId => {\n                                 const troopName = troopNames.get(troopId);\n                                 if (!troopName) return null;\n                                 const total = familyTotals.troops[troopId] || 0;\n                                 return (\n                                     <TableRow key={troopId}>\n                                        <TableCell className=\"sticky left-0 bg-background/95 font-semibold\">{troopName}</TableCell>\n                                        {membersData.map(member => (\n                                            <TableCell key={member.userId} className=\"text-center font-mono\">{formatNumber(member.troops.get(troopId) || 0)}</TableCell>\n                                        ))}\n                                        <TableCell className=\"text-center font-mono font-bold text-primary\">{formatNumber(total)}</TableCell>\n                                     </TableRow>\n                                 )\n                            })}\n                        </TableBody>\n                    </Table>\n                </ScrollArea>\n            </CardContent>\n        </Card>\n    );\n\n    const renderMobileCards = () => (\n        <div className=\"space-y-4\">\n            {membersData.map(member => (\n                <Card key={member.userId}>\n                    <CardHeader className=\"flex flex-row items-center gap-4\">\n                        <Avatar className=\"h-16 w-16\"><AvatarImage src={member.user.avatarUrl || ''} /><AvatarFallback>{member.user.name.charAt(0)}</AvatarFallback></Avatar>\n                        <div>\n                             <CardTitle className=\"flex items-center gap-2\">{roleIcons[member.role]} {member.user.name}</CardTitle>\n                             <CardDescription>{member.role}</CardDescription>\n                        </div>\n                    </CardHeader>\n                    <CardContent>\n                        <Accordion type=\"multiple\" value={openAccordions} onValueChange={setOpenAccordions}>\n                            <AccordionItem value=\"puntos\">\n                                <AccordionTrigger>Resumen de Puntos y Recursos</AccordionTrigger>\n                                <AccordionContent className=\"space-y-2\">\n                                    {resourceRows.map(row => (\n                                        <div key={row.label} className=\"flex justify-between text-sm\">\n                                            <span className=\"text-muted-foreground\">{row.label}</span>\n                                            <span className={cn(\"font-semibold\", row.positive ? 'text-green-400' : 'text-foreground')}>{row.getValue(member)}</span>\n                                        </div>\n                                    ))}\n                                </AccordionContent>\n                            </AccordionItem>\n                             <AccordionItem value=\"entrenamientos\">\n                                <AccordionTrigger>Entrenamientos</AccordionTrigger>\n                                <AccordionContent className=\"space-y-2\">\n                                     {TRAINING_ORDER.map(id => {\n                                         const name = trainingNames.get(id);\n                                         if(!name) return null;\n                                         return (\n                                            <div key={id} className=\"flex justify-between text-sm\">\n                                                <span className=\"text-muted-foreground\">{name}</span>\n                                                <span className=\"font-semibold\">{member.trainingLevels.get(id) || 0}</span>\n                                            </div>\n                                         )\n                                     })}\n                                </AccordionContent>\n                            </AccordionItem>\n                             <AccordionItem value=\"tropas\">\n                                <AccordionTrigger>Tropas</AccordionTrigger>\n                                <AccordionContent className=\"space-y-2\">\n                                     {RECRUITMENT_TROOP_ORDER.concat(SECURITY_TROOP_ORDER).map(id => {\n                                         const name = troopNames.get(id);\n                                         if(!name) return null;\n                                         return (\n                                            <div key={id} className=\"flex justify-between text-sm\">\n                                                <span className=\"text-muted-foreground\">{name}</span>\n                                                <span className=\"font-semibold\">{formatNumber(member.troops.get(id) || 0)}</span>\n                                            </div>\n                                         )\n                                     })}\n                                </AccordionContent>\n                            </AccordionItem>\n                        </Accordion>\n                    </CardContent>\n                </Card>\n            ))}\n        </div>\n    );\n\n    return (\n        <div className=\"space-y-4\">\n             <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Visión Global de la Familia</h2>\n                    <p className=\"text-muted-foreground\">\n                       Comparativa de todos los miembros de {family.name}\n                    </p>\n                </div>\n                <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/family\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver\n                    </Link>\n                </Button>\n            </div>\n            {isMobile ? renderMobileCards() : renderDesktopTable()}\n        </div>\n    )\n}\n",
    "src/components/dashboard/family/family-requests-view.tsx": "'use client'\n\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { FullFamilyInvitation } from \"@/types\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTransition } from \"react\";\nimport { acceptRequest, rejectInvitation } from \"@/lib/actions/family.actions\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Check, Loader2, X, ArrowLeft } from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Link from \"next/link\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\n\n\ninterface FamilyRequestsViewProps {\n    requests: FullFamilyInvitation[];\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nexport function FamilyRequestsView({ requests }: FamilyRequestsViewProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const handleAction = (action: 'accept' | 'reject', invitationId: string) => {\n        startTransition(async () => {\n            const result = action === 'accept' \n                ? await acceptRequest(invitationId)\n                : await rejectInvitation(invitationId);\n            \n            if(result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: result.success });\n            }\n        })\n    }\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Solicitudes para Unirse</h2>\n                    <p className=\"text-muted-foreground\">\n                       Gestiona las solicitudes pendientes de los jugadores que quieren unirse a tu familia.\n                    </p>\n                </div>\n                <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/family\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver a la Familia\n                    </Link>\n                </Button>\n            </div>\n            <Card>\n                <CardContent className=\"p-0\">\n                    {requests.length === 0 ? (\n                        <p className=\"p-6 text-center text-muted-foreground\">No hay solicitudes pendientes.</p>\n                    ) : (\n                        <>\n                        {/* Desktop Table */}\n                        <Table className=\"hidden md:table\">\n                            <TableHeader>\n                                <TableRow>\n                                    <TableHead>Jugador</TableHead>\n                                    <TableHead className=\"text-right\">Puntos</TableHead>\n                                    <TableHead className=\"text-right\">Fecha Solicitud</TableHead>\n                                    <TableHead className=\"text-right\">Acciones</TableHead>\n                                </TableRow>\n                            </TableHeader>\n                             <TableBody>\n                                {requests.map(req => (\n                                    <TableRow key={req.id}>\n                                        <TableCell className=\"font-semibold\">{req.user?.name || 'Desconocido'}</TableCell>\n                                        <TableCell className=\"text-right font-mono\">{formatPoints(req.user?.puntuacion?.puntosTotales)}</TableCell>\n                                        <TableCell className=\"text-right\">{new Date(req.created_at).toLocaleDateString()}</TableCell>\n                                        <TableCell className=\"text-right space-x-2\">\n                                            <Button size=\"icon\" variant=\"outline\" className=\"text-green-500 hover:text-green-500 hover:bg-green-500/10\" onClick={() => handleAction('accept', req.id)} disabled={isPending}>\n                                                {isPending ? <Loader2 className=\"animate-spin\" /> : <Check />}\n                                            </Button>\n                                             <Button size=\"icon\" variant=\"outline\" className=\"text-destructive hover:text-destructive hover:bg-destructive/10\" onClick={() => handleAction('reject', req.id)} disabled={isPending}>\n                                                {isPending ? <Loader2 className=\"animate-spin\" /> : <X />}\n                                            </Button>\n                                        </TableCell>\n                                    </TableRow>\n                                ))}\n                            </TableBody>\n                        </Table>\n                         {/* Mobile Cards */}\n                         <div className=\"md:hidden p-2 space-y-2\">\n                            {requests.map(req => (\n                                <Card key={req.id} className=\"p-4\">\n                                     <div className=\"flex items-center justify-between\">\n                                        <div className=\"flex items-center gap-3\">\n                                             <Avatar>\n                                                <AvatarImage src={req.user?.avatarUrl || ''} />\n                                                <AvatarFallback>{req.user?.name?.charAt(0) || '?'}</AvatarFallback>\n                                            </Avatar>\n                                            <div>\n                                                 <p className=\"font-semibold\">{req.user?.name || 'Desconocido'}</p>\n                                                <p className=\"text-xs text-muted-foreground\">{new Date(req.created_at).toLocaleDateString()}</p>\n                                            </div>\n                                        </div>\n                                         <div className=\"text-right\">\n                                            <p className=\"font-bold text-primary\">{formatPoints(req.user?.puntuacion?.puntosTotales)}</p>\n                                            <p className=\"text-xs text-muted-foreground\">Puntos</p>\n                                        </div>\n                                    </div>\n                                    <Separator className=\"my-3\"/>\n                                    <div className=\"flex justify-end gap-2\">\n                                             <Button size=\"sm\" variant=\"outline\" className=\"flex-1 text-destructive hover:text-destructive hover:bg-destructive/10\" onClick={() => handleAction('reject', req.id)} disabled={isPending}>\n                                            <X className=\"mr-2 h-4 w-4\"/> Rechazar\n                                        </Button>\n                                        <Button size=\"sm\" className=\"flex-1\" onClick={() => handleAction('accept', req.id)} disabled={isPending}>\n                                            <Check className=\"mr-2 h-4 w-4\"/> Aceptar\n                                        </Button>\n                                    </div>\n                                </Card>\n                            ))}\n                         </div>\n                        </>\n                    )}\n                </CardContent>\n            </Card>\n        </div>\n    )\n}",
    "src/components/dashboard/family/family-dashboard-view.tsx": "\n\n'use client'\n\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { FullFamily, UserWithProgress } from \"@/types\";\nimport { FamilyRole } from \"@/types\";\nimport { Crown, Shield, User, Users, Loader2, UserPlus, MailPlus, HandMetal, Send, Settings2, AreaChart, Edit } from \"lucide-react\";\nimport {\n    AlertDialog,\n    AlertDialogAction,\n    AlertDialogCancel,\n    AlertDialogContent,\n    AlertDialogDescription,\n    AlertDialogFooter,\n    AlertDialogHeader,\n    AlertDialogTitle,\n    AlertDialogTrigger,\n  } from \"@/components/ui/alert-dialog\"\nimport { useRef, useTransition } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { createFamilyAnnouncement, leaveFamily } from \"@/lib/actions/family.actions\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\nimport { InviteMemberDialog } from \"./invite-member-dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { EditFamilyDialog } from \"./edit-family-dialog\";\n\n\ninterface FamilyDashboardViewProps {\n    family: FullFamily;\n    currentUser: UserWithProgress;\n    allUsers: { id: string; name: string; familyMember: { familyId: string; } | null; }[];\n    pendingRequests: number;\n}\n\nconst roleIcons: Record<FamilyRole, React.ReactNode> = {\n    [FamilyRole.LEADER]: <Crown className=\"h-4 w-4 text-amber-400\" />,\n    [FamilyRole.CO_LEADER]: <Shield className=\"h-4 w-4 text-blue-400\" />,\n    [FamilyRole.MEMBER]: <User className=\"h-4 w-4 text-muted-foreground\" />,\n}\n\nfunction AnnouncementForm({ familyId }: { familyId: string }) {\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n    const formRef = useRef<HTMLFormElement>(null);\n\n    const handleSubmit = async (formData: FormData) => {\n        const content = formData.get('content') as string;\n        if (!content.trim()) {\n            toast({ variant: 'destructive', title: 'Error', description: 'El anuncio no puede estar vacío.'});\n            return;\n        }\n\n        startTransition(async () => {\n             const result = await createFamilyAnnouncement(familyId, content);\n              if (result.error) {\n                 toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                 toast({ title: 'Éxito', description: result.success });\n                 formRef.current?.reset();\n             }\n        });\n    }\n    \n    return (\n        <form action={handleSubmit} ref={formRef} className=\"space-y-2 mt-4\">\n            <Textarea \n                name=\"content\"\n                placeholder=\"Escribe tu anuncio aquí...\"\n                rows={3}\n                disabled={isPending}\n            />\n            <Button type=\"submit\" size=\"sm\" disabled={isPending}>\n                {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : <Send className=\"mr-2 h-4 w-4\" />}\n                Publicar\n            </Button>\n        </form>\n    )\n}\n\nexport function FamilyDashboardView({ family, currentUser, allUsers, pendingRequests }: FamilyDashboardViewProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const handleLeaveFamily = () => {\n        startTransition(async () => {\n            const result = await leaveFamily();\n             if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Has abandonado la familia', description: result.success });\n            }\n        });\n    }\n    \n    const userRole = currentUser.familyMember?.role;\n    const canManage = userRole === FamilyRole.LEADER || userRole === FamilyRole.CO_LEADER;\n    const isLeader = userRole === FamilyRole.LEADER;\n\n    const usersNotInFamily = allUsers.filter(u => !u.familyMember && u.id !== currentUser.id);\n\n    // 🟢 CORRECCIÓN: family.members ya no es un array aquí, es un número.\n    const memberCount = typeof family.members === 'number' ? family.members : (Array.isArray(family.members) ? family.members.length : 0);\n\n    return (\n        <div className=\"main-view space-y-6\">\n            <Card className=\"overflow-hidden\">\n                <div className=\"relative h-48 bg-muted\">\n                    <Image src=\"/img/login_bg.jpg\" alt=\"Family Banner\" fill className=\"object-cover\" data-ai-hint=\"mafia pattern\" />\n                    <div className=\"absolute inset-0 bg-gradient-to-t from-black/80 to-transparent\" />\n                    <div className=\"absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2\">\n                         <Avatar className=\"h-28 w-28 border-4 border-background shadow-lg\">\n                            <AvatarImage src={family.avatarUrl || ''} alt={family.name} data-ai-hint=\"family crest\" />\n                            <AvatarFallback className=\"text-4xl\">{family.tag}</AvatarFallback>\n                        </Avatar>\n                    </div>\n                </div>\n                 <div className=\"pt-16 pb-4 px-4 text-center border-b\">\n                     <h2 className=\"text-3xl font-bold font-heading tracking-widest text-white shadow-lg\">[{family.tag}] {family.name}</h2>\n                     <p className=\"text-muted-foreground max-w-2xl mx-auto mt-2\">{family.description || \"La familia más temida de la ciudad.\"}</p>\n                 </div>\n                 <div className=\"p-4 bg-muted/30 flex flex-wrap items-center justify-center gap-2\">\n                    {canManage && <InviteMemberDialog familyId={family.id} allUsers={usersNotInFamily} />}\n                    {canManage && (\n                         <Button asChild size=\"sm\" variant=\"outline\">\n                            <Link href={`/family/requests`}>\n                                <HandMetal className=\"mr-2 h-4 w-4\" />\n                                Solicitudes\n                                {pendingRequests > 0 && <Badge variant=\"destructive\" className=\"ml-2\">{pendingRequests}</Badge>}\n                            </Link>\n                        </Button>\n                    )}\n                    {isLeader && (\n                         <Button asChild size=\"sm\" variant=\"outline\">\n                            <Link href={`/family/management`}>\n                                <Settings2 className=\"mr-2 h-4 w-4\" />\n                                Administrar Rangos\n                            </Link>\n                        </Button>\n                    )}\n                     {canManage && <EditFamilyDialog family={family} />}\n                    <Button asChild size=\"sm\" variant=\"outline\">\n                        <Link href={`/family/members?id=${family.id}`}>\n                            <Users className=\"mr-2 h-4 w-4\" />\n                            Ver Lista de Miembros\n                        </Link>\n                    </Button>\n                    <Button asChild size=\"sm\" variant=\"outline\">\n                        <Link href=\"/family/global\">\n                            <AreaChart className=\"mr-2 h-4 w-4\" />\n                            Visión Global\n                        </Link>\n                    </Button>\n                     <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <Button variant=\"destructive\" size=\"sm\">Abandonar Familia</Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                            <AlertDialogHeader>\n                            <AlertDialogTitle>¿Estás seguro de que quieres abandonar la familia?</AlertDialogTitle>\n                            <AlertDialogDescription>\n                                Esta acción no se puede deshacer. Perderás todos los beneficios y la protección de la familia.\n                            </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                            <AlertDialogAction onClick={handleLeaveFamily} disabled={isPending}>\n                                {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                                Sí, abandonar familia\n                            </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                    </AlertDialog>\n                </div>\n            </Card>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <div className=\"lg:col-span-2\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Tablón de Anuncios</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                           {family.announcements.length === 0 ? (\n                            <p className=\"text-sm text-center text-muted-foreground py-8\">\n                                El tablón de anuncios está vacío.\n                            </p>\n                           ) : (\n                               <div className=\"space-y-4\">\n                                   {family.announcements.map((announcement) => (\n                                       <div key={announcement.id} className=\"p-4 border rounded-md\">\n                                           <div className=\"flex items-center gap-3 mb-2\">\n                                                <Avatar className=\"h-8 w-8\">\n                                                    <AvatarImage src={announcement.author.avatarUrl || ''} />\n                                                    <AvatarFallback>{announcement.author.name.charAt(0)}</AvatarFallback>\n                                                </Avatar>\n                                                <div>\n                                                    <p className=\"font-semibold text-sm\">{announcement.author.name}</p>\n                                                    <p className=\"text-xs text-muted-foreground\">{new Date(announcement.created_at).toLocaleString()}</p>\n                                                </div>\n                                           </div>\n                                           <p className=\"text-sm whitespace-pre-wrap\">{announcement.content}</p>\n                                       </div>\n                                   ))}\n                               </div>\n                           )}\n                           {canManage && <AnnouncementForm familyId={family.id} />}\n                        </CardContent>\n                    </Card>\n                </div>\n                 <div>\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Estadísticas</CardTitle>\n                        </CardHeader>\n                        <CardContent className=\"space-y-4\">\n                            <div className=\"flex items-center justify-between\">\n                                <span className=\"text-muted-foreground\">Miembros</span>\n                                <span className=\"font-bold\">{memberCount}</span>\n                            </div>\n                            <Separator />\n                            <div className=\"flex items-center justify-between\">\n                                <span className=\"text-muted-foreground\">Puntos Totales</span>\n                                <span className=\"font-bold\">--</span>\n                            </div>\n                            <Separator />\n                             <div className=\"flex items-center justify-between\">\n                                <span className=\"text-muted-foreground\">Posición Ranking</span>\n                                <span className=\"font-bold\">--</span>\n                            </div>\n                        </CardContent>\n                    </Card>\n                </div>\n            </div>\n        </div>\n    )\n\n}\n",
    "src/components/dashboard/family/edit-family-dialog.tsx": "\n'use client'\n\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Edit, Loader2, UploadCloud } from \"lucide-react\";\nimport { useRef, useState, useTransition } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { FullFamily } from \"@/types\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { updateFamilyDetails } from \"@/lib/actions/family.actions\";\n\ninterface EditFamilyDialogProps {\n    family: FullFamily;\n}\n\nexport function EditFamilyDialog({ family }: EditFamilyDialogProps) {\n    const [isOpen, setIsOpen] = useState(false);\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n    const fileInputRef = useRef<HTMLInputElement>(null);\n\n    const [name, setName] = useState(family.name);\n    const [tag, setTag] = useState(family.tag);\n    const [description, setDescription] = useState(family.description || '');\n    const [avatarUrl, setAvatarUrl] = useState(family.avatarUrl || '');\n    const [previewUrl, setPreviewUrl] = useState<string | null>(family.avatarUrl);\n    \n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (file) {\n            setPreviewUrl(URL.createObjectURL(file));\n        }\n    };\n\n    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {\n        e.preventDefault();\n        const formData = new FormData(e.currentTarget);\n        formData.append('familyId', family.id);\n        \n        startTransition(async () => {\n            const result = await updateFamilyDetails(formData);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: '¡Éxito!', description: result.success });\n                setIsOpen(false);\n            }\n        });\n    };\n\n    return (\n        <Dialog open={isOpen} onOpenChange={setIsOpen}>\n            <DialogTrigger asChild>\n                <Button size=\"sm\" variant=\"outline\">\n                    <Edit className=\"mr-2 h-4 w-4\" />\n                    Editar Familia\n                </Button>\n            </DialogTrigger>\n            <DialogContent>\n                <DialogHeader>\n                    <DialogTitle>Editar Detalles de la Familia</DialogTitle>\n                    <DialogDescription>\n                        Actualiza la información pública y el emblema de tu familia.\n                    </DialogDescription>\n                </DialogHeader>\n                <form onSubmit={handleSubmit} className=\"space-y-4\">\n                    <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                        <div className=\"space-y-2 sm:col-span-2\">\n                            <Label htmlFor=\"name\">Nombre de la Familia</Label>\n                            <Input id=\"name\" name=\"name\" value={name} onChange={(e) => setName(e.target.value)} required disabled={isPending} />\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"tag\">Tag (3-4 letras)</Label>\n                            <Input id=\"tag\" name=\"tag\" value={tag} onChange={(e) => setTag(e.target.value)} required minLength={3} maxLength={4} disabled={isPending} />\n                        </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"description\">Descripción Pública</Label>\n                        <Textarea id=\"description\" name=\"description\" value={description} onChange={(e) => setDescription(e.target.value)} disabled={isPending} />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"avatarUrl\">Emblema de la Familia</Label>\n                        <div className=\"flex items-start gap-4\">\n                            <div className=\"flex-grow space-y-2\">\n                                <Input id=\"avatarUrl\" name=\"avatarUrl\" value={avatarUrl} onChange={(e) => { setAvatarUrl(e.target.value); setPreviewUrl(e.target.value); }} placeholder=\"https://... o sube una imagen\" disabled={isPending} />\n                                <input\n                                    type=\"file\"\n                                    name=\"avatarFile\"\n                                    ref={fileInputRef}\n                                    className=\"hidden\"\n                                    onChange={handleFileChange}\n                                    accept=\"image/png, image/jpeg, image/gif\"\n                                />\n                                <Button type=\"button\" variant=\"outline\" onClick={() => fileInputRef.current?.click()} disabled={isPending}>\n                                    <UploadCloud className=\"mr-2 h-4 w-4\" />\n                                    Cambiar Imagen\n                                </Button>\n                            </div>\n                            <Avatar className=\"h-24 w-24 flex-shrink-0 rounded-md\">\n                                <AvatarImage src={previewUrl || ''} alt=\"Previsualización del emblema\" />\n                                <AvatarFallback className=\"rounded-md\">{tag.slice(0, 3)}</AvatarFallback>\n                            </Avatar>\n                        </div>\n                    </div>\n                    <DialogFooter>\n                        <Button variant=\"ghost\" onClick={() => setIsOpen(false)} type=\"button\">Cancelar</Button>\n                        <Button type=\"submit\" disabled={isPending}>\n                            {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                            Guardar Cambios\n                        </Button>\n                    </DialogFooter>\n                </form>\n            </DialogContent>\n        </Dialog>\n    )\n}\n",
    "src/components/dashboard/settings-view.tsx": "\n\n'use client';\n\nimport { useState, useTransition, useEffect, useRef } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { useToast } from '@/hooks/use-toast';\nimport { updateUserSettings } from '@/lib/actions/user.actions';\nimport type { UserWithProgress } from '@/types';\nimport { Loader2, Check, UploadCloud } from 'lucide-react';\nimport { Avatar, AvatarFallback, AvatarImage } from '../ui/avatar';\n\ninterface SettingsViewProps {\n    user: UserWithProgress;\n}\n\nexport function SettingsView({ user }: SettingsViewProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const [isSuccess, setIsSuccess] = useState(false);\n\n    const [name, setName] = useState(user.name);\n    const [title, setTitle] = useState(user.title || '');\n    const [avatarUrl, setAvatarUrl] = useState(user.avatarUrl || '');\n    const [avatarFile, setAvatarFile] = useState<File | null>(null);\n    const [previewUrl, setPreviewUrl] = useState<string | null>(user.avatarUrl);\n\n    const fileInputRef = useRef<HTMLInputElement>(null);\n\n    const [hasChanges, setHasChanges] = useState(false);\n\n    useEffect(() => {\n        const changesMade = name !== user.name || title !== (user.title || '') || avatarUrl !== (user.avatarUrl || '') || !!avatarFile;\n        setHasChanges(changesMade);\n    }, [name, title, avatarUrl, avatarFile, user]);\n\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const file = e.target.files?.[0];\n        if (file) {\n            setAvatarFile(file);\n            setPreviewUrl(URL.createObjectURL(file));\n        }\n    };\n\n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n        \n        const formData = new FormData();\n        formData.append('name', name);\n        formData.append('title', title);\n        formData.append('avatarUrl', avatarUrl);\n        if (avatarFile) {\n            formData.append('avatarFile', avatarFile);\n        }\n\n        startTransition(async () => {\n            const result = await updateUserSettings(formData);\n\n            if (result.serverError || result.validationErrors) {\n                toast({\n                    variant: 'destructive',\n                    title: 'Error',\n                    description: result.serverError || \"Error de validación.\",\n                });\n            } else if (result.data) {\n                toast({\n                    title: '¡Éxito!',\n                    description: 'Perfil actualizado correctamente.',\n                });\n                \n                const data = result.data;\n                \n                if (data && data.newAvatarUrl) {\n                    setAvatarUrl(data.newAvatarUrl);\n                    setPreviewUrl(data.newAvatarUrl);\n                }\n                setAvatarFile(null);\n                setIsSuccess(true);\n                setTimeout(() => setIsSuccess(false), 2000);\n            }\n        });\n    };\n\n    return (\n        <div>\n            <h2 className=\"text-3xl font-bold tracking-tight mb-4\">Ajustes de Perfil</h2>\n            <Card>\n                <form onSubmit={handleSubmit}>\n                    <CardHeader>\n                        <CardTitle>Tu Perfil</CardTitle>\n                        <CardDescription>\n                            Personaliza cómo te ven los demás en el mundo de Vendetta.\n                        </CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6\">\n                             <div className=\"space-y-6\">\n                                <div className=\"space-y-2\">\n                                    <Label htmlFor=\"name\">Nombre de Jugador</Label>\n                                    <Input\n                                        id=\"name\"\n                                        name=\"name\"\n                                        value={name}\n                                        onChange={(e) => setName(e.target.value)}\n                                        disabled={isPending}\n                                    />\n                                </div>\n                                <div className=\"space-y-2\">\n                                    <Label htmlFor=\"title\">Título</Label>\n                                    <Input\n                                        id=\"title\"\n                                        name=\"title\"\n                                        value={title}\n                                        onChange={(e) => setTitle(e.target.value)}\n                                        placeholder=\"Ej: 'El Padrino', 'Capo'\"\n                                        disabled={isPending}\n                                    />\n                                </div>\n                             </div>\n                             <div className=\"space-y-2\">\n                                <Label htmlFor=\"avatarUrl\">Avatar</Label>\n                                <div className=\"flex items-start gap-4\">\n                                     <div className=\"flex-grow space-y-2\">\n                                        <Input\n                                            id=\"avatarUrl\"\n                                            name=\"avatarUrl\"\n                                            value={avatarUrl}\n                                            onChange={(e) => {\n                                                setAvatarUrl(e.target.value)\n                                                setPreviewUrl(e.target.value)\n                                                setAvatarFile(null)\n                                            }}\n                                            placeholder=\"https://... o sube una imagen\"\n                                            disabled={isPending}\n                                        />\n                                        <input \n                                            type=\"file\" \n                                            ref={fileInputRef} \n                                            className=\"hidden\" \n                                            onChange={handleFileChange}\n                                            accept=\"image/png, image/jpeg, image/gif\"\n                                        />\n                                        <Button type=\"button\" variant=\"outline\" onClick={() => fileInputRef.current?.click()} disabled={isPending}>\n                                            <UploadCloud className=\"mr-2 h-4 w-4\" />\n                                            Subir Imagen\n                                        </Button>\n                                     </div>\n                                    <Avatar className=\"h-24 w-24 flex-shrink-0\">\n                                        <AvatarImage src={previewUrl || ''} alt={name} />\n                                        <AvatarFallback>{name?.charAt(0).toUpperCase()}</AvatarFallback>\n                                    </Avatar>\n                                </div>\n                            </div>\n                        </div>\n                    </CardContent>\n                    <CardFooter>\n                        <Button type=\"submit\" disabled={isPending || !hasChanges || isSuccess} className=\"w-32\">\n                            {isPending ? (\n                                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                            ) : isSuccess ? (\n                                <Check className=\"mr-2 h-4 w-4\" />\n                            ) : null}\n                            {isPending ? 'Guardando...' : (isSuccess ? 'Guardado' : 'Guardar')}\n                        </Button>\n                    </CardFooter>\n                </form>\n            </Card>\n        </div>\n    );\n}\n",
    "src/components/dashboard/dashboard-client-layout.tsx": "'use client'\n\nimport React from \"react\"\nimport { ResourceBar } from \"./resource-bar\"\nimport { SidebarNav } from \"./sidebar-nav\"\nimport { UserWithProgress } from \"@/types\"\n\nfunction DashboardContent({\n    children,\n  }: {\n    children: React.ReactNode\n  }) {\n    return (\n        <div className=\"dashboard-grid\">\n            <SidebarNav />\n            <main className=\"main-content\">\n                <ResourceBar />\n                <div className=\"container\">\n                    {children}\n                </div>\n            </main>\n        </div>\n    )\n}\n\nexport function DashboardClientLayout({\n    children,\n    user,\n  }: {\n    children: React.ReactNode\n    user: UserWithProgress\n  }) {\n    \n    if (!user) {\n        return null;\n    }\n\n    return (\n       <DashboardContent>\n            {children}\n       </DashboardContent>\n    )\n}\n",
    "src/components/dashboard/sidebar-nav.tsx": "\n'use client'\n\nimport React, { useState } from 'react';\nimport Link from 'next/link';\nimport { usePathname, useSearchParams } from 'next/navigation';\nimport { \n    Home, DoorOpen, Users, Shield, Target, Users2, Map, ClipboardList, \n    BarChart, Trophy, Swords, Globe, Building2, FlaskConical, Package, \n    Calculator, Mail, Settings, Search, Menu, X, Building, LogOut\n} from 'lucide-react';\nimport { useAtomValue } from 'jotai';\nimport { userProfileAtom } from '@/store/atoms';\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from '../ui/sheet';\nimport { PropertySelector } from './property-selector';\nimport Image from 'next/image';\nimport { Avatar, AvatarFallback, AvatarImage } from '../ui/avatar';\nimport { Button } from '../ui/button';\nimport { logout } from '@/lib/actions/auth.actions';\n\ninterface NavItem {\n    href: string;\n    label: string;\n    icon: React.ReactNode;\n    isDetailsPage?: boolean;\n}\n\nconst mainNav: NavItem[] = [\n  { href: \"/overview\", label: \"Visión General\", icon: <Home /> },\n  { href: \"/rooms\", label: \"Habitaciones\", icon: <DoorOpen />, isDetailsPage: true },\n  { href: \"/recruitment\", label: \"Reclutamiento\", icon: <Users />, isDetailsPage: true },\n  { href: \"/training\", label: \"Entrenamiento\", icon: <Target /> },\n  { href: \"/security\", label: \"Seguridad\", icon: <Shield /> },\n  { href: \"/missions/new\", label: \"Misiones\", icon: <ClipboardList /> },\n];\n\nconst secondaryNav: NavItem[] = [\n    { href: \"/vision/global\", label: \"Visión Global\", icon: <Globe /> },\n    { href: \"/buildings\", label: \"Edificios\", icon: <Building2 /> },\n    { href: \"/technologies\", label: \"Tecnologías\", icon: <FlaskConical /> },\n    { href: \"/family\", label: \"Familia\", icon: <Users2 /> },\n    { href: \"/resources\", label: \"Recursos\", icon: <Package /> },\n    { href: \"/map\", label: \"Mapa\", icon: <Map /> },\n    { href: \"/simulator\", label: \"Simulador\", icon: <Calculator /> },\n    { href: \"/brawls\", label: \"Batallas\", icon: <Swords /> },\n];\n\nconst tertiaryNav: NavItem[] = [\n    { href: \"/messages\", label: \"Notificaciones\", icon: <Mail /> },\n    { href: \"/statistics\", label: \"Estadísticas\", icon: <BarChart /> },\n    { href: \"/rankings\", label: \"Clasificaciones\", icon: <Trophy /> },\n    { href: \"/settings\", label: \"Ajustes\", icon: <Settings /> },\n    { href: \"/search\", label: \"Buscar\", icon: <Search /> },\n];\n\nfunction UserMenu() {\n    const user = useAtomValue(userProfileAtom);\n    if (!user) return null;\n\n    return (\n        <footer className=\"sidebar-footer\">\n            <div className=\"user-info\">\n                <Avatar className=\"user-avatar\">\n                    <AvatarImage src={user.avatarUrl || ''} alt={user.name} />\n                    <AvatarFallback>{user.name?.charAt(0).toUpperCase()}</AvatarFallback>\n                </Avatar>\n                <span className=\"user-name\">{user.name}</span>\n                 <form action={logout} className=\"logout-form\">\n                    <Button type=\"submit\" variant=\"ghost\" size=\"icon\" className=\"logout-button\">\n                        <LogOut />\n                        <span className=\"logout-text\">Salir</span>\n                    </Button>\n                </form>\n            </div>\n        </footer>\n    )\n}\n\nfunction MobileUserMenu() {\n    const user = useAtomValue(userProfileAtom);\n    if (!user) return null;\n\n    return (\n        <div className=\"mt-auto p-4 border-t border-border\">\n            <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                    <Avatar>\n                        <AvatarImage src={user.avatarUrl || ''} alt={user.name} />\n                        <AvatarFallback>{user.name?.charAt(0).toUpperCase()}</AvatarFallback>\n                    </Avatar>\n                    <span className=\"font-semibold\">{user.name}</span>\n                </div>\n                <form action={logout}>\n                    <Button type=\"submit\" variant=\"ghost\" size=\"icon\">\n                        <LogOut />\n                        <span className=\"sr-only\">Cerrar sesión</span>\n                    </Button>\n                </form>\n            </div>\n        </div>\n    );\n}\n\nexport const SidebarNav = () => {\n    const pathname = usePathname();\n    const user = useAtomValue(userProfileAtom);\n    const [isOpen, setIsOpen] = useState(false);\n    const searchParams = useSearchParams();\n    const propertyId = searchParams.get('propertyId');\n\n    const toggleMenu = () => setIsOpen(!isOpen);\n\n    const generateHref = (baseHref: string, isDetailsPage?: boolean) => {\n        const targetPath = isDetailsPage ? `${baseHref}/details` : baseHref;\n        if (propertyId) {\n            return `${targetPath}?propertyId=${propertyId}`;\n        }\n        // Fallback if no propertyId is present\n        const firstPropertyId = user?.propiedades?.[0]?.id;\n        if (firstPropertyId) {\n            return `${targetPath}?propertyId=${firstPropertyId}`;\n        }\n        return targetPath;\n    };\n\n    const renderDesktopGroup = (items: NavItem[], title: string) => (\n        <div className=\"sidebar-group\">\n            {title && <div className=\"sidebar-group-label\">{title}</div>}\n            {items.map(item => (\n              <Link key={item.href} href={generateHref(item.href, item.isDetailsPage)} passHref>\n                <button\n                    className={`nav-item ${pathname.startsWith(item.href) ? 'active' : ''}`}\n                    title={item.label}\n                >\n                    {item.icon}\n                    <span className=\"nav-label\">{item.label}</span>\n                </button>\n              </Link>\n            ))}\n        </div>\n    );\n\n    const renderMobileGroup = (items: NavItem[], title: string) => (\n        <div className=\"mobile-group\">\n             <div className=\"mobile-group-label\">{title}</div>\n             {items.map(item => (\n                <Link key={item.href} href={generateHref(item.href, item.isDetailsPage)} passHref>\n                    <button\n                        className={`mobile-nav-item ${pathname.startsWith(item.href) ? 'active' : ''}`}\n                        onClick={() => setIsOpen(false)}\n                    >\n                        {item.icon}\n                        <span>{item.label}</span>\n                    </button>\n                </Link>\n             ))}\n        </div>\n    );\n    \n    if (!user) return null;\n\n    return (\n        <>\n            {/* Desktop Sidebar (Left) */}\n            <nav className=\"sidebar desktop-sidebar\">\n                <header className=\"sidebar-header\">\n                    <div className=\"sidebar-logo\">\n                        <Image src=\"/icons/sidebarcontraido.svg\" alt=\"Vendetta Logo\" width={32} height={32} />\n                    </div>\n                    <div className=\"sidebar-title\">\n                        <span className=\"text-primary\">VENDETTA</span>\n                        <span className=\"text-foreground\">GAMES</span>\n                    </div>\n                </header>\n                <div className=\"sidebar-scroll-content\">\n                    <div className=\"sidebar-group\">\n                        <div className=\"sidebar-group-label\">Propiedad Activa</div>\n                        <PropertySelector properties={user.propiedades} />\n                    </div>\n                    {renderDesktopGroup(mainNav, \"Principal\")}\n                    {renderDesktopGroup(secondaryNav, \"Juego\")}\n                    {renderDesktopGroup(tertiaryNav, \"Comunidad\")}\n                </div>\n                <UserMenu />\n            </nav>\n\n            {/* Mobile Bottom Bar (Fixed) */}\n            <nav className=\"mobile-bottom-bar\">\n                <Link href=\"/overview\" className={`mobile-bottom-item ${pathname === '/overview' ? 'active' : ''}`}>\n                    <Home />\n                    <span>Inicio</span>\n                </Link>\n                <Link href={generateHref(\"/rooms\", true)} className={`mobile-bottom-item ${pathname.startsWith('/rooms') ? 'active' : ''}`}>\n                    <DoorOpen />\n                    <span>Hab.</span>\n                </Link>\n                 <Link href={generateHref(\"/training\")} className={`mobile-bottom-item ${pathname.startsWith('/training') ? 'active' : ''}`}>\n                    <Target />\n                    <span>Entrenar</span>\n                </Link>\n                <Sheet>\n                    <SheetTrigger asChild>\n                        <button className=\"mobile-bottom-item\">\n                            <Building />\n                            <span>Propiedad</span>\n                        </button>\n                    </SheetTrigger>\n                    <SheetContent side=\"bottom\" className=\"rounded-t-lg p-0\">\n                         <div className=\"p-6 pb-4\">\n                             <SheetHeader>\n                                <SheetTitle>Cambiar Propiedad</SheetTitle>\n                            </SheetHeader>\n                         </div>\n                        <div className=\"p-6 pt-0 pb-20\">\n                            <PropertySelector properties={user.propiedades} />\n                        </div>\n                    </SheetContent>\n                </Sheet>\n                <button className=\"mobile-bottom-item menu-trigger\" onClick={toggleMenu}>\n                    <Menu />\n                    <span>Menú</span>\n                </button>\n            </nav>\n\n            {/* Mobile Side Drawer (Slide-in) */}\n            <div className={`mobile-menu-overlay ${isOpen ? 'open' : ''}`} onClick={() => setIsOpen(false)}>\n                <div className={`mobile-menu-content ${isOpen ? 'open' : ''}`} onClick={e => e.stopPropagation()}>\n                    <div className=\"mobile-menu-header\">\n                        <h3>Menu Principal</h3>\n                        <button onClick={() => setIsOpen(false)} className=\"close-menu-btn\">\n                            <X />\n                        </button>\n                    </div>\n                    <div className=\"mobile-menu-scroll\">\n                        <div className=\"p-2\">\n                             <PropertySelector properties={user.propiedades} />\n                        </div>\n                        {renderMobileGroup(mainNav, \"Principal\")}\n                        <div className=\"menu-divider\"></div>\n                        {renderMobileGroup(secondaryNav, \"Juego\")}\n                        <div className=\"menu-divider\"></div>\n                        {renderMobileGroup(tertiaryNav, \"Comunidad\")}\n                    </div>\n                    <MobileUserMenu />\n                </div>\n            </div>\n        </>\n    );\n};\n",
    "src/components/dashboard/live-clock.tsx": "\n\"use client\"\n\nimport { useState, useEffect } from 'react';\nimport { Clock } from 'lucide-react';\n\nexport function LiveClock() {\n    const [currentTime, setCurrentTime] = useState('');\n\n    useEffect(() => {\n        const timer = setInterval(() => {\n            const now = new Date();\n            const timeZone = 'Africa/Nouakchott';\n            const date = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', timeZone });\n            const time = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone, hour12: false });\n            setCurrentTime(`${date}, ${time}`);\n        }, 1000);\n\n        return () => clearInterval(timer);\n    }, []);\n\n    if (!currentTime) {\n        return null;\n    }\n\n    return (\n        <div className=\"hidden items-center gap-2 rounded-md bg-black/50 px-3 py-1 text-sm font-medium text-white lg:flex\">\n            <Clock className=\"h-4 w-4 text-primary\" />\n            <span className=\"tabular-nums\">{currentTime}</span>\n        </div>\n    );\n}\n",
    "src/components/dashboard/training-view.tsx": "'use client'\n\nimport {\n  Card,\n  CardContent,\n} from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { BrainCircuit, Hourglass, Ban, Loader2, Terminal } from \"lucide-react\"\nimport { iniciarEntrenamiento } from \"@/lib/actions/training.actions\"\nimport type { FullConfiguracionEntrenamiento, UserWithProgress } from \"@/types\"\nimport { useProperty } from \"@/contexts/property-context\"\nimport { useEffect, useState, useTransition } from \"react\"\nimport { useToast } from \"@/hooks/use-toast\"\nimport { GameCard } from \"@/components/ui/game-card\"\nimport { formatDuration } from \"@/lib/utils\"\nimport { useRouter } from \"next/navigation\"\nimport { QueueCard } from \"./queue-card\"\n\nfunction TrainingForm({ \n    training,\n    propertyId,\n    meetsRequirements,\n    isTrainingInQueue,\n    isPropertyBusy,\n    onTrain\n}: { \n    training: TrainingData,\n    propertyId: string,\n    meetsRequirements: boolean,\n    isTrainingInQueue: boolean,\n    isPropertyBusy: boolean,\n    onTrain: (trainingId: string, propertyId: string) => void\n}) {\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n\n    const handleAction = async () => {\n        startTransition(async () => {\n            await onTrain(training.id, propertyId);\n        });\n    }\n    \n    const isDisabled = isPending || !meetsRequirements || isTrainingInQueue || isPropertyBusy;\n\n    return (\n        <form action={handleAction} className=\"w-full\">\n            <Button\n                type=\"submit\"\n                variant={!isDisabled ? \"default\" : \"secondary\"}\n                size=\"sm\"\n                className=\"w-full font-bold tracking-wide\"\n                disabled={isDisabled}\n            >\n                {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/>}\n                {!isPending && (isTrainingInQueue ? <Hourglass className=\"mr-2 h-4 w-4\" /> : isPropertyBusy ? <Ban className=\"mr-2 h-4 w-4\"/> : <BrainCircuit className=\"mr-2 h-4 w-4\" />)}\n                {isPending ? 'ENVIANDO...' : isTrainingInQueue ? 'EN COLA' : isPropertyBusy ? 'OCUPADO' : 'ENTRENAR'}\n            </Button>\n        </form>\n    )\n}\n\ntype TrainingData = FullConfiguracionEntrenamiento & {\n    nivel: number;\n    costos: {\n        armas: number;\n        municion: number;\n        dolares: number;\n    };\n    tiempo: number;\n    meetsRequirements: boolean;\n    requirementsText: string | null;\n    descripcion?: string;\n}\n\ninterface TrainingViewProps {\n    user: UserWithProgress;\n    trainingsData: TrainingData[];\n}\n\nexport function TrainingView({ user, trainingsData }: TrainingViewProps) {\n  const { selectedProperty } = useProperty();\n  const router = useRouter();\n  const { toast } = useToast();\n\n  const handleTrain = async (trainingId: string, propertyId: string) => {\n    const result = await iniciarEntrenamiento(trainingId, propertyId);\n    if (result.error) {\n        toast({ variant: 'destructive', title: 'Error', description: result.error });\n    } else if (result.success) {\n        toast({ title: 'Éxito', description: result.success });\n        router.refresh();\n    }\n  }\n\n  if (!selectedProperty) {\n      return (\n        <div className=\"main-view\">\n          <h2 className=\"text-3xl font-bold font-heading tracking-tight mb-4\">Centro de Entrenamiento</h2>\n          <Card><CardContent className=\"p-6 text-muted-foreground\">Selecciona una propiedad para ver los entrenamientos.</CardContent></Card>\n        </div>\n      )\n  }\n\n  const isPropertyBusy = user.colaEntrenamientos.some(c => c.propiedadId === selectedProperty.id);\n  \n  // 🟢 CORRECCIÓN: Enriquece los datos con las coordenadas para el componente QueueCard.\n  const activeTrainings = user.colaEntrenamientos.map(t => {\n      const prop = user.propiedades.find(p => p.id === t.propiedadId);\n      return {\n        ...t,\n        coords: prop ? `${prop.ciudad}:${prop.barrio}:${prop.edificio}` : '???'\n      };\n  });\n\n  return (\n    <div className=\"space-y-6 pb-20\">\n       <div className=\"flex flex-col md:flex-row md:items-end justify-between gap-4\">\n            <div>\n                <h2 className=\"text-3xl font-bold font-heading tracking-tight text-foreground\">Centro de Entrenamiento</h2>\n                <p className=\"text-muted-foreground\">\n                    Mejora las capacidades de tu organización en <span className=\"font-semibold text-gold\">{selectedProperty.nombre}</span> <span className=\"font-mono text-sm font-semibold text-primary/80\">[{selectedProperty.ciudad}:{selectedProperty.barrio}:{selectedProperty.edificio}]</span>.\n                </p>\n            </div>\n       </div>\n\n        <QueueCard queueType=\"training\" activeTrainings={activeTrainings} />\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n            {trainingsData.map((training) => {\n                if(training.nivel === 0 && !training.meetsRequirements) {\n                    // Keeping original logic of potentially hiding or just showing as locked\n                    // For now, render them as locked if they exist in the list\n                }\n\n                const isTrainingInQueue = user.colaEntrenamientos.some(c => c.entrenamientoId === training.id);\n\n                return (\n                    <GameCard\n                        key={training.id}\n                        title={training.nombre}\n                        imageSrc={training.urlImagen || \"/img/general/training-default.jpg\"}\n                        level={training.nivel}\n                        description={training.descripcion || \"Entrenamiento avanzado para mejorar las capacidades de tus tropas.\"}\n                        status={isTrainingInQueue ? \"in_progress\" : (!training.meetsRequirements ? \"locked\" : \"available\")}\n                        cost={{\n                            armas: training.costos.armas,\n                            municion: training.costos.municion,\n                            dolares: training.costos.dolares\n                        }}\n                        time={training.tiempo}\n                        requirementsText={(!training.meetsRequirements && training.requirementsText) ? training.requirementsText : undefined}\n                        actionButton={\n                            <TrainingForm \n                                training={training}\n                                propertyId={selectedProperty.id}\n                                meetsRequirements={training.meetsRequirements}\n                                isTrainingInQueue={isTrainingInQueue}\n                                isPropertyBusy={isPropertyBusy}\n                                onTrain={handleTrain}\n                            />\n                        }\n                    />\n                )\n            })}\n        </div>\n    </div>\n  )\n}\n",
    "src/components/dashboard/live-resource-counter.tsx": "\n'use client'\n\nimport { useEffect, useState } from \"react\";\nimport { motion, useSpring, useTransform } from \"framer-motion\";\n\nexport function LiveResourceCounter({ value }: { value: number }) {\n    const spring = useSpring(value, { stiffness: 100, damping: 20 });\n    const displayValue = useTransform(spring, (current) => Math.floor(current).toLocaleString('de-DE'));\n\n    useEffect(() => {\n        spring.set(value);\n    }, [value, spring]);\n\n    return <motion.span>{displayValue}</motion.span>;\n}\n",
    "src/components/dashboard/statistics/statistics-view.tsx": "'use client';\n\nimport { Bar, BarChart, CartesianGrid, ResponsiveContainer, Tooltip, XAxis, YAxis } from \"recharts\";\nimport type { ConfiguracionHabitacion, ConfiguracionTropa, ConfiguracionEntrenamiento, HabitacionUsuario, EntrenamientoUsuario, UserWithProgress } from \"@/types\";\nimport { StatTableCard } from \"./stat-table-card\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\ninterface TroopStat {\n    configuracionTropaId: string;\n    maxAmount: number;\n}\n\ninterface ResourceStat {\n    name: string;\n    maxValue: number;\n}\n\ninterface StatisticsViewProps {\n    currentUser: UserWithProgress;\n    allRoomConfigs: ConfiguracionHabitacion[];\n    allTrainingConfigs: ConfiguracionEntrenamiento[];\n    allTroopConfigs: ConfiguracionTropa[];\n    roomStats: { configuracionHabitacionId: string; nivel: number; }[];\n    trainingStats: { configuracionEntrenamientoId: string; nivel: number; }[];\n    troopStats: TroopStat[];\n    resourceStats: ResourceStat[];\n}\n\nexport function StatisticsView({\n    currentUser,\n    allRoomConfigs,\n    allTrainingConfigs,\n    allTroopConfigs,\n    roomStats,\n    trainingStats,\n    troopStats,\n    resourceStats\n}: StatisticsViewProps) {\n\n    // Process room stats\n    const maxRoomLevels = new Map<string, number>();\n    roomStats.forEach(stat => {\n        const currentMax = maxRoomLevels.get(stat.configuracionHabitacionId) || 0;\n        if (stat.nivel > currentMax) {\n            maxRoomLevels.set(stat.configuracionHabitacionId, stat.nivel);\n        }\n    });\n\n    const currentUserRoomLevels = new Map<string, number>();\n    currentUser.propiedades.forEach(p => {\n        p.habitaciones.forEach(h => {\n            const currentLevel = currentUserRoomLevels.get(h.configuracionHabitacionId) || 0;\n            if (h.nivel > currentLevel) {\n                 currentUserRoomLevels.set(h.configuracionHabitacionId, h.nivel);\n            }\n        });\n    });\n\n    const roomStatData = allRoomConfigs.map(config => ([\n        config.nombre,\n        currentUserRoomLevels.get(config.id) || 0,\n        maxRoomLevels.get(config.id) || 0,\n    ]));\n\n    // Process training stats\n    const maxTrainingLevels = new Map<string, number>();\n    trainingStats.forEach(stat => {\n        const currentMax = maxTrainingLevels.get(stat.configuracionEntrenamientoId) || 0;\n        if (stat.nivel > currentMax) {\n            maxTrainingLevels.set(stat.configuracionEntrenamientoId, stat.nivel);\n        }\n    });\n    const currentUserTrainingLevels = new Map(currentUser.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel]));\n    \n    const trainingStatData = allTrainingConfigs.map(config => ([\n        config.nombre,\n        currentUserTrainingLevels.get(config.id) || 0,\n        maxTrainingLevels.get(config.id) || 0,\n    ]));\n\n    // Process troop stats\n    const maxTroopCounts = new Map<string, number>();\n    troopStats.forEach(stat => {\n        maxTroopCounts.set(stat.configuracionTropaId, stat.maxAmount);\n    });\n\n    const currentUserTroopCounts = new Map<string, number>();\n    // Calculate current user total troops from currentUser prop instead of global list\n    currentUser.propiedades.forEach(propiedad => {\n        // Access TropaUsuario array if it exists\n        if (propiedad.TropaUsuario && Array.isArray(propiedad.TropaUsuario)) {\n            propiedad.TropaUsuario.forEach(tropa => {\n                const currentTotal = currentUserTroopCounts.get(tropa.configuracionTropaId) || 0;\n                currentUserTroopCounts.set(tropa.configuracionTropaId, currentTotal + tropa.cantidad);\n            });\n        }\n    });\n\n    const troopStatData = allTroopConfigs.map(config => ([\n        config.nombre,\n        currentUserTroopCounts.get(config.id) || 0,\n        maxTroopCounts.get(config.id) || 0,\n    ]));\n\n    const chartData = resourceStats.map(stat => ({\n        name: stat.name,\n        Capacidad: stat.maxValue,\n    }));\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Estadísticas Globales</h2>\n                    <p className=\"text-muted-foreground\">\n                        Compara tu progreso con los mejores jugadores del servidor.\n                    </p>\n                </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                 <Card>\n                    <CardHeader>\n                         <CardTitle className=\"font-heading text-xl tracking-wider text-primary\">CAPACIDAD MÁXIMA DE ALMACENAMIENTO</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                        <ResponsiveContainer width=\"100%\" height={300}>\n                            <BarChart data={chartData}>\n                                <CartesianGrid strokeDasharray=\"3 3\" strokeOpacity={0.2} />\n                                <XAxis dataKey=\"name\" stroke=\"#888888\" fontSize={12} tickLine={false} axisLine={false} />\n                                <YAxis stroke=\"#888888\" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `${Number(value) / 1000}K`} />\n                                <Tooltip\n                                    contentStyle={{\n                                        background: \"hsl(var(--background))\",\n                                        borderColor: \"hsl(var(--border))\",\n                                        color: \"hsl(var(--foreground))\"\n                                    }}\n                                />\n                                <Bar dataKey=\"Capacidad\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                            </BarChart>\n                        </ResponsiveContainer>\n                    </CardContent>\n                </Card>\n                <StatTableCard title=\"ESTADÍSTICAS DE HABITACIONES\" headers={['Habitación', 'Mi Nivel', 'Nivel Máximo']} data={roomStatData} hasProgress />\n                <StatTableCard title=\"ESTADÍSTICAS DE ENTRENAMIENTOS\" headers={['Entrenamiento', 'Mi Nivel', 'Nivel Máximo']} data={trainingStatData} hasProgress />\n                <StatTableCard title=\"ESTADÍSTICAS DE TROPAS\" headers={['Tropa', 'Mis Unidades', 'Unidades Máximas']} data={troopStatData} hasProgress />\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/statistics/stat-category-card.tsx": "\n\n'use client';\n\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Trophy } from \"lucide-react\";\n\nexport interface StatItem {\n    id: string;\n    name: string;\n    userValue: number;\n    maxValue: number;\n}\n\ninterface StatCategoryCardProps {\n    title: string;\n    items: StatItem[];\n}\n\nfunction formatNumber(num: number): string {\n    return num.toLocaleString('de-DE');\n}\n\nexport function StatCategoryCard({ title, items }: StatCategoryCardProps) {\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle>{title}</CardTitle>\n            </CardHeader>\n            <CardContent>\n                <ScrollArea className=\"h-96\">\n                    <div className=\"space-y-6 pr-4\">\n                        {items.map(item => {\n                            const progressPercentage = item.maxValue > 0 ? (item.userValue / item.maxValue) * 100 : 0;\n                            const isServerRecord = item.userValue > 0 && item.userValue === item.maxValue;\n                            return (\n                                <div key={item.id} className=\"space-y-1\">\n                                    <div className=\"flex justify-between items-baseline text-sm\">\n                                        <div className=\"flex items-center gap-2\">\n                                            {isServerRecord && (\n                                                <TooltipProvider>\n                                                    <Tooltip>\n                                                        <TooltipTrigger>\n                                                            <Trophy className=\"h-4 w-4 text-amber-400 animate-pulse\" />\n                                                        </TooltipTrigger>\n                                                        <TooltipContent>\n                                                            <p>Récord del Servidor</p>\n                                                        </TooltipContent>\n                                                    </Tooltip>\n                                                </TooltipProvider>\n                                            )}\n                                            <span className=\"font-medium truncate pr-2\">{item.name}</span>\n                                        </div>\n                                        <div className=\"flex items-baseline gap-2\">\n                                            <span className=\"font-bold text-primary\">{formatNumber(item.userValue)}</span>\n                                            <span className=\"text-xs text-muted-foreground\">/ {formatNumber(item.maxValue)}</span>\n                                        </div>\n                                    </div>\n                                    <Progress value={progressPercentage} className=\"h-2\" />\n                                </div>\n                            )\n                        })}\n                    </div>\n                </ScrollArea>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/statistics/stat-table-card.tsx": "\n'use client';\n\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { cn } from \"@/lib/utils\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\ninterface StatTableCardProps {\n    title: string;\n    headers: string[];\n    data: (string | number)[][];\n    hasProgress?: boolean;\n}\n\nfunction formatNumber(value: string | number) {\n    if (typeof value === 'number') {\n        return value.toLocaleString('de-DE');\n    }\n    return value;\n}\n\nexport function StatTableCard({ title, headers, data, hasProgress = false }: StatTableCardProps) {\n    const isMobile = useIsMobile();\n    \n    const finalHeaders = hasProgress && !isMobile ? [...headers, 'Progreso'] : headers;\n\n    return (\n        <Card className=\"overflow-hidden\">\n            <div className=\"bg-primary text-primary-foreground p-4\">\n                <h3 className=\"font-heading text-xl tracking-wider\">{title}</h3>\n            </div>\n            <div className=\"bg-card\">\n                 <Table>\n                    <TableHeader>\n                        <TableRow className=\"border-b-white/10 hover:bg-white/5\">\n                            {finalHeaders.map((header, index) => (\n                                <TableHead \n                                    key={index} \n                                    className={cn(\n                                        \"font-bold text-white/90\", \n                                        index > 0 && \"text-right\",\n                                        isMobile && header === 'Nivel Máximo' && \"hidden\" // Ocultar en móvil\n                                    )}\n                                >\n                                    {header}\n                                </TableHead>\n                            ))}\n                        </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                        {data.map((row, rowIndex) => {\n                             const userValue = hasProgress ? (row[1] as number) : 0;\n                             const maxValue = hasProgress ? (row[2] as number) : 0;\n                             const progress = maxValue > 0 ? (userValue / maxValue) * 100 : 0;\n                             \n                             return (\n                                <TableRow key={rowIndex} className=\"border-b-white/10 hover:bg-white/5\">\n                                    {row.map((cell, cellIndex) => (\n                                        <TableCell \n                                            key={cellIndex} \n                                            className={cn(\n                                                cellIndex > 0 ? 'text-right' : 'font-medium',\n                                                isMobile && headers[cellIndex] === 'Nivel Máximo' && \"hidden\"\n                                            )}\n                                        >\n                                            {formatNumber(cell)}\n                                        </TableCell>\n                                    ))}\n                                    {hasProgress && !isMobile && (\n                                        <TableCell className=\"w-[150px]\">\n                                             <Progress value={progress} className=\"h-2\" indicatorClassName=\"bg-gradient-to-r from-green-400 to-cyan-400\" />\n                                        </TableCell>\n                                    )}\n                                </TableRow>\n                            )\n                        })}\n                    </TableBody>\n                </Table>\n            </div>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/missions-view.tsx": "'use client'\n\nimport { useState, useTransition, useCallback, useEffect, useMemo } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { getPropertyOwner } from '@/lib/data/property';\nimport type { UserWithProgress, FullConfiguracionTropa, FullTropaUsuario, PropertyWithOwner, FullPropiedad } from '@/types';\nimport { Loader2, User, UserX, Clock, Send, Users, Package, PlaneTakeoff, Minus, Plus, DollarSign, ClipboardList } from 'lucide-react';\nimport Image from 'next/image';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';\nimport { enviarMision } from '@/lib/actions/mission.actions';\nimport { useToast } from '@/hooks/use-toast';\nimport { calcularDistancia, calcularDuracionViaje, calcularVelocidadFlota, calcularCosteMision } from '@/lib/formulas/mission-formulas';\nimport { useRouter, useSearchParams } from 'next/navigation';\nimport { Slider } from '../ui/slider';\nimport { Separator } from '../ui/separator';\nimport { resourceIcons } from '@/lib/constants';\nimport Link from 'next/link';\n\ninterface TroopInput {\n    id: string;\n    cantidad: number;\n}\n\n\nfunction formatDuration(seconds: number): string {\n    if (seconds <= 0) return \"0s\";\n\n    const units: {name: string, seconds: number}[] = [\n        { name: 'd', seconds: 86400 },\n        { name: 'h', seconds: 3600 },\n        { name: 'm', seconds: 60 },\n        { name: 's', seconds: 1 }\n    ];\n\n    let remainingSeconds = seconds;\n    let result = '';\n    \n    if (remainingSeconds === 0) return '0s';\n\n    for (const unit of units) {\n        if (remainingSeconds >= unit.seconds) {\n            const amount = Math.floor(remainingSeconds / unit.seconds);\n            result += `${amount}${unit.name} `;\n            remainingSeconds %= unit.seconds;\n        }\n    }\n\n    return result.trim() || \"< 1m\";\n}\n\nfunction formatNumber(num: number): string {\n    if (num === null || num === undefined) return \"0\";\n    return num.toLocaleString('de-DE');\n}\n\ninterface MissionsViewProps {\n    user: UserWithProgress;\n    troopConfigs: FullConfiguracionTropa[];\n    initialTargetOwner?: PropertyWithOwner['user'] | null | undefined;\n    selectedProperty: FullPropiedad;\n}\n\nexport function MissionsView({ user, troopConfigs, initialTargetOwner, selectedProperty }: MissionsViewProps) {\n    const { toast } = useToast();\n    const router = useRouter();\n    const searchParams = useSearchParams();\n    const [isPending, startTransition] = useTransition();\n    const [isSuccess, setIsSuccess] = useState(false);\n    \n    const [coordinates, setCoordinates] = useState({ \n        ciudad: searchParams.get('ciudad') || selectedProperty?.ciudad.toString() || '', \n        barrio: searchParams.get('barrio') || selectedProperty?.barrio.toString() || '', \n        edificio: searchParams.get('edificio') || '' \n    });\n\n    const [targetOwner, setTargetOwner] = useState(initialTargetOwner);\n    const [isLoadingTarget, setIsLoadingTarget] = useState(false);\n    const [missionType, setMissionType] = useState('ATAQUE');\n    const [tropas, setTropas] = useState<TroopInput[]>([]);\n    const [travelTime, setTravelTime] = useState<number>(0);\n    const [travelCost, setTravelCost] = useState<number>(0);\n\n    \n    const troopConfigsMap = useMemo(() => new Map(troopConfigs.map(t => [t.id, t])), [troopConfigs]);\n\n    useEffect(() => {\n        const ciudad = searchParams.get('ciudad');\n        const barrio = searchParams.get('barrio');\n        const edificio = searchParams.get('edificio');\n\n        const newCoords = {\n            ciudad: ciudad || selectedProperty?.ciudad.toString() || '',\n            barrio: barrio || selectedProperty?.barrio.toString() || '',\n            edificio: edificio || ''\n        }\n        setCoordinates(newCoords);\n        setTargetOwner(initialTargetOwner);\n    }, [searchParams, selectedProperty, initialTargetOwner]);\n\n    const calculateTravelInfo = useCallback(() => {\n        if (!selectedProperty || tropas.length === 0 || !coordinates.ciudad || !coordinates.barrio || !coordinates.edificio) {\n            setTravelTime(0);\n            setTravelCost(0);\n            return;\n        }\n\n        const activeTroops = tropas.filter(t => t.cantidad > 0);\n        if(activeTroops.length === 0) {\n            setTravelTime(0);\n            setTravelCost(0);\n            return;\n        }\n\n        // Get Troop objects with speed for speed calculation\n        const troopsForSpeed = activeTroops.map(t => {\n            const config = troopConfigsMap.get(t.id);\n            return { velocidad: Number(config?.velocidad || 0) };\n        });\n        const velocidad = calcularVelocidadFlota(troopsForSpeed);\n\n        // Coordinates should be raw numbers for calculations\n        const origenCoords = {\n            ciudad: selectedProperty.ciudad,\n            barrio: selectedProperty.barrio,\n            edificio: selectedProperty.edificio\n        };\n        const destinoCoords = {\n            ciudad: parseInt(coordinates.ciudad, 10),\n            barrio: parseInt(coordinates.barrio, 10),\n            edificio: parseInt(coordinates.edificio, 10),\n        };\n        const distancia = calcularDistancia(origenCoords, destinoCoords);\n        const duracion = calcularDuracionViaje(distancia, velocidad);\n\n        const tropasConSalario = activeTroops.map((t: TroopInput) => {\n            const config = troopConfigsMap.get(t.id);\n            return {\n                cantidad: t.cantidad,\n                salario: config?.salario || 0\n            };\n        });\n        const coste = calcularCosteMision(distancia, tropasConSalario);\n        \n        setTravelTime(duracion);\n        setTravelCost(coste);\n    }, [tropas, coordinates, selectedProperty, troopConfigsMap]);\n\n    \n    useEffect(() => {\n        calculateTravelInfo();\n    }, [tropas, coordinates, selectedProperty, calculateTravelInfo]);\n    \n\n    const handleCoordinateChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const { name, value } = e.target;\n        const newCoords = { ...coordinates, [name]: value };\n        setCoordinates(newCoords);\n    };\n    \n     const troopsOnMission = useMemo(() => {\n        if (!selectedProperty) return new Map<string, number>();\n        const onMission = new Map<string, number>();\n        user.misiones.filter(m => m.propiedadOrigenId === selectedProperty.id).forEach(m => {\n            if (Array.isArray(m.tropas)) {\n                (m.tropas as ({id: string, cantidad: number} | null)[])\n                    .filter((t): t is {id: string, cantidad: number} => !!t) // Filter out nulls\n                    .forEach(t => {\n                        onMission.set(t.id, (onMission.get(t.id) || 0) + t.cantidad);\n                    });\n            }\n        });\n        return onMission;\n    }, [user.misiones, selectedProperty]);\n\n    const handleTroopChange = (troopId: string, cantidad: number) => {\n        const totalInProperty = selectedProperty?.TropaUsuario.find((t: FullTropaUsuario) => t.configuracionTropa.id === troopId)?.cantidad || 0;\n        const onMissionCount = troopsOnMission.get(troopId) || 0;\n        const tropaMax = totalInProperty - onMissionCount;\n        const safeCantidad = Math.max(0, Math.min(tropaMax, cantidad));\n\n        setTropas(prev => {\n            const existing = prev.find(t => t.id === troopId);\n            if (existing) {\n                if (safeCantidad > 0) {\n                    return prev.map(t => t.id === troopId ? { ...t, cantidad: safeCantidad } : t);\n                } else {\n                    return prev.filter(t => t.id !== troopId);\n                }\n            } else if (safeCantidad > 0) {\n                return [...prev, { id: troopId, cantidad: safeCantidad }];\n            }\n            return prev;\n        })\n    }\n\n    const setMaxTroops = (troopId: string) => {\n        const totalInProperty = selectedProperty?.TropaUsuario.find((tropa: FullTropaUsuario) => tropa.configuracionTropa.id === troopId)?.cantidad || 0;\n        const onMissionCount = troopsOnMission.get(troopId) || 0;\n        const available = totalInProperty - onMissionCount;\n        handleTroopChange(troopId, available);\n    };\n\n    const setAllMaxTroops = () => {\n        if (!selectedProperty) return;\n        const newTroopInputs = selectedProperty.TropaUsuario\n            .filter((tropa: FullTropaUsuario) => tropa.configuracionTropa.tipo !== 'DEFENSA')\n            .map((tropa: FullTropaUsuario) => {\n                const onMissionCount = troopsOnMission.get(tropa.configuracionTropaId) || 0;\n                return {\n                    id: tropa.configuracionTropa.id,\n                    cantidad: tropa.cantidad - onMissionCount,\n                }\n            });\n        setTropas(newTroopInputs);\n    };\n    \n     const { totalCapacity, totalSalary } = useMemo(() => {\n        return tropas.reduce((acc, t: TroopInput) => {\n            const config = troopConfigsMap.get(t.id);\n            if (config) {\n                acc.totalCapacity += config.capacidad * t.cantidad;\n                acc.totalSalary += config.salario * t.cantidad;\n            }\n            return acc;\n        }, { totalCapacity: 0, totalSalary: 0 });\n    }, [tropas, troopConfigsMap]);\n\n    const handleSubmit = async () => {\n        if (!selectedProperty) {\n            toast({ variant: 'destructive', title: 'Error', description: 'No hay una propiedad de origen seleccionada.' });\n            return;\n        }\n\n        startTransition(async () => {\n            const result = await enviarMision({\n                origenPropiedadId: selectedProperty.id,\n                coordinates: {\n                    ciudad: parseInt(coordinates.ciudad, 10),\n                    barrio: parseInt(coordinates.barrio, 10),\n                    edificio: parseInt(coordinates.edificio, 10)\n                },\n                tropas: tropas.filter(t => t.cantidad > 0),\n                tipo: missionType\n            });\n\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error en la misión', description: result.error });\n            } else {\n                toast({ title: '¡Misión enviada!', description: result.success });\n                setIsSuccess(true);\n                setTimeout(() => {\n                    setTropas([]);\n                    setIsSuccess(false);\n                }, 1500)\n            }\n        });\n    }\n\n    if (!selectedProperty) {\n        return <p>Selecciona una propiedad para enviar misiones.</p>\n    }\n\n    const desiredOrder = [\n        \"maton\", \"portero\", \"acuchillador\", \"pistolero\", \"ocupacion\", \"espia\", \"porteador\", \"cia\", \"fbi\",\n        \"transportista\", \"tactico\", \"francotirador\", \"asesino\", \"ninja\", \"demoliciones\", \"mercenario\"\n    ];\n\n    const availableTroops = selectedProperty.TropaUsuario\n        .filter((t: FullTropaUsuario) => {\n            const onMissionCount = troopsOnMission.get(t.configuracionTropaId) || 0;\n            return (t.cantidad - onMissionCount > 0) && t.configuracionTropa.tipo !== 'DEFENSA';\n        })\n        .sort((a: FullTropaUsuario, b: FullTropaUsuario) => {\n            const indexA = desiredOrder.indexOf(a.configuracionTropa.id);\n            const indexB = desiredOrder.indexOf(b.configuracionTropa.id);\n            if (indexA === -1) return 1;\n            if (indexB === -1) return -1;\n            return indexA - indexB;\n        });\n\n    return (\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4\">\n            <div className=\"space-y-6\">\n                <Card>\n                    <CardHeader>\n                        <CardTitle>1. Configuración de la Misión</CardTitle>\n                        <CardDescription>Define el objetivo y el tipo de misión.</CardDescription>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                        <div className=\"grid grid-cols-3 gap-4\">\n                            <div className='space-y-2'>\n                                <Label htmlFor='ciudad'>Ciudad</Label>\n                                <Input id='ciudad' name='ciudad' placeholder='1' value={coordinates.ciudad} onChange={handleCoordinateChange} />\n                            </div>\n                            <div className='space-y-2'>\n                                <Label htmlFor='barrio'>Barrio</Label>\n                                <Input id='barrio' name='barrio' placeholder='1' value={coordinates.barrio} onChange={handleCoordinateChange} />\n                            </div>\n                            <div className='space-y-2'>\n                                <Label htmlFor='edificio'>Edificio</Label>\n                                <Input id='edificio' name='edificio' placeholder='1' value={coordinates.edificio} onChange={handleCoordinateChange} />\n                            </div>\n                        </div>\n\n                        <Card className='p-4 bg-muted/50'>\n                            <div className='flex items-center gap-4'>\n                                {isLoadingTarget ? (\n                                    <Loader2 className=\"h-6 w-6 animate-spin\" />\n                                ) : targetOwner === undefined ? (\n                                     <UserX className=\"h-6 w-6 text-muted-foreground\" />\n                                ) : targetOwner === null ? (\n                                     <UserX className=\"h-6 w-6 text-green-500\" />\n                                ) : (\n                                    <User className=\"h-6 w-6 text-destructive\" />\n                                )}\n                                <div>\n                                    <p className='text-sm text-muted-foreground'>Objetivo</p>\n                                    <p className='font-bold'>\n                                        {isLoadingTarget ? 'Buscando...' : targetOwner?.name || 'Nadie'}\n                                    </p>\n                                </div>\n                            </div>\n                        </Card>\n                        \n                         <div className='space-y-2'>\n                            <Label htmlFor='missionType'>Tipo de Misión</Label>\n                            <Select onValueChange={setMissionType} defaultValue={missionType}>\n                                <SelectTrigger id='missionType'>\n                                    <SelectValue placeholder=\"Selecciona un tipo\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                    <SelectItem value=\"ATAQUE\">Ataque</SelectItem>\n                                    <SelectItem value=\"OCUPAR\">Ocupar</SelectItem>\n                                    <SelectItem value=\"DEFENDER\">Defender</SelectItem>\n                                    <SelectItem value=\"TRANSPORTE\">Transporte</SelectItem>\n                                    <SelectItem value=\"ESPIONAJE\">Espionaje</SelectItem>\n                                </SelectContent>\n                            </Select>\n                         </div>\n                    </CardContent>\n                </Card>\n            </div>\n\n            <div className=\"space-y-6\">\n                <Card>\n                    <CardHeader>\n                        <div className=\"flex justify-between items-center\">\n                            <div>\n                                <CardTitle>2. Selección de Tropas</CardTitle>\n                                <CardDescription>Elige las unidades de <span className=\"font-semibold text-gold\">{selectedProperty.nombre}</span> <span className=\"font-mono text-sm font-semibold text-primary/80\">[{selectedProperty.ciudad}:{selectedProperty.barrio}:{selectedProperty.edificio}]</span></CardDescription>\n                            </div>\n                            <Button variant=\"secondary\" size=\"sm\" onClick={setAllMaxTroops}><Users className=\"mr-2\"/>Todas</Button>\n                        </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2 max-h-96 overflow-y-auto pr-2\">\n                         {availableTroops && availableTroops.length > 0 ? availableTroops.map((tropa: FullTropaUsuario) => {\n                            const cantidadActual = tropas.find(t => t.id === tropa.configuracionTropaId)?.cantidad || 0;\n                            const onMissionCount = troopsOnMission.get(tropa.configuracionTropaId) || 0;\n                            const maxAvailable = tropa.cantidad - onMissionCount;\n                            return (\n                            <div key={tropa.configuracionTropaId} className='p-3 border rounded-lg space-y-3'>\n                                <div className='flex items-center gap-3 flex-1'>\n                                    <div className=\"w-12 h-10 relative rounded-md overflow-hidden border flex-shrink-0\">\n                                        <Image src={tropa.configuracionTropa.urlImagen} alt={tropa.configuracionTropa.nombre} fill sizes=\"48px\" className='object-contain' />\n                                    </div>\n                                    <div>\n                                        <p className='font-semibold'>{tropa.configuracionTropa.nombre}</p>\n                                        <p className='text-xs text-muted-foreground'>Disponibles: {maxAvailable}</p>\n                                    </div>\n                                </div>\n                                 <div className='flex items-center gap-2'>\n                                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={() => handleTroopChange(tropa.configuracionTropaId, cantidadActual - 1)}><Minus /></Button>\n                                    <Slider\n                                        value={[cantidadActual]}\n                                        onValueChange={(value) => handleTroopChange(tropa.configuracionTropaId, value[0])}\n                                        max={maxAvailable}\n                                        step={1}\n                                        className=\"flex-1\"\n                                    />\n                                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={() => handleTroopChange(tropa.configuracionTropaId, cantidadActual + 1)}><Plus/></Button>\n                                    <Input \n                                        type='number'\n                                        min=\"0\"\n                                        max={maxAvailable}\n                                        value={cantidadActual}\n                                        onChange={(e) => handleTroopChange(tropa.configuracionTropaId, parseInt(e.target.value) || 0)}\n                                        className='h-9 w-24 text-center'\n                                    />\n                                </div>\n                            </div>\n                        )}) : (\n                            <p className=\"text-sm text-center text-muted-foreground py-4\">No tienes tropas de ataque disponibles en esta propiedad.</p>\n                        )}\n                    </CardContent>\n                </Card>\n            </div>\n            <div className=\"lg:col-span-2\">\n                 <Card>\n                    <CardHeader>\n                        <CardTitle>3. Resumen de la Misión</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                         <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4 text-center\">\n                            <div className=\"p-3 bg-muted rounded-md\">\n                                <p className=\"text-sm text-muted-foreground\">Objetivo</p>\n                                <p className=\"font-bold\">{coordinates.ciudad}:{coordinates.barrio}:{coordinates.edificio}</p>\n                            </div>\n                            <div className=\"p-3 bg-muted rounded-md\">\n                                <p className=\"text-sm text-muted-foreground\">Tipo</p>\n                                <p className=\"font-bold\">{missionType}</p>\n                            </div>\n                            <div className=\"p-3 bg-muted rounded-md\">\n                                <p className=\"text-sm text-muted-foreground\">Tiempo de Viaje (ida)</p>\n                                <p className=\"font-bold flex items-center justify-center gap-2\"><Clock className=\"h-4 w-4\"/> {formatDuration(travelTime)}</p>\n                            </div>\n                            <div className=\"p-3 bg-muted rounded-md\">\n                                <p className=\"text-sm text-muted-foreground\">Capacidad de Carga</p>\n                                <p className=\"font-bold flex items-center justify-center gap-2\"><Package className=\"h-4 w-4\"/> {formatNumber(totalCapacity)}</p>\n                            </div>\n                             <div className=\"p-3 bg-muted rounded-md\">\n                                <p className=\"text-sm text-muted-foreground\">Coste de la Misión</p>\n                                <p className=\"font-bold flex items-center justify-center gap-2\"><DollarSign className=\"h-4 w-4 text-green-500\"/> {formatNumber(travelCost)}</p>\n                            </div>\n                         </div>\n                         <Separator />\n                        <Button onClick={handleSubmit} disabled={isPending || tropas.length === 0} className='w-full' size=\"lg\">\n                            {isPending ? <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" /> : (isSuccess ? <PlaneTakeoff className=\"mr-2 h-5 w-5\"/> : <Send className=\"mr-2 h-5 w-5\" />)}\n                            {isPending ? 'Enviando Flota...' : (isSuccess ? '¡Misión en Camino!' : 'Confirmar y Enviar Misión')}\n                        </Button>\n                    </CardContent>\n                </Card>\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/brawls/brawl-detail.tsx": "\n'use client';\n\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport type { BattleSimulationResult } from \"@/types/simulation.types\";\nimport type { FullBattleReport } from \"@/types\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { cn } from \"@/lib/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ArrowLeft, CheckCircle, XCircle } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\n\ninterface BrawlDetailProps {\n    report: FullBattleReport;\n    currentUserId: string;\n}\n\nfunction formatNumber(num: number): string {\n    if(num === undefined || num === null) return \"0\";\n    return Math.floor(num).toLocaleString('de-DE');\n}\n\nconst StatLossBar = ({ label, attackerValue, defenderValue }: { label: string, attackerValue: number, defenderValue: number}) => {\n    const total = attackerValue + defenderValue;\n    const attackerPercent = total > 0 ? (attackerValue / total) * 100 : 0;\n    const defenderPercent = total > 0 ? (defenderValue / total) * 100 : 0;\n    \n    return (\n        <div className=\"space-y-2\">\n            <div className=\"flex justify-between items-baseline text-sm\">\n                <span className=\"text-blue-400 font-semibold\">{formatNumber(attackerValue)}</span>\n                <span className=\"text-muted-foreground\">{label}</span>\n                <span className=\"text-red-400 font-semibold\">{formatNumber(defenderValue)}</span>\n            </div>\n            <div className=\"flex w-full h-3 rounded-full bg-muted overflow-hidden\">\n                <div style={{ width: `${attackerPercent}%`}} className=\"bg-blue-600/80 transition-all duration-500 ease-in-out\" />\n                <div style={{ width: `${defenderPercent}%`}} className=\"bg-red-800/80 transition-all duration-500 ease-in-out\" />\n            </div>\n        </div>\n    )\n}\n\nexport function BrawlDetail({ report, currentUserId }: BrawlDetailProps) {\n    const router = useRouter();\n    if (!report.details) return null;\n    \n    const details = report.details as unknown as BattleSimulationResult;\n\n    return (\n        <div className=\"w-full max-w-4xl mx-auto bg-black/80 border-primary border text-white font-mono flex flex-col h-full rounded-lg\">\n            <div className=\"p-6 pb-2 shrink-0 text-center\">\n                <h2 className=\"text-2xl text-primary tracking-widest font-heading\">\n                    INFORME DE BATALLA\n                </h2>\n                <p className=\"text-sm text-muted-foreground\">\n                    {new Date(report.created_at).toLocaleString('es-ES')}\n                </p>\n            </div>\n             <div className=\"flex flex-row items-center justify-around p-4 border-y border-dashed border-white/20 gap-4 shrink-0\">\n                <Link href={`/profile/${report.attacker.id}`} className={cn(\"flex flex-col items-center gap-2\", details.winner === 'attacker' && \"border-2 border-amber-400 p-2 rounded-lg\")}>\n                    <Avatar className=\"h-16 w-16 md:h-20 md:w-20\">\n                        <AvatarImage src={report.attacker.avatarUrl || ''} alt={report.attacker.name} />\n                        <AvatarFallback>{report.attacker.name.charAt(0)}</AvatarFallback>\n                    </Avatar>\n                    <span className=\"font-bold text-base md:text-lg\">{report.attacker.name}</span>\n                    <span className=\"text-xs text-red-400\">Pérdidas: {formatNumber(details.finalStats.attacker.troopsLost)}</span>\n                </Link>\n                <span className=\"text-3xl md:text-5xl font-black text-destructive\">VS</span>\n                <Link href={`/profile/${report.defender.id}`} className={cn(\"flex flex-col items-center gap-2\", details.winner === 'defender' && \"border-2 border-amber-400 p-2 rounded-lg\")}>\n                    <Avatar className=\"h-16 w-16 md:h-20 md:w-20\">\n                        <AvatarImage src={report.defender.avatarUrl || ''} alt={report.defender.name} />\n                        <AvatarFallback>{report.defender.name.charAt(0)}</AvatarFallback>\n                    </Avatar>\n                    <span className=\"font-bold text-base md:text-lg\">{report.defender.name}</span>\n                    <span className=\"text-xs text-red-400\">Pérdidas: {formatNumber(details.finalStats.defender.troopsLost)}</span>\n                </Link>\n            </div>\n            <ScrollArea className=\"flex-grow min-h-0\">\n                <div className=\"space-y-4 p-4\">\n                    <Card className={cn(\"p-4 text-center transition-all duration-300 ease-in-out\", \n                        details.winner === 'attacker' && \"bg-green-900/50 border-green-500/50\",\n                        details.winner === 'defender' && \"bg-red-900/50 border-red-500/50\",\n                        details.winner === 'draw' && \"bg-muted/50\"\n                    )}>\n                        <h3 className={cn(\"text-xl font-bold flex items-center justify-center gap-2\",\n                            details.winner === 'attacker' && \"text-green-400\",\n                            details.winner === 'defender' && \"text-red-400\"\n                        )}>\n                            {details.winner === 'attacker' && <CheckCircle />}\n                            {details.winner === 'defender' && <XCircle />}\n                            {details.finalMessage}\n                        </h3>\n                        <Separator className=\"my-2 bg-white/10\"/>\n                        <div className=\"flex justify-around text-sm\">\n                            <div>\n                                <p className=\"text-muted-foreground\">Puntos Perdidos (Atacante)</p>\n                                <p className=\"font-bold text-lg text-red-400\">{formatNumber(details.finalStats.attacker.pointsLost)}</p>\n                            </div>\n                                <div>\n                                <p className=\"text-muted-foreground\">Puntos Perdidos (Defensor)</p>\n                                <p className=\"font-bold text-lg text-red-400\">{formatNumber(details.finalStats.defender.pointsLost)}</p>\n                            </div>\n                        </div>\n                    </Card>\n                    <Card>\n                        <CardHeader><CardTitle className=\"text-lg\">Resumen de Pérdidas</CardTitle></CardHeader>\n                        <CardContent className=\"space-y-4\">\n                            <div className=\"flex justify-between text-sm font-bold\">\n                                <span className=\"text-blue-400\">Atacante</span>\n                                <span className=\"text-red-400\">Defensor</span>\n                            </div>\n                            <Separator className=\"bg-white/10\" />\n                            <StatLossBar label=\"Tropas\" attackerValue={details.finalStats.attacker.troopsLost} defenderValue={details.finalStats.defender.troopsLost} />\n                            <StatLossBar label=\"Armas\" attackerValue={details.finalStats.attacker.resourcesLost.armas} defenderValue={details.finalStats.defender.resourcesLost.armas} />\n                            <StatLossBar label=\"Munición\" attackerValue={details.finalStats.attacker.resourcesLost.municion} defenderValue={details.finalStats.defender.resourcesLost.municion} />\n                            <StatLossBar label=\"Dólares\" attackerValue={details.finalStats.attacker.resourcesLost.dolares} defenderValue={details.finalStats.defender.resourcesLost.dolares} />\n                        </CardContent>\n                    </Card>\n\n                    {details.rounds.map(round => (\n                        <div key={round.round} className=\"space-y-2\">\n                            <div className=\"bg-primary/80 text-primary-foreground text-center font-bold font-heading py-1\">\n                                RONDA DE BATALLA {round.round}\n                            </div>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                                {/* Atacante */}\n                                <div>\n                                    <h4 className='font-bold text-center mb-1 font-heading'>Atacante</h4>\n                                    <Table>\n                                        <TableHeader>\n                                            <TableRow className=\"border-b-primary/50\">\n                                                <TableHead className=\"text-white\">Tropa</TableHead>\n                                                <TableHead className=\"text-right text-white\">Cant.</TableHead>\n                                                <TableHead className=\"text-right text-red-500\">Pérdidas</TableHead>\n                                            </TableRow>\n                                        </TableHeader>\n                                        <TableBody>\n                                            {round.attacker.troops.map(t => (\n                                                <TableRow key={t.id} className=\"border-b-primary/20\">\n                                                    <TableCell>{t.nombre}</TableCell>\n                                                    <TableCell className=\"text-right\">{formatNumber(t.initialQuantity)}</TableCell>\n                                                    <TableCell className=\"text-right text-red-500\">{formatNumber(t.lostQuantity)}</TableCell>\n                                                </TableRow>\n                                            ))}\n                                        </TableBody>\n                                    </Table>\n                                </div>\n                                 {/* Defensor */}\n                                <div>\n                                     <h4 className='font-bold text-center mb-1 font-heading'>Defensor</h4>\n                                    <Table>\n                                        <TableHeader>\n                                            <TableRow className=\"border-b-primary/50\">\n                                                <TableHead className=\"text-white\">Tropa</TableHead>\n                                                <TableHead className=\"text-right text-white\">Cant.</TableHead>\n                                                <TableHead className=\"text-right text-red-500\">Pérdidas</TableHead>\n                                            </TableRow>\n                                        </TableHeader>\n                                        <TableBody>\n                                            {round.defender.troops.map(t => (\n                                                <TableRow key={t.id} className=\"border-b-primary/20\">\n                                                    <TableCell>{t.nombre}</TableCell>\n                                                    <TableCell className=\"text-right\">{formatNumber(t.initialQuantity)}</TableCell>\n                                                    <TableCell className=\"text-right text-red-500\">{formatNumber(t.lostQuantity)}</TableCell>\n                                                </TableRow>\n                                            ))}\n                                        </TableBody>\n                                    </Table>\n                                </div>\n                            </div>\n                            \n                            <div className=\"bg-primary/80 text-primary-foreground text-center font-bold font-heading py-1 mt-2\">\n                                ESTADO RONDA {round.round}\n                            </div>\n                            <div className=\"grid grid-cols-2 gap-x-4 p-2 text-sm font-mono\">\n                                 <div><span className=\"font-bold\">Ataque Atacante:</span> {formatNumber(round.attacker.totalAttackConBonus)} {round.attacker.poderAtaquePercent ? `(${round.attacker.poderAtaquePercent.toFixed(2)}%)` : ''}</div>\n                                 <div className=\"text-right\"><span className=\"font-bold\">Defensa Defensor:</span> {formatNumber(round.defender.totalDefense)}</div>\n                                 <div><span className=\"font-bold\">Ataque Defensor:</span> {formatNumber(round.defender.totalAttackConBonus)} {round.defender.poderAtaquePercent ? `(${round.defender.poderAtaquePercent.toFixed(2)}%)` : ''}</div>\n                                 <div className=\"text-right\"><span className=\"font-bold\">Defensa Atacante:</span> {formatNumber(round.attacker.totalDefense)}</div>\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </ScrollArea>\n            <div className=\"p-4 pt-4 border-t shrink-0\">\n                <Button onClick={() => router.back()} className=\"w-full\" variant=\"outline\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\"/>\n                    Volver a Informes\n                </Button>\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/brawls/brawls-view.tsx": "\n'use client';\n\nimport { useState } from 'react';\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { cn } from '@/lib/utils';\nimport { Swords, Shield, ChevronsRight } from \"lucide-react\";\nimport { Button } from '@/components/ui/button';\nimport type { FullBattleReport } from '@/types';\nimport { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { useRouter } from 'next/navigation';\n\ninterface BrawlsViewProps {\n    initialReports: FullBattleReport[];\n    currentUserId: string;\n}\n\ntype FilterType = 'all' | 'attacks' | 'defenses' | 'victories' | 'defeats';\n\nexport function BrawlsView({ initialReports, currentUserId }: BrawlsViewProps) {\n    const router = useRouter();\n    const [filter, setFilter] = useState<FilterType>('all');\n\n    const filteredReports = initialReports.filter(report => {\n        const isAttacker = report.attackerId === currentUserId;\n        const wasVictory = (isAttacker && report.winner === 'attacker') || (!isAttacker && report.winner === 'defender');\n\n        if (filter === 'all') return true;\n        if (filter === 'attacks' && isAttacker) return true;\n        if (filter === 'defenses' && !isAttacker) return true;\n        if (filter === 'victories' && wasVictory) return true;\n        if (filter === 'defeats' && !wasVictory) return true;\n        return false;\n    }).sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n\n    return (\n        <>\n            <div className=\"flex justify-center mb-4 flex-wrap\">\n                 <ToggleGroup type=\"single\" value={filter} onValueChange={(value: FilterType) => value && setFilter(value)} className=\"flex-wrap justify-center\">\n                    <ToggleGroupItem value=\"all\" aria-label=\"Todas\">Todas</ToggleGroupItem>\n                    <ToggleGroupItem value=\"attacks\" aria-label=\"Ataques\">Ataques</ToggleGroupItem>\n                    <ToggleGroupItem value=\"defenses\" aria-label=\"Defensas\">Defensas</ToggleGroupItem>\n                    <ToggleGroupItem value=\"victories\" aria-label=\"Victorias\">Victorias</ToggleGroupItem>\n                    <ToggleGroupItem value=\"defeats\" aria-label=\"Derrotas\">Derrotas</ToggleGroupItem>\n                </ToggleGroup>\n            </div>\n            <Card>\n                 <ScrollArea className=\"h-[calc(100vh-340px)]\">\n                    <CardContent className=\"p-0\">\n                        <div className=\"divide-y divide-border\">\n                            {filteredReports.length > 0 ? (\n                                filteredReports.map(report => {\n                                    const isAttacker = report.attackerId === currentUserId;\n                                    const opponent = isAttacker ? report.defender : report.attacker;\n                                    const wasVictory = (isAttacker && report.winner === 'attacker') || (!isAttacker && report.winner === 'defender');\n\n                                    return (\n                                        <div\n                                            key={report.id}\n                                            className={cn(\n                                                \"p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 cursor-pointer hover:bg-muted/50 transition-colors ease-in-out\",\n                                                wasVictory ? \"border-l-4 border-green-500/70\" : \"border-l-4 border-destructive/70\"\n                                            )}\n                                            onClick={() => router.push(`/brawls/${report.id}`)}\n                                        >\n                                            <div className=\"flex items-center gap-4\">\n                                                <div className=\"flex-shrink-0\">\n                                                    {isAttacker ? (\n                                                        <Swords className={cn(\"h-8 w-8\", wasVictory ? \"text-green-500\" : \"text-destructive\")} />\n                                                    ) : (\n                                                        <Shield className={cn(\"h-8 w-8\", wasVictory ? \"text-green-500\" : \"text-destructive\")} />\n                                                    )}\n                                                </div>\n                                                <div>\n                                                    <p className=\"font-bold\">\n                                                        {isAttacker ? \"Ataque a\" : \"Defensa contra\"} {opponent.name}\n                                                    </p>\n                                                    <p className=\"text-xs text-muted-foreground\">\n                                                        {new Date(report.created_at).toLocaleString('es-ES')}\n                                                    </p>\n                                                </div>\n                                            </div>\n                                            <div className=\"sm:ml-auto\">\n                                                <Button variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto\">\n                                                    Ver Informe\n                                                    <ChevronsRight className=\"ml-2 h-4 w-4\" />\n                                                </Button>\n                                            </div>\n                                        </div>\n                                    );\n                                })\n                            ) : (\n                                <div className=\"p-8 text-center text-muted-foreground\">\n                                    No hay informes que coincidan con el filtro.\n                                </div>\n                            )}\n                        </div>\n                    </CardContent>\n                 </ScrollArea>\n            </Card>\n        </>\n    );\n}\n",
    "src/components/dashboard/brawls/battle-report-display.tsx": "// src/components/lab/battle-report-display.tsx\n'use client';\n\nimport type { BattleSimulationResult, BattleRoundReport, CombatStats, BattleRoundTroopState } from '@/types/simulation.types';\nimport {\n    Card,\n    CardContent,\n    CardDescription,\n    CardHeader,\n    CardTitle,\n} from '@/components/ui/card';\nimport {\n    Accordion,\n    AccordionContent,\n    AccordionItem,\n    AccordionTrigger,\n} from '@/components/ui/accordion';\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from '@/components/ui/table';\nimport { Separator } from '@/components/ui/separator';\nimport { Badge } from '@/components/ui/badge';\n\ninterface BattleReportDisplayProps {\n    report: BattleSimulationResult | null;\n}\n\nconst getWinnerBadgeVariant = (winner: 'attacker' | 'defender' | 'draw') => {\n    switch (winner) {\n        case 'attacker':\n            return 'destructive';\n        case 'defender':\n            return 'secondary';\n        case 'draw':\n        default:\n            return 'outline';\n    }\n};\n\nconst StatsCard = ({ title, stats }: { title: string, stats: CombatStats[keyof CombatStats] }) => (\n    <div className=\"space-y-2 rounded-lg border p-4\">\n        <h4 className=\"font-semibold text-center\">{title}</h4>\n        <Separator />\n        <div className=\"text-sm\">\n            <div className=\"flex justify-between\"><span>Tropas Perdidas:</span> <span className=\"font-mono\">{stats.troopsLost.toLocaleString()}</span></div>\n            <div className=\"flex justify-between\"><span>Puntos Perdidos:</span> <span className=\"font-mono\">{stats.pointsLost.toLocaleString()}</span></div>\n        </div>\n        <div>\n            <h5 className=\"text-xs text-muted-foreground mb-1\">Recursos Perdidos:</h5>\n            <div className=\"text-sm space-y-1\">\n                <div className=\"flex justify-between\"><span>Armas:</span> <span className=\"font-mono\">{stats.resourcesLost.armas.toLocaleString()}</span></div>\n                <div className=\"flex justify-between\"><span>Munición:</span> <span className=\"font-mono\">{stats.resourcesLost.municion.toLocaleString()}</span></div>\n                <div className=\"flex justify-between\"><span>Dólares:</span> <span className=\"font-mono\">{stats.resourcesLost.dolares.toLocaleString()}</span></div>\n            </div>\n        </div>\n    </div>\n);\n\n\nconst RoundDetails = ({ round }: { round: BattleRoundReport }) => {\n    // Combinamos las tropas de ambos bandos para renderizarlas en una sola tabla.\n    // Usamos un Map para emparejar tropas por su ID si ambos bandos tienen las mismas.\n    const troopMap = new Map<string, { attacker: BattleRoundTroopState | null, defender: BattleRoundTroopState | null }>();\n\n    round.attacker.troops.forEach((t: BattleRoundTroopState) => {\n        if (!troopMap.has(t.id)) troopMap.set(t.id, { attacker: null, defender: null });\n        const entry = troopMap.get(t.id)!;\n        entry.attacker = t;\n    });\n\n    round.defender.troops.forEach((t: BattleRoundTroopState) => {\n        if (!troopMap.has(t.id)) troopMap.set(t.id, { attacker: null, defender: null });\n        const entry = troopMap.get(t.id)!;\n        entry.defender = t;\n    });\n\n    const combinedTroops = Array.from(troopMap.values());\n    const troopName = combinedTroops[0]?.attacker?.nombre || combinedTroops[0]?.defender?.nombre || 'Tropa';\n\n    return (\n    <div className=\"space-y-4\">\n        {/* Tabla de Unidades */}\n        <div className=\"rounded-md border\">\n            <Table>\n                <TableHeader>\n                    <TableRow>\n                        <TableHead className=\"w-[200px]\">Tropa</TableHead>\n                        <TableHead className=\"text-center\">Cant. Atacante</TableHead>\n                        <TableHead className=\"text-center text-destructive\">Pérdidas Atacante</TableHead>\n                        <TableHead className=\"text-center\">Cant. Defensor</TableHead>\n                        <TableHead className=\"text-center text-destructive\">Pérdidas Defensor</TableHead>\n                    </TableRow>\n                </TableHeader>\n                <TableBody>\n                    {combinedTroops.map(t => (\n                        <TableRow key={t.attacker?.id || t.defender?.id}>\n                             <TableCell className=\"font-medium\">{t.attacker?.nombre || t.defender?.nombre}</TableCell>\n                            <TableCell className=\"text-center font-mono\">{t.attacker?.initialQuantity.toLocaleString() || 0}</TableCell>\n                            <TableCell className=\"text-center font-mono text-destructive\">{t.attacker?.lostQuantity.toLocaleString() || 0}</TableCell>\n                            <TableCell className=\"text-center font-mono\">{t.defender?.initialQuantity.toLocaleString() || 0}</TableCell>\n                            <TableCell className=\"text-center font-mono text-destructive\">{t.defender?.lostQuantity.toLocaleString() || 0}</TableCell>\n                        </TableRow>\n                    ))}\n                </TableBody>\n            </Table>\n        </div>\n\n        {/* Informe de Batalla de la Ronda */}\n        <div className=\"rounded-md border p-4 space-y-2\">\n             <h4 className=\"font-semibold text-center text-lg\">Informe de Batalla {round.round}</h4>\n            <Separator/>\n            <div className=\"grid grid-cols-2 gap-x-8 gap-y-1 text-sm\">\n                <div className=\"font-semibold text-primary\">A: Ataque: {round.attacker.totalAttackConBonus?.toLocaleString() ?? round.attacker.totalAttack.toLocaleString()}</div>\n                <div className=\"font-semibold text-primary\">Defensa: {round.attacker.totalDefense.toLocaleString()}</div>\n                <div className=\"font-semibold text-secondary-foreground\">D: Ataque: {round.defender.totalAttackConBonus?.toLocaleString() ?? round.defender.totalAttack.toLocaleString()}</div>\n                <div className=\"font-semibold text-secondary-foreground\">Defensa: {round.defender.totalDefense.toLocaleString()}</div>\n            </div>\n             <Separator/>\n            <div className=\"text-xs text-muted-foreground pt-2\">\n                <p>A: {troopName} Destruido {round.defender.troops.reduce((acc: number, t: BattleRoundTroopState) => acc + t.lostQuantity, 0).toLocaleString()} {troopName} con {round.attacker.totalAttackConBonus?.toLocaleString() ?? round.attacker.totalAttack.toLocaleString()} de daño.</p>\n                 <p>D: {troopName} Destruido {round.attacker.troops.reduce((acc: number, t: BattleRoundTroopState) => acc + t.lostQuantity, 0).toLocaleString()} {troopName} con {round.defender.totalAttackConBonus?.toLocaleString() ?? round.defender.totalAttack.toLocaleString()} de daño.</p>\n            </div>\n        </div>\n    </div>\n    );\n};\n\nexport function BattleReportDisplay({ report }: BattleReportDisplayProps) {\n    if (!report) {\n        return (\n             <Card className=\"mt-6\">\n                <CardHeader>\n                    <CardTitle>Reporte de Batalla</CardTitle>\n                </CardHeader>\n                <CardContent>\n                    <p className=\"text-muted-foreground text-center py-8\">\n                        Realiza una simulación para ver aquí el reporte de batalla.\n                    </p>\n                </CardContent>\n            </Card>\n        );\n    }\n\n    return (\n        <Card className=\"mt-6\">\n            <CardHeader>\n                <CardTitle className=\"flex justify-between items-center\">\n                    <span>Reporte de Batalla</span>\n                     <Badge variant={getWinnerBadgeVariant(report.winner)} className=\"capitalize text-base px-3 py-1\">\n                        {report.winner === 'draw' ? 'Empate' : `Victoria: ${report.winner}`}\n                    </Badge>\n                </CardTitle>\n                <CardDescription>{report.finalMessage}</CardDescription>\n            </CardHeader>\n            <CardContent>\n                 <Accordion type=\"single\" collapsible className=\"w-full\" defaultValue=\"round-1\">\n                    {report.rounds.map(round => (\n                         <AccordionItem value={`round-${round.round}`} key={round.round}>\n                            <AccordionTrigger className=\"text-lg font-semibold\">\n                                RONDA DE BATALLA {round.round}\n                            </AccordionTrigger>\n                            <AccordionContent>\n                                <RoundDetails round={round} />\n                            </AccordionContent>\n                        </AccordionItem>\n                    ))}\n                </Accordion>\n                \n                <Separator className=\"my-6\" />\n\n                <div className=\"space-y-4\">\n                    <h3 className=\"text-xl font-semibold text-center\">ESTADÍSTICAS FINALES DE COMBATE</h3>\n                     <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                        <StatsCard title=\"Pérdidas del Atacante\" stats={report.finalStats.attacker} />\n                        <StatsCard title=\"Pérdidas del Defensor\" stats={report.finalStats.defender} />\n                    </div>\n                </div>\n\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/mafia-recruit-card.tsx": "\n\"use client\";\n\nimport Image from \"next/image\";\nimport { \n  Clock, Info, Lock,\n  Users\n} from \"lucide-react\";\nimport { cn, formatNumber, formatDuration } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { resourceIcons } from \"@/lib/constants\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"../ui/tooltip\";\n\ninterface TroopCost {\n  armas: number;\n  municion: number;\n  dolares: number; \n  personas?: number;\n}\n\ninterface MafiaRecruitCardProps {\n  name: string;\n  description: string;\n  imageSrc: string;\n  cost: TroopCost;\n  time: number; // in seconds\n  status: \"locked\" | \"available\" | \"training\";\n  requirementsText?: string;\n  onRecruit?: () => void;\n  onDetails?: () => void;\n}\n\nexport function MafiaRecruitCard({\n  name, description, imageSrc, cost, time, status, \n  requirementsText, onRecruit, onDetails\n}: MafiaRecruitCardProps) {\n  \n  const CostItem = ({ icon, value, label }: { icon: string; value: number, label: string }) => {\n    if (!value || value <= 0) return null;\n    return (\n      <TooltipProvider delayDuration={0}>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <div className=\"flex flex-col items-center justify-center gap-1 p-2 rounded-md hover:bg-white/5 cursor-help\">\n              <Image src={icon} alt={label} width={16} height={16} />\n              <span className=\"text-xs font-mono font-bold text-zinc-300\">{formatNumber(value)}</span>\n            </div>\n          </TooltipTrigger>\n          <TooltipContent side=\"bottom\">\n            <p>{label}: {value.toLocaleString('de-DE')}</p>\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n    );\n  };\n\n  return (\n    <div className=\"group relative w-full overflow-hidden rounded-xl border border-border bg-card shadow-lg transition-all duration-300 hover:-translate-y-1 hover:border-primary/50 hover:shadow-primary/20\">\n      \n      {/* --- HEADER & IMAGE --- */}\n      <div className=\"relative h-40 w-full overflow-hidden\">\n        {/* Badge de Estado */}\n        {status === \"locked\" && (\n             <div className=\"absolute right-3 top-3 z-20\">\n                <Badge variant=\"destructive\" className=\"gap-1 font-bold uppercase tracking-wider\">\n                    <Lock size={10} /> Bloqueado\n                </Badge>\n            </div>\n        )}\n        \n        <Image\n          src={imageSrc} alt={name} fill\n          sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw\"\n          className={cn(\n            \"object-contain p-2 transition-transform duration-700 group-hover:scale-110\", \n            status === \"locked\" && \"grayscale contrast-125 opacity-50\"\n          )}\n        />\n        <div className=\"absolute inset-0 bg-gradient-to-t from-card via-card/60 to-transparent\" />\n        \n        <div className=\"absolute bottom-3 left-4 right-4 z-10\">\n            <h3 className=\"font-heading text-3xl uppercase tracking-wide text-white drop-shadow-md\">{name}</h3>\n            <p className=\"line-clamp-1 text-xs text-muted-foreground font-medium\">{description}</p>\n        </div>\n      </div>\n\n      {/* --- BODY --- */}\n      <div className=\"flex flex-col gap-3 p-4 pt-1 relative z-10\">\n        \n        {/* COST GRID */}\n        <div className=\"grid grid-cols-4 items-center divide-x divide-white/5 rounded border border-white/10 bg-black/40 py-1 backdrop-blur-sm\">\n            <CostItem icon={resourceIcons.armas} value={cost.armas} label=\"Armas\" />\n            <CostItem icon={resourceIcons.municion} value={cost.municion} label=\"Munición\" />\n            <CostItem icon={resourceIcons.dolares} value={cost.dolares} label=\"Dólares\" />\n            {cost.personas && <CostItem icon=\"/img/recursos/dolares.svg\" value={cost.personas} label=\"Reclutas\" />}\n             <TooltipProvider delayDuration={0}>\n                <Tooltip>\n                    <TooltipTrigger asChild>\n                         <div className=\"flex flex-col items-center justify-center gap-1 p-2 cursor-help\">\n                            <Clock size={16} className=\"text-zinc-500\" />\n                            <span className=\"text-xs font-mono font-bold text-zinc-300\">{formatDuration(time)}</span>\n                        </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                        <p>Tiempo de Reclutamiento</p>\n                    </TooltipContent>\n                </Tooltip>\n             </TooltipProvider>\n        </div>\n\n        {/* ACTIONS */}\n        <div className=\"mt-1 flex items-center gap-2\">\n            <Button variant=\"ghost\" size=\"icon\" onClick={onDetails} className=\"h-9 w-9 shrink-0 text-muted-foreground hover:bg-white/10 hover:text-white\">\n                <Info size={18} />\n            </Button>\n            \n            {status === \"locked\" ? (\n                <div className=\"flex-1 rounded border border-dashed border-destructive/30 bg-destructive/10 py-2 text-center\">\n                    <span className=\"text-xs font-bold uppercase text-destructive tracking-widest\">\n                        {requirementsText || \"Requiere investigación\"}\n                    </span>\n                </div>\n            ) : (\n                <Button \n                    onClick={onRecruit}\n                    className=\"group relative flex-1 overflow-hidden font-heading text-lg tracking-widest bg-gradient-to-r from-primary to-red-900 hover:from-red-600 hover:to-primary border-0 shadow-lg shadow-red-900/20\"\n                >\n                    <span className=\"relative z-10 flex items-center justify-center gap-2\">\n                        RECLUTAR\n                    </span>\n                    {/* Shimmer effect */}\n                    <div className=\"absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:animate-[shimmer_1.5s_infinite]\" />\n                </Button>\n            )}\n        </div>\n      </div>\n    </div>\n  );\n}\n",
    "src/components/dashboard/security-view.tsx": "\n\n'use client'\n\nimport { GameCard } from \"@/components/ui/game-card\"\nimport { Button } from \"@/components/ui/button\"\nimport { ShieldCheck, Loader2, Info, Dumbbell, DollarSign, Minus, Plus } from \"lucide-react\"\nimport { iniciarEntrenamientoSeguridad } from \"@/lib/actions/troop.actions\"\nimport { useState, useTransition } from \"react\"\nimport { Input } from \"../ui/input\"\nimport { useProperty } from \"@/contexts/property-context\"\nimport { Dialog, DialogTrigger } from \"../ui/dialog\"\nimport { TroopDetailsModal } from \"./troop-details-modal\"\nimport { formatNumber } from \"@/lib/utils\"\nimport type { UserWithProgress, FullTropaUsuario, FullConfiguracionTropa } from \"@/types\"\nimport { useRouter } from \"next/navigation\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ntype TroopWithStats = FullConfiguracionTropa & {\n    ataqueActual: number;\n    defensaActual: number;\n    capacidadActual: number;\n    velocidadActual: number;\n    salarioActual: number;\n}\n\ntype SecurityViewProps = {\n    defenseTroops: TroopWithStats[];\n    user: UserWithProgress;\n}\n\nfunction SecurityTroopForm({ troop }: { troop: TroopWithStats & { count: number } }) {\n    const { selectedProperty } = useProperty();\n    const router = useRouter();\n    const { toast } = useToast();\n    const [cantidad, setCantidad] = useState(0);\n    const [error, setError] = useState('');\n    const [isPending, startTransition] = useTransition();\n    \n    const colaReclutamientoActiva = !!selectedProperty?.colaReclutamiento;\n    \n    const handleSubmit = async (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!selectedProperty || cantidad <= 0) return;\n\n        setError('');\n        startTransition(async () => {\n            const result = await iniciarEntrenamientoSeguridad(selectedProperty.id, troop.id, cantidad);\n            if (result?.error) {\n                setError(result.error);\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                setCantidad(0);\n                toast({ title: 'Éxito', description: 'Entrenamiento de seguridad iniciado.' });\n                router.refresh();\n            }\n        });\n    }\n\n    const handleIncrement = () => setCantidad(c => c + 1);\n    const handleDecrement = () => setCantidad(c => Math.max(0, c - 1));\n    \n    return (\n        <form onSubmit={handleSubmit} className=\"flex items-center gap-1\">\n             <div className=\"flex items-center\">\n                 <Button type=\"button\" variant=\"outline\" size=\"icon\" className=\"h-8 w-8 rounded-r-none border-r-0 shrink-0\" onClick={handleDecrement} disabled={colaReclutamientoActiva || isPending}>\n                    <Minus className=\"h-3 w-3\"/>\n                 </Button>\n                 <Input \n                    type=\"number\"\n                    min=\"0\"\n                    value={cantidad}\n                    onChange={(e) => setCantidad(Number(e.target.value))}\n                    className=\"h-8 w-12 text-center rounded-none px-0 focus-visible:ring-0\"\n                    disabled={colaReclutamientoActiva || isPending}\n                />\n                <Button type=\"button\" variant=\"outline\" size=\"icon\" className=\"h-8 w-8 rounded-l-none border-l-0 shrink-0\" onClick={handleIncrement} disabled={colaReclutamientoActiva || isPending}>\n                    <Plus className=\"h-3 w-3\"/>\n                </Button>\n             </div>\n\n            <Button type=\"submit\" size=\"sm\" className=\"h-8 px-2\" disabled={colaReclutamientoActiva || isPending || cantidad === 0}>\n                {isPending ? <Loader2 className=\"h-3 w-3 animate-spin\"/> : <ShieldCheck className=\"h-3 w-3\" />}\n            </Button>\n            {error && <p className=\"sr-only\">{error}</p>}\n        </form>\n    )\n}\n\nexport function SecurityView({ user, defenseTroops }: SecurityViewProps) {\n  const { selectedProperty } = useProperty();\n\n  if (!selectedProperty) {\n    return (\n      <div className=\"p-4 text-center\">\n          <p>Por favor, selecciona una propiedad para gestionar tus defensas.</p>\n      </div>\n    )\n  }\n  \n  const userTroopsMap = new Map(selectedProperty.TropaSeguridadUsuario.map((t) => [t.configuracionTropaId, t]));\n  const userTrainingsMap = new Map(user.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel]));\n\n  const troopsWithData = defenseTroops.map(config => {\n    const userTropa = userTroopsMap.get(config.id);\n    const requirements = (config.requisitos || []) as unknown as { id: string; lvl: number }[];\n    const meetsRequirements = requirements.every(req => (userTrainingsMap.get(req.id) || 0) >= req.lvl);\n\n    return {\n      ...config,\n      count: userTropa?.cantidad || 0,\n      meetsRequirements,\n    }\n  });\n\n  const unlockedTroops = troopsWithData.filter(t => t.meetsRequirements);\n\n  const totalDefensePower = troopsWithData.reduce((acc, troop) => {\n      return acc + (troop.defensaActual * troop.count);\n  }, 0);\n\n  return (\n    <div className=\"space-y-6\">\n       <div className=\"flex flex-col md:flex-row md:items-end justify-between gap-4\">\n            <div>\n                <h2 className=\"text-3xl font-bold tracking-tight\">Seguridad</h2>\n                 <p className=\"text-muted-foreground\">\n                    Defensas de: <span className=\"font-semibold text-gold\">{selectedProperty.nombre}</span> <span className=\"font-mono text-sm font-semibold text-primary/80\">[{selectedProperty.ciudad}:{selectedProperty.barrio}:{selectedProperty.edificio}]</span>\n                </p>\n            </div>\n\n            {/* Banner style header for total defense */}\n            <div className=\"bg-card border border-border/50 rounded-lg p-3 flex items-center gap-4 shadow-sm min-w-[200px]\">\n                <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n                    <ShieldCheck className=\"h-5 w-5 text-primary\"/>\n                </div>\n                <div>\n                    <p className=\"text-xs text-muted-foreground font-medium uppercase tracking-wider\">Defensa Total</p>\n                    <p className=\"text-xl font-bold font-mono\">{formatNumber(totalDefensePower)}</p>\n                </div>\n            </div>\n       </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {unlockedTroops.map((troop) => (\n            <Dialog key={troop.id}>\n                 <GameCard\n                    title={troop.nombre}\n                    imageSrc={troop.urlImagen ? troop.urlImagen : \"https://placehold.co/80x56.png\"}\n                    imageFit=\"contain\"\n                    badgeText={`${troop.count}`}\n                    description={troop.descripcion || undefined}\n                    status={troop.meetsRequirements ? 'available' : 'locked'}\n                    time={troop.duracion}\n                    stats={[\n                        { icon: <Dumbbell className=\"h-4 w-4 text-red-500\" />, value: troop.ataqueActual, label: \"Ataque\" },\n                        { icon: <ShieldCheck className=\"h-4 w-4 text-blue-500\" />, value: troop.defensaActual, label: \"Defensa\" },\n                        { icon: <DollarSign className=\"h-4 w-4 text-gray-400\" />, value: troop.salarioActual, label: \"Salario\" },\n                    ]}\n                    actionButton={\n                        <div className=\"flex items-center justify-end gap-2 w-full\">\n                            <SecurityTroopForm troop={troop} />\n                             <DialogTrigger asChild>\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 shrink-0\">\n                                     <Info className=\"h-4 w-4 text-muted-foreground\" />\n                                </Button>\n                             </DialogTrigger>\n                        </div>\n                    }\n                />\n                <TroopDetailsModal\n                    troop={troop}\n                    user={user}\n                    ataqueActual={troop.ataqueActual}\n                    defensaActual={troop.defensaActual}\n                    capacidadActual={troop.capacidadActual}\n                    velocidadActual={troop.velocidadActual}\n                    salarioActual={troop.salarioActual}\n                />\n            </Dialog>\n            ))}\n        </div>\n    </div>\n  )\n}\n",
    "src/components/dashboard/map-view.tsx": "'use client'\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useRouter, useSearchParams, usePathname } from 'next/navigation';\nimport { Button } from '@/components/ui/button';\nimport { Card } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { getPropertyOwner, getPropertiesByLocation } from '@/lib/data/property';\nimport type { UserWithProgress, PropertyWithOwner } from '@/types';\nimport { ChevronLeft, ChevronRight, Loader2, Send, ArrowUp, ArrowDown, ArrowLeft as ArrowLeftIcon, ArrowRight as ArrowRightIcon } from 'lucide-react';\nimport { cn } from '@/lib/utils';\nimport {\n    Dialog,\n    DialogContent,\n    DialogDescription,\n    DialogHeader,\n    DialogTitle,\n    DialogTrigger,\n    DialogFooter,\n    DialogClose,\n} from \"@/components/ui/dialog\"\nimport Image from 'next/image';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '../ui/tooltip';\nimport { Avatar, AvatarFallback, AvatarImage } from '../ui/avatar';\nimport { Separator } from '../ui/separator';\n\nconst BuildingGrid = ({ properties, currentUser, currentCiudad, currentBarrio }: { properties: PropertyWithOwner[], currentUser: UserWithProgress, currentCiudad: number, currentBarrio: number }) => {\n    const router = useRouter();\n    const buildings = Array.from({ length: 255 }, (_, i) => {\n        const edificio = i + 1;\n        const property = properties.find(p => p.edificio === edificio);\n        return { edificio, property };\n    });\n\n    const handleSendMission = (ciudad: number, barrio: number, edificio: number) => {\n        const params = new URLSearchParams();\n        params.set('ciudad', ciudad.toString());\n        params.set('barrio', barrio.toString());\n        params.set('edificio', edificio.toString());\n        router.push(`/missions?${params.toString()}`);\n    }\n\n    const getBuildingColor = (property: PropertyWithOwner | undefined): string => {\n        if (!property || !property.user) {\n            return \"bg-black/40 border-black/60 hover:bg-black/60\"; // Desocupado\n        }\n        if (property.userId === currentUser.id) {\n            return \"bg-primary/70 border-primary/90 text-primary-foreground hover:bg-primary hover:shadow-primary/50 hover:shadow-lg\"; // Propio\n        }\n        if (property.user.familyMember?.familyId && property.user.familyMember.familyId === currentUser.familyMember?.familyId) {\n            return \"bg-accent/70 border-accent/90 text-accent-foreground hover:bg-accent hover:shadow-accent/50 hover:shadow-lg\"; // Familia\n        }\n        return \"bg-destructive/70 border-destructive/90 text-destructive-foreground hover:bg-destructive hover:shadow-destructive/50 hover:shadow-lg\"; // Enemigo\n    };\n\n    return (\n        <div className=\"relative w-full aspect-[17/15] rounded-lg border overflow-hidden bg-black shadow-inner shadow-black/50\">\n             <Image\n                src=\"/img/map.png\"\n                alt=\"Mapa de la ciudad\"\n                fill\n                className=\"object-cover z-0 opacity-40\"\n                data-ai-hint=\"city map background\"\n            />\n            <div className=\"absolute inset-0 grid grid-cols-17 gap-0.5 p-1 z-10\">\n                {buildings.map(({ edificio, property }) => (\n                    <TooltipProvider key={edificio} delayDuration={0}>\n                        <Tooltip>\n                            <Dialog>\n                                <TooltipTrigger asChild>\n                                    <DialogTrigger asChild>\n                                        <div className={cn(\n                                            \"aspect-square flex items-center justify-center rounded-sm text-xs font-bold transition-all duration-200 cursor-pointer border hover:scale-110 hover:z-20\",\n                                            getBuildingColor(property)\n                                        )}>\n                                            <span className=\"opacity-75\">{property && edificio}</span>\n                                        </div>\n                                    </DialogTrigger>\n                                </TooltipTrigger>\n                                <DialogContent>\n                                    <DialogHeader>\n                                        <DialogTitle>Propiedad en [{currentCiudad}:{currentBarrio}:{edificio}]</DialogTitle>\n                                         <DialogDescription>\n                                            {property ? (\n                                                `Esta propiedad pertenece a ${property.user?.name || 'Desconocido'}.`\n                                            ) : (\n                                                \"Este solar está actualmente desocupado.\"\n                                            )}\n                                        </DialogDescription>\n                                    </DialogHeader>\n                                    {property && property.user && (\n                                        <div className='flex items-center gap-4'>\n                                             <Avatar className=\"h-20 w-20 border-2 border-primary\">\n                                                <AvatarImage src={property.user.avatarUrl || ''} alt={property.user.name || ''} data-ai-hint=\"mafia boss\" />\n                                                <AvatarFallback>{property.user.name?.charAt(0).toUpperCase()}</AvatarFallback>\n                                            </Avatar>\n                                            <div className='space-y-1'>\n                                                <p><strong>Jugador:</strong> {property.user.name}</p>\n                                                <p><strong>Familia:</strong> {property.user.familyMember?.family.name || 'Sin familia'}</p>\n                                                <p><strong>Puntos:</strong> {property.user.puntuacion?.puntosTotales.toLocaleString('de-DE') || 'N/A'}</p>\n                                            </div>\n                                        </div>\n                                    )}\n                                    <DialogFooter>\n                                         <DialogClose asChild>\n                                            <Button variant=\"outline\">Cerrar</Button>\n                                        </DialogClose>\n                                        <Button onClick={() => handleSendMission(currentCiudad, currentBarrio, edificio)}>\n                                            <Send className=\"mr-2 h-4 w-4\" />\n                                            Enviar Misión\n                                        </Button>\n                                    </DialogFooter>\n                                </DialogContent>\n                            </Dialog>\n                            <TooltipContent>\n                                <p className='font-bold text-base'>[{currentCiudad}:{currentBarrio}:{edificio}]</p>\n                                <Separator className='my-1'/>\n                                <p className='text-sm'>{property?.user?.name || \"Desocupado\"}</p>\n                                {property?.user?.familyMember && <p className='text-xs text-muted-foreground'>Familia: {property.user.familyMember.family.name}</p>}\n                            </TooltipContent>\n                        </Tooltip>\n                    </TooltipProvider>\n                ))}\n            </div>\n        </div>\n    );\n};\n\nconst CoordinateInput = ({ label, value, onChange }: { label: string, value: number, onChange: (newValue: number) => void }) => {\n    const handleManualChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const val = parseInt(e.target.value, 10);\n        if (!isNaN(val) && val > 0) {\n            onChange(val);\n        } else if (e.target.value === '') {\n            onChange(1); \n        }\n    };\n    \n    return (\n        <div className=\"flex flex-col items-center gap-1\">\n            <span className=\"text-xs font-medium\">{label}</span>\n            <div className=\"flex items-center gap-1\">\n                <Button \n                    variant=\"outline\" \n                    size=\"icon\" \n                    className=\"h-8 w-8 transition-colors\" \n                    onClick={() => onChange(Math.max(1, value - 1))}\n                    aria-label={`Disminuir ${label.toLowerCase()}`}\n                >\n                    <ChevronLeft className=\"h-4 w-4\" />\n                </Button>\n                <Input \n                    type=\"number\" \n                    className=\"w-16 h-8 text-center\" \n                    value={value}\n                    onChange={handleManualChange}\n                />\n                <Button \n                    variant=\"outline\" \n                    size=\"icon\" \n                    className=\"h-8 w-8 transition-colors\" \n                    onClick={() => onChange(value + 1)}\n                    aria-label={`Aumentar ${label.toLowerCase()}`}\n                >\n                    <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n            </div>\n        </div>\n    )\n}\n\nexport function MapView({ ciudad, barrio, properties, currentUser }: { ciudad: number, barrio: number, properties: PropertyWithOwner[], currentUser: UserWithProgress }) {\n    const router = useRouter();\n    const pathname = usePathname();\n\n    // Internal state for the input fields, initialized from props\n    const [inputCiudad, setInputCiudad] = useState(ciudad);\n    const [inputBarrio, setInputBarrio] = useState(barrio);\n\n    // Update internal state if props change (e.g., via browser back/forward)\n    useEffect(() => {\n        setInputCiudad(ciudad);\n        setInputBarrio(barrio);\n    }, [ciudad, barrio]);\n\n    const updateMap = useCallback((newCiudad: number, newBarrio: number) => {\n        const params = new URLSearchParams();\n        params.set('ciudad', newCiudad.toString());\n        params.set('barrio', newBarrio.toString());\n        router.push(`${pathname}?${params.toString()}`);\n    }, [pathname, router]);\n\n    return (\n        <Card className=\"bg-card/80\">\n            <div className=\"space-y-4 p-4\">\n                <div className=\"flex flex-row flex-wrap justify-center items-end gap-2 p-2 rounded-lg bg-muted border\">\n                    <CoordinateInput label=\"Ciudad\" value={inputCiudad} onChange={setInputCiudad} />\n                    <CoordinateInput label=\"Barrio\" value={inputBarrio} onChange={setInputBarrio} />\n                    <Button onClick={() => updateMap(inputCiudad, inputBarrio)} size=\"sm\" className=\"h-8\">\n                        Ir\n                    </Button>\n                </div>\n\n                <div className=\"relative\">\n                     <div className=\"flex justify-center mb-1\">\n                        <Button variant=\"ghost\" size=\"icon\" onClick={() => updateMap(ciudad, barrio - 1)}>\n                            <ArrowUp className=\"h-5 w-5\"/>\n                            <span className=\"sr-only\">Ir al barrio anterior (Norte)</span>\n                        </Button>\n                    </div>\n                     <div className=\"flex items-center justify-between\">\n                         <Button variant=\"ghost\" size=\"icon\" onClick={() => updateMap(ciudad - 1, barrio)}>\n                            <ArrowLeftIcon className=\"h-5 w-5\"/>\n                            <span className=\"sr-only\">Ir a la ciudad anterior (Oeste)</span>\n                        </Button>\n                        <BuildingGrid properties={properties} currentUser={currentUser} currentCiudad={ciudad} currentBarrio={barrio} />\n                         <Button variant=\"ghost\" size=\"icon\" onClick={() => updateMap(ciudad + 1, barrio)}>\n                            <ArrowRightIcon className=\"h-5 w-5\"/>\n                            <span className=\"sr-only\">Ir a la ciudad siguiente (Este)</span>\n                        </Button>\n                    </div>\n                     <div className=\"flex justify-center mt-1\">\n                        <Button variant=\"ghost\" size=\"icon\" onClick={() => updateMap(ciudad, barrio + 1)}>\n                            <ArrowDown className=\"h-5 w-5\"/>\n                            <span className=\"sr-only\">Ir al barrio siguiente (Sur)</span>\n                        </Button>\n                    </div>\n                </div>\n            </div>\n        </Card>\n    )\n}\n",
    "src/components/dashboard/property-selector.tsx": "\n'use client'\n\nimport * as React from 'react'\nimport { Button } from '@/components/ui/button'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport { Building, Check, ChevronLeft, ChevronRight } from 'lucide-react'\nimport type { FullPropiedad } from '@/types'\nimport { useProperty } from '@/contexts/property-context'\nimport { cn } from '@/lib/utils'\n\ninterface PropertySelectorProps {\n  properties: FullPropiedad[]\n}\n\nexport function PropertySelector({ properties }: PropertySelectorProps) {\n  const { selectedProperty, setSelectedPropertyById } = useProperty();\n\n  const handlePropertyChange = (direction: 'next' | 'prev') => {\n    if (!selectedProperty || properties.length <= 1) return;\n\n    const currentIndex = properties.findIndex(p => p.id === selectedProperty.id);\n    if (currentIndex === -1) return;\n\n    let nextIndex;\n    if (direction === 'next') {\n        nextIndex = (currentIndex + 1) % properties.length;\n    } else {\n        nextIndex = (currentIndex - 1 + properties.length) % properties.length;\n    }\n    \n    const nextPropertyId = properties[nextIndex].id;\n    setSelectedPropertyById(nextPropertyId);\n  }\n\n  const getPropertyDisplay = (property: FullPropiedad | null) => {\n    if (!property) return 'Seleccionar...';\n    return `[${property.ciudad}:${property.barrio}:${property.edificio}]`;\n  }\n\n  if (!properties || properties.length === 0) {\n    return null\n  }\n  \n  if (properties.length === 1) {\n    return (\n       <div className=\"p-2\">\n            <Button\n                variant=\"outline\"\n                role=\"combobox\"\n                className=\"w-full justify-start\"\n            >\n                <Building className=\"mr-2 h-4 w-4\" />\n                <span className=\"truncate\">{getPropertyDisplay(selectedProperty)}</span>\n            </Button>\n       </div>\n    )\n  }\n\n  return (\n    <div className=\"p-2 flex items-center gap-1\">\n        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 shrink-0 transition-colors\" onClick={() => handlePropertyChange('prev')}>\n            <ChevronLeft className=\"h-4 w-4\" />\n            <span className=\"sr-only\">Propiedad anterior</span>\n        </Button>\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button\n            variant=\"outline\"\n            role=\"combobox\"\n            className=\"w-full h-8 justify-center bg-muted/50 hover:bg-muted\"\n          >\n            <div className=\"flex items-center gap-2 truncate\">\n              <Building className=\"h-4 w-4 flex-shrink-0\" />\n              <span className=\"truncate text-sm font-medium\">{getPropertyDisplay(selectedProperty)}</span>\n            </div>\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent className=\"w-[var(--sidebar-width)] -translate-x-2\">\n          <DropdownMenuLabel>Tus Propiedades</DropdownMenuLabel>\n          <DropdownMenuSeparator />\n          {properties.map((property) => (\n            <DropdownMenuItem\n              key={property.id}\n              onSelect={() => setSelectedPropertyById(property.id)}\n            >\n              <Check\n                className={cn('mr-2 h-4 w-4',\n                  selectedProperty?.id === property.id ? 'opacity-100' : 'opacity-0'\n                )}\n              />\n              <span>{getPropertyDisplay(property)}</span>\n            </DropdownMenuItem>\n          ))}\n        </DropdownMenuContent>\n      </DropdownMenu>\n       <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 shrink-0 transition-colors\" onClick={() => handlePropertyChange('next')}>\n            <ChevronRight className=\"h-4 w-4\" />\n            <span className=\"sr-only\">Siguiente propiedad</span>\n        </Button>\n    </div>\n  )\n}\n",
    "src/components/dashboard/overview-view.tsx": "\n\n'use client'\nimport * as React from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport Image from \"next/image\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Bell, MessageSquare, UserPlus, Users2, Wifi } from \"lucide-react\";\nimport { QueueStatusCard } from \"@/components/dashboard/queue-status-card\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport Link from \"next/link\";\nimport type { UserWithProgress } from \"@/types\";\nimport { IncomingAttacks } from \"@/components/dashboard/incoming-attacks\";\nimport { PlayerCard } from \"@/components/dashboard/overview/player-card\";\nimport { calcularPoderAtaque } from \"@/lib/formulas/score-formulas\";\nimport { MissionOverview } from \"@/components/dashboard/overview/mission-overview\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAtomValue } from 'jotai';\nimport { userProfileAtom, activePropertyAtom } from '@/store/atoms';\nimport { cn, getLastSeenStatus } from \"@/lib/utils\";\n\nfunction ActionIcons({ unreadMessages, inFamily }: { unreadMessages: number, inFamily: boolean }) {\n    const actions = [\n        { href: \"/messages?categoria=SISTEMA\", icon: <Bell className=\"h-5 w-5\" />, notification: 0, label: \"Notificaciones del Sistema\" },\n        { href: \"/messages\", icon: <MessageSquare className=\"h-5 w-5\" />, notification: unreadMessages, label: \"Mensajes\" },\n        { href: \"/family\", label: \"Familia\", icon: <Users2 className=\"h-5 w-5\" /> },\n    ]\n    return (\n        <div className=\"absolute top-4 right-4 flex flex-col items-center gap-3 z-30\">\n            {actions.map((action, index) => (\n                 <TooltipProvider key={index} delayDuration={0}>\n                    <Tooltip>\n                        <TooltipTrigger asChild>\n                             <Button asChild variant=\"outline\" size=\"icon\" className=\"h-9 w-9 bg-background/50 border-white/20 hover:bg-white/10 text-white relative backdrop-blur-sm shadow-md transition-all hover:scale-110\">\n                                <Link href={action.href}>\n                                    {action.icon}\n                                    <span className=\"sr-only\">{action.label}</span>\n                                    {action.notification && action.notification > 0 && \n                                        <Badge variant=\"destructive\" className=\"absolute -top-1 -right-1 h-4 w-4 flex items-center justify-center p-0 animate-pulse\">{action.notification}</Badge>\n                                    }\n                                </Link>\n                            </Button>\n                        </TooltipTrigger>\n                        <TooltipContent side=\"left\">\n                            <p>{action.label}</p>\n                        </TooltipContent>\n                    </Tooltip>\n                 </TooltipProvider>\n            ))}\n        </div>\n    )\n}\n\nexport default function OverviewView() {\n    const selectedProperty = useAtomValue(activePropertyAtom);\n    const user = useAtomValue(userProfileAtom);\n\n    if (!user || !selectedProperty) {\n        return (\n             <div className=\"main-view h-full\">\n                <div className=\"flex-grow space-y-4\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n                        <Skeleton className=\"h-64 w-full rounded-lg\" />\n                        <Skeleton className=\"h-64 lg:col-span-2 w-full rounded-lg\" />\n                        <Skeleton className=\"h-64 w-full rounded-lg\" />\n                    </div>\n                    <Skeleton className=\"h-[74px] w-full rounded-lg\" />\n                </div>\n            </div>\n        )\n    }\n\n    const honorLevel = user.entrenamientos?.find(t => t.configuracionEntrenamientoId === 'honor')?.nivel || 0;\n    const propertyCount = user.propiedades?.length || 0;\n    const lealtad = React.useMemo(() => Math.round(calcularPoderAtaque(propertyCount, honorLevel)), [propertyCount, honorLevel]);\n\n    const { puntuacion, familyMember } = user;\n    const unreadMessages = user._count?.receivedMessages || 0;\n    \n    // 🟢 CORRECCIÓN: Se normaliza la obtención de miembros y su estado online.\n    const hasFamily = !!familyMember && !!familyMember.family;\n    const familyMembers = React.useMemo(() => (hasFamily && Array.isArray(familyMember.family.members)) ? familyMember.family.members : [], [hasFamily, familyMember]);\n    const memberCount = familyMembers.length;\n    \n    const membersOnline = React.useMemo(() => familyMembers.filter(m => {\n            const status = getLastSeenStatus(m.user.lastSeen);\n            return status.isOnline;\n        }).length, [familyMembers]);\n    \n    return (\n        <div className=\"main-view h-full\">\n            <div className=\"flex flex-col flex-grow gap-6 animate-fade-in\">\n\n                <IncomingAttacks attacks={user.incomingAttacks || []} />\n                \n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                    <PlayerCard \n                        user={user}\n                        lealtad={lealtad}\n                        troops={selectedProperty.TropaUsuario}\n                    />\n\n                    <Card className=\"group relative overflow-hidden border-border/50 bg-card/50 hover:bg-card hover:border-gold/50 transition-all duration-500 hover:shadow-lg hover:shadow-gold/10 lg:h-full\">\n                        <CardContent className=\"p-0 flex flex-col items-center justify-center h-full relative z-10 min-h-[16rem]\">\n                            {hasFamily ? (\n                                <>\n                                    <div className=\"absolute inset-0 bg-black/60 z-0 group-hover:bg-black/40 transition-colors duration-500\" />\n                                    <Image \n                                        src={familyMember.family.avatarUrl || \"/img/login_bg.jpg\"}\n                                        alt=\"Family Banner\"\n                                        fill\n                                        sizes=\"(max-width: 1024px) 100vw, 33vw\"\n                                        className=\"object-cover -z-10 transition-transform duration-700 ease-in-out group-hover:scale-110 saturate-50 group-hover:saturate-100\"\n                                        data-ai-hint=\"mafia meeting room\"\n                                    />\n\n                                    <div className=\"absolute bottom-0 left-0 p-6 w-full bg-gradient-to-t from-black via-black/80 to-transparent\">\n                                        <div className=\"flex items-end justify-between gap-4\">\n                                            <div>\n                                                <p className=\"text-xs text-gold uppercase tracking-widest font-bold mb-1\">La Familia</p>\n                                                <p className=\"text-3xl font-bold font-heading tracking-tight text-white drop-shadow-lg\">{familyMember.family.name}</p>\n                                                <Badge variant=\"outline\" className=\"mt-2 border-gold/50 text-gold bg-black/50 backdrop-blur-md\">\n                                                    [{familyMember.family.tag}]\n                                                </Badge>\n                                            </div>\n                                            <div className=\"text-right\">\n                                                    <div className=\"flex items-center gap-2 text-xs text-green-400 bg-green-950/30 px-2 py-1 rounded-full border border-green-900/50 backdrop-blur-sm\">\n                                                    <Wifi className=\"h-3 w-3 animate-pulse\" />\n                                                    <span>{membersOnline} / {memberCount}</span>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </>\n                            ) : (\n                                <div className=\"p-4 flex flex-col items-center justify-center gap-4 h-full w-full bg-secondary/20\">\n                                    <Users2 className=\"h-20 w-20 text-muted-foreground opacity-20\" />\n                                    <div className=\"text-center z-10\">\n                                        <p className=\"text-lg font-heading tracking-wide text-foreground\">Lobo Solitario</p>\n                                        <p className=\"text-xs text-muted-foreground mb-4\">Sin lealtades, sin protección.</p>\n                                        <Button asChild size=\"default\" className=\"animate-fade-in bg-primary hover:bg-primary/90\">\n                                            <Link href=\"/family\">\n                                                <UserPlus className=\"mr-2 h-4 w-4\" />\n                                                Unirse a una Familia\n                                            </Link>\n                                        </Button>\n                                    </div>\n                                </div>\n                            )}\n                        </CardContent>\n                        <div className=\"z-20 relative\">\n                            <ActionIcons unreadMessages={unreadMessages} inFamily={!!familyMember} />\n                        </div>\n                        {familyMember && (\n                            <Link href=\"/family\" className=\"absolute inset-0 z-10 focus:outline-none focus:ring-2 focus:ring-gold/50 rounded-lg\">\n                                <span className=\"sr-only\">Ir a la familia</span>\n                            </Link>\n                        )}\n                    </Card>\n                </div>\n                \n                <QueueStatusCard user={user} />\n                <MissionOverview missions={user.misiones} incomingAttacks={user.incomingAttacks || []} />\n\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/buildings/buildings-view.tsx": "\n'use client';\n\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport type { FullPropiedad } from \"@/types\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { updatePropertyDetails } from \"@/lib/actions/user.actions\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ntype PropertyWithPoints = FullPropiedad & { puntos: number };\n\ninterface BuildingsViewProps {\n    initialProperties: PropertyWithPoints[];\n}\n\nfunction formatPoints(points: number): string {\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nexport function BuildingsView({ initialProperties }: BuildingsViewProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const [properties, setProperties] = useState(initialProperties);\n    const [mainPropertyId, setMainPropertyId] = useState(\n        initialProperties.find(p => p.nombre === 'Propiedad Principal')?.id || initialProperties[0]?.id\n    );\n\n    const handleNameChange = (id: string, newName: string) => {\n        setProperties(prev => prev.map(p => p.id === id ? { ...p, nombre: newName } : p));\n    };\n\n    const handleSubmit = () => {\n        startTransition(async () => {\n            const result = await updatePropertyDetails({ properties, mainPropertyId });\n             if (result.serverError || result.validationErrors) {\n                 const msg = result.serverError || (result.validationErrors ? Object.values(result.validationErrors).flat().join(', ') : 'Error desconocido');\n                toast({ variant: 'destructive', title: 'Error', description: msg });\n            } else if (result.data?.success) {\n                toast({ title: 'Éxito', description: result.data.success });\n            }\n        })\n    }\n    \n    return (\n        <Card>\n            <CardContent className=\"p-0\">\n                <form action={handleSubmit}>\n                    <div className=\"overflow-x-auto\">\n                        <Table>\n                            <TableHeader>\n                                <TableRow>\n                                    <TableHead className=\"w-[100px]\">Principal</TableHead>\n                                    <TableHead>Edificio</TableHead>\n                                    <TableHead>Nombre</TableHead>\n                                    <TableHead className=\"text-right\">Puntos</TableHead>\n                                </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                                {properties.map(prop => (\n                                    <TableRow key={prop.id}>\n                                        <TableCell>\n                                            <RadioGroup\n                                                value={mainPropertyId}\n                                                onValueChange={setMainPropertyId}\n                                            >\n                                                <div className=\"flex items-center space-x-2\">\n                                                    <RadioGroupItem value={prop.id} id={`main-${prop.id}`} />\n                                                    <Label htmlFor={`main-${prop.id}`} className=\"sr-only\">\n                                                        Marcar {prop.nombre} como principal\n                                                    </Label>\n                                                </div>\n                                            </RadioGroup>\n                                        </TableCell>\n                                        <TableCell className=\"font-mono text-sm\">\n                                            {prop.ciudad}:{prop.barrio}:{prop.edificio}\n                                        </TableCell>\n                                        <TableCell>\n                                            <Input \n                                                value={prop.nombre}\n                                                onChange={(e) => handleNameChange(prop.id, e.target.value)}\n                                                className=\"max-w-xs\"\n                                                disabled={isPending}\n                                            />\n                                        </TableCell>\n                                        <TableCell className=\"text-right font-mono font-semibold\">\n                                            {formatPoints(prop.puntos)}\n                                        </TableCell>\n                                    </TableRow>\n                                ))}\n                            </TableBody>\n                        </Table>\n                    </div>\n                     <div className=\"p-4 flex justify-end\">\n                        <Button type=\"submit\" disabled={isPending}>\n                            {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/>}\n                            Modificar\n                        </Button>\n                    </div>\n                </form>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/queue-card.tsx": "'use client';\n\nimport { useRouter } from 'next/navigation';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport type { FullColaReclutamiento, FullColaEntrenamiento } from '@/types';\nimport { BrainCircuit, Swords } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { cancelarEntrenamiento } from '@/lib/actions/training.actions';\nimport { cancelarReclutamiento } from '@/lib/actions/troop.actions';\nimport { cn } from '@/lib/utils';\nimport { QueueItem } from './queue-item';\n\ntype QueueType = 'training' | 'recruitment';\n\ninterface EnrichedRecruitment extends FullColaReclutamiento {\n    coords: string;\n    propertyName: string;\n}\n\ninterface EnrichedTraining extends FullColaEntrenamiento {\n    coords: string;\n}\n\ninterface QueueCardProps {\n    queueType: QueueType;\n    activeTrainings?: EnrichedTraining[];\n    activeRecruitments?: EnrichedRecruitment[];\n    className?: string;\n};\n\nexport function QueueCard({ queueType, activeTrainings = [], activeRecruitments = [], className }: QueueCardProps) {\n    const router = useRouter();\n    const { toast } = useToast();\n\n    const handleCancelTraining = async (id: string) => {\n        const result = await cancelarEntrenamiento(id);\n        if (result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n        else toast({ title: 'Entrenamiento Cancelado', description: result.success });\n    };\n    \n    const handleCancelRecruitment = async (id: string) => {\n        const result = await cancelarReclutamiento(id);\n        if (result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n        else toast({ title: 'Reclutamiento Cancelado', description: result.success });\n    };\n\n    const items = queueType === 'training' ? activeTrainings : activeRecruitments;\n    const title = queueType === 'training' ? 'ENTRENAMIENTO' : 'RECLUTAMIENTO';\n    const Icon = queueType === 'training' ? BrainCircuit : Swords;\n\n    if (items.length === 0) {\n        return null;\n    }\n\n    return (\n        <Card className={cn(className)}>\n            <CardHeader className=\"flex-row items-center space-x-3 space-y-0 p-3 bg-muted/20\">\n                <Icon className=\"h-6 w-6 text-primary\"/>\n                <CardTitle className=\"font-heading tracking-wider text-primary\">{title} ({items.length})</CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-2 space-y-1\">\n                {items.map(item => {\n                    const isTraining = 'entrenamiento' in item;\n                    const config = isTraining ? item.entrenamiento : item.tropaConfig;\n                    const label = config.nombre;\n                    const info = isTraining ? `N${item.nivelDestino}` : `x${item.cantidad}`;\n                    const coords = item.coords;\n                    \n                    return (\n                        <QueueItem\n                            key={item.id}\n                            label={label}\n                            info={info}\n                            coords={coords}\n                            endDate={item.fechaFinalizacion}\n                            image={config.urlImagen}\n                            onCancel={() => isTraining ? handleCancelTraining(item.id) : handleCancelRecruitment(item.id)}\n                            onFinish={() => router.refresh()}\n                        />\n                    )\n                })}\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/rooms-view.tsx": "'use client'\n\nimport { Dialog, DialogTrigger, DialogContent } from \"@/components/ui/dialog\"\nimport { Button } from \"@/components/ui/button\"\nimport { PlusCircle, Ban, Info, Loader2 } from \"lucide-react\"\nimport { iniciarAmpliacion } from \"@/lib/actions/room.actions\"\nimport { ConstructionQueue } from \"./construction-queue\"\nimport { useEffect, useState, useTransition, useOptimistic } from \"react\"\nimport { useToast } from \"@/hooks/use-toast\"\nimport { useRouter } from \"next/navigation\"\nimport { RoomDetailsModal } from \"./room-details-modal\"\nimport { calcularCostosNivel, calcularTiempoConstruccion } from \"@/lib/formulas/room-formulas\"\nimport type { FullConfiguracionHabitacion, UserWithProgress, FullPropiedad } from \"@/types\"\nimport { ID_OFICINA_JEFE, MAX_CONSTRUCTION_QUEUE_SIZE } from \"@/lib/constants\"\nimport { getAvailableRoomsForProperty } from \"@/lib/formulas/room-logic\"\nimport { GameCard } from \"@/components/ui/game-card\"\nimport { Card, CardContent } from \"../ui/card\"\n\ntype RoomsViewProps = {\n    user: UserWithProgress;\n    allRoomConfigs: FullConfiguracionHabitacion[];\n    initialProperty: FullPropiedad | undefined;\n}\n\nexport function RoomsView({ user, allRoomConfigs, initialProperty }: RoomsViewProps) {\n    const router = useRouter();\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n\n    const selectedProperty = initialProperty;\n\n    const [optimisticLevels, addOptimisticLevel] = useOptimistic(\n        {} as Record<string, number>,\n        (state, roomId: string) => ({\n             ...state,\n             [roomId]: (state[roomId] || 0) + 1\n        })\n    );\n\n    if (!selectedProperty) {\n      return (\n        <div className=\"main-view\">\n          <h2 className=\"text-3xl font-bold font-heading tracking-tight mb-4\">Gestión de Habitaciones</h2>\n          <Card>\n            <CardContent className=\"p-6 text-muted-foreground\">\n                <p>Por favor, selecciona una propiedad para gestionar sus habitaciones.</p>\n            </CardContent>\n          </Card>\n        </div>\n      )\n    }\n\n    const construccionEnCola = selectedProperty.colaConstruccion;\n    const isQueueFull = construccionEnCola.length >= MAX_CONSTRUCTION_QUEUE_SIZE;\n\n    const handleAmpliacion = (habitacionId: string) => {\n        if (!selectedProperty) return;\n\n        startTransition(async () => {\n            addOptimisticLevel(habitacionId);\n            const resultado = await iniciarAmpliacion({\n                propiedadId: selectedProperty.id,\n                habitacionId: habitacionId\n            });\n\n            if (resultado.validationErrors || resultado.serverError) {\n                toast({\n                    title: \"Error al ampliar\",\n                    description: resultado.serverError || \"Datos inválidos\",\n                    variant: \"destructive\"\n                })\n            } else if (resultado.data?.success) {\n                toast({\n                    title: \"¡Éxito!\",\n                    description: resultado.data.success\n                })\n                // router.refresh(); // handled by action\n            }\n        });\n    }\n\n    const simpleRoomConfigs = allRoomConfigs.map(r => ({ id: r.id, nombre: r.nombre, urlImagen: r.urlImagen }));\n\n    const availableRoomsData = getAvailableRoomsForProperty(selectedProperty, allRoomConfigs);\n    \n    const roomsData = availableRoomsData.map(room => {\n        const mejorasEnCola = construccionEnCola.filter(c => c.habitacionId === room.id).length;\n\n        // Apply optimistic level\n        const optimisticIncrement = optimisticLevels[room.id] || 0;\n        const currentLevel = room.nivel + optimisticIncrement;\n\n        const nivelSiguiente = currentLevel + mejorasEnCola + 1;\n        const nivelOficinaJefe = selectedProperty.habitaciones.find(h => h.configuracionHabitacionId === ID_OFICINA_JEFE)?.nivel || 1;\n        \n        const costosSiguienteNivel = calcularCostosNivel(nivelSiguiente, room.config);\n        const tiempoSiguienteNivel = calcularTiempoConstruccion(nivelSiguiente, room.config, nivelOficinaJefe);\n        \n        const construccionActiva = construccionEnCola[0]?.habitacionId === room.id ? construccionEnCola[0] : undefined;\n        \n        return {\n            ...room,\n            nivel: currentLevel, // Use optimistic level for display\n            nivelSiguiente,\n            costos: costosSiguienteNivel,\n            tiempo: tiempoSiguienteNivel,\n            enConstruccion: mejorasEnCola > 0, // This might not update optimistically unless we also simulate queue addition\n            construccionActiva,\n        };\n    });\n    \n\n    return (\n        <div className=\"space-y-8 pb-10\">\n            <div className=\"mb-8\">\n                <ConstructionQueue propiedad={selectedProperty} allRooms={simpleRoomConfigs} />\n            </div>\n\n            <div className=\"flex flex-col gap-2 border-b border-white/10 pb-4\">\n                <h2 className=\"text-4xl font-bold font-heading uppercase tracking-tighter text-white drop-shadow-md\">\n                    Gestión de <span className=\"text-primary\">Habitaciones</span>\n                </h2>\n                <p className=\"text-muted-foreground\">\n                    Administra las operaciones en <span className=\"text-gold font-semibold\">{selectedProperty.nombre}</span> <span className=\"font-mono text-sm font-semibold text-primary/80\">[{selectedProperty.ciudad}:{selectedProperty.barrio}:{selectedProperty.edificio}]</span>.\n                </p>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n                {roomsData.map((room) => {\n                    const canUpgrade = room.meetsRequirements && !isQueueFull;\n                    const status = !room.meetsRequirements ? 'locked' : (room.enConstruccion ? 'in_progress' : 'available');\n\n                    return (\n                        <Dialog key={room.id}>\n                            <GameCard\n                                title={room.config.nombre}\n                                description={room.config.descripcion || \"Instalación estratégica.\"}\n                                imageSrc={room.config.urlImagen || \"/img/general/building-default.jpg\"}\n                                level={room.nivel}\n                                time={room.tiempo}\n                                cost={{ armas: room.costos.armas, municion: room.costos.municion, dolares: room.costos.dolares }}\n                                status={status}\n                                requirementsText={(!room.meetsRequirements && room.requirementsText) ? room.requirementsText : undefined}\n                                actionButton={\n                                    <div className=\"flex items-center justify-end gap-2 w-full\">\n                                         <DialogTrigger asChild>\n                                            <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 shrink-0\">\n                                                <Info className=\"h-4 w-4 text-muted-foreground\" />\n                                            </Button>\n                                         </DialogTrigger>\n                                        <Button\n                                            onClick={(e) => { e.preventDefault(); handleAmpliacion(room.id); }}\n                                            disabled={isPending || !canUpgrade}\n                                            className=\"flex-1\"\n                                        >\n                                            {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/> : (isQueueFull ? <Ban className=\"mr-2 h-4 w-4\" /> : null)}\n                                            {isQueueFull ? 'COLA LLENA' : `MEJORAR A ${room.nivelSiguiente}`}\n                                        </Button>\n                                    </div>\n                                }\n                            />\n\n                            <DialogContent className=\"sm:max-w-[600px] bg-card border-white/10 text-foreground\">\n                                <RoomDetailsModal room={{...room.config, nivel: room.nivel}} />\n                            </DialogContent>\n                        </Dialog>\n                    )\n                })}\n            </div>\n        </div>\n    )\n}\n",
    "src/components/dashboard/rankings/family-rankings-view.tsx": "\n'use client';\n\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from \"@/components/ui/table\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport type { FullFamily } from \"@/types\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Medal } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport Link from \"next/link\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\ninterface FamilyRankingsViewProps {\n    families: FullFamily[];\n    currentUserFamilyId?: string | null;\n    page: number;\n    pageSize: number;\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nconst medalColors = [\n    \"text-amber-400\", // Gold\n    \"text-slate-400\", // Silver\n    \"text-amber-600\"  // Bronze\n];\n\nexport function FamilyRankingsView({ families, currentUserFamilyId, page, pageSize }: FamilyRankingsViewProps) {\n    if (!families || families.length === 0) {\n        return (\n             <Card>\n                <CardContent className=\"p-6 text-center text-muted-foreground\">\n                    No hay familias en la clasificación.\n                </CardContent>\n            </Card>\n        )\n    }\n\n    // You might need to calculate total points for families in the future\n    const sortedFamilies = families; //.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));\n\n    return (\n        <div className=\"animate-fade-in\">\n            <Card className=\"mt-4\">\n                <CardContent className=\"p-0\">\n                    {/* Desktop Table */}\n                    <Table className=\"hidden md:table\">\n                        <TableHeader>\n                            <TableRow className=\"bg-muted/50 hover:bg-muted/80\">\n                                <TableHead className=\"w-[80px] font-bold\">#</TableHead>\n                                <TableHead className=\"font-bold\">NOMBRE</TableHead>\n                                <TableHead className=\"text-right font-bold\">PUNTOS TOTALES</TableHead>\n                                <TableHead className=\"text-right font-bold\">MIEMBROS</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {sortedFamilies.map((family, index) => {\n                                const rank = page * pageSize + index + 1;\n                                return (\n                                <TableRow key={family.id} className={cn(family.id === currentUserFamilyId && \"bg-primary/10 hover:bg-primary/20\")}>\n                                    <TableCell className=\"font-medium text-lg flex items-center gap-2\">\n                                        {rank <= 3 && <Medal className={cn(\"h-5 w-5\", medalColors[rank - 1])} />}\n                                        {rank}\n                                    </TableCell>\n                                    <TableCell className=\"font-bold\">\n                                         <Link href={`/family/members?id=${family.id}`} className=\"hover:underline flex items-center gap-3\">\n                                             <Avatar className=\"h-10 w-10\">\n                                                <AvatarImage src={family.avatarUrl || ''} />\n                                                <AvatarFallback>{family.tag}</AvatarFallback>\n                                            </Avatar>\n                                            <span>[{family.tag}] {family.name}</span>\n                                        </Link>\n                                    </TableCell>\n                                    <TableCell className=\"text-right font-bold text-primary font-mono\">{formatPoints(0)}</TableCell>\n                                    <TableCell className=\"text-right font-mono\">{family.members.length}</TableCell>\n                                </TableRow>\n                            )})}\n                        </TableBody>\n                    </Table>\n                     {/* Mobile Cards */}\n                    <div className=\"md:hidden\">\n                        <div className=\"space-y-2 p-2\">\n                            {sortedFamilies.map((family, index) => {\n                                const rank = page * pageSize + index + 1;\n                                return (\n                                <Card key={family.id} className={cn(\"p-4\", family.id === currentUserFamilyId && \"bg-primary/10 border-primary/20\")}>\n                                     <div className=\"flex justify-between items-center\">\n                                        <div className=\"flex items-center gap-4\">\n                                            <span className=\"text-lg font-bold text-muted-foreground w-8 flex items-center gap-1\">\n                                                {rank <= 3 && <Medal className={cn(\"h-5 w-5\", medalColors[rank-1])} />}\n                                                #{rank}\n                                            </span>\n                                            <Link href={`/family/members?id=${family.id}`} className=\"hover:underline\">\n                                                <span className=\"font-bold text-lg\">[{family.tag}] {family.name}</span>\n                                            </Link>\n                                        </div>\n                                         <div className=\"text-right\">\n                                            <div className=\"font-bold text-primary text-lg\">{formatPoints(0)}</div>\n                                            <div className=\"text-xs text-muted-foreground\">Puntos</div>\n                                        </div>\n                                    </div>\n                                    <Separator className=\"my-3\" />\n                                     <div className=\"text-right text-sm\">\n                                        <span className=\"text-muted-foreground\">Miembros:</span>\n                                        <span className=\"font-semibold ml-2\">{family.members.length}</span>\n                                    </div>\n                                </Card>\n                            )})}\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n",
    "src/components/dashboard/rankings/honor-rankings-view.tsx": "'use client';\n\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from \"@/components/ui/table\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport type { UserForRanking } from \"@/types\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Link from \"next/link\";\nimport { Medal } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface HonorRankingsViewProps {\n    users: UserForRanking[];\n    currentUserId: string;\n    page: number;\n    pageSize: number;\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nconst medalColors = [\n    \"text-amber-400\", // Gold\n    \"text-slate-400\", // Silver\n    \"text-amber-600\"  // Bronze\n];\n\nexport function HonorRankingsView({ users, currentUserId, page, pageSize }: HonorRankingsViewProps) {\n    return (\n        <div className=\"animate-fade-in\">\n            <Card className=\"mt-4\">\n                <CardContent className=\"p-0\">\n                    {/* Desktop Table */}\n                    <Table className=\"hidden md:table\">\n                        <TableHeader>\n                            <TableRow className=\"bg-muted/50 hover:bg-muted/80\">\n                                <TableHead className=\"w-[80px] font-bold\">#</TableHead>\n                                <TableHead className=\"font-bold\">NOMBRE</TableHead>\n                                <TableHead className=\"text-right font-bold\">PUNTOS DE HONOR (ATAQUE)</TableHead>\n                                <TableHead className=\"text-right font-bold\">PUNTOS DE HONOR (DEFENSA)</TableHead>\n                                <TableHead className=\"text-right font-bold\">HONOR TOTAL</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {users.map((user, index) => {\n                                const rank = page * pageSize + index + 1;\n                                return (\n                                <TableRow key={user.id} className={cn(user.id === currentUserId && \"bg-primary/10 hover:bg-primary/20\")}>\n                                    <TableCell className=\"font-medium text-lg flex items-center gap-2\">\n                                        {rank <= 3 && <Medal className={cn(\"h-5 w-5\", medalColors[rank - 1])} />}\n                                        {rank}\n                                    </TableCell>\n                                    <TableCell className=\"font-bold\">\n                                        <Link href={`/profile/${user.id}`} className=\"hover:underline\">\n                                            {user.name}\n                                        </Link>\n                                    </TableCell>\n                                    <TableCell className=\"text-right font-mono\">{formatPoints(user.puntuacion?.puntosHonorAtacante)}</TableCell>\n                                    <TableCell className=\"text-right font-mono\">{formatPoints(user.puntuacion?.puntosHonorDefensor)}</TableCell>\n                                    <TableCell className=\"text-right font-bold text-primary font-mono\">{formatPoints(user.puntuacion?.puntosHonorTotales)}</TableCell>\n                                </TableRow>\n                            )})}\n                        </TableBody>\n                    </Table>\n\n                    {/* Mobile Cards */}\n                    <div className=\"md:hidden\">\n                        <div className=\"space-y-2 p-2\">\n                            {users.map((user, index) => {\n                                const rank = page * pageSize + index + 1;\n                                return (\n                                <Card key={user.id} className={cn(\"p-4\", user.id === currentUserId && \"bg-primary/10 border-primary/20\")}>\n                                    <div className=\"flex justify-between items-center\">\n                                        <div className=\"flex items-center gap-4\">\n                                            <span className=\"text-lg font-bold text-muted-foreground w-8 flex items-center gap-1\">\n                                                {rank <= 3 && <Medal className={cn(\"h-5 w-5\", medalColors[rank - 1])} />}\n                                                #{rank}\n                                            </span>\n                                            <Link href={`/profile/${user.id}`} className=\"hover:underline\">\n                                                <span className=\"font-bold text-lg\">{user.name}</span>\n                                            </Link>\n                                        </div>\n                                        <div className=\"text-right\">\n                                            <div className=\"font-bold text-primary text-lg\">{formatPoints(user.puntuacion?.puntosHonorTotales)}</div>\n                                            <div className=\"text-xs text-muted-foreground\">Honor Total</div>\n                                        </div>\n                                    </div>\n                                    <Separator className=\"my-3\" />\n                                    <div className=\"grid grid-cols-2 gap-x-4 gap-y-2 text-sm\">\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-muted-foreground\">Honor (Ataque):</span>\n                                            <span className=\"font-semibold\">{formatPoints(user.puntuacion?.puntosHonorAtacante)}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-muted-foreground\">Honor (Defensa):</span>\n                                            <span className=\"font-semibold\">{formatPoints(user.puntuacion?.puntosHonorDefensor)}</span>\n                                        </div>\n                                    </div>\n                                </Card>\n                            )})}\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n",
    "src/components/dashboard/rankings/player-rankings-view.tsx": "'use client';\n\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from \"@/components/ui/table\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport type { UserForRanking } from \"@/types\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Link from \"next/link\";\nimport { Medal } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface PlayerRankingsViewProps {\n    users: UserForRanking[];\n    currentUserId: string;\n    page: number;\n    pageSize: number;\n}\n\nfunction formatPoints(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nconst medalColors = [\n    \"text-amber-400\", // Gold\n    \"text-slate-400\", // Silver\n    \"text-amber-600\"  // Bronze\n];\n\nexport function PlayerRankingsView({ users, currentUserId, page, pageSize }: PlayerRankingsViewProps) {\n    return (\n        <div className=\"animate-fade-in\">\n            <Card className=\"mt-4\">\n                <CardContent className=\"p-0\">\n                    {/* Vista de Tabla para Escritorio */}\n                    <Table className=\"hidden md:table\">\n                        <TableHeader>\n                            <TableRow className=\"bg-muted/50 hover:bg-muted/80\">\n                                <TableHead className=\"w-[80px] font-bold\">#</TableHead>\n                                <TableHead className=\"font-bold\">NOMBRE</TableHead>\n                                <TableHead className=\"text-right font-bold\">PUNTOS (ENTRÉN.)</TableHead>\n                                <TableHead className=\"text-right font-bold\">PUNTOS (EDIFICIOS)</TableHead>\n                                <TableHead className=\"text-right font-bold\">PUNTOS (TROPAS)</TableHead>\n                                <TableHead className=\"text-right font-bold\">SUMA</TableHead>\n                                <TableHead className=\"text-right font-bold\">PROPIEDADES</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {users.map((user, index) => {\n                                const rank = page * pageSize + index + 1;\n                                return (\n                                <TableRow key={user.id} className={cn(user.id === currentUserId && \"bg-primary/10 hover:bg-primary/20\")}>\n                                    <TableCell className=\"font-medium text-lg flex items-center gap-2\">\n                                        {rank <= 3 && <Medal className={cn(\"h-5 w-5\", medalColors[rank - 1])} />}\n                                        {rank}\n                                    </TableCell>\n                                    <TableCell className=\"font-bold\">\n                                        <Link href={`/profile/${user.id}`} className=\"hover:underline\">\n                                            {user.name}\n                                        </Link>\n                                    </TableCell>\n                                    <TableCell className=\"text-right font-mono\">{formatPoints(user.puntuacion?.puntosEntrenamientos)}</TableCell>\n                                    <TableCell className=\"text-right font-mono\">{formatPoints(user.puntuacion?.puntosHabitaciones)}</TableCell>\n                                    <TableCell className=\"text-right font-mono\">{formatPoints(user.puntuacion?.puntosTropas)}</TableCell>\n                                    <TableCell className=\"text-right font-bold text-primary font-mono\">{formatPoints(user.puntuacion?.puntosTotales)}</TableCell>\n                                    <TableCell className=\"text-right font-mono\">{user._count.propiedades}</TableCell>\n                                </TableRow>\n                            )})}\n                        </TableBody>\n                    </Table>\n\n                    {/* Vista de Tarjetas para Móvil */}\n                    <div className=\"md:hidden\">\n                        <div className=\"space-y-2 p-2\">\n                            {users.map((user, index) => {\n                                const rank = page * pageSize + index + 1;\n                                return (\n                                <Card key={user.id} className={cn(\"p-4\", user.id === currentUserId && \"bg-primary/10 border-primary/20\")}>\n                                    <div className=\"flex justify-between items-center\">\n                                        <div className=\"flex items-center gap-4\">\n                                            <span className=\"text-lg font-bold text-muted-foreground w-8 flex items-center gap-1\">\n                                                {rank <= 3 && <Medal className={cn(\"h-5 w-5\", medalColors[rank - 1])} />}\n                                                #{rank}\n                                            </span>\n                                            <Link href={`/profile/${user.id}`} className=\"hover:underline\">\n                                                <span className=\"font-bold text-lg\">{user.name}</span>\n                                            </Link>\n                                        </div>\n                                        <div className=\"text-right\">\n                                            <div className=\"font-bold text-primary text-lg\">{formatPoints(user.puntuacion?.puntosTotales)}</div>\n                                            <div className=\"text-xs text-muted-foreground\">Puntos Totales</div>\n                                        </div>\n                                    </div>\n                                    <Separator className=\"my-3\" />\n                                    <div className=\"grid grid-cols-2 gap-x-4 gap-y-2 text-sm\">\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-muted-foreground\">Entrenamiento:</span>\n                                            <span className=\"font-semibold\">{formatPoints(user.puntuacion?.puntosEntrenamientos)}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-muted-foreground\">Edificios:</span>\n                                            <span className=\"font-semibold\">{formatPoints(user.puntuacion?.puntosHabitaciones)}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-muted-foreground\">Tropas:</span>\n                                            <span className=\"font-semibold\">{formatPoints(user.puntuacion?.puntosTropas)}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-muted-foreground\">Propiedades:</span>\n                                            <span className=\"font-semibold\">{user._count.propiedades}</span>\n                                        </div>\n                                    </div>\n                                </Card>\n                            )})}\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    )\n}\n",
    "src/components/dashboard/rankings/battles-rankings-view.tsx": "\n'use client';\n\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from \"@/components/ui/table\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Link from \"next/link\";\nimport { Swords } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { FullBattleReport } from \"@/types\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport type { BattleSimulationResult } from '@/types/simulation.types';\n\ninterface BattlesRankingsViewProps {\n    reports: FullBattleReport[];\n    currentUserId: string;\n}\n\nfunction formatNumber(points: number | null | undefined): string {\n    if (points === null || points === undefined) return \"0\";\n    return Math.floor(points).toLocaleString('de-DE');\n}\n\nexport function BattlesRankingsView({ reports }: BattlesRankingsViewProps) {\n    const processedReports = reports.map(report => {\n        const details = report.details as unknown as BattleSimulationResult;\n        const totalTropasDestruidas = (details?.finalStats?.attacker.troopsLost ?? 0) + (details?.finalStats?.defender.troopsLost ?? 0);\n        const totalPuntosDestruidos = (details?.finalStats?.attacker.pointsLost ?? 0) + (details?.finalStats?.defender.pointsLost ?? 0);\n        return {\n            ...report,\n            totalTropasDestruidas,\n            totalPuntosDestruidos\n        };\n    });\n    \n    return (\n        <div className=\"animate-fade-in\">\n            <Card className=\"mt-4\">\n                <CardContent className=\"p-0\">\n                    {/* Desktop Table */}\n                    <Table className=\"hidden md:table\">\n                        <TableHeader>\n                            <TableRow className=\"bg-muted/50 hover:bg-muted/80\">\n                                <TableHead className=\"w-[50px] font-bold\">#</TableHead>\n                                <TableHead className=\"font-bold\">Agresor</TableHead>\n                                <TableHead className=\"w-[20px]\"></TableHead>\n                                <TableHead className=\"font-bold\">Defensor</TableHead>\n                                <TableHead className=\"text-right font-bold\">Tropas Destruidas</TableHead>\n                                <TableHead className=\"text-right font-bold\">Puntos Destruidos</TableHead>\n                                <TableHead className=\"text-right font-bold\">Día</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {processedReports.map((report, index) => (\n                                <TableRow key={report.id}>\n                                    <TableCell className=\"font-medium text-muted-foreground\">{index + 1}</TableCell>\n                                    <TableCell>\n                                        <Link href={`/profile/${report.attacker.id}`} className=\"flex items-center gap-2 hover:underline text-green-400 font-semibold\">\n                                            <Avatar className=\"h-8 w-8\"><AvatarImage src={report.attacker.avatarUrl || ''} /><AvatarFallback>{report.attacker.name.charAt(0)}</AvatarFallback></Avatar>\n                                            {report.attacker.name}\n                                        </Link>\n                                    </TableCell>\n                                    <TableCell className=\"font-bold text-destructive\">vs</TableCell>\n                                    <TableCell>\n                                         <Link href={`/profile/${report.defender.id}`} className=\"flex items-center gap-2 hover:underline text-red-400 font-semibold\">\n                                            <Avatar className=\"h-8 w-8\"><AvatarImage src={report.defender.avatarUrl || ''} /><AvatarFallback>{report.defender.name.charAt(0)}</AvatarFallback></Avatar>\n                                            {report.defender.name}\n                                        </Link>\n                                    </TableCell>\n                                    <TableCell className=\"text-right font-mono\">{formatNumber(report.totalTropasDestruidas)}</TableCell>\n                                    <TableCell className=\"text-right font-mono text-primary\">{formatNumber(report.totalPuntosDestruidos)}</TableCell>\n                                    <TableCell className=\"text-right text-xs text-muted-foreground\">{new Date(report.created_at).toLocaleDateString()}</TableCell>\n                                </TableRow>\n                            ))}\n                        </TableBody>\n                    </Table>\n                    {/* Mobile Cards */}\n                     <div className=\"md:hidden space-y-2 p-2\">\n                        {processedReports.map((report, index) => (\n                            <Card key={report.id} className=\"p-4\">\n                                <div className=\"flex justify-between items-center text-sm\">\n                                    <Link href={`/profile/${report.attacker.id}`} className=\"font-semibold text-green-400 hover:underline\">{report.attacker.name}</Link>\n                                    <Swords className=\"h-5 w-5 text-destructive\" />\n                                    <Link href={`/profile/${report.defender.id}`} className=\"font-semibold text-red-400 hover:underline\">{report.defender.name}</Link>\n                                </div>\n                                <Separator className=\"my-3\"/>\n                                <div className=\"space-y-1 text-xs\">\n                                    <div className=\"flex justify-between\"><span>Tropas Destruidas:</span><span className=\"font-semibold font-mono\">{formatNumber(report.totalTropasDestruidas)}</span></div>\n                                    <div className=\"flex justify-between\"><span>Puntos Destruidos:</span><span className=\"font-semibold font-mono\">{formatNumber(report.totalPuntosDestruidos)}</span></div>\n                                    <div className=\"flex justify-between\"><span>Fecha:</span><span className=\"font-semibold font-mono\">{new Date(report.created_at).toLocaleString()}</span></div>\n                                </div>\n                            </Card>\n                        ))}\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n",
    "src/components/dashboard/rankings/ranking-type-selector.tsx": "\n'use client';\n\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useRouter, usePathname, useSearchParams } from \"next/navigation\";\n\nconst categories = [\n    { value: '0', label: 'Jugadores' },\n    { value: '1', label: 'Familias' },\n    { value: '2', label: 'Honor' },\n    { value: '3', label: 'Batallas' }\n];\n\nconst ranges = [\n    { value: '0', label: '1-100' },\n    { value: '1', label: '101-200' },\n    { value: '2', label: '201-300' },\n    { value: '3', label: '301-400' },\n    { value: '4', label: '401-500' },\n];\n\nexport function RankingTypeSelector() {\n    const router = useRouter();\n    const pathname = usePathname();\n    const searchParams = useSearchParams();\n    \n    const currentType = searchParams.get('type') || '0';\n    const currentRange = searchParams.get('range') || '0';\n    const isBattleRanking = currentType === '3';\n\n    const handleValueChange = (key: 'type' | 'range', value: string) => {\n        const params = new URLSearchParams(searchParams);\n        if (key === 'type') {\n            // Reset range when type changes\n            params.set('type', value);\n            params.delete('range');\n        } else {\n            params.set('range', value);\n        }\n        router.push(`${pathname}?${params.toString()}`);\n    };\n\n    return (\n        <div className=\"flex flex-col gap-2 w-full\">\n             <Tabs value={currentType} onValueChange={(value) => handleValueChange('type', value)} className=\"w-full\">\n                <TabsList className=\"flex flex-wrap h-auto justify-start sm:justify-center\">\n                    {categories.map(cat => (\n                        <TabsTrigger key={cat.value} value={cat.value} className=\"flex-grow sm:flex-grow-0\">{cat.label}</TabsTrigger>\n                    ))}\n                </TabsList>\n            </Tabs>\n             {!isBattleRanking && (\n                <Tabs value={currentRange} onValueChange={(value) => handleValueChange('range', value)} className=\"w-full\">\n                    <TabsList className=\"grid w-full grid-cols-2 sm:grid-cols-5\">\n                        {ranges.map(range => (\n                            <TabsTrigger key={range.value} value={range.value}>{range.label}</TabsTrigger>\n                        ))}\n                    </TabsList>\n                </Tabs>\n             )}\n        </div>\n    );\n}\n",
    "src/components/dashboard/recruitment-view.tsx": "\n\n'use client'\n\nimport { Button } from \"@/components/ui/button\"\nimport { PlusCircle, Loader2, Info } from \"lucide-react\"\nimport { iniciarReclutamiento } from \"@/lib/actions/troop.actions\"\nimport { useState, useMemo, useTransition } from \"react\"\nimport { Input } from \"../ui/input\"\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"../ui/dialog\"\nimport { TroopDetailsModal } from \"./troop-details-modal\"\nimport { RECRUITMENT_TROOP_ORDER, TROOP_TYPE_DEFENSE, resourceIcons } from \"@/lib/constants\"\nimport { formatNumber, cn } from \"@/lib/utils\"\nimport type { UserWithProgress, FullConfiguracionTropa, FullTropaUsuario, FullPropiedad, FullColaReclutamiento } from \"@/types\"\nimport { GameCard } from \"@/components/ui/game-card\" \nimport { useToast } from \"@/hooks/use-toast\"\nimport Image from \"next/image\"\nimport { calcularStatsTropa } from \"@/lib/formulas/troop-formulas\"\nimport { useRouter } from \"next/navigation\"\nimport { QueueCard } from \"./queue-card\"\nimport { Minus, Plus } from \"lucide-react\"\n\n\ntype TroopWithStats = FullConfiguracionTropa & {\n    ataqueActual: number;\n    defensaActual: number;\n    capacidadActual: number;\n    velocidadActual: number;\n    salarioActual: number;\n}\n\ntype RecruitmentViewProps = {\n    troopConfigs: FullConfiguracionTropa[];\n    user: UserWithProgress;\n    selectedProperty: FullPropiedad;\n}\n\nfunction RecruitForm({ troop, onRecruit, onClose, selectedProperty }: { troop: TroopWithStats, onRecruit: (troopId: string, amount: number) => void, onClose: () => void, selectedProperty: FullPropiedad }) {\n    const [cantidad, setCantidad] = useState(1);\n    \n    // Calculate total costs\n    const totalArmas = Number(troop.costoArmas || 0) * cantidad;\n    const totalMunicion = Number(troop.costoMunicion || 0) * cantidad;\n    const totalDolares = Number(troop.costoDolares || 0) * cantidad;\n    \n    // Check resources\n    const userArmas = selectedProperty?.armas || 0;\n    const userMunicion = selectedProperty?.municion || 0;\n    const userDolares = selectedProperty?.dolares || 0;\n    \n    const canAfford = userArmas >= totalArmas && userMunicion >= totalMunicion && userDolares >= totalDolares;\n    const colaReclutamientoActiva = selectedProperty?.colaReclutamiento && selectedProperty.colaReclutamiento.length > 0;\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        onRecruit(troop.id, cantidad);\n    }\n    \n    return (\n        <div className=\"flex flex-col gap-6 p-6\">\n             <div className=\"flex items-center gap-4\">\n                <div className=\"relative h-20 w-20 shrink-0 overflow-hidden rounded-md border border-white/10\">\n                     <Image src={troop.urlImagen || \"/img/general/building-default.jpg\"} alt={troop.nombre} fill className=\"object-cover\" />\n                </div>\n                <div>\n                     <h3 className=\"text-xl font-heading tracking-wide text-white\">{troop.nombre}</h3>\n                     <p className=\"text-sm text-muted-foreground\">{troop.descripcion}</p>\n                </div>\n             </div>\n             \n             <div className=\"grid grid-cols-3 gap-4 rounded-lg bg-black/40 p-4 border border-white/5\">\n                <div className={cn(\"flex flex-col items-center gap-1\", userArmas < totalArmas ? \"text-destructive\" : \"text-zinc-300\")}>\n                     <Image src={resourceIcons.armas} width={20} height={20} alt=\"Armas\" />\n                     <span className=\"font-mono text-sm font-bold\">{formatNumber(totalArmas)}</span>\n                </div>\n                <div className={cn(\"flex flex-col items-center gap-1\", userMunicion < totalMunicion ? \"text-destructive\" : \"text-zinc-300\")}>\n                     <Image src={resourceIcons.municion} width={20} height={20} alt=\"Municion\" />\n                     <span className=\"font-mono text-sm font-bold\">{formatNumber(totalMunicion)}</span>\n                </div>\n                <div className={cn(\"flex flex-col items-center gap-1\", userDolares < totalDolares ? \"text-destructive\" : \"text-zinc-300\")}>\n                     <Image src={resourceIcons.dolares} width={20} height={20} alt=\"Dolares\" />\n                     <span className=\"font-mono text-sm font-bold\">{formatNumber(totalDolares)}</span>\n                </div>\n             </div>\n\n             <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium text-zinc-400\">Cantidad a reclutar</label>\n                    <div className=\"flex items-center gap-2\">\n                        <Input \n                            type=\"number\"\n                            min=\"1\"\n                            max=\"1000\"\n                            value={cantidad}\n                            onChange={(e) => setCantidad(Math.max(1, Number(e.target.value)))}\n                            className=\"text-lg font-mono bg-black/20 border-white/10\"\n                            disabled={colaReclutamientoActiva}\n                        />\n                         <Button \n                            type=\"button\" \n                            variant=\"outline\" \n                            onClick={() => {\n                                const maxArmas = Number(troop.costoArmas) > 0 ? Math.floor(userArmas / Number(troop.costoArmas)) : Infinity;\n                                const maxMunicion = Number(troop.costoMunicion) > 0 ? Math.floor(userMunicion / Number(troop.costoMunicion)) : Infinity;\n                                const maxDolares = Number(troop.costoDolares) > 0 ? Math.floor(userDolares / Number(troop.costoDolares)) : Infinity;\n                                const max = Math.min(maxArmas, maxMunicion, maxDolares);\n                                const safeMax = max === Infinity ? 100 : max;\n                                setCantidad(Math.max(1, safeMax));\n                            }}\n                            className=\"font-mono border-white/10 hover:bg-white/5\"\n                        >\n                            Max\n                        </Button>\n                    </div>\n                </div>\n\n                <div className=\"flex gap-2 justify-end pt-2\">\n                     <Button type=\"button\" variant=\"ghost\" onClick={onClose}>Cancelar</Button>\n                     <Button \n                        type=\"submit\" \n                        disabled={!canAfford || !!colaReclutamientoActiva}\n                        className=\"bg-primary text-primary-foreground hover:bg-primary/90 min-w-[120px]\"\n                     >\n                        <PlusCircle className=\"h-4 w-4 mr-2\" />\n                        Reclutar\n                     </Button>\n                </div>\n             </form>\n             \n             {colaReclutamientoActiva && (\n                 <p className=\"text-xs text-destructive text-center\">Ya hay un reclutamiento en curso.</p>\n             )}\n             {!canAfford && !colaReclutamientoActiva && (\n                 <p className=\"text-xs text-destructive text-center\">Recursos insuficientes.</p>\n             )}\n        </div>\n    )\n}\n\nexport function RecruitmentView({ user, troopConfigs, selectedProperty }: RecruitmentViewProps) {\n  const [isSubmitting, startTransition] = useTransition();\n  const { toast } = useToast();\n  const router = useRouter();\n  \n  const [selectedTroop, setSelectedTroop] = useState<TroopWithStats | null>(null);\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [dialogMode, setDialogMode] = useState<'recruit' | 'details'>('recruit');\n\n  const troopConfigsWithStats = useMemo(() => {\n    const userTrainingsMap: Record<string, number> = {};\n    if (user.entrenamientos) {\n        user.entrenamientos.forEach(t => {\n            userTrainingsMap[t.configuracionEntrenamientoId] = t.nivel;\n        });\n    }\n\n    return troopConfigs.map(config => {\n        const { ataqueActual, defensaActual, capacidadActual, velocidadActual, salarioActual } = calcularStatsTropa(config, userTrainingsMap);\n        return {\n            ...config,\n            ataqueActual,\n            defensaActual,\n            capacidadActual,\n            velocidadActual,\n            salarioActual: salarioActual || config.salario,\n        }\n    });\n  }, [troopConfigs, user.entrenamientos]);\n\n  if (!selectedProperty) {\n    return (\n      <div className=\"p-4 text-center\">\n          <p>Por favor, selecciona una propiedad para reclutar tropas.</p>\n      </div>\n    )\n  }\n\n  const handleRecruitSubmit = (troopId: string, amount: number) => {\n      startTransition(async () => {\n          const result = await iniciarReclutamiento(selectedProperty.id, troopId, amount);\n          if (result.error) {\n              toast({ title: \"Error\", description: result.error, variant: \"destructive\" });\n          } else {\n              toast({ title: \"Reclutamiento iniciado\", description: `Has ordenado el reclutamiento de tropas.` });\n              setDialogOpen(false);\n              router.refresh();\n          }\n      });\n  }\n\n  const handleOpenRecruit = (troop: TroopWithStats) => {\n      setSelectedTroop(troop);\n      setDialogMode('recruit');\n      setDialogOpen(true);\n  }\n\n  const handleOpenDetails = (troop: TroopWithStats) => {\n      setSelectedTroop(troop);\n      setDialogMode('details');\n      setDialogOpen(true);\n  }\n\n  const userTroopsMap = new Map(selectedProperty.TropaUsuario.map((t: FullTropaUsuario) => [t.configuracionTropa.id, t]));\n  const userTrainingsMap = new Map(user.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel]));\n\n  const troopsData = troopConfigsWithStats.map(config => {\n    const userTropa = userTroopsMap.get(config.id);\n    const requirements = (config.requisitos || []) as unknown as { id: string; lvl: number }[];\n    const meetsRequirements = requirements.every(req => (userTrainingsMap.get(req.id) || 0) >= req.lvl);\n    \n    const requirementsText = !meetsRequirements\n        ? \"Requiere: \" + requirements.map(req => {\n            const trainingName = user.entrenamientos.find(e => e.configuracionEntrenamientoId === req.id)?.configuracionEntrenamiento.nombre || req.id;\n            return `${trainingName} (Nvl ${req.lvl})`;\n        }).join(', ')\n        : undefined;\n\n    return {\n      config,\n      count: userTropa?.cantidad || 0,\n      meetsRequirements,\n      requirementsText,\n    }\n  });\n\n  const sortedTroops = [...troopsData]\n    .filter(t => t.config.tipo !== TROOP_TYPE_DEFENSE)\n    .sort((a, b) => {\n        if (a.meetsRequirements && !b.meetsRequirements) return -1;\n        if (!a.meetsRequirements && b.meetsRequirements) return 1;\n\n        const indexA = RECRUITMENT_TROOP_ORDER.indexOf(a.config.id);\n        const indexB = RECRUITMENT_TROOP_ORDER.indexOf(b.config.id);\n        if (indexA === -1) return 1;\n        if (indexB === -1) return -1;\n        return indexA - indexB;\n    });\n  \n    const activeRecruitments = useMemo(() => {\n        if (selectedProperty?.colaReclutamiento && Array.isArray(selectedProperty.colaReclutamiento)) {\n            return selectedProperty.colaReclutamiento.map(r => ({\n                ...r,\n                coords: `${selectedProperty.ciudad}:${selectedProperty.barrio}:${selectedProperty.edificio}`,\n                propertyName: selectedProperty.nombre\n            }));\n        }\n        return [];\n    }, [selectedProperty]);\n\n  return (\n    <div className=\"space-y-6\">\n       <div className=\"flex items-center justify-between\">\n            <div>\n                <h2 className=\"text-3xl font-bold tracking-tight\">Reclutamiento</h2>\n                <p className=\"text-muted-foreground\">\n                    Gestiona tu ejército en: <span className=\"font-semibold text-gold\">{selectedProperty.nombre}</span> <span className=\"font-mono text-sm font-semibold text-primary/80\">[{selectedProperty.ciudad}:{selectedProperty.barrio}:{selectedProperty.edificio}]</span>\n                </p>\n            </div>\n       </div>\n       \n       <QueueCard queueType=\"recruitment\" activeRecruitments={activeRecruitments} />\n\n       <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n          {sortedTroops.map(({ config, meetsRequirements, requirementsText }) => {\n                return (\n                    <Dialog key={config.id} open={dialogOpen && selectedTroop?.id === config.id} onOpenChange={(open) => { if (!open) setDialogOpen(false)}}>\n                        <GameCard\n                            title={config.nombre}\n                            description={config.descripcion || \"Unidad de combate especializada.\"}\n                            imageSrc={config.urlImagen || \"/img/general/building-default.jpg\"}\n                            status={!meetsRequirements ? \"locked\" : \"available\"}\n                            requirementsText={requirementsText}\n                            actionButton={\n                                <div className=\"flex items-center justify-end gap-2 w-full\">\n                                    <DialogTrigger asChild>\n                                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 shrink-0\" onClick={() => handleOpenDetails(config as TroopWithStats)}>\n                                            <Info className=\"h-4 w-4 text-muted-foreground\" />\n                                        </Button>\n                                    </DialogTrigger>\n                                    <Button\n                                        onClick={(e) => { e.preventDefault(); handleOpenRecruit(config as TroopWithStats); }}\n                                        disabled={isSubmitting || !meetsRequirements}\n                                        className=\"flex-1\"\n                                    >\n                                        {isSubmitting ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/> : null}\n                                        RECLUTAR\n                                    </Button>\n                                </div>\n                            }\n                        />\n                         {selectedTroop?.id === config.id && dialogMode === 'details' && (\n                            <TroopDetailsModal \n                                troop={selectedTroop} \n                                user={user}\n                                ataqueActual={selectedTroop.ataqueActual}\n                                defensaActual={selectedTroop.defensaActual}\n                                capacidadActual={selectedTroop.capacidadActual}\n                                velocidadActual={selectedTroop.velocidadActual}\n                                salarioActual={selectedTroop.salarioActual}\n                            />\n                        )}\n                        {selectedTroop?.id === config.id && dialogMode === 'recruit' && (\n                            <DialogContent className=\"sm:max-w-[600px] bg-card border-white/10 text-foreground p-0 gap-0 overflow-hidden\">\n                                <DialogHeader className=\"p-6 pb-0\">\n                                    <DialogTitle className=\"sr-only\">Reclutar {selectedTroop.nombre}</DialogTitle>\n                                </DialogHeader>\n                                <RecruitForm \n                                    troop={selectedTroop} \n                                    onRecruit={handleRecruitSubmit} \n                                    onClose={() => setDialogOpen(false)}\n                                    selectedProperty={selectedProperty}\n                                />\n                            </DialogContent>\n                        )}\n                    </Dialog>\n                )\n            })}\n        </div>\n    </div>\n  );\n}\n",
    "src/components/dashboard/missions/mission-details-view.tsx": "\n'use client'\n\nimport { useState, useEffect, useMemo, useTransition } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport type { ColaMisiones, IncomingAttack, FullConfiguracionTropa } from \"@/types\";\nimport { ArrowLeftRight, Check, Loader2, Shield, Swords, Undo2, Users, X, Calculator } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { cancelarMision } from \"@/lib/actions/cancel-mission.action\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { useRouter } from \"next/navigation\";\nimport { convertirACoordenadasVirtuales, calcularDistancia, calcularCosteMision, calcularDuracionViaje } from \"@/lib/formulas/mission-formulas\";\n\n// Componente Cliente para evitar Hydration Mismatch en fechas\nfunction ClientSideDate({ date }: { date: Date | string }) {\n    const [formattedDate, setFormattedDate] = useState('');\n\n    useEffect(() => {\n        setFormattedDate(new Date(date).toLocaleString('es-ES'));\n    }, [date]);\n\n    return <>{formattedDate}</>;\n}\n\n\ninterface MissionDetailsViewProps {\n    missions: ColaMisiones[];\n    incomingAttacks: IncomingAttack[];\n    troopConfigs: FullConfiguracionTropa[];\n}\n\nconst missionIcons: { [key: string]: React.ReactNode } = {\n    ATAQUE: <Swords className=\"h-4 w-4 text-destructive\" />,\n    DEFENDER: <Shield className=\"h-4 w-4 text-blue-500\" />,\n    TRANSPORTE: <ArrowLeftRight className=\"h-4 w-4 text-green-500\" />,\n    ESPIONAJE: <ArrowLeftRight className=\"h-4 w-4 text-yellow-500\" />,\n    OCUPAR: <Check className=\"h-4 w-4 text-primary\" />,\n    REGRESO: <Undo2 className=\"h-4 w-4 text-gray-400\" />,\n};\n\nfunction formatTime(totalSeconds: number): string {\n    if (totalSeconds < 0) totalSeconds = 0;\n    const hours = Math.floor(totalSeconds / 3600);\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\n    const seconds = Math.floor(totalSeconds % 60);\n    return [hours, minutes, seconds]\n        .map(v => v.toString().padStart(2, '0'))\n        .join(':');\n}\n\nfunction Countdown({ endDate, onFinish }: { endDate: Date | string, onFinish: () => void }) {\n    const [timeLeft, setTimeLeft] = useState(() => {\n        const diff = new Date(endDate).getTime() - new Date().getTime();\n        return Math.max(0, Math.floor(diff / 1000));\n    });\n\n    useEffect(() => {\n        const interval = setInterval(() => {\n            const diff = new Date(endDate).getTime() - new Date().getTime();\n            const secondsLeft = Math.max(0, Math.floor(diff / 1000));\n            setTimeLeft(secondsLeft);\n            if (secondsLeft === 0) {\n                clearInterval(interval);\n                onFinish();\n            }\n        }, 1000);\n        return () => clearInterval(interval);\n    }, [endDate, onFinish]);\n\n    return <span className=\"font-mono\">{formatTime(timeLeft)}</span>;\n}\n\nconst MissionRow = ({ mission, type }: { mission: ColaMisiones | IncomingAttack, type: 'outgoing' | 'incoming' | 'returning' | 'all' }) => {\n    const { toast } = useToast();\n    const router = useRouter();\n    const [isPending, startTransition] = useTransition();\n\n    const handleCancel = (missionId: string) => {\n        startTransition(async () => {\n            const result = await cancelarMision(missionId);\n            if(result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n            else toast({ title: 'Éxito', description: result.success });\n        })\n    }\n\n    const isOutgoing = 'userId' in mission;\n    const from = isOutgoing ? `${mission.origenCiudad}:${mission.origenBarrio}:${mission.origenEdificio}` : mission.attackerName;\n    const to = isOutgoing ? `${mission.destinoCiudad}:${mission.destinoBarrio}:${mission.destinoEdificio}` : mission.targetProperty;\n    \n    const tropas = isOutgoing ? (\n        Array.isArray(mission.tropas)\n            ? (mission.tropas as ({id: string, cantidad: number} | null)[]).filter(Boolean).reduce((sum, t) => sum + (t!.cantidad || 0), 0)\n            : 0\n    ) : mission.totalTroops;\n\n    const missionType = isOutgoing ? mission.tipoMision : \"ATAQUE\";\n    const startDate = isOutgoing ? mission.fechaInicio : mission.created_at;\n    const arrivalDate = isOutgoing ? mission.fechaLlegada : mission.arrivalTime;\n    const returnDate = isOutgoing ? mission.fechaRegreso : null;\n\n    const finalDate = (isOutgoing && mission.tipoMision === 'REGRESO' && returnDate) ? returnDate : arrivalDate;\n\n    return (\n        <TableRow>\n            <TableCell>\n                <div><span className=\"font-semibold\">{from}</span></div>\n                <div className=\"text-muted-foreground\">{to}</div>\n            </TableCell>\n            <TableCell className=\"hidden sm:table-cell\">\n                 <div><ClientSideDate date={startDate} /></div>\n                 <div className=\"text-muted-foreground\"><ClientSideDate date={arrivalDate} /></div>\n            </TableCell>\n            <TableCell><Countdown endDate={finalDate} onFinish={() => router.refresh()} /></TableCell>\n            <TableCell className=\"text-center\">{tropas}</TableCell>\n            <TableCell>\n                <div className=\"flex items-center gap-2\">\n                    {missionIcons[missionType]}\n                    <span className=\"hidden sm:inline\">{missionType}</span>\n                </div>\n            </TableCell>\n             <TableCell className=\"text-right\">\n                {isOutgoing && missionType !== 'REGRESO' && (\n                    <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                            <Button variant=\"destructive\" size=\"sm\" disabled={isPending}>Cancelar</Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                            <AlertDialogHeader>\n                                <AlertDialogTitle>¿Cancelar misión?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                    La flota regresará inmediatamente. Esta acción no se puede deshacer.\n                                </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                                <AlertDialogCancel>No</AlertDialogCancel>\n                                <AlertDialogAction onClick={() => handleCancel(mission.id)} disabled={isPending}>\n                                    {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\"/> : <X className=\"mr-2\"/>}\n                                    Confirmar cancelación\n                                </AlertDialogAction>\n                            </AlertDialogFooter>\n                        </AlertDialogContent>\n                    </AlertDialog>\n                )}\n            </TableCell>\n        </TableRow>\n    );\n};\n\nfunction MissionSimulator({ troopConfigs }: { troopConfigs: FullConfiguracionTropa[] }) {\n    const [coords, setCoords] = useState({ ciudad: 1, barrio: 1, edificio: 1 });\n    const [origin, setOrigin] = useState({ ciudad: 1, barrio: 1, edificio: 1 });\n    const [troops, setTroops] = useState<{ [id: string]: number }>({});\n\n    const virtualOrigin = useMemo(() => convertirACoordenadasVirtuales(origin), [origin]);\n    const virtualTarget = useMemo(() => convertirACoordenadasVirtuales(coords), [coords]);\n    const distance = useMemo(() => calcularDistancia(origin, coords), [origin, coords]);\n\n    const selectedTroopsList = useMemo(() => {\n        return Object.entries(troops)\n            .filter(([, qty]) => qty > 0)\n            .map(([id, qty]) => {\n                const config = troopConfigs.find(t => t.id === id);\n                return {\n                    id,\n                    qty,\n                    config\n                };\n            });\n    }, [troops, troopConfigs]);\n\n    const cost = useMemo(() => {\n        const units = selectedTroopsList.map(t => ({\n            cantidad: t.qty,\n            salario: t.config?.salario || 0\n        }));\n        return calcularCosteMision(distance, units);\n    }, [selectedTroopsList, distance]);\n\n    const time = useMemo(() => {\n        if (selectedTroopsList.length === 0) return 0;\n        const speeds = selectedTroopsList.map(t => Number(t.config?.velocidad || 0));\n        const minSpeed = Math.min(...speeds);\n        return calcularDuracionViaje(distance, minSpeed);\n    }, [selectedTroopsList, distance]);\n\n    return (\n        <div className=\"space-y-6 p-4 border rounded-md mt-4\">\n            <div className=\"flex items-center gap-2 mb-4\">\n                <Calculator className=\"w-5 h-5\" />\n                <h2 className=\"text-lg font-semibold\">Simulador de Logística</h2>\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                        <Label>Origen (Ciudad : Barrio : Edificio)</Label>\n                        <div className=\"grid grid-cols-3 gap-2\">\n                            <Input type=\"number\" min=\"1\" value={origin.ciudad} onChange={e => setOrigin({...origin, ciudad: parseInt(e.target.value)||0})} placeholder=\"C\" />\n                            <Input type=\"number\" min=\"1\" value={origin.barrio} onChange={e => setOrigin({...origin, barrio: parseInt(e.target.value)||0})} placeholder=\"B\" />\n                            <Input type=\"number\" min=\"1\" value={origin.edificio} onChange={e => setOrigin({...origin, edificio: parseInt(e.target.value)||0})} placeholder=\"E\" />\n                        </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                         <Label>Destino (Ciudad : Barrio : Edificio)</Label>\n                        <div className=\"grid grid-cols-3 gap-2\">\n                             <Input type=\"number\" min=\"1\" value={coords.ciudad} onChange={e => setCoords({...coords, ciudad: parseInt(e.target.value)||0})} placeholder=\"C\" />\n                             <Input type=\"number\" min=\"1\" value={coords.barrio} onChange={e => setCoords({...coords, barrio: parseInt(e.target.value)||0})} placeholder=\"B\" />\n                             <Input type=\"number\" min=\"1\" value={coords.edificio} onChange={e => setCoords({...coords, edificio: parseInt(e.target.value)||0})} placeholder=\"E\" />\n                        </div>\n                    </div>\n                    \n                    <div className=\"p-4 bg-muted/50 rounded-lg space-y-2 text-sm font-mono\">\n                        <p>Virtual Origen (Y, X): {virtualOrigin.altura.toFixed(2)}, {virtualOrigin.anchura.toFixed(2)}</p>\n                        <p>Virtual Destino (Y, X): {virtualTarget.altura.toFixed(2)}, {virtualTarget.anchura.toFixed(2)}</p>\n                        <div className=\"h-px bg-border my-2\"/>\n                        <p className=\"font-bold\">Distancia Euclídea: {distance.toFixed(5)}</p>\n                    </div>\n                </div>\n\n                <div className=\"space-y-4\">\n                    <Label>Selección de Tropas</Label>\n                    <div className=\"h-64 overflow-y-auto border rounded-md p-2 space-y-2\">\n                        {troopConfigs.map(t => (\n                            <div key={t.id} className=\"flex items-center justify-between gap-2 p-2 hover:bg-muted/50 rounded\">\n                                <div className=\"flex flex-col\">\n                                    <span className=\"font-medium text-sm\">{t.nombre}</span>\n                                    <span className=\"text-xs text-muted-foreground\">Vel: {Number(t.velocidad)} | Sal: {t.salario}</span>\n                                </div>\n                                <Input \n                                    type=\"number\" \n                                    className=\"w-20 h-8\" \n                                    placeholder=\"0\" \n                                    min=\"0\"\n                                    value={troops[t.id] || ''}\n                                    onChange={e => setTroops({...troops, [t.id]: parseInt(e.target.value) || 0})}\n                                />\n                            </div>\n                        ))}\n                    </div>\n                </div>\n            </div>\n\n             <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-6 bg-primary/5 border rounded-xl text-center\">\n                    <p className=\"text-sm text-muted-foreground mb-1\">Costo Estimado</p>\n                    <p className=\"text-3xl font-bold text-green-600\">${cost.toLocaleString()}</p>\n                </div>\n                <div className=\"p-6 bg-primary/5 border rounded-xl text-center\">\n                    <p className=\"text-sm text-muted-foreground mb-1\">Tiempo de Viaje</p>\n                    <p className=\"text-3xl font-bold text-blue-600\">{formatTime(time)}</p>\n                </div>\n            </div>\n        </div>\n    )\n}\n\nexport function MissionDetailsView({ missions, incomingAttacks, troopConfigs }: MissionDetailsViewProps) {\n    const now = new Date().getTime();\n    \n    const getFinalTime = (item: ColaMisiones | IncomingAttack): number => {\n        if ('tipoMision' in item) { // ColaMisiones\n            return new Date(item.tipoMision === 'REGRESO' && item.fechaRegreso ? item.fechaRegreso : item.fechaLlegada).getTime();\n        }\n        return new Date(item.arrivalTime).getTime(); // IncomingAttack\n    };\n\n    const activeMovements = useMemo(() => {\n        return [...missions, ...incomingAttacks]\n            .filter(mov => getFinalTime(mov) > now)\n            .sort((a,b) => getFinalTime(a) - getFinalTime(b));\n    }, [missions, incomingAttacks, now]);\n\n\n    const outgoingMissions = useMemo(() => activeMovements.filter(m => 'tipoMision' in m && m.tipoMision !== 'REGRESO'), [activeMovements]);\n    const returningMissions = useMemo(() => activeMovements.filter(m => 'tipoMision' in m && m.tipoMision === 'REGRESO'), [activeMovements]);\n    const activeAttacks = useMemo(() => activeMovements.filter(m => !('tipoMision' in m)), [activeMovements]);\n\n    const renderTable = (data: (ColaMisiones | IncomingAttack)[], type: 'outgoing' | 'incoming' | 'returning' | 'all') => (\n        <Table>\n            <TableHeader>\n                <TableRow>\n                    <TableHead>{type === 'incoming' ? 'Atacante/Destino' : 'Origen/Destino'}</TableHead>\n                    <TableHead className=\"hidden sm:table-cell\">Salida/Llegada</TableHead>\n                    <TableHead>Tiempo Restante</TableHead>\n                    <TableHead className=\"text-center\">Cantidad</TableHead>\n                    <TableHead>Misión</TableHead>\n                    <TableHead className=\"text-right\">Acción</TableHead>\n                </TableRow>\n            </TableHeader>\n            <TableBody>\n                {data.length > 0 ? (\n                    data.map(item => <MissionRow key={item.id} mission={item} type={type} />)\n                ) : (\n                    <TableRow>\n                        <TableCell colSpan={6} className=\"h-24 text-center\">No hay flotas en esta categoría.</TableCell>\n                    </TableRow>\n                )}\n            </TableBody>\n        </Table>\n    );\n\n    return (\n        <Tabs defaultValue=\"all\" className=\"w-full mt-4\">\n            <TabsList className=\"grid w-full grid-cols-2 md:grid-cols-5\">\n                <TabsTrigger value=\"all\">Todas ({activeMovements.length})</TabsTrigger>\n                <TabsTrigger value=\"outgoing\">En Misión ({outgoingMissions.length})</TabsTrigger>\n                <TabsTrigger value=\"incoming\">Enemigas ({activeAttacks.length})</TabsTrigger>\n                <TabsTrigger value=\"returning\">Regresando ({returningMissions.length})</TabsTrigger>\n                <TabsTrigger value=\"simulator\">Simulador</TabsTrigger>\n            </TabsList>\n            <TabsContent value=\"all\">{renderTable(activeMovements, 'all')}</TabsContent>\n            <TabsContent value=\"outgoing\">{renderTable(outgoingMissions, 'outgoing')}</TabsContent>\n            <TabsContent value=\"incoming\">{renderTable(activeAttacks, 'incoming')}</TabsContent>\n            <TabsContent value=\"returning\">{renderTable(returningMissions, 'returning')}</TabsContent>\n            <TabsContent value=\"simulator\"><MissionSimulator troopConfigs={troopConfigs} /></TabsContent>\n        </Tabs>\n    )\n}\n",
    "src/components/dashboard/room-details-modal.tsx": "'use client';\n\nimport Image from 'next/image';\nimport { DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogClose, DialogFooter } from '@/components/ui/dialog';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { calcularCostosNivel, calcularProduccionRecurso } from '@/lib/formulas/room-formulas';\nimport { X } from 'lucide-react';\nimport { ScrollArea } from '../ui/scroll-area';\nimport { Separator } from '../ui/separator';\nimport { Button } from '../ui/button';\nimport type { FullConfiguracionHabitacion } from '@/types';\n\ntype RoomWithLevel = FullConfiguracionHabitacion & { nivel: number };\n\ninterface RoomDetailsModalProps {\n  room: RoomWithLevel;\n}\n\nfunction formatNumber(num: number): string {\n    return num.toLocaleString('de-DE');\n}\n\nfunction getBenefitText(roomId: string, level: number): string {\n    if (!roomId) return '-';\n    \n    // Simplificado, en un futuro se puede hacer más dinámico\n    if (roomId.includes('almacen') || roomId.includes('deposito') || roomId.includes('caja_fuerte')) {\n        return `+${formatNumber(level * 5000)} Capacidad`;\n    }\n    if (roomId === 'oficina_del_jefe') return `-${level * 2}% Tiempo const.`;\n    if (roomId === 'escuela_especializacion') return `-${level * 2}% Tiempo entren.`;\n    if (roomId === 'campo_de_entrenamiento') return `-${level * 5}% Tiempo reclut.`;\n    if (roomId.includes('seguridad') || roomId.includes('torreta') || roomId.includes('minas')) return `+${level * 5}% Defensa`;\n\n    return 'Beneficio mejorado';\n}\n\nfunction CostList({ costos }: { costos: { armas: number, municion: number, dolares: number }}) {\n    return (\n        <div className=\"flex flex-col gap-1 sm:grid sm:grid-cols-3 sm:gap-x-2 text-xs\">\n            {costos.armas > 0 && <div className=\"flex items-center gap-1.5\" title='Armas'><Image src=\"/img/recursos/armas.svg\" alt=\"Armas\" width={14} height={14} /><span>{formatNumber(costos.armas)}</span></div>}\n            {costos.municion > 0 && <div className=\"flex items-center gap-1.5\" title='Munición'><Image src=\"/img/recursos/municion.svg\" alt=\"Munición\" width={14} height={14} /><span>{formatNumber(costos.municion)}</span></div>}\n            {costos.dolares > 0 && <div className=\"flex items-center gap-1.5\" title='Dólares'><Image src=\"/img/recursos/dolares.svg\" alt=\"Dólares\" width={14} height={14} /><span>{formatNumber(costos.dolares)}</span></div>}\n        </div>\n    )\n}\n\nexport function RoomDetailsModal({ room }: RoomDetailsModalProps) {\n  const projectionLevels = Array.from({ length: 5 }, (_, i) => room.nivel + i + 1);\n\n  return (\n    <DialogContent className=\"max-w-3xl w-full p-0 flex flex-col h-full sm:h-auto max-h-screen\">\n        <DialogHeader className=\"p-6 pb-4 shrink-0\">\n            <div className=\"flex flex-col sm:flex-row items-start gap-4\">\n            <div className=\"w-24 h-20 relative rounded-md overflow-hidden border flex-shrink-0\">\n                <Image src={room.urlImagen} alt={room.nombre} fill className=\"object-cover\" data-ai-hint=\"game building icon\" />\n            </div>\n            <div>\n                <DialogTitle className=\"text-2xl\">{room.nombre}</DialogTitle>\n                <DialogDescription>\n                Nivel actual: <span className=\"font-bold text-primary\">{room.nivel}</span>\n                </DialogDescription>\n                <p className=\"text-sm text-muted-foreground mt-2\">{room.descripcion}</p>\n            </div>\n            </div>\n        </DialogHeader>\n       \n        <ScrollArea className=\"flex-grow min-h-0 px-6\">\n            <h3 className=\"font-semibold mb-2\">Proyección de Mejoras</h3>\n            \n            {/* Vista de tabla para escritorio */}\n            <Table className=\"hidden sm:table\">\n            <TableHeader>\n                <TableRow>\n                <TableHead className=\"w-[80px]\">Nivel</TableHead>\n                <TableHead>Costos</TableHead>\n                <TableHead className=\"text-right\">Producción / Beneficio</TableHead>\n                </TableRow>\n            </TableHeader>\n            <TableBody>\n                {projectionLevels.map((level) => {\n                const costos = calcularCostosNivel(level, room);\n                const produccion = room.produccionRecurso \n                    ? calcularProduccionRecurso(room.id, level)\n                    : 0;\n\n                return (\n                    <TableRow key={level}>\n                    <TableCell className=\"font-medium text-primary\">{level}</TableCell>\n                    <TableCell>\n                        <CostList costos={costos} />\n                    </TableCell>\n                    <TableCell className=\"text-right text-green-400 font-mono text-sm\">\n                        {produccion > 0 \n                        ? `+${formatNumber(produccion)}/h`\n                        : getBenefitText(room.id, level)\n                        }\n                    </TableCell>\n                    </TableRow>\n                );\n                })}\n            </TableBody>\n            </Table>\n\n            {/* Vista de lista/tarjetas para móvil */}\n            <div className=\"sm:hidden space-y-4\">\n                {projectionLevels.map((level) => {\n                    const costos = calcularCostosNivel(level, room);\n                    const produccion = room.produccionRecurso\n                        ? calcularProduccionRecurso(room.id, level)\n                        : 0;\n                    \n                    return (\n                        <div key={level} className=\"p-3 border rounded-lg\">\n                            <div className=\"flex justify-between items-center mb-2\">\n                                <span className=\"font-bold text-primary\">Nivel {level}</span>\n                                <span className=\"text-sm text-green-400 font-mono\">\n                                    {produccion > 0 \n                                      ? `+${formatNumber(produccion)}/h`\n                                      : getBenefitText(room.id, level)\n                                    }\n                                </span>\n                            </div>\n                             <Separator className=\"my-2\" />\n                            <div className=\"text-xs text-muted-foreground mb-1\">Costos:</div>\n                            <CostList costos={costos} />\n                        </div>\n                    )\n                })}\n            </div>\n        </ScrollArea>\n        <DialogFooter className=\"p-6 pt-4 border-t shrink-0\">\n             <DialogClose asChild>\n                <Button type=\"button\" variant=\"secondary\" className=\"w-full\">\n                    Cerrar\n                </Button>\n            </DialogClose>\n        </DialogFooter>\n    </DialogContent>\n  );\n}\n",
    "src/components/dashboard/technologies/tech-item-card.tsx": "\n'use client';\n\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport Image from \"next/image\";\nimport { Lock, Unlock, CheckCircle } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport interface Requirement {\n    id: string;\n    name: string;\n    level?: number;\n}\n\nexport type TechStatus = 'unlocked' | 'locked' | 'available';\n\ninterface TechItemCardProps {\n    name: string;\n    description: string | null;\n    imageUrl: string | null;\n    requirements: Requirement[];\n    status: TechStatus;\n}\n\nexport function TechItemCard({ name, description, imageUrl, requirements, status }: TechItemCardProps) {\n    const hasRequirements = requirements.length > 0;\n\n    return (\n        <Card className={cn(\n            \"flex flex-col h-full transition-all duration-300\",\n            status === 'locked' && \"grayscale opacity-60\",\n            status === 'available' && \"border-primary/50 shadow-lg shadow-primary/10\",\n        )}>\n            <CardHeader className=\"flex flex-row items-start gap-4\">\n                <div className=\"w-20 h-16 relative rounded-md overflow-hidden border flex-shrink-0\">\n                    <Image\n                        src={imageUrl || \"https://placehold.co/80x56.png\"}\n                        alt={name}\n                        fill\n                        className=\"object-contain\"\n                        data-ai-hint=\"game item icon\"\n                    />\n                </div>\n                <div>\n                    <CardTitle className=\"text-lg\">{name}</CardTitle>\n                    <CardDescription className=\"text-xs line-clamp-2\">{description}</CardDescription>\n                </div>\n            </CardHeader>\n            <CardContent className=\"flex-grow flex flex-col pt-0\">\n                <Separator />\n                <div className=\"pt-4 flex-grow\">\n                    <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-2\">\n                        {status === 'locked' ? <Lock className=\"h-4 w-4 text-destructive\" /> : <Unlock className=\"h-4 w-4 text-green-500\" />}\n                        {status === 'locked' ? \"Requisitos para Desbloquear\" : \"Disponible\"}\n                    </h4>\n                    {hasRequirements ? (\n                        <div className=\"space-y-1.5 text-sm text-muted-foreground\">\n                            {requirements.map(req => (\n                                <Badge key={req.id} variant=\"secondary\" className=\"mr-1 mb-1\">\n                                    {req.name} {req.level && `(Nvl ${req.level})`}\n                                </Badge>\n                            ))}\n                        </div>\n                    ) : (\n                         <p className=\"text-sm text-muted-foreground\">Disponible desde el inicio.</p>\n                    )}\n                </div>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/dashboard/technologies/technology-tree-view.tsx": "'use client';\nimport { useState, useMemo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { FullConfiguracionHabitacion, FullConfiguracionTropa, FullConfiguracionEntrenamiento, UserWithProgress } from \"@/types\";\nimport { TechItemCard, TechStatus } from \"./tech-item-card\";\nimport { ROOM_ORDER, TRAINING_ORDER, RECRUITMENT_TROOP_ORDER, SECURITY_TROOP_ORDER } from \"@/lib/constants\";\n\ninterface TechnologyTreeViewProps {\n    user: UserWithProgress;\n    rooms: FullConfiguracionHabitacion[];\n    trainings: FullConfiguracionEntrenamiento[];\n    troops: FullConfiguracionTropa[];\n}\n\ntype Category = 'rooms' | 'trainings' | 'troops';\n\nexport function TechnologyTreeView({ user, rooms, trainings, troops }: TechnologyTreeViewProps) {\n    const [activeCategory, setActiveCategory] = useState<Category>('rooms');\n    \n    const userRoomsMap = new Map(user.propiedades.flatMap(p => p.habitaciones).map(h => [h.configuracionHabitacionId, h.nivel]));\n    const userTrainingsMap = new Map(user.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel]));\n    \n    const roomMap = new Map(rooms.map(r => [r.id, r.nombre]));\n    const trainingMap = new Map(trainings.map(t => [t.id, t.nombre]));\n\n    const getStatus = (requirements: { requiredId: string; requiredLevel: number; type: 'room' | 'training' }[]): TechStatus => {\n        for (const req of requirements) {\n            const userLevel = req.type === 'room' \n                ? (userRoomsMap.get(req.requiredId) || 0)\n                : (userTrainingsMap.get(req.requiredId) || 0);\n            \n            if (userLevel < req.requiredLevel) {\n                return 'locked';\n            }\n        }\n        return 'unlocked';\n    };\n\n    const getTroopStatus = (requirements: { id: string; lvl: number }[]): TechStatus => {\n         for (const req of requirements) {\n            const userLevel = userTrainingsMap.get(req.id) || 0;\n            if (userLevel < req.lvl) {\n                return 'locked';\n            }\n        }\n        return 'unlocked';\n    }\n\n    const sortedRooms = useMemo(() => {\n        return [...rooms].sort((a, b) => {\n            const indexA = ROOM_ORDER.indexOf(a.id);\n            const indexB = ROOM_ORDER.indexOf(b.id);\n            if (indexA === -1) return 1;\n            if (indexB === -1) return -1;\n            return indexA - indexB;\n        });\n    }, [rooms]);\n\n    const sortedTrainings = useMemo(() => {\n        return [...trainings].sort((a, b) => {\n            const indexA = TRAINING_ORDER.indexOf(a.id);\n            const indexB = TRAINING_ORDER.indexOf(b.id);\n            if (indexA === -1) return 1;\n            if (indexB === -1) return -1;\n            return indexA - indexB;\n        });\n    }, [trainings]);\n\n    const sortedTroops = useMemo(() => {\n        const fullTroopOrder = [...RECRUITMENT_TROOP_ORDER, ...SECURITY_TROOP_ORDER];\n        return [...troops].sort((a, b) => {\n            const indexA = fullTroopOrder.indexOf(a.id);\n            const indexB = fullTroopOrder.indexOf(b.id);\n            if (indexA === -1) return 1;\n            if (indexB === -1) return -1;\n            return indexA - indexB;\n        });\n    }, [troops]);\n\n    return (\n        <div className=\"w-full mt-4\">\n            <div className=\"flex gap-2 mb-4\">\n                 <Button variant={activeCategory === 'rooms' ? 'default' : 'outline'} onClick={() => setActiveCategory('rooms')}>Habitaciones</Button>\n                 <Button variant={activeCategory === 'trainings' ? 'default' : 'outline'} onClick={() => setActiveCategory('trainings')}>Entrenamientos</Button>\n                 <Button variant={activeCategory === 'troops' ? 'default' : 'outline'} onClick={() => setActiveCategory('troops')}>Tropas</Button>\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4\">\n                {activeCategory === 'rooms' && sortedRooms.map((room, index) => {\n                    const requirements = room.requisitos.map(req => ({ requiredId: req.requiredRoomId, requiredLevel: req.requiredLevel, type: 'room' as const }));\n                    const status = getStatus(requirements);\n                    return (\n                        <div key={room.id} className=\"animate-fade-in-up\" style={{ animationDelay: `${index * 50}ms`}}>\n                             <TechItemCard\n                                name={room.nombre}\n                                description={room.descripcion}\n                                imageUrl={room.urlImagen}\n                                status={status}\n                                requirements={room.requisitos.map(req => ({\n                                    id: req.requiredRoomId,\n                                    name: roomMap.get(req.requiredRoomId) || req.requiredRoomId,\n                                    level: req.requiredLevel\n                                }))}\n                            />\n                        </div>\n                    )\n                })}\n                 {activeCategory === 'trainings' && sortedTrainings.map((training, index) => {\n                    const requirements = training.requisitos.map(req => ({ requiredId: req.requiredTrainingId, requiredLevel: req.requiredLevel, type: 'training' as const }));\n                    const status = getStatus(requirements);\n                     return (\n                        <div key={training.id} className=\"animate-fade-in-up\" style={{ animationDelay: `${index * 50}ms`}}>\n                            <TechItemCard\n                                name={training.nombre}\n                                description={null}\n                                imageUrl={training.urlImagen}\n                                status={status}\n                                requirements={training.requisitos.map(req => ({\n                                    id: req.requiredTrainingId,\n                                    name: trainingMap.get(req.requiredTrainingId) || req.requiredTrainingId,\n                                    level: req.requiredLevel\n                                }))}\n                            />\n                        </div>\n                    )\n                 })}\n                 {activeCategory === 'troops' && sortedTroops.map((troop, index) => {\n                    const troopReqs = (troop.requisitos || []) as unknown as { id: string; lvl: number }[];\n                    const status = getTroopStatus(troopReqs);\n                     return (\n                        <div key={troop.id} className=\"animate-fade-in-up\" style={{ animationDelay: `${index * 50}ms`}}>\n                             <TechItemCard\n                                key={troop.id}\n                                name={troop.nombre}\n                                description={troop.descripcion}\n                                imageUrl={troop.urlImagen}\n                                status={status}\n                                requirements={troopReqs.map(req => ({\n                                    id: req.id,\n                                    name: trainingMap.get(req.id) || roomMap.get(req.id) || req.id,\n                                    level: req.lvl\n                                }))}\n                            />\n                        </div>\n                    )\n                 })}\n            </div>\n        </div>\n    );\n}\n",
    "src/components/dashboard/overview.tsx": "// This component has been removed as it is no longer used.\n",
    "src/components/admin/data-editor-view.tsx": "\n'use client';\n\nimport { useState, useCallback } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Alert, AlertTitle, AlertDescription } from \"@/components/ui/alert\";\nimport { UploadCloud, FileJson, FileText, FileSpreadsheet, X, Save, Trash2, Download } from \"lucide-react\";\nimport { useDropzone } from \"react-dropzone\";\nimport { parseCsv } from \"@/lib/import-utils\";\nimport { EditableTable } from \"./editable-table\";\nimport { Button } from \"../ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype TableData = {\n    headers: string[];\n    rows: (string | number)[][];\n}\n\nexport function DataEditorView() {\n    const { toast } = useToast();\n    const [tableData, setTableData] = useState<TableData | null>(null);\n    const [fileName, setFileName] = useState<string | null>(null);\n    const [error, setError] = useState<string | null>(null);\n\n    const onDrop = useCallback((acceptedFiles: File[]) => {\n        setError(null);\n        setTableData(null);\n        const file = acceptedFiles[0];\n        if (!file) return;\n\n        setFileName(file.name);\n        const reader = new FileReader();\n\n        reader.onabort = () => console.log('File reading was aborted');\n        reader.onerror = () => {\n            setError(\"Error al leer el archivo.\");\n            console.log('File reading has failed');\n        }\n        reader.onload = () => {\n            const content = reader.result as string;\n            try {\n                if (file.type === 'application/json') {\n                    const jsonData = JSON.parse(content);\n                    if (!Array.isArray(jsonData) || jsonData.length === 0) {\n                        throw new Error(\"El JSON debe ser un array de objetos no vacío.\");\n                    }\n                    const headers = Object.keys(jsonData[0]);\n                    const rows = jsonData.map(row => headers.map(header => row[header]));\n                    setTableData({ headers, rows });\n                } else if (file.type === 'text/csv') {\n                    const parsedData = parseCsv(content);\n                    if (!parsedData.headers || parsedData.rows.length === 0) {\n                        throw new Error(\"El CSV está vacío o tiene un formato incorrecto.\");\n                    }\n                    setTableData(parsedData);\n                } else {\n                    throw new Error(`Tipo de archivo no soportado: ${file.type}`);\n                }\n            } catch (e: any) {\n                setError(`Error al procesar el archivo: ${e.message}`);\n            }\n        };\n        reader.readAsText(file);\n\n    }, []);\n\n    const { getRootProps, getInputProps, isDragActive } = useDropzone({ \n        onDrop,\n        accept: {\n            'application/json': ['.json'],\n            'text/csv': ['.csv'],\n        },\n        maxFiles: 1\n    });\n\n    const handleClearData = () => {\n        setTableData(null);\n        setFileName(null);\n        setError(null);\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <Card>\n                <CardHeader>\n                    <CardTitle>Editor de Datos</CardTitle>\n                    <CardDescription>\n                        Importa un archivo JSON o CSV para visualizarlo y editarlo como una hoja de cálculo.\n                    </CardDescription>\n                </CardHeader>\n                <CardContent>\n                    {!tableData && (\n                        <div \n                            {...getRootProps()} \n                            className={`flex flex-col items-center justify-center p-12 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${\n                                isDragActive ? 'border-primary bg-primary/10' : 'border-border hover:border-primary/50'\n                            }`}\n                        >\n                            <input {...getInputProps()} />\n                            <UploadCloud className=\"h-12 w-12 text-muted-foreground mb-4\"/>\n                            <p className=\"text-lg font-semibold\">Arrastra y suelta tu archivo aquí</p>\n                            <p className=\"text-muted-foreground\">o haz clic para seleccionar un archivo</p>\n                            <p className=\"text-xs text-muted-foreground mt-4\">Soportado: JSON, CSV</p>\n                        </div>\n                    )}\n                    {error && (\n                        <Alert variant=\"destructive\" className=\"mt-4\">\n                            <AlertTitle>Error</AlertTitle>\n                            <AlertDescription>{error}</AlertDescription>\n                        </Alert>\n                    )}\n                </CardContent>\n            </Card>\n\n            {tableData && fileName && (\n                <Card>\n                    <CardHeader>\n                        <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-2\">\n                                <FileSpreadsheet className=\"h-5 w-5 text-primary\"/>\n                                <CardTitle>Editando: {fileName}</CardTitle>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                                <Button variant=\"outline\" size=\"sm\"><Download className=\"mr-2\"/> Exportar</Button>\n                                <Button size=\"sm\"><Save className=\"mr-2\"/> Guardar Cambios</Button>\n                                <Button variant=\"destructive\" size=\"icon\" onClick={handleClearData}>\n                                    <Trash2 className=\"h-4 w-4\"/>\n                                </Button>\n                            </div>\n                        </div>\n                    </CardHeader>\n                    <CardContent>\n                        <EditableTable initialData={tableData} />\n                    </CardContent>\n                </Card>\n            )}\n\n        </div>\n    );\n}\n",
    "src/components/admin/verification/missions-verifier.tsx": "\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { \n    calcularDistancia, \n    calcularCosteMision, \n    calcularDuracionViaje, \n    convertirACoordenadasVirtuales, \n    CoordenadasJuego \n} from \"@/lib/formulas/mission-formulas\";\nimport { Calculator, MapPin, Clock, DollarSign } from \"lucide-react\";\nimport { ClientNumber } from \"./ClientNumber\";\nimport { StatusBadge } from \"./StatusBadge\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nexport async function MissionsVerifier() {\n    const supabase = await createClient();\n\n    // Escenario: Mudanza de Mercenarios (Legacy 2010)\n    const origen: CoordenadasJuego = { ciudad: 35, barrio: 42, edificio: 41 };\n    const destino: CoordenadasJuego = { ciudad: 21, barrio: 50, edificio: 214 };\n    \n    // --- Cálculos en TypeScript (Frontend) ---\n    const vOrigen = convertirACoordenadasVirtuales(origen);\n    const vDestino = convertirACoordenadasVirtuales(destino);\n    const distCalcTS = calcularDistancia(origen, destino);\n    \n    const tropas = [{ cantidad: 1000, salario: 70, velocidad: 5850 }];\n    const velocidadFlota = 5850;\n\n    const costeCalcTS = calcularCosteMision(distCalcTS, tropas);\n    const tiempoCalcTS = calcularDuracionViaje(distCalcTS, velocidadFlota); \n\n    // --- Cálculos en Base de Datos (Backend) ---\n    const { data: dbDistanceData } = await supabase.rpc('calcular_distancia', {\n        origen_ciudad: origen.ciudad, origen_barrio: origen.barrio, origen_edificio: origen.edificio,\n        destino_ciudad: destino.ciudad, destino_barrio: destino.barrio, destino_edificio: destino.edificio\n    });\n    \n    const dbDistance = dbDistanceData || 0;\n\n    const { data: dbCostData } = await supabase.rpc('calcular_coste_mision', {\n        distancia: dbDistance,\n        tropas: JSON.stringify(tropas.map(t => ({ troop_id: 'mercenario', quantity: t.cantidad })))\n    });\n    const dbCost = dbCostData || 0;\n\n    const { data: dbTimeData } = await supabase.rpc('calcular_duracion_viaje', {\n        distancia: dbDistance,\n        velocidad_flota: velocidadFlota\n    });\n    const dbTime = dbTimeData || 0;\n\n    // Valores Esperados (Legacy Benchmark)\n    const costeEsp = 615035; \n    const tiempoEsp = 13045; // 3h 37m 25s\n    \n    // Validación\n    const okCoste = Math.abs(costeCalcTS - costeEsp) <= 5 && Math.abs(dbCost - costeEsp) <= 5;\n    const okTiempo = Math.abs(tiempoCalcTS - tiempoEsp) <= 10 && Math.abs(dbTime - tiempoEsp) <= 10;\n    \n    const costeError = `TS: ${costeCalcTS}, DB: ${dbCost}, ESP: ${costeEsp}`;\n    const tiempoError = `TS: ${tiempoCalcTS}s, DB: ${dbTime}s, ESP: ${tiempoEsp}s`;\n\n    return (\n        <div className=\"space-y-4\">\n            <Card>\n                <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\"><MapPin className=\"w-5 h-5\"/> Coordenadas Virtuales</CardTitle>\n                    <CardDescription>Traducción de Coordenadas de Juego a Mapa Plano.</CardDescription>\n                </CardHeader>\n                <CardContent>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"p-3 bg-muted rounded-md\">\n                            <p className=\"font-semibold text-sm\">Origen (35:42:41)</p>\n                            <p className=\"text-xs text-muted-foreground\">H:618 / W:585</p>\n                            <p className=\"text-lg font-mono text-blue-400\">H:{vOrigen.altura} / W:{vOrigen.anchura}</p>\n                        </div>\n                        <div className=\"p-3 bg-muted rounded-md\">\n                            <p className=\"font-semibold text-sm\">Destino (21:50:214)</p>\n                            <p className=\"text-xs text-muted-foreground\">H:748 / W:350</p>\n                            <p className=\"text-lg font-mono text-blue-400\">H:{vDestino.altura} / W:{vDestino.anchura}</p>\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n\n            <Card>\n                <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\"><Calculator className=\"w-5 h-5\"/> Simulación de Misión</CardTitle>\n                    <CardDescription>\n                        Comparación de cálculos entre Frontend (TS), Backend (SQL) y el valor esperado (Legacy) para 1000 Mercenarios.\n                    </CardDescription>\n                </CardHeader>\n                <CardContent>\n                    <Table>\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead className=\"w-[150px]\">Métrica</TableHead>\n                                <TableHead>Esperado (Legacy)</TableHead>\n                                <TableHead>Fórmula (Legacy)</TableHead>\n                                <TableHead>Calculado (Vivo)</TableHead>\n                                <TableHead>Fórmula (Viva)</TableHead>\n                                <TableHead>Calculado (BD)</TableHead>\n                                <TableHead className=\"text-right\">Estado</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            <TableRow>\n                                <TableCell className=\"font-medium flex items-center gap-2\"><DollarSign className=\"w-4 h-4\"/> Coste</TableCell>\n                                <TableCell className=\"font-mono\"><ClientNumber value={costeEsp} /></TableCell>\n                                <TableCell className=\"font-mono text-xs text-muted-foreground\">(Sal/10)*D^0.8</TableCell>\n                                <TableCell className=\"font-mono\"><ClientNumber value={costeCalcTS} /></TableCell>\n                                <TableCell className=\"font-mono text-xs text-muted-foreground\">(Sal/10)*D^0.8</TableCell>\n                                <TableCell className=\"font-mono\"><ClientNumber value={dbCost} /></TableCell>\n                                <TableCell className=\"text-right\">\n                                    <StatusBadge isOk={okCoste} errorMsg={costeError} />\n                                </TableCell>\n                            </TableRow>\n                            <TableRow>\n                                <TableCell className=\"font-medium flex items-center gap-2\"><Clock className=\"w-4 h-4\"/> Tiempo</TableCell>\n                                <TableCell className=\"font-mono\">03:37:25 ({tiempoEsp}s)</TableCell>\n                                <TableCell className=\"font-mono text-xs text-muted-foreground\">0.2795*V^-0.2*D^0.2</TableCell>\n                                <TableCell className=\"font-mono\">{new Date(tiempoCalcTS * 1000).toISOString().substr(11, 8)} ({tiempoCalcTS}s)</TableCell>\n                                <TableCell className=\"font-mono text-xs text-muted-foreground\">0.2795*V^-0.2*D^0.2</TableCell>\n                                <TableCell className=\"font-mono\">{new Date(dbTime * 1000).toISOString().substr(11, 8)} ({dbTime}s)</TableCell>\n                                <TableCell className=\"text-right\">\n                                    <StatusBadge isOk={okTiempo} errorMsg={tiempoError} />\n                                </TableCell>\n                            </TableRow>\n                        </TableBody>\n                    </Table>\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n",
    "src/components/admin/verification/trainings-verifier.tsx": "\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport function TrainingsVerifier() {\n    return (\n        <Card className=\"opacity-70 border-dashed\">\n            <CardHeader><CardTitle>Integridad de Entrenamientos</CardTitle></CardHeader>\n            <CardContent className=\"flex flex-col gap-4 items-center py-8 text-muted-foreground\">\n                <p>Módulo de verificación pendiente de implementación.</p>\n                <Badge variant=\"outline\">TODO</Badge>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/admin/verification/troops-verifier.tsx": "\"use client\";\n\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { calcularStatsTropa } from \"@/lib/formulas/troop-formulas\";\nimport { CheckCircle2, ShieldAlert, Truck, Zap } from \"lucide-react\";\n\nexport function TroopsVerifier() {\n    // 1. Caso Capacidad: Transportista + Contrabando 8\n    // Base 40,000 * (1 + sqrt(8)/10) = 51,313.7 -> FLOOR = 51,313\n    const transportista = { \n        id: 'transportista', ataque: 5, defensa: 20, capacidad: 40000, \n        velocidad: 60, tipo: 'TRANSPORTE', salario: 15, bonusAtaque: [], bonusDefensa: [] \n    };\n    const nivelesCapacidad = { contrabando: 8 };\n    const resCapacidad = calcularStatsTropa(transportista, nivelesCapacidad);\n\n    // 2. Caso Combate: CIA + Armas(8) + Tiro(7) + Guerrilla(4)\n    // Base 100 * (1.2828) * (1.2645) * (1.2) = 194.67 -> ROUND = 195\n    const cia = { \n        id: 'cia', ataque: 100, defensa: 40, capacidad: 10, \n        velocidad: 130, tipo: 'ATAQUE', salario: 30, \n        bonusAtaque: ['armas', 'tiro', 'guerrilla'], bonusDefensa: [] \n    };\n    const nivelesCombate = { armas: 8, tiro: 7, guerrilla: 4 };\n    const resCombate = calcularStatsTropa(cia, nivelesCombate);\n\n    // 3. Caso Velocidad: Mercenario + Planificación Misión 9\n    // Base 4500 * (1 + sqrt(9)/10) = 4500 * 1.3 = 5850\n    // Nota: El tutorial menciona vel 5850 con nivel 9. Invertimos para hallar base: 5850/1.3 = 4500.\n    const mercenario = { \n        id: 'mercenario', ataque: 1000, defensa: 2400, capacidad: 12000, \n        velocidad: 4500, tipo: 'ATAQUE', salario: 300, bonusAtaque: [], bonusDefensa: [] \n    };\n    // 'mercenario' está en ID_TROPAS_ENCARGOS (src/lib/constants.ts)\n    const nivelesVelocidad = { encargos: 9 };\n    const resVelocidad = calcularStatsTropa(mercenario, nivelesVelocidad);\n\n    // Validación\n    const okCapacidad = resCapacidad.capacidadActual === 51313;\n    const okCombate = resCombate.ataqueActual === 195;\n    const okVelocidad = resVelocidad.velocidadActual === 5850;\n\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\"><ShieldAlert className=\"w-5 h-5\"/> Motor de Tropas (Bonificaciones)</CardTitle>\n                <CardDescription>Validación de multiplicadores de entrenamiento (Legacy 2010).</CardDescription>\n            </CardHeader>\n            <CardContent>\n                <Table>\n                    <TableHeader>\n                        <TableRow><TableHead>Prueba</TableHead><TableHead>Detalle</TableHead><TableHead>Esperado</TableHead><TableHead>Actual</TableHead><TableHead>Estado</TableHead></TableRow>\n                    </TableHeader>\n                    <TableBody>\n                        <TableRow>\n                            <TableCell className=\"font-medium flex items-center gap-2\"><Truck className=\"w-4 h-4\"/> Capacidad</TableCell>\n                            <TableCell>Transportista + Contrabando Lvl 8</TableCell>\n                            <TableCell>51,313</TableCell>\n                            <TableCell>{resCapacidad.capacidadActual.toLocaleString()}</TableCell>\n                            <TableCell>{okCapacidad ? <Badge className=\"bg-green-600\">PASS</Badge> : <Badge variant=\"destructive\">FAIL</Badge>}</TableCell>\n                        </TableRow>\n                        <TableRow>\n                            <TableCell className=\"font-medium flex items-center gap-2\"><Zap className=\"w-4 h-4\"/> Combate (Ataque)</TableCell>\n                            <TableCell>CIA + Armas(8)/Tiro(7)/Guerrilla(4)</TableCell>\n                            <TableCell>195</TableCell>\n                            <TableCell>{resCombate.ataqueActual}</TableCell>\n                            <TableCell>{okCombate ? <Badge className=\"bg-green-600\">PASS</Badge> : <Badge variant=\"destructive\">FAIL</Badge>}</TableCell>\n                        </TableRow>\n                        <TableRow>\n                            <TableCell className=\"font-medium flex items-center gap-2\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"w-4 h-4\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><polyline points=\"12 6 12 12 16 14\"/></svg> Velocidad</TableCell>\n                            <TableCell>Mercenario + Plan. Misión Lvl 9</TableCell>\n                            <TableCell>5,850</TableCell>\n                            <TableCell>{resVelocidad.velocidadActual.toLocaleString()}</TableCell>\n                            <TableCell>{okVelocidad ? <Badge className=\"bg-green-600\">PASS</Badge> : <Badge variant=\"destructive\">FAIL</Badge>}</TableCell>\n                        </TableRow>\n                    </TableBody>\n                </Table>\n            </CardContent>\n        </Card>\n    );\n}",
    "src/components/admin/verification/ClientNumber.tsx": "'use client';\n\nimport { useState, useEffect } from 'react';\n\nfunction formatNumber(value: number): string {\n    if (value === null || value === undefined) return '0';\n    return value.toLocaleString('de-DE');\n}\n\nexport function ClientNumber({ value }: { value: number }) {\n    const [displayValue, setDisplayValue] = useState<string | number>(value);\n\n    useEffect(() => {\n        setDisplayValue(formatNumber(value));\n    }, [value]);\n\n    return <>{displayValue}</>;\n}\n",
    "src/components/admin/verification/rooms-verifier.tsx": "\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport function RoomsVerifier() {\n    return (\n        <Card className=\"opacity-70 border-dashed\">\n            <CardHeader><CardTitle>Integridad de Habitaciones</CardTitle></CardHeader>\n            <CardContent className=\"flex flex-col gap-4 items-center py-8 text-muted-foreground\">\n                <p>Módulo de verificación pendiente de implementación.</p>\n                <Badge variant=\"outline\">TODO</Badge>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/admin/verification/StatusBadge.tsx": "\n'use client';\n\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\n\ninterface StatusBadgeProps {\n    isOk: boolean;\n    errorMsg?: string;\n}\n\nexport function StatusBadge({ isOk, errorMsg }: StatusBadgeProps) {\n    if (isOk) {\n        return <Badge className=\"bg-green-600\">PASS</Badge>;\n    }\n\n    return (\n        <TooltipProvider>\n            <Tooltip>\n                <TooltipTrigger asChild>\n                    <Badge variant=\"destructive\" className=\"cursor-help\">FAIL</Badge>\n                </TooltipTrigger>\n                <TooltipContent>\n                    <p className=\"text-destructive-foreground\">{errorMsg || \"El valor calculado no coincide con el esperado.\"}</p>\n                </TooltipContent>\n            </Tooltip>\n        </TooltipProvider>\n    );\n}\n",
    "src/components/admin/export-button.tsx": "'use client';\n\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Copy } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ExportButtonProps<T> {\n  data: T[];\n  filename: string;\n  tableName: string;\n}\n\n// Helper para aplanar objetos anidados para CSV/SQL\nconst flattenObject = (ob: any, prefix = ''): Record<string, any> => {\n    const result: Record<string, any> = {};\n    for (const key in ob) {\n        if (!ob.hasOwnProperty(key)) continue;\n        const newKey = prefix ? `${prefix}_${key}` : key;\n        if (typeof ob[key] === 'object' && ob[key] !== null && !Array.isArray(ob[key])) {\n            Object.assign(result, flattenObject(ob[key], newKey));\n        } else if (Array.isArray(ob[key])) {\n            result[newKey] = JSON.stringify(ob[key]);\n        } else {\n            result[newKey] = ob[key];\n        }\n    }\n    return result;\n};\n\n\nexport function ExportButton<T extends Record<string, any>>({ data, filename, tableName }: ExportButtonProps<T>) {\n    const { toast } = useToast();\n\n    const downloadFile = (content: string, fileType: string, extension: string) => {\n        const blob = new Blob([content], { type: fileType });\n        const link = document.createElement('a');\n        link.href = URL.createObjectURL(blob);\n        link.download = `${filename}.${extension}`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n    };\n\n    const copyToClipboard = async (content: string, formatName: string) => {\n        try {\n            await navigator.clipboard.writeText(content);\n            toast({\n                title: '¡Copiado!',\n                description: `Los datos en formato ${formatName} se han copiado al portapapeles.`,\n            });\n        } catch (err) {\n            console.error('Failed to copy text: ', err);\n            toast({\n                variant: 'destructive',\n                title: 'Error',\n                description: 'No se pudo copiar el contenido al portapapeles.',\n            });\n        }\n    };\n    \n    const getCsvContent = (): string => {\n        if (data.length === 0) return \"\";\n        const flattenedData = data.map(row => flattenObject(row));\n        const headers = Object.keys(flattenedData[0]);\n        const csvRows = [\n            headers.join(','),\n            ...flattenedData.map(row => \n                headers.map(header => JSON.stringify(row[header], (_, value) => value ?? '')).join(',')\n            )\n        ];\n        return csvRows.join('\\n');\n    }\n\n    const getSqlContent = (): string => {\n         if (data.length === 0) return \"\";\n        const flattenedData = data.map(row => flattenObject(row));\n        const headers = Object.keys(flattenedData[0]).map(h => `\"${h}\"`);\n        \n        const sqlRows = flattenedData.map(row => {\n            const values = Object.values(row).map(val => {\n                if (val === null || val === undefined) return 'NULL';\n                if (typeof val === 'string') return `'${val.replace(/'/g, \"''\")}'`;\n                return val;\n            }).join(', ');\n            return `INSERT INTO \"${tableName}\" (${headers.join(', ')}) VALUES (${values});`;\n        });\n\n        return sqlRows.join('\\n');\n    }\n\n    const getJsonContent = (): string => {\n        return JSON.stringify(data, null, 2);\n    }\n\n\n    return (\n        <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\">\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    Exportar\n                </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent>\n                <DropdownMenuItem onClick={() => downloadFile(getCsvContent(), 'text/csv;charset=utf-8;', 'csv')}>\n                    Descargar como CSV\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => downloadFile(getSqlContent(), 'application/sql', 'sql')}>\n                    Descargar como SQL\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => downloadFile(getJsonContent(), 'application/json', 'json')}>\n                    Descargar como JSON\n                </DropdownMenuItem>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem onClick={() => copyToClipboard(getCsvContent(), 'CSV')}>\n                     <Copy className=\"mr-2 h-4 w-4\" />\n                    Copiar como CSV\n                </DropdownMenuItem>\n                 <DropdownMenuItem onClick={() => copyToClipboard(getSqlContent(), 'SQL')}>\n                     <Copy className=\"mr-2 h-4 w-4\" />\n                    Copiar como SQL\n                </DropdownMenuItem>\n                 <DropdownMenuItem onClick={() => copyToClipboard(getJsonContent(), 'JSON')}>\n                     <Copy className=\"mr-2 h-4 w-4\" />\n                    Copiar como JSON\n                </DropdownMenuItem>\n            </DropdownMenuContent>\n        </DropdownMenu>\n    );\n}\n",
    "src/components/admin/admin-sidebar.tsx": "\n\"use client\"\n\nimport * as React from \"react\"\nimport {\n  Building,\n  Brain,\n  Users,\n  Hotel,\n  LayoutDashboard,\n  Settings,\n  ShieldAlert,\n  FileJson,\n  Database, // Importar el nuevo icono\n} from \"lucide-react\"\nimport Link from \"next/link\"\nimport { usePathname } from \"next/navigation\"\n\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarHeader,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarRail,\n  SidebarSeparator,\n} from \"@/components/ui/sidebar\"\n\n// Menu items.\nconst items = [\n  {\n    title: \"Dashboard\",\n    url: \"/admin/panel\",\n    icon: LayoutDashboard,\n  },\n  {\n    title: \"Habitaciones\",\n    url: \"/admin/panel/rooms\",\n    icon: Building,\n  },\n  {\n    title: \"Entrenamientos\",\n    url: \"/admin/panel/trainings\",\n    icon: Brain,\n  },\n  {\n    title: \"Tropas\",\n    url: \"/admin/panel/troops\",\n    icon: Users,\n  },\n  {\n    title: \"Propiedades\",\n    url: \"/admin/panel/properties\",\n    icon: Hotel,\n  },\n  {\n    title: \"Editor\",\n    url: \"/admin/panel/editor\",\n    icon: FileJson,\n  },\n  // Nuevo enlace añadido\n  {\n    title: \"Base de Datos\",\n    url: \"/admin/panel/database\",\n    icon: Database,\n  },\n]\n\nexport function AdminSidebar({ ...props }: React.ComponentProps<typeof Sidebar>) {\n  const pathname = usePathname()\n\n  return (\n    <Sidebar collapsible=\"icon\" {...props}>\n      <SidebarHeader>\n        <SidebarMenu>\n          <SidebarMenuItem>\n            <SidebarMenuButton size=\"lg\" asChild>\n              <Link href=\"/admin/panel\">\n                <div className=\"flex aspect-square size-8 items-center justify-center rounded-lg bg-sidebar-primary text-sidebar-primary-foreground\">\n                  <ShieldAlert className=\"size-4\" />\n                </div>\n                <div className=\"flex flex-col gap-0.5 leading-none\">\n                  <span className=\"font-semibold\">Vendetta Admin</span>\n                  <span className=\"\">v1.0.0</span>\n                </div>\n              </Link>\n            </SidebarMenuButton>\n          </SidebarMenuItem>\n        </SidebarMenu>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarMenu>\n          {items.map((item) => (\n            <SidebarMenuItem key={item.title}>\n              <SidebarMenuButton asChild isActive={pathname === item.url} tooltip={item.title}>\n                <Link href={item.url}>\n                  <item.icon />\n                  <span>{item.title}</span>\n                </Link>\n              </SidebarMenuButton>\n            </SidebarMenuItem>\n          ))}\n        </SidebarMenu>\n\n        <SidebarSeparator className=\"my-2\" />\n\n        <SidebarMenu>\n            <SidebarMenuItem>\n                 <SidebarMenuButton asChild tooltip=\"Configuración\">\n                    <Link href=\"#\">\n                        <Settings />\n                        <span>Configuración</span>\n                    </Link>\n                 </SidebarMenuButton>\n            </SidebarMenuItem>\n        </SidebarMenu>\n\n      </SidebarContent>\n      <SidebarFooter>\n        <div className=\"p-2 text-xs text-muted-foreground text-center\">\n            Admin User\n        </div>\n      </SidebarFooter>\n      <SidebarRail />\n    </Sidebar>\n  )\n}\n",
    "src/components/admin/batch-forms/edit-rooms-form.tsx": "'use client';\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { FullConfiguracionHabitacion, FullPropiedad, UserProfileData } from \"@/types\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { batchUpdatePropertiesByAdmin } from \"@/lib/actions/admin-batch.actions\";\nimport { ArrowLeft, Loader2, Save } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\n\ninterface EditRoomsFormProps {\n    user: UserProfileData;\n    properties: FullPropiedad[];\n    allRooms: FullConfiguracionHabitacion[];\n}\n\nexport function EditRoomsForm({ user, properties, allRooms }: EditRoomsFormProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const [selectedProperties, setSelectedProperties] = useState<string[]>([]);\n    const [roomLevels, setRoomLevels] = useState<Record<string, string>>({});\n\n     const handleSelectAll = (checked: boolean | string) => {\n        if (checked) {\n            setSelectedProperties(properties.map(p => p.id));\n        } else {\n            setSelectedProperties([]);\n        }\n    };\n\n    const handlePropertySelect = (propertyId: string, checked: boolean | string) => {\n        if (checked) {\n            setSelectedProperties(prev => [...prev, propertyId]);\n        } else {\n            setSelectedProperties(prev => prev.filter(id => id !== propertyId));\n        }\n    };\n\n    const handleLevelChange = (roomId: string, value: string) => {\n        setRoomLevels(prev => ({...prev, [roomId]: value}));\n    };\n    \n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        if(selectedProperties.length === 0) {\n            toast({ variant: 'destructive', title: 'Error', description: 'Selecciona al menos una propiedad.'});\n            return;\n        }\n\n        const payload = {\n            userId: user.id,\n            propertyIds: selectedProperties,\n            updates: {\n                roomLevels: Object.entries(roomLevels)\n                    .filter(([,val]) => val !== '')\n                    .map(([key, val]) => ({ id: key, level: parseInt(val, 10) }))\n            }\n        };\n\n        startTransition(async () => {\n            const result = await batchUpdatePropertiesByAdmin(payload);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: result.success });\n            }\n        });\n    }\n\n    return (\n        <form onSubmit={handleSubmit}>\n            <Card>\n                <CardHeader>\n                     <div className=\"flex items-start justify-between\">\n                        <div>\n                            <CardTitle>Editar Niveles de Habitaciones para {user.name}</CardTitle>\n                            <CardDescription>Establece los niveles para una o más propiedades. Los campos vacíos no se modificarán.</CardDescription>\n                         </div>\n                         <Button asChild variant=\"outline\" size=\"sm\">\n                            <Link href={`/admin/panel/properties/${user.id}/edit`}>\n                                <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                                Volver\n                            </Link>\n                        </Button>\n                    </div>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                    <div>\n                        <h4 className=\"font-semibold mb-2\">1. Seleccionar Propiedades</h4>\n                        <div className=\"border rounded-md p-4 space-y-2 max-h-48 overflow-y-auto\">\n                            <div className=\"flex items-center space-x-2\">\n                                <Checkbox\n                                    id=\"select-all-props\"\n                                    onCheckedChange={handleSelectAll}\n                                    checked={selectedProperties.length === properties.length && properties.length > 0}\n                                />\n                                <Label htmlFor=\"select-all-props\" className=\"font-bold\">Seleccionar Todas</Label>\n                            </div>\n                            {properties.map(prop => (\n                                <div key={prop.id} className=\"flex items-center space-x-2\">\n                                    <Checkbox\n                                        id={`prop-${prop.id}`}\n                                        onCheckedChange={(checked) => handlePropertySelect(prop.id, checked)}\n                                        checked={selectedProperties.includes(prop.id)}\n                                    />\n                                    <Label htmlFor={`prop-${prop.id}`}>{prop.nombre} [{prop.ciudad}:{prop.barrio}:{prop.edificio}]</Label>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n                    <div>\n                        <h4 className=\"font-semibold mb-2\">2. Definir Niveles de Habitaciones</h4>\n                         <ScrollArea className=\"h-72 border rounded-md p-4\">\n                            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                                {allRooms.map(room => (\n                                    <div key={room.id} className=\"space-y-1.5\">\n                                        <Label htmlFor={`room-${room.id}`} className=\"text-xs\">{room.nombre}</Label>\n                                        <Input\n                                            id={`room-${room.id}`}\n                                            type=\"number\"\n                                            min=\"0\"\n                                            placeholder=\"Sin cambios\"\n                                            value={roomLevels[room.id] || ''}\n                                            onChange={(e) => handleLevelChange(room.id, e.target.value)}\n                                            disabled={isPending}\n                                            className=\"h-8\"\n                                        />\n                                    </div>\n                                ))}\n                            </div>\n                         </ScrollArea>\n                    </div>\n                </CardContent>\n                <CardContent className=\"p-6 pt-0\">\n                    <Button type=\"submit\" disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        <Save className=\"mr-2 h-4 w-4\" />\n                        Aplicar Cambios\n                    </Button>\n                </CardContent>\n            </Card>\n        </form>\n    );\n}\n",
    "src/components/admin/batch-forms/edit-troops-form.tsx": "'use client';\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { FullConfiguracionTropa, FullPropiedad, UserProfileData } from \"@/types\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { batchUpdatePropertiesByAdmin } from \"@/lib/actions/admin-batch.actions\";\nimport { ArrowLeft, Loader2, Save, ShieldCheck, Swords } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\n\ninterface EditTroopsFormProps {\n    user: UserProfileData;\n    properties: FullPropiedad[];\n    allTroops: FullConfiguracionTropa[];\n}\n\nexport function EditTroopsForm({ user, properties, allTroops }: EditTroopsFormProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const [selectedProperties, setSelectedProperties] = useState<string[]>([]);\n    const [attackTroops, setAttackTroops] = useState<Record<string, string>>({});\n    const [defenseTroops, setDefenseTroops] = useState<Record<string, string>>({});\n\n    const handleSelectAll = (checked: boolean | string) => {\n        if (checked) setSelectedProperties(properties.map(p => p.id));\n        else setSelectedProperties([]);\n    };\n\n    const handlePropertySelect = (propertyId: string, checked: boolean | string) => {\n        if (checked) setSelectedProperties(prev => [...prev, propertyId]);\n        else setSelectedProperties(prev => prev.filter(id => id !== propertyId));\n    };\n\n    const handleTroopChange = (setter: React.Dispatch<React.SetStateAction<Record<string, string>>>, troopId: string, value: string) => {\n        setter(prev => ({...prev, [troopId]: value}));\n    };\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        if (selectedProperties.length === 0) {\n            toast({ variant: 'destructive', title: 'Error', description: 'Selecciona al menos una propiedad.'});\n            return;\n        }\n\n        const payload = {\n            userId: user.id,\n            propertyIds: selectedProperties,\n            updates: {\n                attackTroops: Object.entries(attackTroops).filter(([,val]) => val !== '').map(([id, val]) => ({ id, quantity: parseInt(val, 10) })),\n                defenseTroops: Object.entries(defenseTroops).filter(([,val]) => val !== '').map(([id, val]) => ({ id, quantity: parseInt(val, 10) }))\n            }\n        };\n\n        startTransition(async () => {\n            const result = await batchUpdatePropertiesByAdmin(payload);\n            if (result.error) toast({ variant: 'destructive', title: 'Error', description: result.error });\n            else toast({ title: 'Éxito', description: result.success });\n        });\n    };\n\n    const attackTroopConfigs = allTroops.filter(t => t.tipo !== 'DEFENSA');\n    const defenseTroopConfigs = allTroops.filter(t => t.tipo === 'DEFENSA');\n\n    return (\n        <form onSubmit={handleSubmit}>\n            <Card>\n                 <CardHeader>\n                     <div className=\"flex items-start justify-between\">\n                        <div>\n                            <CardTitle>Añadir Tropas para {user.name}</CardTitle>\n                            <CardDescription>Añade unidades a las propiedades seleccionadas. Las cantidades se sumarán a las existentes.</CardDescription>\n                        </div>\n                         <Button asChild variant=\"outline\" size=\"sm\">\n                            <Link href={`/admin/panel/properties/${user.id}/edit`}>\n                                <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                                Volver\n                            </Link>\n                        </Button>\n                    </div>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                    <div>\n                        <h4 className=\"font-semibold mb-2\">1. Seleccionar Propiedades</h4>\n                         <div className=\"border rounded-md p-4 space-y-2 max-h-48 overflow-y-auto\">\n                            <div className=\"flex items-center space-x-2\">\n                                <Checkbox id=\"select-all-props\" onCheckedChange={handleSelectAll} checked={selectedProperties.length === properties.length && properties.length > 0} />\n                                <Label htmlFor=\"select-all-props\" className=\"font-bold\">Seleccionar Todas</Label>\n                            </div>\n                            {properties.map(prop => (\n                                <div key={prop.id} className=\"flex items-center space-x-2\">\n                                    <Checkbox id={`prop-${prop.id}`} onCheckedChange={(checked) => handlePropertySelect(prop.id, checked)} checked={selectedProperties.includes(prop.id)} />\n                                    <Label htmlFor={`prop-${prop.id}`}>{prop.nombre} [{prop.ciudad}:{prop.barrio}:{prop.edificio}]</Label>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                        <div>\n                            <h4 className=\"font-semibold mb-2 flex items-center gap-2\"><Swords className=\"h-5 w-5 text-destructive\"/> Tropas de Ataque/Espionaje</h4>\n                            <ScrollArea className=\"h-72 border rounded-md p-4\">\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                    {attackTroopConfigs.map(troop => (\n                                        <div key={troop.id} className=\"space-y-1.5\">\n                                            <Label htmlFor={`troop-${troop.id}`} className=\"text-xs\">{troop.nombre}</Label>\n                                            <Input id={`troop-${troop.id}`} type=\"number\" min=\"0\" placeholder=\"0\" value={attackTroops[troop.id] || ''} onChange={(e) => handleTroopChange(setAttackTroops, troop.id, e.target.value)} disabled={isPending} className=\"h-8\"/>\n                                        </div>\n                                    ))}\n                                </div>\n                            </ScrollArea>\n                        </div>\n                        <div>\n                             <h4 className=\"font-semibold mb-2 flex items-center gap-2\"><ShieldCheck className=\"h-5 w-5 text-blue-500\"/> Tropas de Defensa</h4>\n                            <ScrollArea className=\"h-72 border rounded-md p-4\">\n                                <div className=\"grid grid-cols-2 gap-4\">\n                                    {defenseTroopConfigs.map(troop => (\n                                         <div key={troop.id} className=\"space-y-1.5\">\n                                            <Label htmlFor={`defense-troop-${troop.id}`} className=\"text-xs\">{troop.nombre}</Label>\n                                            <Input id={`defense-troop-${troop.id}`} type=\"number\" min=\"0\" placeholder=\"0\" value={defenseTroops[troop.id] || ''} onChange={(e) => handleTroopChange(setDefenseTroops, troop.id, e.target.value)} disabled={isPending} className=\"h-8\"/>\n                                        </div>\n                                    ))}\n                                </div>\n                            </ScrollArea>\n                        </div>\n                    </div>\n                </CardContent>\n                 <CardContent className=\"p-6 pt-0\">\n                    <Button type=\"submit\" disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        <Save className=\"mr-2 h-4 w-4\" />\n                        Añadir Tropas\n                    </Button>\n                </CardContent>\n            </Card>\n        </form>\n    );\n}\n",
    "src/components/admin/batch-forms/edit-trainings-form.tsx": "'use client';\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { FullConfiguracionEntrenamiento, UserProfileData, EntrenamientoUsuario } from \"@/types\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { batchUpdatePropertiesByAdmin } from \"@/lib/actions/admin-batch.actions\";\nimport { ArrowLeft, Loader2, Save } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\n\ninterface EditTrainingsFormProps {\n    user: UserProfileData;\n    userTrainings: (EntrenamientoUsuario & { configuracionEntrenamiento: FullConfiguracionEntrenamiento })[];\n    allTrainings: FullConfiguracionEntrenamiento[];\n}\n\nexport function EditTrainingsForm({ user, userTrainings, allTrainings }: EditTrainingsFormProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const initialLevels = Object.fromEntries(userTrainings.map(t => [t.configuracionEntrenamientoId, t.nivel.toString()]));\n    const [trainingLevels, setTrainingLevels] = useState<Record<string, string>>(initialLevels);\n\n    const handleLevelChange = (trainingId: string, value: string) => {\n        setTrainingLevels(prev => ({...prev, [trainingId]: value}));\n    };\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n\n        const payload = {\n            userId: user.id,\n            propertyIds: [], // Not needed for trainings\n            updates: {\n                trainings: Object.entries(trainingLevels)\n                    .filter(([,val]) => val !== '' && !isNaN(parseInt(val, 10)))\n                    .map(([key, val]) => ({ id: key, level: parseInt(val, 10) }))\n            }\n        };\n\n        startTransition(async () => {\n            const result = await batchUpdatePropertiesByAdmin(payload);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: result.success });\n            }\n        });\n    };\n\n    return (\n        <form onSubmit={handleSubmit}>\n            <Card>\n                <CardHeader>\n                     <div className=\"flex items-start justify-between\">\n                        <div>\n                            <CardTitle>Gestionar Entrenamientos de {user.name}</CardTitle>\n                            <CardDescription>Ajusta los niveles de todas las investigaciones del usuario. Los cambios se guardarán para este usuario.</CardDescription>\n                        </div>\n                        <Button asChild variant=\"outline\" size=\"sm\">\n                            <Link href={`/admin/panel/properties/${user.id}/edit`}>\n                                <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                                Volver\n                            </Link>\n                        </Button>\n                    </div>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                    <ScrollArea className=\"h-96 border rounded-md p-4\">\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                            {allTrainings.map(training => (\n                                <div key={training.id} className=\"space-y-1.5\">\n                                    <Label htmlFor={`training-${training.id}`} className=\"text-xs\">{training.nombre}</Label>\n                                    <Input\n                                        id={`training-${training.id}`}\n                                        type=\"number\"\n                                        min=\"0\"\n                                        placeholder=\"0\"\n                                        value={trainingLevels[training.id] || ''}\n                                        onChange={(e) => handleLevelChange(training.id, e.target.value)}\n                                        disabled={isPending}\n                                        className=\"h-8\"\n                                    />\n                                </div>\n                            ))}\n                        </div>\n                    </ScrollArea>\n                </CardContent>\n                <CardContent className=\"p-6 pt-0\">\n                    <Button type=\"submit\" disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        <Save className=\"mr-2 h-4 w-4\" />\n                        Guardar Niveles\n                    </Button>\n                </CardContent>\n            </Card>\n        </form>\n    );\n}\n",
    "src/components/admin/batch-forms/edit-resources-form.tsx": "'use client';\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { FullPropiedad, UserProfileData } from \"@/types\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { batchUpdatePropertiesByAdmin } from \"@/lib/actions/admin-batch.actions\";\nimport { ArrowLeft, Loader2, Save } from \"lucide-react\";\nimport Link from \"next/link\";\n\ninterface EditResourcesFormProps {\n    user: UserProfileData;\n    properties: FullPropiedad[];\n}\n\nexport function EditResourcesForm({ user, properties }: EditResourcesFormProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const [selectedProperties, setSelectedProperties] = useState<string[]>([]);\n    const [resources, setResources] = useState({\n        armas: '',\n        municion: '',\n        alcohol: '',\n        dolares: ''\n    });\n\n    const handleSelectAll = (checked: boolean | string) => {\n        if (checked) {\n            setSelectedProperties(properties.map(p => p.id));\n        } else {\n            setSelectedProperties([]);\n        }\n    };\n\n    const handlePropertySelect = (propertyId: string, checked: boolean | string) => {\n        if (checked) {\n            setSelectedProperties(prev => [...prev, propertyId]);\n        } else {\n            setSelectedProperties(prev => prev.filter(id => id !== propertyId));\n        }\n    };\n\n    const handleResourceChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        setResources(prev => ({...prev, [e.target.name]: e.target.value}));\n    };\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        if(selectedProperties.length === 0) {\n            toast({ variant: 'destructive', title: 'Error', description: 'Selecciona al menos una propiedad.'});\n            return;\n        }\n\n        const payload = {\n            userId: user.id,\n            propertyIds: selectedProperties,\n            updates: {\n                resources: Object.fromEntries(\n                    Object.entries(resources)\n                        .filter(([, val]) => val !== '')\n                        .map(([key, val]) => [key, parseInt(val, 10)])\n                )\n            }\n        };\n\n        startTransition(async () => {\n            const result = await batchUpdatePropertiesByAdmin(payload);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: result.success });\n            }\n        });\n    }\n\n    return (\n         <form onSubmit={handleSubmit}>\n            <Card>\n                <CardHeader>\n                    <div className=\"flex items-start justify-between\">\n                        <div>\n                             <CardTitle>Ajustar Recursos para {user.name}</CardTitle>\n                            <CardDescription>Modifica los recursos para las propiedades seleccionadas. Los campos vacíos no se modificarán.</CardDescription>\n                        </div>\n                         <Button asChild variant=\"outline\" size=\"sm\">\n                            <Link href={`/admin/panel/properties/${user.id}/edit`}>\n                                <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                                Volver\n                            </Link>\n                        </Button>\n                    </div>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                    <div>\n                        <h4 className=\"font-semibold mb-2\">1. Seleccionar Propiedades</h4>\n                        <div className=\"border rounded-md p-4 space-y-2 max-h-48 overflow-y-auto\">\n                            <div className=\"flex items-center space-x-2\">\n                                <Checkbox\n                                    id=\"select-all-props\"\n                                    onCheckedChange={handleSelectAll}\n                                    checked={selectedProperties.length === properties.length && properties.length > 0}\n                                />\n                                <Label htmlFor=\"select-all-props\" className=\"font-bold\">Seleccionar Todas</Label>\n                            </div>\n                            {properties.map(prop => (\n                                <div key={prop.id} className=\"flex items-center space-x-2\">\n                                    <Checkbox\n                                        id={`prop-${prop.id}`}\n                                        onCheckedChange={(checked) => handlePropertySelect(prop.id, checked)}\n                                        checked={selectedProperties.includes(prop.id)}\n                                    />\n                                    <Label htmlFor={`prop-${prop.id}`}>{prop.nombre} [{prop.ciudad}:{prop.barrio}:{prop.edificio}]</Label>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n                    <div>\n                        <h4 className=\"font-semibold mb-2\">2. Definir Nuevos Valores de Recursos</h4>\n                        <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n                            {Object.keys(resources).map(resKey => (\n                                <div key={resKey} className=\"space-y-1.5\">\n                                    <Label htmlFor={resKey} className=\"capitalize\">{resKey}</Label>\n                                    <Input\n                                        id={resKey}\n                                        name={resKey}\n                                        type=\"number\"\n                                        placeholder=\"Dejar vacío para no cambiar\"\n                                        value={resources[resKey as keyof typeof resources]}\n                                        onChange={handleResourceChange}\n                                        disabled={isPending}\n                                    />\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n                </CardContent>\n                 <CardContent className=\"p-6 pt-0\">\n                    <Button type=\"submit\" disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        <Save className=\"mr-2 h-4 w-4\" />\n                        Aplicar Cambios\n                    </Button>\n                </CardContent>\n            </Card>\n         </form>\n    )\n}\n",
    "src/components/admin/admin-header.tsx": "\n\"use client\"\n\nimport { SidebarTrigger } from \"@/components/ui/sidebar\"\n\nexport function AdminHeader({ children }: { children?: React.ReactNode }) {\n  return (\n    <header className=\"sticky top-0 z-10 flex h-14 items-center justify-between gap-4 border-b bg-background px-4 sm:static sm:h-auto sm:border-0 sm:bg-transparent sm:px-6\">\n      <div className=\"flex items-center gap-2\">\n        <SidebarTrigger className=\"md:hidden\" />\n        {/* You can add a breadcrumb component here if you want */}\n      </div>\n      <div className=\"relative flex items-center gap-2 md:grow-0\">\n        {children}\n      </div>\n    </header>\n  )\n}\n",
    "src/components/admin/troop-config-table.tsx": "'use client';\nimport { useState } from \"react\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"../ui/table\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"../ui/card\";\nimport { Button } from \"../ui/button\";\nimport type { TipoTropa } from \"@/types\";\nimport { DeleteConfigButton } from \"./delete-config-button\";\nimport { deleteTroopConfig } from \"@/lib/actions/admin.actions\";\nimport type { FullConfiguracionEntrenamiento, FullConfiguracionTropa } from \"@/types\";\nimport Link from \"next/link\";\nimport { PlusCircle } from \"lucide-react\";\nimport { ExportButton } from \"./export-button\";\n\ninterface TroopConfigTableProps {\n    initialData: FullConfiguracionTropa[];\n    allTrainings: FullConfiguracionEntrenamiento[];\n    tiposTropa: string[];\n}\n\nexport function TroopConfigTable({ initialData, allTrainings, tiposTropa }: TroopConfigTableProps) {\n    \n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle>Configuración de Tropas</CardTitle>\n                <CardDescription>\n                    Define las estadísticas, costos y requisitos de todas las unidades del juego.\n                </CardDescription>\n            </CardHeader>\n            <CardContent>\n                <div className=\"flex items-center gap-2 mb-4\">\n                    <ExportButton data={initialData} filename=\"config_tropas\" tableName=\"ConfiguracionTropa\" />\n                    <Button asChild>\n                        <Link href=\"/admin/panel/troops/new\">\n                            <PlusCircle />\n                            Crear Nueva Tropa\n                        </Link>\n                    </Button>\n                </div>\n                <div className=\"rounded-md border\">\n                    <Table>\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead>Nombre</TableHead>\n                                <TableHead className=\"hidden sm:table-cell\">Puntos</TableHead>\n                                <TableHead className=\"text-right\">Ataque</TableHead>\n                                <TableHead className=\"text-right\">Defensa</TableHead>\n                                <TableHead className=\"hidden md:table-cell\">Tipo</TableHead>\n                                <TableHead className=\"text-right\">Acciones</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {initialData.map(troop => (\n                                <TableRow key={troop.id}>\n                                    <TableCell className=\"font-medium\">{troop.nombre}</TableCell>\n                                    <TableCell className=\"hidden sm:table-cell\">{troop.puntos}</TableCell>\n                                    <TableCell className=\"text-right\">{troop.ataque.toLocaleString('de-DE')}</TableCell>\n                                    <TableCell className=\"text-right\">{troop.defensa.toLocaleString('de-DE')}</TableCell>\n                                    <TableCell className=\"hidden md:table-cell\">{troop.tipo}</TableCell>\n                                    <TableCell className=\"text-right space-x-2\">\n                                        <Button asChild variant=\"outline\" size=\"sm\">\n                                            <Link href={`/admin/panel/troops/${troop.id}`}>Editar</Link>\n                                        </Button>\n                                        <DeleteConfigButton id={troop.id} action={deleteTroopConfig} />\n                                    </TableCell>\n                                </TableRow>\n                            ))}\n                        </TableBody>\n                    </Table>\n                </div>\n            </CardContent>\n        </Card>\n    );\n}",
    "src/components/admin/bonus-config-matrix.tsx": "\n'use client';\n\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"../ui/card\";\nimport { Button } from \"../ui/button\";\nimport { Input } from \"../ui/input\";\nimport { Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { saveTroopBonusConfig } from \"@/lib/actions/admin.actions\";\nimport { ConfiguracionTropa, TropaBonusContrincante } from \"@/types\";\nimport { ScrollArea } from \"../ui/scroll-area\";\nimport { cn } from \"@/lib/utils\";\n\ninterface BonusConfigMatrixProps {\n    attackTroops: ConfiguracionTropa[];\n    defenseTroops: ConfiguracionTropa[];\n    initialBonusConfig: TropaBonusContrincante[];\n}\n\nexport function BonusConfigMatrix({ attackTroops, defenseTroops, initialBonusConfig }: BonusConfigMatrixProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n\n    const initialMatrixState = () => {\n        const matrix = new Map<string, Map<string, number>>();\n        for (const bonus of initialBonusConfig) {\n            if (!matrix.has(bonus.tropaAtacanteId)) {\n                matrix.set(bonus.tropaAtacanteId, new Map());\n            }\n            matrix.get(bonus.tropaAtacanteId)!.set(bonus.tropaDefensoraId, bonus.factorPrioridad);\n        }\n        return matrix;\n    };\n\n    const [matrix, setMatrix] = useState(initialMatrixState);\n\n    const handleInputChange = (attackerId: string, defenderId: string, value: string) => {\n        const newMatrix = new Map(matrix);\n        if (!newMatrix.has(attackerId)) {\n            newMatrix.set(attackerId, new Map());\n        }\n        \n        const numValue = parseFloat(value);\n        if (value === '' || isNaN(numValue)) {\n            newMatrix.get(attackerId)!.delete(defenderId);\n        } else {\n            newMatrix.get(attackerId)!.set(defenderId, numValue);\n        }\n        setMatrix(newMatrix);\n    };\n\n    const handleSubmit = () => {\n        const bonusData: { tropaAtacanteId: string; tropaDefensoraId: string; factorPrioridad: number; }[] = [];\n        matrix.forEach((defenderMap, attackerId) => {\n            defenderMap.forEach((factor, defenderId) => {\n                // Solo guardamos si el factor es diferente de 1 para no llenar la DB\n                if (factor !== 1) { \n                    bonusData.push({\n                        tropaAtacanteId: attackerId,\n                        tropaDefensoraId: defenderId,\n                        factorPrioridad: factor,\n                    });\n                }\n            });\n        });\n\n        startTransition(async () => {\n            const result = await saveTroopBonusConfig(bonusData);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Configuración de bonus guardada.' });\n            }\n        });\n    };\n    \n    const allDefenders = [...attackTroops, ...defenseTroops];\n\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle>Matriz de Bonus de Ataque vs Tropas</CardTitle>\n                <CardDescription>\n                    Define el factor de prioridad de ataque. Un valor de 1.5 significa un 50% más de daño contra esa unidad. Un valor de 1 es el normal.\n                </CardDescription>\n            </CardHeader>\n            <CardContent>\n                <ScrollArea className=\"w-full whitespace-nowrap rounded-md border h-[75vh]\">\n                    <table className=\"min-w-full border-collapse text-sm\">\n                        <thead>\n                            <tr className=\"bg-muted/50\">\n                                <th className=\"sticky top-0 left-0 z-20 bg-muted/80 p-2 border-b border-r text-xs font-semibold w-[150px] backdrop-blur-sm\">Atacante / Defensor</th>\n                                {attackTroops.map(defender => (\n                                     <th key={defender.id} className=\"sticky top-0 z-10 p-2 border-b border-r text-xs font-semibold w-28 h-28 bg-blue-950/40 backdrop-blur-sm\">\n                                        <div className=\"[writing-mode:vertical-rl] origin-center -rotate-180\">\n                                            <span className=\"truncate block\">{defender.nombre}</span>\n                                        </div>\n                                    </th>\n                                ))}\n                                {defenseTroops.map(defender => (\n                                     <th key={defender.id} className=\"sticky top-0 z-10 p-2 border-b border-r text-xs font-semibold w-28 h-28 bg-red-950/40 backdrop-blur-sm\">\n                                        <div className=\"[writing-mode:vertical-rl] origin-center -rotate-180\">\n                                            <span className=\"truncate block\">{defender.nombre}</span>\n                                        </div>\n                                    </th>\n                                ))}\n                            </tr>\n                        </thead>\n                        <tbody>\n                            {attackTroops.map(attacker => (\n                                <tr key={attacker.id} className=\"even:bg-muted/20\">\n                                    <td className=\"sticky left-0 z-10 bg-card p-2 border-b border-r font-semibold w-[150px]\">{attacker.nombre}</td>\n                                    {allDefenders.map(defender => (\n                                        <td key={defender.id} className={cn(\"p-1 border-b border-r text-center\", attacker.id === defender.id && \"bg-muted/30\")}>\n                                            <Input\n                                                type=\"number\"\n                                                step=\"0.1\"\n                                                className=\"w-20 h-8 mx-auto text-center tabular-nums\"\n                                                placeholder=\"1\"\n                                                value={matrix.get(attacker.id)?.get(defender.id) ?? ''}\n                                                onChange={(e) => handleInputChange(attacker.id, defender.id, e.target.value)}\n                                            />\n                                        </td>\n                                    ))}\n                                </tr>\n                            ))}\n                        </tbody>\n                    </table>\n                </ScrollArea>\n                <div className=\"flex justify-end mt-4\">\n                    <Button onClick={handleSubmit} disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        Guardar Cambios\n                    </Button>\n                </div>\n            </CardContent>\n        </Card>\n    );\n}\n",
    "src/components/admin/forms/troop-config-form.tsx": "\n'use client';\n\nimport { useTransition, useState, useMemo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { saveTroopConfig } from \"@/lib/actions/admin.actions\";\nimport { Loader2, PlusCircle, Trash2 } from \"lucide-react\";\nimport type { ConfiguracionTropa, TipoTropa, TropaBonusContrincante } from \"@/types\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport type { FullConfiguracionEntrenamiento, FullConfiguracionTropa } from \"@/types\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useRouter } from \"next/navigation\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { TRAINING_ORDER } from \"@/lib/constants\";\n\ninterface TroopConfigFormProps {\n    troop: FullConfiguracionTropa | null;\n    allTrainings: FullConfiguracionEntrenamiento[];\n    allTroops: ConfiguracionTropa[];\n    tiposTropa: string[];\n}\n\nfunction CheckboxList({ title, items, selectedItems, onSelectionChange }: { title: string, items: {id: string, nombre: string}[], selectedItems: Set<string>, onSelectionChange: (id: string, checked: boolean) => void}) {\n    return (\n        <div className=\"space-y-2\">\n            <Label>{title}</Label>\n            <div className=\"w-full rounded-md border p-4\">\n                 <div className=\"flex flex-wrap gap-x-4 gap-y-2\">\n                    {items.map(item => (\n                        <div key={item.id} className=\"flex items-center gap-2\">\n                            <Checkbox\n                                id={`${title}-${item.id}`}\n                                checked={selectedItems.has(item.id)}\n                                onCheckedChange={(checked) => onSelectionChange(item.id, !!checked)}\n                            />\n                            <Label htmlFor={`${title}-${item.id}`} className=\"font-normal whitespace-nowrap\">\n                                {item.nombre}\n                            </Label>\n                        </div>\n                    ))}\n                 </div>\n            </div>\n        </div>\n    )\n}\n\ntype BonusContrincanteState = Omit<TropaBonusContrincante, 'created_at' | 'updated_at'>;\n\n\nexport function TroopConfigForm({ troop, allTrainings, allTroops, tiposTropa }: TroopConfigFormProps) {\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n    const router = useRouter();\n\n    const [formData, setFormData] = useState({\n        id: troop?.id || '',\n        nombre: troop?.nombre || '',\n        descripcion: troop?.descripcion || '',\n        urlImagen: troop?.urlImagen || '',\n        costoArmas: troop?.costoArmas || 0,\n        costoMunicion: troop?.costoMunicion || 0,\n        costoDolares: troop?.costoDolares || 0,\n        ataque: troop?.ataque || 0,\n        defensa: troop?.defensa || 0,\n        puntos: troop?.puntos || 0,\n        capacidad: troop?.capacidad || 0,\n        velocidad: troop?.velocidad.toString() || '0',\n        salario: troop?.salario || 0,\n        duracion: troop?.duracion || 0,\n        tipo: troop?.tipo || 'ATAQUE',\n    });\n    \n    const [bonusContrincantes, setBonusContrincantes] = useState<BonusContrincanteState[]>(troop?.bonusContrincante || []);\n\n    const handleAddBonus = () => {\n        setBonusContrincantes([...bonusContrincantes, { id: Date.now().toString(), tropaAtacanteId: troop?.id || '', tropaDefensoraId: '', factorPrioridad: 1.0 }]);\n    };\n\n    const handleRemoveBonus = (id: string) => {\n        setBonusContrincantes(bonusContrincantes.filter(b => b.id !== id));\n    };\n\n    const handleBonusChange = (id: string, field: 'tropaDefensoraId' | 'factorPrioridad', value: string | number) => {\n        setBonusContrincantes(bonusContrincantes.map(b => b.id === id ? { ...b, [field]: value } : b));\n    };\n\n\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n        const { name, value, type } = e.target;\n        const isNumber = type === 'number';\n        setFormData(prev => ({\n            ...prev,\n            [name]: isNumber ? (parseFloat(value) || 0) : value\n        }));\n    };\n\n    const handleSelectChange = (name: string, value: string) => {\n        setFormData(prev => ({ ...prev, [name]: value }));\n    }\n    \n    const [bonusAtaque, setBonusAtaque] = useState(new Set(troop?.bonusAtaque || []));\n    const [bonusDefensa, setBonusDefensa] = useState(new Set(troop?.bonusDefensa || []));\n    \n    // In DB 'requisitos' is now Json [{id, lvl}], so we map it correctly.\n    const initialRequirements = new Map<string, number>(\n      ((troop?.requisitos || []) as unknown as {id: string, lvl: number}[]).map(req => [req.id, req.lvl])\n    );\n    const [requisitos, setRequisitos] = useState<Map<string, number>>(initialRequirements);\n\n\n    const handleSelectionChange = (setter: React.Dispatch<React.SetStateAction<Set<string>>>, id: string, checked: boolean) => {\n        setter(prev => {\n            const newSet = new Set(prev);\n            if (checked) {\n                newSet.add(id);\n            } else {\n                newSet.delete(id);\n            }\n            return newSet;\n        });\n    }\n\n    const handleRequirementChange = (trainingId: string, checked: boolean) => {\n        const newRequirements = new Map(requisitos);\n        if (checked) {\n            newRequirements.set(trainingId, 1); // Default to level 1\n        } else {\n            newRequirements.delete(trainingId);\n        }\n        setRequisitos(newRequirements);\n    };\n\n    const handleLevelChange = (trainingId: string, level: number) => {\n        const newRequirements = new Map(requisitos);\n        if (level > 0) {\n            newRequirements.set(trainingId, level);\n        } else {\n            // If level is 0 or less, we might want to remove the requirement\n            // Or just keep it at a minimum of 1. Let's enforce minimum 1.\n            newRequirements.set(trainingId, 1);\n        }\n        setRequisitos(newRequirements);\n    };\n\n\n    const sortedTrainings = useMemo(() => {\n        return [...allTrainings].sort((a, b) => {\n            const indexA = TRAINING_ORDER.indexOf(a.id);\n            const indexB = TRAINING_ORDER.indexOf(b.id);\n            if (indexA === -1) return 1;\n            if (indexB === -1) return -1;\n            return indexA - indexB;\n        });\n    }, [allTrainings]);\n\n    const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n        e.preventDefault();\n        const form = new FormData(e.currentTarget);\n        form.append('bonusAtaque', Array.from(bonusAtaque).join(','));\n        form.append('bonusDefensa', Array.from(bonusDefensa).join(','));\n        \n        // Serialize requirements. Note: The backend expects object with requiredTrainingId and requiredLevel, \n        // even though it currently only saves IDs to string[].\n        // We preserve the level data in the POST for future compatibility or advanced handling.\n        const requirementsData = Array.from(requisitos.entries()).map(([id, level]) => ({ requiredTrainingId: id, requiredLevel: level }));\n        form.append('requisitos', JSON.stringify(requirementsData));\n\n        form.append('bonusContrincantes', JSON.stringify(\n            bonusContrincantes.map(({id, tropaAtacanteId, ...rest}) => rest))\n        );\n        \n        startTransition(async () => {\n            const result = await saveTroopConfig(form);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Configuración guardada.' });\n                router.push('/admin/panel/troops');\n            }\n        });\n    }\n\n    return (\n        <form onSubmit={handleSubmit} className=\"flex flex-col h-full\">\n            <ScrollArea className=\"flex-grow p-1 pr-4\">\n                <div className=\"space-y-6\">\n                    <input type=\"hidden\" name=\"id\" value={troop?.id || ''} />\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"idForm\">ID (Editable solo al crear)</Label>\n                            <Input id=\"idForm\" name=\"idForm\" value={formData.id} onChange={handleInputChange} required disabled={!!troop} />\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"nombre\">Nombre</Label>\n                            <Input id=\"nombre\" name=\"nombre\" value={formData.nombre} onChange={handleInputChange} required />\n                        </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"descripcion\">Descripción</Label>\n                        <Textarea id=\"descripcion\" name=\"descripcion\" value={formData.descripcion} onChange={handleInputChange} />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"urlImagen\">URL de Imagen</Label>\n                        <Input id=\"urlImagen\" name=\"urlImagen\" value={formData.urlImagen} onChange={handleInputChange} />\n                    </div>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"costoArmas\">Armas</Label>\n                            <Input id=\"costoArmas\" name=\"costoArmas\" type=\"number\" value={formData.costoArmas || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"costoMunicion\">Munición</Label>\n                            <Input id=\"costoMunicion\" name=\"costoMunicion\" type=\"number\" value={formData.costoMunicion || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"costoDolares\">Dólares</Label>\n                            <Input id=\"costoDolares\" name=\"costoDolares\" type=\"number\" value={formData.costoDolares || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                    </div>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"ataque\">Ataque</Label>\n                            <Input id=\"ataque\" name=\"ataque\" type=\"number\" value={formData.ataque || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"defensa\">Defensa</Label>\n                            <Input id=\"defensa\" name=\"defensa\" type=\"number\" value={formData.defensa || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"puntos\">Puntos</Label>\n                            <Input id=\"puntos\" name=\"puntos\" type=\"number\" step=\"0.01\" value={formData.puntos || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                    </div>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-4 gap-4\">\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"capacidad\">Capacidad</Label>\n                            <Input id=\"capacidad\" name=\"capacidad\" type=\"number\" value={formData.capacidad || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"velocidad\">Velocidad</Label>\n                            <Input id=\"velocidad\" name=\"velocidad\" type=\"text\" value={formData.velocidad} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"salario\">Salario</Label>\n                            <Input id=\"salario\" name=\"salario\" type=\"number\" value={formData.salario || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"duracion\">Duración (s)</Label>\n                            <Input id=\"duracion\" name=\"duracion\" type=\"number\" value={formData.duracion || ''} onChange={handleInputChange} placeholder=\"0\"/>\n                        </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"tipo\">Tipo de Tropa</Label>\n                        <Select name=\"tipo\" value={formData.tipo} onValueChange={(value) => handleSelectChange('tipo', value)}>\n                            <SelectTrigger>\n                                <SelectValue placeholder=\"Selecciona un tipo\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {tiposTropa.map(tipo => (\n                                    <SelectItem key={tipo} value={tipo}>{tipo}</SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n                    \n                    <div className=\"space-y-4\">\n                        <CheckboxList \n                            title=\"Bonus Ataque (Entrenamientos)\"\n                            items={sortedTrainings}\n                            selectedItems={bonusAtaque}\n                            onSelectionChange={(id, checked) => handleSelectionChange(setBonusAtaque, id, checked)}\n                        />\n\n                        <CheckboxList \n                            title=\"Bonus Defensa (Entrenamientos)\"\n                            items={sortedTrainings}\n                            selectedItems={bonusDefensa}\n                            onSelectionChange={(id, checked) => handleSelectionChange(setBonusDefensa, id, checked)}\n                        />\n\n                         <div className=\"space-y-2\">\n                            <Label>Requisitos de Entrenamiento</Label>\n                            <div className=\"w-full rounded-md border p-4 grid grid-cols-2 gap-4\">\n                                {sortedTrainings.map(item => {\n                                    const isChecked = requisitos.has(item.id);\n                                    return (\n                                        <div key={item.id} className=\"flex items-center gap-2 justify-between\">\n                                            <div className=\"flex items-center gap-2\">\n                                                <Checkbox\n                                                    id={`req-${item.id}`}\n                                                    checked={isChecked}\n                                                    onCheckedChange={(checked) => handleRequirementChange(item.id, !!checked)}\n                                                />\n                                                <Label htmlFor={`req-${item.id}`} className=\"font-normal whitespace-nowrap\">\n                                                    {item.nombre}\n                                                </Label>\n                                            </div>\n                                            {isChecked && (\n                                                <div className=\"flex items-center gap-2\">\n                                                    <Label htmlFor={`level-${item.id}`} className=\"text-xs\">Nvl:</Label>\n                                                    <Input\n                                                        id={`level-${item.id}`}\n                                                        type=\"number\"\n                                                        min=\"1\"\n                                                        value={requisitos.get(item.id) || 1}\n                                                        onChange={(e) => handleLevelChange(item.id, parseInt(e.target.value, 10))}\n                                                        className=\"h-8 w-16\"\n                                                    />\n                                                </div>\n                                            )}\n                                        </div>\n                                    )\n                                })}\n                            </div>\n                        </div>\n                    </div>\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Bonificaciones de Ataque Específicas</CardTitle>\n                            <CardDescription>\n                                Define un multiplicador de daño contra tipos de tropa específicos. El valor por defecto es 1.\n                            </CardDescription>\n                        </CardHeader>\n                        <CardContent className=\"space-y-2\">\n                            {bonusContrincantes.map((bonus, index) => (\n                                <div key={bonus.id} className=\"flex items-center gap-2 p-2 border rounded-md\">\n                                    <Select \n                                        value={bonus.tropaDefensoraId} \n                                        onValueChange={(value) => handleBonusChange(bonus.id, 'tropaDefensoraId', value)}\n                                    >\n                                        <SelectTrigger>\n                                            <SelectValue placeholder=\"Selecciona Tropa Defensora...\" />\n                                        </SelectTrigger>\n                                        <SelectContent>\n                                            {allTroops.map(t => (\n                                                <SelectItem key={t.id} value={t.id}>{t.nombre}</SelectItem>\n                                            ))}\n                                        </SelectContent>\n                                    </Select>\n                                    <Input\n                                        type=\"number\"\n                                        step=\"0.1\"\n                                        min=\"0.1\"\n                                        max=\"2.9\"\n                                        value={bonus.factorPrioridad}\n                                        onChange={(e) => handleBonusChange(bonus.id, 'factorPrioridad', parseFloat(e.target.value))}\n                                        className=\"w-24\"\n                                    />\n                                    <Button type=\"button\" variant=\"ghost\" size=\"icon\" onClick={() => handleRemoveBonus(bonus.id)}>\n                                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                                    </Button>\n                                </div>\n                            ))}\n                            <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={handleAddBonus}>\n                                <PlusCircle className=\"mr-2 h-4 w-4\" />\n                                Añadir Bonificación de Ataque\n                            </Button>\n                        </CardContent>\n                    </Card>\n                </div>\n            </ScrollArea>\n            <div className=\"flex justify-end gap-2 pt-6 border-t mt-6 shrink-0\">\n                <Button type=\"button\" variant=\"ghost\" onClick={() => router.push('/admin/panel/troops')}>Cancelar</Button>\n                <Button type=\"submit\" disabled={isPending}>\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Guardar\n                </Button>\n            </div>\n        </form>\n    );\n}\n",
    "src/components/admin/forms/training-config-form.tsx": "'use client';\n\nimport type { FullConfiguracionEntrenamiento } from \"@/types\";\nimport { useMemo, useState, useTransition } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { saveTrainingConfig } from \"@/lib/actions/admin.actions\";\nimport { Loader2 } from \"lucide-react\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useRouter } from \"next/navigation\";\nimport { TRAINING_ORDER } from \"@/lib/constants\";\ninterface TrainingConfigFormProps {\n    training: FullConfiguracionEntrenamiento | null;\n    allTrainings: FullConfiguracionEntrenamiento[];\n}\nexport function TrainingConfigForm({ training, allTrainings }: TrainingConfigFormProps) {\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n    const router = useRouter();\n    const [formData, setFormData] = useState({\n        id: training?.id || '',\n        nombre: training?.nombre || '',\n        urlImagen: training?.urlImagen || '',\n        costoArmas: training?.costoArmas || 0,\n        costoMunicion: training?.costoMunicion || 0,\n        costoDolares: training?.costoDolares || 0,\n        duracion: training?.duracion || 0,\n        puntos: training?.puntos || 0,\n    });\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n        const { name, value, type } = e.target;\n        const isNumber = type === 'number';\n        setFormData(prev => ({\n            ...prev,\n            [name]: isNumber ? (parseFloat(value) || 0) : value\n        }));\n    };\n    const initialRequirements = new Map(\n        training?.requisitos.map(req => [req.requiredTrainingId, req.requiredLevel])\n    );\n    const [requirements, setRequirements] = useState<Map<string, number>>(initialRequirements);\n    const handleRequirementChange = (trainingId: string, checked: boolean) => {\n        const newRequirements = new Map(requirements);\n        if (checked) {\n            newRequirements.set(trainingId, 1);\n        } else {\n            newRequirements.delete(trainingId);\n        }\n        setRequirements(newRequirements);\n    };\n    const handleLevelChange = (trainingId: string, level: number) => {\n        const newRequirements = new Map(requirements);\n        if (level > 0) {\n            newRequirements.set(trainingId, level);\n        } else {\n            newRequirements.delete(trainingId);\n        }\n        setRequirements(newRequirements);\n    };\n    const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n        e.preventDefault();\n        const form = new FormData(e.currentTarget);\n        requirements.forEach((level, id) => {\n            form.append('requirement_ids', id);\n            form.append(`requirement_level_${id}`, level.toString());\n        });\n        startTransition(async () => {\n            const result = await saveTrainingConfig(form);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Configuración guardada.' });\n                router.push('/admin/panel/trainings');\n            }\n        });\n    }\n    const availableRequirements = useMemo(() => {\n        const otherTrainings = allTrainings.filter(t => t.id !== training?.id);\n        return [...otherTrainings].sort((a, b) => {\n            const indexA = TRAINING_ORDER.indexOf(a.id);\n            const indexB = TRAINING_ORDER.indexOf(b.id);\n            if(indexA === -1) return 1;\n            if(indexB === -1) return -1;\n            return indexA - indexB;\n        });\n    }, [allTrainings, training]);\n    return (\n        <form onSubmit={handleSubmit}>\n            <div className=\"space-y-4\">\n                <input type=\"hidden\" name=\"originalId\" value={training?.id || ''} />\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"id\">ID</Label>\n                        <Input id=\"id\" name=\"id\" value={formData.id} onChange={handleInputChange} required disabled={!!training} />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"nombre\">Nombre</Label>\n                        <Input id=\"nombre\" name=\"nombre\" value={formData.nombre} onChange={handleInputChange} required />\n                    </div>\n                </div>\n                <div className=\"space-y-2\">\n                    <Label htmlFor=\"urlImagen\">URL de Imagen</Label>\n                    <Input id=\"urlImagen\" name=\"urlImagen\" value={formData.urlImagen} onChange={handleInputChange} />\n                </div>\n                <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"costoArmas\">Armas</Label>\n                        <Input id=\"costoArmas\" name=\"costoArmas\" type=\"number\" value={formData.costoArmas || ''} onChange={handleInputChange} placeholder=\"0\" />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"costoMunicion\">Munición</Label>\n                        <Input id=\"costoMunicion\" name=\"costoMunicion\" type=\"number\" value={formData.costoMunicion || ''} onChange={handleInputChange} placeholder=\"0\" />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"costoDolares\">Dólares</Label>\n                        <Input id=\"costoDolares\" name=\"costoDolares\" type=\"number\" value={formData.costoDolares || ''} onChange={handleInputChange} placeholder=\"0\" />\n                    </div>\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"puntos\">Puntos</Label>\n                        <Input id=\"puntos\" name=\"puntos\" type=\"number\" step=\"0.01\" value={formData.puntos || ''} onChange={handleInputChange} placeholder=\"0\" />\n                    </div>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"duracion\">Duración (s)</Label>\n                        <Input id=\"duracion\" name=\"duracion\" type=\"number\" value={formData.duracion || ''} onChange={handleInputChange} placeholder=\"0\" />\n                    </div>\n                </div>\n                <div className=\"space-y-2\">\n                    <Label>Requisitos</Label>\n                    <div className=\"border rounded-md p-4 grid grid-cols-2 gap-x-4 gap-y-2\">\n                        {availableRequirements.map(reqTraining => {\n                            const isChecked = requirements.has(reqTraining.id);\n                            return (\n                                <div key={reqTraining.id} className=\"flex items-center gap-4\">\n                                    <div className=\"flex items-center gap-2 flex-1\">\n                                        <Checkbox\n                                            id={`req-${reqTraining.id}`}\n                                            checked={isChecked}\n                                            onCheckedChange={(checked) => handleRequirementChange(reqTraining.id, !!checked)}\n                                        />\n                                        <Label htmlFor={`req-${reqTraining.id}`} className=\"font-normal cursor-pointer\">\n                                            {reqTraining.nombre}\n                                        </Label>\n                                    </div>\n                                    {isChecked && (\n                                        <div className=\"flex items-center gap-2\">\n                                            <Label htmlFor={`level-${reqTraining.id}`} className=\"text-xs\">Nivel:</Label>\n                                            <Input\n                                                id={`level-${reqTraining.id}`}\n                                                type=\"number\"\n                                                value={requirements.get(reqTraining.id) || ''}\n                                                onChange={(e) => handleLevelChange(reqTraining.id, parseInt(e.target.value, 10))}\n                                                className=\"h-8 w-20\"\n                                                min=\"1\"\n                                                placeholder=\"1\"\n                                            />\n                                        </div>\n                                    )}\n                                </div>\n                            )\n                        })}\n                    </div>\n                </div>\n            </div>\n            <div className=\"flex justify-end gap-2 pt-4 border-t mt-4\">\n                <Button type=\"button\" variant=\"ghost\" onClick={() => router.push('/admin/panel/trainings')}>Cancelar</Button>\n                <Button type=\"submit\" disabled={isPending}>\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Guardar\n                </Button>\n            </div>\n        </form>\n    );\n}",
    "src/components/admin/forms/room-config-form.tsx": "\n'use client';\n\nimport { useTransition, useState, useEffect } from \"react\";\nimport Image from \"next/image\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { saveRoomConfig } from \"@/lib/actions/admin.actions\";\nimport { Loader2 } from \"lucide-react\";\nimport type { ConfiguracionHabitacion } from \"@/types\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useRouter } from \"next/navigation\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\ninterface RoomConfigFormProps {\n    room: (ConfiguracionHabitacion & { requisitos: { requiredRoomId: string; requiredLevel: number }[] }) | null;\n    allRooms: ConfiguracionHabitacion[];\n}\n\nexport function RoomConfigForm({ room, allRooms }: RoomConfigFormProps) {\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n    const router = useRouter();\n\n    const [formData, setFormData] = useState({\n        id: room?.id || '',\n        nombre: room?.nombre || '',\n        descripcion: room?.descripcion || '',\n        urlImagen: room?.urlImagen || '',\n        costoArmas: room?.costoArmas || 0,\n        costoMunicion: room?.costoMunicion || 0,\n        costoDolares: room?.costoDolares || 0,\n        duracion: room?.duracion || 0,\n        puntos: room?.puntos || 0,\n        produccionBase: room?.produccionBase || 0,\n        produccionRecurso: room?.produccionRecurso || '',\n    });\n\n    // Preview Logic\n    const [imagePreview, setImagePreview] = useState<string | null>(room?.urlImagen || null);\n\n    useEffect(() => {\n        if (formData.urlImagen) {\n            setImagePreview(formData.urlImagen);\n        } else {\n            setImagePreview(null);\n        }\n    }, [formData.urlImagen]);\n\n\n    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n        const { name, value, type } = e.target;\n        const isNumber = type === 'number';\n        setFormData(prev => ({\n            ...prev,\n            [name]: isNumber ? (parseFloat(value) || 0) : value\n        }));\n    };\n    \n    const initialRequirements = new Map(\n        (room?.requisitos || []).map(req => [req.requiredRoomId, req.requiredLevel])\n    );\n    const [requirements, setRequirements] = useState<Map<string, number>>(initialRequirements);\n    const [reqSearch, setReqSearch] = useState(\"\");\n\n    const handleRequirementChange = (roomId: string, checked: boolean) => {\n        const newRequirements = new Map(requirements);\n        if (checked) {\n            newRequirements.set(roomId, 1);\n        } else {\n            newRequirements.delete(roomId);\n        }\n        setRequirements(newRequirements);\n    };\n\n    const handleLevelChange = (roomId: string, level: number) => {\n        const newRequirements = new Map(requirements);\n        if (level > 0) {\n            newRequirements.set(roomId, level);\n        } else {\n            newRequirements.delete(roomId);\n        }\n        setRequirements(newRequirements);\n    };\n\n    const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n        e.preventDefault();\n        const form = new FormData(e.currentTarget);\n        \n        requirements.forEach((level, id) => {\n            form.append('requirement_ids', id);\n            form.append(`requirement_level_${id}`, level.toString());\n        });\n        \n        startTransition(async () => {\n            const result = await saveRoomConfig(form);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Configuración guardada.' });\n                router.push('/admin/panel/rooms');\n            }\n        });\n    }\n    \n    const availableRequirements = allRooms.filter(r => r.id !== room?.id);\n    const filteredRequirements = availableRequirements.filter(r => r.nombre.toLowerCase().includes(reqSearch.toLowerCase()));\n\n    return (\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <input type=\"hidden\" name=\"originalId\" value={room?.id || ''} />\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n                {/* Left Column: General Info */}\n                <div className=\"space-y-6\">\n                    <Card>\n                        <CardContent className=\"pt-6 space-y-4\">\n                            <div className=\"space-y-2\">\n                                <Label htmlFor=\"id\">ID (Identificador único)</Label>\n                                <Input id=\"id\" name=\"id\" value={formData.id} onChange={handleInputChange} required disabled={!!room} className=\"font-mono\" />\n                                {!room && <p className=\"text-xs text-muted-foreground\">Solo editable al crear.</p>}\n                            </div>\n                            <div className=\"space-y-2\">\n                                <Label htmlFor=\"nombre\">Nombre del Edificio <span className=\"text-destructive\">*</span></Label>\n                                <Input id=\"nombre\" name=\"nombre\" value={formData.nombre} onChange={handleInputChange} required />\n                            </div>\n                            <div className=\"space-y-2\">\n                                <Label htmlFor=\"descripcion\">Descripción</Label>\n                                <Textarea id=\"descripcion\" name=\"descripcion\" value={formData.descripcion} onChange={handleInputChange} rows={3} />\n                            </div>\n                            <div className=\"space-y-2\">\n                                <Label htmlFor=\"urlImagen\">URL de Imagen</Label>\n                                <div className=\"flex gap-4 items-start\">\n                                    <div className=\"flex-1\">\n                                        <Input id=\"urlImagen\" name=\"urlImagen\" value={formData.urlImagen} onChange={handleInputChange} />\n                                    </div>\n                                    {imagePreview && (\n                                        <div className=\"w-16 h-16 rounded-md border bg-muted overflow-hidden shrink-0 relative\">\n                                            <Image\n                                                src={imagePreview}\n                                                alt=\"Preview\"\n                                                fill\n                                                className=\"object-cover\"\n                                                unoptimized\n                                                onError={() => setImagePreview(null)}\n                                            />\n                                        </div>\n                                    )}\n                                </div>\n                            </div>\n                        </CardContent>\n                    </Card>\n                </div>\n\n                {/* Right Column: Numbers & Logic */}\n                <div className=\"space-y-6\">\n                     <Tabs defaultValue=\"costs\">\n                        <TabsList className=\"grid w-full grid-cols-3\">\n                            <TabsTrigger value=\"costs\">Costos & Tiempos</TabsTrigger>\n                            <TabsTrigger value=\"production\">Producción</TabsTrigger>\n                            <TabsTrigger value=\"requirements\">Requisitos</TabsTrigger>\n                        </TabsList>\n\n                        <TabsContent value=\"costs\" className=\"mt-4\">\n                            <Card>\n                                <CardContent className=\"pt-6 space-y-4\">\n                                    <div className=\"grid grid-cols-2 gap-4\">\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"costoArmas\">Costo Armas</Label>\n                                            <Input id=\"costoArmas\" name=\"costoArmas\" type=\"number\" value={formData.costoArmas || ''} onChange={handleInputChange} placeholder=\"0\" min=\"0\" />\n                                        </div>\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"costoMunicion\">Costo Munición</Label>\n                                            <Input id=\"costoMunicion\" name=\"costoMunicion\" type=\"number\" value={formData.costoMunicion || ''} onChange={handleInputChange} placeholder=\"0\" min=\"0\" />\n                                        </div>\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"costoDolares\">Costo Dólares</Label>\n                                            <Input id=\"costoDolares\" name=\"costoDolares\" type=\"number\" value={formData.costoDolares || ''} onChange={handleInputChange} placeholder=\"0\" min=\"0\" />\n                                        </div>\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"duracion\">Duración (segundos)</Label>\n                                            <Input id=\"duracion\" name=\"duracion\" type=\"number\" value={formData.duracion || ''} onChange={handleInputChange} placeholder=\"0\" min=\"0\" />\n                                        </div>\n                                    </div>\n                                    <div className=\"pt-2\">\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"puntos\">Puntos Obtenidos</Label>\n                                            <Input id=\"puntos\" name=\"puntos\" type=\"number\" step=\"0.01\" value={formData.puntos || ''} onChange={handleInputChange} placeholder=\"0\" />\n                                        </div>\n                                    </div>\n                                </CardContent>\n                            </Card>\n                        </TabsContent>\n\n                        <TabsContent value=\"production\" className=\"mt-4\">\n                            <Card>\n                                <CardContent className=\"pt-6 space-y-4\">\n                                    <div className=\"grid grid-cols-2 gap-4\">\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"produccionBase\">Producción Base / Hora</Label>\n                                            <Input id=\"produccionBase\" name=\"produccionBase\" type=\"number\" value={formData.produccionBase || ''} onChange={handleInputChange} placeholder=\"0\" />\n                                        </div>\n                                        <div className=\"space-y-2\">\n                                            <Label htmlFor=\"produccionRecurso\">Tipo de Recurso</Label>\n                                             {/* Could be a Select if we knew all resource types */}\n                                            <Input id=\"produccionRecurso\" name=\"produccionRecurso\" value={formData.produccionRecurso || ''} onChange={handleInputChange} placeholder=\"ej: armas\" />\n                                            <p className=\"text-xs text-muted-foreground\">Dejar vacío si no produce recursos.</p>\n                                        </div>\n                                    </div>\n                                </CardContent>\n                            </Card>\n                        </TabsContent>\n\n                        <TabsContent value=\"requirements\" className=\"mt-4\">\n                            <Card>\n                                <CardContent className=\"pt-6\">\n                                    <div className=\"space-y-4\">\n                                        <Input\n                                            placeholder=\"Buscar edificio...\"\n                                            value={reqSearch}\n                                            onChange={(e) => setReqSearch(e.target.value)}\n                                            className=\"mb-2\"\n                                        />\n                                        <ScrollArea className=\"h-[200px] border rounded-md p-2\">\n                                            <div className=\"space-y-2\">\n                                                {filteredRequirements.map(reqRoom => {\n                                                    const isChecked = requirements.has(reqRoom.id);\n                                                    return (\n                                                        <div key={reqRoom.id} className=\"flex items-center justify-between p-2 hover:bg-muted/50 rounded-md\">\n                                                            <div className=\"flex items-center gap-2\">\n                                                                <Checkbox\n                                                                    id={`req-${reqRoom.id}`}\n                                                                    checked={isChecked}\n                                                                    onCheckedChange={(checked) => handleRequirementChange(reqRoom.id, !!checked)}\n                                                                />\n                                                                <Label htmlFor={`req-${reqRoom.id}`} className=\"font-normal cursor-pointer\">\n                                                                    {reqRoom.nombre}\n                                                                </Label>\n                                                            </div>\n                                                            {isChecked && (\n                                                                <div className=\"flex items-center gap-2\">\n                                                                    <Label htmlFor={`level-${reqRoom.id}`} className=\"text-xs\">Nivel:</Label>\n                                                                    <Input\n                                                                        id={`level-${reqRoom.id}`}\n                                                                        type=\"number\"\n                                                                        value={requirements.get(reqRoom.id) || ''}\n                                                                        onChange={(e) => handleLevelChange(reqRoom.id, parseInt(e.target.value, 10))}\n                                                                        className=\"h-7 w-16 text-right\"\n                                                                        min=\"1\"\n                                                                    />\n                                                                </div>\n                                                            )}\n                                                        </div>\n                                                    )\n                                                })}\n                                                {filteredRequirements.length === 0 && (\n                                                    <p className=\"text-sm text-muted-foreground text-center py-4\">No se encontraron edificios.</p>\n                                                )}\n                                            </div>\n                                        </ScrollArea>\n                                    </div>\n                                </CardContent>\n                            </Card>\n                        </TabsContent>\n                    </Tabs>\n                </div>\n            </div>\n\n            <div className=\"flex justify-end gap-4 pt-6 border-t\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => router.push('/admin/panel/rooms')}>Cancelar</Button>\n                <Button type=\"submit\" disabled={isPending}>\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Guardar Cambios\n                </Button>\n            </div>\n        </form>\n    );\n}\n",
    "src/components/admin/forms/create-property-form.tsx": "\n'use client';\n\nimport { useState, useTransition } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2 } from \"lucide-react\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { createPropertyForUser } from \"@/lib/actions/admin.actions\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport type { FullConfiguracionHabitacion } from \"@/types\";\n\ninterface CreatePropertyFormProps {\n    users: { id: string; name: string; }[];\n    allRooms: FullConfiguracionHabitacion[];\n}\n\nexport function CreatePropertyForm({ users, allRooms }: CreatePropertyFormProps) {\n    const { toast } = useToast();\n    const [isPending, startTransition] = useTransition();\n    const [roomLevels, setRoomLevels] = useState<Record<string, number>>({});\n\n    const handleRoomLevelChange = (roomId: string, value: string) => {\n        const level = parseInt(value, 10);\n        setRoomLevels(prev => ({\n            ...prev,\n            [roomId]: isNaN(level) ? 0 : level\n        }));\n    }\n\n    const handleSubmit = (formData: FormData) => {\n        formData.append('roomLevels', JSON.stringify(roomLevels));\n        \n        startTransition(async () => {\n            const result = await createPropertyForUser(formData);\n            if (result.error) {\n                toast({\n                    variant: 'destructive',\n                    title: 'Error al crear la propiedad',\n                    description: result.error,\n                });\n            } else {\n                 toast({\n                    title: '¡Propiedad Creada!',\n                    description: result.success,\n                });\n            }\n        });\n    }\n\n    return (\n        <form action={handleSubmit}>\n            <Card>\n                <CardHeader>\n                    <CardTitle>Crear Nueva Propiedad para Usuario</CardTitle>\n                    <CardDescription>\n                        Selecciona un usuario, define las coordenadas y los niveles iniciales de las habitaciones.\n                    </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"user-select\">Seleccionar Usuario</Label>\n                        <Select name=\"userId\" disabled={isPending}>\n                            <SelectTrigger id=\"user-select\">\n                                <SelectValue placeholder=\"Elige un usuario...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                                {users.map(user => (\n                                    <SelectItem key={user.id} value={user.id}>\n                                        {user.name}\n                                    </SelectItem>\n                                ))}\n                            </SelectContent>\n                        </Select>\n                    </div>\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                         <div className=\"space-y-2\">\n                            <Label htmlFor=\"ciudad\">Ciudad</Label>\n                            <Input id=\"ciudad\" name=\"ciudad\" type=\"number\" defaultValue=\"1\" required disabled={isPending} />\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"barrio\">Barrio</Label>\n                            <Input id=\"barrio\" name=\"barrio\" type=\"number\" defaultValue=\"1\" required disabled={isPending} />\n                        </div>\n                        <div className=\"space-y-2\">\n                            <Label htmlFor=\"edificio\">Edificio</Label>\n                            <Input id=\"edificio\" name=\"edificio\" type=\"number\" defaultValue=\"1\" required disabled={isPending} />\n                        </div>\n                    </div>\n\n                    <Separator />\n                    \n                    <div>\n                        <h4 className=\"font-semibold mb-2\">Niveles de Habitaciones Iniciales</h4>\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                            {allRooms.map(room => (\n                                <div key={room.id} className=\"space-y-1.5\">\n                                    <Label htmlFor={`room-${room.id}`} className=\"text-xs\">{room.nombre}</Label>\n                                    <Input\n                                        id={`room-${room.id}`}\n                                        type=\"number\"\n                                        min=\"0\"\n                                        placeholder=\"0\"\n                                        value={roomLevels[room.id] || ''}\n                                        onChange={(e) => handleRoomLevelChange(room.id, e.target.value)}\n                                        disabled={isPending}\n                                        className=\"h-8\"\n                                    />\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n\n                </CardContent>\n                <CardContent className=\"p-6 pt-0\">\n                    <Button type=\"submit\" disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        Crear Propiedad\n                    </Button>\n                </CardContent>\n            </Card>\n        </form>\n    )\n}\n",
    "src/components/admin/room-config-table.tsx": "'use client';\nimport { useState } from \"react\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"../ui/table\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"../ui/card\";\nimport { Button } from \"../ui/button\";\nimport { Input } from \"../ui/input\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuTrigger } from \"../ui/dropdown-menu\";\nimport { deleteRoomConfig } from \"@/lib/actions/admin.actions\";\nimport { DeleteConfigButton } from \"./delete-config-button\";\nimport type { FullConfiguracionHabitacion } from \"@/types\";\nimport { PlusCircle, Search, MoreHorizontal, Pencil, Trash2 } from \"lucide-react\";\nimport { ScrollArea } from \"../ui/scroll-area\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { ExportButton } from \"./export-button\";\n\n\ninterface RoomConfigTableProps {\n    initialData: FullConfiguracionHabitacion[];\n}\n\nfunction formatRequirements(requisitos: FullConfiguracionHabitacion['requisitos'], allRooms: FullConfiguracionHabitacion[]) {\n    if (!requisitos || requisitos.length === 0) return '-';\n    const allRoomsMap = new Map(allRooms.map(r => [r.id, r.nombre]));\n    return requisitos.map(req => `${allRoomsMap.get(req.requiredRoomId) || req.requiredRoomId} (Nvl ${req.requiredLevel})`).join(', ');\n}\n\n\nexport function RoomConfigTable({ initialData }: RoomConfigTableProps) {\n    const router = useRouter();\n    const [searchTerm, setSearchTerm] = useState(\"\");\n\n    const filteredData = initialData.filter(room =>\n        room.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        room.id.toLowerCase().includes(searchTerm.toLowerCase())\n    );\n\n    return (\n        <Card>\n            <CardHeader>\n                <CardTitle>Configuración de Habitaciones</CardTitle>\n                <CardDescription>Visualiza, edita y crea nuevas configuraciones para las habitaciones.</CardDescription>\n            </CardHeader>\n            <CardContent>\n                <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4 mb-6\">\n                    <div className=\"relative w-full sm:w-72\">\n                        <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n                        <Input\n                            placeholder=\"Buscar por nombre o ID...\"\n                            className=\"pl-8\"\n                            value={searchTerm}\n                            onChange={(e) => setSearchTerm(e.target.value)}\n                        />\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                         <ExportButton data={initialData} filename=\"config_habitaciones\" tableName=\"ConfiguracionHabitacion\" />\n                         <Button asChild size=\"sm\">\n                            <Link href=\"/admin/panel/rooms/new\">\n                                <PlusCircle className=\"mr-2 h-4 w-4\" />\n                                Crear Nueva\n                            </Link>\n                        </Button>\n                    </div>\n                </div>\n\n                <div className=\"rounded-md border\">\n                    <Table>\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead className=\"w-[100px]\">ID</TableHead>\n                                <TableHead>Nombre</TableHead>\n                                <TableHead className=\"hidden md:table-cell\">Requisitos</TableHead>\n                                <TableHead className=\"text-right font-mono\">Puntos</TableHead>\n                                <TableHead className=\"text-right font-mono\">Armas</TableHead>\n                                <TableHead className=\"w-[50px]\"></TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {filteredData.length === 0 ? (\n                                <TableRow>\n                                    <TableCell colSpan={6} className=\"h-24 text-center\">\n                                        No se encontraron resultados.\n                                    </TableCell>\n                                </TableRow>\n                            ) : (\n                                filteredData.map(room => (\n                                    <TableRow key={room.id} className=\"even:bg-muted/50\">\n                                        <TableCell className=\"font-mono text-xs\">{room.id}</TableCell>\n                                        <TableCell className=\"font-medium\">{room.nombre}</TableCell>\n                                        <TableCell className=\"text-xs hidden md:table-cell text-muted-foreground\">\n                                            {formatRequirements(room.requisitos, initialData)}\n                                        </TableCell>\n                                        <TableCell className=\"text-right font-mono\">{room.puntos}</TableCell>\n                                        <TableCell className=\"text-right font-mono\">{room.costoArmas.toLocaleString('de-DE')}</TableCell>\n                                        <TableCell>\n                                            <DropdownMenu>\n                                                <DropdownMenuTrigger asChild>\n                                                    <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\n                                                        <span className=\"sr-only\">Abrir menú</span>\n                                                        <MoreHorizontal className=\"h-4 w-4\" />\n                                                    </Button>\n                                                </DropdownMenuTrigger>\n                                                <DropdownMenuContent align=\"end\">\n                                                    <DropdownMenuLabel>Acciones</DropdownMenuLabel>\n                                                    <DropdownMenuItem asChild>\n                                                        <Link href={`/admin/panel/rooms/${room.id}`} className=\"cursor-pointer\">\n                                                            <Pencil className=\"mr-2 h-4 w-4\" />\n                                                            Editar\n                                                        </Link>\n                                                    </DropdownMenuItem>\n                                                    <DropdownMenuItem onSelect={(e) => e.preventDefault()}>\n                                                        <DeleteConfigButton\n                                                            id={room.id}\n                                                            action={deleteRoomConfig}\n                                                            variant=\"ghost\"\n                                                            size=\"default\"\n                                                            className=\"w-full justify-start h-8 px-2 text-destructive hover:text-destructive hover:bg-destructive/10\"\n                                                            label={<><Trash2 className=\"mr-2 h-4 w-4\" /> Eliminar</>}\n                                                        />\n                                                    </DropdownMenuItem>\n                                                </DropdownMenuContent>\n                                            </DropdownMenu>\n                                        </TableCell>\n                                    </TableRow>\n                                ))\n                            )}\n                        </TableBody>\n                    </Table>\n                </div>\n            </CardContent>\n        </Card>\n    );\n}",
    "src/components/admin/export-schema-button.tsx": "'use client';\n\nimport { useState, useTransition } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from '@/hooks/use-toast';\nimport { Download, Loader2 } from 'lucide-react';\nimport { exportSchemaDataToJSON } from '@/lib/actions/admin.actions';\n\ninterface ExportSchemaButtonProps {\n  data: any[];\n  fileName: string;\n}\n\nexport function ExportSchemaButton({ data, fileName }: ExportSchemaButtonProps) {\n  const { toast } = useToast();\n  const [isPending, startTransition] = useTransition();\n\n  const handleExport = () => {\n    startTransition(async () => {\n      const result = await exportSchemaDataToJSON(data, fileName);\n      if (result.error) {\n        toast({\n          variant: 'destructive',\n          title: 'Error de Exportación',\n          description: result.error,\n        });\n      } else {\n        toast({\n          title: 'Exportación Exitosa',\n          description: `Los datos se han guardado en scripts/resultados/base/${fileName}`,\n        });\n      }\n    });\n  };\n\n  return (\n    <Button onClick={handleExport} disabled={isPending} variant=\"outline\" size=\"sm\">\n      {isPending ? (\n        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n      ) : (\n        <Download className=\"mr-2 h-4 w-4\" />\n      )}\n      Exportar a JSON\n    </Button>\n  );\n}\n",
    "src/components/admin/config-download-button.tsx": "\"use client\";\n\nimport { useTransition } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Download, Loader2 } from \"lucide-react\";\nimport { exportConfigurationData } from \"@/lib/actions/admin.actions\";\n\ninterface ConfigDownloadButtonProps {\n  tableName: string;\n  data: any[];\n}\n\nexport function ConfigDownloadButton({ tableName, data }: ConfigDownloadButtonProps) {\n  const { toast } = useToast();\n  const [isPending, startTransition] = useTransition();\n\n  const handleExport = () => {\n    startTransition(async () => {\n      const result = await exportConfigurationData(data, tableName);\n      if (result.error) {\n        toast({\n          variant: \"destructive\",\n          title: \"Error de Exportación\",\n          description: result.error,\n        });\n      } else {\n        toast({\n          title: \"Exportación Exitosa\",\n          description: `Los datos se han guardado en la carpeta del servidor.`,\n        });\n      }\n    });\n  };\n\n  return (\n    <Button variant=\"outline\" size=\"sm\" onClick={handleExport} disabled={isPending}>\n      {isPending ? (\n        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n      ) : (\n        <Download className=\"mr-2 h-4 w-4\" />\n      )}\n      Exportar\n    </Button>\n  );\n}\n",
    "src/components/admin/export-all-schema-button.tsx": "'use client';\n\nimport { useState, useTransition } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from '@/hooks/use-toast';\nimport { Download, Loader2 } from 'lucide-react';\nimport { exportAllSchemaData } from '@/lib/actions/admin.actions';\n\ninterface ExportAllSchemaButtonProps {\n  data: {\n    tables: any[];\n    functions: any[];\n    triggers: any[];\n    policies: any[];\n  };\n}\n\nexport function ExportAllSchemaButton({ data }: ExportAllSchemaButtonProps) {\n  const { toast } = useToast();\n  const [isPending, startTransition] = useTransition();\n\n  const handleExport = () => {\n    startTransition(async () => {\n      const result = await exportAllSchemaData(data);\n      if (result.error) {\n        toast({\n          variant: 'destructive',\n          title: 'Error de Exportación',\n          description: result.error,\n        });\n      } else {\n        toast({\n          title: 'Exportación Exitosa',\n          description: `Todos los archivos de esquema se han guardado en el servidor.`,\n        });\n      }\n    });\n  };\n\n  return (\n    <Button onClick={handleExport} disabled={isPending}>\n      {isPending ? (\n        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n      ) : (\n        <Download className=\"mr-2 h-4 w-4\" />\n      )}\n      Exportar Todo\n    </Button>\n  );\n}\n",
    "src/components/admin/admin-login-form.tsx": "\n\n'use client';\n\nimport { useState, useTransition } from \"react\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"../ui/card\";\nimport { Label } from \"../ui/label\";\nimport { Input } from \"../ui/input\";\nimport { Button } from \"../ui/button\";\nimport { loginAdmin } from \"@/lib/auth-admin\";\nimport { Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport Image from \"next/image\";\n\nexport function AdminLoginForm() {\n    const [password, setPassword] = useState('');\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        startTransition(async () => {\n            const result = await loginAdmin(password);\n            if (!result.success) {\n                toast({\n                    variant: 'destructive',\n                    title: 'Error',\n                    description: result.error,\n                });\n            }\n        });\n    }\n\n    return (\n        <Card className=\"w-full max-w-sm\">\n            <CardHeader className=\"text-center\">\n                 <Image \n                    src=\"/logo.jpg\"\n                    alt=\"Vendetta Logo\"\n                    width={96} // w-24\n                    height={48}\n                    className=\"object-contain mx-auto mb-4\"\n                    data-ai-hint=\"game logo\"\n                />\n                <CardTitle>Acceso de Administrador</CardTitle>\n                <CardDescription>Introduce la contraseña para acceder al panel.</CardDescription>\n            </CardHeader>\n            <form onSubmit={handleSubmit}>\n                <CardContent>\n                    <div className=\"space-y-2\">\n                        <Label htmlFor=\"password\">Contraseña</Label>\n                        <Input \n                            id=\"password\" \n                            type=\"password\"\n                            value={password}\n                            onChange={(e) => setPassword(e.target.value)}\n                            disabled={isPending}\n                        />\n                    </div>\n                </CardContent>\n                <CardFooter>\n                    <Button type=\"submit\" className=\"w-full\" disabled={isPending}>\n                        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        Entrar\n                    </Button>\n                </CardFooter>\n            </form>\n        </Card>\n    );\n}\n",
    "src/components/admin/editable-table.tsx": "\n'use client';\n\nimport { useState } from \"react\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"../ui/table\";\nimport { Input } from \"../ui/input\";\nimport { ScrollArea } from \"../ui/scroll-area\";\n\ntype TableData = {\n    headers: string[];\n    rows: (string | number)[][];\n}\n\ninterface EditableTableProps {\n    initialData: TableData;\n}\n\nexport function EditableTable({ initialData }: EditableTableProps) {\n    const [data, setData] = useState(initialData);\n\n    const handleCellChange = (rowIndex: number, colIndex: number, value: string) => {\n        const newRows = [...data.rows];\n        newRows[rowIndex][colIndex] = value;\n        setData({ ...data, rows: newRows });\n    }\n\n    return (\n        <ScrollArea className=\"w-full whitespace-nowrap rounded-md border h-[60vh]\">\n            <Table className=\"min-w-full\">\n                <TableHeader>\n                    <TableRow className=\"bg-muted/50 hover:bg-muted/80\">\n                        {data.headers.map(header => (\n                            <TableHead key={header} className=\"sticky top-0 bg-muted/95 backdrop-blur-sm\">{header}</TableHead>\n                        ))}\n                    </TableRow>\n                </TableHeader>\n                <TableBody>\n                    {data.rows.map((row, rowIndex) => (\n                        <TableRow key={rowIndex}>\n                            {row.map((cell, colIndex) => (\n                                <TableCell key={colIndex} className=\"p-0\">\n                                    <Input \n                                        value={cell}\n                                        onChange={(e) => handleCellChange(rowIndex, colIndex, e.target.value)}\n                                        className=\"h-full w-full border-0 rounded-none focus-visible:ring-1 focus-visible:ring-primary focus-visible:bg-secondary\"\n                                    />\n                                </TableCell>\n                            ))}\n                        </TableRow>\n                    ))}\n                </TableBody>\n            </Table>\n        </ScrollArea>\n    );\n}\n",
    "src/components/admin/delete-config-button.tsx": "\n'use client';\nimport { useTransition } from \"react\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Button, ButtonProps } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Trash2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface DeleteConfigButtonProps extends ButtonProps {\n    id: string;\n    action: (id: string) => Promise<{ success?: boolean; error?: string }>;\n    label?: React.ReactNode;\n}\n\nexport function DeleteConfigButton({ id, action, className, variant = \"destructive\", size = \"sm\", label = \"Eliminar\", ...props }: DeleteConfigButtonProps) {\n    const [isPending, startTransition] = useTransition();\n    const { toast } = useToast();\n\n    const handleDelete = () => {\n        startTransition(async () => {\n            const result = await action(id);\n            if (result.error) {\n                toast({ variant: 'destructive', title: 'Error', description: result.error });\n            } else {\n                toast({ title: 'Éxito', description: 'Elemento eliminado correctamente.' });\n            }\n        });\n    }\n\n    return (\n        <AlertDialog>\n            <AlertDialogTrigger asChild>\n                <Button variant={variant} size={size} disabled={isPending} className={cn(className)} {...props}>\n                    {isPending ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : null}\n                    {label}\n                </Button>\n            </AlertDialogTrigger>\n            <AlertDialogContent>\n                <AlertDialogHeader>\n                    <AlertDialogTitle>¿Estás seguro?</AlertDialogTitle>\n                    <AlertDialogDescription>\n                        Esta acción no se puede deshacer. Esto eliminará permanentemente la configuración de la base de datos.\n                    </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                    <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                    <AlertDialogAction onClick={handleDelete} disabled={isPending} className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\">\n                         {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                        Confirmar Eliminación\n                    </AlertDialogAction>\n                </AlertDialogFooter>\n            </AlertDialogContent>\n        </AlertDialog>\n    );\n}\n",
    "src/components/admin/training-config-table.tsx": "'use client';\n\nimport type { FullConfiguracionEntrenamiento } from \"@/types\";\nimport {\n    Table,\n    TableBody,\n    TableCell,\n    TableHead,\n    TableHeader,\n    TableRow,\n} from '@/components/ui/table';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { deleteTrainingConfig } from '@/lib/actions/admin.actions';\nimport { DeleteConfigButton } from './delete-config-button';\nimport { PlusCircle } from 'lucide-react';\nimport { ScrollArea } from '../ui/scroll-area';\nimport Link from 'next/link';\nimport { useRouter } from 'next/navigation';\nimport { ExportButton } from './export-button';\ninterface TrainingConfigTableProps {\n    initialData: FullConfiguracionEntrenamiento[];\n}\nfunction formatRequirements(\n  requisitos: FullConfiguracionEntrenamiento['requisitos'],\n  allTrainings: FullConfiguracionEntrenamiento[]\n) {\n    if (!requisitos || requisitos.length === 0) return '-';\n    const allTrainingsMap = new Map(allTrainings.map((t) => [t.id, t.nombre]));\n    return requisitos\n        .map(\n            (req) =>\n            `${allTrainingsMap.get(req.requiredTrainingId) || req.requiredTrainingId\n            } (Nvl ${req.requiredLevel})`\n        )\n        .join(', ');\n}\nexport function TrainingConfigTable({ initialData }: TrainingConfigTableProps) {\n    const router = useRouter();\n    return (\n        <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n                <div>\n                    <CardTitle>Configuración de Entrenamientos</CardTitle>\n                    <CardDescription>Visualiza, edita y crea nuevos entrenamientos.</CardDescription>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    <ExportButton data={initialData} filename=\"config_entrenamientos\" tableName=\"ConfiguracionEntrenamiento\" />\n                    <Button asChild size=\"sm\">\n                        <Link href=\"/admin/panel/trainings/new\">\n                            <PlusCircle className=\"mr-2 h-4 w-4\" />\n                            Crear Nuevo Entrenamiento\n                        </Link>\n                    </Button>\n                </div>\n            </CardHeader>\n            <CardContent>\n                <ScrollArea className=\"h-[70vh] w-full rounded-md border\">\n                    <Table>\n                        <TableHeader>\n                            <TableRow>\n                                <TableHead className=\"sticky top-0 bg-muted z-10\">ID</TableHead>\n                                <TableHead className=\"sticky top-0 bg-muted z-10\">Nombre</TableHead>\n                                <TableHead className=\"sticky top-0 bg-muted z-10 hidden sm:table-cell\">Requisitos</TableHead>\n                                <TableHead className=\"sticky top-0 bg-muted z-10 text-right\">Puntos</TableHead>\n                                <TableHead className=\"sticky top-0 bg-muted z-10 text-right\">Acciones</TableHead>\n                            </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                            {initialData.map((training) => (\n                                <TableRow key={training.id} className=\"even:bg-muted/50\">\n                                    <TableCell className=\"font-mono text-xs\">{training.id}</TableCell>\n                                    <TableCell className=\"font-medium\">{training.nombre}</TableCell>\n                                    <TableCell className=\"text-xs hidden sm:table-cell\">\n                                        {formatRequirements(training.requisitos, initialData)}\n                                    </TableCell>\n                                    <TableCell className=\"text-right\">{training.puntos}</TableCell>\n                                    <TableCell className=\"text-right space-x-2\">\n                                         <Button asChild variant=\"outline\" size=\"sm\">\n                                            <Link href={`/admin/panel/trainings/${training.id}`}>Editar</Link>\n                                        </Button>\n                                        <DeleteConfigButton id={training.id} action={deleteTrainingConfig} />\n                                    </TableCell>\n                                </TableRow>\n                            ))}\n                        </TableBody>\n                    </Table>\n                </ScrollArea>\n            </CardContent>\n        </Card>\n    );\n}",
    "src/components/store-hydrator.tsx": "'use client';\n\nimport { useEffect } from 'react';\nimport { useHydrateAtoms } from 'jotai/utils';\nimport { useSetAtom } from 'jotai';\nimport {\n    userProfileAtom,\n    propertiesAtom,\n    activeMissionsAtom,\n    activePropertyIdAtom\n} from '@/store/atoms';\nimport { UserWithProgress, FullPropiedad } from '@/types';\nimport { useSearchParams } from 'next/navigation';\n\ninterface StoreHydratorProps {\n    user: UserWithProgress;\n    initialProperties: FullPropiedad[];\n}\n\nexport function StoreHydrator({ user, initialProperties }: StoreHydratorProps) {\n    const searchParams = useSearchParams();\n    const urlPropertyId = searchParams.get('propertyId');\n\n    // Determine initial active property ID\n    const initialActiveId = urlPropertyId\n        ? (initialProperties.find(p => p.id === urlPropertyId)?.id || initialProperties[0]?.id || null)\n        : (initialProperties[0]?.id || null);\n\n    // 1. Initial Hydration (SSR/First Load)\n    useHydrateAtoms([\n        [userProfileAtom, user],\n        [propertiesAtom, initialProperties],\n        [activeMissionsAtom, user.misiones],\n        [activePropertyIdAtom, initialActiveId]\n    ]);\n\n    // 2. Sync with Server Updates (Revalidation)\n    const setUserProfile = useSetAtom(userProfileAtom);\n    const setProperties = useSetAtom(propertiesAtom);\n    const setActiveMissions = useSetAtom(activeMissionsAtom);\n\n    useEffect(() => {\n        setUserProfile(user);\n        setProperties(initialProperties);\n        setActiveMissions(user.misiones);\n    }, [user, initialProperties, setUserProfile, setProperties, setActiveMissions]);\n\n    // 3. Sync Active Property with URL\n    const setActivePropertyId = useSetAtom(activePropertyIdAtom);\n\n    useEffect(() => {\n        if (urlPropertyId) {\n            // Validate if the ID exists in properties? Maybe not strictly necessary if we trust URL\n            setActivePropertyId(urlPropertyId);\n        } else if (initialProperties.length > 0) {\n            // Default to first if no URL param\n            setActivePropertyId(initialProperties[0].id);\n        }\n    }, [urlPropertyId, initialProperties, setActivePropertyId]);\n\n    return null;\n}\n",
    "src/components/user-selection.tsx": "// This component is no longer used and can be deleted.\n\"use client\";\n\nimport { useRouter } from 'next/navigation';\nimport type { User } from '@/types';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\nimport Image from 'next/image';\n\ninterface UserSelectionProps {\n  users: User[];\n}\n\nexport function UserSelection({ users }: UserSelectionProps) {\n  const router = useRouter();\n\n  const handleUserSelect = (userId: string) => {\n    // For now, we'll just redirect. In a real app, you'd handle session/auth.\n    console.log(`User ${userId} selected`);\n    // You can use localStorage to persist the user selection\n    localStorage.setItem('selectedUserId', userId);\n    router.push('/overview');\n  };\n\n  return (\n    <Card className=\"w-full max-w-md\">\n      <CardHeader className=\"text-center\">\n        <CardTitle className=\"text-2xl\">¿Quién eres?</CardTitle>\n        <CardDescription>Selecciona tu perfil para continuar</CardDescription>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {users.map((user) => (\n            <div\n              key={user.id}\n              onClick={() => handleUserSelect(user.id)}\n              className=\"flex cursor-pointer items-center space-x-4 rounded-lg border p-4 transition-all hover:bg-muted/50\"\n            >\n              <Avatar className=\"h-16 w-16\">\n                <AvatarImage src={user.avatarUrl || 'https://placehold.co/100x100.png'} alt={user.name} data-ai-hint=\"mafia character\" />\n                <AvatarFallback>{user.name.charAt(0).toUpperCase()}</AvatarFallback>\n              </Avatar>\n              <div>\n                <p className=\"font-semibold\">{user.name}</p>\n                <p className=\"text-sm text-muted-foreground\">{user.title}</p>\n              </div>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n",
    "src/components/auth-form.tsx": "\n'use client';\n\nimport { useState, useTransition } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Label } from '@/components/ui/label';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';\nimport { Loader2, Terminal } from 'lucide-react';\nimport { login, registerUser } from '@/lib/actions/auth.actions';\n\nexport function AuthForm() {\n    const router = useRouter();\n    const { toast } = useToast();\n    const [isLoginView, setIsLoginView] = useState(true);\n    const [isPending, startTransition] = useTransition();\n\n    // Common state\n    const [username, setUsername] = useState('');\n    const [password, setPassword] = useState('');\n    const [email, setEmail] = useState('');\n    const [error, setError] = useState('');\n\n    // Registration state\n    const [confirmPassword, setConfirmPassword] = useState('');\n\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        setError('');\n\n        if (isLoginView) {\n             startTransition(async () => {\n                const result = await login({ email, password });\n                if (result.error) {\n                    setError(result.error);\n                } else {\n                    toast({ title: \"Inicio de sesión exitoso\", description: \"Bienvenido de nuevo, Jefe.\" });\n                    router.push('/overview');\n                    router.refresh();\n                }\n            });\n        } else {\n            // Registration logic\n            if (password !== confirmPassword) {\n                setError('Las contraseñas no coinciden.');\n                return;\n            }\n             if (password.length < 6) {\n                setError('La contraseña debe tener al menos 6 caracteres.');\n                return;\n            }\n\n            startTransition(async () => {\n                const result = await registerUser({\n                    email,\n                    username,\n                    password,\n                    locationMode: 'random',\n                });\n\n                if (result.error) {\n                    setError(result.error);\n                } else {\n                    toast({ title: \"¡Registro exitoso!\", description: `Bienvenido a Vendetta, ${username}. Por favor, revisa tu correo para confirmar tu cuenta.` });\n                    router.push('/overview');\n                    router.refresh();\n                }\n            });\n        }\n    };\n\n    const renderLogin = () => (\n        <form onSubmit={handleSubmit}>\n            <CardHeader className=\"text-center\">\n                <CardTitle className=\"text-4xl font-heading tracking-widest text-white/90\">INICIAR SESIÓN</CardTitle>\n                <CardDescription className=\"text-white/70\">Introduce tus credenciales para acceder a tu imperio.</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '100ms' }}>\n                    <Label htmlFor=\"username-login\">Usuario</Label>\n                    <Input id=\"username-login\" name=\"username\" type=\"text\" placeholder=\"Tu nombre de guerra\" value={username} onChange={(e) => setUsername(e.target.value)} required disabled={isPending} />\n                </div>\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '200ms' }}>\n                    <Label htmlFor=\"password-login\">Contraseña</Label>\n                    <Input id=\"password-login\" name=\"password\" type=\"password\" placeholder=\"Tu código secreto\" value={password} onChange={(e) => setPassword(e.target.value)} required disabled={isPending} />\n                </div>\n                 {error && (\n                    <Alert variant=\"destructive\" className=\"bg-destructive/20 border-destructive/50 text-destructive-foreground\">\n                        <Terminal className=\"h-4 w-4\" />\n                        <AlertTitle>Error</AlertTitle>\n                        <AlertDescription>{error}</AlertDescription>\n                    </Alert>\n                )}\n            </CardContent>\n            <CardFooter className=\"flex-col gap-4\">\n                <Button type=\"submit\" variant=\"destructive\" className=\"w-full transition-all hover:scale-105\" disabled={isPending}>\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Entrar\n                </Button>\n            </CardFooter>\n        </form>\n    );\n\n    const renderRegister = () => (\n         <form onSubmit={handleSubmit}>\n            <CardHeader className=\"text-center\">\n                <CardTitle className=\"text-4xl font-heading tracking-widest text-white/90\">CREAR CUENTA</CardTitle>\n                <CardDescription className=\"text-white/70\">Únete a la familia.</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '100ms' }}>\n                    <Label htmlFor=\"username-register\">Usuario</Label>\n                    <Input id=\"username-register\" name=\"username\" type=\"text\" placeholder=\"Tu nombre de guerra\" value={username} onChange={(e) => setUsername(e.target.value)} required />\n                </div>\n                 <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '200ms' }}>\n                    <Label htmlFor=\"email-register\">Correo Electrónico</Label>\n                    <Input id=\"email-register\" name=\"email\" type=\"email\" placeholder=\"tu@correo.com\" value={email} onChange={(e) => setEmail(e.target.value)} required />\n                </div>\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '300ms' }}>\n                    <Label htmlFor=\"password-register\">Contraseña</Label>\n                    <Input id=\"password-register\" name=\"password\" type=\"password\" placeholder=\"Tu código secreto (mín. 6 caracteres)\" value={password} onChange={(e) => setPassword(e.target.value)} required />\n                </div>\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '400ms' }}>\n                    <Label htmlFor=\"confirm-password\">Confirmar Contraseña</Label>\n                    <Input id=\"confirm-password\" type=\"password\" placeholder=\"Repite tu código secreto\" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} required />\n                </div>\n                {error && (\n                    <Alert variant=\"destructive\" className=\"bg-destructive/20 border-destructive/50 text-destructive-foreground\">\n                        <Terminal className=\"h-4 w-4\" />\n                        <AlertTitle>Error</AlertTitle>\n                        <AlertDescription>{error}</AlertDescription>\n                    </Alert>\n                )}\n            </CardContent>\n            <CardFooter>\n                <Button type=\"submit\" variant=\"destructive\" className=\"w-full transition-all hover:scale-105\" disabled={isPending}>\n                    {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Confirmar y Entrar al Juego\n                </Button>\n            </CardFooter>\n        </form>\n    );\n\n    return (\n        <Card className=\"w-full max-w-md bg-background/90 text-white border-white/10 backdrop-blur-md animate-fade-in shadow-lg shadow-primary/20\">\n           {isLoginView ? renderLogin() : renderRegister()}\n            <CardFooter className=\"flex-col gap-4 border-t pt-4\">\n                 <p className=\"text-xs text-center text-white/60\">\n                    {isLoginView ? '¿No tienes una cuenta?' : '¿Ya eres parte de la familia?'}\n                    <Button variant=\"link\" type=\"button\" size=\"sm\" className=\"p-0 h-auto ml-1 text-accent\" onClick={() => { setIsLoginView(!isLoginView); setError(''); }}>\n                         {isLoginView ? 'Regístrate aquí.' : 'Inicia sesión.'}\n                    </Button>\n                </p>\n            </CardFooter>\n        </Card>\n    );\n}\n",
    "src/components/theme-provider.tsx": "\"use client\"\n\nimport * as React from \"react\"\nimport { ThemeProvider as NextThemesProvider, type ThemeProviderProps } from \"next-themes\"\n\nexport function ThemeProvider({ children, ...props }: ThemeProviderProps) {\n  return <NextThemesProvider {...props}>{children}</NextThemesProvider>\n}\n",
    "src/app/auth/confirm/route.ts": "import { type EmailOtpType } from '@supabase/supabase-js'\nimport { type NextRequest, NextResponse } from 'next/server'\n\nimport { createClient } from '@/utils/supabase/server'\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url)\n  const token_hash = searchParams.get('token_hash')\n  const type = searchParams.get('type') as EmailOtpType | null\n  const code = searchParams.get('code')\n  const next = searchParams.get('next') ?? '/overview'\n\n  const redirectTo = request.nextUrl.clone()\n  redirectTo.pathname = next\n  redirectTo.searchParams.delete('token_hash')\n  redirectTo.searchParams.delete('type')\n  redirectTo.searchParams.delete('code')\n  redirectTo.searchParams.delete('next')\n\n  const supabase = await createClient()\n\n  if (code) {\n    const { error } = await supabase.auth.exchangeCodeForSession(code)\n    if (!error) {\n      return NextResponse.redirect(redirectTo)\n    }\n  }\n\n  if (token_hash && type) {\n    const { error } = await supabase.auth.verifyOtp({\n      type,\n      token_hash,\n    })\n    if (!error) {\n      return NextResponse.redirect(redirectTo)\n    }\n  }\n\n  // return the user to an error page with some instructions\n  redirectTo.pathname = '/verify'\n  redirectTo.searchParams.set('error', 'auth_failed')\n  return NextResponse.redirect(redirectTo)\n}\n",
    "src/app/layout.tsx": "import type {Metadata, Viewport} from 'next';\nimport './globals.css';\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { Inter, Bebas_Neue as BebasNeue } from 'next/font/google';\n\nconst inter = Inter({\n  subsets: ['latin'],\n  variable: '--font-inter',\n});\n\nconst bebas_neue = BebasNeue({\n  subsets: ['latin'],\n  weight: '400',\n  variable: '--font-bebas-neue',\n});\n\nconst APP_NAME = \"Vendetta\";\nconst APP_DEFAULT_TITLE = \"Vendetta tu familia Vendettera\";\nconst APP_TITLE_TEMPLATE = \"%s | Vendetta\";\nconst APP_DESCRIPTION = \"Gestiona tu imperio mafioso, construye edificios, recluta tropas y domina la ciudad en Vendetta, un juego de estrategia en tiempo real.\";\nconst APP_URL = \"https://vendettadashboardredis.vercel.app\";\n\nexport const metadata: Metadata = {\n  applicationName: APP_NAME,\n  title: {\n    default: APP_DEFAULT_TITLE,\n    template: APP_TITLE_TEMPLATE,\n  },\n  description: APP_DESCRIPTION,\n  appleWebApp: {\n    capable: true,\n    statusBarStyle: \"default\",\n    title: APP_DEFAULT_TITLE,\n  },\n  formatDetection: {\n    telephone: false,\n  },\n  openGraph: {\n    type: \"website\",\n    siteName: APP_NAME,\n    title: {\n      default: APP_DEFAULT_TITLE,\n      template: APP_TITLE_TEMPLATE,\n    },\n    description: APP_DESCRIPTION,\n    url: new URL(APP_URL),\n    locale: \"es_ES\",\n    images: [\n        {\n          url: `${APP_URL}/icons/og-image.png`,\n          width: 1200,\n          height: 630,\n          alt: \"Banner de Vendetta, un juego de estrategia de mafia.\",\n          type: \"image/png\",\n        },\n    ],\n  },\n  twitter: {\n    card: \"summary_large_image\",\n    title: {\n      default: APP_DEFAULT_TITLE,\n      template: APP_TITLE_TEMPLATE,\n    },\n    description: APP_DESCRIPTION,\n    images: [\n        {\n          url: `${APP_URL}/icons/og-image.png`,\n          alt: \"Banner de Vendetta, un juego de estrategia de mafia.\",\n        },\n      ],\n  },\n  keywords: [\"vendetta\", \"mafia\", \"estrategia\", \"juego online\", \"gestión de recursos\", \"juego de navegador\"],\n  authors: [{ name: \"Vendetta Team\" }],\n  creator: \"Vendetta Team\",\n  publisher: \"Vendetta Team\",\n  robots: \"index, follow\",\n};\n\nexport const viewport: Viewport = {\n  themeColor: \"#121212\",\n  colorScheme: \"dark\",\n  width: \"device-width\",\n  initialScale: 1,\n  maximumScale: 1,\n  userScalable: false,\n};\n\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <html lang=\"es\" suppressHydrationWarning>\n      <body className={`${inter.variable} ${bebas_neue.variable} font-sans antialiased bg-background`}>\n        <ThemeProvider\n          attribute=\"class\"\n          defaultTheme=\"system\"\n          enableSystem\n          disableTransitionOnChange\n        >\n          {children}\n          <Toaster />\n        </ThemeProvider>\n      </body>\n    </html>\n  );\n}\n",
    "src/app/loading.tsx": "\nimport { Loader2 } from \"lucide-react\";\n\nexport default function Loading() {\n  return (\n    <div className=\"flex h-screen w-full items-center justify-center bg-background text-foreground\">\n      <div className=\"flex flex-col items-center gap-4\">\n        <Loader2 className=\"h-12 w-12 animate-spin text-primary\" />\n        <p className=\"text-lg font-medium text-muted-foreground\">Cargando Vendetta...</p>\n      </div>\n    </div>\n  );\n}\n",
    "src/app/page.tsx": "\nimport { redirect } from \"next/navigation\";\nimport { getSessionUser } from \"@/lib/auth\";\n\nexport default async function GatePage() {\n    const user = await getSessionUser();\n    \n    if (user) {\n        redirect('/overview');\n    }\n\n    redirect('/login');\n}\n",
    "src/app/verify/page.tsx": "import Link from \"next/link\";\nimport { Card, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\n\nexport default function VerifyPage() {\n  return (\n    <main className=\"relative flex min-h-screen w-full flex-col items-center justify-center p-4\">\n       <div className=\"z-10 flex flex-col items-center justify-center space-y-8 animate-fade-in\">\n           <h1 className=\"text-5xl font-heading tracking-widest text-white/90 drop-shadow-lg\">\n               Vendetta <span className=\"text-destructive\">Plus</span>\n           </h1>\n\n           <Card className=\"w-full max-w-md bg-background/90 text-white border-white/10 backdrop-blur-md shadow-lg shadow-primary/20\">\n                <CardHeader className=\"text-center space-y-4\">\n                    <CardTitle className=\"text-3xl font-heading tracking-widest text-white/90\">¡Revisa tu correo!</CardTitle>\n                    <CardDescription className=\"text-white/70 text-lg\">\n                        Registro completado. Por favor, revisa tu correo para confirmar la cuenta.\n                    </CardDescription>\n                </CardHeader>\n                <CardFooter className=\"flex justify-center pt-4\">\n                    <Link href=\"/login\" className=\"w-full\">\n                        <Button className=\"w-full transition-all hover:scale-105\" variant=\"default\">\n                            Volver a Inicio de Sesión\n                        </Button>\n                    </Link>\n                </CardFooter>\n           </Card>\n       </div>\n    </main>\n  );\n}\n",
    "src/app/admin/layout.tsx": "\nimport { SidebarProvider, SidebarInset } from \"@/components/ui/sidebar\"\nimport { AdminSidebar } from \"@/components/admin/admin-sidebar\"\nimport { AdminHeader } from \"@/components/admin/admin-header\"\nimport { logoutAdmin } from \"@/lib/auth-admin\"\nimport { Button } from \"@/components/ui/button\"\n\nasync function LogoutButton() {\n    'use server';\n    return (\n        <form action={async () => {\n            'use server';\n            await logoutAdmin();\n        }}>\n            <Button type=\"submit\" variant=\"ghost\" size=\"sm\">Cerrar Sesión</Button>\n        </form>\n    )\n}\n\nexport default function AdminLayout({\n    children,\n  }: {\n    children: React.ReactNode\n  }) {\n    return (\n        <SidebarProvider>\n            <AdminSidebar />\n            <SidebarInset>\n                <AdminHeader>\n                    <LogoutButton />\n                </AdminHeader>\n                <div className=\"flex flex-1 flex-col gap-4 p-4 pt-0\">\n                    <div className=\"mx-auto w-full max-w-7xl py-6\">\n                        {children}\n                    </div>\n                </div>\n            </SidebarInset>\n        </SidebarProvider>\n    )\n  }\n",
    "src/app/admin/page.tsx": "\n\nimport { AdminLoginForm } from \"@/components/admin/admin-login-form\";\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { redirect } from \"next/navigation\";\n\nexport default async function AdminPage() {\n    const isAdmin = await getAdminSession();\n\n    if (isAdmin) {\n        redirect('/admin/panel');\n    }\n\n    return (\n        <div className=\"flex flex-col items-center justify-center min-h-[80vh]\">\n            <AdminLoginForm />\n        </div>\n    );\n}\n",
    "src/app/admin/database/page.tsx": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { fetchDatabaseSchema } from '@/lib/actions/admin-db.actions';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Search } from 'lucide-react';\n\nexport default function DatabaseInspectorPage() {\n    const [data, setData] = useState<any>(null);\n    const [loading, setLoading] = useState(true);\n    const [error, setError] = useState<string | null>(null);\n    const [searchTerm, setSearchTerm] = useState('');\n\n    useEffect(() => {\n        const loadData = async () => {\n            try {\n                const result = await fetchDatabaseSchema();\n                if (result.error) {\n                    setError(result.error);\n                } else {\n                    setData(result.data);\n                }\n            } catch (err) {\n                setError(\"Error al cargar datos.\");\n            } finally {\n                setLoading(false);\n            }\n        };\n        loadData();\n    }, []);\n\n    const filterData = (items: any[], key: string) => {\n        if (!searchTerm) return items;\n        return items?.filter((item: any) =>\n            item[key]?.toLowerCase().includes(searchTerm.toLowerCase())\n        ) || [];\n    };\n\n    if (loading) return <div className=\"p-8 text-center\">Cargando esquema de base de datos...</div>;\n    if (error) return <div className=\"p-8 text-red-500\">Error: {error}</div>;\n    if (!data) return <div className=\"p-8\">No se encontraron datos.</div>;\n\n    return (\n        <div className=\"container mx-auto py-6 space-y-6\">\n            <div className=\"flex justify-between items-center\">\n                <h1 className=\"text-3xl font-bold\">Inspector de Base de Datos</h1>\n                <div className=\"relative w-72\">\n                    <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                        placeholder=\"Buscar...\"\n                        value={searchTerm}\n                        onChange={(e) => setSearchTerm(e.target.value)}\n                        className=\"pl-8\"\n                    />\n                </div>\n            </div>\n\n            <Tabs defaultValue=\"tables\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-5\">\n                    <TabsTrigger value=\"tables\">Tablas ({data.tables?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"functions\">Funciones ({data.functions?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"triggers\">Triggers ({data.triggers?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"policies\">Policies ({data.policies?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"enums\">Enums ({data.enums?.length || 0})</TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"tables\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Tablas Públicas</CardTitle>\n                            <CardDescription>Estructura de tablas y columnas.</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <Accordion type=\"single\" collapsible className=\"w-full\">\n                                {filterData(data.tables, 'table_name').map((table: any, idx: number) => (\n                                    <AccordionItem key={idx} value={`table-${idx}`}>\n                                        <AccordionTrigger className=\"font-mono text-sm\">{table.table_name}</AccordionTrigger>\n                                        <AccordionContent>\n                                            <div className=\"rounded-md border p-4 bg-muted/50\">\n                                                <table className=\"w-full text-sm text-left\">\n                                                    <thead>\n                                                        <tr className=\"border-b\">\n                                                            <th className=\"py-2\">Columna</th>\n                                                            <th className=\"py-2\">Tipo</th>\n                                                            <th className=\"py-2\">Nullable</th>\n                                                            <th className=\"py-2\">Default</th>\n                                                        </tr>\n                                                    </thead>\n                                                    <tbody>\n                                                        {table.columns.map((col: any, cIdx: number) => (\n                                                            <tr key={cIdx} className=\"border-b last:border-0\">\n                                                                <td className=\"py-2 font-mono\">{col.column_name}</td>\n                                                                <td className=\"py-2 text-blue-600 dark:text-blue-400\">{col.data_type}</td>\n                                                                <td className=\"py-2\">{col.is_nullable}</td>\n                                                                <td className=\"py-2 text-muted-foreground break-all\">{col.column_default || '-'}</td>\n                                                            </tr>\n                                                        ))}\n                                                    </tbody>\n                                                </table>\n                                            </div>\n                                        </AccordionContent>\n                                    </AccordionItem>\n                                ))}\n                            </Accordion>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                <TabsContent value=\"functions\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Funciones RPC</CardTitle>\n                            <CardDescription>Procedimientos almacenados y funciones del esquema público.</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <ScrollArea className=\"h-[600px] w-full pr-4\">\n                                <Accordion type=\"single\" collapsible className=\"w-full\">\n                                    {filterData(data.functions, 'function_name').map((func: any, idx: number) => (\n                                        <AccordionItem key={idx} value={`func-${idx}`}>\n                                            <AccordionTrigger className=\"font-mono text-sm hover:no-underline\">\n                                                <div className=\"flex items-center gap-2\">\n                                                    <span className=\"font-bold text-purple-600 dark:text-purple-400\">{func.function_name}</span>\n                                                    <Badge variant=\"outline\" className=\"text-xs\">{func.language}</Badge>\n                                                </div>\n                                            </AccordionTrigger>\n                                            <AccordionContent>\n                                                <div className=\"space-y-4\">\n                                                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                                                        <div>\n                                                            <span className=\"font-semibold text-muted-foreground\">Argumentos:</span>\n                                                            <p className=\"font-mono mt-1\">{func.arguments || 'None'}</p>\n                                                        </div>\n                                                        <div>\n                                                            <span className=\"font-semibold text-muted-foreground\">Retorno:</span>\n                                                            <p className=\"font-mono mt-1\">{func.return_type}</p>\n                                                        </div>\n                                                    </div>\n                                                    <div className=\"relative\">\n                                                        <pre className=\"p-4 rounded-md bg-slate-950 text-slate-50 overflow-x-auto text-xs font-mono\">\n                                                            <code>{func.source_code}</code>\n                                                        </pre>\n                                                    </div>\n                                                </div>\n                                            </AccordionContent>\n                                        </AccordionItem>\n                                    ))}\n                                </Accordion>\n                            </ScrollArea>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                <TabsContent value=\"triggers\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Triggers</CardTitle>\n                            <CardDescription>Disparadores de eventos en base de datos.</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <Accordion type=\"single\" collapsible className=\"w-full\">\n                                {filterData(data.triggers, 'trigger_name').map((trigger: any, idx: number) => (\n                                    <AccordionItem key={idx} value={`trigger-${idx}`}>\n                                        <AccordionTrigger className=\"font-mono text-sm\">\n                                            {trigger.trigger_name} <span className=\"text-muted-foreground ml-2\">({trigger.table_name})</span>\n                                        </AccordionTrigger>\n                                        <AccordionContent>\n                                            <div className=\"space-y-2\">\n                                                <p className=\"text-sm\"><span className=\"font-semibold\">Función:</span> {trigger.function_name}</p>\n                                                <pre className=\"p-4 rounded-md bg-slate-950 text-slate-50 overflow-x-auto text-xs font-mono\">\n                                                    <code>{trigger.definition}</code>\n                                                </pre>\n                                            </div>\n                                        </AccordionContent>\n                                    </AccordionItem>\n                                ))}\n                            </Accordion>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                <TabsContent value=\"policies\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>RLS Policies</CardTitle>\n                            <CardDescription>Políticas de seguridad a nivel de fila.</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <Accordion type=\"single\" collapsible className=\"w-full\">\n                                {filterData(data.policies, 'policy_name').map((policy: any, idx: number) => (\n                                    <AccordionItem key={idx} value={`policy-${idx}`}>\n                                        <AccordionTrigger className=\"font-mono text-sm text-left\">\n                                            <div className=\"flex flex-col items-start gap-1\">\n                                                <span>{policy.policy_name}</span>\n                                                <div className=\"flex gap-2\">\n                                                    <Badge variant=\"secondary\" className=\"text-[10px]\">{policy.table_name}</Badge>\n                                                    <Badge className={\n                                                        policy.command === 'SELECT' ? 'bg-blue-500' :\n                                                        policy.command === 'INSERT' ? 'bg-green-500' :\n                                                        policy.command === 'UPDATE' ? 'bg-yellow-500' :\n                                                        'bg-red-500'\n                                                    }>{policy.command}</Badge>\n                                                </div>\n                                            </div>\n                                        </AccordionTrigger>\n                                        <AccordionContent>\n                                            <div className=\"space-y-4 text-sm\">\n                                                <div className=\"grid grid-cols-2 gap-4\">\n                                                    <div>\n                                                        <span className=\"font-semibold block mb-1\">Roles:</span>\n                                                        <span className=\"font-mono text-muted-foreground\">\n                                                            {policy.roles ? `{${policy.roles.join(', ')}}` : 'PUBLIC'}\n                                                        </span>\n                                                    </div>\n                                                </div>\n                                                {policy.using_expression && (\n                                                    <div>\n                                                        <span className=\"font-semibold block mb-1\">USING (Rows visible):</span>\n                                                        <pre className=\"p-2 rounded bg-muted font-mono text-xs whitespace-pre-wrap\">\n                                                            {policy.using_expression}\n                                                        </pre>\n                                                    </div>\n                                                )}\n                                                {policy.check_expression && (\n                                                    <div>\n                                                        <span className=\"font-semibold block mb-1\">WITH CHECK (Rows insertable/updatable):</span>\n                                                        <pre className=\"p-2 rounded bg-muted font-mono text-xs whitespace-pre-wrap\">\n                                                            {policy.check_expression}\n                                                        </pre>\n                                                    </div>\n                                                )}\n                                            </div>\n                                        </AccordionContent>\n                                    </AccordionItem>\n                                ))}\n                            </Accordion>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                 <TabsContent value=\"enums\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Enums</CardTitle>\n                            <CardDescription>Tipos enumerados personalizados.</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                                {filterData(data.enums, 'type_name').map((e: any, idx: number) => (\n                                    <Card key={idx}>\n                                        <CardHeader className=\"pb-2\">\n                                            <CardTitle className=\"text-base font-mono\">{e.type_name}</CardTitle>\n                                        </CardHeader>\n                                        <CardContent>\n                                            <div className=\"flex flex-wrap gap-2\">\n                                                {e.values.map((val: string, vIdx: number) => (\n                                                    <Badge key={vIdx} variant=\"outline\">{val}</Badge>\n                                                ))}\n                                            </div>\n                                        </CardContent>\n                                    </Card>\n                                ))}\n                            </div>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n            </Tabs>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/verification/page.tsx": "\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { MissionsVerifier } from \"@/components/admin/verification/missions-verifier\";\nimport { TroopsVerifier } from \"@/components/admin/verification/troops-verifier\";\nimport { TrainingsVerifier } from \"@/components/admin/verification/trainings-verifier\";\nimport { RoomsVerifier } from \"@/components/admin/verification/rooms-verifier\";\n\nexport default function VerificationDashboard() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex flex-col gap-2\">\n                <h1 className=\"text-3xl font-bold tracking-tight\">Centro de Verificación</h1>\n                <p className=\"text-muted-foreground\">Diagnóstico en vivo de la lógica de negocio del servidor.</p>\n            </div>\n\n            <Tabs defaultValue=\"missions\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-4 lg:w-[600px]\">\n                    <TabsTrigger value=\"missions\">Misiones</TabsTrigger>\n                    <TabsTrigger value=\"troops\">Tropas</TabsTrigger>\n                    <TabsTrigger value=\"trainings\">Entrenos</TabsTrigger>\n                    <TabsTrigger value=\"rooms\">Salas</TabsTrigger>\n                </TabsList>\n                \n                <TabsContent value=\"missions\" className=\"mt-4\">\n                    <MissionsVerifier />\n                </TabsContent>\n                <TabsContent value=\"troops\" className=\"mt-4\">\n                    <TroopsVerifier />\n                </TabsContent>\n                <TabsContent value=\"trainings\" className=\"mt-4\">\n                    <TrainingsVerifier />\n                </TabsContent>\n                <TabsContent value=\"rooms\" className=\"mt-4\">\n                    <RoomsVerifier />\n                </TabsContent>\n            </Tabs>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/page.tsx": "\nimport { getAdminSession, logoutAdmin } from \"@/lib/auth-admin\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport Link from \"next/link\";\nimport { Building, Brain, Users, Hotel, ShieldCheck } from \"lucide-react\";\nimport { redirect } from \"next/navigation\";\n\nasync function LogoutButton() {\n    'use server';\n    return (\n        <form action={async () => {\n            'use server';\n            await logoutAdmin();\n        }}>\n            <Button type=\"submit\" variant=\"outline\">Cerrar Sesión</Button>\n        </form>\n    )\n}\n\nexport default async function AdminPanelPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex flex-wrap gap-4 justify-between items-center\">\n                <div>\n                    <h1 className=\"text-3xl font-bold tracking-tight\">Panel de Administración de Vendetta</h1>\n                    <p className=\"text-muted-foreground\">\n                        Gestión central de la configuración del juego.\n                    </p>\n                </div>\n                <LogoutButton />\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                <Link href=\"/admin/panel/rooms\" className=\"group\">\n                    <Card className=\"hover:border-primary hover:shadow-primary/20 transition-all\">\n                        <CardHeader>\n                            <Building className=\"h-10 w-10 text-primary mb-2\" />\n                            <CardTitle>Habitaciones</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                            <p className=\"text-muted-foreground\">\n                                Gestionar las configuraciones, costos y requisitos de todos los edificios y habitaciones.\n                            </p>\n                        </CardContent>\n                    </Card>\n                </Link>\n                <Link href=\"/admin/panel/trainings\" className=\"group\">\n                     <Card className=\"hover:border-primary hover:shadow-primary/20 transition-all\">\n                        <CardHeader>\n                            <Brain className=\"h-10 w-10 text-primary mb-2\" />\n                            <CardTitle>Entrenamientos</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                            <p className=\"text-muted-foreground\">\n                                Editar los entrenamientos, sus costos, tiempos y requisitos de nivel para el desarrollo del jugador.\n                            </p>\n                        </CardContent>\n                    </Card>\n                </Link>\n                <Link href=\"/admin/panel/troops\" className=\"group\">\n                    <Card className=\"hover:border-primary hover:shadow-primary/20 transition-all\">\n                        <CardHeader>\n                            <Users className=\"h-10 w-10 text-primary mb-2\" />\n                            <CardTitle>Tropas</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                            <p className=\"text-muted-foreground\">\n                                Ajustar estadísticas, costos, y bonificaciones de todas las unidades de ataque y defensa del juego.\n                            </p>\n                        </CardContent>\n                    </Card>\n                </Link>\n                 <Link href=\"/admin/panel/properties\" className=\"group\">\n                    <Card className=\"hover:border-primary hover:shadow-primary/20 transition-all\">\n                        <CardHeader>\n                            <Hotel className=\"h-10 w-10 text-primary mb-2\" />\n                            <CardTitle>Propiedades</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                            <p className=\"text-muted-foreground\">\n                               Crea y gestiona propiedades para usuarios.\n                            </p>\n                        </CardContent>\n                    </Card>\n                </Link>\n                 <Link href=\"/admin/panel/verification\" className=\"group\">\n                    <Card className=\"hover:border-primary hover:shadow-primary/20 transition-all\">\n                        <CardHeader>\n                            <ShieldCheck className=\"h-10 w-10 text-primary mb-2\" />\n                            <CardTitle>Verificación</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                            <p className=\"text-muted-foreground\">\n                                Dashboard para verificar la lógica del juego y las fórmulas.\n                            </p>\n                        </CardContent>\n                    </Card>\n                </Link>\n            </div>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/rooms/[roomId]/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { getRoomConfigurations } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { RoomConfigForm } from \"@/components/admin/forms/room-config-form\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { FullConfiguracionHabitacion } from \"@/types\";\n\nexport default async function EditRoomPage(props: { params: Promise<{ roomId: string }> }) {\n    const params = await props.params;\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const { roomId } = params;\n    const isNew = roomId === 'new';\n\n    const allRooms = await getRoomConfigurations();\n\n    const room = isNew ? null : allRooms.find(r => r.id === roomId) as FullConfiguracionHabitacion | null;\n\n    if (!isNew && !room) {\n        return (\n            <div className=\"space-y-4\">\n                 <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/admin/panel/rooms\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver\n                    </Link>\n                </Button>\n                <Card>\n                    <CardHeader>\n                        <CardTitle>Error</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                        <p>No se encontró la habitación con el ID especificado.</p>\n                    </CardContent>\n                </Card>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel/rooms\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a la tabla de Habitaciones\n                </Link>\n            </Button>\n            <Card>\n                 <CardHeader>\n                    <CardTitle>{isNew ? \"Crear Nueva Habitación\" : `Editando: ${room?.nombre}`}</CardTitle>\n                    <CardDescription>\n                       Ajusta todos los parámetros de la habitación.\n                    </CardDescription>\n                </CardHeader>\n                <CardContent>\n                    <RoomConfigForm\n                        room={room}\n                        allRooms={allRooms}\n                    />\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/rooms/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { Button } from \"@/components/ui/button\";\nimport { redirect } from \"next/navigation\";\nimport { RoomConfigTable } from \"@/components/admin/room-config-table\";\nimport { getRoomConfigurations } from \"@/lib/data\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\n\nfunction TableSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full rounded-t-md\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                </div>\n            </div>\n        </div>\n    )\n}\n\nexport default async function AdminRoomsPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const rooms = await getRoomConfigurations();\n\n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver al Panel Principal\n                </Link>\n            </Button>\n            <Suspense fallback={<TableSkeleton />}>\n                <RoomConfigTable initialData={rooms} />\n            </Suspense>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/trainings/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { Button } from \"@/components/ui/button\";\nimport { redirect } from \"next/navigation\";\nimport { TrainingConfigTable } from \"@/components/admin/training-config-table\";\nimport { getTrainingConfigurations } from \"@/lib/data\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\n\nfunction TableSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full rounded-t-md\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                </div>\n            </div>\n        </div>\n    )\n}\n\nexport default async function AdminTrainingsPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const trainings = await getTrainingConfigurations();\n\n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver al Panel Principal\n                </Link>\n            </Button>\n            <Suspense fallback={<TableSkeleton />}>\n                <TrainingConfigTable initialData={trainings} />\n            </Suspense>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/trainings/[trainingId]/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { getTrainingConfigurations, FullConfiguracionEntrenamiento } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { TrainingConfigForm } from \"@/components/admin/forms/training-config-form\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\n\nexport default async function EditTrainingPage(props: { params: Promise<{ trainingId: string }> }) {\n    const params = await props.params;\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const { trainingId } = params;\n    const isNew = trainingId === 'new';\n\n    const allTrainings = await getTrainingConfigurations();\n\n    const training = isNew ? null : allTrainings.find(t => t.id === trainingId) as FullConfiguracionEntrenamiento | null;\n\n    if (!isNew && !training) {\n        return (\n            <div className=\"space-y-4\">\n                 <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/admin/panel/trainings\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver\n                    </Link>\n                </Button>\n                <Card>\n                    <CardHeader>\n                        <CardTitle>Error</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                        <p>No se encontró el entrenamiento con el ID especificado.</p>\n                    </CardContent>\n                </Card>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel/trainings\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a la tabla de Entrenamientos\n                </Link>\n            </Button>\n            <Card>\n                 <CardHeader>\n                    <CardTitle>{isNew ? \"Crear Nuevo Entrenamiento\" : `Editando: ${training?.nombre}`}</CardTitle>\n                    <CardDescription>\n                       Ajusta todos los parámetros del entrenamiento.\n                    </CardDescription>\n                </CardHeader>\n                <CardContent>\n                    <TrainingConfigForm\n                        training={training}\n                        allTrainings={allTrainings}\n                    />\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/properties/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft, Users } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { getUsersAdmin } from \"@/lib/data\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\nfunction TableSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full rounded-t-md\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                </div>\n            </div>\n        </div>\n    )\n}\n\nexport default async function AdminUserListPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const users = await getUsersAdmin();\n\n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver al Panel Principal\n                </Link>\n            </Button>\n            <Suspense fallback={<TableSkeleton />}>\n                <Card>\n                    <CardHeader>\n                        <CardTitle>Gestión de Jugadores y Propiedades</CardTitle>\n                        <CardDescription>Selecciona un jugador para editar sus propiedades, entrenamientos y recursos en lote.</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                        <div className=\"rounded-md border\">\n                            <Table>\n                                <TableHeader>\n                                    <TableRow>\n                                        <TableHead className=\"w-[250px]\">Jugador</TableHead>\n                                        <TableHead>Email</TableHead>\n                                        <TableHead className=\"text-right\">Acciones</TableHead>\n                                    </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                    {users.map(user => (\n                                        <TableRow key={user.id}>\n                                            <TableCell>\n                                                <div className=\"flex items-center gap-3\">\n                                                    <Avatar className=\"h-8 w-8\">\n                                                        <AvatarImage src={user.avatarUrl || ''} />\n                                                        <AvatarFallback>{user.name?.charAt(0) || 'U'}</AvatarFallback>\n                                                    </Avatar>\n                                                    <span className=\"font-medium\">{user.name}</span>\n                                                </div>\n                                            </TableCell>\n                                            <TableCell className=\"text-muted-foreground\">{user.email}</TableCell>\n                                            <TableCell className=\"text-right\">\n                                                <Button asChild variant=\"outline\" size=\"sm\">\n                                                    <Link href={`/admin/panel/properties/${user.id}/edit`}>\n                                                        <Users className=\"mr-2 h-4 w-4\"/>\n                                                        Gestionar\n                                                    </Link>\n                                                </Button>\n                                            </TableCell>\n                                        </TableRow>\n                                    ))}\n                                </TableBody>\n                            </Table>\n                        </div>\n                    </CardContent>\n                </Card>\n            </Suspense>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/properties/[userId]/edit/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft, Brain, Coins, Sprout, Tent } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { getUserProfileById } from \"@/lib/data\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\n\nfunction EditUserHubSkeleton() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center gap-4\">\n                <Skeleton className=\"h-16 w-16 rounded-full\" />\n                <div className=\"space-y-2\">\n                    <Skeleton className=\"h-8 w-48\" />\n                    <Skeleton className=\"h-4 w-32\" />\n                </div>\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <Skeleton className=\"h-40 w-full\" />\n                <Skeleton className=\"h-40 w-full\" />\n                <Skeleton className=\"h-40 w-full\" />\n                <Skeleton className=\"h-40 w-full\" />\n            </div>\n        </div>\n    );\n}\n\nconst actionCards = [\n    {\n        href: 'trainings',\n        title: 'Gestionar Entrenamientos',\n        description: 'Ajusta los niveles de todas las investigaciones del usuario.',\n        icon: <Brain className=\"h-8 w-8 text-primary\" />\n    },\n    {\n        href: 'resources',\n        title: 'Ajustar Recursos',\n        description: 'Modifica los recursos de una o varias de sus propiedades.',\n        icon: <Coins className=\"h-8 w-8 text-primary\" />\n    },\n    {\n        href: 'rooms',\n        title: 'Editar Niveles de Habitaciones',\n        description: 'Establece los niveles de los edificios en las propiedades seleccionadas.',\n        icon: <Tent className=\"h-8 w-8 text-primary\" />\n    },\n    {\n        href: 'troops',\n        title: 'Añadir Tropas',\n        description: 'Añade unidades de ataque o defensa a las propiedades del usuario.',\n        icon: <Sprout className=\"h-8 w-8 text-primary\" />\n    }\n]\n\nexport default async function AdminEditUserHubPage(props: {\n    params: Promise<{ userId: string }>;\n}) {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n    \n    const { userId } = await props.params;\n\n    const userProfile = await getUserProfileById(userId);\n\n    if (!userProfile) {\n         return (\n            <div className=\"space-y-4 max-w-4xl mx-auto\">\n                <p>Usuario no encontrado.</p>\n                 <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/admin/panel/properties\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver a la lista\n                    </Link>\n                </Button>\n            </div>\n        );\n    }\n    \n    return (\n        <div className=\"space-y-6 max-w-6xl mx-auto\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel/properties\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a la lista de usuarios\n                </Link>\n            </Button>\n            \n            <Suspense fallback={<EditUserHubSkeleton />}>\n                <div className=\"space-y-6\">\n                    <div className=\"flex items-center gap-4\">\n                        <Avatar className=\"h-16 w-16\">\n                            <AvatarImage src={userProfile.avatarUrl || ''} />\n                            <AvatarFallback>{userProfile.name.charAt(0)}</AvatarFallback>\n                        </Avatar>\n                        <div>\n                            <p className=\"text-sm text-muted-foreground\">Editando a:</p>\n                            <h1 className=\"text-3xl font-bold tracking-tight\">{userProfile.name}</h1>\n                        </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                        {actionCards.map(card => (\n                             <Link key={card.href} href={`/admin/panel/properties/${userId}/edit/${card.href}`} className=\"group\">\n                                <Card className=\"hover:border-primary hover:shadow-primary/20 transition-all h-full\">\n                                    <CardHeader className=\"flex flex-row items-center gap-4\">\n                                        {card.icon}\n                                        <div>\n                                            <CardTitle>{card.title}</CardTitle>\n                                            <CardDescription>{card.description}</CardDescription>\n                                        </div>\n                                    </CardHeader>\n                                </Card>\n                            </Link>\n                        ))}\n                    </div>\n                </div>\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/properties/[userId]/edit/rooms/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { getUserProfileById, getRoomConfigurations, getUserResources } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { EditRoomsForm } from \"@/components/admin/batch-forms/edit-rooms-form\";\nimport type { FullPropiedad } from \"@/types\";\n\nfunction FormSkeleton() {\n    return <Skeleton className=\"h-96 w-full\" />;\n}\n\nexport default async function AdminEditRoomsPage(props: {\n    params: Promise<{ userId: string }>;\n}) {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) redirect('/admin');\n\n    const { userId } = await props.params;\n    const [user, allRooms, userProperties] = await Promise.all([\n        getUserProfileById(userId),\n        getRoomConfigurations(),\n        getUserResources(userId)\n    ]);\n\n    if (!user) {\n        return <p>Usuario no encontrado.</p>;\n    }\n    \n    return (\n        <div className=\"space-y-6\">\n            <Suspense fallback={<FormSkeleton />}>\n                <EditRoomsForm user={user} properties={userProperties as FullPropiedad[]} allRooms={allRooms} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/properties/[userId]/edit/trainings/page.tsx": "import { getAdminSession } from \"@/lib/auth-admin\";\nimport { getUserProfileById, getTrainingConfigurations, getUserTrainings } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { EditTrainingsForm } from \"@/components/admin/batch-forms/edit-trainings-form\";\n\nfunction FormSkeleton() {\n    return <Skeleton className=\"h-96 w-full\" />;\n}\n\nexport default async function AdminEditTrainingsPage(props: {\n    params: Promise<{ userId: string }>;\n}) {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) redirect('/admin');\n\n    const { userId } = await props.params;\n\n    const [user, userTrainings, allTrainings] = await Promise.all([\n        getUserProfileById(userId),\n        getUserTrainings(userId),\n        getTrainingConfigurations()\n    ]);\n\n    if (!user) {\n        return <p>Usuario no encontrado.</p>;\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <Suspense fallback={<FormSkeleton />}>\n                <EditTrainingsForm user={user} userTrainings={userTrainings} allTrainings={allTrainings} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/properties/[userId]/edit/resources/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { getUserProfileById, getUserResources } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { EditResourcesForm } from \"@/components/admin/batch-forms/edit-resources-form\";\nimport type { FullPropiedad } from \"@/types\";\n\nfunction FormSkeleton() {\n    return <Skeleton className=\"h-96 w-full\" />;\n}\n\nexport default async function AdminEditResourcesPage(props: {\n    params: Promise<{ userId: string }>;\n}) {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) redirect('/admin');\n\n    const { userId } = await props.params;\n    const [user, userProperties] = await Promise.all([\n        getUserProfileById(userId),\n        getUserResources(userId)\n    ]);\n\n\n    if (!user) {\n        return <p>Usuario no encontrado.</p>;\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <Suspense fallback={<FormSkeleton />}>\n                <EditResourcesForm user={user} properties={userProperties as FullPropiedad[]} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/properties/[userId]/edit/troops/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { getUserProfileById, getTroopConfigurations, getUserResources } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { EditTroopsForm } from \"@/components/admin/batch-forms/edit-troops-form\";\nimport type { FullPropiedad } from \"@/types\";\n\nfunction FormSkeleton() {\n    return <Skeleton className=\"h-96 w-full\" />;\n}\n\nexport default async function AdminEditTroopsPage(props: {\n    params: Promise<{ userId: string }>;\n}) {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) redirect('/admin');\n\n    const { userId } = await props.params;\n    const [user, allTroops, userProperties] = await Promise.all([\n        getUserProfileById(userId),\n        getTroopConfigurations(),\n        getUserResources(userId)\n    ]);\n\n    if (!user) {\n        return <p>Usuario no encontrado.</p>;\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <Suspense fallback={<FormSkeleton />}>\n                <EditTroopsForm user={user} properties={userProperties as FullPropiedad[]} allTroops={allTroops} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/properties/new/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { CreatePropertyForm } from \"@/components/admin/forms/create-property-form\";\nimport { getRoomConfigurations, getUsers } from \"@/lib/data\";\nimport { Button } from \"@/components/ui/button\";\n\nfunction FormSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md p-6\">\n                <Skeleton className=\"h-8 w-1/4 mb-2\" />\n                <Skeleton className=\"h-10 w-full mb-4\" />\n                <Skeleton className=\"h-10 w-1/3\" />\n            </div>\n        </div>\n    )\n}\n\nexport default async function AdminCreatePropertyPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const [users, roomConfigs] = await Promise.all([\n        getUsers(),\n        getRoomConfigurations()\n    ]);\n\n    return (\n        <div className=\"space-y-4 max-w-4xl mx-auto\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel/properties\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a la lista de usuarios\n                </Link>\n            </Button>\n            \n            <Suspense fallback={<FormSkeleton />}>\n                <CreatePropertyForm users={users} allRooms={roomConfigs} />\n            </Suspense>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/database/page.tsx": "import { createAdminClient } from \"@/utils/supabase/server\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Search } from 'lucide-react';\nimport { ExportAllSchemaButton } from \"@/components/admin/export-all-schema-button\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport { FileJson } from \"lucide-react\";\nimport { ExportSchemaButton } from \"@/components/admin/export-schema-button\";\n\n\nexport default async function DatabaseInspectorPage() {\n    const supabase = createAdminClient();\n    const { data, error } = await supabase.rpc('get_schema_introspection_data');\n\n    if (error) return <div className=\"p-8 text-red-500\">Error: {error.message}</div>;\n    if (!data) return <div className=\"p-8\">No se encontraron datos.</div>;\n\n    // Although the page is now a server component, we keep the filtering logic on the client\n    // for the interactivity of the search input. This requires converting the main component\n    // to a client component that receives the data as props.\n    \n    // For simplicity and to follow the spirit of the instruction, we will do the initial rendering\n    // directly on the server and leave interactivity for a future refactor to client.\n    \n    const groupedTables = data.tables ? Object.values(data.tables.reduce((acc: any, row: any) => {\n        acc[row.table_name] = acc[row.table_name] || [];\n        acc[row.table_name].push(row);\n        return acc;\n    }, {} as Record<string, any[]>)) : [];\n\n    return (\n        <div className=\"container mx-auto py-6 space-y-6\">\n            <div className=\"flex justify-between items-center\">\n                <h1 className=\"text-3xl font-bold\">Inspector de Base de Datos</h1>\n                {/* The search input would require a client component */}\n            </div>\n\n            <div className=\"flex items-center justify-end gap-2\">\n                 <ExportAllSchemaButton data={data} />\n                <Button asChild variant=\"outline\">\n                    <Link href=\"/admin/panel/database/configuration\">\n                        <FileJson className=\"mr-2 h-4 w-4\" />\n                        Ver Configuración\n                    </Link>\n                </Button>\n            </div>\n\n            <Tabs defaultValue=\"tables\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-5\">\n                    <TabsTrigger value=\"tables\">Tablas ({data.tables?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"functions\">Funciones ({data.functions?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"triggers\">Triggers ({data.triggers?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"policies\">Policies ({data.policies?.length || 0})</TabsTrigger>\n                    <TabsTrigger value=\"enums\">Enums ({data.enums?.length || 0})</TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"tables\">\n                    <Card>\n                        <CardHeader className=\"flex flex-row justify-between items-center\">\n                            <CardTitle>Tablas Públicas</CardTitle>\n                             <ExportSchemaButton data={data.tables || []} fileName=\"tablas.json\" />\n                        </CardHeader>\n                        <CardContent>\n                            <Accordion type=\"single\" collapsible className=\"w-full\">\n                                {groupedTables.map((table: any, idx: number) => (\n                                    <AccordionItem key={idx} value={`table-${idx}`}>\n                                        <AccordionTrigger className=\"font-mono text-sm\">{table[0]?.table_name}</AccordionTrigger>\n                                        <AccordionContent>\n                                            <div className=\"rounded-md border p-4 bg-muted/50\">\n                                                <table className=\"w-full text-sm text-left\">\n                                                    <thead>\n                                                        <tr className=\"border-b\">\n                                                            <th className=\"py-2\">Columna</th>\n                                                            <th className=\"py-2\">Tipo</th>\n                                                            <th className=\"py-2\">Nullable</th>\n                                                            <th className=\"py-2\">Default</th>\n                                                        </tr>\n                                                    </thead>\n                                                    <tbody>\n                                                        {table.map((col: any, cIdx: number) => (\n                                                            <tr key={cIdx} className=\"border-b last:border-0\">\n                                                                <td className=\"py-2 font-mono\">{col.column_name}</td>\n                                                                <td className=\"py-2 text-blue-600 dark:text-blue-400\">{col.data_type}</td>\n                                                                <td className=\"py-2\">{col.is_nullable}</td>\n                                                                <td className=\"py-2 text-muted-foreground break-all\">{col.column_default || '-'}</td>\n                                                            </tr>\n                                                        ))}\n                                                    </tbody>\n                                                </table>\n                                            </div>\n                                        </AccordionContent>\n                                    </AccordionItem>\n                                ))}\n                            </Accordion>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                <TabsContent value=\"functions\">\n                    <Card>\n                        <CardHeader className=\"flex flex-row justify-between items-center\">\n                            <CardTitle>Funciones RPC</CardTitle>\n                             <ExportSchemaButton data={data.functions || []} fileName=\"funciones.json\" />\n                        </CardHeader>\n                        <CardContent>\n                            <ScrollArea className=\"h-[600px] w-full pr-4\">\n                                <Accordion type=\"single\" collapsible className=\"w-full\">\n                                    {data.functions.map((func: any, idx: number) => (\n                                        <AccordionItem key={idx} value={`func-${idx}`}>\n                                            <AccordionTrigger className=\"font-mono text-sm hover:no-underline\">\n                                                <div className=\"flex items-center gap-2\">\n                                                    <span className=\"font-bold text-purple-600 dark:text-purple-400\">{func.function_name}</span>\n                                                    <Badge variant=\"outline\" className=\"text-xs\">{func.language}</Badge>\n                                                </div>\n                                            </AccordionTrigger>\n                                            <AccordionContent>\n                                                <div className=\"space-y-4\">\n                                                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                                                        <div>\n                                                            <span className=\"font-semibold text-muted-foreground\">Argumentos:</span>\n                                                            <p className=\"font-mono mt-1\">{func.arguments || 'None'}</p>\n                                                        </div>\n                                                        <div>\n                                                            <span className=\"font-semibold text-muted-foreground\">Retorno:</span>\n                                                            <p className=\"font-mono mt-1\">{func.return_type}</p>\n                                                        </div>\n                                                    </div>\n                                                    <div className=\"relative\">\n                                                        <pre className=\"p-4 rounded-md bg-slate-950 text-slate-50 overflow-x-auto text-xs font-mono\">\n                                                            <code>{func.source_code}</code>\n                                                        </pre>\n                                                    </div>\n                                                </div>\n                                            </AccordionContent>\n                                        </AccordionItem>\n                                    ))}\n                                </Accordion>\n                            </ScrollArea>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                <TabsContent value=\"triggers\">\n                    <Card>\n                        <CardHeader className=\"flex flex-row justify-between items-center\">\n                            <CardTitle>Triggers</CardTitle>\n                             <ExportSchemaButton data={data.triggers || []} fileName=\"triggers.json\" />\n                        </CardHeader>\n                        <CardContent>\n                            <Accordion type=\"single\" collapsible className=\"w-full\">\n                                {data.triggers.map((trigger: any, idx: number) => (\n                                    <AccordionItem key={idx} value={`trigger-${idx}`}>\n                                        <AccordionTrigger className=\"font-mono text-sm\">\n                                            {trigger.trigger_name} <span className=\"text-muted-foreground ml-2\">({trigger.table_name})</span>\n                                        </AccordionTrigger>\n                                        <AccordionContent>\n                                            <div className=\"space-y-2\">\n                                                <p className=\"text-sm\"><span className=\"font-semibold\">Función:</span> {trigger.function_name}</p>\n                                                <pre className=\"p-4 rounded-md bg-slate-950 text-slate-50 overflow-x-auto text-xs font-mono\">\n                                                    <code>{trigger.definition}</code>\n                                                </pre>\n                                            </div>\n                                        </AccordionContent>\n                                    </AccordionItem>\n                                ))}\n                            </Accordion>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                <TabsContent value=\"policies\">\n                    <Card>\n                         <CardHeader className=\"flex flex-row justify-between items-center\">\n                            <CardTitle>RLS Policies</CardTitle>\n                             <ExportSchemaButton data={data.policies || []} fileName=\"policies.json\" />\n                        </CardHeader>\n                        <CardContent>\n                            <Accordion type=\"single\" collapsible className=\"w-full\">\n                                {data.policies.map((policy: any, idx: number) => (\n                                    <AccordionItem key={idx} value={`policy-${idx}`}>\n                                        <AccordionTrigger className=\"font-mono text-sm text-left\">\n                                            <div className=\"flex flex-col items-start gap-1\">\n                                                <span>{policy.policy_name}</span>\n                                                <div className=\"flex gap-2\">\n                                                    <Badge variant=\"secondary\" className=\"text-[10px]\">{policy.table_name}</Badge>\n                                                    <Badge className={\n                                                        policy.command === 'SELECT' ? 'bg-blue-500' :\n                                                        policy.command === 'INSERT' ? 'bg-green-500' :\n                                                        policy.command === 'UPDATE' ? 'bg-yellow-500' :\n                                                        'bg-red-500'\n                                                    }>{policy.command}</Badge>\n                                                </div>\n                                            </div>\n                                        </AccordionTrigger>\n                                        <AccordionContent>\n                                            <div className=\"space-y-4 text-sm\">\n                                                <div className=\"grid grid-cols-2 gap-4\">\n                                                    <div>\n                                                        <span className=\"font-semibold block mb-1\">Roles:</span>\n                                                        <span className=\"font-mono text-muted-foreground\">\n                                                            {policy.roles ? `{${policy.roles.join(', ')}}` : 'PUBLIC'}\n                                                        </span>\n                                                    </div>\n                                                </div>\n                                                {policy.using_expression && (\n                                                    <div>\n                                                        <span className=\"font-semibold block mb-1\">USING (Rows visible):</span>\n                                                        <pre className=\"p-2 rounded bg-muted font-mono text-xs whitespace-pre-wrap\">\n                                                            {policy.using_expression}\n                                                        </pre>\n                                                    </div>\n                                                )}\n                                                {policy.check_expression && (\n                                                    <div>\n                                                        <span className=\"font-semibold block mb-1\">WITH CHECK (Rows insertable/updatable):</span>\n                                                        <pre className=\"p-2 rounded bg-muted font-mono text-xs whitespace-pre-wrap\">\n                                                            {policy.check_expression}\n                                                        </pre>\n                                                    </div>\n                                                )}\n                                            </div>\n                                        </AccordionContent>\n                                    </AccordionItem>\n                                ))}\n                            </Accordion>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n\n                 <TabsContent value=\"enums\">\n                    <Card>\n                        <CardHeader>\n                            <CardTitle>Enums</CardTitle>\n                            <CardDescription>Tipos enumerados personalizados.</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                                {data.enums.map((e: any, idx: number) => (\n                                    <Card key={idx}>\n                                        <CardHeader className=\"pb-2\">\n                                            <CardTitle className=\"text-base font-mono\">{e.type_name}</CardTitle>\n                                        </CardHeader>\n                                        <CardContent>\n                                            <div className=\"flex flex-wrap gap-2\">\n                                                {e.values.map((val: string, vIdx: number) => (\n                                                    <Badge key={vIdx} variant=\"outline\">{val}</Badge>\n                                                ))}\n                                            </div>\n                                        </CardContent>\n                                    </Card>\n                                ))}\n                            </div>\n                        </CardContent>\n                    </Card>\n                </TabsContent>\n            </Tabs>\n        </div>\n    );\n}",
    "src/app/admin/panel/database/configuration/page.tsx": "import { createClient } from \"@/utils/supabase/server\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ConfigDownloadButton } from \"@/components/admin/config-download-button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface ConfigItem {\n  table_name: string;\n  data: any;\n}\n\nexport default async function ConfigurationPage() {\n  const supabase = await createClient();\n\n  // 🟢 CORRECCIÓN: Consultar la nueva vista en el esquema 'public'\n  const { data: rawConfigs, error } = await supabase\n    .from('configurations_data')\n    .select('*');\n\n  if (error) {\n    return (\n      <div className=\"p-6 text-red-500 bg-red-50 rounded-md border border-red-200\">\n        <h3 className=\"font-bold\">Error cargando configuración</h3>\n        <p>{error.message}</p>\n        <p className=\"text-sm mt-2 text-gray-600\">\n          Asegúrate de que la vista `public.configurations_data` existe y tiene los permisos correctos.\n        </p>\n      </div>\n    );\n  }\n\n  // Agregación manual: Group by table_name\n  const groupedConfigs: Record<string, any[]> = {};\n  if (rawConfigs) {\n    rawConfigs.forEach((item: ConfigItem) => {\n        if (!groupedConfigs[item.table_name]) {\n            groupedConfigs[item.table_name] = [];\n        }\n        groupedConfigs[item.table_name].push(item.data);\n    });\n  }\n\n  const configs = Object.keys(groupedConfigs).sort().map(tableName => ({\n    table_name: tableName,\n    data: groupedConfigs[tableName],\n    exported_at: new Date().toISOString()\n  }));\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\">Configuración del Juego</h1>\n          <p className=\"text-muted-foreground\">Datos estáticos y reglas de balanceo (Valores Actuales).</p>\n        </div>\n        <Badge variant=\"outline\" className=\"px-3 py-1\">\n          {configs.length} Tablas Detectadas\n        </Badge>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-1 lg:grid-cols-2\">\n        {configs.map((config) => (\n          <Card key={config.table_name} className=\"flex flex-col shadow-sm\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"text-lg\">{config.table_name}</CardTitle>\n                  <CardDescription className=\"text-xs font-mono mt-1\">\n                    Exportado: {new Date(config.exported_at).toLocaleTimeString()}\n                  </CardDescription>\n                </div>\n                <ConfigDownloadButton\n                  tableName={config.table_name}\n                  data={config.data}\n                />\n              </div>\n            </CardHeader>\n            <CardContent className=\"flex-1 min-h-[250px]\">\n              <div className=\"rounded-md border bg-muted/50 p-4 h-full\">\n                <ScrollArea className=\"h-[250px] w-full\">\n                  <pre className=\"text-[10px] leading-relaxed font-mono text-foreground/80\">\n                    {JSON.stringify(config.data, null, 2)}\n                  </pre>\n                </ScrollArea>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n",
    "src/app/admin/panel/property/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { CreatePropertyForm } from \"@/components/admin/forms/create-property-form\";\nimport { getRoomConfigurations, getUsers } from \"@/lib/data\";\nimport { Button } from \"@/components/ui/button\";\n\nfunction FormSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md p-6\">\n                <Skeleton className=\"h-8 w-1/4 mb-2\" />\n                <Skeleton className=\"h-10 w-full mb-4\" />\n                <Skeleton className=\"h-10 w-1/3\" />\n            </div>\n        </div>\n    )\n}\n\nexport default async function AdminCreatePropertyPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const [users, roomConfigs] = await Promise.all([\n        getUsers(),\n        getRoomConfigurations()\n    ]);\n\n    return (\n        <div className=\"space-y-4 max-w-4xl mx-auto\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel/properties\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a Propiedades\n                </Link>\n            </Button>\n            \n            <Suspense fallback={<FormSkeleton />}>\n                <CreatePropertyForm users={users} allRooms={roomConfigs} />\n            </Suspense>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/editor/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { DataEditorView } from \"@/components/admin/data-editor-view\";\n\nfunction EditorSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <Skeleton className=\"h-64 w-full\" />\n            <Skeleton className=\"h-96 w-full\" />\n        </div>\n    )\n}\n\nexport default async function AdminDataEditorPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n    \n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver al Panel Principal\n                </Link>\n            </Button>\n            <Suspense fallback={<EditorSkeleton />}>\n                <DataEditorView />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/admin/panel/troops/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { Button } from \"@/components/ui/button\";\nimport { redirect } from \"next/navigation\";\nimport { TroopConfigTable } from \"@/components/admin/troop-config-table\";\nimport { getTrainingConfigurations, getTroopConfigurations } from \"@/lib/data\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { TipoTropa } from \"@/types\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\n\nfunction TableSkeleton() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full rounded-t-md\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                    <Skeleton className=\"h-8 w-full\" />\n                </div>\n            </div>\n        </div>\n    )\n}\n\nexport default async function AdminTroopsPage() {\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const troops = await getTroopConfigurations();\n    const trainings = await getTrainingConfigurations();\n    const tiposTropa = Object.values(TipoTropa);\n\n    return (\n        <div className=\"space-y-4\">\n             <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver al Panel Principal\n                </Link>\n            </Button>\n            <Suspense fallback={<TableSkeleton />}>\n                <TroopConfigTable \n                    initialData={troops} \n                    allTrainings={trainings}\n                    tiposTropa={tiposTropa} \n                />\n            </Suspense>\n        </div>\n    )\n}\n",
    "src/app/admin/panel/troops/[troopId]/page.tsx": "\nimport { getAdminSession } from \"@/lib/auth-admin\";\nimport { getTrainingConfigurations, getTroopConfigurations, FullConfiguracionTropa } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { TroopConfigForm } from \"@/components/admin/forms/troop-config-form\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { TipoTropa } from \"@/types\";\n\nexport default async function EditTroopPage(props: { params: Promise<{ troopId: string }> }) {\n    const params = await props.params;\n    const isAdmin = await getAdminSession();\n    if (!isAdmin) {\n        redirect('/admin');\n    }\n\n    const { troopId } = params;\n    const isNew = troopId === 'new';\n\n    const [allTroops, allTrainings] = await Promise.all([\n        getTroopConfigurations(),\n        getTrainingConfigurations()\n    ]);\n\n    const troop = isNew ? null : allTroops.find(t => t.id === troopId) as FullConfiguracionTropa | null;\n\n    if (!isNew && !troop) {\n        return (\n            <div className=\"space-y-4\">\n                 <Button asChild variant=\"outline\" size=\"sm\">\n                    <Link href=\"/admin/panel/troops\">\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                        Volver\n                    </Link>\n                </Button>\n                <Card>\n                    <CardHeader>\n                        <CardTitle>Error</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                        <p>No se encontró la tropa con el ID especificado.</p>\n                    </CardContent>\n                </Card>\n            </div>\n        );\n    }\n    const tiposTropa = Object.values(TipoTropa);\n\n\n    return (\n        <div className=\"space-y-4\">\n            <Button asChild variant=\"outline\" size=\"sm\">\n                <Link href=\"/admin/panel/troops\">\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                    Volver a la tabla de Tropas\n                </Link>\n            </Button>\n            <Card>\n                 <CardHeader>\n                    <CardTitle>{isNew ? \"Crear Nueva Tropa\" : `Editando: ${troop?.nombre}`}</CardTitle>\n                    <CardDescription>\n                       Ajusta todos los parámetros de la unidad.\n                    </CardDescription>\n                </CardHeader>\n                <CardContent>\n                    <TroopConfigForm\n                        troop={troop}\n                        allTroops={allTroops}\n                        allTrainings={allTrainings}\n                        tiposTropa={tiposTropa}\n                    />\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n",
    "src/app/login/page.tsx": "import Link from \"next/link\";\nimport { LoginForm } from \"./login-form\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\n\n// Asegurar que la verificación de sesión sea en tiempo real\nexport const dynamic = 'force-dynamic';\nexport const experimental_ppr = true;\nexport default async function LoginPage() {\n  let user = null;\n  try {\n    user = await getSessionUser();\n  } catch (error) {\n    // Fail safe: Si falla la DB, permitimos intentar login\n    console.error(\"[LoginPage] Error checking session, proceeding to login form:\", error);\n  }\n\n  if (user) {\n    redirect('/overview');\n  }\n\n  return (\n    <main className=\"relative flex min-h-screen w-full flex-col items-center justify-center p-4\">\n        <div className=\"z-10 flex flex-col items-center justify-center space-y-8\">\n            <LoginForm />\n        </div>\n        <div className=\"absolute bottom-4 right-4 z-10\">\n            <Link href=\"/admin\" className=\"text-xs text-muted-foreground hover:text-primary transition-colors\">\n                Admin\n            </Link>\n        </div>\n    </main>\n  );\n}\n",
    "src/app/login/error.tsx": "'use client';\n\nimport { useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { AlertCircle } from 'lucide-react';\n\nexport default function Error({\n  error,\n  reset,\n}: {\n  error: Error & { digest?: string };\n  reset: () => void;\n}) {\n  useEffect(() => {\n    console.error('[LoginError] Error captured:', error);\n  }, [error]);\n\n  return (\n    <div className=\"flex min-h-screen flex-col items-center justify-center bg-background p-4 text-center\">\n      <div className=\"flex flex-col items-center space-y-4 max-w-md\">\n        <div className=\"rounded-full bg-destructive/10 p-4\">\n            <AlertCircle className=\"h-10 w-10 text-destructive\" />\n        </div>\n        <h2 className=\"text-2xl font-bold tracking-tight\">Algo salió mal</h2>\n        <p className=\"text-muted-foreground\">\n          Ocurrió un error inesperado al cargar el formulario de acceso.\n          {error.message && <span className=\"block mt-2 text-xs font-mono bg-muted p-2 rounded\">{error.message}</span>}\n        </p>\n        <div className=\"flex gap-4 pt-4\">\n             <Button onClick={() => window.location.reload()} variant=\"outline\">\n                Recargar página\n            </Button>\n            <Button onClick={() => reset()}>\n                Reintentar\n            </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n",
    "src/app/login/login-form.tsx": "'use client';\n\nimport { useState, useTransition } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Label } from '@/components/ui/label';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\"\nimport { Loader2, Terminal, Eye, EyeOff } from 'lucide-react';\nimport { login, registerUser } from '@/lib/actions/auth.actions';\n\nconst PasswordInput = ({ className, ...props }: React.ComponentProps<typeof Input>) => {\n    const [show, setShow] = useState(false);\n    return (\n        <div className=\"relative\">\n            <Input\n                type={show ? \"text\" : \"password\"}\n                className={`pr-10 ${className || ''}`}\n                {...props}\n            />\n            <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent text-muted-foreground\"\n                onClick={() => setShow(!show)}\n                aria-label={show ? \"Ocultar contraseña\" : \"Mostrar contraseña\"}\n            >\n                {show ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n            </Button>\n        </div>\n    );\n};\n\nexport function LoginForm() {\n    const router = useRouter();\n    const { toast } = useToast();\n    const [isLoginView, setIsLoginView] = useState(true);\n    const [isPending, startTransition] = useTransition();\n\n    // Common state\n    const [username, setUsername] = useState('');\n    const [password, setPassword] = useState('');\n    const [email, setEmail] = useState('');\n    const [error, setError] = useState('');\n\n    const [confirmPassword, setConfirmPassword] = useState('');\n\n    // Location state\n    const [locationMode, setLocationMode] = useState<'random' | 'manual'>('random');\n    const [city, setCity] = useState('');\n    const [district, setDistrict] = useState('');\n    const [building, setBuilding] = useState('');\n\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        setError('');\n\n        if (isLoginView) {\n             startTransition(async () => {\n                const result = await login({ email: email, password });\n                if (result.error) {\n                    setError(result.error);\n                } else {\n                    toast({ title: \"Inicio de sesión exitoso\", description: \"Bienvenido de nuevo, Jefe.\" });\n                    router.push('/overview');\n                    router.refresh();\n                }\n            });\n        } else {\n            // Registration logic\n            if (password !== confirmPassword) {\n                setError('Las contraseñas no coinciden.');\n                return;\n            }\n            if (password.length < 6) {\n                setError('La contraseña debe tener al menos 6 caracteres.');\n                return;\n            }\n\n            startTransition(async () => {\n                const result = await registerUser({\n                    email,\n                    password,\n                    username,\n                    locationMode,\n                    coordinates: locationMode === 'manual' ? {\n                        ciudad: parseInt(city),\n                        barrio: parseInt(district),\n                        edificio: parseInt(building)\n                    } : undefined\n                });\n\n                if (result.error) {\n                    setError(result.error);\n                } else {\n                    // Smart Redirect: Check if session was created automatically\n                    if (result.sessionCreated) {\n                        toast({\n                            title: \"¡Bienvenido, Jefe!\",\n                            description: \"Tu imperio te espera.\",\n                        });\n                        router.push('/overview');\n                    } else {\n                        toast({\n                            title: \"¡Registro casi completo!\",\n                            description: \"Registro completado. Por favor, revisa tu correo para confirmar la cuenta.\"\n                        });\n                        router.push('/verify');\n                    }\n                }\n            });\n        }\n    };\n\n    const renderLogin = () => (\n        <form onSubmit={handleSubmit}>\n            <CardHeader className=\"text-center\">\n                <CardTitle className=\"text-4xl font-heading tracking-widest text-white/90\">INICIAR SESIÓN</CardTitle>\n                <CardDescription className=\"text-white/70\">Introduce tus credenciales para acceder a tu imperio.</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '100ms' }}>\n                    <Label htmlFor=\"email-login\">Correo Electrónico</Label>\n                    <Input id=\"email-login\" name=\"email\" type=\"email\" placeholder=\"jefe@imperio.com\" value={email} onChange={(e) => setEmail(e.target.value)} required disabled={isPending} />\n                </div>\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '200ms' }}>\n                    <Label htmlFor=\"password-login\">Contraseña</Label>\n                    <PasswordInput id=\"password-login\" name=\"password\" placeholder=\"Tu código secreto\" value={password} onChange={(e) => setPassword(e.target.value)} required disabled={isPending} />\n                </div>\n                 {error && (\n                    <Alert variant=\"destructive\" className=\"bg-destructive/20 border-destructive/50 text-destructive-foreground\">\n                        <Terminal className=\"h-4 w-4\" />\n                        <AlertTitle>Error</AlertTitle>\n                        <AlertDescription>{error}</AlertDescription>\n                    </Alert>\n                )}\n            </CardContent>\n            <CardFooter className=\"flex-col gap-4\">\n                <Button type=\"submit\" variant=\"destructive\" className=\"w-full transition-all hover:scale-105\" disabled={isPending}>\n                    {isPending ? (\n                        <span className=\"flex items-center justify-center\">\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                            <span>Entrando...</span>\n                        </span>\n                    ) : (\n                        <span>Entrar</span>\n                    )}\n                </Button>\n            </CardFooter>\n        </form>\n    );\n\n    const renderRegister = () => (\n         <form onSubmit={handleSubmit}>\n            <CardHeader className=\"text-center\">\n                <CardTitle className=\"text-4xl font-heading tracking-widest text-white/90\">CREAR CUENTA</CardTitle>\n                <CardDescription className=\"text-white/70\">Únete a la familia.</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '100ms' }}>\n                    <Label htmlFor=\"username-register\">Usuario</Label>\n                    <Input id=\"username-register\" name=\"username\" type=\"text\" placeholder=\"Tu nombre de guerra\" value={username} onChange={(e) => setUsername(e.target.value)} required />\n                </div>\n                 <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '200ms' }}>\n                    <Label htmlFor=\"email-register\">Correo Electrónico</Label>\n                    <Input id=\"email-register\" name=\"email\" type=\"email\" placeholder=\"tu@correo.com\" value={email} onChange={(e) => setEmail(e.target.value)} required />\n                </div>\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '300ms' }}>\n                    <Label htmlFor=\"password-register\">Contraseña</Label>\n                    <PasswordInput id=\"password-register\" name=\"password\" placeholder=\"Tu código secreto (mín. 6 caracteres)\" value={password} onChange={(e) => setPassword(e.target.value)} required />\n                </div>\n                <div className=\"space-y-2 animate-fade-in-up\" style={{ animationDelay: '400ms' }}>\n                    <Label htmlFor=\"confirm-password\">Confirmar Contraseña</Label>\n                    <PasswordInput id=\"confirm-password\" placeholder=\"Repite tu código secreto\" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} required />\n                </div>\n\n                <div className=\"space-y-4 pt-2 animate-fade-in-up\" style={{ animationDelay: '500ms' }}>\n                    <Label>Ubicación Inicial</Label>\n                    <RadioGroup defaultValue=\"random\" value={locationMode} onValueChange={(v: 'random' | 'manual') => setLocationMode(v)} className=\"flex gap-4\">\n                        <div className=\"flex items-center space-x-2\">\n                            <RadioGroupItem value=\"random\" id=\"loc-random\" />\n                            <Label htmlFor=\"loc-random\">Aleatoria</Label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                            <RadioGroupItem value=\"manual\" id=\"loc-manual\" />\n                            <Label htmlFor=\"loc-manual\">Manual</Label>\n                        </div>\n                    </RadioGroup>\n                </div>\n\n                {locationMode === 'manual' && (\n                    <div className=\"grid grid-cols-3 gap-2 animate-fade-in-up\" style={{ animationDelay: '550ms' }}>\n                        <div className=\"space-y-1\">\n                            <Label htmlFor=\"city\" className=\"text-xs\">Ciudad</Label>\n                            <Input id=\"city\" type=\"number\" min={1} max={50} placeholder=\"1-50\" value={city} onChange={(e) => setCity(e.target.value)} required />\n                        </div>\n                        <div className=\"space-y-1\">\n                            <Label htmlFor=\"district\" className=\"text-xs\">Barrio</Label>\n                            <Input id=\"district\" type=\"number\" min={1} max={50} placeholder=\"1-50\" value={district} onChange={(e) => setDistrict(e.target.value)} required />\n                        </div>\n                         <div className=\"space-y-1\">\n                            <Label htmlFor=\"building\" className=\"text-xs\">Edificio</Label>\n                            <Input id=\"building\" type=\"number\" min={1} max={255} placeholder=\"1-255\" value={building} onChange={(e) => setBuilding(e.target.value)} required />\n                        </div>\n                    </div>\n                )}\n\n                {error && (\n                    <Alert variant=\"destructive\" className=\"bg-destructive/20 border-destructive/50 text-destructive-foreground\">\n                        <Terminal className=\"h-4 w-4\" />\n                        <AlertTitle>Error</AlertTitle>\n                        <AlertDescription>{error}</AlertDescription>\n                    </Alert>\n                )}\n            </CardContent>\n            <CardFooter>\n                <Button type=\"submit\" variant=\"destructive\" className=\"w-full transition-all hover:scale-105\" disabled={isPending}>\n                    {isPending ? (\n                        <span className=\"flex items-center justify-center\">\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                            <span>Creando cuenta...</span>\n                        </span>\n                    ) : (\n                        <span>Confirmar y Entrar al Juego</span>\n                    )}\n                </Button>\n            </CardFooter>\n        </form>\n    );\n\n    return (\n        <Card className=\"w-full max-w-md bg-background/90 text-white border-white/10 backdrop-blur-md animate-fade-in shadow-lg shadow-primary/20\">\n           {isLoginView ? renderLogin() : renderRegister()}\n            <CardFooter className=\"flex-col gap-4 border-t pt-4\">\n                 <p className=\"text-xs text-center text-white/60\">\n                    {isLoginView ? '¿No tienes una cuenta?' : '¿Ya eres parte de la familia?'}\n                    <Button variant=\"link\" type=\"button\" size=\"sm\" className=\"p-0 h-auto ml-1 text-accent\" onClick={() => { setIsLoginView(!isLoginView); setError(''); }}>\n                         {isLoginView ? 'Regístrate aquí.' : 'Inicia sesión.'}\n                    </Button>\n                </p>\n            </CardFooter>\n        </Card>\n    );\n}\n",
    "src/app/(dashboard)/settings/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { SettingsView } from \"@/components/dashboard/settings-view\";\nimport { Card, CardContent, CardFooter, CardHeader } from \"@/components/ui/card\";\n\nfunction SettingsLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <Skeleton className=\"h-8 w-48 mb-4\" />\n            <Card>\n                <CardHeader>\n                    <Skeleton className=\"h-6 w-1/3\" />\n                    <Skeleton className=\"h-4 w-2/3\" />\n                </CardHeader>\n                <CardContent>\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                        <div className=\"space-y-4\">\n                            <div className=\"space-y-2\">\n                                <Skeleton className=\"h-4 w-20\" />\n                                <Skeleton className=\"h-10 w-full\" />\n                            </div>\n                            <div className=\"space-y-2\">\n                                <Skeleton className=\"h-4 w-20\" />\n                                <Skeleton className=\"h-10 w-full\" />\n                            </div>\n                        </div>\n                         <div className=\"space-y-4\">\n                            <div className=\"space-y-2\">\n                                <Skeleton className=\"h-4 w-20\" />\n                                <Skeleton className=\"h-10 w-full\" />\n                            </div>\n                            <div className=\"flex justify-center pt-2\">\n                                <Skeleton className=\"h-24 w-24 rounded-full\" />\n                            </div>\n                        </div>\n                    </div>\n                </CardContent>\n                <CardFooter>\n                    <Skeleton className=\"h-10 w-32\" />\n                </CardFooter>\n            </Card>\n        </div>\n    )\n}\n\n\nexport default async function SettingsPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<SettingsLoading />}>\n                <SettingsView user={user} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/messages/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { MessagesView } from \"@/components/dashboard/messages/messages-view\";\nimport { getNotificationFeedForUser, getUsers } from \"@/lib/data\";\n\nfunction MessagesLoading() {\n    return (\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n            <div className=\"col-span-1\">\n                <Skeleton className=\"h-12 w-full mb-2\" />\n                <Skeleton className=\"h-12 w-full mb-2\" />\n                <Skeleton className=\"h-12 w-full mb-2\" />\n                <Skeleton className=\"h-12 w-full\" />\n            </div>\n            <div className=\"md:col-span-3\">\n                <Skeleton className=\"h-96 w-full\" />\n            </div>\n        </div>\n    )\n}\n\n\nexport default async function MessagesPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const [initialFeed, allUsers] = await Promise.all([\n        getNotificationFeedForUser(user.id),\n        getUsers()\n    ]);\n    \n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<MessagesLoading />}>\n                <MessagesView \n                    currentUser={user}\n                    initialFeed={initialFeed} \n                    allUsers={allUsers}\n                />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/layout.tsx": "import { Suspense } from \"react\"\nimport { DashboardClientLayout } from \"@/components/dashboard/dashboard-client-layout\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { PropertyProvider } from \"@/contexts/property-context\";\nimport { StoreHydrator } from \"@/components/store-hydrator\";\nimport { actualizarEstadoCompletoDelJuego } from \"@/lib/actions/user.actions\";\nimport { getRoomConfigurations, getTroopConfigurations, getFamilyById } from \"@/lib/data\";\nimport { GameConfigProvider } from \"@/contexts/GameConfigContext\";\nimport { redirect } from \"next/navigation\";\nimport { UserWithProgress } from \"@/types\";\n\nasync function getInitialData(): Promise<{\n    user: UserWithProgress | null;\n    allRooms: any[];\n    allTroops: any[];\n}> {\n    let initialUser = await getSessionUser();\n    if (!initialUser) return { user: null, allRooms: [], allTroops: [] };\n\n    // This call was causing revalidation errors during render.\n    // The game state update logic should be triggered by explicit user actions, not on layout load.\n    await actualizarEstadoCompletoDelJuego(initialUser);\n\n    // Refetch the user data to get the freshest state after potential updates.\n    // We keep this in case the update logic is moved elsewhere but still want fresh data on load.\n    const finalUser = await getSessionUser();\n    \n    if (!finalUser) {\n        console.error(\"Failed to refetch user after game state update.\");\n        return { user: null, allRooms: [], allTroops: [] };\n    }\n\n    const [allRooms, allTroops] = await Promise.all([\n        getRoomConfigurations(),\n        getTroopConfigurations(),\n    ]);\n\n    // If the user has a family, ensure the full family data is loaded.\n    if (finalUser.familyMember?.familyId && (!finalUser.familyMember.family || !Array.isArray(finalUser.familyMember.family.members))) {\n        const familyData = await getFamilyById(finalUser.familyMember.familyId);\n        if (familyData) {\n            (finalUser.familyMember as any).family = familyData;\n        }\n    }\n\n    return { user: finalUser, allRooms, allTroops };\n}\n\nexport default async function DashboardLayout({\n    children,\n  }: {\n    children: React.ReactNode\n  }) {\n  \n  const { user: finalUser, allRooms, allTroops } = await getInitialData();\n\n  if (!finalUser) {\n    redirect('/login');\n  }\n\n  const sortedProperties = [...(finalUser.propiedades || [])].sort((a, b) => {\n    if (a.nombre === 'Propiedad Principal') return -1;\n    if (b.nombre === 'Propiedad Principal') return 1;\n    return 0;\n  }).map(p => ({\n    ...p,\n    armas: Number(p.armas),\n    municion: Number(p.municion),\n    alcohol: Number(p.alcohol),\n    dolares: Number(p.dolares),\n  }));\n\n\n  return (\n    <Suspense>\n      <GameConfigProvider value={{ allRooms, allTroops }}>\n        <Suspense fallback={<Skeleton className=\"h-screen w-full\" />}>\n          <PropertyProvider initialProperties={sortedProperties as any}>\n              <StoreHydrator user={finalUser} initialProperties={sortedProperties as any} />\n              <DashboardClientLayout user={finalUser}>\n                {(!finalUser.propiedades || finalUser.propiedades.length === 0) ? (\n                   <main id=\"main-content\" className=\"p-4 md:p-6\">\n                    <div className=\"flex flex-col items-center justify-center h-full text-center\">\n                      <h2 className=\"text-2xl font-bold\">Sin propiedades</h2>\n                      <p className=\"text-muted-foreground\">No tienes ninguna propiedad. ¡Tu imperio te espera!</p>\n                      <p className=\"text-sm mt-4\">Ve al panel de administración para asignarte una propiedad y empezar a jugar.</p>\n                    </div>\n                  </main>\n                ) : (\n                  <div className=\"pb-20 md:pb-0\">\n                    {children}\n                  </div>\n                )}\n              </DashboardClientLayout>\n          </PropertyProvider>\n        </Suspense>\n      </GameConfigProvider>\n    </Suspense>\n  )\n}\n",
    "src/app/(dashboard)/profile/page.tsx": "\nimport { createClient } from \"@/utils/supabase/server\";\nimport { redirect } from \"next/navigation\";\n\nexport default async function ProfilePage() {\n    const supabase = await createClient();\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (!user) {\n        redirect('/login');\n    }\n    \n    // Redirect from the generic /profile to the specific user's profile\n    redirect(`/profile/${user.id}`);\n}\n",
    "src/app/(dashboard)/profile/[userId]/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { getUserProfile, getUserResources, getUserActiveMissions } from \"@/lib/data\";\nimport { redirect } from \"next/navigation\";\nimport { ProfileView } from \"@/components/dashboard/profile/profile-view\";\n\nfunction ProfileLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center gap-6\">\n                <Skeleton className=\"h-24 w-24 rounded-full\" />\n                <div className=\"space-y-2\">\n                    <Skeleton className=\"h-8 w-48\" />\n                    <Skeleton className=\"h-4 w-32\" />\n                </div>\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <Skeleton className=\"h-48 w-full\" />\n                <Skeleton className=\"h-48 w-full\" />\n            </div>\n        </div>\n    );\n}\n\nexport default async function ProfilePage(props: { params: Promise<{ userId: string }> }) {\n    const params = await props.params;\n    const supabase = await createClient();\n    const { data: { user: sessionUser } } = await supabase.auth.getUser();\n\n    if (!sessionUser) {\n        redirect('/');\n    }\n\n    const [userProfile, resources, missions] = await Promise.all([\n        getUserProfile(params.userId),\n        getUserResources(params.userId),\n        getUserActiveMissions(params.userId)\n    ]);\n\n    if (!userProfile) {\n        return (\n            <div className=\"main-view\">\n                <h2 className=\"text-3xl font-bold tracking-tight\">Perfil no encontrado</h2>\n                <p>El jugador que buscas no existe o ha sido eliminado.</p>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<ProfileLoading />}>\n                <ProfileView\n                    user={userProfile}\n                    resources={resources}\n                    activeMissionsCount={missions.length}\n                />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/espionage/[reportId]/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getEspionageReportById } from \"@/lib/data\";\nimport { EspionageDetailView } from \"@/components/dashboard/espionage/espionage-detail-view\";\n\nfunction EspionageDetailLoading() {\n    return (\n        <div className=\"space-y-4 max-w-4xl mx-auto\">\n            <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n            <Skeleton className=\"h-4 w-80 shimmer\" />\n            <div className=\"border rounded-lg p-6 space-y-6\">\n                <div className=\"flex justify-around items-center\">\n                    <Skeleton className=\"h-20 w-20 rounded-full shimmer\" />\n                    <Skeleton className=\"h-10 w-16 shimmer\" />\n                    <Skeleton className=\"h-20 w-20 rounded-full shimmer\" />\n                </div>\n                <Skeleton className=\"h-24 w-full shimmer\" />\n                <Skeleton className=\"h-48 w-full shimmer\" />\n            </div>\n        </div>\n    );\n}\n\nexport default async function EspionageDetailPage(props: { params: Promise<{ reportId: string }>}) {\n    const params = await props.params;\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const report = await getEspionageReportById(params.reportId);\n\n    if (!report || (report.attackerId !== user.id && report.defenderId !== user.id)) {\n        return (\n            <div className=\"main-view text-center\">\n                <h2 className=\"text-3xl font-bold tracking-tight\">Informe no encontrado</h2>\n                <p className=\"text-muted-foreground\">\n                    El informe de espionaje que buscas no existe o no tienes permiso para verlo.\n                </p>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<EspionageDetailLoading />}>\n                <EspionageDetailView report={report} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/espionage/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getEspionageReportsForUser } from \"@/lib/data\";\nimport { EspionageListView } from \"@/components/dashboard/espionage/espionage-list-view\";\n\nfunction EspionageLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n                    <Skeleton className=\"h-4 w-80 shimmer\" />\n                </div>\n            </div>\n            <div className=\"border rounded-lg p-0\">\n                <div className=\"divide-y\">\n                    {[...Array(5)].map((_, i) => (\n                        <div key={i} className=\"p-4 flex items-center space-x-4\">\n                            <Skeleton className=\"h-10 w-10 rounded-full shimmer\" />\n                            <div className=\"space-y-2 flex-1\">\n                                <Skeleton className=\"h-4 w-3/4 shimmer\" />\n                                <Skeleton className=\"h-4 w-1/2 shimmer\" />\n                            </div>\n                            <Skeleton className=\"h-8 w-24 rounded-md shimmer\" />\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function EspionagePage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const reports = await getEspionageReportsForUser(user.id);\n    \n    return (\n        <div className=\"main-view\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Informes de Espionaje</h2>\n                    <p className=\"text-muted-foreground\">\n                        Revisa el historial de tus operaciones de inteligencia.\n                    </p>\n                </div>\n            </div>\n            <Suspense fallback={<EspionageLoading />}>\n                <EspionageListView initialReports={reports} currentUserId={user.id} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/map/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { MapView } from \"@/components/dashboard/map-view\";\nimport { getPropertiesByLocation } from \"@/lib/data\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\n\nfunction MapLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center gap-4\">\n                <Skeleton className=\"h-10 w-48 shimmer\" />\n                <Skeleton className=\"h-10 w-48 shimmer\" />\n            </div>\n            <Skeleton className=\"w-full aspect-square rounded-lg shimmer\" />\n        </div>\n    )\n}\n\nexport default async function MapPage(\n    props: {\n        searchParams?: Promise<{\n            ciudad?: string;\n            barrio?: string;\n        }>;\n    }\n) {\n    const searchParams = await props.searchParams;\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    // Si no hay params, usamos la ubicación de la primera propiedad del usuario\n    const initialCiudad = searchParams?.ciudad ? parseInt(searchParams.ciudad, 10) : user.propiedades?.[0]?.ciudad || 1;\n    const initialBarrio = searchParams?.barrio ? parseInt(searchParams.barrio, 10) : user.propiedades?.[0]?.barrio || 1;\n\n    const properties = await getPropertiesByLocation(initialCiudad, initialBarrio);\n\n    return (\n        <div className=\"main-view\">\n            <h2 className=\"text-3xl font-bold tracking-tight mb-4\">Mapa de la Ciudad</h2>\n            <Suspense fallback={<MapLoading />}>\n                <MapView \n                    ciudad={initialCiudad} \n                    barrio={initialBarrio} \n                    properties={properties} \n                    currentUser={user}\n                />\n            </Suspense>\n        </div>\n    );\n}\n\n",
    "src/app/(dashboard)/rooms/page.tsx": "import { getSessionUser } from \"@/lib/auth\"\nimport { redirect } from \"next/navigation\"\n\nexport default async function RoomsPage() {\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/');\n  }\n\n  // Si el usuario no tiene propiedades, lo enviamos al overview.\n  // La página de detalles ya se encarga de seleccionar la principal si no hay ID.\n  if (!user.propiedades || user.propiedades.length === 0) {\n      redirect('/overview');\n  }\n\n  // Simplemente redirige a la página de detalles.\n  // El componente `details/page.tsx` ya tiene la lógica para\n  // seleccionar la propiedad principal si no se proporciona ninguna en la URL.\n  // Esto preservará el `propertyId` si ya existe en los searchParams.\n  redirect(`/rooms/details`);\n}\n",
    "src/app/(dashboard)/rooms/details/page.tsx": "import { RoomsView } from \"@/components/dashboard/rooms-view\"\nimport { Suspense } from \"react\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport { getSessionUser } from \"@/lib/auth\"\nimport { getRoomConfigurations } from \"@/lib/data\"\nimport { redirect } from \"next/navigation\"\n\nfunction RoomsLoading() {\n    return (\n      <div className=\"space-y-8\">\n        <div className=\"border-b border-white/10 pb-4\">\n            <Skeleton className=\"h-10 w-64 mb-2 shimmer bg-zinc-800\" />\n            <Skeleton className=\"h-4 w-96 shimmer bg-zinc-800/50\" />\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n            {[...Array(6)].map((_, i) => (\n                <div key={i} className=\"rounded-xl border border-zinc-800 bg-card overflow-hidden h-[400px]\">\n                    <Skeleton className=\"h-48 w-full shimmer bg-zinc-900\" />\n                    <div className=\"p-4 space-y-4\">\n                        <Skeleton className=\"h-4 w-3/4 shimmer bg-zinc-800\" />\n                        <div className=\"grid grid-cols-3 gap-2\">\n                             <Skeleton className=\"h-12 w-full shimmer bg-zinc-900\" />\n                             <Skeleton className=\"h-12 w-full shimmer bg-zinc-900\" />\n                             <Skeleton className=\"h-12 w-full shimmer bg-zinc-900\" />\n                        </div>\n                        <div className=\"flex gap-2 pt-2\">\n                            <Skeleton className=\"h-10 w-10 shimmer bg-zinc-800\" />\n                            <Skeleton className=\"h-10 flex-1 shimmer bg-zinc-800\" />\n                        </div>\n                    </div>\n                </div>\n            ))}\n        </div>\n      </div>\n    )\n}\n\nexport default async function RoomsByPropertyIdPage(\n    props: { searchParams: Promise<{ propertyId?: string }> }\n) {\n  const searchParams = (await props.searchParams);\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/');\n  }\n\n  const allRoomConfigs = await getRoomConfigurations();\n\n  if (!user.propiedades || user.propiedades.length === 0) {\n    return (\n      <div className=\"main-view\">\n         <h2 className=\"text-3xl font-bold tracking-tight\">Gestión de Habitaciones</h2>\n         <p>No tienes propiedades para gestionar.</p>\n      </div>\n    )\n  }\n\n  const propertyId = searchParams.propertyId;\n  const property = user.propiedades.find(p => p.id === propertyId);\n  \n  if (!property && user.propiedades.length > 0) {\n    const mainProperty = user.propiedades.find(p => p.nombre === 'Propiedad Principal') || user.propiedades[0];\n    redirect(`/rooms/details?propertyId=${mainProperty.id}`);\n  }\n\n  return (\n    <div className=\"main-view\">\n      <Suspense fallback={<RoomsLoading />}>\n          <RoomsView \n            user={user} \n            allRoomConfigs={allRoomConfigs} \n            initialProperty={property}\n          />\n      </Suspense>\n    </div>\n  )\n}\n",
    "src/app/(dashboard)/vision/global/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { GlobalVisionView } from \"@/components/dashboard/vision/global-view\";\n\nfunction GlobalVisionLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-2\">\n                    <Skeleton className=\"h-8 w-64\" />\n                    <Skeleton className=\"h-4 w-80\" />\n                </div>\n            </div>\n            <Skeleton className=\"h-48 w-full\" />\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Skeleton className=\"h-64 w-full\" />\n                <Skeleton className=\"h-64 w-full\" />\n            </div>\n        </div>\n    );\n}\n\n\nexport default async function GlobalVisionPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/login');\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<GlobalVisionLoading />}>\n                <GlobalVisionView user={user} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/security/page.tsx": "\n\nimport { SecurityView } from \"@/components/dashboard/security-view\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getTroopConfigurations } from \"@/lib/data\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { calcularStatsTropa } from \"@/lib/formulas/troop-formulas\";\nimport { SECURITY_TROOP_ORDER, TROOP_TYPE_DEFENSE } from \"@/lib/constants\";\nimport type { UserWithProgress } from \"@/types\";\n\nfunction SecurityLoading() {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n            <Skeleton className=\"h-4 w-80 shimmer\" />\n          </div>\n        </div>\n        <Skeleton className=\"h-24 w-full\" />\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {[...Array(3)].map((_, i) => (\n                <Skeleton key={i} className=\"h-64 w-full shimmer\" />\n            ))}\n        </div>\n      </div>\n    )\n}\n\nexport default async function SecurityPage() {\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/');\n  }\n\n  const troopConfigs = await getTroopConfigurations();\n  \n  const defenseTroops = troopConfigs.filter(t => t.tipo === TROOP_TYPE_DEFENSE);\n\n  const sortedDefenseTroops = [...defenseTroops].sort((a, b) => {\n    const indexA = SECURITY_TROOP_ORDER.indexOf(a.id);\n    const indexB = SECURITY_TROOP_ORDER.indexOf(b.id);\n    if (indexA === -1) return 1;\n    if (indexB === -1) return -1;\n    return indexA - indexB;\n  });\n\n  // Transformar el array de entrenamientos a un objeto de niveles\n  const nivelesUsuario = user.entrenamientos.reduce((acc, t) => {\n      acc[t.configuracionEntrenamientoId] = t.nivel;\n      return acc;\n  }, {} as Record<string, number>);\n\n  const troopsWithStats = sortedDefenseTroops.map(config => {\n      const { ataqueActual, defensaActual, capacidadActual, velocidadActual, salarioActual } = calcularStatsTropa(config, nivelesUsuario);\n      return {\n          ...config,\n          ataqueActual,\n          defensaActual,\n          capacidadActual,\n          velocidadActual,\n          salarioActual,\n      }\n  })\n\n  return (\n    <div className=\"main-view\">\n      <Suspense fallback={<SecurityLoading />}>\n          <SecurityView user={user} defenseTroops={troopsWithStats} />\n      </Suspense>\n    </div>\n  )\n}\n",
    "src/app/(dashboard)/overview/page.tsx": "'use server';\n\nimport { Suspense } from \"react\";\nimport OverviewView from \"@/components/dashboard/overview-view\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nfunction OverviewLoading() {\n    return (\n         <div className=\"main-view h-full\">\n            <div className=\"flex-grow space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n                    <Skeleton className=\"h-64 w-full rounded-lg\" />\n                    <Skeleton className=\"h-64 lg:col-span-2 w-full rounded-lg\" />\n                    <Skeleton className=\"h-64 w-full rounded-lg\" />\n                </div>\n                <Skeleton className=\"h-[74px] w-full rounded-lg\" />\n            </div>\n        </div>\n    )\n}\n\nexport default async function OverviewPage() {\n    return (\n        <Suspense fallback={<OverviewLoading />}>\n            <OverviewView />\n        </Suspense>\n    );\n}\n",
    "src/app/(dashboard)/simulator/loading.tsx": "import { Skeleton } from \"@/components/ui/skeleton\";\n\nexport default function SimulatorLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-8 w-48 mb-4\" />\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <Skeleton className=\"h-96 w-full\" />\n                <Skeleton className=\"h-96 w-full\" />\n            </div>\n            <Skeleton className=\"h-10 w-full mt-4\" />\n        </div>\n    )\n}\n",
    "src/app/(dashboard)/simulator/page.tsx": "import { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getTroopConfigurations, getTrainingConfigurations, getRoomConfigurations } from \"@/lib/data/config\";\nimport SimulatorPageClient from \"./page-client\";\n\nexport default async function SimulatorPage() {\n    const sessionUser = await getSessionUser();\n    if (!sessionUser) {\n        redirect('/');\n    }\n\n    const [troops, trainings, rooms] = await Promise.all([\n        getTroopConfigurations(),\n        getTrainingConfigurations(),\n        getRoomConfigurations()\n    ]);\n\n    const defenseConfigs = rooms.filter(r =>\n        ['seguridad', 'torreta_de_fuego_automatico', 'minas_ocultas'].includes(r.id)\n    );\n\n    return (\n        <SimulatorPageClient\n            user={sessionUser}\n            troopConfigs={troops}\n            trainingConfigs={trainings}\n            defenseConfigs={defenseConfigs}\n        />\n    );\n}\n",
    "src/app/(dashboard)/simulator/page-client.tsx": "'use client';\n\nimport React, { useState } from \"react\";\nimport { SimulatorView } from \"@/components/dashboard/simulator-view\";\nimport { BattleReportDisplay } from \"@/components/dashboard/brawls/battle-report-display\";\nimport type { BattleSimulationResult } from '@/types/simulation.types';\nimport type { UserWithProgress, FullConfiguracionTropa, FullConfiguracionEntrenamiento, FullConfiguracionHabitacion } from \"@/types\";\n\ninterface SimulatorPageClientProps {\n    user: UserWithProgress;\n    troopConfigs: FullConfiguracionTropa[];\n    trainingConfigs: FullConfiguracionEntrenamiento[];\n    defenseConfigs: FullConfiguracionHabitacion[];\n}\n\nexport default function SimulatorPageClient({\n    user,\n    troopConfigs,\n    trainingConfigs,\n    defenseConfigs\n}: SimulatorPageClientProps) {\n    const [battleReport, setBattleReport] = useState<BattleSimulationResult | null>(null);\n\n    return (\n        <div className=\"main-view\">\n            <SimulatorView\n                user={user}\n                troopConfigs={troopConfigs}\n                trainingConfigs={trainingConfigs}\n                defenseConfigs={defenseConfigs}\n                onSimulationComplete={setBattleReport}\n            />\n            {battleReport && <BattleReportDisplay report={battleReport} />}\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/family/global/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getFamilyByIdWithAllMembersData } from \"@/lib/data\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { FamilyGlobalView } from \"@/components/dashboard/family/family-global-view\";\nimport { FullFamily } from \"@/types\";\n\nfunction GlobalViewLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center\">\n                 <Skeleton className=\"h-10 w-48\" />\n                 <Skeleton className=\"h-10 w-32\" />\n            </div>\n            <div className=\"border rounded-lg overflow-hidden\">\n                <Skeleton className=\"h-96 w-full\" />\n            </div>\n        </div>\n    );\n}\n\n\nexport default async function FamilyGlobalViewPage() {\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) {\n        redirect('/family');\n    }\n\n    const familyWithDetails = await getFamilyByIdWithAllMembersData(user.familyMember.familyId);\n\n    if (!familyWithDetails) {\n        return <p>Familia no encontrada.</p>;\n    }\n    \n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<GlobalViewLoading />}>\n                <FamilyGlobalView family={familyWithDetails as FullFamily} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/family/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { CreateOrJoinFamilyView } from \"@/components/dashboard/family/create-or-join-family-view\";\nimport { FamilyDashboardView } from \"@/components/dashboard/family/family-dashboard-view\";\nimport { getFamilyById, getFamilyRequests, getUsers } from \"@/lib/data\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nfunction FamilyLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <Skeleton className=\"h-48 w-full\" />\n            <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                <Skeleton className=\"h-64 lg:col-span-2 w-full\" />\n                <Skeleton className=\"h-48 w-full\" />\n            </div>\n        </div>\n    )\n}\n\nexport default async function FamilyPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    if (user.familyMember && user.familyMember.familyId) {\n         const [family, allUsers, requests] = await Promise.all([\n            getFamilyById(user.familyMember.familyId),\n            getUsers(),\n            getFamilyRequests(user.familyMember.familyId)\n         ]);\n\n        if (family) {\n             return (\n                <Suspense fallback={<FamilyLoading />}>\n                    <FamilyDashboardView \n                        family={family} \n                        currentUser={user} \n                        allUsers={allUsers}\n                        pendingRequests={requests.length}\n                    />\n                </Suspense>\n            );\n        }\n    }\n\n    // If not in a family, show the create/join view\n    return (\n        <Suspense fallback={<FamilyLoading />}>\n            <CreateOrJoinFamilyView />\n        </Suspense>\n    )\n}\n",
    "src/app/(dashboard)/family/requests/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getFamilyRequests } from \"@/lib/data\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { FamilyRequestsView } from \"@/components/dashboard/family/family-requests-view\";\nimport { FamilyRole } from \"@/types\";\n\nfunction RequestsLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full bg-muted/80\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function FamilyRequestsPage() {\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) {\n        redirect('/family');\n    }\n\n    const canManage = user.familyMember.role === FamilyRole.LEADER || user.familyMember.role === FamilyRole.CO_LEADER;\n    if (!canManage) {\n        redirect('/family');\n    }\n\n    const requests = await getFamilyRequests(user.familyMember.familyId);\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<RequestsLoading />}>\n                <FamilyRequestsView requests={requests} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/family/members/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getFamilyById } from \"@/lib/data\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { FamilyMembersView } from \"@/components/dashboard/family/family-members-view\";\n\nfunction MembersLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-48\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full bg-muted/80\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function FamilyMembersPage(\n    props: {\n        searchParams: Promise<{ id?: string }>;\n    }\n) {\n    const searchParams = await props.searchParams;\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const familyId = searchParams.id;\n    if (!familyId) {\n        // Redirect to main family page if no ID is provided\n        redirect('/family');\n    }\n\n    const family = await getFamilyById(familyId);\n\n    if (!family) {\n        return <p>Familia no encontrada.</p>;\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<MembersLoading />}>\n                <FamilyMembersView family={family} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/family/find/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getFamiliesForRanking, getInvitationsForUser } from \"@/lib/data\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { FindFamilyView } from \"@/components/dashboard/family/find-family-view\";\n\nfunction FindFamilyLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-10 w-full max-w-md\" />\n            <div className=\"border rounded-md\">\n                <Skeleton className=\"h-12 w-full bg-muted/80\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function FindFamilyPage() {\n    const user = await getSessionUser();\n    if (!user) redirect('/');\n    if (user.familyMember) redirect('/family'); // Already in a family\n\n    const [families, userInvitations] = await Promise.all([\n        getFamiliesForRanking(0, 50),\n        getInvitationsForUser(user.id)\n    ]);\n\n    return (\n        <div className=\"main-view\">\n             <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Buscar Familia</h2>\n                    <p className=\"text-muted-foreground\">\n                       Encuentra una nueva familia a la que unirte o responde a tus invitaciones.\n                    </p>\n                </div>\n            </div>\n            <Suspense fallback={<FindFamilyLoading />}>\n                <FindFamilyView \n                    families={families} \n                    userInvitations={userInvitations}\n                    currentUserId={user.id}\n                />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/family/management/page.tsx": "\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getFamilyById } from \"@/lib/data\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { FamilyManagementView } from \"@/components/dashboard/family/family-management-view\";\nimport { FamilyRole } from \"@/types\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\n\nfunction ManagementLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex justify-between items-center\">\n                <Skeleton className=\"h-10 w-64\" />\n                <Skeleton className=\"h-10 w-32\" />\n            </div>\n            <Skeleton className=\"h-24 w-full\" />\n            <Card>\n                <CardHeader>\n                    <Skeleton className=\"h-8 w-48\" />\n                </CardHeader>\n                <CardContent>\n                     <div className=\"border rounded-md\">\n                        <Skeleton className=\"h-12 w-full bg-muted/80\" />\n                        <div className=\"p-4 space-y-3\">\n                            <Skeleton className=\"h-10 w-full\" />\n                            <Skeleton className=\"h-10 w-full\" />\n                        </div>\n                    </div>\n                </CardContent>\n            </Card>\n        </div>\n    );\n}\n\nexport default async function FamilyManagementPage() {\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) {\n        redirect('/family');\n    }\n\n    const isLeader = user.familyMember.role === FamilyRole.LEADER;\n    if (!isLeader) {\n        redirect('/family');\n    }\n\n    const family = await getFamilyById(user.familyMember.familyId);\n\n    if (!family) {\n        redirect('/family');\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<ManagementLoading />}>\n                <FamilyManagementView family={family} currentUserId={user.id} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/training/page.tsx": "\nimport { TrainingView } from \"@/components/dashboard/training-view\"\nimport { Suspense } from \"react\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport { getSessionUser } from \"@/lib/auth\"\nimport { redirect } from \"next/navigation\"\nimport { getTrainingConfigurations } from \"@/lib/data\"\nimport { calcularCostosEntrenamiento, calcularTiempoEntrenamiento } from \"@/lib/formulas/training-formulas\"\nimport { ID_ESCUELA_ESPECIALIZACION, TRAINING_ORDER } from \"@/lib/constants\"\n\nfunction TrainingLoading() {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n            <Skeleton className=\"h-4 w-80 shimmer\" />\n          </div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4\">\n            {[...Array(9)].map((_, i) => (\n                <Skeleton key={i} className=\"h-48 w-full shimmer\" />\n            ))}\n        </div>\n      </div>\n    )\n  }\n\nexport default async function TrainingPage() {\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/');\n  }\n\n  const allTrainingConfigs = await getTrainingConfigurations();\n\n  // Pre-calculate data on the server\n  const userTrainingsMap = new Map(user.entrenamientos.map(t => [t.configuracionEntrenamientoId, t.nivel]));\n  \n  const allUserRooms = user.propiedades?.flatMap(p => p.habitaciones || []) || [];\n  const escuelaRoom = allUserRooms.find(h => h && h.configuracionHabitacionId === ID_ESCUELA_ESPECIALIZACION);\n  const nivelEscuela = escuelaRoom?.nivel || 0;\n  \n  const sortedTrainingsData = TRAINING_ORDER.map(id => {\n      const config = allTrainingConfigs.find(c => c.id === id);\n      if (!config) return null;\n\n      const userTraining = userTrainingsMap.get(id);\n      const nivel = userTraining || 0;\n      \n      const costosSiguienteNivel = calcularCostosEntrenamiento(nivel + 1, config);\n      const tiempoSiguienteNivel = calcularTiempoEntrenamiento(nivel + 1, config, nivelEscuela);\n      \n      const requisitos = config.requisitos || [];\n      const meetsRequirements = requisitos.every(req => (userTrainingsMap.get(req.requiredTrainingId) || 0) >= req.requiredLevel);\n      const requirementsText = !meetsRequirements \n        ? requisitos\n            .map(req => {\n                const reqConfig = allTrainingConfigs.find(c => c.id === req.requiredTrainingId);\n                return `${reqConfig?.nombre || req.requiredTrainingId} (Nvl ${req.requiredLevel})`\n            })\n            .join(', ')\n        : null;\n\n\n      return {\n          ...config,\n          nivel,\n          costos: costosSiguienteNivel,\n          tiempo: tiempoSiguienteNivel,\n          meetsRequirements,\n          requirementsText\n      };\n  }).filter((t): t is NonNullable<typeof t> => t !== null);\n\n\n  return (\n    <div className=\"main-view\">\n      <Suspense fallback={<TrainingLoading />}>\n          <TrainingView user={user} trainingsData={sortedTrainingsData} />\n      </Suspense>\n    </div>\n  );\n}\n",
    "src/app/(dashboard)/statistics/page.tsx": "import { getGlobalStatistics, getMaximumResourceCapacity } from \"@/lib/data\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { StatisticsView } from \"@/components/dashboard/statistics/statistics-view\";\n\nfunction StatisticsLoading() {\n    return (\n        <div className=\"space-y-6\">\n             <div className=\"flex items-center justify-between\">\n                <div>\n                    <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n                    <Skeleton className=\"h-4 w-80 shimmer\" />\n                </div>\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <Skeleton className=\"h-64 w-full shimmer\" />\n                <Skeleton className=\"h-64 w-full shimmer\" />\n                <Skeleton className=\"h-64 w-full shimmer\" />\n                <Skeleton className=\"h-64 w-full shimmer\" />\n            </div>\n        </div>\n    )\n}\n\nexport default async function StatisticsPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const [\n        globalStats,\n        rawResourceStats\n    ] = await Promise.all([\n        getGlobalStatistics(),\n        getMaximumResourceCapacity()\n    ]);\n    \n    const { \n        allRoomConfigs, \n        allTrainingConfigs, \n        allTroopConfigs, \n        roomStats, \n        trainingStats, \n        troopStats: rawTroopStats \n    } = globalStats;\n    \n    // --- CORRECCIÓN DE TIPOS ---\n\n    // 1. Transformar ResourceStats: de Objeto a Array si es necesario\n    // El error indica que rawResourceStats viene como objeto { armas: number, ... }\n    const resourceStats = Array.isArray(rawResourceStats) \n        ? rawResourceStats \n        : [\n            { name: 'Armas', maxValue: (rawResourceStats as any).armas || 0 },\n            { name: 'Munición', maxValue: (rawResourceStats as any).municion || 0 },\n            { name: 'Alcohol', maxValue: (rawResourceStats as any).alcohol || 0 },\n            { name: 'Dólares', maxValue: (rawResourceStats as any).dolares || 0 },\n        ];\n\n    // 2. Transformar TroopStats: mapear max_amount a maxAmount\n    // El error indica que viene con 'max_amount' pero el componente espera 'maxAmount'\n    const troopStats = rawTroopStats.map((stat: any) => ({\n        configuracionTropaId: stat.configuracionTropaId,\n        maxAmount: stat.maxAmount ?? stat.max_amount ?? 0\n    }));\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<StatisticsLoading />}>\n                <StatisticsView \n                    currentUser={user}\n                    allRoomConfigs={allRoomConfigs}\n                    allTrainingConfigs={allTrainingConfigs}\n                    allTroopConfigs={allTroopConfigs}\n                    roomStats={roomStats}\n                    trainingStats={trainingStats}\n                    troopStats={troopStats}\n                    resourceStats={resourceStats}\n                />\n            </Suspense>\n        </div>\n    );\n}",
    "src/app/(dashboard)/brawls/[reportId]/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getBattleReportById } from \"@/lib/data\";\nimport { BrawlDetail } from \"@/components/dashboard/brawls/brawl-detail\";\n\nfunction BrawlDetailLoading() {\n    return (\n        <div className=\"space-y-4 max-w-4xl mx-auto\">\n            <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n            <Skeleton className=\"h-4 w-80 shimmer\" />\n            <div className=\"border rounded-lg p-6 space-y-6\">\n                <div className=\"flex justify-around items-center\">\n                    <Skeleton className=\"h-20 w-20 rounded-full shimmer\" />\n                    <Skeleton className=\"h-10 w-16 shimmer\" />\n                    <Skeleton className=\"h-20 w-20 rounded-full shimmer\" />\n                </div>\n                <Skeleton className=\"h-24 w-full shimmer\" />\n                <Skeleton className=\"h-48 w-full shimmer\" />\n            </div>\n        </div>\n    );\n}\n\nexport default async function BrawlDetailPage(props: { params: Promise<{ reportId: string }>}) {\n    const params = await props.params;\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const report = await getBattleReportById(params.reportId);\n\n    if (!report || (report.attackerId !== user.id && report.defenderId !== user.id)) {\n        return (\n            <div className=\"main-view text-center\">\n                <h2 className=\"text-3xl font-bold tracking-tight\">Informe no encontrado</h2>\n                <p className=\"text-muted-foreground\">\n                    El informe de batalla que buscas no existe o no tienes permiso para verlo.\n                </p>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<BrawlDetailLoading />}>\n                <BrawlDetail report={report} currentUserId={user.id} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/brawls/page.tsx": "import { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { getBattleReportsForUser } from \"@/lib/data\";\nimport { BrawlsView } from \"@/components/dashboard/brawls/brawls-view\";\n\nfunction BrawlsLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n                    <Skeleton className=\"h-4 w-80 shimmer\" />\n                </div>\n            </div>\n            <div className=\"border rounded-lg p-0\">\n                <div className=\"divide-y\">\n                    {[...Array(5)].map((_, i) => (\n                        <div key={i} className=\"p-4 flex items-center space-x-4\">\n                            <Skeleton className=\"h-10 w-10 rounded-full shimmer\" />\n                            <div className=\"space-y-2 flex-1\">\n                                <Skeleton className=\"h-4 w-3/4 shimmer\" />\n                                <Skeleton className=\"h-4 w-1/2 shimmer\" />\n                            </div>\n                            <Skeleton className=\"h-8 w-24 rounded-md shimmer\" />\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function BrawlsPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const reports = await getBattleReportsForUser(user.id);\n    \n    return (\n        <div className=\"main-view\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Informes de Batalla</h2>\n                    <p className=\"text-muted-foreground\">\n                        Revisa el historial de tus enfrentamientos.\n                    </p>\n                </div>\n            </div>\n            <Suspense fallback={<BrawlsLoading />}>\n                <BrawlsView initialReports={reports} currentUserId={user.id} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/recruitment/page.tsx": "import { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\n\nexport default async function RecruitmentRedirectPage() {\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/');\n  }\n\n  if (!user.propiedades || user.propiedades.length === 0) {\n      redirect('/overview');\n  }\n\n  // Simplemente redirige a la página de detalles.\n  // El componente 'details/page.tsx' se encargará de seleccionar\n  // la propiedad principal si no hay ninguna en la URL, preservando\n  // la selección actual si existe.\n  redirect(`/recruitment/details`);\n}\n",
    "src/app/(dashboard)/recruitment/details/page.tsx": "'use server';\n\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { RecruitmentView } from \"@/components/dashboard/recruitment-view\";\nimport { getTroopConfigurations, getUserTrainings } from \"@/lib/data\";\nimport { calcularStatsTropa } from \"@/lib/formulas/troop-formulas\";\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\nfunction RecruitmentLoading() {\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n          <Skeleton className=\"h-4 w-80 shimmer\" />\n        </div>\n      </div>\n      <Skeleton className=\"h-24 w-full\" />\n      <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n          {[...Array(6)].map((_, i) => (\n              <Skeleton key={i} className=\"h-[320px] w-full rounded-xl\" />\n          ))}\n      </div>\n    </div>\n  )\n}\n\nexport default async function RecruitmentPage(\n    props: { searchParams: Promise<{ propertyId?: string }> }\n) {\n  const searchParams = (await props.searchParams);\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/login');\n  }\n\n  if (!user.propiedades || user.propiedades.length === 0) {\n    return (\n      <div className=\"main-view\">\n         <h2 className=\"text-3xl font-bold tracking-tight\">Reclutamiento</h2>\n         <Card>\n            <CardContent className=\"p-6 text-muted-foreground\">\n                <p>No tienes propiedades para reclutar tropas.</p>\n            </CardContent>\n         </Card>\n      </div>\n    )\n  }\n\n  const propertyId = searchParams.propertyId;\n  const property = user.propiedades.find(p => p.id === propertyId);\n  \n  if (!property && user.propiedades.length > 0) {\n    const mainProperty = user.propiedades.find(p => p.nombre === 'Propiedad Principal') || user.propiedades[0];\n    redirect(`/recruitment/details?propertyId=${mainProperty.id}`);\n  }\n  \n  if (!property) {\n      return <RecruitmentLoading />; // Should be redirected, but as a fallback\n  }\n\n  const [configsTropa, userTrainings] = await Promise.all([\n    getTroopConfigurations(),\n    getUserTrainings(user.id)\n  ]);\n\n  // Calculate real stats\n  const nivelesUsuario = userTrainings.reduce((acc, curr) => ({...acc, [curr.configuracionEntrenamientoId]: curr.nivel}), {} as Record<string, number>);\n\n  const tropasConStatsReales = configsTropa.map(tropa => {\n      const statsCalculadas = calcularStatsTropa(tropa, nivelesUsuario);\n\n      return {\n          ...tropa,\n          ...statsCalculadas // Merge calculated stats\n      };\n  });\n\n  return (\n    <div className=\"main-view\">\n      <Suspense fallback={<RecruitmentLoading />}>\n        <RecruitmentView\n          user={user}\n          troopConfigs={tropasConStatsReales}\n          selectedProperty={property}\n        />\n      </Suspense>\n    </div>\n  );\n}\n",
    "src/app/(dashboard)/buildings/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { BuildingsView } from \"@/components/dashboard/buildings/buildings-view\";\nimport { calcularPuntosPropiedad } from \"@/lib/formulas/score-formulas\";\n\nfunction BuildingsLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n                    <Skeleton className=\"h-4 w-80 shimmer\" />\n                </div>\n            </div>\n            <div className=\"border rounded-lg p-0\">\n                <div className=\"h-12 w-full bg-muted/50 rounded-t-lg\" />\n                <div className=\"p-4 space-y-3\">\n                    <Skeleton className=\"h-10 w-full\" />\n                    <Skeleton className=\"h-10 w-full\" />\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function BuildingsPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const propertiesWithPoints = user.propiedades.map(prop => ({\n        ...prop,\n        puntos: calcularPuntosPropiedad(prop)\n    }));\n    \n    return (\n        <div className=\"main-view\">\n             <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Gestión de Edificios</h2>\n                    <p className=\"text-muted-foreground\">\n                        Administra los nombres y la propiedad principal de tu imperio.\n                    </p>\n                </div>\n            </div>\n            <Suspense fallback={<BuildingsLoading />}>\n                <BuildingsView initialProperties={propertiesWithPoints} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/search/page.tsx": "\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport default function SearchPage() {\n  return (\n    <div className=\"main-view\">\n      <h2 className=\"text-3xl font-bold tracking-tight\">Buscar</h2>\n      <Card>\n        <CardHeader>\n          <CardTitle>Búsqueda Avanzada</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p>Próximamente: Aquí podrás buscar jugadores, familias y coordenadas.</p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
    "src/app/(dashboard)/resources/page.tsx": "\n\nimport { ResourcesView } from \"@/components/dashboard/resources-view\"\nimport { getSessionUser } from \"@/lib/auth\";\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport { redirect } from \"next/navigation\";\nimport { Suspense } from \"react\"\n\nfunction ResourcesLoading() {\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n          <Skeleton className=\"h-4 w-80 shimmer\" />\n        </div>\n      </div>\n       <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <Skeleton className=\"h-64 w-full shimmer\" />\n            <Skeleton className=\"h-64 w-full shimmer\" />\n            <Skeleton className=\"h-64 w-full shimmer\" />\n            <Skeleton className=\"h-64 w-full shimmer\" />\n        </div>\n    </div>\n  )\n}\n\nexport default async function ResourcesPage() {\n  const user = await getSessionUser();\n  if (!user) {\n    redirect('/');\n  }\n\n  return (\n    <div className=\"main-view\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n            <h2 className=\"text-3xl font-bold tracking-tight\">Análisis de Recursos</h2>\n            <p className=\"text-muted-foreground\">\n                Visualiza la producción y proyección de tus recursos.\n            </p>\n        </div>\n      </div>\n      <Suspense fallback={<ResourcesLoading />}>\n        <ResourcesView />\n      </Suspense>\n    </div>\n  )\n}\n",
    "src/app/(dashboard)/rankings/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getFamiliesForRanking, getUsersForRanking, getUsersForHonorRanking, getRecentBattleReports } from \"@/lib/data\";\nimport { PlayerRankingsView } from \"@/components/dashboard/rankings/player-rankings-view\";\nimport { RankingTypeSelector } from \"@/components/dashboard/rankings/ranking-type-selector\";\nimport { FamilyRankingsView } from \"@/components/dashboard/rankings/family-rankings-view\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { HonorRankingsView } from \"@/components/dashboard/rankings/honor-rankings-view\";\nimport { BattlesRankingsView } from \"@/components/dashboard/rankings/battles-rankings-view\";\n\nfunction RankingsLoading() {\n    return (\n        <div className=\"space-y-4 animate-pulse\">\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-between sm:items-center\">\n                <Skeleton className=\"h-8 w-48\" />\n                <Skeleton className=\"h-24 w-full\" />\n            </div>\n            <div className=\"rounded-lg border\">\n                <div className=\"w-full h-12 bg-muted/80 rounded-t-lg\" />\n                <div className=\"p-4 space-y-2\">\n                    {[...Array(10)].map((_, i) => (\n                        <Skeleton key={i} className=\"h-10 w-full shimmer\" />\n                    ))}\n                </div>\n            </div>\n        </div>\n    )\n}\n\nconst PAGE_SIZE = 100;\n\nexport default async function RankingsPage(\n    props: {\n        searchParams?: Promise<{ type?: string, range?: string }>\n    }\n) {\n    const searchParams = await props.searchParams;\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const rankingType = searchParams?.type || '0';\n    const range = parseInt(searchParams?.range || '0', 10);\n    const skip = range * PAGE_SIZE;\n\n    const users = rankingType === '0' ? await getUsersForRanking(skip, PAGE_SIZE) : [];\n    const families = rankingType === '1' ? await getFamiliesForRanking(skip, PAGE_SIZE) : [];\n    const honorUsers = rankingType === '2' ? await getUsersForHonorRanking(skip, PAGE_SIZE) : [];\n    \n    // Fix: Pass current user ID to getRecentBattleReports\n    const recentBattles = rankingType === '3' ? await getRecentBattleReports(user.id) : [];\n\n    return (\n        <div className=\"main-view\">\n            <div className=\"flex flex-col sm:flex-row gap-4 justify-between sm:items-center\">\n              <h2 className=\"text-3xl font-bold tracking-tight\">Clasificaciones</h2>\n            </div>\n             <div className=\"mt-4\">\n                 <RankingTypeSelector />\n            </div>\n            <Suspense fallback={<RankingsLoading />}>\n                {rankingType === '0' && <PlayerRankingsView users={users} currentUserId={user.id} page={range} pageSize={PAGE_SIZE} />}\n                {rankingType === '1' && <FamilyRankingsView families={families} currentUserFamilyId={user.familyMember?.familyId} page={range} pageSize={PAGE_SIZE} />}\n                {rankingType === '2' && <HonorRankingsView users={honorUsers} currentUserId={user.id} page={range} pageSize={PAGE_SIZE} />}\n                {rankingType === '3' && <BattlesRankingsView reports={recentBattles} currentUserId={user.id} />}\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/missions/page.tsx": "'use server';\nimport { redirect } from \"next/navigation\";\n\n// This page now simply redirects to the canonical details page.\nexport default async function MissionsPage() {\n    redirect('/missions/details');\n}\n",
    "src/app/(dashboard)/missions/details/page.tsx": "'use server';\nimport { Suspense } from \"react\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { MissionDetailsView } from \"@/components/dashboard/missions/mission-details-view\";\nimport { getTroopConfigurations } from \"@/lib/data\";\nimport { Button } from \"@/components/ui/button\";\nimport { PlusCircle } from \"lucide-react\";\nimport Link from \"next/link\";\n\nfunction MissionDetailsLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n                    <Skeleton className=\"h-4 w-80 shimmer\" />\n                </div>\n                <Skeleton className=\"h-10 w-36\" />\n            </div>\n            <Skeleton className=\"h-10 w-full\" />\n            <div className=\"border rounded-lg p-0\">\n                <div className=\"divide-y\">\n                    {[...Array(5)].map((_, i) => (\n                        <div key={i} className=\"p-4 flex items-center space-x-4\">\n                            <div className=\"space-y-2 flex-1\">\n                                <Skeleton className=\"h-4 w-full shimmer\" />\n                                <Skeleton className=\"h-4 w-3/4 shimmer\" />\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            </div>\n        </div>\n    );\n}\n\nexport default async function MissionDetailsPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    const troopConfigs = await getTroopConfigurations();\n\n    return (\n        <div className=\"main-view\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Centro de Control de Misiones</h2>\n                    <p className=\"text-muted-foreground\">\n                        Supervisa todas tus flotas en movimiento.\n                    </p>\n                </div>\n                <Button asChild>\n                    <Link href=\"/missions/new\">\n                        <PlusCircle className=\"mr-2 h-4 w-4\" />\n                        Planificar Misión\n                    </Link>\n                </Button>\n            </div>\n            <Suspense fallback={<MissionDetailsLoading />}>\n                <MissionDetailsView \n                    missions={user.misiones} \n                    incomingAttacks={user.incomingAttacks || []}\n                    troopConfigs={troopConfigs}\n                />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/missions/new/page.tsx": "'use server';\n\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { MissionsView } from \"@/components/dashboard/missions-view\";\nimport { getTroopConfigurations, getPropertyOwner } from \"@/lib/data\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport { ClipboardList } from \"lucide-react\";\n\nfunction MissionsLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <Skeleton className=\"h-8 w-48 mb-4 shimmer\" />\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div className=\"space-y-4\">\n                    <Skeleton className=\"h-10 w-full shimmer\" />\n                    <Skeleton className=\"h-10 w-full shimmer\" />\n                    <Skeleton className=\"h-10 w-full shimmer\" />\n                </div>\n                <div className=\"space-y-4\">\n                    <Skeleton className=\"h-40 w-full shimmer\" />\n                    <Skeleton className=\"h-10 w-full shimmer\" />\n                </div>\n            </div>\n        </div>\n    )\n}\n\nexport default async function NewMissionPage(props: {\n    searchParams: Promise<{\n        propertyId?: string;\n        ciudad?: string;\n        barrio?: string;\n        edificio?: string;\n    }>\n}) {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    if (!user.propiedades || user.propiedades.length === 0) {\n        return (\n            <div className=\"main-view text-center\">\n                <h2 className=\"text-2xl font-bold\">Sin propiedades</h2>\n                <p className=\"text-muted-foreground\">No puedes enviar misiones si no tienes propiedades.</p>\n            </div>\n        )\n    }\n\n    const { propertyId, ciudad, barrio, edificio } = (await props.searchParams) || {};\n    \n    let initialTargetOwner = undefined;\n\n    if (ciudad && barrio && edificio) {\n        const owner = await getPropertyOwner({ \n            ciudad: parseInt(ciudad), \n            barrio: parseInt(barrio), \n            edificio: parseInt(edificio) \n        });\n        initialTargetOwner = owner;\n    }\n\n    const selectedProperty = user.propiedades.find(p => p.id === propertyId) || user.propiedades.find(p => p.nombre === 'Propiedad Principal') || user.propiedades[0];\n    \n    if (propertyId !== selectedProperty.id) {\n        let redirectPath = `/missions/new?propertyId=${selectedProperty.id}`;\n        if(ciudad && barrio && edificio) {\n            redirectPath += `&ciudad=${ciudad}&barrio=${barrio}&edificio=${edificio}`;\n        }\n        redirect(redirectPath);\n    }\n\n    const troopConfigs = await getTroopConfigurations();\n    \n    return (\n        <div className=\"main-view\">\n             <div className=\"flex flex-wrap items-center justify-between gap-4\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Centro de Mando</h2>\n                    <p className=\"text-muted-foreground\">\n                        Planifica y ejecuta tus operaciones desde {selectedProperty.nombre}.\n                    </p>\n                </div>\n                <Button asChild>\n                    <Link href=\"/missions/details\">\n                        <ClipboardList className=\"mr-2 h-4 w-4\" />\n                        Ver Flotas en Movimiento\n                    </Link>\n                </Button>\n            </div>\n            <Suspense fallback={<MissionsLoading />}>\n                <MissionsView \n                    user={user} \n                    troopConfigs={troopConfigs} \n                    initialTargetOwner={initialTargetOwner}\n                    selectedProperty={selectedProperty}\n                />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/powerattack/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { PowerAttackView } from \"@/components/dashboard/powerattack-view\";\n\nfunction PowerAttackLoading() {\n    return (\n        <div className=\"space-y-4\">\n            <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n            <Skeleton className=\"h-4 w-80 shimmer\" />\n            <Skeleton className=\"h-24 w-full shimmer\" />\n            <div className=\"border rounded-lg p-0\">\n                <Skeleton className=\"h-[400px] w-full shimmer\" />\n            </div>\n        </div>\n    );\n}\n\nexport default async function PowerAttackPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n\n    return (\n        <div className=\"main-view\">\n            <Suspense fallback={<PowerAttackLoading />}>\n                <PowerAttackView user={user} />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/(dashboard)/technologies/page.tsx": "\nimport { Suspense } from \"react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { getRoomConfigurations, getTrainingConfigurations, getTroopConfigurations, UserWithProgress } from \"@/lib/data\";\nimport { TechnologyTreeView } from \"@/components/dashboard/technologies/technology-tree-view\";\nimport { getSessionUser } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\n\nfunction TechnologiesLoading() {\n    return (\n        <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <Skeleton className=\"h-8 w-64 mb-2 shimmer\" />\n                    <Skeleton className=\"h-4 w-80 shimmer\" />\n                </div>\n            </div>\n             <div className=\"flex gap-2 mb-4\">\n                <Skeleton className=\"h-10 w-32\" />\n                <Skeleton className=\"h-10 w-32\" />\n                <Skeleton className=\"h-10 w-32\" />\n            </div>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                {[...Array(9)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-48 w-full shimmer\" />\n                ))}\n            </div>\n        </div>\n    )\n}\n\nexport default async function TechnologiesPage() {\n    const user = await getSessionUser();\n    if (!user) {\n        redirect('/');\n    }\n    \n    const [rooms, trainings, troops] = await Promise.all([\n        getRoomConfigurations(),\n        getTrainingConfigurations(),\n        getTroopConfigurations()\n    ]);\n    \n    return (\n        <div className=\"main-view\">\n            <div className=\"flex items-center justify-between\">\n                <div>\n                    <h2 className=\"text-3xl font-bold tracking-tight\">Guía de Desbloqueo</h2>\n                    <p className=\"text-muted-foreground\">\n                        Consulta el árbol tecnológico para planificar tus próximos movimientos.\n                    </p>\n                </div>\n            </div>\n            <Suspense fallback={<TechnologiesLoading />}>\n                <TechnologyTreeView\n                    user={user}\n                    rooms={rooms}\n                    trainings={trainings}\n                    troops={troops}\n                />\n            </Suspense>\n        </div>\n    );\n}\n",
    "src/app/sitemap.ts": "import { MetadataRoute } from 'next'\n \nconst URL = 'https://vendettadashboardredis.vercel.app';\n\nexport default function sitemap(): MetadataRoute.Sitemap {\n  return [\n    {\n      url: `${URL}/`,\n      lastModified: new Date(),\n      changeFrequency: 'yearly',\n      priority: 1,\n    },\n    {\n        url: `${URL}/admin`,\n        lastModified: new Date(),\n        changeFrequency: 'monthly',\n        priority: 0.5,\n    },\n    {\n        url: `${URL}/overview`,\n        lastModified: new Date(),\n        changeFrequency: 'daily',\n        priority: 0.9,\n    },\n  ]\n}",
    "src/app/not-found.tsx": "\nimport Link from 'next/link'\n\nexport default function NotFound() {\n  return (\n    <div className=\"flex h-screen w-full flex-col items-center justify-center bg-background text-foreground gap-4\">\n      <h2 className=\"text-4xl font-bold\">404 - Página no encontrada</h2>\n      <p className=\"text-muted-foreground\">La página que buscas no existe o ha sido movida.</p>\n      <Link href=\"/\" className=\"text-primary hover:underline underline-offset-4\">\n        Volver al inicio\n      </Link>\n    </div>\n  )\n}\n",
    "src/app/globals.css": "@tailwind base;\n@tailwind utilities;\n@tailwind components;\n\n@layer base {\n  :root {\n    /* Dark Theme Base (Zinc-950) */\n    --background: 240 10% 3.9%;\n    --foreground: 0 0% 98%;\n\n    /* Card & Popover - Darker with slight elevation */\n    --card: 240 10% 6%;\n    --card-foreground: 0 0% 98%;\n    --popover: 240 10% 5%;\n    --popover-foreground: 0 0% 98%;\n\n    /* Primary: Red Vendetta (Intense Blood Red) */\n    --primary: 0 85% 40%;\n    --primary-foreground: 0 0% 98%;\n\n    /* Secondary: Dark Metal/Gunmetal */\n    --secondary: 240 5% 12%;\n    --secondary-foreground: 0 0% 98%;\n\n    /* Muted: Subtle Text */\n    --muted: 240 4% 16%;\n    --muted-foreground: 240 5% 65%;\n\n    /* Accent: Interactive Elements */\n    --accent: 240 5% 15%;\n    --accent-foreground: 0 0% 98%;\n\n    /* Destructive */\n    --destructive: 0 62% 30%;\n    --destructive-foreground: 0 0% 98%;\n\n    /* Borders & Inputs */\n    --border: 240 5% 15%;\n    --input: 240 5% 15%;\n    --ring: 0 85% 40%;\n\n    /* Custom Accents */\n    --gold: 48 80% 50%; /* Metallic Gold */\n    --gold-foreground: 48 95% 5%;\n\n    --radius: 0.5rem;\n\n    /* Semantic Colors */\n    --success: 142 70% 35%;\n    --success-border: 142 70% 25%;\n    --error: 0 84% 60%;\n    --error-border: 0 84% 40%;\n\n    /* Map Colors */\n    --map-player: 142 70% 45%;\n    --map-family: 48 90% 50%;\n    --map-enemy: 0 85% 45%;\n\n    /* Sidebar Variables */\n    --sidebar-background: 240 10% 3.9%;\n    --sidebar-foreground: 240 5% 65%;\n    --sidebar-primary: 0 85% 40%;\n    --sidebar-primary-foreground: 0 0% 98%;\n    --sidebar-accent: 240 5% 15%;\n    --sidebar-accent-foreground: 0 0% 98%;\n    --sidebar-border: 240 5% 15%;\n    --sidebar-ring: 0 85% 40%;\n  }\n}\n\n@layer base {\n  * {\n    @apply border-border transition-colors duration-200;\n  }\n  html {\n    @apply font-sans;\n  }\n  body {\n    @apply bg-background text-foreground;\n    background-image: url(\"/fondos/fondo_mafia_theme_mobile.webp\");\n    background-size: cover;\n    background-position: center center;\n    background-repeat: no-repeat;\n    background-attachment: fixed;\n  }\n\n  @media (min-width: 768px) {\n    body {\n        background-image: url(\"/fondos/fondo_mafia_theme.webp\");\n    }\n  }\n  \n  h1, h2, h3, h4, h5, h6 {\n    @apply font-heading tracking-tight;\n  }\n\n  table {\n    @apply w-full;\n  }\n\n  table > tbody > tr:nth-child(even) {\n    @apply bg-muted/20;\n  }\n}\n\n@layer components {\n    .main-view {\n        @apply p-4 md:p-6 space-y-6 animate-fade-in;\n    }\n    .ok-message {\n      @apply bg-success/20 border-l-4 border-success text-emerald-100 p-4 mb-4 rounded-r-md backdrop-blur-sm shadow-sm;\n    }\n    .error-message {\n      @apply bg-destructive/20 border-l-4 border-destructive text-destructive-foreground p-4 mb-4 rounded-r-md backdrop-blur-sm shadow-sm;\n    }\n     .content_box {\n      @apply bg-card/90 border border-border mb-4 p-4 rounded-lg shadow-sm backdrop-blur-sm;\n    }\n    .progress-bar-indicator {\n        @apply rounded-full;\n    }\n\n    /* --- New Layout System --- */\n    .dashboard-grid {\n      @apply md:grid md:grid-cols-[auto_1fr];\n    }\n    \n    .main-content {\n      @apply flex-1 flex flex-col min-w-0;\n    }\n\n    .container {\n      @apply max-w-7xl mx-auto w-full p-4 md:p-6 lg:p-8;\n    }\n}\n\n/* --- New Sidebar Styles --- */\n.sidebar {\n  width: 68px; /* Slightly wider to give icons room */\n  background-color: hsl(var(--card));\n  border-right: 1px solid hsl(var(--border));\n  display: flex;\n  flex-direction: column;\n  padding: 0;\n  height: 100vh;\n  position: sticky;\n  top: 0;\n  z-index: 40;\n  transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);\n  overflow: hidden;\n}\n\n.sidebar:hover {\n  width: 260px;\n  box-shadow: 4px 0 20px rgba(0,0,0,0.4);\n}\n\n.sidebar-header {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  height: 64px;\n  flex-shrink: 0;\n  position: relative;\n  border-bottom: 1px solid hsl(var(--border));\n}\n\n.sidebar-logo {\n  position: absolute;\n  inset: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: opacity 0.3s ease, transform 0.3s ease;\n}\n\n.sidebar:hover .sidebar-logo {\n  opacity: 0;\n  transform: scale(0.8);\n}\n\n.sidebar-title {\n  position: absolute;\n  inset: 0;\n  display: flex;\n  flex-direction: row;\n  align-items: baseline;\n  justify-content: center;\n  gap: 0.5rem;\n  opacity: 0;\n  transform: scale(1.2);\n  transition: opacity 0.3s ease, transform 0.3s ease;\n  pointer-events: none;\n  font-family: 'Bebas Neue', sans-serif;\n  font-size: 1.5rem;\n  letter-spacing: 0.1em;\n  text-transform: uppercase;\n}\n\n.sidebar:hover .sidebar-title {\n  opacity: 1;\n  transform: scale(1);\n  transition-delay: 0.1s;\n  pointer-events: auto;\n}\n\n.sidebar-scroll-content {\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n    padding: 10px;\n    height: 100%;\n    overflow-y: auto;\n    overflow-x: hidden;\n    flex-grow: 1;\n}\n\n.sidebar-scroll-content::-webkit-scrollbar {\n    display: none;\n}\n\n.sidebar-group {\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n    margin-bottom: 8px;\n    padding-bottom: 8px;\n    border-bottom: 1px solid hsl(var(--border));\n}\n\n.sidebar-group:last-child {\n    border-bottom: none;\n}\n\n.sidebar-group-label {\n    padding: 0 12px;\n    font-size: 0.7rem;\n    text-transform: uppercase;\n    color: hsl(var(--muted-foreground));\n    font-weight: 700;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n    white-space: nowrap;\n    margin-bottom: 4px;\n}\n\n.sidebar:hover .sidebar-group-label {\n    opacity: 1;\n    transition-delay: 0.1s;\n}\n\n.nav-item {\n  width: 100%;\n  height: 44px;\n  display: flex;\n  align-items: center;\n  justify-content: flex-start;\n  padding: 0 0 0 12px; \n  border-radius: var(--radius);\n  color: hsl(var(--muted-foreground));\n  background: transparent;\n  border: none;\n  cursor: pointer;\n  transition: all 0.2s;\n  overflow: hidden;\n  gap: 16px; /* Spacing between icon and text */\n  flex-shrink: 0;\n}\n\n.nav-item:hover {\n  color: hsl(var(--foreground));\n  background-color: hsl(var(--accent));\n}\n\n.nav-item.active {\n  color: hsl(var(--primary));\n  background-color: hsla(var(--primary), 0.2);\n}\n\n.nav-item svg {\n  min-width: 24px;\n  width: 24px;\n  height: 24px;\n}\n\n.nav-label {\n  opacity: 0;\n  transform: translateX(-15px);\n  transition: opacity 0.3s ease, transform 0.3s ease;\n  white-space: nowrap;\n  font-family: 'Bebas Neue', sans-serif;\n  font-weight: 500;\n  text-transform: uppercase;\n  font-size: 0.95rem;\n  letter-spacing: 0.05em;\n}\n\n.sidebar:hover .nav-label {\n  opacity: 1;\n  transform: translateX(0);\n  transition-delay: 0.1s;\n}\n\n/* --- Sidebar Footer --- */\n.sidebar-footer {\n    flex-shrink: 0;\n    margin-top: auto;\n    padding: 10px;\n    border-top: 1px solid hsl(var(--border));\n}\n\n.user-info {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    padding: 4px;\n    overflow: hidden;\n}\n\n.user-avatar {\n    width: 36px;\n    height: 36px;\n    flex-shrink: 0;\n}\n\n.user-name {\n    font-weight: 600;\n    font-size: 0.875rem;\n    white-space: nowrap;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n.logout-form {\n    margin-left: auto;\n}\n\n.logout-button {\n    color: hsl(var(--muted-foreground));\n    padding: 8px; /* consistent size */\n}\n\n.logout-button:hover {\n    color: hsl(var(--destructive));\n    background-color: hsla(var(--destructive), 0.1);\n}\n\n.logout-text {\n    opacity: 0;\n    width: 0;\n    overflow: hidden;\n    white-space: nowrap;\n    transition: opacity 0.3s ease, width 0.3s ease;\n}\n\n.sidebar:hover .user-name {\n    opacity: 1;\n    transition-delay: 0.1s;\n}\n\n.sidebar:hover .logout-text {\n    opacity: 1;\n    width: auto;\n    margin-left: 8px;\n    transition-delay: 0.1s;\n}\n\n/* --- Mobile Nav --- */\n.desktop-sidebar {\n    display: none;\n}\n.mobile-bottom-bar {\n    display: none;\n}\n.mobile-menu-overlay {\n    display: none;\n}\n\n@media (min-width: 768px) {\n    .desktop-sidebar {\n        display: flex;\n    }\n}\n\n@media (max-width: 767px) {\n    .mobile-bottom-bar {\n        display: flex;\n        position: fixed;\n        bottom: 0;\n        left: 0;\n        width: 100%;\n        height: 64px;\n        background-color: hsla(var(--card), 0.95);\n        backdrop-filter: blur(10px);\n        border-top: 1px solid hsl(var(--border));\n        justify-content: space-around;\n        align-items: center;\n        z-index: 900;\n        padding-top: 10px;\n        padding-bottom: max(10px, env(safe-area-inset-bottom));\n    }\n\n    .mobile-bottom-item {\n        background: none;\n        border: none;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 4px;\n        color: hsl(var(--muted-foreground));\n        font-size: 0.7rem;\n        cursor: pointer;\n        flex: 1;\n    }\n\n    .mobile-bottom-item svg {\n        width: 20px;\n        height: 20px;\n    }\n\n    .mobile-bottom-item.active {\n        color: hsl(var(--primary));\n    }\n\n    .mobile-bottom-item.menu-trigger {\n        color: hsl(var(--foreground));\n    }\n\n    .mobile-menu-overlay {\n        display: block;\n        position: fixed;\n        inset: 0;\n        background-color: rgba(0, 0, 0, 0.8);\n        backdrop-filter: blur(2px);\n        z-index: 999;\n        opacity: 0;\n        visibility: hidden;\n        transition: opacity 0.3s ease, visibility 0.3s;\n        pointer-events: none;\n    }\n\n    .mobile-menu-overlay.open {\n        opacity: 1;\n        visibility: visible;\n        pointer-events: auto;\n    }\n\n    .mobile-menu-content {\n        position: fixed;\n        top: 0;\n        left: 0;\n        height: 100%;\n        width: 280px;\n        background-color: hsl(var(--card));\n        border-right: 1px solid hsl(var(--border));\n        transform: translateX(-100%);\n        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        display: flex;\n        flex-direction: column;\n        z-index: 1000;\n        box-shadow: 10px 0 30px rgba(0,0,0,0.5);\n    }\n\n    .mobile-menu-content.open {\n        transform: translateX(0);\n    }\n\n    .mobile-menu-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 20px;\n        border-bottom: 1px solid hsl(var(--border));\n    }\n\n    .mobile-menu-header h3 {\n        margin: 0;\n        font-size: 1.2rem;\n        text-transform: uppercase;\n        color: hsl(var(--foreground));\n    }\n\n    .close-menu-btn {\n        background: transparent;\n        border: none;\n        color: hsl(var(--muted-foreground));\n        cursor: pointer;\n    }\n    .close-menu-btn:hover { color: hsl(var(--foreground)); }\n\n    .mobile-menu-scroll {\n        overflow-y: auto;\n        flex: 1;\n        padding: 16px;\n    }\n\n    .mobile-group {\n        margin-bottom: 16px;\n    }\n\n    .mobile-group-label {\n        font-size: 0.75rem;\n        text-transform: uppercase;\n        color: hsl(var(--muted-foreground));\n        margin-bottom: 8px;\n        font-weight: 700;\n        padding-left: 12px;\n    }\n\n    .mobile-nav-item {\n        width: 100%;\n        display: flex;\n        align-items: center;\n        gap: 16px;\n        padding: 12px;\n        background: transparent;\n        border: none;\n        color: hsl(var(--muted-foreground));\n        font-size: 0.95rem;\n        border-radius: var(--radius);\n        text-align: left;\n        cursor: pointer;\n    }\n\n    .mobile-nav-item.active {\n        background-color: hsla(var(--primary), 0.1);\n        color: hsl(var(--primary));\n    }\n    \n    .mobile-nav-item:hover {\n        color: hsl(var(--foreground));\n    }\n\n    .menu-divider {\n        height: 1px;\n        background-color: hsl(var(--border));\n        margin: 8px 0 16px 0;\n    }\n}\n",
    "src/workers/mission-worker.ts": "\nimport { createClient } from '@supabase/supabase-js';\nimport { popNextMission } from '../lib/queue';\nimport { handleAttackMission } from '../lib/actions/brawl.actions';\nimport { handleEspionageMission } from '../lib/actions/espionage.actions';\nimport { handleTransportMission } from '../lib/actions/transport.actions';\nimport { handleDefendMission } from '../lib/actions/defense.actions';\nimport { handleOccupyMission } from '../lib/actions/occupy.actions';\nimport type { ColaMisiones } from '@/types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!; // IMPORTANT: Use SERVICE_ROLE_KEY for workers\n\nif (!supabaseUrl || !supabaseKey) {\n    console.error(\"Supabase URL or Service Role Key is not defined. Worker cannot start.\");\n    process.exit(1);\n}\n\nconst supabase = createClient(supabaseUrl, supabaseKey);\n\nconsole.log(\"Mission worker started...\");\n\nasync function run() {\n    while (true) {\n        try {\n            // popNextMission now uses the correct service client internally\n            const job = await popNextMission();\n            if (job) {\n                console.log(`Processing mission job: ${job.id} (Provider: ${job.provider})`);\n                const { payload } = job;\n\n                const missionId = payload.missionId;\n\n                if (missionId) {\n                    const { data: mission, error } = await supabase\n                        .from('ColaMisiones')\n                        .select('*')\n                        .eq('id', missionId)\n                        .single();\n\n                    if (mission) {\n                        const m = mission as unknown as ColaMisiones;\n\n                        switch (m.tipoMision) {\n                            case 'ATAQUE':\n                                await handleAttackMission(m, supabase);\n                                break;\n                            case 'ESPIONAJE':\n                                await handleEspionageMission(m, supabase);\n                                break;\n                            case 'TRANSPORTE':\n                                await handleTransportMission(m, supabase);\n                                break;\n                            case 'DEFENDER':\n                                await handleDefendMission(m, supabase);\n                                break;\n                            case 'OCUPAR':\n                                await handleOccupyMission(m, supabase);\n                                break;\n                            default:\n                                console.warn(`Unknown mission type: ${m.tipoMision}`);\n                        }\n                    } else {\n                        console.warn(`Mission not found: ${missionId}`);\n                    }\n                }\n\n                if (job.provider === 'pgmq') {\n                     await supabase.rpc('pgmq.archive' as any, { queue_name: 'fleet_missions', msg_id: job.id });\n                }\n\n                if (job.provider === 'fleet_queue') {\n                     await supabase.from('FleetQueue').delete().eq('id', job.id);\n                }\n\n            } else {\n                await new Promise(r => setTimeout(r, 1000));\n            }\n        } catch (e) {\n            console.error(\"Worker error:\", e);\n            await new Promise(r => setTimeout(r, 5000));\n        }\n    }\n}\n\nrun();\n",
    "src/utils/supabase/proxy.ts": "\nimport { createServerClient, type CookieOptions } from \"@supabase/ssr\";\nimport { type NextRequest, NextResponse } from \"next/server\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY;\n\nexport const createClient = (request: NextRequest) => {\n  // Create an unmodified response\n  let supabaseResponse = NextResponse.next({\n    request: {\n      headers: request.headers,\n    },\n  });\n\n  const supabase = createServerClient(\n    supabaseUrl!,\n    supabaseKey!,\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll()\n        },\n        setAll(cookiesToSet) {\n          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))\n          supabaseResponse = NextResponse.next({\n            request,\n          })\n          cookiesToSet.forEach(({ name, value, options }) =>\n            supabaseResponse.cookies.set(name, value, options)\n          )\n        },\n      },\n    },\n  );\n\n  return supabaseResponse\n};\n",
    "src/utils/supabase/server.ts": "import { createServerClient } from '@supabase/ssr'\nimport { createClient as createJsClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\n// 1. Cliente estándar para Server Actions/Components (Contexto de Usuario)\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // Ignorar errores de escritura en Server Components\n          }\n        },\n      },\n    }\n  )\n}\n\n// 2. Cliente de Servicio (Admin/Bypass RLS) - SIN contexto de cookies\nexport function createAdminClient() {\n  return createJsClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  )\n}\n",
    "src/utils/supabase/middleware.ts": "import { createServerClient } from '@supabase/ssr'\nimport { NextResponse, type NextRequest } from 'next/server'\n\nexport async function updateSession(request: NextRequest) {\n  let supabaseResponse = NextResponse.next({\n    request: {\n      headers: request.headers,\n    },\n  })\n\n  const supabase = createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll()\n        },\n        setAll(cookiesToSet) {\n          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))\n          supabaseResponse = NextResponse.next({\n            request,\n          })\n          cookiesToSet.forEach(({ name, value, options }) =>\n            supabaseResponse.cookies.set(name, value, options)\n          )\n        },\n      },\n    }\n  )\n\n  // IMPORTANT: DO NOT REMOVE auth.getUser()\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (\n    !user &&\n    !request.nextUrl.pathname.startsWith('/login') &&\n    !request.nextUrl.pathname.startsWith('/auth')\n  ) {\n    // no user, potentially respond by redirecting the user to the login page\n    // const url = request.nextUrl.clone()\n    // url.pathname = '/login'\n    // return NextResponse.redirect(url)\n  }\n\n  return supabaseResponse\n}\n",
    "src/utils/supabase/client.ts": "\nimport { createBrowserClient } from \"@supabase/ssr\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY;\n\nexport const createClient = () =>\n  createBrowserClient(\n    supabaseUrl!,\n    supabaseKey!,\n  );\n",
    "src/hooks/use-toast.test.ts": "import { describe, it, expect } from 'vitest';\n\ndescribe('use-toast', () => {\n    it('is pending migration', () => {\n        expect(true).toBe(true);\n    });\n});\n",
    "src/hooks/use-mobile.tsx": "import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n",
    "src/hooks/use-toast.ts": "\"use client\"\n\n// Inspired by react-hot-toast library\nimport * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n\n  if (action.type === \"DISMISS_TOAST\") {\n    const { toastId } = action\n    if (toastId) {\n      addToRemoveQueue(toastId)\n    } else {\n      memoryState.toasts.forEach((toast) => {\n        addToRemoveQueue(toast.id)\n      })\n    }\n  }\n\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n",
    "src/hooks/use-game-state.ts": "import { useSetAtom } from 'jotai';\nimport { updateActiveResourcesAtom, updatePropertyResourcesAtom } from '@/store/atoms';\n\nexport function useUpdateResources() {\n    const updateActive = useSetAtom(updateActiveResourcesAtom);\n    const updateById = useSetAtom(updatePropertyResourcesAtom);\n\n    return {\n        updateActiveResources: (update: Partial<{ armas: number; municion: number; dolares: number; alcohol: number }>) => updateActive(update),\n        updatePropertyResources: (propertyId: string, update: Partial<{ armas: number; municion: number; dolares: number; alcohol: number }>) => updateById({ propertyId, update })\n    };\n}\n",
    "src/lib/data/family.ts": "import 'server-only';\nimport { cache } from 'react';\nimport { createClient } from '@/utils/supabase/server';\nimport type { FullFamily, FullFamilyInvitation } from '@/types';\nimport type { QueryData } from '@supabase/supabase-js';\n\nexport const getFamilyById = cache(async(id: string): Promise<FullFamily | null> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('Family')\n            .select(`\n                *,\n                members:FamilyMember(*, user:User(id, name, puntuacion:PuntuacionUsuario(*), lastSeen)),\n                announcements:FamilyAnnouncement(*, author:User(id, name, avatarUrl))\n            `)\n            .eq('id', id)\n            .single();\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullFamily;\n    } catch (e) {\n        console.error(\"Error fetching family by id\", JSON.stringify(e, null, 2));\n        return null;\n    }\n});\n\nexport const getFamilyByIdWithAllMembersData = cache(async (familyId: string): Promise<FullFamily | null> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('Family')\n            .select(`*,\n                members:FamilyMember(*, user:User(*,\n                    propiedades:Propiedad(*,\n                        habitaciones:HabitacionUsuario(*, configuracionHabitacion:ConfiguracionHabitacion(*)),\n                        TropaUsuario(*, configuracionTropa:ConfiguracionTropa(*)),\n                        TropaSeguridadUsuario(*, configuracionTropa:ConfiguracionTropa(*))\n                    ),\n                    entrenamientos:EntrenamientoUsuario(*, configuracionEntrenamiento:ConfiguracionEntrenamiento(*)),\n                    puntuacion:PuntuacionUsuario(*)\n                )),\n                announcements:FamilyAnnouncement(*, author:User(id, name, avatarUrl))\n            `)\n            .eq('id', familyId)\n            .single();\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullFamily;\n    } catch (e) {\n        console.error(\"Error fetching full family data by id\", JSON.stringify(e, null, 2));\n        return null;\n    }\n});\n\n\nexport const getFamilyRequests = cache(async (familyId: string): Promise<FullFamilyInvitation[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('FamilyInvitation')\n            .select('*, user:User(id, name, avatarUrl, puntuacion:PuntuacionUsuario(*))')\n            .eq('familyId', familyId)\n            .eq('type', 'REQUEST')\n            .eq('status', \"PENDING\")\n            .order('created_at', { ascending: true });\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullFamilyInvitation[];\n    } catch(e) {\n        console.error(`Error fetching requests for family ${familyId}`, JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n\n\nexport const getInvitationsForUser = cache(async (userId: string): Promise<FullFamilyInvitation[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('FamilyInvitation')\n            .select('*, family:Family(id, name, tag, avatarUrl)')\n            .eq('userId', userId)\n            .eq('status', \"PENDING\")\n            .order('created_at', { ascending: false });\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullFamilyInvitation[];\n    } catch(e) {\n        console.error(`Error fetching invitations for user ${userId}`, JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n",
    "src/lib/data/config.ts": "import 'server-only';\nimport { cache } from 'react';\nimport { createClient } from '@/utils/supabase/server';\nimport type {\n    FullConfiguracionHabitacion,\n    FullConfiguracionEntrenamiento,\n    FullConfiguracionTropa,\n    FullPropiedad\n} from '@/types';\nimport type { QueryData } from '@supabase/supabase-js';\nimport { calculateStorageCapacity } from '../formulas/room-formulas';\n\n// Global configurations (cached heavily in real scenarios, or stored in memory/Redis)\n// Here we fetch from DB but these tables are small.\n\nexport const getRoomConfigurations = cache(async (): Promise<FullConfiguracionHabitacion[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('ConfiguracionHabitacion')\n            .select('*, requisitos:RoomRequirement!roomId(*)');\n\n        type RoomConfigQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullConfiguracionHabitacion[];\n    } catch (e) {\n        console.error(\"Error fetching room configurations\", JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n\nexport const getTrainingConfigurations = cache(async (): Promise<FullConfiguracionEntrenamiento[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('ConfiguracionEntrenamiento')\n            .select('*, requisitos:TrainingRequirement!trainingId(*)');\n\n        type TrainingConfigQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullConfiguracionEntrenamiento[];\n    } catch (e) {\n        console.error(\"Error fetching training configurations\", JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n\nexport const getTroopConfigurations = cache(async (): Promise<FullConfiguracionTropa[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('ConfiguracionTropa')\n            .select('*, bonusContrincante:TropaBonusContrincante!tropaAtacanteId(*)');\n\n        type TroopConfigQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as unknown as FullConfiguracionTropa[];\n    } catch (e) {\n        console.error(\"Error fetching troop configurations\", JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n\nexport const getTroopBonusConfig = cache(async () => {\n    const supabase = await createClient();\n    try {\n        const query = supabase.from('TropaBonusContrincante').select('*');\n\n        type BonusQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n        if(error) throw error;\n        return data as BonusQuery;\n    } catch(e) {\n        return [];\n    }\n});\n\nexport const getMaximumResourceCapacity = cache(async (propiedad?: FullPropiedad) => {\n    if (!propiedad) {\n        // Fallback or base capacity if no property provided\n        return {\n            armas: 1000000,\n            municion: 1000000,\n            alcohol: 1000000,\n            dolares: 1000000\n        };\n    }\n    return calculateStorageCapacity(propiedad);\n});\n\nexport const getGlobalStatistics = cache(async () => {\n    const supabase = await createClient();\n    // Using RPC to get aggregated stats to avoid heavy client-side math on all users\n    try {\n        const [\n            allRoomConfigs,\n            allTrainingConfigs,\n            allTroopConfigs\n        ] = await Promise.all([\n            getRoomConfigurations(),\n            getTrainingConfigurations(),\n            getTroopConfigurations()\n        ]);\n\n        const { data: troopStats, error } = await supabase.rpc('get_max_troop_counts');\n        if (error) throw error;\n\n        // Map to structure expected by UI if it was different\n        // Based on memory: \"StatisticsView calculates user-specific totals ... treating the passed `troopStats` strictly as global comparison data.\"\n        // And the page component expects: allRoomConfigs, allTrainingConfigs, allTroopConfigs, roomStats, trainingStats, troopStats\n\n        return {\n            allRoomConfigs,\n            allTrainingConfigs,\n            allTroopConfigs,\n            roomStats: [], // Server-side aggregation not yet implemented for these, returning empty to avoid errors\n            trainingStats: [], // Server-side aggregation not yet implemented for these\n            troopStats: troopStats || [],\n            maxTroops: troopStats || [] \n        };\n    } catch (e) {\n        console.error(\"Error fetching global statistics\", JSON.stringify(e, null, 2));\n        return { \n            allRoomConfigs: [],\n            allTrainingConfigs: [],\n            allTroopConfigs: [],\n            roomStats: [],\n            trainingStats: [],\n            troopStats: [], \n            maxTroops: [] \n        };\n    }\n});\n",
    "src/lib/data/property.ts": "\n'use server';\n\nimport { cache } from 'react';\nimport { createClient } from '@/utils/supabase/server';\nimport type { PropertyWithOwner, UserProfileData } from '@/types';\n\nexport const getPropertyOwner = cache(async (coords: { ciudad: number, barrio: number, edificio: number }): Promise<PropertyWithOwner['user'] | null> => {\n    const supabase = await createClient();\n    try {\n        // CORRECCIÓN: Se cambia .single() por .limit(1).maybeSingle() para evitar el error PGRST116\n        // si existen datos duplicados (aunque el nuevo constraint lo previene).\n        // Esto hace la consulta más robusta.\n        const { data, error } = await supabase\n            .from('Propiedad')\n            .select(`\n                user:User!userId (*,\n                    puntuacion:PuntuacionUsuario(puntosTotales),\n                    propiedades:Propiedad(id, nombre, ciudad, barrio, edificio),\n                    familyMember:FamilyMember(*, family:Family(id, name, tag, avatarUrl))\n                )\n            `)\n            .eq('ciudad', coords.ciudad)\n            .eq('barrio', coords.barrio)\n            .eq('edificio', coords.edificio)\n            .limit(1)\n            .maybeSingle();\n\n        // El error PGRST116 (multiple rows) ya no debería ocurrir debido al .limit(1),\n        // pero mantenemos el manejo de errores por si acaso.\n        if (error && error.code !== 'PGRST116') throw error;\n        \n        return data?.user as unknown as UserProfileData | null;\n    } catch(e) {\n        // Log a more informative error\n        console.error(`Error in getPropertyOwner for coords ${coords.ciudad}:${coords.barrio}:${coords.edificio}:`, JSON.stringify(e, null, 2));\n        return null;\n    }\n});\n\n\nexport const getPropertiesByLocation = cache(async (ciudad: number, barrio: number): Promise<PropertyWithOwner[]> => {\n    const supabase = await createClient();\n    try {\n        // Fetch static data (with relations) and dynamic resource data in parallel\n        const [staticRes, liveRes] = await Promise.all([\n            supabase\n                .from('Propiedad')\n                .select(`\n                    *,\n                    user:User!userId(*,\n                        familyMember:FamilyMember(*, family:Family(id, name, tag)),\n                        puntuacion:PuntuacionUsuario(puntosTotales),\n                        propiedades:Propiedad(id, nombre, ciudad, barrio, edificio)\n                    )\n                `)\n                .eq('ciudad', ciudad)\n                .eq('barrio', barrio),\n\n            supabase\n                .from('PropiedadLive')\n                .select('id, armas, municion, alcohol, dolares, updated_at')\n                .eq('ciudad', ciudad)\n                .eq('barrio', barrio)\n        ]);\n\n        if(staticRes.error) throw staticRes.error;\n        if(liveRes.error) throw liveRes.error;\n\n        const liveMap = new Map(liveRes.data?.map(l => [l.id, l]));\n        \n        const transformedData = staticRes.data?.map((p) => {\n             const live = liveMap.get(p.id);\n             return {\n                ...p,\n                // Override with live data if available\n                alcohol: live ? Number(live.alcohol) : Number(p.alcohol),\n                armas: live ? Number(live.armas) : Number(p.armas),\n                dolares: live ? Number(live.dolares) : Number(p.dolares),\n                municion: live ? Number(live.municion) : Number(p.municion),\n                updated_at: live ? live.updated_at : p.updated_at,\n                user: p.user as unknown as UserProfileData\n             };\n        });\n\n        return transformedData as PropertyWithOwner[];\n    } catch (error) {\n        console.error(\"Error fetching properties by location:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n",
    "src/lib/data/ranking.ts": "import 'server-only';\nimport { cache } from 'react';\nimport { createClient } from '@/utils/supabase/server';\nimport type { UserForRanking, FullFamily } from '@/types';\nimport type { QueryData } from '@supabase/supabase-js';\n\n// NOTA: Para que este archivo compile sin errores 2677/2322,\n// se ASUME que el tipo FullFamily en '@/types' ha sido actualizado\n// para incluir 'totalPoints: number', 'members: number' y 'announcements: number'.\n\n\nexport const getUsersForRanking = cache(async (skip: number, take: number): Promise<UserForRanking[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('User')\n            .select(`\n                id, name, title, avatarUrl, created_at,\n                puntuacion:PuntuacionUsuario(*),\n                _count:propiedades(count)\n            `)\n            .order('puntosTotales', { referencedTable: 'PuntuacionUsuario', ascending: false, nullsFirst: false })\n            .range(skip, skip + take - 1);\n\n        const { data, error } = await query;\n        if(error) throw error;\n\n        // Mapeo existente para aplanar el conteo\n        const mappedData = data.map((user) => ({\n            ...user,\n            _count: {\n                propiedades: (user._count as unknown as { count: number }[] | null)?.[0]?.count ?? 0\n            }\n        }));\n\n        return mappedData as unknown as UserForRanking[];\n    } catch (error) {\n        console.error(\"Error fetching users for ranking:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n\nexport const getUsersForHonorRanking = cache(async (skip: number, take: number): Promise<UserForRanking[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('User')\n            .select('*, puntuacion:PuntuacionUsuario(*), _count:propiedades(count)')\n            .order('puntosHonorTotales', { referencedTable: 'PuntuacionUsuario', ascending: false, nullsFirst: false })\n            .range(skip, skip + take - 1);\n        \n        const { data, error } = await query;\n        if(error) throw error;\n        \n        const mappedData = data.map((user) => ({\n            ...user,\n            _count: {\n                propiedades: (user._count as unknown as { count: number }[] | null)?.[0]?.count ?? 0\n            }\n        }));\n\n        return mappedData as unknown as UserForRanking[];\n    } catch (error) {\n        console.error(\"Error fetching users for honor ranking:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n\n\nexport const getFamiliesForRanking = cache(async (skip: number = 0, take: number = 100): Promise<FullFamily[]> => {\n    const supabase = await createClient();\n    try {\n        const { data: rankingData, error: rankingError } = await supabase\n            .from('FamilyRanking')\n            .select('familyId, totalPoints')\n            .order('totalPoints', { ascending: false, nullsFirst: false })\n            .range(skip, skip + take - 1);\n\n        if (rankingError) throw rankingError;\n        if (!rankingData || rankingData.length === 0) return [];\n\n        // 🟢 CORRECCIÓN A: Filtra y asegura que familyIds es string[]\n        const familyIds = rankingData\n            .map(r => r.familyId)\n            .filter((id): id is string => id !== null); \n\n        // Si todos los IDs fueron nulos después de filtrar, salimos.\n        if (familyIds.length === 0) return []; \n\n        const { data: familiesData, error: familiesError } = await supabase\n            .from('Family')\n            .select('*, members:FamilyMember(count), announcements(count)')\n            .in('id', familyIds);\n\n        if (familiesError) throw familiesError;\n\n        const familiesMap = new Map(familiesData.map(f => {\n            // Aseguramos que el tipo de los conteos sea number (asumiendo que FullFamily lo espera)\n            const memberCount = (f.members as unknown as { count: number }[] | null)?.[0]?.count ?? 0;\n            const announcementCount = (f.announcements as unknown as { count: number }[] | null)?.[0]?.count ?? 0;\n            \n            return [f.id, {\n                ...f,\n                members: memberCount,\n                announcements: announcementCount,\n                // 🟢 CORRECCIÓN B (Práctica segura): Añade la verificación de nulidad si 'familyId' es 'string | null'\n                totalPoints: rankingData.find(r => r.familyId === f.id && r.familyId !== null)?.totalPoints || 0\n            } as unknown as FullFamily] // 🟢 CORRECCIÓN C: Se castea a FullFamily (requiere actualización del tipo FullFamily)\n        }));\n        \n        const sortedFamilies = familyIds\n            .map(id => familiesMap.get(id))\n            .filter((f): f is FullFamily => f !== undefined);\n\n        return sortedFamilies;\n    } catch (error) {\n        console.error(\"Error fetching families for ranking:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n",
    "src/lib/data/combat.ts": "import 'server-only';\nimport { cache } from 'react';\nimport { createClient } from '@/utils/supabase/server';\nimport type { FullBattleReport, FullEspionageReport, FullMessage } from '@/types';\nimport type { QueryData } from '@supabase/supabase-js';\n\nexport const getBattleReportById = cache(async (id: string): Promise<FullBattleReport | null> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('BattleReport')\n            .select('*, attacker:User!attackerId(id, name, avatarUrl), defender:User!defenderId(id, name, avatarUrl)')\n            .eq('id', id)\n            .single();\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as FullBattleReport;\n    } catch (e) {\n        console.error(\"Error fetching battle report by id\", JSON.stringify(e, null, 2));\n        return null;\n    }\n});\n\nexport const getEspionageReportById = cache(async (id: string): Promise<FullEspionageReport | null> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('EspionageReport')\n            .select('*, attacker:User!attackerId(id, name, avatarUrl), defender:User!defenderId(id, name, avatarUrl)')\n            .eq('id', id)\n            .single();\n\n        const { data, error } = await query;\n\n        if(error) throw error;\n        return data as FullEspionageReport;\n    } catch(e) {\n        console.error(\"Error fetching espionage report by id\", JSON.stringify(e, null, 2));\n        return null;\n    }\n});\n\nexport const getBattleReportsForUser = cache(async (userId: string, limit?: number): Promise<FullBattleReport[]> => {\n    const supabase = await createClient();\n    try {\n        let query = supabase\n            .from('BattleReport')\n            .select('*, attacker:User!attackerId(id, name, avatarUrl), defender:User!defenderId(id, name, avatarUrl)')\n            .or(`attackerId.eq.${userId},defenderId.eq.${userId}`)\n            .order('created_at', { ascending: false });\n\n        if (limit) {\n            query = query.limit(limit);\n        }\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as FullBattleReport[];\n    } catch (error) {\n        console.error(\"Error fetching battle reports:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n\nexport const getEspionageReportsForUser = cache(async (userId: string, limit?: number): Promise<FullEspionageReport[]> => {\n    const supabase = await createClient();\n    try {\n        let query = supabase\n            .from('EspionageReport')\n            .select('*, attacker:User!attackerId(id, name, avatarUrl), defender:User!defenderId(id, name, avatarUrl)')\n            .or(`attackerId.eq.${userId},defenderId.eq.${userId}`)\n            .order('created_at', { ascending: false });\n\n        if (limit) {\n            query = query.limit(limit);\n        }\n\n        const { data, error } = await query;\n\n        if (error) throw error;\n        return data as FullEspionageReport[];\n    } catch (error) {\n        console.error(\"Error fetching espionage reports:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n\nexport const getRecentBattleReports = cache(async (userId: string, limit: number = 20): Promise<FullBattleReport[]> => {\n    const supabase = await createClient();\n    try {\n        const query = supabase\n            .from('BattleReport')\n            .select('*, attacker:User!attackerId(id, name, avatarUrl), defender:User!defenderId(id, name, avatarUrl)')\n            .order('created_at', { ascending: false })\n            .limit(limit);\n\n        const { data, error } = await query;\n\n        if(error) throw error;\n        return data as FullBattleReport[];\n    } catch(e) {\n        console.error(\"Error fetching recent battle reports\", JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n",
    "src/lib/data/user.ts": "\nimport 'server-only';\n\nimport { cache } from 'react';\nimport { createClient, createAdminClient } from '@/utils/supabase/server';\nimport type { \n    UserWithProgress, \n    FullMessage, \n    UserProfileData,\n    FullFamily,\n    FullPropiedad,\n    FullFamilyMember,\n    FullColaReclutamiento,\n    FullHabitacionUsuario,\n    FullTropaUsuario,\n    FullTropaSeguridadUsuario,\n    FullColaEntrenamiento,\n    ColaMisiones,\n} from '@/types';\nimport { getBattleReportsForUser, getEspionageReportsForUser } from './combat';\nimport type { QueryData } from '@supabase/supabase-js';\nimport { getFamilyById } from './family';\n\ninterface RPCResourceRow {\n  propiedad_id: string;\n  alcohol: number;\n  armas: number;\n  dolares: number;\n  municion: number;\n}\n\n// ==============================================================================\n//  USER FETCHING (OPTIMIZED)\n// ==============================================================================\n\n/**\n * Retrieves the complete user profile including all related game data.\n * This function is now optimized to avoid recursive joins that cause database errors.\n * It fetches the user's core data and then fetches family data separately if it exists.\n * @deprecated Use atomic functions instead (getUserProfile, getUserResources, getUserActiveMissions).\n * This function fetches too much data and blocks rendering.\n * @param userId The ID of the user to fetch.\n * @returns The complete user profile or null if not found.\n */\nexport const getUserWithProgressById = cache(async (userId: string): Promise<UserWithProgress | null> => {\n    const supabase = await createClient();\n    try {\n        // Step 1: Fetch all non-family related data in parallel.\n        // 🟢 CORRECCIÓN: Se simplifica la consulta para evitar la recursión.\n        // Ya no se intenta hacer un JOIN profundo en la familia aquí.\n        const userQuery = supabase\n            .from('User')\n            .select('*, puntuacion:PuntuacionUsuario(*), familyMember:FamilyMember(familyId, role)')\n            .eq('id', userId)\n            .single();\n\n        const propertiesQuery = supabase\n            .from('Propiedad')\n            .select(`\n                *,\n                habitaciones:HabitacionUsuario(*,\n                    configuracionHabitacion:ConfiguracionHabitacion(*,\n                        requisitos:RoomRequirement!roomId(*)\n                    )\n                ),\n                colaConstruccion:ColaConstruccion(*),\n                colaReclutamiento:ColaReclutamiento(*, tropaConfig:ConfiguracionTropa(*)),\n                TropaUsuario(*, configuracionTropa:ConfiguracionTropa(*)),\n                TropaSeguridadUsuario(*, configuracionTropa:ConfiguracionTropa(*))\n            `)\n            .eq('userId', userId);\n\n        const missionsQuery = supabase.from('ColaMisiones').select('*').eq('userId', userId);\n        const attacksQuery = supabase.from('IncomingAttack').select('*').eq('defenderId', userId);\n        const trainingsQuery = supabase\n            .from('EntrenamientoUsuario')\n            .select('*, configuracionEntrenamiento:ConfiguracionEntrenamiento(*)')\n            .eq('userId', userId);\n        const trainingQueueQuery = supabase.from('ColaEntrenamiento').select('*, entrenamiento:ConfiguracionEntrenamiento(*), propiedad:Propiedad(nombre)').eq('userId', userId);\n        const messagesQuery = supabase.from('Message').select('*', { count: 'exact', head: true }).eq('recipientId', userId).eq('isRead', false);\n\n        // Execute all base queries\n        const [\n            userRes,\n            propertiesRes,\n            missionsRes,\n            attacksRes,\n            trainingsRes,\n            trainingQueueRes,\n            messagesRes\n        ] = await Promise.all([\n            userQuery,\n            propertiesQuery,\n            missionsQuery,\n            attacksQuery,\n            trainingsQuery,\n            trainingQueueQuery,\n            messagesQuery\n        ]);\n\n        // Central error check\n        for (const res of [userRes, propertiesRes, missionsRes, attacksRes, trainingsRes, trainingQueueRes, messagesRes]) {\n            if (res.error) throw new Error(`Database query failed: ${res.error.message}`);\n        }\n\n        if (!userRes.data) return null;\n\n        const userBase = userRes.data;\n        const propertiesData = propertiesRes.data || [];\n\n        // 🟢 NEW: Hydrate properties with real-time resources via Batch RPC\n        // Because data in 'Propiedad' table is lazy/stale, we must calculate current resources.\n        // Optimized to use a single RPC call instead of N+1\n        let hydratedProperties = propertiesData;\n        try {\n            const { data: resourcesList, error: batchError } = await supabase.rpc('get_all_properties_resources', { p_user_id: userId });\n\n            if (batchError) {\n                console.error(\"Batch RPC Error:\", batchError);\n            } else if (resourcesList) {\n                const typedResources = resourcesList as unknown as RPCResourceRow[];\n                const resourcesMap = new Map(typedResources.map((r) => [r.propiedad_id, r]));\n\n                hydratedProperties = propertiesData.map(p => {\n                    const resData = resourcesMap.get(p.id);\n                    if (resData) {\n                        return {\n                            ...p,\n                            alcohol: resData.alcohol ?? p.alcohol,\n                            armas: resData.armas ?? p.armas,\n                            dolares: resData.dolares ?? p.dolares,\n                            municion: resData.municion ?? p.municion\n                        };\n                    }\n                    return p;\n                });\n            }\n        } catch (e) {\n            console.error(\"Failed to batch calculate resources\", e);\n        }\n        \n        // Manejo seguro de array vs objeto (Supabase a veces devuelve array para relaciones 1:1) \n        const rawMember = userBase.familyMember; \n        const familyMemberData = Array.isArray(rawMember) ? rawMember[0] : rawMember; \n        \n        const familyMember = familyMemberData as unknown as (FullFamilyMember & { family: FullFamily }) | null;\n        \n        const fullProperties: FullPropiedad[] = hydratedProperties.map((p) => ({\n            ...p,\n            alcohol: Number(p.alcohol),\n            armas: Number(p.armas),\n            dolares: Number(p.dolares),\n            municion: Number(p.municion),\n            habitaciones: p.habitaciones as unknown as FullHabitacionUsuario[],\n            colaConstruccion: p.colaConstruccion || [],\n            colaReclutamiento: (Array.isArray(p.colaReclutamiento) ? p.colaReclutamiento : (p.colaReclutamiento ? [p.colaReclutamiento] : [])) as unknown as FullColaReclutamiento[],\n            TropaUsuario: p.TropaUsuario as unknown as FullTropaUsuario[],\n            TropaSeguridadUsuario: p.TropaSeguridadUsuario as unknown as FullTropaSeguridadUsuario[],\n        }));\n        \n        const finalUser: UserWithProgress = {\n            ...userBase,\n            // 🟢 CORRECCIÓN: Se establece familyMember con datos básicos, sin anidamiento profundo.\n            familyMember: familyMember ? { ...familyMember, family: {} as FullFamily } : null,\n            propiedades: fullProperties,\n            entrenamientos: (trainingsRes.data || []) as UserWithProgress['entrenamientos'],\n            misiones: missionsRes.data || [],\n            incomingAttacks: attacksRes.data || [],\n            colaEntrenamientos: (trainingQueueRes.data || []) as unknown as FullColaEntrenamiento[],\n            puntuacion: userBase.puntuacion || null,\n            _count: {\n                receivedMessages: messagesRes.count || 0\n            }\n        };\n\n        return finalUser;\n\n    } catch (error: any) { \n        console.error(\"🔥🔥 ERROR CRÍTICO FETCHING USER 🔥🔥\"); \n        console.error(\"Mensaje:\", error?.message || error); \n        console.error(\"Stack:\", error?.stack); \n        console.error(\"Detalle completo:\", JSON.stringify(error, Object.getOwnPropertyNames(error), 2)); \n        return null; \n    }\n});\n\n/**\n * Retrieves basic user profile data.\n * Optimized for low overhead.\n */\nexport const getUserProfile = cache(async (userId: string): Promise<UserProfileData | null> => {\n    const supabase = await createClient();\n    try {\n        const { data: { user } } = await supabase.auth.getUser();\n        let queryClient = supabase;\n\n        // If trying to view another user, we must use admin client because RLS blocks 'User' table access for others\n        if (user?.id !== userId) {\n            const adminClient = createAdminClient();\n            queryClient = adminClient as any;\n        }\n\n        const query = queryClient\n            .from('User')\n            .select(`\n                id, name, title, avatarUrl, created_at,\n                puntuacion:PuntuacionUsuario(*),\n                propiedades:Propiedad(id, nombre, ciudad, barrio, edificio),\n                familyMember:FamilyMember(*, family:Family(id, name, tag, avatarUrl))\n            `)\n            .eq('id', userId)\n            .single();\n\n        type UserProfileQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n\n        if (error) throw error;\n\n        // Manual casting for FamilyMember because the query returns an array or object depending on relationship setup\n        const familyMember = Array.isArray(data.familyMember) ? data.familyMember[0] : data.familyMember;\n\n        return {\n            ...data,\n            familyMember: familyMember || null,\n            propiedades: data.propiedades, // Assuming correct structure\n            puntuacion: data.puntuacion // Assuming correct structure\n        } as unknown as UserProfileData;\n\n    } catch(e) {\n        console.error(`Error fetching profile for user ${userId}`, JSON.stringify(e, null, 2));\n        return null;\n    }\n});\n\n// Alias for backward compatibility\nexport const getUserProfileById = getUserProfile;\n\nexport const getUserResources = cache(async (userId: string) => {\n    const supabase = await createClient();\n    try {\n        const { data, error } = await supabase\n            .from('Propiedad')\n            .select('id, nombre, alcohol, armas, dolares, municion')\n            .eq('userId', userId);\n\n        if (error) throw error;\n\n        // 🟢 NEW: Hydrate with real-time resources via Batch RPC\n        let hydratedData = data;\n        try {\n            const { data: resourcesList, error: batchError } = await supabase.rpc('get_all_properties_resources', { p_user_id: userId });\n\n            if (batchError) {\n                // console.warn(`Batch RPC Error in getUserResources:`, batchError);\n            } else if (resourcesList) {\n                const typedResources = resourcesList as unknown as RPCResourceRow[];\n                const resourcesMap = new Map(typedResources.map((r) => [r.propiedad_id, r]));\n\n                hydratedData = data.map(p => {\n                    const resData = resourcesMap.get(p.id);\n                    if (resData) {\n                        return {\n                            ...p,\n                            alcohol: resData.alcohol ?? p.alcohol,\n                            armas: resData.armas ?? p.armas,\n                            dolares: resData.dolares ?? p.dolares,\n                            municion: resData.municion ?? p.municion\n                        };\n                    }\n                    return p;\n                });\n            }\n        } catch (e) {\n             console.error(`Failed to batch calculate resources`, e);\n        }\n\n        return hydratedData.map(p => ({\n            ...p,\n            alcohol: Number(p.alcohol),\n            armas: Number(p.armas),\n            dolares: Number(p.dolares),\n            municion: Number(p.municion),\n        }));\n    } catch (error) {\n         console.error(\"Error fetching user resources:\", JSON.stringify(error, null, 2));\n         return [];\n    }\n});\n\nexport const getUserActiveMissions = cache(async (userId: string): Promise<ColaMisiones[]> => {\n    const supabase = await createClient();\n    try {\n        const { data, error } = await supabase\n            .from('ColaMisiones')\n            .select('*')\n            .eq('userId', userId);\n\n        if (error) throw error;\n        return data || [];\n    } catch (error) {\n         console.error(\"Error fetching user missions:\", JSON.stringify(error, null, 2));\n         return [];\n    }\n});\n\nexport const getUserTrainings = cache(async (userId: string) => {\n  const supabase = await createClient();\n  try {\n      const { data, error } = await supabase\n          .from('EntrenamientoUsuario')\n          .select('*, configuracionEntrenamiento:ConfiguracionEntrenamiento(*)')\n          .eq('userId', userId);\n\n      if (error) throw error;\n      return data || [];\n  } catch (error) {\n      console.error(\"Error fetching user trainings:\", JSON.stringify(error, null, 2));\n      return [];\n  }\n});\n\n\n// ==============================================================================\n//  FUNCIONES DE DATOS ESPECIALIZADAS Y LEGADAS\n// ==============================================================================\n\nexport const getMessagesForUser = cache(async (userId: string, limit?: number): Promise<FullMessage[]> => {\n    const supabase = await createClient();\n    try {\n        let query = supabase\n            .from('Message')\n            .select('*, sender:User!senderId(id, name, avatarUrl)')\n            .eq('recipientId', userId)\n            .eq('category', 'JUGADOR')\n            .order('created_at', { ascending: false });\n        \n        if (limit) {\n            query = query.limit(limit);\n        }\n\n        const { data, error } = await query;\n        if(error) throw error;\n        return data as FullMessage[];\n    } catch (e) {\n        console.error(\"Error fetching messages for user\", JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n\nexport const getNotificationFeedForUser = cache(async (userId: string) => {\n    try {\n        const [messages, battleReports, espionageReports] = await Promise.all([\n            getMessagesForUser(userId, 50),\n            getBattleReportsForUser(userId, 50),\n            getEspionageReportsForUser(userId, 50)\n        ]);\n\n        const messageFeed = messages.map(m => ({ ...m, type: 'message' as const }));\n        const battleFeed = battleReports.map(b => ({ ...b, type: 'battle' as const }));\n        const espionageFeed = espionageReports.map(e => ({ ...e, type: 'espionage' as const }));\n\n        const combinedFeed = [...messageFeed, ...battleFeed, ...espionageFeed];\n\n        combinedFeed.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());\n\n        return combinedFeed;\n    } catch (e) {\n        console.error(\"Error fetching notification feed for user\", JSON.stringify(e, null, 2));\n        return [];\n    }\n});\n\n\nexport const getUsers = cache(async (): Promise<{ id: string; name: string; familyMember: { familyId: string } | null }[]> => {\n    // We use admin client here because 'User' table RLS prevents listing other users\n    const supabase = createAdminClient();\n    try {\n        const query = supabase\n            .from('User')\n            .select('id, name, familyMember:FamilyMember(familyId)');\n\n        type UsersQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n\n        if(error) throw error;\n        \n        // Supabase-js v2 puede devolver un array para relaciones uno a uno, lo aplanamos.\n        return (data as UsersQuery)?.map((u: any) => {\n            const familyMember = Array.isArray(u.familyMember) ? u.familyMember[0] : u.familyMember;\n            return {\n                id: u.id,\n                name: u.name,\n                familyMember: familyMember || null\n            };\n        }) || [];\n    } catch (error) {\n        console.error(\"Error fetching users:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n\nexport const getUsersAdmin = cache(async () => {\n    // We use admin client here because 'User' table RLS prevents listing other users\n    const supabase = createAdminClient();\n    try {\n        const query = supabase\n            .from('User')\n            .select('id, name, email, avatarUrl, familyMember:FamilyMember(familyId)');\n\n        type UsersAdminQuery = QueryData<typeof query>;\n        const { data, error } = await query;\n\n        if(error) throw error;\n\n        // Supabase-js v2 puede devolver un array para relaciones uno a uno, lo aplanamos.\n        return (data as UsersAdminQuery)?.map((u: any) => {\n            const familyMember = Array.isArray(u.familyMember) ? u.familyMember[0] : u.familyMember;\n            return {\n                ...u,\n                familyMember: familyMember || null\n            };\n        }) || [];\n    } catch (error) {\n        console.error(\"Error fetching users:\", JSON.stringify(error, null, 2));\n        return [];\n    }\n});\n",
    "src/lib/data/auth-utils.ts": "import 'server-only';\nimport { cache } from 'react';\nimport { createClient } from '@/utils/supabase/server';\nimport { getUserWithProgressById } from './user';\nimport { Database } from '@/types/database';\n\nexport const getSessionUser = cache(async () => {\n    const supabase = await createClient();\n    try {\n        const { data: { user: authUser }, error } = await supabase.auth.getUser();\n        if (error || !authUser) return null;\n        \n        let dbUser = await getUserWithProgressById(authUser.id);\n        \n        // ZOMBIE USER DETECTION & SELF-REPAIR\n        // If dbUser is null OR (user exists but has no property), we attempt repair.\n        // The check (dbUser.propiedades.length === 0) handles cases where User row exists but setup failed mid-way.\n        if (!dbUser || (dbUser.propiedades && dbUser.propiedades.length === 0)) {\n             console.info(`[System] Zombie User detected (ID: ${authUser.id}). Initiating self-repair sequence...`);\n\n             try {\n                // The new RPC function that is safe to call\n                const { data: repairResult, error: rpcError } = await supabase.rpc('setup_new_user_game_data_rpc' as any, {\n                    p_user_id: authUser.id\n                });\n\n                if (rpcError) {\n                    console.error(\"[System] Self-repair failed:\", rpcError);\n                } else {\n                    console.info(`[System] Self-repair result: ${repairResult}`);\n                    // Wait a moment for DB propagation\n                    await new Promise(resolve => setTimeout(resolve, 500));\n\n                    // Retry fetch\n                    dbUser = await getUserWithProgressById(authUser.id);\n                }\n             } catch (repairError) {\n                 console.error(\"[System] Critical error during self-repair:\", repairError);\n             }\n        }\n\n        if (!dbUser) {\n            console.error(`User profile not found after repair attempt for user ID: ${authUser.id}. Check RLS policies.`);\n            return null;\n        }\n\n        return dbUser;\n    } catch (e: any) {\n        // This will catch the \"permission denied\" error from getUserWithProgressById\n        console.error(\"🔥🔥 ERROR CRÍTICO FETCHING SESSION USER 🔥🔥\"); \n        console.error(\"Mensaje:\", e?.message || e); \n        console.error(\"Detalle completo:\", JSON.stringify(e, Object.getOwnPropertyNames(e), 2)); \n        return null;\n    }\n});\n",
    "src/lib/constants/game-config.ts": "export const GAME_CONFIG = {\n  TROOPS: {\n    // Divisor for sqrt(level) in skill bonuses (e.g., Contrabando, Rutas)\n    // Formula: 1 + sqrt(level) / SKILL_LEVEL_DIVISOR\n    SKILL_LEVEL_DIVISOR: 10,\n  },\n  SCORING: {\n    ATTACK_POWER: {\n      EXPONENT_BASE: 4.5,\n      HONOR_DIVISOR: 10,\n      POWER_DIVISOR: 10000000,\n      PERCENTAGE_MULTIPLIER: 100,\n    }\n  },\n  TIME: {\n    SECONDS_PER_HOUR: 3600,\n    MIN_CONSTRUCTION_TIME: 5, // Math.max(5, ...)\n  },\n  MISSIONS: {\n    // 0.21989 - Base constant for travel duration formula\n    TRAVEL_DURATION_CONSTANT: 0.21989,\n    // 15 - Height factor for virtual coordinates (Neighborhood)\n    COORDINATE_BLOCK_HEIGHT: 15,\n    // 17 - Width factor for virtual coordinates (City/Building)\n    COORDINATE_CITY_WIDTH: 17,\n    // 86400 - Seconds in a day\n    SECONDS_PER_DAY: 86400,\n    // 10 - Divisor for cost calculation based on salary\n    COST_SALARY_DIVISOR: 10,\n    // Exponents for formulas\n    DURATION_VELOCITY_EXPONENT: -0.2,\n    DURATION_DISTANCE_EXPONENT: 0.2,\n    COST_DISTANCE_EXPONENT: 0.8,\n  },\n  ROOMS: {\n    JEFE_OFFICE: {\n      // Base time for Jefe Office construction formula\n      BASE_TIME: 300,\n    },\n    PRODUCTION: {\n      ARMERIA_BASE: 10,\n      MUNICION_BASE: 20,\n      MUNICION_OFFSET: 20,\n      CERVECERIA_BASE_FACTOR: 10,\n      CERVECERIA_OFFSET_MULTIPLIER: 2,\n      CERVECERIA_FINAL_MULTIPLIER: 5,\n      TABERNA_BASE: 2,\n      CONTRABANDO_BASE: 21,\n    },\n    CONSUMPTION: {\n      TABERNA_DOLLAR_FACTOR: 7,\n      TABERNA_OFFSET: 3,\n      CONTRABANDO_DOLLAR_FACTOR: 4,\n      CONTRABANDO_OFFSET: 1,\n    }\n  }\n};\n",
    "src/lib/import-utils.ts": "\nexport function parseCsv(csvText: string): { headers: string[], rows: string[][] } {\n    const lines = csvText.trim().split(/\\r?\\n/);\n    if (lines.length === 0) {\n        return { headers: [], rows: [] };\n    }\n    \n    const parseLine = (line: string) => {\n        const fields = [];\n        let currentField = '';\n        let inQuotes = false;\n        for (let i = 0; i < line.length; i++) {\n            const char = line[i];\n            if (char === '\"') {\n                if (inQuotes && line[i+1] === '\"') {\n                    currentField += '\"';\n                    i++; // Skip next quote\n                } else {\n                    inQuotes = !inQuotes;\n                }\n            } else if (char === ',' && !inQuotes) {\n                fields.push(currentField);\n                currentField = '';\n            } else {\n                currentField += char;\n            }\n        }\n        fields.push(currentField);\n        return fields;\n    };\n    \n    const headers = parseLine(lines[0]);\n    const rows = lines.slice(1).map(line => parseLine(line));\n\n    return { headers, rows };\n}\n\n\n// Placeholder for a more complex SQL parser if needed in the future\nexport function parseSqlInsert(sqlText: string) {\n    // This is a complex task. For now, we can just throw an error\n    // or try to handle a very specific \"INSERT INTO ... VALUES (...)\" format.\n    throw new Error(\"La importación de SQL no está implementada todavía.\");\n}\n",
    "src/lib/formulas/room-formulas.ts": "import type { FullConfiguracionHabitacion, FullPropiedad } from '@/types';\nimport { BASE_STORAGE_CAPACITY, ID_CAMPO_ENTRENAMIENTO, ID_ESCUELA_ESPECIALIZACION, ID_OFICINA_JEFE, STORAGE_CAPACITY_PER_LEVEL } from '../constants';\nimport { GAME_CONFIG } from '../constants/game-config';\n\nexport interface ProductionData {\n  produccionBruta: number;\n  consumoTotal: number;\n  produccionNeta: number;\n}\n\n\n/**\n * Calcula los costos de recursos para construir o mejorar una habitación a un nivel específico.\n * @see Database Function: calcular_costo_habitacion (partial logic)\n */\nexport function calcularCostosNivel(\n  nivel: number,\n  config: FullConfiguracionHabitacion\n): { armas: number; municion: number; dolares: number } {\n  if (nivel <= 1) {\n    return { armas: Number(config.costoArmas), municion: Number(config.costoMunicion), dolares: Number(config.costoDolares) };\n  }\n\n  // Adjusted formula: (Nivel + 1)^2\n  const factor = Math.pow(nivel + 1, 2);\n\n  const costoArmas = Math.floor(Number(config.costoArmas) * factor);\n  const costoMunicion = Math.floor(Number(config.costoMunicion) * factor);\n  const costoDolares = Math.floor(Number(config.costoDolares) * factor);\n\n  return { armas: costoArmas, municion: costoMunicion, dolares: costoDolares };\n}\n\n/**\n * Calcula el tiempo de construcción para una habitación a un nivel específico.\n * @see Database Function: calcular_tiempo_construccion\n */\nexport function calcularTiempoConstruccion(\n  nivel: number,\n  config: FullConfiguracionHabitacion,\n  nivelOficinaJefe: number\n): number {\n  if (nivel <= 0) {\n    return config.duracion;\n  }\n\n  if (config.id === ID_OFICINA_JEFE) {\n    if (nivel <= 1) {\n        return config.duracion;\n    }\n    // Fórmula Informe: FLOOR( ((Nivel+1)*300 + 300) / (Nivel-1) )\n    // Asumimos tiempoBase (300) = config.duracion\n    const tiempoBase = config.duracion;\n    return Math.floor(((nivel + 1) * tiempoBase + tiempoBase) / (nivel - 1));\n  }\n\n  const divisorOficina = Math.max(1, nivelOficinaJefe);\n  \n  // Adjusted formula: (duracionBase * (Nivel + 1)^2) / Math.max(1, nivelOficinaJefe)\n  const tiempoFinal = (config.duracion * Math.pow(nivel + 1, 2)) / divisorOficina;\n\n  return Math.max(GAME_CONFIG.TIME.MIN_CONSTRUCTION_TIME, Math.floor(tiempoFinal));\n}\n\n/**\n * @see Database Function: calcular_produccion_armeria\n */\nfunction calcularProduccionArmeria(nivel: number): number {\n  if (nivel <= 0) return 0;\n  return Math.trunc(GAME_CONFIG.ROOMS.PRODUCTION.ARMERIA_BASE * Math.pow((nivel + 1) / 2, 2));\n}\n\n/**\n * @see Database Function: calcular_produccion_municion\n */\nfunction calcularProduccionMunicion(nivel: number): number {\n  if (nivel <= 0) return 0;\n  return Math.trunc(GAME_CONFIG.ROOMS.PRODUCTION.MUNICION_BASE * Math.pow((nivel + 1) / 2, 2) + GAME_CONFIG.ROOMS.PRODUCTION.MUNICION_OFFSET);\n}\n\n/**\n * @see Database Function: calcular_produccion_cerveceria\n */\nfunction calcularProduccionCerveceria(nivel: number): number {\n    if (nivel <= 0) return 0;\n    const signo = Math.sign(nivel);\n    const entero = Math.trunc(nivel / 2);\n    const residuo = nivel % 2;\n    const residuoMasUno = (nivel + 1) % 2;\n  \n    const calculoIntermedio = ((1 + entero) * entero + (entero + 1) * residuo) * GAME_CONFIG.ROOMS.PRODUCTION.CERVECERIA_BASE_FACTOR + (residuoMasUno * GAME_CONFIG.ROOMS.PRODUCTION.CERVECERIA_OFFSET_MULTIPLIER);\n    return signo * calculoIntermedio * GAME_CONFIG.ROOMS.PRODUCTION.CERVECERIA_FINAL_MULTIPLIER;\n}\n\n/**\n * @see Database Function: calcular_produccion_taberna\n */\nfunction calcularProduccionTaberna(nivel: number): number {\n    if (nivel <= 0) return 0;\n    return Math.trunc(GAME_CONFIG.ROOMS.PRODUCTION.TABERNA_BASE * Math.pow((nivel + 1) / 2, 2));\n}\n\n/**\n * @see Database Function: calcular_produccion_contrabando\n */\nfunction calcularProduccionContrabando(nivel: number): number {\n    if (nivel <= 0) return 0;\n    return Math.trunc(GAME_CONFIG.ROOMS.PRODUCTION.CONTRABANDO_BASE * Math.pow((nivel + 1) / 2, 2));\n}\n\n/**\n * Maps room ID to specific production formula.\n * @see Database Function: calcular_produccion_recursos (case statement)\n */\nexport function calcularProduccionRecurso(idHabitacion: string, nivel: number): number {\n  switch (idHabitacion) {\n    case 'armeria':\n      return calcularProduccionArmeria(nivel);\n    case 'almacen_de_municion':\n      return calcularProduccionMunicion(nivel);\n    case 'cerveceria':\n      return calcularProduccionCerveceria(nivel);\n    case 'taberna':\n      return calcularProduccionTaberna(nivel);\n    case 'contrabando':\n      return calcularProduccionContrabando(nivel);\n    default:\n      return 0;\n  }\n}\n\nexport function calcularConsumoAlcoholTaberna(produccionDolares: number): number {\n    return (produccionDolares * GAME_CONFIG.ROOMS.CONSUMPTION.TABERNA_DOLLAR_FACTOR) + GAME_CONFIG.ROOMS.CONSUMPTION.TABERNA_OFFSET;\n}\n\nexport function calcularConsumoAlcoholContrabando(produccionDolares: number): number {\n    return (produccionDolares * GAME_CONFIG.ROOMS.CONSUMPTION.CONTRABANDO_DOLLAR_FACTOR) + GAME_CONFIG.ROOMS.CONSUMPTION.CONTRABANDO_OFFSET;\n}\n\n/**\n * Orchestrates production calculation including consumption logic.\n * @see Database Function: actualizar_recursos\n */\nexport function calcularProduccionTotalPorSegundo(propiedad: FullPropiedad): { armas: ProductionData, municion: ProductionData, alcohol: ProductionData, dolares: ProductionData } {\n  const empty = { produccionBruta: 0, consumoTotal: 0, produccionNeta: 0 };\n  if (!propiedad || !Array.isArray(propiedad.habitaciones)) {\n    return { armas: empty, municion: empty, alcohol: empty, dolares: empty };\n  }\n\n  let produccionArmasPorHora = 0;\n  let produccionMunicionPorHora = 0;\n  let produccionAlcoholBrutaPorHora = 0;\n\n  const nivelTaberna = propiedad.habitaciones.find(h => h.configuracionHabitacionId === 'taberna')?.nivel || 0;\n  const nivelContrabando = propiedad.habitaciones.find(h => h.configuracionHabitacionId === 'contrabando')?.nivel || 0;\n\n  propiedad.habitaciones.forEach(habitacion => {\n      const config = habitacion.configuracionHabitacion;\n      if (!config || !config.produccionRecurso || habitacion.nivel === 0) return;\n\n      const produccionPorHora = calcularProduccionRecurso(config.id, habitacion.nivel);\n      \n      switch (config.produccionRecurso) {\n          case 'armas':\n              produccionArmasPorHora += produccionPorHora;\n              break;\n          case 'municion':\n              produccionMunicionPorHora += produccionPorHora;\n              break;\n          case 'alcohol':\n              produccionAlcoholBrutaPorHora += produccionPorHora;\n              break;\n      }\n  });\n\n  let produccionDolaresTabernaPorHora = calcularProduccionRecurso('taberna', nivelTaberna) || 0;\n  let consumoAlcoholTaberna = calcularConsumoAlcoholTaberna(produccionDolaresTabernaPorHora) || 0;\n  \n  let produccionDolaresContrabandoPorHora = calcularProduccionRecurso('contrabando', nivelContrabando) || 0;\n  let consumoAlcoholContrabando = calcularConsumoAlcoholContrabando(produccionDolaresContrabandoPorHora) || 0;\n  \n  let consumoTotalAlcohol = consumoAlcoholTaberna + consumoAlcoholContrabando;\n  let produccionNetaAlcoholPorHora = produccionAlcoholBrutaPorHora - consumoTotalAlcohol;\n\n\n  if (produccionNetaAlcoholPorHora < 0) {\n      let alcoholDisponible = produccionAlcoholBrutaPorHora;\n\n      if (alcoholDisponible >= consumoAlcoholTaberna) {\n          alcoholDisponible -= consumoAlcoholTaberna;\n          if(alcoholDisponible < consumoAlcoholContrabando){\n            produccionDolaresContrabandoPorHora = Math.max(0, (alcoholDisponible - 1) / 4);\n          }\n      } else {\n          produccionDolaresTabernaPorHora = Math.max(0, (alcoholDisponible - 3) / 7);\n          produccionDolaresContrabandoPorHora = 0; \n      }\n  }\n\n  const produccionDolaresPorHora = produccionDolaresTabernaPorHora + produccionDolaresContrabandoPorHora;\n\n  return {\n    armas: { produccionBruta: produccionArmasPorHora || 0, consumoTotal: 0, produccionNeta: produccionArmasPorHora || 0 },\n    municion: { produccionBruta: produccionMunicionPorHora || 0, consumoTotal: 0, produccionNeta: produccionMunicionPorHora || 0 },\n    alcohol: { produccionBruta: produccionAlcoholBrutaPorHora || 0, consumoTotal: consumoTotalAlcohol || 0, produccionNeta: produccionNetaAlcoholPorHora || 0 },\n    dolares: { produccionBruta: produccionDolaresPorHora || 0, consumoTotal: 0, produccionNeta: produccionDolaresPorHora || 0 },\n  };\n}\n\n\n/**\n * Calcula la capacidad de almacenamiento de recursos de una propiedad.\n * @param propiedad - La propiedad con sus habitaciones.\n * @returns Un objeto con la capacidad máxima de cada recurso.\n */\nexport function calculateStorageCapacity(propiedad: FullPropiedad): { armas: number, municion: number, alcohol: number, dolares: number } {\n    let capacidadArmas = BASE_STORAGE_CAPACITY;\n    let capacidadMunicion = BASE_STORAGE_CAPACITY;\n    let capacidadAlcohol = BASE_STORAGE_CAPACITY;\n    let capacidadDolares = BASE_STORAGE_CAPACITY;\n\n    if (!propiedad || !Array.isArray(propiedad.habitaciones)) {\n        return {\n            armas: capacidadArmas,\n            municion: capacidadMunicion,\n            alcohol: capacidadAlcohol,\n            dolares: capacidadDolares,\n        };\n    }\n\n    const almacenArmas = propiedad.habitaciones.find(h => h.configuracionHabitacionId === 'almacen_de_armas');\n    if (almacenArmas) {\n        capacidadArmas += almacenArmas.nivel * STORAGE_CAPACITY_PER_LEVEL;\n    }\n\n    const depositoMunicion = propiedad.habitaciones.find(h => h.configuracionHabitacionId === 'deposito_de_municion');\n    if (depositoMunicion) {\n        capacidadMunicion += depositoMunicion.nivel * STORAGE_CAPACITY_PER_LEVEL;\n    }\n\n    const almacenAlcohol = propiedad.habitaciones.find(h => h.configuracionHabitacionId === 'almacen_de_alcohol');\n    if (almacenAlcohol) {\n        capacidadAlcohol += almacenAlcohol.nivel * STORAGE_CAPACITY_PER_LEVEL;\n    }\n\n    const cajaFuerte = propiedad.habitaciones.find(h => h.configuracionHabitacionId === 'caja_fuerte');\n    if (cajaFuerte) {\n        capacidadDolares += cajaFuerte.nivel * STORAGE_CAPACITY_PER_LEVEL;\n    }\n\n    return {\n        armas: capacidadArmas,\n        municion: capacidadMunicion,\n        alcohol: capacidadAlcohol,\n        dolares: capacidadDolares,\n    };\n}\n",
    "src/lib/formulas/mission-formulas.test.ts": "import { expect, test, describe } from \"vitest\";\nimport { calcularDistancia, calcularDuracionViaje, calcularCosteMision, type CoordenadasJuego } from \"./mission-formulas\";\n\ndescribe(\"Core 2010 Logic\", () => {\n  const origen: CoordenadasJuego = { ciudad: 35, barrio: 42, edificio: 41 };\n  const destino: CoordenadasJuego = { ciudad: 21, barrio: 50, edificio: 214 };\n  const exactDist = calcularDistancia(origen, destino); // ~268.56\n\n  test(\"Calcula distancia tutorial (35:42:41 -> 21:50:214)\", () => {\n    expect(exactDist).toBeCloseTo(268.56, 1);\n  });\n\n  test(\"Calcula Duracion Viaje (Constant 0.21989, Exact Distance)\", () => {\n    // Formula: 0.21989 * (5850^-0.2) * (268.56^0.2) * 86400\n    // Result is ~10258 seconds.\n    const speed = 5850;\n    const duration = calcularDuracionViaje(exactDist, speed);\n\n    expect(duration).toBeGreaterThan(10250);\n    expect(duration).toBeLessThan(10270);\n  });\n\n  test(\"Calcula Coste Mision (Exact Distance)\", () => {\n    // Formula: (TotalSalario / 10) * (Dist^0.8)\n    // Salario 1000. Dist 268.56.\n    // 100 * (268.56^0.8)\n    // 268.56^0.8 = 87.75\n    // Result ~8775\n    const tropas = [{ cantidad: 10, salario: 100 }]; // Total 1000\n    const coste = calcularCosteMision(exactDist, tropas);\n\n    expect(coste).toBeGreaterThan(8770);\n    expect(coste).toBeLessThan(8780);\n  });\n});\n",
    "src/lib/formulas/troop-formulas.ts": "import { ID_TROPAS_ENCARGOS, ID_TROPAS_RUTAS } from '../constants';\nimport { GAME_CONFIG } from '../constants/game-config';\n\ninterface StatsBase {\n  id: string;\n  ataque: number;\n  defensa: number;\n  capacidad: number;\n  velocidad: number | string;\n  tipo: string;\n  salario: number;\n}\n\ninterface ConfiguracionTropa extends StatsBase {\n  bonusAtaque?: string[] | null;\n  bonusDefensa?: string[] | null;\n}\n\n/**\n * Calcula las estadísticas finales de una tropa (Legacy 2010).\n * Bonificaciones Multiplicativas. Redondeo al entero más cercano.\n */\nexport function calcularStatsTropa(\n  tropa: ConfiguracionTropa,\n  niveles: Record<string, number>\n) {\n  // 1. Capacidad (Carga) - Contrabando\n  // Fórmula: Base * (1 + sqrt(Nivel)/10)\n  let capacidadReal = tropa.capacidad;\n  if (tropa.capacidad > 0) {\n    const nivelContrabando = niveles['contrabando'] || 0;\n    if (nivelContrabando > 0) {\n      // Ejemplo: 40000 * (1 + sqrt(8)/10) = 51313.7 -> 51313.\n      capacidadReal = Math.floor(tropa.capacidad * (1 + Math.sqrt(nivelContrabando) / GAME_CONFIG.TROOPS.SKILL_LEVEL_DIVISOR));\n    }\n  }\n\n  // 2. Velocidad (Logística)\n  // Rutas (Matón-Pistolero) vs Encargos (FBI-Mercenario)\n  let velocidadReal = Number(tropa.velocidad);\n  if (velocidadReal > 0) {\n      if (ID_TROPAS_RUTAS.includes(tropa.id)) {\n          const nivelRutas = niveles['rutas'] || 0;\n          if (nivelRutas > 0) {\n              velocidadReal = Math.floor(velocidadReal * (1 + Math.sqrt(nivelRutas) / GAME_CONFIG.TROOPS.SKILL_LEVEL_DIVISOR));\n          }\n      } else if (ID_TROPAS_ENCARGOS.includes(tropa.id)) {\n          const nivelEncargos = niveles['encargos'] || 0;\n          if (nivelEncargos > 0) {\n              velocidadReal = Math.floor(velocidadReal * (1 + Math.sqrt(nivelEncargos) / GAME_CONFIG.TROOPS.SKILL_LEVEL_DIVISOR));\n          }\n      }\n  }\n\n  // 3. Combate (Ataque) - Multiplicativo\n  // Ejemplo: 100 * (1.28) * (1.26) * (1.2) = 195 (ROUND)\n  let ataqueReal = tropa.ataque;\n  if (tropa.bonusAtaque && tropa.bonusAtaque.length > 0) {\n      let multiplier = 1.0;\n      tropa.bonusAtaque.forEach(bonusId => {\n          const nivel = niveles[bonusId] || 0;\n          if (nivel > 0) {\n              multiplier *= (1 + Math.sqrt(nivel) / GAME_CONFIG.TROOPS.SKILL_LEVEL_DIVISOR);\n          }\n      });\n      ataqueReal = Math.round(tropa.ataque * multiplier);\n  }\n\n  // 4. Combate (Defensa) - Multiplicativo\n  let defensaReal = tropa.defensa;\n  if (tropa.bonusDefensa && tropa.bonusDefensa.length > 0) {\n      let multiplier = 1.0;\n      tropa.bonusDefensa.forEach(bonusId => {\n          const nivel = niveles[bonusId] || 0;\n          if (nivel > 0) {\n              multiplier *= (1 + Math.sqrt(nivel) / GAME_CONFIG.TROOPS.SKILL_LEVEL_DIVISOR);\n          }\n      });\n      defensaReal = Math.round(tropa.defensa * multiplier);\n  }\n\n  return {\n    ataqueActual: ataqueReal,\n    defensaActual: defensaReal,\n    capacidadActual: capacidadReal,\n    velocidadActual: velocidadReal,\n    salarioActual: tropa.salario\n  };\n}\n\nexport function calcularTiempoReclutamiento(\n  config: { duracion: number },\n  cantidad: number,\n  nivelEdificio: number\n): number {\n  if (cantidad <= 0) return 0;\n  const divisor = Math.max(1, nivelEdificio);\n  const tiempoTotal = (config.duracion / divisor) * cantidad;\n  return Math.max(1, Math.floor(tiempoTotal));\n}\n",
    "src/lib/formulas/score-formulas.ts": "import type { UserWithProgress } from \"../data\";\nimport type { FullPropiedad } from '@/types';\nimport { EntrenamientoUsuario, ConfiguracionEntrenamiento } from \"@/types\";\nimport { GAME_CONFIG } from '../constants/game-config';\n\nexport function calcularPuntosHabitaciones(propiedades: FullPropiedad[]): number {\n  if (!propiedades || propiedades.length === 0) return 0;\n\n  return propiedades.reduce((totalPuntos, propiedad) => {\n    if (!propiedad || !Array.isArray(propiedad.habitaciones)) {\n        return totalPuntos;\n    }\n    const puntosPropiedad = propiedad.habitaciones.reduce((subtotal, habitacion) => {\n      return subtotal + (habitacion.configuracionHabitacion.puntos * habitacion.nivel);\n    }, 0);\n    return totalPuntos + puntosPropiedad;\n  }, 0);\n}\n\n\nexport function calcularPuntosPropiedad(propiedad: FullPropiedad): number {\n    if (!propiedad) return 0;\n    \n    const puntosHabitaciones = (propiedad.habitaciones || []).reduce((totalHabitaciones, habitacion) => {\n        const puntos = habitacion.configuracionHabitacion.puntos * habitacion.nivel;\n        return totalHabitaciones + puntos;\n    }, 0);\n\n    const puntosTropas = (propiedad.TropaUsuario || []).reduce((totalTropas, tropa) => {\n        const puntos = tropa.configuracionTropa.puntos * tropa.cantidad;\n        return totalTropas + puntos;\n    }, 0);\n    \n    const puntosSeguridad = (propiedad.TropaSeguridadUsuario || []).reduce((totalSeguridad, tropa) => {\n        const puntos = tropa.configuracionTropa.puntos * tropa.cantidad;\n        return totalSeguridad + puntos;\n    }, 0);\n\n    return puntosHabitaciones + puntosTropas + puntosSeguridad;\n}\n\nexport function calcularPuntosTropas(propiedades: FullPropiedad[]): number {\n    if (!propiedades || propiedades.length === 0) return 0;\n  \n  return propiedades.reduce((totalPropiedades, propiedad) => {\n    if (!propiedad) return totalPropiedades;\n\n    const puntosTropas = (propiedad.TropaUsuario || []).reduce((totalTropas, tropa) => {\n      const puntos = tropa.configuracionTropa.puntos * tropa.cantidad;\n      return totalTropas + puntos;\n    }, 0);\n\n    const puntosSeguridad = (propiedad.TropaSeguridadUsuario || []).reduce((totalSeguridad, tropa) => {\n        const puntos = tropa.configuracionTropa.puntos * tropa.cantidad;\n        return totalSeguridad + puntos;\n    }, 0);\n    return totalPropiedades + puntosTropas + puntosSeguridad;\n  }, 0);\n}\n\nexport function calcularPuntosEntrenamientos(entrenamientos: (EntrenamientoUsuario & { configuracionEntrenamiento: ConfiguracionEntrenamiento })[]): number {\n  if (!entrenamientos || entrenamientos.length === 0) return 0;\n\n  return entrenamientos.reduce((total, entrenamiento) => {\n    if (entrenamiento && entrenamiento.configuracionEntrenamiento) {\n      const puntos = entrenamiento.configuracionEntrenamiento.puntos * entrenamiento.nivel;\n      return total + puntos;\n    }\n    return total;\n  }, 0);\n}\n\nexport function calcularPoderAtaque(totalPropiedades: number, honor: number): number {\n    if (totalPropiedades < 1) totalPropiedades = 1;\n    if (honor < 0) honor = 0;\n\n    const base = totalPropiedades - 1;\n    const exponent = GAME_CONFIG.SCORING.ATTACK_POWER.EXPONENT_BASE - (honor / GAME_CONFIG.SCORING.ATTACK_POWER.HONOR_DIVISOR);\n    \n    if (base < 0 && exponent % 1 !== 0) {\n        return 0; \n    }\n\n    const powerCalculation = Math.pow(base, exponent);\n    \n    if (isNaN(powerCalculation)) {\n        return 0; \n    }\n\n    const poder = 1 / (1 + powerCalculation / GAME_CONFIG.SCORING.ATTACK_POWER.POWER_DIVISOR);\n    \n    return poder * GAME_CONFIG.SCORING.ATTACK_POWER.PERCENTAGE_MULTIPLIER;\n}\n",
    "src/lib/formulas/troop-formulas.test.ts": "\nimport { describe, it, expect } from 'vitest';\nimport { calcularStatsTropa } from './troop-formulas';\n\ndescribe('calcularStatsTropa', () => {\n    // 1. Setup Base Data\n    const baseTroop = {\n        id: 'acuchillador', // Not maton\n        ataque: 100,\n        defensa: 100,\n        capacidad: 100,\n        velocidad: 100,\n        tipo: 'ATAQUE',\n        salario: 100,\n        bonusAtaque: ['entrenamiento_A'],\n        bonusDefensa: ['entrenamiento_D']\n    };\n\n    it('should return base stats when no training levels are provided', () => {\n        const result = calcularStatsTropa(baseTroop, {});\n        expect(result.ataqueActual).toBe(100);\n        expect(result.defensaActual).toBe(100);\n        expect(result.capacidadActual).toBe(100);\n        expect(result.velocidadActual).toBe(100);\n        expect(result.salarioActual).toBe(100);\n    });\n\n    it('should apply attack bonus correctly (1 + sqrt(level)/10)', () => {\n        // Level 25 -> sqrt(25)=5. Factor 1 + 0.5 = 1.5. Result 150.\n        const result = calcularStatsTropa(baseTroop, { 'entrenamiento_A': 25 });\n        expect(result.ataqueActual).toBe(150);\n\n        // Level 100 -> sqrt(100)=10. Factor 1 + 1.0 = 2.0. Result 200.\n        const result2 = calcularStatsTropa(baseTroop, { 'entrenamiento_A': 100 });\n        expect(result2.ataqueActual).toBe(200);\n    });\n\n    it('should apply defense bonus correctly (1 + sqrt(level)/10)', () => {\n         // Level 25 -> Factor 1.5\n        const result = calcularStatsTropa(baseTroop, { 'entrenamiento_D': 25 });\n        expect(result.defensaActual).toBe(150);\n    });\n\n    it('should apply capacity bonus from \"contrabando\" for normal troops', () => {\n         // Level 25 -> Factor 1.5\n        const result = calcularStatsTropa(baseTroop, { 'contrabando': 25 });\n        expect(result.capacidadActual).toBe(150);\n    });\n\n     it('should apply capacity bonus from \"contrabando\" for DEFENSE troops', () => {\n        // New rule: All troops with capacity > 0 get bonus\n        const defenseTroop = { ...baseTroop, tipo: 'DEFENSA' };\n        const result = calcularStatsTropa(defenseTroop, { 'contrabando': 25 });\n        expect(result.capacidadActual).toBe(150);\n    });\n\n    it('should apply capacity bonus from \"contrabando\" for MATON', () => {\n        // New rule: All troops with capacity > 0 get bonus\n        const matonTroop = { ...baseTroop, id: 'maton' };\n        // Level 100 -> Factor 2.0\n        const result = calcularStatsTropa(matonTroop, { 'contrabando': 100 });\n        expect(result.capacidadActual).toBe(200);\n    });\n\n    it('should apply speed bonus for ROUTE troops (maton)', () => {\n         // Maton is in ID_TROPAS_RUTAS. Level 25 -> Factor 1.5\n        const result = calcularStatsTropa({ ...baseTroop, id: 'maton' }, { 'rutas': 25 });\n        expect(result.velocidadActual).toBe(150);\n    });\n    \n    it('should apply speed bonus for MISSION troops (fbi)', () => {\n         // FBI is in ID_TROPAS_ENCARGOS. Level 25 -> Factor 1.5\n         const fbiTroop = { ...baseTroop, id: 'fbi' };\n        const result = calcularStatsTropa(fbiTroop, { 'encargos': 25 });\n        expect(result.velocidadActual).toBe(150);\n    });\n\n    it('should NOT apply speed bonus if wrong training is leveled', () => {\n        // Maton (Rutas) should not benefit from Encargos\n        const result = calcularStatsTropa({ ...baseTroop, id: 'maton' }, { 'encargos': 25 });\n        expect(result.velocidadActual).toBe(100);\n    });\n\n    it('should calculate cumulative attack bonuses correctly', () => {\n        const multiBonusTroop = {\n            ...baseTroop,\n            bonusAtaque: ['train_A', 'train_B']\n        };\n        // train_A Level 25 -> Factor 1.5\n        // train_B Level 25 -> Factor 1.5\n        // Total Multiplier = 1.0 * 1.5 * 1.5 = 2.25\n        // Result 100 * 2.25 = 225\n        const result = calcularStatsTropa(multiBonusTroop, { 'train_A': 25, 'train_B': 25 });\n        expect(result.ataqueActual).toBe(225);\n    });\n});\n",
    "src/lib/formulas/training-formulas.ts": "import type { ConfiguracionEntrenamiento } from '@/types';\n\nexport function calcularCostosEntrenamiento(\n  nivel: number,\n  config: ConfiguracionEntrenamiento\n): { armas: number; municion: number; dolares: number } {\n  if (nivel <= 1) {\n    return { armas: Number(config.costoArmas), municion: Number(config.costoMunicion), dolares: Number(config.costoDolares) };\n  }\n\n  // Adjusted formula: (Nivel + 1)^2\n  const factor = Math.pow(nivel + 1, 2);\n\n  const costoArmas = Math.floor(Number(config.costoArmas) * factor);\n  const costoMunicion = Math.floor(Number(config.costoMunicion) * factor);\n  const costoDolares = Math.floor(Number(config.costoDolares) * factor);\n\n  return { armas: costoArmas, municion: costoMunicion, dolares: costoDolares };\n}\n\nexport function calcularTiempoEntrenamiento(\n  nivel: number,\n  config: ConfiguracionEntrenamiento,\n  nivelEscuela: number\n): number {\n  if (nivel <= 0) {\n    return config.duracion;\n  }\n  \n  // Adjusted formula: (duracionBase * (Nivel + 1)^2) / Math.max(1, nivelEscuela)\n  const divisorNivelEscuela = Math.max(1, nivelEscuela);\n\n  const tiempoFinal = (config.duracion * Math.pow(nivel + 1, 2)) / divisorNivelEscuela;\n  \n  return Math.max(5, Math.floor(tiempoFinal)); // Asegura un tiempo mínimo de 5 segundos.\n}\n",
    "src/lib/formulas/room-logic.ts": "\n\n'use client';\n\nimport type { FullConfiguracionHabitacion, FullPropiedad } from '@/types';\nimport { ROOM_ORDER } from '../constants';\n\n/**\n * Definición de la estructura de un requerimiento de habitación\n */\nexport interface RoomRequirementData {\n  roomId: string;\n  requiredRoomId: string;\n  requiredLevel: number;\n\n}\n\n/**\n * Datos estáticos de los requerimientos de habitaciones\n * Generado a partir del JSON proporcionado\n */\nexport const STATIC_ROOM_REQUIREMENTS: RoomRequirementData[] = [\n    {\n      \"roomId\": \"almacen_de_alcohol\",\n      \"requiredRoomId\": \"cerveceria\",\n      \"requiredLevel\": 5\n  },\n  {\n      \"roomId\": \"deposito_de_municion\",\n      \"requiredRoomId\": \"almacen_de_municion\",\n      \"requiredLevel\": 5\n  },\n  {\n      \"roomId\": \"caja_fuerte\",\n      \"requiredRoomId\": \"oficina_del_jefe\",\n      \"requiredLevel\": 8\n  },\n  {\n      \"roomId\": \"contrabando\",\n      \"requiredRoomId\": \"taberna\",\n      \"requiredLevel\": 5\n  },\n  {\n      \"roomId\": \"torreta_de_fuego_automatico\",\n      \"requiredRoomId\": \"seguridad\",\n      \"requiredLevel\": 2\n  },\n  {\n      \"roomId\": \"minas_ocultas\",\n      \"requiredRoomId\": \"seguridad\",\n      \"requiredLevel\": 2\n  },\n  {\n      \"roomId\": \"caja_fuerte\",\n      \"requiredRoomId\": \"taberna\",\n      \"requiredLevel\": 5\n  },\n  {\n      \"roomId\": \"contrabando\",\n      \"requiredRoomId\": \"cerveceria\",\n      \"requiredLevel\": 8\n  },\n  {\n      \"roomId\": \"seguridad\",\n      \"requiredRoomId\": \"campo_de_entrenamiento\",\n      \"requiredLevel\": 2\n  },\n  {\n      \"roomId\": \"almacen_de_armas\",\n      \"requiredRoomId\": \"armeria\",\n      \"requiredLevel\": 5,\n  },\n  {\n      \"roomId\": \"caja_fuerte\",\n      \"requiredRoomId\": \"cerveceria\",\n      \"requiredLevel\": 8\n  }\n  ];\n\nexport interface AvailableRoom {\n  id: string;\n  nivel: number;\n  meetsRequirements: boolean;\n  requirementsText: string | null;\n  config: FullConfiguracionHabitacion;\n}\n\n/**\n * Filters and sorts rooms to show only those available to the user for a specific property.\n * A room is available if it's already built (level > 0) or if all its requirements are met.\n * @param property The user's property with its current rooms.\n * @param allRoomConfigs All possible room configurations from the database.\n * @returns A sorted array of available rooms with their status.\n */\nexport function getAvailableRoomsForProperty(\n  property: FullPropiedad,\n  allRoomConfigs: FullConfiguracionHabitacion[]\n): AvailableRoom[] {\n  const userRoomsMap = new Map(property.habitaciones.map(h => [h.configuracionHabitacionId, h.nivel]));\n  const allRoomsMap = new Map(allRoomConfigs.map(r => [r.id, r]));\n\n  const roomsData = ROOM_ORDER.map(id => {\n    const config = allRoomsMap.get(id);\n    if (!config) return null;\n\n    const nivel = userRoomsMap.get(id) || 0;\n\n    const requirements = STATIC_ROOM_REQUIREMENTS.filter(r => r.roomId === id);\n    const meetsRequirements = requirements.every(req => (userRoomsMap.get(req.requiredRoomId) || 0) >= req.requiredLevel);\n\n    // Show if no requirements OR if all requirements are met.\n    if (requirements.length === 0 || meetsRequirements) {\n      const requirementsText = !meetsRequirements\n        ? requirements.map(req => `${allRoomsMap.get(req.requiredRoomId)?.nombre || req.requiredRoomId} (Nvl ${req.requiredLevel})`).join(', ')\n        : null;\n\n      return {\n        id: config.id,\n        nivel,\n        meetsRequirements: true, // It's available, so this is true for the UI\n        requirementsText,\n        config,\n      };\n    }\n\n    return null;\n\n  }).filter((r): r is NonNullable<typeof r> => r !== null);\n\n  return roomsData;\n}\n",
    "src/lib/formulas/formulas.test.ts": "\nimport { describe, test, expect } from 'vitest';\nimport { calcularCostosNivel, calcularTiempoConstruccion } from './room-formulas';\nimport { ID_OFICINA_JEFE } from '../constants';\n\ndescribe('Game Formulas Logic', () => {\n    test('Room Cost Level 1 (Base)', () => {\n        const config: any = { costoArmas: 100, costoMunicion: 200, costoDolares: 300 };\n        const cost = calcularCostosNivel(1, config);\n        expect(cost).toEqual({ armas: 100, municion: 200, dolares: 300 });\n    });\n\n    test('Room Cost Level 2 (Target Level)', () => {\n        const config: any = { costoArmas: 100, costoMunicion: 200, costoDolares: 300 };\n        // Formula: Base * (nivel + 1)^2\n        // Level 2: Base * (2 + 1)^2 = Base * 9\n        const cost = calcularCostosNivel(2, config);\n        expect(cost).toEqual({ armas: 900, municion: 1800, dolares: 2700 });\n    });\n\n    test('Oficina de Construccion Time Formula (Special Case)', () => {\n        const config: any = { id: ID_OFICINA_JEFE, duracion: 300 };\n\n        // Formula: ((Nivel+1)*300 + 300) / (Nivel-1)\n\n        // Level 2: ((3)*300 + 300) / 1 = 1200\n        expect(calcularTiempoConstruccion(2, config, 1)).toBe(1200);\n\n        // Level 3: ((4)*300 + 300) / 2 = 750\n        expect(calcularTiempoConstruccion(3, config, 1)).toBe(750);\n\n        // Level 4: ((5)*300 + 300) / 3 = 600\n        expect(calcularTiempoConstruccion(4, config, 1)).toBe(600);\n\n        // Check High Level decrease\n        // Level 10: ((11)*300 + 300) / 9 = 3600 / 9 = 400.\n        // It decreases from 1200 (Lvl 2) to 400 (Lvl 10).\n        expect(calcularTiempoConstruccion(10, config, 1)).toBe(400);\n    });\n\n    test('General Room Time Formula', () => {\n        const config: any = { id: 'some_room', duracion: 300 };\n        // Formula: (duracionBase * (nivel + 1)^2) / Math.max(1, nivelOficinaJefe)\n\n        // Level 2, Jefe 1: 300 * 9 / 1 = 2700\n        expect(calcularTiempoConstruccion(2, config, 1)).toBe(2700);\n\n        // Level 2, Jefe 2: 300 * 9 / 2 = 1350\n        expect(calcularTiempoConstruccion(2, config, 2)).toBe(1350);\n    });\n});\n",
    "src/lib/formulas/mission-formulas.ts": "import { GAME_CONFIG } from '../constants/game-config';\n\nexport interface CoordenadasJuego {\n  ciudad: number;\n  barrio: number;\n  edificio: number;\n}\n\nexport interface CoordenadasVirtuales {\n  altura: number;\n  anchura: number;\n}\n\n/**\n * Convierte coordenadas del juego (C:B:E) a coordenadas virtuales (H:W).\n * Lógica 2010: Lectura de Arriba-Abajo (Y: Barrio, X: Ciudad).\n */\nexport function convertirACoordenadasVirtuales(coords: CoordenadasJuego): CoordenadasVirtuales {\n  // Altura (Y): (Barrio - 1) * 15 + CEIL(Edificio / 17)\n  const altura = (coords.barrio - 1) * GAME_CONFIG.MISSIONS.COORDINATE_BLOCK_HEIGHT + Math.ceil(coords.edificio / GAME_CONFIG.MISSIONS.COORDINATE_CITY_WIDTH);\n\n  // Anchura (X): (Ciudad - 1) * 17 + Columna Relativa\n  const anchura = (coords.ciudad - 1) * GAME_CONFIG.MISSIONS.COORDINATE_CITY_WIDTH + (coords.edificio - (Math.floor((coords.edificio - 1) / GAME_CONFIG.MISSIONS.COORDINATE_CITY_WIDTH) * GAME_CONFIG.MISSIONS.COORDINATE_CITY_WIDTH));\n\n  return { altura, anchura };\n}\n\n/**\n * Calcula distancia Euclidiana.\n */\nexport function calcularDistancia(origen: CoordenadasJuego, destino: CoordenadasJuego): number {\n  const virtOrigen = convertirACoordenadasVirtuales(origen);\n  const virtDestino = convertirACoordenadasVirtuales(destino);\n\n  const diffAltura = virtOrigen.altura - virtDestino.altura;\n  const diffAnchura = virtOrigen.anchura - virtDestino.anchura;\n\n  return Math.sqrt(Math.pow(diffAltura, 2) + Math.pow(diffAnchura, 2));\n}\n\n/**\n * Calcula duración en SEGUNDOS.\n * Constante Oficial: 0.21989\n * Fórmula: 0.21989 * (velocidad^-0.2) * (distancia^0.2)\n */\nexport function calcularDuracionViaje(distancia: number, velocidadFlota: number): number {\n  if (velocidadFlota <= 0 || distancia <= 0) return 0;\n\n  // Usar distancia EXACTA (Float), no redondeada.\n  const CONSTANTE_OFICIAL = GAME_CONFIG.MISSIONS.TRAVEL_DURATION_CONSTANT;\n\n  // Fórmula produce DÍAS\n  const duracionDias = (CONSTANTE_OFICIAL * Math.pow(velocidadFlota, GAME_CONFIG.MISSIONS.DURATION_VELOCITY_EXPONENT)) * Math.pow(distancia, GAME_CONFIG.MISSIONS.DURATION_DISTANCE_EXPONENT);\n\n  // Convertir a Segundos\n  return Math.floor(duracionDias * GAME_CONFIG.MISSIONS.SECONDS_PER_DAY);\n}\n\n/**\n * Calcula Coste de Misión.\n * Fórmula: (TotalSalario / 10) * (Distancia^0.8)\n */\nexport function calcularCosteMision(distancia: number, tropas: { cantidad: number, salario: number }[]): number {\n  const totalSalario = tropas.reduce((sum, tropa) => sum + (tropa.cantidad * tropa.salario), 0);\n  if (totalSalario <= 0 || distancia <= 0) return 0;\n\n  // Usar distancia EXACTA (Float)\n  const factorDistancia = Math.pow(distancia, GAME_CONFIG.MISSIONS.COST_DISTANCE_EXPONENT);\n  const coste = (totalSalario / GAME_CONFIG.MISSIONS.COST_SALARY_DIVISOR) * factorDistancia;\n\n  return Math.floor(coste);\n}\n\nexport function calcularVelocidadFlota(tropasSeleccionadas: { velocidad: number }[]): number {\n  if (tropasSeleccionadas.length === 0) return 0;\n  return Math.min(...tropasSeleccionadas.map(t => t.velocidad));\n}\n",
    "src/lib/auth.ts": "\n'use server';\n\nimport { getSessionUser as getSessionUserFromData } from '@/lib/data/auth-utils';\n\n/**\n * Retrieves the full game user profile based on the current Supabase Auth session.\n * This is the new single source of truth for the logged-in user.\n * NOTE: This function does NOT trigger the game state update. The update is\n * handled by `actualizarEstadoCompletoDelJuego` in the main layout.\n * @returns The complete user profile or null if not authenticated.\n */\nexport async function getSessionUser() {\n    return await getSessionUserFromData();\n}\n",
    "src/lib/safe-action.ts": "import { z } from 'zod';\n\nexport type SafeActionResponse<T> =\n  | { data: T; validationErrors?: never; serverError?: never }\n  | { data?: never; validationErrors: Record<string, string[]>; serverError?: never }\n  | { data?: never; validationErrors?: never; serverError: string };\n\nexport const createSafeAction = <TInput, TOutput, TSchemaInput = TInput>(\n  schema: z.ZodType<TInput, z.ZodTypeDef, TSchemaInput>,\n  handler: (input: TInput) => Promise<TOutput>\n) => {\n  return async (input: TSchemaInput): Promise<SafeActionResponse<TOutput>> => {\n    const validationResult = schema.safeParse(input);\n\n    if (!validationResult.success) {\n      return {\n        validationErrors: validationResult.error.flatten().fieldErrors as Record<string, string[]>,\n      };\n    }\n\n    try {\n      const data = await handler(validationResult.data);\n      return {\n        data,\n      };\n    } catch (error: any) {\n      return {\n        serverError: error.message || \"Something went wrong.\",\n      };\n    }\n  };\n};\n",
    "src/lib/data.ts": "\n// BARREL FILE: src/lib/data.ts\n// This file re-exports all data fetching functions from modularized files.\n// It maintains backward compatibility for existing imports.\n\n// Explicitly import and export functions from each module\nimport {\n    getUserWithProgressById,\n    getMessagesForUser,\n    getNotificationFeedForUser,\n    getUsers,\n    getUserProfileById,\n    getUserTrainings, // Added export\n    getUserProfile,\n    getUserResources,\n    getUserActiveMissions,\n    getUsersAdmin,\n} from './data/user';\n\nimport { getPropertyOwner, getPropertiesByLocation } from './data/property';\n\nimport { getSessionUser } from './data/auth-utils';\n\nimport {\n    getFamilyById,\n    getFamilyByIdWithAllMembersData,\n    getFamilyRequests,\n    getInvitationsForUser\n} from './data/family';\n\nimport {\n    getBattleReportById,\n    getEspionageReportById,\n    getBattleReportsForUser,\n    getEspionageReportsForUser,\n    getRecentBattleReports,\n} from './data/combat';\n\nimport {\n    getRoomConfigurations,\n    getTrainingConfigurations,\n    getTroopConfigurations,\n    getTroopBonusConfig,\n    getMaximumResourceCapacity,\n    getGlobalStatistics\n} from './data/config';\n\nimport { \n    getUsersForRanking, \n    getUsersForHonorRanking,\n    getFamiliesForRanking \n} from './data/ranking';\n\n\nexport {\n    // from user\n    getUserWithProgressById,\n    getMessagesForUser,\n    getNotificationFeedForUser,\n    getUsers,\n    getUserProfileById,\n    getUserTrainings, // Added export\n    getUserProfile,\n    getUserResources,\n    getUserActiveMissions,\n    getUsersAdmin,\n    // from property\n    getPropertyOwner,\n    getPropertiesByLocation,\n    // from auth-utils\n    getSessionUser,\n    // from family\n    getFamilyById,\n    getFamilyByIdWithAllMembersData,\n    getFamilyRequests,\n    getInvitationsForUser,\n    // from combat\n    getBattleReportById,\n    getEspionageReportById,\n    getBattleReportsForUser,\n    getEspionageReportsForUser,\n    getRecentBattleReports,\n    // from config\n    getRoomConfigurations,\n    getTrainingConfigurations,\n    getTroopConfigurations,\n    getTroopBonusConfig,\n    getMaximumResourceCapacity,\n    getGlobalStatistics,\n    // from ranking\n    getUsersForRanking,\n    getUsersForHonorRanking,\n    getFamiliesForRanking,\n};\n\n\n// Re-export specific types for compatibility\nexport type {\n    FullPropiedad,\n    UserWithProgress,\n    FullBattleReport,\n    FullFamily,\n    FullFamilyInvitation,\n    FullConfiguracionEntrenamiento,\n    FullConfiguracionHabitacion,\n    FullConfiguracionTropa,\n    UserForRanking,\n    UserProfileData,\n    FullMessage,\n    PropertyWithOwner,\n    FullEspionageReport,\n    FullTropaUsuario\n} from '@/types';\n",
    "src/lib/utils.ts": "import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n\nexport function formatNumber(num: number | undefined | null): string {\n    if (num === null || num === undefined) return \"0\";\n    if (num < 1000) {\n      return num.toString();\n    }\n    const suffixes = [\"\", \"K\", \"M\", \"B\", \"T\"];\n    const i = Math.floor(Math.log10(num) / 3);\n    \n    // Avoid showing decimals for numbers like 1,000,000 which would become 1.00M\n    const shouldShowDecimal = (num < 1000000 && i > 0);\n    const precision = shouldShowDecimal ? 1 : 0;\n    \n    // Custom logic to handle formatting for numbers just over a threshold\n    let shortValue = num / Math.pow(1000, i);\n    if (i > 0 && shortValue < 10) {\n      shortValue = Math.round(shortValue * 10) / 10; // e.g. 1.5K\n    } else {\n      shortValue = Math.round(shortValue); // e.g. 10K, 150K\n    }\n\n    return shortValue.toString() + suffixes[i];\n}\n  \n\nexport function formatDuration(seconds: number): string {\n    if (seconds <= 0) return \"0s\";\n\n    const units: {name: string, seconds: number}[] = [\n        { name: 'año', seconds: 31536000 },\n        { name: 'sem', seconds: 604800 },\n        { name: 'd', seconds: 86400 },\n        { name: 'h', seconds: 3600 },\n        { name: 'm', seconds: 60 },\n        { name: 's', seconds: 1 }\n    ];\n\n    let remainingSeconds = seconds;\n    let result = '';\n    let parts = 0;\n\n    for (const unit of units) {\n        if (remainingSeconds >= unit.seconds && parts < 3) {\n            const amount = Math.floor(remainingSeconds / unit.seconds);\n            if (amount > 0) {\n                result += `${amount}${unit.name} `;\n                remainingSeconds %= unit.seconds;\n                parts++;\n            }\n        }\n    }\n\n    return result.trim() || '0s';\n}\n\n\nexport function getLastSeenStatus(lastSeen: Date | string | null): { text: string; isOnline: boolean; minutesAgo: number } {\n    if (!lastSeen) return { text: \"Nunca\", isOnline: false, minutesAgo: Infinity };\n\n    const lastSeenDate = typeof lastSeen === 'string' ? new Date(lastSeen) : lastSeen;\n    const now = new Date();\n    const diffSeconds = Math.floor((now.getTime() - lastSeenDate.getTime()) / 1000);\n    const diffMinutes = Math.floor(diffSeconds / 60);\n\n    if (diffMinutes < 5) return { text: \"En Línea\", isOnline: true, minutesAgo: diffMinutes };\n    if (diffMinutes < 60) return { text: `Hace ${diffMinutes}m`, isOnline: false, minutesAgo: diffMinutes };\n    \n    const diffHours = Math.floor(diffMinutes / 60);\n    if (diffHours < 24) return { text: `Hace ${diffHours}h`, isOnline: false, minutesAgo: diffMinutes };\n\n    const diffDays = Math.floor(diffHours / 24);\n    return { text: `Hace ${diffDays}d`, isOnline: false, minutesAgo: diffMinutes };\n}\n",
    "src/lib/auth-admin.ts": "\n'use server';\n\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { ADMIN_COOKIE_NAME } from \"./constants\";\n\nconst ADMIN_PASSWORD = 'admin'; // Store this in environment variables in a real app\n\nexport async function loginAdmin(password: string) {\n    if (password !== ADMIN_PASSWORD) {\n        return { success: false, error: \"Contraseña incorrecta.\" };\n    }\n\n    (await cookies()).set(ADMIN_COOKIE_NAME, 'true', {\n        httpOnly: true,\n        secure: process.env.NODE_ENV === 'production',\n        maxAge: 60 * 60 * 8, // 8 hours\n        path: '/',\n    });\n    \n    // We can't redirect here because this might be called in a transition\n    // The component calling this should handle the redirect\n    return { success: true };\n}\n\nexport async function logoutAdmin() {\n    (await cookies()).delete(ADMIN_COOKIE_NAME);\n    redirect('/admin');\n}\n\nexport async function getAdminSession(): Promise<boolean> {\n    // DEVELOPMENT BYPASS: Always return true\n    return Promise.resolve(true);\n}\n\nexport async function verifyAdminSession(): Promise<boolean> {\n    // DEVELOPMENT BYPASS: Always return true\n    return Promise.resolve(true);\n}\n",
    "src/lib/schemas.ts": "\nimport { z } from 'zod';\n\n// =================================================================\n// AUTH SCHEMAS\n// =================================================================\nexport const LoginSchema = z.object({\n  email: z.string().email(\"Debe ser un correo electrónico válido.\"),\n  password: z.string().min(6, \"La contraseña debe tener al menos 6 caracteres.\"),\n});\n\nexport const RegisterSchema = z.object({\n    email: z.string().email(\"Correo electrónico inválido.\"),\n    username: z.string().min(3, \"El nombre de usuario debe tener al menos 3 caracteres.\").max(20),\n    password: z.string().min(6, \"La contraseña debe tener al menos 6 caracteres.\"),\n    locationMode: z.enum(['random', 'manual']).default('random'),\n    coordinates: z.object({\n        ciudad: z.number().int().min(1).max(50),\n        barrio: z.number().int().min(1).max(50),\n        edificio: z.number().int().min(1).max(255),\n    }).optional(),\n}).refine((data) => {\n    if (data.locationMode === 'manual') {\n        return !!data.coordinates;\n    }\n    return true;\n}, {\n    message: \"Coordenadas requeridas para ubicación manual\",\n    path: [\"coordinates\"],\n});\n\n\n// =================================================================\n// GAME ACTION SCHEMAS\n// =================================================================\n\nexport const RecruitTroopsSchema = z.object({\n  propiedadId: z.string().uuid(\"ID de propiedad inválido.\"),\n  tropaId: z.string().min(1, \"Debe seleccionar una tropa.\"),\n  cantidad: z.number().int().positive(\"La cantidad debe ser mayor que cero.\"),\n});\nexport type RecruitTroopsInput = z.infer<typeof RecruitTroopsSchema>;\n\nexport const SendMissionSchema = z.object({\n  origenPropiedadId: z.string().uuid(),\n  coordinates: z.object({\n    ciudad: z.number().int().positive(),\n    barrio: z.number().int().positive(),\n    edificio: z.number().int().positive(),\n  }),\n  tropas: z.array(z.object({\n    id: z.string(),\n    cantidad: z.number().int().positive(),\n  })).min(1, \"Debes enviar al menos una tropa.\"),\n  tipo: z.string(),\n});\nexport type MissionInput = z.infer<typeof SendMissionSchema>;\n\n// =================================================================\n// USER SETTINGS SCHEMAS\n// =================================================================\n\nexport const UserSettingsSchema = z.preprocess((val) => {\n    if (typeof FormData !== 'undefined' && val instanceof FormData) {\n        return Object.fromEntries(val.entries());\n    }\n    return val;\n}, z.object({\n  name: z.string().min(3, \"El nombre debe tener al menos 3 caracteres.\").max(30, \"Máximo 30 caracteres.\").optional(),\n  title: z.string().max(50, \"El título no puede exceder 50 caracteres.\").optional(),\n  avatarUrl: z.string().url(\"Debe ser una URL válida.\").optional().or(z.literal('')),\n  avatarFile: z.any().optional(),\n}));\n\nexport const CancelConstructionSchema = z.object({\n  colaId: z.string().uuid(\"ID de cola inválido.\"),\n});\n\nexport const UpdatePropertyDetailsSchema = z.object({\n  properties: z.array(z.object({\n    id: z.string().uuid(),\n    nombre: z.string().min(3, \"El nombre debe tener al menos 3 caracteres.\").max(30, \"Máximo 30 caracteres.\")\n  })),\n  mainPropertyId: z.string().uuid()\n});\n",
    "src/lib/constants.ts": "// /src/lib/constants.ts\n// IMPORTANTE: NO AGREGUES 'use server' AQUÍ.\n\n// --- AUTH ---\nexport const SESSION_COOKIE_NAME = 'vendetta-session';\nexport const ADMIN_COOKIE_NAME = 'vendetta-admin-session';\nexport const SUPER_USER_COOKIE_NAME = 'vendetta-super-session';\n\n// --- GAME RULES ---\nexport const MAX_CONSTRUCTION_QUEUE_SIZE = 5;\nexport const BASE_STORAGE_CAPACITY = 10000;\nexport const STORAGE_CAPACITY_PER_LEVEL = 150000;\n\n// --- SPECIAL BUILDING IDs ---\nexport const ID_OFICINA_JEFE = 'oficina_del_jefe';\nexport const ID_ESCUELA_ESPECIALIZACION = 'escuela_especializacion';\nexport const ID_CAMPO_ENTRENAMIENTO = 'campo_de_entrenamiento';\nexport const ID_SEGURIDAD = 'seguridad';\n\n// --- TROOP IDs ---\nexport const ID_TROPA_ESPIA = 'espia';\nexport const ID_TROPA_OCUPACION = 'ocupacion';\nexport const ID_TROPAS_RUTAS = ['maton', 'portero', 'acuchillador', 'pistolero', 'ocupacion', 'porteador'];\nexport const ID_TROPAS_ENCARGOS = ['espia', 'cia', 'fbi', 'transportista', 'francotirador', 'tactico', 'demoliciones', 'asesino', 'ninja', 'mercenario'];\n\n\n// --- TROOP TYPES ---\nexport const TROOP_TYPE_DEFENSE = 'DEFENSA';\nexport const TROOP_TYPE_ATTACK = 'ATAQUE';\nexport const TROOP_TYPE_TRANSPORT = 'TRANSPORTE';\nexport const TROOP_TYPE_SPY = 'ESPIONAJE';\nexport const TROOP_TYPE_OCCUPY = 'OCUPAR';\n\n// --- MISSION TYPES ---\nexport const MISSION_TYPES_NO_RETURN = ['OCUPAR'];\n\n// --- UI SORTING ---\nexport const RECRUITMENT_TROOP_ORDER = [\n    \"maton\", \"portero\", \"acuchillador\", \"pistolero\", \"ocupacion\", \"espia\", \"porteador\", \"cia\", \"fbi\", \"transportista\", \"tactico\", \"francotirador\", \"asesino\", \"ninja\", \"demoliciones\", \"mercenario\"\n];\n\nexport const SECURITY_TROOP_ORDER = [\"trabajador_ilegal\", \"centinela\", \"policia\", \"guardaespaldas\", \"guardia_de_honor\"];\n\nexport const TRAINING_ORDER = [\n    \"rutas\", \"encargos\", \"extorsion\", \"administracion\", \"contrabando\", \"espionaje\", \"seguridad\",\n    \"proteccion\", \"combate\", \"armas\", \"tiro\", \"explosivos\", \"guerrilla\", \"psicologico\", \"quimico\", \"honor\"\n];\n\nexport const ROOM_ORDER = [\n    'oficina_del_jefe', 'escuela_especializacion', 'armeria', 'almacen_de_municion',\n    'cerveceria', 'taberna', 'contrabando', 'almacen_de_armas', 'deposito_de_municion',\n    'almacen_de_alcohol', 'caja_fuerte', 'campo_de_entrenamiento', 'seguridad',\n    'torreta_de_fuego_automatico', 'minas_ocultas'\n];\n\n// --- RESOURCES ---\nexport const resourceIcons: { [key: string]: string } = {\n    armas: '/img/recursos/armas.svg',\n    municion: '/img/recursos/municion.svg',\n    alcohol: '/img/recursos/alcohol.svg',\n    dolares: '/img/recursos/dolares.svg',\n};\n",
    "src/lib/queue.ts": "\nimport 'server-only';\nimport { createClient } from '@/utils/supabase/server';\nimport type { SupabaseClient } from '@supabase/supabase-js';\nimport { Database } from '@/types/database';\n\nexport interface MissionPayload {\n    missionId?: string;\n    [key: string]: any;\n}\n\nexport async function enqueueMission(\n    supabase: SupabaseClient<Database>,\n    missionData: MissionPayload, \n    delaySeconds: number\n) {\n    // Try PGMQ first\n    const { error } = await supabase.rpc('pgmq' as any, {\n        p_queue_name: 'fleet_missions',\n        p_msg: missionData,\n        p_delay: delaySeconds\n    });\n\n    if (error) {\n        // Fallback to FleetQueue table\n        const availableAt = new Date(Date.now() + delaySeconds * 1000).toISOString();\n        const { error: fallbackError } = await supabase\n            .from('FleetQueue')\n            .insert({\n                payload: missionData,\n                status: 'queued',\n                available_at: availableAt\n            });\n\n        if (fallbackError) {\n            console.error('Failed to enqueue mission (Fallback)', fallbackError);\n            throw new Error('Failed to enqueue mission');\n        }\n    }\n}\n\nexport async function popNextMission() {\n    const supabase = await createClient();\n    // Try PGMQ\n    const { data, error } = await supabase.rpc('pgmq.pop' as any, {\n        queue_name: 'fleet_missions'\n    });\n\n    if (!error && data && data.length > 0) {\n        return {\n            id: data[0].msg_id,\n            payload: data[0].msg,\n            receipt: data[0].vt,\n            provider: 'pgmq'\n        };\n    }\n\n    if (error) {\n         // If error, it might be because PGMQ is not installed. Try fallback RPC.\n         const { data: fallbackData, error: fallbackError } = await supabase.rpc('pop_fleet_mission');\n\n         if (!fallbackError && fallbackData && fallbackData.length > 0) {\n             return {\n                 id: fallbackData[0].id,\n                 payload: fallbackData[0].payload,\n                 receipt: null,\n                 provider: 'fleet_queue'\n             };\n         }\n    }\n\n    return null;\n}\n",
    "src/lib/services/admin-game.service.ts": "import 'server-only';\nimport { createClient } from \"@/utils/supabase/server\";\nimport type { ConfiguracionHabitacion, ConfiguracionEntrenamiento, ConfiguracionTropa, TropaBonusContrincante } from '@/types';\n\nexport class AdminGameService {\n    // Room Config\n    static async upsertRoomConfig(\n        data: Omit<ConfiguracionHabitacion, 'created_at' | 'updated_at'>,\n        requirements: { requiredRoomId: string; requiredLevel: number }[],\n        originalId?: string\n    ) {\n        const supabase = await createClient();\n\n        if (originalId && originalId !== data.id) {\n           await supabase.from('RoomRequirement').delete().or(`roomId.eq.${originalId},requiredRoomId.eq.${originalId}`);\n           await supabase.from('ConfiguracionHabitacion').delete().eq('id', originalId);\n        }\n\n        const { error: upsertError } = await supabase.from('ConfiguracionHabitacion').upsert(data);\n        if (upsertError) throw upsertError;\n\n        const { error: deleteReqError } = await supabase.from('RoomRequirement').delete().eq('roomId', data.id);\n        if (deleteReqError) throw deleteReqError;\n\n        if (requirements.length > 0) {\n            const { error: createReqError } = await supabase.from('RoomRequirement').insert(\n                requirements.map(req => ({\n                    roomId: data.id,\n                    requiredRoomId: req.requiredRoomId,\n                    requiredLevel: req.requiredLevel\n                }))\n            );\n            if (createReqError) throw createReqError;\n        }\n        return { success: true };\n    }\n\n    static async deleteRoomConfig(id: string) {\n        const supabase = await createClient();\n        const { error: reqError } = await supabase.from('RoomRequirement').delete().or(`roomId.eq.${id},requiredRoomId.eq.${id}`);\n        if(reqError) throw reqError;\n        const { error: roomError } = await supabase.from('ConfiguracionHabitacion').delete().eq('id', id);\n        if(roomError) throw roomError;\n        return { success: true };\n    }\n\n    // Training Config\n    static async upsertTrainingConfig(\n        data: Omit<ConfiguracionEntrenamiento, 'created_at' | 'updated_at'>,\n        requirements: { requiredTrainingId: string; requiredLevel: number }[],\n        originalId?: string\n    ) {\n        const supabase = await createClient();\n\n        if (originalId && originalId !== data.id) {\n            await supabase.from('TrainingRequirement').delete().or(`trainingId.eq.${originalId},requiredTrainingId.eq.${originalId}`);\n            await supabase.from('ConfiguracionEntrenamiento').delete().eq('id', originalId);\n        }\n\n        const { error: upsertError } = await supabase.from('ConfiguracionEntrenamiento').upsert(data);\n        if (upsertError) throw upsertError;\n\n        const { error: deleteReqError } = await supabase.from('TrainingRequirement').delete().eq('trainingId', data.id);\n        if (deleteReqError) throw deleteReqError;\n\n        if (requirements.length > 0) {\n            const { error: createReqError } = await supabase.from('TrainingRequirement').insert(\n                requirements.map(req => ({\n                    trainingId: data.id,\n                    requiredTrainingId: req.requiredTrainingId,\n                    requiredLevel: req.requiredLevel\n                }))\n            );\n            if (createReqError) throw createReqError;\n        }\n        return { success: true };\n    }\n\n    static async deleteTrainingConfig(id: string) {\n        const supabase = await createClient();\n        const { error: reqError } = await supabase.from('TrainingRequirement').delete().or(`trainingId.eq.${id},requiredTrainingId.eq.${id}`);\n        if(reqError) throw reqError;\n        const { error: trainingError } = await supabase.from('ConfiguracionEntrenamiento').delete().eq('id', id);\n        if(trainingError) throw trainingError;\n        return { success: true };\n    }\n\n    // Troop Config\n    static async upsertTroopConfig(\n        data: Omit<ConfiguracionTropa, 'created_at' | 'updated_at'>,\n        bonusContrincantes: {tropaDefensoraId: string, factorPrioridad: number}[]\n    ) {\n        const supabase = await createClient();\n\n        // Cast to any to avoid type check on upsert if partial\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const { error: upsertError } = await supabase.from('ConfiguracionTropa').upsert(data as any);\n        if (upsertError) throw upsertError;\n\n        const { error: deleteBonusError } = await supabase.from('TropaBonusContrincante').delete().eq('tropaAtacanteId', data.id);\n        if (deleteBonusError) throw deleteBonusError;\n\n        if (bonusContrincantes.length > 0) {\n            const { error: createBonusError } = await supabase.from('TropaBonusContrincante').insert(\n                bonusContrincantes.map((b) => ({\n                    tropaAtacanteId: data.id,\n                    tropaDefensoraId: b.tropaDefensoraId,\n                    factorPrioridad: b.factorPrioridad\n                }))\n            );\n            if (createBonusError) throw createBonusError;\n        }\n        return { success: true };\n    }\n\n    static async deleteTroopConfig(id: string) {\n        const supabase = await createClient();\n        const { error: bonusError } = await supabase.from('TropaBonusContrincante').delete().or(`tropaAtacanteId.eq.${id},tropaDefensoraId.eq.${id}`);\n        if(bonusError) throw bonusError;\n        const { error: troopError } = await supabase.from('ConfiguracionTropa').delete().eq('id', id);\n        if(troopError) throw troopError;\n        return { success: true };\n    }\n\n    static async upsertTroopBonuses(bonusData: Omit<TropaBonusContrincante, 'id' | 'created_at' | 'updated_at'>[]) {\n        const supabase = await createClient();\n        const { error: deleteError } = await supabase.from('TropaBonusContrincante').delete().neq('id', '0'); // Delete all\n        if (deleteError) throw deleteError;\n\n        if (bonusData.length > 0) {\n            const { error: createError } = await supabase.from('TropaBonusContrincante').insert(bonusData);\n            if(createError) throw createError;\n        }\n        return { success: true };\n    }\n}\n",
    "src/lib/actions/simulation.actions.ts": "\n'use server';\n\nimport { getTrainingConfigurations, getTroopConfigurations } from '../data';\nimport { calcularPoderAtaque } from '../formulas/score-formulas';\nimport { calcularStatsTropa } from '../formulas/troop-formulas';\nimport type { ConfiguracionTropa } from '@/types';\nimport type { ArmyUnit, BattleRound, BattleSimulationResult, MinimalTroopConfig, SimulationInput, TroopData, ResourceCost, BattleRoundTroopState } from '@/types/simulation.types';\n\nfunction calculateResourceLoss(lostTroops: ArmyUnit[], troopConfigsMap: Map<string, ConfiguracionTropa>): ResourceCost {\n    return lostTroops.reduce((total, unit) => {\n        const config = troopConfigsMap.get(unit.config.id);\n        if(config) {\n            total.armas += Number(config.costoArmas) * unit.cantidad;\n            total.municion += Number(config.costoMunicion) * unit.cantidad;\n            total.dolares += Number(config.costoDolares) * unit.cantidad;\n        }\n        return total;\n    }, { armas: 0, municion: 0, dolares: 0 });\n}\n\nexport async function runBattleSimulation(attacker: SimulationInput, defender: SimulationInput): Promise<BattleSimulationResult> {\n    const [troopConfigs, trainingConfigs] = await Promise.all([\n        getTroopConfigurations(),\n        getTrainingConfigurations()\n    ]);\n    const troopConfigsMap = new Map(troopConfigs.map(t => [t.id, t]));\n    const trainingConfigsMap = new Map(trainingConfigs.map(t => [t.id, t]));\n\n    const buildArmy = (simInput: SimulationInput): ArmyUnit[] => {\n        const userTrainings = simInput.trainings.map(t => ({\n            configuracionEntrenamientoId: t.id,\n            nivel: t.level,\n            configuracion: trainingConfigsMap.get(t.id)!\n        }));\n\n        return (simInput.troops as any[]).map((troop: TroopData & {cantidad?: number, quantity?: number}) => {\n            const configFull = troopConfigsMap.get(troop.id);\n            if (!configFull) return null;\n\n            // Calculate dynamic stats\n            const { ataqueActual, defensaActual } = calcularStatsTropa(configFull, userTrainings as any);\n\n            const minimalConfig: MinimalTroopConfig = {\n                id: configFull.id,\n                nombre: configFull.nombre,\n                tipo: configFull.tipo,\n                ataque: ataqueActual,\n                defensa: defensaActual,\n                velocidad: configFull.velocidad,\n                capacidadCarga: configFull.capacidad,\n                esAereo: false\n            };\n\n            return {\n                config: minimalConfig,\n                cantidad: troop.quantity ?? troop.cantidad ?? 0,\n                bonus: 0,\n                entrenamientoNivel: 0\n            };\n        }).filter((u): u is ArmyUnit => u !== null && u.cantidad > 0);\n    };\n\n    let attackerArmy = buildArmy(attacker);\n    let defenderArmy = buildArmy(defender);\n    \n    // Deep copy for initial state tracking\n    const bigIntReplacer = (key: any, value: any) => typeof value === 'bigint' ? value.toString() : value;\n\n    // Capture INITIAL state for round reporting (round 0 logic or loss calc)\n    // Note: To match old logic perfectly, we need to track state round-by-round.\n    const initialAttackerArmyForCalc: ArmyUnit[] = JSON.parse(JSON.stringify(attackerArmy, bigIntReplacer));\n    const initialDefenderArmyForCalc: ArmyUnit[] = JSON.parse(JSON.stringify(defenderArmy, bigIntReplacer));\n\n    const honorAtacante = attacker.trainings.find(t => t.id === 'honor')?.level || 0;\n    const honorDefensor = defender.trainings.find(t => t.id === 'honor')?.level || 0;\n    \n    const poderAtaqueAtacantePercent = await calcularPoderAtaque(attacker.propertyCount, honorAtacante);\n    const poderAtaqueDefensorPercent = await calcularPoderAtaque(defender.propertyCount, honorDefensor);\n\n    const battleRounds: BattleRound[] = [];\n    \n    for (let i = 1; i <= 5; i++) {\n        const roundAttackerArmyStart = JSON.parse(JSON.stringify(attackerArmy, bigIntReplacer));\n        const roundDefenderArmyStart = JSON.parse(JSON.stringify(defenderArmy, bigIntReplacer));\n\n        let attackerTroopCount = attackerArmy.reduce((sum, u) => sum + u.cantidad, 0);\n        let defenderTroopCount = defenderArmy.reduce((sum, u) => sum + u.cantidad, 0);\n\n        if (attackerTroopCount === 0 || defenderTroopCount === 0) break;\n\n        // Calculate total power\n        const attackerTotalAttackBase = attackerArmy.reduce((sum, u) => sum + u.config.ataque * u.cantidad, 0);\n        const defenderTotalAttackBase = defenderArmy.reduce((sum, u) => sum + u.config.ataque * u.cantidad, 0);\n        \n        const attackerTotalAttackConBonus = attackerTotalAttackBase * (poderAtaqueAtacantePercent / 100);\n        const defenderTotalAttackConBonus = defenderTotalAttackBase * (poderAtaqueDefensorPercent / 100);\n\n        let attackerTotalDefense = attackerArmy.reduce((sum, u) => sum + u.config.defensa * u.cantidad, 0) * (poderAtaqueAtacantePercent / 100);\n        let defenderTotalDefense = defenderArmy.reduce((sum, u) => sum + u.config.defensa * u.cantidad, 0) * (poderAtaqueDefensorPercent / 100);\n\n        // Damage ratio\n        const attackerLossRatio = defenderTotalAttackConBonus > attackerTotalDefense ? 1 : defenderTotalAttackConBonus / (attackerTotalDefense || 1);\n        const defenderLossRatio = attackerTotalAttackConBonus > defenderTotalDefense ? 1 : attackerTotalAttackConBonus / (defenderTotalDefense || 1);\n        \n        const attackerRoundTroopStates: BattleRoundTroopState[] = [];\n        const defenderRoundTroopStates: BattleRoundTroopState[] = [];\n\n        // Apply losses and record stats\n        attackerArmy.forEach(u => {\n            const startQty = u.cantidad;\n            const losses = Math.floor(startQty * attackerLossRatio);\n            u.cantidad = Math.max(0, startQty - losses);\n            attackerRoundTroopStates.push({\n                id: u.config.id,\n                nombre: u.config.nombre,\n                initialQuantity: startQty,\n                lostQuantity: losses\n            });\n        });\n\n        defenderArmy.forEach(u => {\n            const startQty = u.cantidad;\n            const losses = Math.floor(startQty * defenderLossRatio);\n            u.cantidad = Math.max(0, startQty - losses);\n            defenderRoundTroopStates.push({\n                id: u.config.id,\n                nombre: u.config.nombre,\n                initialQuantity: startQty,\n                lostQuantity: losses\n            });\n        });\n        \n        battleRounds.push({\n            round: i,\n            attacker: {\n                troops: attackerRoundTroopStates,\n                totalAttack: attackerTotalAttackBase,\n                totalAttackConBonus: attackerTotalAttackConBonus,\n                poderAtaquePercent: poderAtaqueAtacantePercent,\n                totalDefense: attackerTotalDefense\n            },\n            defender: {\n                troops: defenderRoundTroopStates,\n                totalAttack: defenderTotalAttackBase,\n                totalAttackConBonus: defenderTotalAttackConBonus,\n                poderAtaquePercent: poderAtaqueDefensorPercent,\n                totalDefense: defenderTotalDefense\n            },\n            log: [`Round ${i}: Attacker lost ${attackerLossRatio.toFixed(2)}% troops, Defender lost ${defenderLossRatio.toFixed(2)}% troops.`]\n        });\n    }\n\n    const finalAttackerTroops = new Map(attackerArmy.map(u => [u.config.id, u.cantidad]));\n    const finalDefenderTroops = new Map(defenderArmy.map(u => [u.config.id, u.cantidad]));\n\n    const totalAttackerLossesArray: ArmyUnit[] = initialAttackerArmyForCalc.map((u) => ({\n        ...u,\n        cantidad: u.cantidad - (finalAttackerTroops.get(u.config.id) || 0)\n    }));\n    const totalDefenderLossesArray: ArmyUnit[] = initialDefenderArmyForCalc.map((u) => ({\n        ...u,\n        cantidad: u.cantidad - (finalDefenderTroops.get(u.config.id) || 0)\n    }));\n\n    const attackerLossesMap: { [id: string]: number } = {};\n    totalAttackerLossesArray.forEach(u => attackerLossesMap[u.config.id] = u.cantidad);\n\n    const defenderLossesMap: { [id: string]: number } = {};\n    totalDefenderLossesArray.forEach(u => defenderLossesMap[u.config.id] = u.cantidad);\n\n    const finalStats = {\n        attacker: {\n            troopsLost: totalAttackerLossesArray.reduce((s, u) => s + u.cantidad, 0),\n            pointsLost: 0,\n            resourcesLost: calculateResourceLoss(totalAttackerLossesArray, troopConfigsMap)\n        },\n        defender: {\n            troopsLost: totalDefenderLossesArray.reduce((s, u) => s + u.cantidad, 0),\n            pointsLost: 0,\n            resourcesLost: calculateResourceLoss(totalDefenderLossesArray, troopConfigsMap)\n        }\n    };\n\n    const attackerHasTroops = attackerArmy.some(u => u.cantidad > 0);\n    const defenderHasTroops = defenderArmy.some(u => u.cantidad > 0);\n    \n    let winner: 'attacker' | 'defender' | 'draw';\n    let finalMessage = \"\";\n\n    if(attackerHasTroops && !defenderHasTroops) {\n        winner = 'attacker';\n        finalMessage = \"Victoria del atacante.\";\n    } else if (!attackerHasTroops && defenderHasTroops) {\n        winner = 'defender';\n        finalMessage = \"Defensa exitosa.\";\n    } else {\n        winner = 'draw';\n        finalMessage = \"Empate.\";\n    }\n\n    const loot = {\n        armas: 0,\n        municion: 0,\n        alcohol: 0,\n        dolares: 0\n    };\n\n    return {\n        winner,\n        rounds: battleRounds,\n        attackerLosses: attackerLossesMap,\n        defenderLosses: defenderLossesMap,\n        loot,\n        xpGained: 0,\n        finalStats,\n        finalMessage\n    };\n}\n",
    "src/lib/actions/cancel-mission.action.ts": "\n'use server'\n\nimport { revalidatePath } from \"next/cache\";\nimport { getSessionUser } from \"../auth\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nexport async function cancelarMision(misionId: string) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) {\n        return { error: \"Usuario no autenticado.\" };\n    }\n\n    const { data: mision, error: missionError } = await supabase.from('ColaMisiones').select('*').eq('id', misionId).single();\n\n    if (missionError || !mision || mision.userId !== user.id) {\n        return { error: \"Misión no encontrada o no te pertenece.\" };\n    }\n    \n    if (new Date() > new Date(mision.fechaLlegada)) {\n        return { error: \"No se puede cancelar una misión que ya ha llegado a su destino.\" };\n    }\n\n    const ahora = new Date();\n    const tiempoTranscurrido = ahora.getTime() - new Date(mision.fechaInicio).getTime();\n    const nuevaFechaRegreso = new Date(ahora.getTime() + tiempoTranscurrido);\n\n    try {\n        const { error } = await supabase.from('ColaMisiones').update({\n                tipoMision: 'REGRESO',\n                fechaRegreso: nuevaFechaRegreso.toISOString(),\n            }).eq('id', misionId);\n        \n        if (error) throw error;\n\n        revalidatePath('/overview');\n        revalidatePath('/missions/details');\n        return { success: \"La misión ha sido cancelada y la flota está de regreso.\" };\n\n    } catch (error) {\n        console.error(\"Error al cancelar la misión:\", JSON.stringify(error, null, 2));\n        return { error: \"No se pudo cancelar la misión.\" };\n    }\n\n}\n",
    "src/lib/actions/admin-batch.actions.ts": "'use server';\nimport { revalidatePath } from 'next/cache';\nimport { verifyAdminSession } from '@/lib/auth-admin';\nimport { createClient } from '@/utils/supabase/server';\n\ninterface BatchUpdatePayload {\n    userId: string;\n    propertyIds: string[];\n    updates: {\n        resources?: { [key: string]: number };\n        roomLevels?: { id: string; level: number }[];\n        trainings?: { id: string; level: number }[];\n        attackTroops?: { id: string; quantity: number }[];\n        defenseTroops?: { id: string; quantity: number }[];\n    };\n}\n\nexport async function batchUpdatePropertiesByAdmin(payload: BatchUpdatePayload) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) {\n        return { error: 'No autorizado.' };\n    }\n\n    const { userId, propertyIds, updates } = payload;\n    const supabase = await createClient();\n\n    try {\n        const { error } = await supabase.rpc('update_properties_by_user_id', {\n            p_user_id: userId,\n            p_property_ids: propertyIds,\n            p_resources: updates.resources && Object.keys(updates.resources).length > 0 ? updates.resources : null,\n            p_room_levels: updates.roomLevels && updates.roomLevels.length > 0 ? updates.roomLevels : null,\n            p_trainings: updates.trainings && updates.trainings.length > 0 ? updates.trainings : null,\n            p_troops_to_add: (updates.attackTroops || []).concat(updates.defenseTroops || []),\n        });\n        \n        if (error) {\n            console.error(\"Error en RPC batch update:\", JSON.stringify(error, null, 2));\n            throw error;\n        }\n\n        revalidatePath('/(dashboard)', 'layout');\n        revalidatePath(`/admin/panel/properties/${userId}/edit`, 'layout');\n\n        return { success: 'Actualización masiva completada con éxito.' };\n    } catch (e: any) {\n        return { error: e.message || 'Error al procesar la actualización masiva.' };\n    }\n}\n",
    "src/lib/actions/training.actions.ts": "'use server';\n\nimport { revalidatePath } from \"next/cache\";\nimport { getSessionUser } from \"../auth\";\nimport { getTrainingConfigurations } from \"../data\";\nimport { calcularCostosEntrenamiento, calcularTiempoEntrenamiento } from \"../formulas/training-formulas\";\nimport { ID_ESCUELA_ESPECIALIZACION } from \"../constants\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nexport async function iniciarEntrenamiento(trainingId: string, propertyId: string) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n  \n    if (!user) {\n      return { error: 'Usuario no autenticado.' };\n    }\n    \n    const propiedadActual = user.propiedades.find(p => p.id === propertyId);\n    if (!propiedadActual) {\n        return { error: 'Propiedad no encontrada para este usuario.' };\n    }\n\n    const { data: colaEntrenamientoUsuario, error: colaError } = await supabase.from('ColaEntrenamiento').select('*').eq('userId', user.id);\n    if (colaError) {\n        console.error(colaError);\n        return { error: 'Error al verificar la cola de entrenamiento.' };\n    }\n\n\n    if (colaEntrenamientoUsuario.some(c => c.propiedadId === propertyId)) {\n        return { error: 'Ya hay un entrenamiento en curso en esta propiedad.' };\n    }\n    \n    if (colaEntrenamientoUsuario.some(c => c.entrenamientoId === trainingId)) {\n        return { error: 'Ya estás investigando este entrenamiento en otra propiedad.' };\n    }\n\n    const allTrainingConfigs = await getTrainingConfigurations();\n    const config = allTrainingConfigs.find(c => c.id === trainingId);\n    \n    if (!config) {\n        return { error: 'Configuración de entrenamiento no encontrada.'}\n    }\n\n    const userTraining = user.entrenamientos.find(t => t.configuracionEntrenamientoId === trainingId);\n    \n    const nivelActual = userTraining ? userTraining.nivel : 0;\n    const nivelSiguiente = nivelActual + 1;\n  \n    const costos = calcularCostosEntrenamiento(nivelSiguiente, config);\n  \n    if (\n      Number(propiedadActual.armas) < costos.armas ||\n      Number(propiedadActual.municion) < costos.municion ||\n      Number(propiedadActual.dolares) < costos.dolares\n    ) {\n      return { error: 'No tienes suficientes recursos en esta propiedad para el entrenamiento.' };\n    }\n\n    const nivelEscuela = propiedadActual.habitaciones.find(h => h.configuracionHabitacionId === ID_ESCUELA_ESPECIALIZACION)?.nivel || 1;\n    const duracion = calcularTiempoEntrenamiento(nivelSiguiente, config, nivelEscuela);\n\n    const fechaInicio = new Date();\n    const fechaFinalizacion = new Date(fechaInicio.getTime() + duracion * 1000);\n  \n    try {\n        const { error: propUpdateError } = await supabase.from('Propiedad').update({\n            armas: Number(propiedadActual.armas) - costos.armas,\n            municion: Number(propiedadActual.municion) - costos.municion,\n            dolares: Number(propiedadActual.dolares) - costos.dolares,\n        }).eq('id', propertyId);\n        \n        if (propUpdateError) throw propUpdateError;\n\n        const { error: queueInsertError } = await supabase.from('ColaEntrenamiento').insert({\n            userId: user.id,\n            propiedadId: propertyId,\n            entrenamientoId: trainingId,\n            nivelDestino: nivelSiguiente,\n            fechaInicio: fechaInicio.toISOString(),\n            fechaFinalizacion: fechaFinalizacion.toISOString(),\n        });\n        \n        if (queueInsertError) throw queueInsertError;\n  \n      revalidatePath('/(dashboard)/layout', 'layout');\n  \n      return { success: `¡El entrenamiento de ${config.nombre} a nivel ${nivelSiguiente} ha comenzado!` };\n    } catch (error) {\n      console.error('Error durante la transacción de entrenamiento:', JSON.stringify(error, null, 2));\n      return { error: 'Ocurrió un error en el servidor al intentar entrenar.' };\n    }\n}\n\nexport async function cancelarEntrenamiento(colaId: string) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n\n    const { data: itemCola, error: colaError } = await supabase\n        .from('ColaEntrenamiento')\n        .select('*, entrenamiento:ConfiguracionEntrenamiento(*), propiedad:Propiedad(*)')\n        .eq('id', colaId)\n        .single();\n    \n    if(colaError || !itemCola || itemCola.userId !== user.id) {\n        return { error: \"Elemento de cola no encontrado o no te pertenece.\" };\n    }\n\n    const config = itemCola.entrenamiento;\n    if (!config) return { error: \"Configuración de entrenamiento no encontrada.\" };\n    \n    const propiedad = itemCola.propiedad;\n    if (!propiedad) return { error: \"Propiedad asociada no encontrada.\" };\n\n    const costos = calcularCostosEntrenamiento(itemCola.nivelDestino, config);\n\n    try {\n        const { error: updateError } = await supabase\n            .from('Propiedad')\n            .update({\n                armas: Number(propiedad.armas) + costos.armas,\n                municion: Number(propiedad.municion) + costos.municion,\n                dolares: Number(propiedad.dolares) + costos.dolares,\n            })\n            .eq('id', itemCola.propiedadId);\n        \n        if (updateError) throw updateError;\n        \n        const { error: deleteError } = await supabase\n            .from('ColaEntrenamiento')\n            .delete()\n            .eq('id', colaId);\n        \n        if (deleteError) throw deleteError;\n\n        revalidatePath('/(dashboard)/layout', 'layout');\n        return { success: `El entrenamiento de ${config.nombre} ha sido cancelado.` };\n\n    } catch (error) {\n        console.error('Error al cancelar entrenamiento:', JSON.stringify(error, null, 2));\n        return { error: 'No se pudo cancelar el entrenamiento.' };\n    }\n}\n",
    "src/lib/actions/user.actions.ts": "\n'use server';\n\nimport type { UserWithProgress } from '@/types';\nimport { revalidatePath } from \"next/cache\";\nimport { getSessionUser } from \"../auth\";\nimport { createClient, createAdminClient } from '@/utils/supabase/server';\nimport { handleAttackMission } from \"./brawl.actions\"; \nimport { handleEspionageMission } from \"./espionage.actions\";\nimport { handleTransportMission } from \"./transport.actions\";\nimport { handleDefendMission } from \"./defense.actions\";\nimport { handleOccupyMission } from './occupy.actions';\nimport { UserSettingsSchema, UpdatePropertyDetailsSchema } from '../schemas';\nimport { createSafeAction } from \"../safe-action\";\n\n// Función principal que orquesta todas las actualizaciones\nexport async function actualizarEstadoCompletoDelJuego(user: UserWithProgress): Promise<void> {\n  console.time('game-update');\n  // 1. Verificar y finalizar misiones (ATAQUE, ESPIONAJE, etc.)\n  // Usamos adminClient para permitir interacción entre usuarios (ej. atacar) saltando RLS\n  const adminClient = createAdminClient();\n  await verificarYFinalizarMisiones(user, adminClient);\n  \n  // 2. Ejecutar actualización centralizada en BD (Construcción, Reclutamiento, Entrenamiento, Recursos)\n  const supabase = await createClient();\n  const { error: rpcError } = await supabase.rpc('actualizar_estado_completo_del_juego', {\n      p_user_id: user.id\n  });\n\n  if (rpcError) {\n      console.error(\"Error en RPC de actualización de estado:\", JSON.stringify(rpcError, null, 2));\n  }\n  console.timeEnd('game-update');\n}\n\n// ---- SUB-FUNCIONES ----\n\nasync function verificarYFinalizarMisiones(user: UserWithProgress, supabaseClient: any): Promise<void> {\n    const ahora = new Date().getTime();\n    const misionesFinalizadas = user.misiones.filter(m => new Date(m.fechaLlegada).getTime() <= ahora && m.tipoMision !== 'REGRESO');\n\n    if (misionesFinalizadas.length === 0) {\n        return;\n    }\n\n    await Promise.all(misionesFinalizadas.map(mision => {\n        switch (mision.tipoMision) {\n            case 'ATAQUE':\n                return handleAttackMission(mision, supabaseClient);\n            case 'ESPIONAJE':\n                return handleEspionageMission(mision, supabaseClient);\n            case 'TRANSPORTE':\n                return handleTransportMission(mision, supabaseClient);\n            case 'DEFENDER':\n                return handleDefendMission(mision, supabaseClient);\n            case 'OCUPAR':\n                return handleOccupyMission(mision, supabaseClient);\n            default:\n                console.warn(`Tipo de misión no manejado: ${mision.tipoMision}`);\n                return Promise.resolve();\n        }\n    }));\n}\n\nexport const updateUserSettings = createSafeAction(UserSettingsSchema, async (input) => {\n    const user = await getSessionUser();\n    const supabase = await createClient();\n\n    if (!user) {\n        throw new Error(\"Usuario no autenticado.\");\n    }\n    \n    const { name, title, avatarUrl, avatarFile } = input;\n    let finalAvatarUrl = avatarUrl;\n    \n    try {\n        if (avatarFile && avatarFile.size > 0) {\n            const filePath = `${user.id}/${Date.now()}_${avatarFile.name}`;\n            const { error: uploadError } = await supabase.storage\n                .from('vendettagame')\n                .upload(filePath, avatarFile);\n\n            if (uploadError) {\n                throw new Error(`Error al subir la imagen: ${uploadError.message}`);\n            }\n\n            finalAvatarUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/vendettagame/${filePath}`;\n        }\n\n        const { error } = await supabase\n            .from('User')\n            .update({\n                name,\n                title,\n                avatarUrl: finalAvatarUrl,\n            })\n            .eq('id', user.id);\n        \n        if (error) throw error;\n\n        revalidatePath('/settings');\n        revalidatePath('/(dashboard)', 'layout');\n        revalidatePath('/profile/[userId]', 'page');\n\n        return { newAvatarUrl: finalAvatarUrl };\n    } catch (error: any) {\n        console.error(\"Error al actualizar el perfil:\", JSON.stringify(error, null, 2));\n        throw new Error(error.message || \"Ocurrió un error al actualizar el perfil.\");\n    }\n});\n\nexport const updatePropertyDetails = createSafeAction(UpdatePropertyDetailsSchema, async (input) => {\n    const { properties, mainPropertyId } = input;\n    const user = await getSessionUser();\n    const supabase = await createClient();\n\n    if (!user) {\n        throw new Error(\"No autenticado.\");\n    }\n\n    const propertyIds = properties.map(p => p.id);\n    const { count, error: countError } = await supabase\n        .from('Propiedad')\n        .select('*', { count: 'exact', head: true })\n        .in('id', propertyIds)\n        .eq('userId', user.id);\n\n    if (countError || count !== properties.length) {\n        throw new Error(\"No tienes permiso para modificar una o más de estas propiedades.\");\n    }\n\n    try {\n        const { error } = await supabase.rpc('update_property_names', {\n            p_user_id: user.id,\n            p_main_property_id: mainPropertyId,\n            p_property_updates: properties.map(p => ({id: p.id, nombre: p.nombre}))\n        });\n\n        if(error) throw error;\n\n        revalidatePath('/(dashboard)', 'layout');\n        revalidatePath('/buildings');\n        return { success: \"Propiedades actualizadas correctamente.\" };\n    } catch (error: any) {\n        console.error(\"Error updating properties:\", JSON.stringify(error, null, 2));\n        throw new Error(\"Ocurrió un error al actualizar las propiedades.\");\n    }\n});\n",
    "src/lib/actions/score-formulas.ts": "\nimport type { UserWithProgress } from \"../data\";\n\nexport function calcularPuntosHabitaciones(user: UserWithProgress): number {\n  if (!user.propiedades || user.propiedades.length === 0) return 0;\n\n  return user.propiedades.reduce((totalPropiedades, propiedad) => {\n    const puntosPropiedad = propiedad.habitaciones.reduce((totalHabitaciones, habitacion) => {\n      const puntos = habitacion.configuracionHabitacion.puntos * habitacion.nivel;\n      return totalHabitaciones + puntos;\n    }, 0);\n    return totalPropiedades + puntosPropiedad;\n  }, 0);\n}\n\nexport function calcularPuntosTropas(user: UserWithProgress): number {\n  if (!user.propiedades) return 0;\n  \n  return user.propiedades.reduce((totalPropiedades, propiedad) => {\n    if (!propiedad.TropaUsuario) return totalPropiedades;\n    const puntosPropiedad = propiedad.TropaUsuario.reduce((totalTropas, tropa) => {\n      const puntos = tropa.configuracionTropa.puntos * tropa.cantidad;\n      return totalTropas + puntos;\n    }, 0);\n    return totalPropiedades + puntosPropiedad;\n  }, 0);\n}\n\nexport function calcularPuntosEntrenamientos(user: UserWithProgress): number {\n  if (!user.entrenamientos) return 0;\n\n  return user.entrenamientos.reduce((total, entrenamiento) => {\n    const puntos = entrenamiento.configuracionEntrenamiento.puntos * entrenamiento.nivel;\n    return total + puntos;\n  }, 0);\n}\n",
    "src/lib/actions/troop.actions.ts": "\n'use server';\n\nimport { revalidatePath } from \"next/cache\";\nimport { getSessionUser } from \"../auth\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { RecruitTroopsSchema } from \"../schemas\";\nimport { TROOP_TYPE_DEFENSE } from \"../constants\";\n\nasync function iniciarProcesoReclutamiento(\n    propiedadId: string, \n    tropaId: string, \n    cantidad: number, \n    tipoTropaEsperado: 'ATAQUE' | 'DEFENSA'\n) {\n    const supabase = await createClient();\n    \n    // 1. Zod Validation remains a good first-line defense\n    const validation = RecruitTroopsSchema.safeParse({ propiedadId, tropaId, cantidad });\n    if (!validation.success) {\n        return { error: validation.error.errors.map(e => e.message).join(', ') };\n    }\n\n    // 2. User Authentication\n    const user = await getSessionUser();\n    if (!user) {\n      return { error: 'Usuario no autenticado.' };\n    }\n    \n    const propiedadActual = user.propiedades.find(p => p.id === propiedadId);\n    if (!propiedadActual) {\n        return { error: 'Propiedad de origen no encontrada.' };\n    }\n\n    try {\n        // 3. Call the single atomic RPC function\n        const { data, error } = await supabase.rpc('iniciar_reclutamiento_atomico', {\n            p_propiedad_id: propiedadId,\n            p_tropa_id: tropaId,\n            p_cantidad: cantidad,\n            p_tipo_tropa_esperado: tipoTropaEsperado\n        });\n\n        if (error) {\n            console.error(`Error en RPC iniciar_reclutamiento_atomico para tipo ${tipoTropaEsperado}:`, JSON.stringify(error, null, 2));\n            // Handle logical errors returned within the 'data' object in some pg versions\n            const rpcError = (data as any)?.error;\n            if (rpcError) {\n                return { error: rpcError };\n            }\n            // For other DB errors, provide a generic message\n            return { error: 'No se pudo iniciar el reclutamiento debido a un error del servidor.' };\n        }\n\n        // The RPC returns a success message in `data.success`\n        if (data && typeof data === 'object' && 'success' in data && typeof (data as any).success === 'string') {\n            revalidatePath('/', 'layout');\n            return { success: (data as any).success };\n        }\n\n        return { error: 'Respuesta inesperada del servidor.' };\n\n    } catch (e: any) {\n        console.error(`Excepción crítica en reclutamiento (${tipoTropaEsperado}):`, e);\n        return { error: 'Error interno al procesar la solicitud.' };\n    }\n}\n\n\nexport async function iniciarReclutamiento(propiedadId: string, tropaId: string, cantidad: number) {\n    // We expect attack troops here. The DB function will validate the troop type.\n    return iniciarProcesoReclutamiento(propiedadId, tropaId, cantidad, 'ATAQUE');\n}\n\nexport async function iniciarEntrenamientoSeguridad(propiedadId: string, tropaId: string, cantidad: number) {\n     // We expect defense troops here. The DB function will validate the troop type.\n    return iniciarProcesoReclutamiento(propiedadId, tropaId, cantidad, 'DEFENSA');\n}\n\n\nexport async function cancelarReclutamiento(colaId: string) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n\n    const { data: itemCola, error: colaError } = await supabase\n        .from('ColaReclutamiento')\n        .select('*, tropaConfig:ConfiguracionTropa(*), propiedad:Propiedad(*)')\n        .eq('id', colaId)\n        .single();\n    \n    if(colaError || !itemCola) return { error: \"Elemento de cola no encontrado.\" };\n\n    const propiedad = user.propiedades.find(p => p.id === itemCola.propiedadId);\n    if (!propiedad) return { error: \"No tienes permiso para cancelar este reclutamiento.\" };\n    \n    const config = itemCola.tropaConfig;\n    if (!config) return { error: \"Configuración de tropa no encontrada.\" };\n    \n    const costoArmasTotal = Number(config.costoArmas) * itemCola.cantidad;\n    const costoMunicionTotal = Number(config.costoMunicion) * itemCola.cantidad;\n    const costoDolaresTotal = Number(config.costoDolares) * itemCola.cantidad;\n\n    try {\n        const { error: updateError } = await supabase\n            .from('Propiedad')\n            .update({\n                armas: Number(propiedad.armas) + costoArmasTotal,\n                municion: Number(propiedad.municion) + costoMunicionTotal,\n                dolares: Number(propiedad.dolares) + costoDolaresTotal,\n            })\n            .eq('id', itemCola.propiedadId);\n        \n        if (updateError) throw updateError;\n        \n        const { error: deleteError } = await supabase\n            .from('ColaReclutamiento')\n            .delete()\n            .eq('id', colaId);\n        \n        if (deleteError) throw deleteError;\n\n        revalidatePath('/', 'layout');\n        return { success: `El reclutamiento de ${itemCola.cantidad} x ${config.nombre} ha sido cancelado.` };\n\n    } catch (error) {\n        console.error('Error al cancelar reclutamiento:', JSON.stringify(error, null, 2));\n        return { error: 'No se pudo cancelar el reclutamiento.' };\n    }\n}\n",
    "src/lib/actions/mission.actions.ts": "\n'use server'\n\nimport { revalidatePath } from \"next/cache\";\nimport { getSessionUser } from \"../auth\";\nimport { getPropertyOwner, getTroopConfigurations } from \"../data\";\nimport { calcularDistancia, calcularCosteMision } from \"../formulas/mission-formulas\";\nimport { ID_TROPA_ESPIA, ID_TROPA_OCUPACION, TROOP_TYPE_OCCUPY, TROOP_TYPE_SPY } from \"../constants\";\nimport type { MissionInput } from '@/types';\nimport { createClient } from \"@/utils/supabase/server\";\nimport { SendMissionSchema } from \"../schemas\";\nimport { enqueueMission } from \"../queue\";\n\nexport async function enviarMision(input: MissionInput) {\n    const supabase = await createClient();\n    \n    // 1. Zod Validation\n    const validatedFields = SendMissionSchema.safeParse(input);\n    if (!validatedFields.success) {\n        return {\n            error: \"Datos de misión inválidos.\",\n            details: validatedFields.error.flatten().fieldErrors,\n        };\n    }\n    \n    const { origenPropiedadId, coordinates, tropas, tipo } = validatedFields.data;\n\n    // 2. Session and Ownership Validation\n    const user = await getSessionUser();\n    if (!user) {\n        return { error: \"Usuario no autenticado.\" };\n    }\n\n    const origenPropiedad = user.propiedades.find(p => p.id === origenPropiedadId);\n    if (!origenPropiedad) {\n        return { error: \"Propiedad de origen no encontrada o no te pertenece.\" };\n    }\n\n    // 3. Game Logic Validation (fast-fail for better UX)\n    if (tipo === TROOP_TYPE_SPY) {\n        const tropaEspia = tropas.find(t => t.id === ID_TROPA_ESPIA && t.cantidad > 0);\n        if (!tropaEspia) {\n            return { error: \"Necesitas enviar al menos una tropa de Espionaje para esta misión.\" };\n        }\n    }\n    \n    if (tipo === TROOP_TYPE_OCCUPY) {\n        const tropaOcupacion = tropas.find(t => t.id === ID_TROPA_OCUPACION && t.cantidad > 0);\n        if (!tropaOcupacion) {\n            return { error: \"Necesitas enviar al menos una Tropa de Ocupación para esta misión.\" };\n        }\n        const targetOwner = await getPropertyOwner(coordinates);\n        if (targetOwner) {\n            return { error: \"No puedes ocupar una propiedad que ya tiene dueño.\" };\n        }\n    }\n\n    // 4. Prepare payload for RPC\n    const troopsPayload = tropas.map(t => ({ id: t.id, cantidad: t.cantidad }));\n    \n    const destinationPayload = {\n        ciudad: coordinates.ciudad,\n        barrio: coordinates.barrio,\n        edificio: coordinates.edificio\n    };\n\n    // 5. Database Call (RPC)\n    try {\n        const { data, error } = await supabase.rpc('enviar_mision_atomica', {\n            p_user_id: user.id,\n            p_origen_id: origenPropiedadId,\n            p_destino_coords: destinationPayload,\n            p_tropas: troopsPayload,\n            p_tipo: tipo\n        });\n\n        if (error) throw error;\n        \n        const res = data as any;\n        if (res && typeof res === 'object' && !Array.isArray(res) && 'error' in res) {\n            return { error: res.error as string };\n        }\n\n        if (res?.missionId && res?.duration !== undefined) {\n             await enqueueMission(supabase, { missionId: res.missionId }, res.duration);\n        }\n\n    } catch (error: any) {\n        console.error(\"Error al crear la misión:\", JSON.stringify(error, null, 2));\n        return { error: error.message || \"No se pudo enviar la misión.\" };\n    }\n    \n    // 6. Revalidation\n    revalidatePath('/missions');\n    revalidatePath('/overview');\n    revalidatePath('/(dashboard)/layout', 'layout');\n\n    return { success: `Misión de ${tipo} enviada a ${coordinates.ciudad}:${coordinates.barrio}:${coordinates.edificio}.` };\n}\n",
    "src/lib/actions/mission.actions.test.ts": "import { describe, it, expect, beforeEach, vi } from 'vitest';\nimport { TROOP_TYPE_ATTACK } from '../constants';\nimport troopConfigs from '@/contexts/pruebas/ConfiguracionTropa_rows.json';\nimport users from '@/contexts/pruebas/usuario.json';\n\n// --- Mocks Setup ---\nconst mocks = vi.hoisted(() => ({\n    revalidatePath: vi.fn(),\n    getSessionUser: vi.fn(),\n    getPropertyOwner: vi.fn(),\n    getTroopConfigurations: vi.fn(),\n    createClient: vi.fn(),\n    enqueueMission: vi.fn(),\n    missionFormulas: {\n        calcularVelocidadFlota: vi.fn(() => 100),\n        calcularDuracionViaje: vi.fn(() => 3600),\n        convertirACoordenadasVirtuales: vi.fn(() => ({ altura: 0, anchura: 0 })),\n        calcularDistancia: vi.fn(() => 10),\n        calcularCosteMision: vi.fn(() => 100),\n    }\n}));\n\nvi.mock(\"next/cache\", () => ({\n    revalidatePath: mocks.revalidatePath,\n}));\n\nvi.mock(\"../auth\", () => ({\n    getSessionUser: mocks.getSessionUser,\n}));\n\nvi.mock(\"../data\", () => ({\n    getPropertyOwner: mocks.getPropertyOwner,\n    getTroopConfigurations: mocks.getTroopConfigurations,\n}));\n\nvi.mock(\"../formulas/mission-formulas\", () => mocks.missionFormulas);\n\nvi.mock(\"@/utils/supabase/server\", () => ({\n    createClient: mocks.createClient,\n}));\n\nvi.mock(\"../queue\", () => ({\n    enqueueMission: mocks.enqueueMission,\n}));\n\nimport { enviarMision } from './mission.actions';\n\ndescribe('enviarMision', () => {\n    let mockSupabase: any;\n    let mockBuilder: any;\n    const VALID_UUID = \"123e4567-e89b-12d3-a456-426614174000\";\n\n    beforeEach(() => {\n        // Clear mocks\n        vi.clearAllMocks();\n\n        // Setup Supabase Mock Chain\n        mockBuilder = {\n            select: vi.fn(() => mockBuilder),\n            insert: vi.fn(() => mockBuilder),\n            update: vi.fn(() => mockBuilder),\n            eq: vi.fn(() => mockBuilder),\n            single: vi.fn(() => Promise.resolve({ data: { id: 'mission-123' }, error: null })),\n        };\n\n        mockSupabase = {\n            from: vi.fn(() => mockBuilder),\n            rpc: vi.fn(() => Promise.resolve({ data: { success: 'ok' }, error: null })),\n        };\n\n        mocks.createClient.mockResolvedValue(mockSupabase);\n    });\n\n    it('should deduct troops from user property when sending a mission', async () => {\n        const testUser = users[0];\n        const mockUser = {\n            id: testUser.id,\n            name: testUser.name,\n            propiedades: [\n                {\n                    id: VALID_UUID,\n                    nombre: 'Home Base',\n                    ciudad: 1,\n                    barrio: 1,\n                    edificio: 1,\n                    dolares: 100000,\n                    TropaUsuario: [\n                        { configuracionTropa: { id: 'maton', nombre: 'Matón' }, cantidad: 100 },\n                        { configuracionTropa: { id: 'espia', nombre: 'Espía' }, cantidad: 10 }\n                    ]\n                }\n            ]\n        };\n        mocks.getSessionUser.mockResolvedValue(mockUser);\n\n        const matonConfig = troopConfigs.find(t => t.id === 'maton')!;\n        const espiaConfig = troopConfigs.find(t => t.id === 'espia')!;\n\n        mocks.getTroopConfigurations.mockResolvedValue([\n            { id: matonConfig.id, velocidad: matonConfig.velocidad, salario: matonConfig.salario },\n            { id: espiaConfig.id, velocidad: espiaConfig.velocidad, salario: espiaConfig.salario }\n        ]);\n\n        mocks.getPropertyOwner.mockResolvedValue(null);\n\n        const input = {\n            origenPropiedadId: VALID_UUID,\n            coordinates: { ciudad: 2, barrio: 2, edificio: 2 },\n            tropas: [\n                { id: 'maton', cantidad: 50 }\n            ],\n            tipo: TROOP_TYPE_ATTACK\n        };\n\n        const result = await enviarMision(input);\n\n        if (!result.success && result.error) {\n            console.error(\"Test failed with error:\", result.error, result.details);\n        }\n\n        expect(result).toHaveProperty('success');\n        \n        // Verify RPC call\n        expect(mockSupabase.rpc).toHaveBeenCalledWith('enviar_mision_atomica', expect.objectContaining({\n             p_user_id: mockUser.id,\n             p_origen_id: VALID_UUID,\n             p_tipo: TROOP_TYPE_ATTACK,\n             p_destino_coords: { ciudad: 2, barrio: 2, edificio: 2 }\n        }));\n    });\n});\n",
    "src/lib/actions/room.actions.test.ts": "import { describe, it, expect, beforeEach, vi } from 'vitest';\n\nconst mocks = vi.hoisted(() => ({\n    revalidatePath: vi.fn(),\n    getSessionUser: vi.fn(),\n    rpc: vi.fn(),\n    createClient: vi.fn(),\n}));\n\nvi.mock(\"next/cache\", () => ({\n    revalidatePath: mocks.revalidatePath,\n}));\n\nvi.mock(\"../auth\", () => ({\n    getSessionUser: mocks.getSessionUser,\n}));\n\nvi.mock(\"@/utils/supabase/server\", () => ({\n    createClient: mocks.createClient,\n}));\n\nimport { cancelarConstruccion, iniciarAmpliacion } from './room.actions';\n\ndescribe('room.actions', () => {\n    beforeEach(() => {\n        vi.clearAllMocks();\n        // Setup default behaviors\n        mocks.getSessionUser.mockResolvedValue({ id: 'user-1' });\n        mocks.createClient.mockResolvedValue({\n            rpc: mocks.rpc,\n            from: () => ({ select: () => ({ data: [], error: null }) })\n        });\n        mocks.rpc.mockResolvedValue({ data: {}, error: null });\n    });\n\n    describe('cancelarConstruccion', () => {\n        it('should call RPC cancelar_construccion_habitacion', async () => {\n            mocks.rpc.mockResolvedValueOnce({\n                data: { success: 'Cancelado' },\n                error: null\n            });\n\n            const validUUID = '123e4567-e89b-12d3-a456-426614174000';\n            const result = await cancelarConstruccion({ colaId: validUUID });\n            expect(mocks.rpc).toHaveBeenCalledWith('cancelar_construccion_habitacion', { p_cola_id: validUUID });\n            expect(result).toEqual({ data: { success: 'Cancelado' } });\n        });\n    });\n\n    describe('iniciarAmpliacion', () => {\n        it('should call RPC iniciar_construccion_habitacion with validated input', async () => {\n             mocks.rpc.mockResolvedValueOnce({\n                data: { success: 'Iniciado', nivelDestino: 2 },\n                error: null\n            });\n\n            const result = await iniciarAmpliacion({\n                propiedadId: '123e4567-e89b-12d3-a456-426614174000',\n                habitacionId: 'hab-1'\n            });\n\n            expect(mocks.rpc).toHaveBeenCalledWith('iniciar_construccion_habitacion', {\n                p_propiedad_id: '123e4567-e89b-12d3-a456-426614174000',\n                p_habitacion_id: 'hab-1'\n            });\n\n            expect(result).toEqual({ data: { success: 'Iniciado', nivelDestino: 2 } });\n        });\n\n        it('should return validation error for invalid input', async () => {\n            const result = await iniciarAmpliacion({\n                propiedadId: 'invalid-uuid',\n                habitacionId: ''\n            });\n\n            expect(result.validationErrors).toBeDefined();\n            expect(mocks.rpc).not.toHaveBeenCalled();\n        });\n    });\n});\n",
    "src/lib/actions/family.actions.ts": "\n'use server';\n\nimport { getSessionUser } from \"../auth\";\nimport { revalidatePath } from \"next/cache\";\n// Importar la función asíncrona directamente\nimport { createClient } from \"@/utils/supabase/server\"; \nimport { FamilyRole, InvitationStatus, InvitationType } from '@/types';\nimport { Database } from \"@/types/database\";\n\n// ELIMINAMOS O COMENTAMOS la función getSupabaseClient que causaba el conflicto:\n// const getSupabaseClient = () => createClient<Database>(); \n\n\nexport async function createFamily(formData: FormData) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user) return { error: \"Debes iniciar sesión para crear una familia.\" };\n    if (user.familyMember) return { error: \"Ya perteneces a una familia.\" };\n\n    const name = formData.get('name') as string;\n    const tag = formData.get('tag') as string;\n    const description = formData.get('description') as string;\n    const avatarUrl = formData.get('avatarUrl') as string;\n    const avatarFile = formData.get('avatarFile') as File;\n\n    if (!name || !tag) return { error: \"El nombre y el tag son obligatorios.\" };\n    if (tag.length < 3 || tag.length > 4) return { error: \"El tag debe tener entre 3 y 4 caracteres.\" };\n\n    let finalAvatarUrl = avatarUrl;\n\n    try {\n        if (avatarFile && avatarFile.size > 0) {\n            const filePath = `public/${tag.toLowerCase()}_${Date.now()}`;\n            const { error: uploadError } = await supabase.storage // ✅ Usa supabase (el cliente esperado)\n                .from('family-avatars')\n                .upload(filePath, avatarFile);\n\n            if (uploadError) throw new Error(`Error al subir imagen: ${uploadError.message}`);\n\n            finalAvatarUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/family-avatars/${filePath}`;\n        }\n        \n        const { data: newFamily, error } = await supabase.rpc('create_family_and_leader', { // ✅ Usa supabase\n            p_name: name,\n            p_tag: tag,\n            p_description: description,\n            p_avatar_url: finalAvatarUrl,\n            p_leader_id: user.id\n        });\n\n        if (error) {\n            if (error.message.includes('duplicate key value violates unique constraint')) {\n                 return { error: \"El nombre o el tag de la familia ya están en uso.\" };\n            }\n            throw error;\n        }\n\n        revalidatePath('/family');\n        return { success: `¡Familia \"${name}\" creada con éxito!`, family: newFamily };\n    } catch (error: any) {\n        console.error(error);\n        return { error: error.message || \"Ocurrió un error al crear la familia.\" };\n    }\n}\n\nexport async function inviteUserToFamily(userIdToInvite: string, familyId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) return { error: \"No tienes permisos para invitar.\" };\n    if (user.familyMember.familyId !== familyId) return { error: \"No puedes invitar a una familia a la que no perteneces.\" };\n    \n    const role = user.familyMember.role;\n    if (role !== FamilyRole.LEADER && role !== FamilyRole.CO_LEADER) {\n        return { error: \"Solo los líderes y co-líderes pueden enviar invitaciones.\" };\n    }\n\n    try {\n        const { error } = await supabase.from('FamilyInvitation').insert({ // ✅ Usa supabase\n            familyId: familyId,\n            userId: userIdToInvite,\n            type: InvitationType.INVITATION,\n            status: InvitationStatus.PENDING,\n        });\n        if (error) {\n            if (error.code === '23505') { // Unique constraint violation\n                return { error: \"Ya existe una invitación o solicitud para este usuario.\" };\n            }\n            throw error;\n        }\n        revalidatePath('/family');\n        return { success: \"Invitación enviada.\" };\n    } catch (error: any) {\n        console.error(error);\n        return { error: \"No se pudo enviar la invitación.\" };\n    }\n}\n\n\nexport async function acceptFamilyInvitation(invitationId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user) return { error: \"Usuario no autenticado.\" };\n    if (user.familyMember) return { error: \"Ya perteneces a una familia.\" };\n\n    const { data: invitation, error: invError } = await supabase.from('FamilyInvitation').select('*').eq('id', invitationId).single(); // ✅ Usa supabase\n\n    if (invError || !invitation || invitation.userId !== user.id) {\n        return { error: \"Invitación no válida.\" };\n    }\n    \n    try {\n        const { error: rpcError } = await supabase.rpc('accept_invitation_and_join_family', { // ✅ Usa supabase\n            p_user_id: user.id,\n            p_family_id: invitation.familyId,\n        });\n\n        if(rpcError) throw rpcError;\n\n        revalidatePath('/family');\n        return { success: \"¡Bienvenido a la familia!\" };\n    } catch(error) {\n        console.error(error);\n        return { error: \"Error al unirse a la familia.\" };\n    }\n}\n\n\nexport async function leaveFamily() {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) return { error: \"No perteneces a ninguna familia.\" };\n\n    if (user.familyMember.role === FamilyRole.LEADER) {\n        const { count, error } = await supabase // ✅ Usa supabase\n            .from('FamilyMember')\n            .select('*', { count: 'exact', head: true })\n            .eq('familyId', user.familyMember.familyId);\n        \n        if (error) {\n            console.error(error);\n            return { error: \"No se pudo verificar el número de miembros.\" };\n        }\n\n        if (count !== null && count > 1) {\n            return { error: \"Eres el líder. Debes nombrar a un nuevo líder o ser el último miembro para poder abandonar la familia.\" }\n        }\n    }\n\n    try {\n        const { error } = await supabase.rpc('leave_or_delete_family', { // ✅ Usa supabase\n            p_user_id: user.id,\n            p_family_id: user.familyMember.familyId,\n        });\n\n        if(error) throw error;\n        \n        revalidatePath('/family');\n        return { success: \"Has abandonado la familia.\" };\n    } catch(error) {\n        console.error(error);\n        return { error: \"No se pudo abandonar la familia.\" };\n    }\n}\n\nexport async function applyToFamily(familyId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user) return { error: \"Debes iniciar sesión para solicitar unirte.\" };\n    if (user.familyMember) return { error: \"Ya perteneces a una familia.\" };\n\n    try {\n        const { error } = await supabase.from('FamilyInvitation').insert({ // ✅ Usa supabase\n            familyId: familyId,\n            userId: user.id,\n            type: InvitationType.REQUEST, // User requests to join\n            status: InvitationStatus.PENDING,\n        });\n        if (error) {\n             if (error.code === '23505') {\n                 return { error: \"Ya has enviado una solicitud a esta familia.\" };\n            }\n            throw error;\n        }\n        revalidatePath('/family/find');\n        return { success: \"Solicitud enviada.\" };\n    } catch (error: any) {\n        console.error(error);\n        return { error: \"No se pudo enviar la solicitud.\" };\n    }\n}\n\n\nexport async function cancelInvitation(invitationId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n    \n    const { data: invitation, error: invError } = await supabase.from('FamilyInvitation').select('*, family:Family(*, members:FamilyMember(*))').eq('id', invitationId).single(); // ✅ Usa supabase\n    if(invError || !invitation) return { error: \"Invitación no encontrada.\" };\n    \n    // User can cancel their own application, or a leader can cancel an invitation\n    const userIsLeader = invitation.family.members.some((m: { userId: string; role: string; }) => m.userId === user.id && (m.role === \"LEADER\" || m.role === \"CO_LEADER\"));\n    const userIsApplicant = invitation.userId === user.id;\n\n    if (!userIsLeader && !userIsApplicant) {\n        return { error: \"No tienes permiso para cancelar esta solicitud/invitación.\" };\n    }\n\n    try {\n        await supabase.from('FamilyInvitation').update({ status: InvitationStatus.CANCELLED }).eq('id', invitationId); // ✅ Usa supabase\n        revalidatePath('/family');\n        revalidatePath('/family/find');\n        return { success: \"Solicitud/Invitación cancelada.\" };\n    } catch(error) {\n        console.error(error);\n        return { error: \"Error al cancelar.\" };\n    }\n}\n\nexport async function rejectInvitation(invitationId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n\n    const { data: invitation, error: invError } = await supabase.from('FamilyInvitation').select('*, family:Family(*, members:FamilyMember(*))').eq('id', invitationId).single(); // ✅ Usa supabase\n    if(invError || !invitation) return { error: \"Invitación/Solicitud no encontrada.\" };\n    \n    const userIsLeader = invitation.family.members.some((m: { userId: string; role: string; }) => m.userId === user.id && (m.role === \"LEADER\" || m.role === \"CO_LEADER\"));\n    const userIsInvitee = invitation.userId === user.id;\n\n    if (!userIsLeader && !userIsInvitee) {\n        return { error: \"No tienes permiso para realizar esta acción.\" };\n    }\n\n    try {\n        await supabase.from('FamilyInvitation').update({ status: InvitationStatus.REJECTED }).eq('id', invitationId); // ✅ Usa supabase\n        revalidatePath('/family');\n        revalidatePath('/family/requests');\n        return { success: \"Solicitud/Invitación rechazada.\" };\n    } catch(error) {\n        console.error(error);\n        return { error: \"Error al rechazar.\" };\n    }\n}\n\nexport async function acceptRequest(invitationId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) return { error: \"No tienes permisos para aceptar.\" };\n\n    const { data: invitation, error: invError } = await supabase.from('FamilyInvitation').select('*').eq('id', invitationId).single(); // ✅ Usa supabase\n\n    if (invError || !invitation || invitation.familyId !== user.familyMember.familyId) {\n        return { error: \"Solicitud no válida o no para tu familia.\" };\n    }\n    \n    const role = user.familyMember.role;\n    if (role !== FamilyRole.LEADER && role !== FamilyRole.CO_LEADER) {\n        return { error: \"Solo los líderes y co-líderes pueden aceptar solicitudes.\" };\n    }\n\n    try {\n        const { data: applicant, error: applicantError } = await supabase.from('User').select('familyMember:FamilyMember(familyId)').eq('id', invitation.userId).single(); // ✅ Usa supabase\n        if(applicantError) throw applicantError;\n        if (applicant?.familyMember) {\n            throw new Error(\"El usuario ya se ha unido a otra familia.\");\n        }\n\n        const { error } = await supabase.rpc('accept_invitation_and_join_family', { // ✅ Usa supabase\n            p_user_id: invitation.userId,\n            p_family_id: invitation.familyId,\n        });\n\n        if(error) throw error;\n        \n        revalidatePath('/family');\n        revalidatePath('/family/requests');\n        return { success: \"¡Nuevo miembro aceptado en la familia!\" };\n    } catch(error: any) {\n        console.error(error);\n        return { error: error.message || \"Error al aceptar al miembro.\" };\n    }\n}\n\nexport async function createFamilyAnnouncement(familyId: string, content: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember) return { error: \"No tienes permisos para crear un anuncio.\" };\n\n    if (user.familyMember.familyId !== familyId) {\n        return { error: \"No perteneces a esta familia.\" };\n    }\n\n    if (user.familyMember.role !== FamilyRole.LEADER && user.familyMember.role !== FamilyRole.CO_LEADER) {\n        return { error: \"Solo los líderes y co-líderes pueden crear anuncios.\" };\n    }\n\n    if (!content.trim()) {\n        return { error: \"El contenido del anuncio no puede estar vacío.\" };\n    }\n\n    try {\n        await supabase.from('FamilyAnnouncement').insert({ // ✅ Usa supabase\n            content,\n            familyId,\n            authorId: user.id,\n        });\n\n        revalidatePath('/family');\n        return { success: \"Anuncio publicado.\" };\n    } catch (e) {\n        console.error(e);\n        return { error: \"Error al publicar el anuncio.\" };\n    }\n}\n\nexport async function updateMemberRole(memberId: string, familyId: string, newRole: FamilyRole) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember || user.familyMember.role !== FamilyRole.LEADER || user.familyMember.familyId !== familyId) {\n        return { error: \"No tienes permiso para realizar esta acción.\" };\n    }\n    if (newRole === FamilyRole.LEADER) {\n        return { error: \"El liderazgo solo se puede transferir, no asignar.\" };\n    }\n    try {\n        await supabase.from('FamilyMember').update({ role: newRole }).eq('userId', memberId); // ✅ Usa supabase\n        revalidatePath('/family/management');\n        return { success: \"Rango actualizado correctamente.\" };\n    } catch (error) {\n        return { error: \"Error al actualizar el rango.\" };\n    }\n}\n\nexport async function transferLeadership(newLeaderId: string, familyId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember || user.familyMember.role !== FamilyRole.LEADER || user.familyMember.familyId !== familyId) {\n        return { error: \"No tienes permiso para realizar esta acción.\" };\n    }\n    try {\n        const { error } = await supabase.rpc('transfer_leadership', { // ✅ Usa supabase\n            p_family_id: familyId,\n            p_old_leader_id: user.id,\n            p_new_leader_id: newLeaderId\n        });\n        if(error) throw error;\n\n        revalidatePath('/family/management');\n        revalidatePath('/family');\n        return { success: \"Liderazgo transferido con éxito.\" };\n    } catch (error) {\n        return { error: \"Error al transferir el liderazgo.\" };\n    }\n}\n\nexport async function expelMember(memberId: string, familyId: string) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    if (!user || !user.familyMember || user.familyMember.role !== FamilyRole.LEADER || user.familyMember.familyId !== familyId) {\n        return { error: \"No tienes permiso para realizar esta acción.\" };\n    }\n    try {\n        await supabase.from('FamilyMember').delete().eq('userId', memberId); // ✅ Usa supabase\n        revalidatePath('/family/management');\n        return { success: \"Miembro expulsado.\" };\n    } catch (error) {\n        return { error: \"Error al expulsar al miembro.\" };\n    }\n}\n\nexport async function updateFamilyDetails(formData: FormData) {\n    const supabase = await createClient(); // ✅ CORRECCIÓN\n    const user = await getSessionUser();\n    \n    const familyId = formData.get('familyId') as string;\n    if (!user || !user.familyMember || user.familyMember.familyId !== familyId) {\n        return { error: \"No tienes permisos para editar esta familia.\" };\n    }\n\n    const role = user.familyMember.role;\n    if (role !== FamilyRole.LEADER && role !== FamilyRole.CO_LEADER) {\n        return { error: \"Solo los líderes y co-líderes pueden editar la familia.\" };\n    }\n    \n    const name = formData.get('name') as string;\n    const tag = formData.get('tag') as string;\n    const description = formData.get('description') as string;\n    const avatarUrl = formData.get('avatarUrl') as string;\n    const avatarFile = formData.get('avatarFile') as File;\n\n    if (!name || !tag) return { error: \"El nombre y el tag son obligatorios.\" };\n    if (tag.length < 3 || tag.length > 4) return { error: \"El tag debe tener entre 3 y 4 caracteres.\" };\n\n    let finalAvatarUrl = avatarUrl;\n\n    try {\n        if (avatarFile && avatarFile.size > 0) {\n            const filePath = `public/${tag.toLowerCase()}_${Date.now()}`;\n            const { error: uploadError } = await supabase.storage // ✅ Usa supabase\n                .from('family-avatars')\n                .upload(filePath, avatarFile);\n\n            if (uploadError) throw new Error(`Error al subir imagen: ${uploadError.message}`);\n            finalAvatarUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/family-avatars/${filePath}`;\n        }\n        \n        const { error } = await supabase // ✅ Usa supabase\n            .from('Family')\n            .update({\n                name,\n                tag,\n                description,\n                avatarUrl: finalAvatarUrl,\n            })\n            .eq('id', familyId);\n\n        if (error) {\n             if (error.message.includes('duplicate key value violates unique constraint')) {\n                 return { error: \"El nombre o el tag de la familia ya están en uso.\" };\n             }\n             throw error;\n        }\n\n        revalidatePath('/family');\n        return { success: \"¡Los detalles de la familia han sido actualizados!\" };\n    } catch (error: any) {\n        console.error(error);\n        return { error: error.message || \"Ocurrió un error al actualizar la familia.\" };\n    }\n}\n",
    "src/lib/actions/espionage.actions.ts": "\nimport { revalidatePath } from \"next/cache\";\nimport { runBattleSimulation } from \"./simulation.actions\";\nimport { MessageCategory, ColaMisiones } from '@/types';\nimport type { SimulationInput, EspionageReportDetails } from '@/types/simulation.types';\nimport { ID_TROPA_ESPIA } from \"../constants\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nexport async function handleEspionageMission(mision: ColaMisiones, supabaseClient?: any) {\n    const supabase = supabaseClient || await createClient();\n    \n    const { data: atacante, error: attackerError } = await supabase.from('User').select('*, propiedades:Propiedad(*), entrenamientos:EntrenamientoUsuario(*)').eq('id', mision.userId).single();\n    if (attackerError || !atacante) {\n        console.error(\"Atacante no encontrado para la misión de espionaje:\", mision.id, JSON.stringify(attackerError, null, 2));\n        await supabase.from('ColaMisiones').delete().eq('id', mision.id);\n        return;\n    }\n\n    const { data: propiedadDefensora, error: propError } = await supabase\n        .from('Propiedad')\n        .select(`*, \n            user:User(*), \n            habitaciones:HabitacionUsuario(*, configuracionHabitacion:ConfiguracionHabitacion(*)), \n            TropaUsuario:TropaUsuario(*, configuracionTropa:ConfiguracionTropa(*)), \n            TropaSeguridadUsuario:TropaSeguridadUsuario(*, configuracionTropa:ConfiguracionTropa(*))\n        `)\n        .eq('ciudad', mision.destinoCiudad)\n        .eq('barrio', mision.destinoBarrio)\n        .eq('edificio', mision.destinoEdificio)\n        .single();\n    \n    if (propError || !propiedadDefensora || !propiedadDefensora.user) {\n        await supabase.from('ColaMisiones').update({\n            tipoMision: 'REGRESO',\n            fechaRegreso: new Date(new Date().getTime() + mision.duracionViaje * 1000).toISOString()\n        }).eq('id', mision.id);\n        return;\n    }\n\n    const { data: defensor, error: defenderError } = await supabase\n        .from('User')\n        .select('*, entrenamientos:EntrenamientoUsuario(*), propiedades:Propiedad(*)')\n        .eq('id', propiedadDefensora.userId)\n        .single();\n\n    if (defenderError || !defensor) {\n         await supabase.from('ColaMisiones').update({\n            tipoMision: 'REGRESO',\n            fechaRegreso: new Date(new Date().getTime() + mision.duracionViaje * 1000).toISOString()\n        }).eq('id', mision.id);\n        return;\n    }\n\n    const attackerTroops = (mision.tropas as any[]).filter(t => t.id === ID_TROPA_ESPIA);\n    const defenderAllTroops = [...(propiedadDefensora.TropaUsuario as any[]), ...(propiedadDefensora.TropaSeguridadUsuario as any[])];\n\n    const attackerInput: SimulationInput = {\n        troops: attackerTroops.map(t => ({ id: t.id, quantity: t.cantidad })),\n        trainings: atacante.entrenamientos.map((t:any) => ({ id: t.configuracionEntrenamientoId, level: t.nivel })),\n        defenses: [],\n        buildingsLevel: 1, \n        propertyCount: atacante.propiedades.length,\n    };\n\n    const defenderInput: SimulationInput = {\n        troops: defenderAllTroops.map(t => ({ id: t.configuracionTropa.id, quantity: t.cantidad })),\n        trainings: defensor.entrenamientos.map((t: any) => ({ id: t.configuracionEntrenamientoId, level: t.nivel })),\n        defenses: [],\n        buildingsLevel: 1,\n        propertyCount: defensor.propiedades?.length || 1\n    };\n    \n    const combatReport = await runBattleSimulation(attackerInput, defenderInput);\n    \n    const spiesSurvived = combatReport.rounds.length > 0 && combatReport.winner === 'attacker';\n    \n    let intel: EspionageReportDetails['intel'] = null;\n    if (spiesSurvived) {\n        intel = {\n            resources: {\n                armas: Number(propiedadDefensora.armas),\n                municion: Number(propiedadDefensora.municion),\n                alcohol: Number(propiedadDefensora.alcohol),\n                dolares: Number(propiedadDefensora.dolares),\n            },\n            buildings: propiedadDefensora.habitaciones.map((h: any) => ({\n                id: h.configuracionHabitacionId,\n                name: h.configuracionHabitacion.nombre,\n                level: h.nivel\n            }))\n        }\n    }\n\n    const bigIntReplacer = (key: any, value: any) => typeof value === 'bigint' ? value.toString() : value;\n    const serializableReportDetails: EspionageReportDetails = {\n        combat: JSON.parse(JSON.stringify(combatReport, bigIntReplacer)),\n        intel: intel,\n        detected: false\n    };\n    \n    const survivingSpies = combatReport.rounds.length > 0 ? combatReport.rounds[combatReport.rounds.length - 1].attacker.troops.map(t => ({ id: t.id, cantidad: t.initialQuantity - t.lostQuantity })).filter(t => t.cantidad > 0) : [];\n    const nonSpyTroops = (mision.tropas as any[]).filter(t => t.id !== ID_TROPA_ESPIA);\n    const tropaRegreso = [...survivingSpies, ...nonSpyTroops];\n\n    const { data: espReport, error: createReportError } = await supabase.from('EspionageReport').insert({\n        attackerId: atacante.id,\n        defenderId: defensor.id,\n        details: serializableReportDetails as any,\n    }).select().single();\n\n    if(createReportError || !espReport) {\n        console.error(\"Error creating espionage report\", JSON.stringify(createReportError, null, 2));\n        return;\n    }\n\n    await Promise.all([\n        supabase.from('Message').insert({\n            recipientId: atacante.id,\n            subject: `Informe de Espionaje en ${mision.destinoCiudad}:${mision.destinoBarrio}`,\n            content: spiesSurvived ? `Tus espías han tenido éxito y han vuelto con información.` : `Tus espías han sido descubiertos y eliminados.`,\n            category: MessageCategory.ESPIONAJE,\n            espionageReportId: espReport.id,\n        }),\n        supabase.from('Message').insert({\n            recipientId: defensor.id,\n            subject: `Actividad de espionaje detectada`,\n            content: `Has detectado y combatido espías de ${atacante.name} en tu propiedad en [${mision.destinoCiudad}:${mision.destinoBarrio}].`,\n            category: MessageCategory.ESPIONAJE,\n            espionageReportId: espReport.id,\n        }),\n        supabase.from('ColaMisiones').update({\n            tipoMision: 'REGRESO',\n            tropas: tropaRegreso,\n            fechaRegreso: new Date(new Date().getTime() + mision.duracionViaje * 1000).toISOString()\n        }).eq('id', mision.id)\n    ]);\n\n    // REVALIDATION IS NOW HANDLED CENTRALLY in user.actions.ts\n}\n",
    "src/lib/actions/admin-db.actions.ts": "'use server';\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport { verifyAdminSession } from \"@/lib/auth-admin\";\n\nexport async function fetchDatabaseSchema() {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) {\n        return { error: \"No autorizado\" };\n    }\n\n    const supabase = await createClient();\n\n    try {\n        const { data, error } = await supabase.rpc('get_schema_introspection_data');\n\n        if (error) {\n            console.error(\"Error fetching schema data:\", error);\n            return { error: error.message };\n        }\n\n        return { data };\n    } catch (e: any) {\n        console.error(\"Exception fetching schema:\", e);\n        return { error: e.message };\n    }\n}\n",
    "src/lib/actions/auth.actions.ts": "\n'use server';\n\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { headers } from \"next/headers\";\nimport { z } from 'zod';\nimport { LoginSchema, RegisterSchema } from \"@/lib/schemas\";\n\n/**\n * Logs the login event to the database. Does not handle authentication itself.\n * @param userId The ID of the user who logged in.\n */\nasync function logLoginHistory(userId: string) {\n    const supabase = await createClient();\n    try {\n        const headerList = await headers();\n        \n        const ip = headerList.get('x-forwarded-for') ?? 'unknown';\n        const userAgent = headerList.get('user-agent') ?? 'unknown';\n\n        await supabase.from('LoginHistory').insert({\n            userId: userId,\n            ipAddress: ip,\n            userAgent: userAgent,\n        });\n    } catch (e) {\n        console.error(\"Failed to log login history:\", JSON.stringify(e, null, 2));\n    }\n}\n\n/**\n * Logs the user out by clearing the Supabase session cookie.\n */\nexport async function logout() {\n    const supabase = await createClient();\n    await supabase.auth.signOut();\n    revalidatePath('/');\n}\n\nexport async function login(credentials: z.infer<typeof LoginSchema>) {\n    try {\n        const validation = LoginSchema.safeParse(credentials);\n        if (!validation.success) {\n            return { error: 'Datos de entrada inválidos.' };\n        }\n\n        // CORRECCIÓN: Usamos 'email' directamente, no 'username'.\n        const { email, password } = validation.data;\n        const supabase = await createClient();\n\n        // Lógica simplificada: Iniciar sesión directamente con email y contraseña.\n        const { data: { user }, error: signInError } = await supabase.auth.signInWithPassword({\n            email: email,\n            password: password,\n        });\n\n        if (signInError || !user) {\n            // El error genérico de Supabase es suficiente y más seguro.\n            return { error: 'Credenciales de inicio de sesión inválidas.' };\n        }\n\n        // 🛡️ SELF-HEALING: Verificar si el usuario tiene datos completos.\n        try {\n            const { data: dbUser, error: dbError } = await supabase\n                .from('User')\n                .select('*, Propiedad(id)')\n                .eq('id', user.id)\n                .single();\n\n            // Validamos si tiene al menos una propiedad (Array no vacío)\n            // Nota: Si 'Propiedad' es null/undefined, la condición falla de forma segura.\n            // Supabase devuelve un array para relaciones One-to-Many.\n            const hasProperty = dbUser?.Propiedad && Array.isArray(dbUser.Propiedad) && dbUser.Propiedad.length > 0;\n\n            if (dbError || !dbUser || !hasProperty) {\n                 console.info(`[System] Usuario incompleto detectado en Login (${user.id}). Ejecutando autorreparación...`);\n                 const { data: repairResult, error: repairError } = await supabase.rpc('setup_new_user_game_data_rpc', { p_user_id: user.id });\n\n                 if (repairError) {\n                     console.error(\"[System] Error llamando a RPC de reparación:\", repairError);\n                 } else {\n                     console.info(`[System] Resultado de autorreparación: ${repairResult}`);\n                 }\n            }\n        } catch (err) {\n            console.error(\"[System] Excepción en autorreparación durante login:\", err);\n            // Fail open: Permitimos el login aunque la reparación falle, el usuario contactará soporte si ve algo raro.\n        }\n\n        await logLoginHistory(user.id);\n\n        // revalidatePath('/', 'layout');\n        return { success: true };\n    } catch (error) {\n        console.error(\"[AuthAction] CRITICAL LOGIN FAILURE:\", error);\n        return { error: 'Error interno del sistema. Contacte al administrador.' };\n    }\n}\n\n\nexport async function registerUser(input: z.infer<typeof RegisterSchema>) {\n    const result = RegisterSchema.safeParse(input);\n    if (!result.success) {\n        return { error: result.error.errors[0].message };\n    }\n\n    const headerList = await headers();\n    const host = headerList.get('host');\n    const protocol = headerList.get('x-forwarded-proto') ?? 'http';\n    const origin = headerList.get('origin') ?? process.env.NEXT_PUBLIC_SITE_URL ?? `${protocol}://${host}`;\n    \n    const { email, username, password, locationMode, coordinates } = result.data;\n    const supabase = await createClient();\n\n    // Check if username already exists in the public.User table (fast feedback)\n    // Usamos RPC para evitar problemas de RLS (Error 406/403) al consultar 'User' como anónimo.\n    const { data: isAvailable, error: userCheckError } = await supabase\n        .rpc('check_username_availability', { p_username: username });\n    \n    if (userCheckError) {\n        console.error(\"Error checking username via RPC:\", JSON.stringify(userCheckError, null, 2));\n        // Fallback or specific error handling can go here if needed.\n        return { error: \"Error al verificar el nombre de usuario.\" };\n    }\n\n    // check_username_availability returns TRUE if available (not exists), FALSE if occupied.\n    if (isAvailable === false) {\n        return { error: \"El nombre de usuario ya está en uso.\" };\n    }\n\n    // Call Supabase Auth - The DB Trigger `on_auth_user_created` will handle\n    // the creation of `public.User` and the initialization of game data (Property, Rooms, etc.)\n    const { data: { user, session }, error: signUpError } = await supabase.auth.signUp({\n        email,\n        password,\n        options: {\n            emailRedirectTo: `${origin}/auth/confirm`,\n            data: {\n                username: username,\n                name: username, // Default name same as username\n                title: 'Novato',\n                avatar_url: `https://placehold.co/128x128.png`, // snake_case for Supabase Auth metadata\n                location_mode: locationMode,\n                manual_coords: locationMode === 'manual' ? coordinates : null,\n            }\n        }\n    });\n\n    if (signUpError) {\n        console.error('Error durante el registro en Supabase Auth:', JSON.stringify(signUpError, null, 2));\n        if (signUpError.message.includes(\"User already registered\")) {\n             return { error: 'El correo electrónico ya está registrado.' };\n        }\n        if (signUpError.message.includes(\"UBICACION_OCUPADA\")) {\n             return { error: 'La ubicación seleccionada ya está ocupada.' };\n        }\n        return { error: signUpError.message || 'No se pudo crear la cuenta.' };\n    }\n\n    if (!user) {\n        return { error: 'No se pudo iniciar el proceso de registro.' };\n    }\n    \n    // Success: We rely on Eventual Consistency.\n    // The trigger will run in the background. The user will be redirected to login/dashboard.\n    // If the trigger fails, the user might exist in Auth but not in Public.\n    // The Login action has self-healing logic (or should have) to retry creation if needed,\n    // or the user will contact support.\n    \n    revalidatePath('/');\n\n    // Return whether a session was created (Auto-confirm enabled) or not (Email confirm required)\n    return { success: true, sessionCreated: !!session };\n}\n",
    "src/lib/actions/room.actions.ts": "'use server';\n\nimport { revalidatePath } from \"next/cache\";\nimport { getSessionUser } from \"../auth\";\nimport { createClient } from '@/utils/supabase/server';\nimport { createSafeAction } from \"../safe-action\";\nimport { z } from \"zod\";\nimport { CancelConstructionSchema } from \"../schemas\";\n\nconst ExpandRoomSchema = z.object({\n  propiedadId: z.string().uuid(),\n  habitacionId: z.string().min(1)\n});\n\nexport const iniciarAmpliacion = createSafeAction(ExpandRoomSchema, async (input) => {\n    const { propiedadId, habitacionId } = input;\n    console.log(`[Action: iniciarAmpliacion] Iniciando para propiedad: ${propiedadId}, habitacion: ${habitacionId}`);\n    const supabase = await createClient();\n    const user = await getSessionUser();\n  \n    if (!user) {\n      console.error('[Action: iniciarAmpliacion] Fallo: Usuario no autenticado.');\n      throw new Error('Usuario no autenticado.');\n    }\n\n    try {\n        // Llama al RPC atómico para iniciar la construcción\n        const { data, error } = await supabase.rpc('iniciar_construccion_habitacion', {\n            p_propiedad_id: propiedadId,\n            p_habitacion_id: habitacionId\n        });\n\n        if (error) {\n            console.error('[Action: iniciarAmpliacion] Error en RPC iniciar_construccion_habitacion:', JSON.stringify(error, null, 2));\n            // Devolvemos el error de la base de datos directamente si es posible\n            throw new Error(error.message || 'Ocurrió un error al procesar la solicitud.');\n        }\n\n        console.log('[Action: iniciarAmpliacion] Respuesta del RPC:', JSON.stringify(data, null, 2));\n\n        // El RPC devuelve un JSONB. Supabase lo tipa como 'any' o 'Json'.\n        // Casteamos para acceder a las propiedades.\n        const response = data as { error?: string, success?: string, nivelDestino?: number };\n\n        if (response?.error) {\n            console.warn(`[Action: iniciarAmpliacion] Error lógico devuelto por RPC: ${response.error}`);\n            throw new Error(response.error);\n        }\n\n        if (response?.success) {\n            console.log(`[Action: iniciarAmpliacion] Éxito: ${response.success}`);\n            revalidatePath('/(dashboard)/layout', 'layout');\n            return { success: response.success, nivelDestino: response.nivelDestino };\n        }\n\n        console.error('[Action: iniciarAmpliacion] Fallo: Respuesta inesperada del servidor.', response);\n        throw new Error('Respuesta inesperada del servidor.');\n\n    } catch (e: any) {\n        console.error('[Action: iniciarAmpliacion] Excepción capturada:', JSON.stringify(e, null, 2));\n        // If it's already an error object we threw, rethrow it or return its message\n        throw new Error(e.message || 'Error de conexión o inesperado.');\n    }\n});\n\n\nexport const cancelarConstruccion = createSafeAction(CancelConstructionSchema, async (input) => {\n    const { colaId } = input;\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) {\n        throw new Error('Usuario no autenticado.');\n    }\n\n    try {\n        const { data, error } = await supabase.rpc('cancelar_construccion_habitacion', {\n            p_cola_id: colaId\n        });\n\n        if (error) {\n            console.error('[Action: cancelarConstruccion] Error en RPC:', JSON.stringify(error, null, 2));\n            throw new Error(error.message || 'Error al cancelar la construcción.');\n        }\n\n        const response = data as { error?: string, success?: string };\n\n        if (response?.error) {\n             throw new Error(response.error);\n        }\n\n        revalidatePath('/(dashboard)/layout', 'layout');\n\n        return { success: response?.success || 'Construcción cancelada exitosamente.' };\n\n    } catch (e: any) {\n        console.error('[Action: cancelarConstruccion] Excepción:', JSON.stringify(e, null, 2));\n        throw new Error(e.message || 'Error inesperado.');\n    }\n});\n\nexport async function inicializarHabitacionesPropiedad(propiedadId: string) {\n    const supabase = await createClient();\n    \n    // 1. Obtener todas las configuraciones de habitaciones base\n    const { data: configs, error: configError } = await supabase\n        .from('ConfiguracionHabitacion')\n        .select('id');\n    \n    if (configError || !configs) {\n        console.error('Error al obtener configuraciones de habitación:', configError);\n        return { error: 'Error interno al inicializar habitaciones.' };\n    }\n\n    // 2. Preparar los registros para insertar\n    const habitacionesIniciales = configs.map(config => ({\n        propiedadId: propiedadId,\n        configuracionHabitacionId: config.id,\n        nivel: 0 // Se inician en nivel 0, listas para ser construidas\n    }));\n\n    // 3. Insertar masivamente usando upsert para evitar errores de duplicados.\n    const { error: upsertError } = await supabase\n        .from('HabitacionUsuario')\n        .upsert(habitacionesIniciales, { onConflict: 'propiedadId, configuracionHabitacionId', ignoreDuplicates: true });\n        \n    if (upsertError) {\n         console.error('Error al crear habitaciones iniciales:', upsertError);\n         return { error: 'No se pudieron crear las habitaciones de la propiedad.' };\n    }\n\n    return { success: true };\n}\n",
    "src/lib/actions/transport.actions.ts": "\nimport { createClient } from \"@/utils/supabase/server\";\nimport type { ColaMisiones } from '@/types';\n\nexport async function handleTransportMission(mision: ColaMisiones, supabaseClient?: any) {\n    const supabase = supabaseClient || await createClient();\n\n    // Call the RPC to process the mission\n    // Casting to 'any' because types are not regenerated\n    const { error } = await (supabase.rpc as any)('process_transport_mission', {\n        p_mission_id: mision.id\n    });\n\n    if (error) {\n        console.error(\"Error processing transport mission:\", JSON.stringify(error, null, 2));\n    }\n}\n",
    "src/lib/actions/message.actions.ts": "\n'use server';\n\nimport { MessageCategory } from '@/types';\nimport { getSessionUser } from \"../auth\";\nimport { revalidatePath } from \"next/cache\";\nimport { createClient } from \"@/utils/supabase/server\";\n\nexport async function sendMessage(formData: FormData) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n\n    const recipientId = formData.get('recipientId') as string;\n    const subject = formData.get('subject') as string;\n    const content = formData.get('content') as string;\n\n    if (!recipientId || !subject || !content) {\n        return { error: \"Todos los campos son obligatorios.\" };\n    }\n\n    try {\n        const { error } = await supabase.from('Message').insert({\n            senderId: user.id,\n            recipientId,\n            subject,\n            content,\n            category: MessageCategory.JUGADOR,\n        });\n\n        if (error) throw error;\n        revalidatePath('/messages');\n        return { success: true };\n    } catch (e) {\n        console.error(e);\n        return { error: \"No se pudo enviar el mensaje.\" };\n    }\n}\n\nexport async function markMessageAsRead(messageId: string) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n\n    try {\n        const { error } = await supabase.from('Message').update({ isRead: true })\n            .eq('id', messageId)\n            .eq('recipientId', user.id);\n        \n        if (error) throw error;\n        revalidatePath('/messages');\n        return { success: true };\n    } catch (e) {\n        console.error(e);\n        return { error: \"No se pudo marcar el mensaje como leído.\" };\n    }\n}\n\nexport async function deleteMessage(messageId: string) {\n    const supabase = await createClient();\n    const user = await getSessionUser();\n    if (!user) return { error: \"No autenticado.\" };\n\n    try {\n        const { error } = await supabase.from('Message').delete()\n            .eq('id', messageId)\n            .eq('recipientId', user.id);\n\n        if (error) throw error;\n        revalidatePath('/messages');\n        return { success: true };\n    } catch (e) {\n        console.error(e);\n        return { error: \"No se pudo eliminar el mensaje.\" };\n    }\n}\n",
    "src/lib/actions/defense.actions.ts": "\nimport { createClient } from \"@/utils/supabase/server\";\nimport type { ColaMisiones } from '@/types';\n\nexport async function handleDefendMission(mision: ColaMisiones, supabaseClient?: any) {\n    const supabase = supabaseClient || await createClient();\n\n    // Call the RPC to process the mission\n    // Casting to 'any' because types are not regenerated\n    const { error } = await (supabase.rpc as any)('process_defend_mission', {\n        p_mission_id: mision.id\n    });\n\n    if (error) {\n        console.error(\"Error processing defend mission:\", JSON.stringify(error, null, 2));\n    }\n}\n",
    "src/lib/actions/admin.actions.ts": "\n\n'use server';\n\nimport { revalidatePath } from \"next/cache\";\nimport { verifyAdminSession } from \"../auth-admin\";\nimport { createClient } from \"@/utils/supabase/server\";\nimport { AdminGameService } from \"../services/admin-game.service\";\nimport { TipoTropa } from '@/types';\nimport type { ConfiguracionHabitacion, TropaBonusContrincante, ConfiguracionEntrenamiento, ConfiguracionTropa } from '@/types';\nimport fs from 'fs/promises';\nimport path from 'path';\n\nconst parseNumber = (val: FormDataEntryValue | null) => Number(val) || 0;\nconst parseFloatValue = (val: FormDataEntryValue | null) => parseFloat(String(val)) || 0;\nconst parseString = (val: FormDataEntryValue | null) => String(val || '');\nconst parseNullString = (val: FormDataEntryValue | null) => val ? String(val) : null;\nconst parseStringArray = (val: FormDataEntryValue | null) => parseString(val).split(',').map(s => s.trim()).filter(Boolean);\n\nfunction convertToCsv(data: any[]): string {\n    if (data.length === 0) return '';\n    const headers = Object.keys(data[0]);\n    const csvRows = [\n        headers.join(','),\n        ...data.map(row => \n            headers.map(header => {\n                let value = row[header];\n                if (value === null || value === undefined) return '';\n                if (typeof value === 'string' && value.includes(',')) {\n                    return `\"${value}\"`;\n                }\n                return value;\n            }).join(',')\n        )\n    ];\n    return csvRows.join('\\n');\n}\n\nexport async function exportConfigurationData(data: any[], tableName: string) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n\n    const dirPath = path.join(process.cwd(), 'scripts', 'resultados', 'base', 'datos_configuracion');\n    \n    try {\n        await fs.mkdir(dirPath, { recursive: true });\n\n        // Guardar como JSON\n        const jsonFilePath = path.join(dirPath, `${tableName}.json`);\n        await fs.writeFile(jsonFilePath, JSON.stringify(data, null, 2));\n\n        // Convertir y guardar como CSV\n        const csvContent = convertToCsv(data);\n        const csvFilePath = path.join(dirPath, `${tableName}.csv`);\n        await fs.writeFile(csvFilePath, csvContent);\n        \n        return { success: `Datos exportados a ${dirPath}` };\n    } catch (e: any) {\n        console.error(\"Error exporting configuration data:\", e);\n        return { error: `No se pudo escribir el archivo: ${e.message}` };\n    }\n}\n\n\nexport async function exportSchemaDataToJSON(data: any[], fileName: string) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n\n    let dataToExport: any = data;\n\n    if (Array.isArray(data) && ['tablas.json', 'triggers.json', 'policies.json'].includes(fileName)) {\n        const groupedData: Record<string, any[]> = {};\n        data.forEach(row => {\n            const tableName = row.table_name;\n            if (!tableName) return;\n            if (!groupedData[tableName]) groupedData[tableName] = [];\n            const { table_name, ...rowData } = row;\n            groupedData[tableName].push(rowData);\n        });\n        dataToExport = groupedData;\n    }\n\n    try {\n        const dirPath = path.join(process.cwd(), 'scripts', 'resultados', 'base');\n        await fs.mkdir(dirPath, { recursive: true });\n        const filePath = path.join(dirPath, fileName);\n        await fs.writeFile(filePath, JSON.stringify(dataToExport, null, 2));\n        return { success: `Datos exportados a ${filePath}` };\n    } catch (e: any) {\n        console.error(\"Error exporting to JSON:\", e);\n        return { error: `No se pudo escribir el archivo: ${e.message}` };\n    }\n}\n\nexport async function exportAllSchemaData(data: { tables: any[], functions: any[], triggers: any[], policies: any[] }) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n\n    const filesToExport = {\n        'tablas.json': data.tables,\n        'funciones.json': data.functions,\n        'triggers.json': data.triggers,\n        'policies.json': data.policies,\n    };\n\n    try {\n        for (const [fileName, fileData] of Object.entries(filesToExport)) {\n            await exportSchemaDataToJSON(fileData, fileName);\n        }\n        return { success: \"Todos los datos del esquema han sido exportados.\" };\n    } catch (e: any) {\n        console.error(\"Error during batch export:\", e);\n        return { error: `Ocurrió un error durante la exportación masiva: ${e.message}` };\n    }\n}\n\n\n// Room Config CRUD\nexport async function saveRoomConfig(formData: FormData) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    const supabase = await createClient();\n\n    const originalId = parseString(formData.get('originalId'));\n    const id = parseString(formData.get('id')) || originalId;\n\n    if (!id) {\n        return { error: \"El ID de la habitación es obligatorio.\" };\n    }\n\n    const data: Omit<ConfiguracionHabitacion, 'created_at' | 'updated_at'> = {\n        id,\n        nombre: parseString(formData.get('nombre')),\n        descripcion: parseString(formData.get('descripcion')),\n        urlImagen: parseString(formData.get('urlImagen')),\n        costoArmas: parseNumber(formData.get('costoArmas')),\n        costoMunicion: parseNumber(formData.get('costoMunicion')),\n        costoDolares: parseNumber(formData.get('costoDolares')),\n        duracion: parseNumber(formData.get('duracion')),\n        produccionBase: parseFloatValue(formData.get('produccionBase')),\n        produccionRecurso: parseNullString(formData.get('produccionRecurso')),\n        puntos: parseFloatValue(formData.get('puntos')),\n    };\n\n    const requirementIds = formData.getAll('requirement_ids').map(String);\n    const newRequirements = requirementIds.map(reqId => {\n        const level = parseNumber(formData.get(`requirement_level_${reqId}`));\n        if (level <= 0) {\n            throw new Error(`Nivel inválido para el requisito ${reqId}`);\n        }\n        return { requiredRoomId: reqId, requiredLevel: level };\n    });\n\n    try {\n        await AdminGameService.upsertRoomConfig(data, newRequirements, originalId);\n        \n        revalidatePath('/admin/panel/rooms');\n        return { success: true };\n    } catch (e: any) {\n        return { error: e.message };\n    }\n}\n\nexport async function deleteRoomConfig(id: string) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    try {\n        await AdminGameService.deleteRoomConfig(id);\n\n        revalidatePath('/admin/panel/rooms');\n        return { success: true };\n    } catch (e: any) {\n        return { error: e.message };\n    }\n}\n\n\n// Training Config CRUD\nexport async function saveTrainingConfig(formData: FormData) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    const supabase = await createClient();\n\n    const originalId = parseString(formData.get('originalId'));\n    const id = parseString(formData.get('id')) || originalId;\n    \n    if (!id) {\n        return { error: \"El ID del entrenamiento es obligatorio.\" };\n    }\n\n    const data: Omit<ConfiguracionEntrenamiento, 'created_at' | 'updated_at'> = {\n        id,\n        nombre: parseString(formData.get('nombre')),\n        urlImagen: parseString(formData.get('urlImagen')),\n        costoArmas: parseNumber(formData.get('costoArmas')),\n        costoMunicion: parseNumber(formData.get('costoMunicion')),\n        costoDolares: parseNumber(formData.get('costoDolares')),\n        duracion: parseNumber(formData.get('duracion')),\n        puntos: parseFloatValue(formData.get('puntos')),\n    };\n\n    const requirementIds = formData.getAll('requirement_ids').map(String);\n    const newRequirements = requirementIds.map(reqId => {\n        const level = parseNumber(formData.get(`requirement_level_${reqId}`));\n        if (level <= 0) {\n            throw new Error(`Nivel inválido para el requisito ${reqId}`);\n        }\n        return { requiredTrainingId: reqId, requiredLevel: level };\n    });\n\n    try {\n        await AdminGameService.upsertTrainingConfig(data, newRequirements, originalId);\n        \n        revalidatePath('/admin/panel/trainings');\n        return { success: true };\n    } catch (e: any) {\n        return { error: e.message };\n    }\n}\n\nexport async function deleteTrainingConfig(id: string) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    try {\n        await AdminGameService.deleteTrainingConfig(id);\n        \n        revalidatePath('/admin/panel/trainings');\n        return { success: true };\n    } catch (e: any) {\n        return { error: e.message };\n    }\n}\n\n\n// Troop Config CRUD\nexport async function saveTroopConfig(formData: FormData) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    const supabase = await createClient();\n    \n    const id = parseString(formData.get('idForm')) || parseString(formData.get('id'));\n     if (!id) {\n        return { error: \"El ID de la tropa es obligatorio.\" };\n    }\n    \n    // In current DB schema, requisitos is a simple string[] on the ConfiguracionTropa table.\n    // It is NOT a separate table 'TroopTrainingRequirement'.\n    // The previous code was trying to join or insert into a non-existent table.\n    \n    // Requirements (expected as an array of training IDs)\n    const requisitosData = JSON.parse(parseString(formData.get('requisitos')) || '[]');\n    // Extract just the training IDs to store in the string[] column\n    const requisitos = requisitosData.map((r: { requiredTrainingId: string, requiredLevel: number }) => r.requiredTrainingId);\n    \n    const data: Omit<ConfiguracionTropa, 'created_at' | 'updated_at'> = {\n        id,\n        nombre: parseString(formData.get('nombre')),\n        urlImagen: parseString(formData.get('urlImagen')),\n        descripcion: parseString(formData.get('descripcion')),\n        costoArmas: parseNumber(formData.get('costoArmas')),\n        costoMunicion: parseNumber(formData.get('costoMunicion')),\n        costoDolares: parseNumber(formData.get('costoDolares')),\n        duracion: parseNumber(formData.get('duracion')),\n        puntos: parseFloatValue(formData.get('puntos')),\n        ataque: parseNumber(formData.get('ataque')),\n        defensa: parseNumber(formData.get('defensa')),\n        capacidad: parseNumber(formData.get('capacidad')),\n        velocidad: parseNumber(formData.get('velocidad')),\n        salario: parseNumber(formData.get('salario')),\n        tipo: parseString(formData.get('tipo')) as TipoTropa,\n        requisitos: requisitos, // Store IDs directly\n        bonusAtaque: parseStringArray(formData.get('bonusAtaque')),\n        bonusDefensa: parseStringArray(formData.get('bonusDefensa')),\n    };\n\n    const bonusContrincantes = JSON.parse(parseString(formData.get('bonusContrincantes')) || '[]') as {tropaDefensoraId: string, factorPrioridad: number}[];\n\n    try {\n        await AdminGameService.upsertTroopConfig(data, bonusContrincantes);\n\n        revalidatePath('/admin/panel/troops');\n        return { success: true };\n    } catch (e: any) {\n        return { error: e.message };\n    }\n}\n\nexport async function deleteTroopConfig(id: string) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    try {\n        await AdminGameService.deleteTroopConfig(id);\n\n        revalidatePath('/admin/panel/troops');\n        return { success: true };\n    } catch (e: any) {\n        return { error: e.message };\n    }\n}\n\n// Bonus Config\nexport async function saveTroopBonusConfig(bonusData: Omit<TropaBonusContrincante, 'id' | 'created_at' | 'updated_at'>[]) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    try {\n        await AdminGameService.upsertTroopBonuses(bonusData);\n        \n        revalidatePath('/admin/panel/bonus');\n        return { success: true };\n    } catch (e: any) {\n        console.error(e);\n        return { error: \"Error al guardar la configuración de bonus.\" };\n    }\n}\n\n// Property Management\nexport async function createPropertyForUser(formData: FormData) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    const supabase = await createClient();\n\n    const userId = parseString(formData.get('userId'));\n    const ciudad = parseNumber(formData.get('ciudad'));\n    const barrio = parseNumber(formData.get('barrio'));\n    const edificio = parseNumber(formData.get('edificio'));\n    const roomLevels = JSON.parse(parseString(formData.get('roomLevels')) || '{}') as Record<string, number>;\n\n    if (!userId) return { error: \"Se debe seleccionar un usuario.\" };\n    if (!ciudad || !barrio || !edificio) return { error: \"Las coordenadas son obligatorias.\" };\n\n    const roomLevelsArray = Object.entries(roomLevels)\n        .filter(([, level]) => level > 0)\n        .map(([id, level]) => ({ room_id: id, level: level }));\n\n    try {\n        const { error } = await supabase.rpc('create_property_for_user', {\n            p_user_id: userId,\n            p_ciudad: ciudad,\n            p_barrio: barrio,\n            p_edificio: edificio,\n            p_room_levels: roomLevelsArray\n        });\n\n        if (error) {\n            console.error(\"Error calling create_property_for_user RPC:\", JSON.stringify(error, null, 2));\n            if (error.message.includes(\"already exists\")) {\n                return { error: `La propiedad en las coordenadas ${ciudad}:${barrio}:${edificio} ya existe.` };\n            }\n            throw error;\n        }\n\n        revalidatePath('/(dashboard)', 'layout');\n        return { success: `Nueva propiedad creada para el usuario ${userId} en ${ciudad}:${barrio}:${edificio}` };\n    } catch(e: any) {\n        return { error: e.message || 'Error al crear la propiedad.' };\n    }\n}\n\n\nexport async function updatePropertyByAdmin(formData: FormData) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    const supabase = await createClient();\n\n    try {\n        const propertyId = parseString(formData.get('propertyId'));\n        const propertyName = parseString(formData.get('propertyName'));\n        const resources = JSON.parse(parseString(formData.get('resources')));\n        const roomLevels = JSON.parse(parseString(formData.get('roomLevels')));\n        const attackTroops = JSON.parse(parseString(formData.get('attackTroops')));\n        const defenseTroops = JSON.parse(parseString(formData.get('defenseTroops')));\n        \n        const { error } = await supabase.rpc('update_property_as_admin', {\n            p_property_id: propertyId,\n            p_nombre: propertyName,\n            p_resources: resources,\n            p_room_levels: roomLevels,\n            p_attack_troops: attackTroops,\n            p_defense_troops: defenseTroops\n        });\n\n        if (error) {\n            console.error(\"Error en RPC update_property_as_admin:\", JSON.stringify(error, null, 2));\n            throw error;\n        }\n\n        revalidatePath('/admin/panel/properties');\n        revalidatePath(`/admin/panel/properties/${propertyId}`);\n        return { success: \"Propiedad actualizada correctamente.\" };\n    } catch(e: any) {\n        return { error: e.message || \"Error al actualizar la propiedad.\" };\n    }\n}\n\nexport async function deletePropertyByAdmin(propertyId: string) {\n    const isAdmin = await verifyAdminSession();\n    if (!isAdmin) return { error: \"No autorizado\" };\n    const supabase = await createClient();\n\n    try {\n        // Correctly using delete_property_and_contents RPC which is known to exist in migrations\n        // Assuming delete_property_and_contents is defined in the DB. If TS complains, we might need to cast supabase client.\n        const { error } = await (supabase.rpc as any)('delete_property_and_contents', { p_property_id: propertyId });\n        if (error) throw error;\n        \n        revalidatePath('/admin/panel/properties');\n        return { success: \"Propiedad eliminada con éxito.\" };\n    } catch(e: any) {\n        console.error(\"Error deleting property:\", JSON.stringify(e, null, 2));\n        return { error: e.message || \"Error al eliminar la propiedad.\" };\n    }\n}\n",
    "src/lib/actions/occupy.actions.ts": "\n'use server';\n\nimport { createClient } from \"@/utils/supabase/server\";\nimport type { ColaMisiones } from '@/types';\nimport { revalidatePath } from \"next/cache\";\n\nexport async function handleOccupyMission(mision: ColaMisiones, supabaseClient?: any) {\n    const supabase = supabaseClient || await createClient();\n\n    // 1. Call the atomic RPC function to process the occupation\n    const { data, error } = await supabase.rpc('ocupar_y_procesar_mision', {\n        p_mission_id: mision.id\n    });\n\n    if (error) {\n        console.error(\"Error processing occupation mission via RPC:\", JSON.stringify(error, null, 2));\n        // No manual rollback needed; the RPC transaction ensures atomicity.\n        return;\n    }\n    \n    // Check custom error from RPC result if it's not a standard postgrest error but a logical one returned in JSON\n    if (data && typeof data === 'object' && !Array.isArray(data) && 'error' in data) {\n         console.error(\"Occupation mission failed (logic error):\", (data as any).error);\n         // Optionally handle specific logic errors (e.g. notify user)\n         return;\n    }\n\n    // REVALIDATION IS NOW HANDLED CENTRALLY in user.actions.ts\n}\n",
    "src/lib/actions/brawl.actions.ts": "\nimport { createClient } from \"@/utils/supabase/server\";\nimport { revalidatePath } from \"next/cache\";\nimport { runBattleSimulation } from \"./simulation.actions\";\nimport type { ColaMisiones } from '@/types';\nimport { MessageCategory } from '@/types';\nimport type { SimulationInput } from '@/types/simulation.types';\n\nexport async function handleAttackMission(mision: ColaMisiones, supabaseClient?: any) {\n    const supabase = supabaseClient || await createClient();\n    \n    const { data: atacante, error: attackerError } = await supabase.from('User').select('*, propiedades:Propiedad(*), entrenamientos:EntrenamientoUsuario(*)').eq('id', mision.userId).single();\n    if (attackerError || !atacante) {\n        console.error(\"Atacante no encontrado para la misión:\", mision.id, JSON.stringify(attackerError, null, 2));\n        await supabase.from('ColaMisiones').delete().eq('id', mision.id);\n        return;\n    }\n\n    const { data: propiedadDefensora, error: propError } = await supabase\n        .from('Propiedad')\n        .select('id, userId')\n        .eq('ciudad', mision.destinoCiudad)\n        .eq('barrio', mision.destinoBarrio)\n        .eq('edificio', mision.destinoEdificio)\n        .single();\n    \n    if (propError || !propiedadDefensora || !propiedadDefensora.userId) {\n        await supabase.from('ColaMisiones').update({ \n            tipoMision: 'REGRESO',\n            fechaRegreso: new Date(new Date().getTime() + mision.duracionViaje * 1000).toISOString()\n        }).eq('id', mision.id);\n        return;\n    }\n\n    const { data: defensor, error: defenderError } = await supabase\n        .from('User')\n        .select('*, propiedades:Propiedad(*, TropaUsuario:TropaUsuario(*, configuracionTropa:ConfiguracionTropa(*)), TropaSeguridadUsuario:TropaSeguridadUsuario(*, configuracionTropa:ConfiguracionTropa(*))), entrenamientos:EntrenamientoUsuario(*)')\n        .eq('id', propiedadDefensora.userId)\n        .single();\n    \n    if (defenderError || !defensor) {\n        console.error(\"Defensor no encontrado para la propiedad:\", propiedadDefensora.id, JSON.stringify(defenderError, null, 2));\n         await supabase.from('ColaMisiones').update({ \n            tipoMision: 'REGRESO',\n            fechaRegreso: new Date(new Date().getTime() + mision.duracionViaje * 1000).toISOString()\n        }).eq('id', mision.id);\n        return;\n    }\n    \n    const attackerTroops = (mision.tropas as any[]).map(t => ({ id: t.id, quantity: t.cantidad }));\n\n    const attackerInput: SimulationInput = {\n        troops: attackerTroops,\n        trainings: atacante.entrenamientos.map((t: any) => ({ id: t.configuracionEntrenamientoId, level: t.nivel })),\n        defenses: [],\n        buildingsLevel: 1, \n        propertyCount: atacante.propiedades.length,\n    };\n\n    const defenderInput: SimulationInput = {\n        troops: defensor.propiedades.flatMap((p: any) => [...p.TropaUsuario, ...p.TropaSeguridadUsuario].map((t: any) => ({ id: t.configuracionTropa.id, quantity: t.cantidad }))),\n        trainings: defensor.entrenamientos.map((t: any) => ({ id: t.configuracionEntrenamientoId, level: t.nivel })),\n        defenses: [], \n        buildingsLevel: 1,\n        propertyCount: defensor.propiedades?.length || 1\n    };\n\n    const report = await runBattleSimulation(attackerInput, defenderInput);\n    \n    let tropaRegreso: { id: string, cantidad: number }[];\n\n    if (report.rounds.length > 0) {\n        tropaRegreso = report.rounds[report.rounds.length - 1].attacker.troops\n            .map(t => ({ id: t.id, cantidad: t.initialQuantity - t.lostQuantity }))\n            .filter(t => t.cantidad > 0);\n    } else {\n        tropaRegreso = (mision.tropas as any[]).map(t => ({ id: t.id, cantidad: t.cantidad }));\n    }\n\n    const bigIntReplacer = (key: any, value: any) => typeof value === 'bigint' ? value.toString() : value;\n    const serializableReport = JSON.parse(JSON.stringify(report, bigIntReplacer));\n\n    const honorGanadoAtacante = report.finalStats.defender.pointsLost;\n    const honorGanadoDefensor = report.finalStats.attacker.pointsLost;\n    \n    const { error: rpcError } = await supabase.rpc('process_battle_report', {\n        p_attacker_id: atacante.id,\n        p_defender_id: defensor.id,\n        p_winner: report.winner,\n        p_details: serializableReport,\n        p_ciudad: mision.destinoCiudad,\n        p_barrio: mision.destinoBarrio,\n        p_edificio: mision.destinoEdificio,\n        p_attacker_honor_gain: honorGanadoAtacante,\n        p_defender_honor_gain: honorGanadoDefensor,\n        p_mission_id: mision.id,\n        p_surviving_troops: tropaRegreso,\n        p_return_time: new Date(new Date().getTime() + mision.duracionViaje * 1000).toISOString(),\n        p_defender_losses: report.rounds.length > 0 ? report.rounds[report.rounds.length - 1].defender.troops.map(t => ({id: t.id, lost: t.lostQuantity})) : [],\n        p_propiedad_origen_id: mision.propiedadOrigenId,\n    });\n\n    if (rpcError) {\n        console.error(\"Error processing battle report via RPC\", JSON.stringify(rpcError, null, 2));\n    }\n}\n",
    "src/store/atoms.ts": "import { atom } from 'jotai';\nimport { FullPropiedad, ColaMisiones, UserWithProgress } from '@/types';\n\n// ============================================================================\n// BASE ATOMS\n// ============================================================================\n\n// Stores the user's core profile data (lightweight)\nexport const userProfileAtom = atom<UserWithProgress | null>(null);\n\n// Stores all properties with their full data (including nested queues)\nexport const propertiesAtom = atom<FullPropiedad[]>([]);\n\n// Stores active missions\nexport const activeMissionsAtom = atom<ColaMisiones[]>([]);\n\n// Stores the ID of the currently selected property (UI State)\nexport const activePropertyIdAtom = atom<string | null>(null);\n\n// ============================================================================\n// DERIVED ATOMS (READ-ONLY)\n// ============================================================================\n\n// Returns the full object of the currently selected property\nexport const activePropertyAtom = atom(\n    (get) => {\n        const properties = get(propertiesAtom);\n        const activeId = get(activePropertyIdAtom);\n        if (!activeId) return properties.length > 0 ? properties[0] : null;\n        return properties.find((p) => p.id === activeId) || properties[0] || null;\n    }\n);\n\n// Returns only the resources of the active property\nexport const activeResourcesAtom = atom(\n    (get) => {\n        const p = get(activePropertyAtom);\n        if (!p) return null;\n        return {\n            armas: p.armas,\n            municion: p.municion,\n            dolares: p.dolares,\n            alcohol: p.alcohol\n        };\n    }\n);\n\n// ============================================================================\n// ACTION ATOMS (WRITE-ONLY / UPDATES)\n// ============================================================================\n\n// Optimistically updates resources for the ACTIVE property\nexport const updateActiveResourcesAtom = atom(\n    null,\n    (get, set, update: Partial<{ armas: number; municion: number; dolares: number; alcohol: number }>) => {\n        const activeProp = get(activePropertyAtom);\n        if (!activeProp) return;\n\n        set(propertiesAtom, (prevProps) =>\n            prevProps.map((p) => {\n                if (p.id === activeProp.id) {\n                    return { ...p, ...update };\n                }\n                return p;\n            })\n        );\n    }\n);\n\n// Optimistically updates resources for a SPECIFIC property by ID\nexport const updatePropertyResourcesAtom = atom(\n    null,\n    (get, set, { propertyId, update }: { propertyId: string; update: Partial<{ armas: number; municion: number; dolares: number; alcohol: number }> }) => {\n        set(propertiesAtom, (prevProps) =>\n            prevProps.map((p) => {\n                if (p.id === propertyId) {\n                    return { ...p, ...update };\n                }\n                return p;\n            })\n        );\n    }\n);\n",
    "src/types/index.ts": "import type { Tables, Enums, Database } from './database';\nimport type { BattleSimulationResult, EspionageReportDetails as EspionageReportDetailsType, MinimalTroopConfig } from './simulation.types';\nimport type { MissionInput as ZodMissionInput } from '@/lib/schemas';\n\n// --- ENUMS ---\nexport type FamilyRole = Enums<'FamilyRole'>;\nexport type InvitationType = Enums<'InvitationType'>;\nexport type InvitationStatus = Enums<'InvitationStatus'>;\nexport type MessageCategory = Enums<'MessageCategory'>;\nexport type TipoTropa = Enums<'TipoTropa'>;\n\n// También exportar los valores como constantes para su uso en runtime.\nexport const FamilyRole = {\n    LEADER: 'LEADER',\n    CO_LEADER: 'CO_LEADER',\n    MEMBER: 'MEMBER',\n} as const;\n\nexport const InvitationType = {\n    INVITATION: 'INVITATION',\n    REQUEST: 'REQUEST',\n} as const;\n\nexport const InvitationStatus = {\n    PENDING: 'PENDING',\n    ACCEPTED: 'ACCEPTED',\n    REJECTED: 'REJECTED',\n    CANCELLED: 'CANCELLED',\n} as const;\n\nexport const MessageCategory = {\n    JUGADOR: 'JUGADOR',\n    BATALLA: 'BATALLA',\n    CONSTRUCCION: 'CONSTRUCCION',\n    SISTEMA: 'SISTEMA',\n    ESPIONAJE: 'ESPIONAJE',\n} as const;\n\nexport const TipoTropa = {\n    ATAQUE: 'ATAQUE',\n    DEFENSA: 'DEFENSA',\n    TRANSPORTE: 'TRANSPORTE',\n    ESPIONAJE: 'ESPIONAJE',\n    OCUPAR: 'OCUPAR',\n} as const;\n\n\n// --- BASE TYPES FROM DATABASE ---\nexport type User = Tables<'User'>;\nexport type Propiedad = Tables<'Propiedad'>;\nexport type ConfiguracionHabitacion = Tables<'ConfiguracionHabitacion'>;\nexport type RoomRequirement = Tables<'RoomRequirement'>;\nexport type HabitacionUsuario = Tables<'HabitacionUsuario'>;\nexport type ColaConstruccion = Tables<'ColaConstruccion'>;\nexport type ConfiguracionEntrenamiento = Tables<'ConfiguracionEntrenamiento'>;\nexport type TrainingRequirement = Tables<'TrainingRequirement'>;\nexport type EntrenamientoUsuario = Tables<'EntrenamientoUsuario'>;\nexport type ColaEntrenamiento = Tables<'ColaEntrenamiento'>;\nexport type PuntuacionUsuario = Tables<'PuntuacionUsuario'>;\nexport type ConfiguracionTropa = Tables<'ConfiguracionTropa'>;\nexport type TropaBonusContrincante = Tables<'TropaBonusContrincante'>;\nexport type TropaUsuario = Tables<'TropaUsuario'>;\nexport type TropaSeguridadUsuario = Tables<'TropaSeguridadUsuario'>;\nexport type ColaReclutamiento = Tables<'ColaReclutamiento'>;\nexport type ColaMisiones = Tables<'ColaMisiones'>;\nexport type IncomingAttack = Tables<'IncomingAttack'>;\nexport type Family = Tables<'Family'>;\nexport type FamilyMember = Tables<'FamilyMember'>;\nexport type FamilyAnnouncement = Tables<'FamilyAnnouncement'>;\nexport type FamilyInvitation = Tables<'FamilyInvitation'>;\nexport type Message = Tables<'Message'>;\nexport type BattleReport = Tables<'BattleReport'>;\nexport type EspionageReport = Tables<'EspionageReport'>;\n\n\n// --- COMBINED & FULL TYPES (Tipos compuestos y enriquecidos) ---\n\nexport type FullConfiguracionHabitacion = ConfiguracionHabitacion & {\n    requisitos: RoomRequirement[];\n};\n\nexport type FullConfiguracionEntrenamiento = ConfiguracionEntrenamiento & {\n    requisitos: TrainingRequirement[];\n};\n\nexport type FullConfiguracionTropa = ConfiguracionTropa & {\n    bonusContrincante: TropaBonusContrincante[];\n};\n\nexport type FullHabitacionUsuario = HabitacionUsuario & { \n    configuracionHabitacion: FullConfiguracionHabitacion \n};\n\nexport type FullColaReclutamiento = ColaReclutamiento & {\n    tropaConfig: ConfiguracionTropa;\n};\n\nexport type FullColaEntrenamiento = ColaEntrenamiento & {\n    entrenamiento: ConfiguracionEntrenamiento;\n    propiedad: { nombre: string };\n};\n\nexport type FullTropaUsuario = TropaUsuario & {\n    configuracionTropa: ConfiguracionTropa;\n};\n\nexport type FullTropaSeguridadUsuario = TropaSeguridadUsuario & {\n    configuracionTropa: ConfiguracionTropa;\n};\n\nexport type FullPropiedad = Omit<Propiedad, 'alcohol' | 'armas' | 'dolares' | 'municion'> & {\n    alcohol: number;\n    armas: number;\n    dolares: number;\n    municion: number;\n    habitaciones: FullHabitacionUsuario[];\n    colaConstruccion: ColaConstruccion[];\n    colaReclutamiento: FullColaReclutamiento[]; // CORREGIDO: Debería ser un array\n    TropaUsuario: FullTropaUsuario[];\n    TropaSeguridadUsuario: FullTropaSeguridadUsuario[];\n};\n\nexport type FullFamilyMember = FamilyMember & { \n    user: UserWithProgress;\n};\n\nexport type FullFamilyAnnouncement = FamilyAnnouncement & {\n    author: Pick<User, 'id' | 'name' | 'avatarUrl'>;\n};\n\n// Tipo para la familia cuando se cargan todos los miembros y anuncios como objetos\nexport type FullFamily = Family & {\n    members: FullFamilyMember[];\n    announcements: FullFamilyAnnouncement[];\n};\n\n// 🟢 NUEVO TIPO: Tipo para la familia en tablas de clasificación (solo conteos y puntos)\nexport type FamilyForRanking = Family & {\n    members: {count: number}[]; // Conteo de miembros\n    announcements: {count: number}[]; // Conteo de anuncios\n    totalPoints?: number; // Puntuación total del ranking\n};\n\n// 🟢 NUEVO TIPO: Definición flexible para invitaciones enriquecidas\nexport type FullFamilyInvitation = FamilyInvitation & (\n    {\n        // Para getFamilyRequests: Usuario que solicitó unirse (tiene puntuacion)\n        user: Pick<User, 'id' | 'name' | 'avatarUrl'> & { puntuacion: PuntuacionUsuario | null }; \n        family?: never; // No incluye el objeto family\n    } | {\n        // Para getInvitationsForUser: Invitación de una familia a un usuario\n        family: Pick<Family, 'id' | 'name' | 'tag' | 'avatarUrl'>;\n        user?: never; // No incluye el objeto user enriquecido\n    }\n);\n\n\nexport type FullMessage = Message & {\n    sender: Pick<User, 'id' | 'name' | 'avatarUrl'> | null;\n};\n\nexport type FullBattleReport = BattleReport & {\n    attacker: Pick<User, 'id' | 'name' | 'avatarUrl'>;\n    defender: Pick<User, 'id' | 'name' | 'avatarUrl'>;\n};\n\nexport type FullEspionageReport = EspionageReport & {\n    attacker: Pick<User, 'id' | 'name' | 'avatarUrl'>;\n    defender: Pick<User, 'id' | 'name' | 'avatarUrl'>;\n    details: EspionageReportDetails;\n};\n\n// --- USER-CENTRIC TYPES (Tipos centrados en el usuario) ---\n\nexport type UserWithProgress = User & {\n    propiedades: FullPropiedad[];\n    entrenamientos: (EntrenamientoUsuario & { configuracionEntrenamiento: ConfiguracionEntrenamiento })[];\n    puntuacion: PuntuacionUsuario | null;\n    misiones: ColaMisiones[];\n    incomingAttacks: IncomingAttack[];\n    colaEntrenamientos: FullColaEntrenamiento[];\n    familyMember: (FamilyMember & { family: FullFamily }) | null;\n    _count: {\n        receivedMessages: number;\n    }\n};\n\nexport type UserProfileData = Pick<User, 'id' | 'name' | 'title' | 'avatarUrl' | 'created_at'> & {\n    puntuacion: PuntuacionUsuario | null;\n    propiedades: Pick<Propiedad, 'id' | 'nombre' | 'ciudad' | 'barrio' | 'edificio'>[];\n    familyMember: (FamilyMember & { family: Pick<Family, 'id' | 'name' | 'tag' | 'avatarUrl'> }) | null;\n};\n\n// Tipo para las tablas de clasificación.\nexport type UserForRanking = User & {\n    puntuacion: PuntuacionUsuario | null;\n    _count: {\n        propiedades: number;\n    }\n};\n\nexport type PropertyWithOwner = Propiedad & { \n    user: UserProfileData | null;\n};\n\nexport type UserForOverview = Pick<UserWithProgress, 'propiedades' | 'colaEntrenamientos'>;\n\n\n// --- INPUT & ACTION TYPES ---\n\nexport type MissionInput = ZodMissionInput;\n\nexport type EspionageReportDetails = EspionageReportDetailsType;\n\nexport type ActionResponse<T = void> = { success: true; data?: T } | { success: false; error: string };\n",
    "src/types/database.ts": "export type Json =\n  | string\n  | number\n  | boolean\n  | null\n  | { [key: string]: Json | undefined }\n  | Json[]\n\nexport type Database = {\n  // Allows to automatically instantiate createClient with right options\n  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)\n  __InternalSupabase: {\n    PostgrestVersion: \"13.0.5\"\n  }\n  public: {\n    Tables: {\n      BattleReport: {\n        Row: {\n          attackerId: string\n          barrio: number\n          ciudad: number\n          created_at: string\n          defenderId: string\n          details: Json\n          edificio: number\n          id: string\n          updated_at: string\n          winner: string\n        }\n        Insert: {\n          attackerId: string\n          barrio: number\n          ciudad: number\n          created_at?: string\n          defenderId: string\n          details: Json\n          edificio: number\n          id?: string\n          updated_at?: string\n          winner: string\n        }\n        Update: {\n          attackerId?: string\n          barrio?: number\n          ciudad?: number\n          created_at?: string\n          defenderId?: string\n          details?: Json\n          edificio?: number\n          id?: string\n          updated_at?: string\n          winner?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"BattleReport_attackerId_fkey\"\n            columns: [\"attackerId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"BattleReport_defenderId_fkey\"\n            columns: [\"defenderId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      ColaConstruccion: {\n        Row: {\n          created_at: string\n          duracion: number\n          fechaFinalizacion: string | null\n          fechaInicio: string\n          habitacionId: string\n          id: string\n          nivelDestino: number\n          propiedadId: string\n          updated_at: string\n        }\n        Insert: {\n          created_at?: string\n          duracion: number\n          fechaFinalizacion?: string | null\n          fechaInicio: string\n          habitacionId: string\n          id?: string\n          nivelDestino: number\n          propiedadId: string\n          updated_at?: string\n        }\n        Update: {\n          created_at?: string\n          duracion?: number\n          fechaFinalizacion?: string | null\n          fechaInicio?: string\n          habitacionId?: string\n          id?: string\n          nivelDestino?: number\n          propiedadId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"colaconstruccion_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colaconstruccion_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      ColaEntrenamiento: {\n        Row: {\n          created_at: string\n          entrenamientoId: string\n          fechaFinalizacion: string\n          fechaInicio: string\n          id: string\n          nivelDestino: number\n          propiedadId: string\n          updated_at: string\n          userId: string\n        }\n        Insert: {\n          created_at?: string\n          entrenamientoId: string\n          fechaFinalizacion: string\n          fechaInicio: string\n          id?: string\n          nivelDestino: number\n          propiedadId: string\n          updated_at?: string\n          userId: string\n        }\n        Update: {\n          created_at?: string\n          entrenamientoId?: string\n          fechaFinalizacion?: string\n          fechaInicio?: string\n          id?: string\n          nivelDestino?: number\n          propiedadId?: string\n          updated_at?: string\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"colaentrenamiento_entrenamientoid_fkey\"\n            columns: [\"entrenamientoId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionEntrenamiento\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colaentrenamiento_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: true\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colaentrenamiento_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: true\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colaentrenamiento_userid_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      ColaMisiones: {\n        Row: {\n          created_at: string\n          destinoBarrio: number\n          destinoCiudad: number\n          destinoEdificio: number\n          duracionViaje: number\n          fechaInicio: string\n          fechaLlegada: string\n          fechaRegreso: string | null\n          id: string\n          origenBarrio: number\n          origenCiudad: number\n          origenEdificio: number\n          propiedadOrigenId: string\n          recursos: Json | null\n          tipoMision: string\n          tropas: Json\n          updated_at: string\n          userId: string\n          velocidadFlota: number\n        }\n        Insert: {\n          created_at?: string\n          destinoBarrio: number\n          destinoCiudad: number\n          destinoEdificio: number\n          duracionViaje: number\n          fechaInicio: string\n          fechaLlegada: string\n          fechaRegreso?: string | null\n          id?: string\n          origenBarrio: number\n          origenCiudad: number\n          origenEdificio: number\n          propiedadOrigenId: string\n          recursos?: Json | null\n          tipoMision: string\n          tropas: Json\n          updated_at?: string\n          userId: string\n          velocidadFlota: number\n        }\n        Update: {\n          created_at?: string\n          destinoBarrio?: number\n          destinoCiudad?: number\n          destinoEdificio?: number\n          duracionViaje?: number\n          fechaInicio?: string\n          fechaLlegada?: string\n          fechaRegreso?: string | null\n          id?: string\n          origenBarrio?: number\n          origenCiudad?: number\n          origenEdificio?: number\n          propiedadOrigenId?: string\n          recursos?: Json | null\n          tipoMision?: string\n          tropas?: Json\n          updated_at?: string\n          userId?: string\n          velocidadFlota?: number\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"colamisiones_propiedadorigenid_fkey\"\n            columns: [\"propiedadOrigenId\"]\n            isOneToOne: false\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colamisiones_propiedadorigenid_fkey\"\n            columns: [\"propiedadOrigenId\"]\n            isOneToOne: false\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colamisiones_userid_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      ColaReclutamiento: {\n        Row: {\n          cantidad: number\n          created_at: string\n          fechaFinalizacion: string\n          fechaInicio: string\n          id: string\n          propiedadId: string\n          tropaId: string\n          updated_at: string\n        }\n        Insert: {\n          cantidad: number\n          created_at?: string\n          fechaFinalizacion: string\n          fechaInicio: string\n          id?: string\n          propiedadId: string\n          tropaId: string\n          updated_at?: string\n        }\n        Update: {\n          cantidad?: number\n          created_at?: string\n          fechaFinalizacion?: string\n          fechaInicio?: string\n          id?: string\n          propiedadId?: string\n          tropaId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"colareclutamiento_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: true\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colareclutamiento_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: true\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"colareclutamiento_tropaid_fkey\"\n            columns: [\"tropaId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionTropa\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      ConfiguracionEntrenamiento: {\n        Row: {\n          costoArmas: number\n          costoDolares: number\n          costoMunicion: number\n          created_at: string\n          duracion: number\n          id: string\n          nombre: string\n          puntos: number\n          updated_at: string\n          urlImagen: string\n        }\n        Insert: {\n          costoArmas: number\n          costoDolares: number\n          costoMunicion: number\n          created_at?: string\n          duracion: number\n          id: string\n          nombre: string\n          puntos: number\n          updated_at?: string\n          urlImagen: string\n        }\n        Update: {\n          costoArmas?: number\n          costoDolares?: number\n          costoMunicion?: number\n          created_at?: string\n          duracion?: number\n          id?: string\n          nombre?: string\n          puntos?: number\n          updated_at?: string\n          urlImagen?: string\n        }\n        Relationships: []\n      }\n      ConfiguracionHabitacion: {\n        Row: {\n          costoArmas: number\n          costoDolares: number\n          costoMunicion: number\n          created_at: string\n          descripcion: string | null\n          duracion: number\n          id: string\n          nombre: string\n          produccionBase: number\n          produccionRecurso: string | null\n          puntos: number\n          updated_at: string\n          urlImagen: string\n        }\n        Insert: {\n          costoArmas: number\n          costoDolares: number\n          costoMunicion: number\n          created_at?: string\n          descripcion?: string | null\n          duracion: number\n          id: string\n          nombre: string\n          produccionBase?: number\n          produccionRecurso?: string | null\n          puntos: number\n          updated_at?: string\n          urlImagen: string\n        }\n        Update: {\n          costoArmas?: number\n          costoDolares?: number\n          costoMunicion?: number\n          created_at?: string\n          descripcion?: string | null\n          duracion?: number\n          id?: string\n          nombre?: string\n          produccionBase?: number\n          produccionRecurso?: string | null\n          puntos?: number\n          updated_at?: string\n          urlImagen?: string\n        }\n        Relationships: []\n      }\n      ConfiguracionTropa: {\n        Row: {\n          ataque: number\n          bonusAtaque: string[] | null\n          bonusDefensa: string[] | null\n          capacidad: number\n          costoArmas: number\n          costoDolares: number\n          costoMunicion: number\n          created_at: string\n          defensa: number\n          descripcion: string | null\n          duracion: number\n          id: string\n          nombre: string\n          puntos: number\n          requisitos: Json | null\n          salario: number\n          tipo: Database[\"public\"][\"Enums\"][\"TipoTropa\"]\n          updated_at: string\n          urlImagen: string\n          velocidad: number\n        }\n        Insert: {\n          ataque: number\n          bonusAtaque?: string[] | null\n          bonusDefensa?: string[] | null\n          capacidad: number\n          costoArmas: number\n          costoDolares: number\n          costoMunicion: number\n          created_at?: string\n          defensa: number\n          descripcion?: string | null\n          duracion: number\n          id: string\n          nombre: string\n          puntos: number\n          requisitos?: Json | null\n          salario: number\n          tipo: Database[\"public\"][\"Enums\"][\"TipoTropa\"]\n          updated_at?: string\n          urlImagen: string\n          velocidad: number\n        }\n        Update: {\n          ataque?: number\n          bonusAtaque?: string[] | null\n          bonusDefensa?: string[] | null\n          capacidad?: number\n          costoArmas?: number\n          costoDolares?: number\n          costoMunicion?: number\n          created_at?: string\n          defensa?: number\n          descripcion?: string | null\n          duracion?: number\n          id?: string\n          nombre?: string\n          puntos?: number\n          requisitos?: Json | null\n          salario?: number\n          tipo?: Database[\"public\"][\"Enums\"][\"TipoTropa\"]\n          updated_at?: string\n          urlImagen?: string\n          velocidad?: number\n        }\n        Relationships: []\n      }\n      EntrenamientoUsuario: {\n        Row: {\n          configuracionEntrenamientoId: string\n          created_at: string\n          nivel: number\n          updated_at: string\n          userId: string\n        }\n        Insert: {\n          configuracionEntrenamientoId: string\n          created_at?: string\n          nivel?: number\n          updated_at?: string\n          userId: string\n        }\n        Update: {\n          configuracionEntrenamientoId?: string\n          created_at?: string\n          nivel?: number\n          updated_at?: string\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"entrenamientousuario_configuracionentrenamientoid_fkey\"\n            columns: [\"configuracionEntrenamientoId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionEntrenamiento\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"entrenamientousuario_userid_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      EspionageReport: {\n        Row: {\n          attackerId: string\n          created_at: string\n          defenderId: string\n          details: Json\n          id: string\n          updated_at: string\n        }\n        Insert: {\n          attackerId: string\n          created_at?: string\n          defenderId: string\n          details: Json\n          id?: string\n          updated_at?: string\n        }\n        Update: {\n          attackerId?: string\n          created_at?: string\n          defenderId?: string\n          details?: Json\n          id?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"EspionageReport_attackerId_fkey\"\n            columns: [\"attackerId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"EspionageReport_defenderId_fkey\"\n            columns: [\"defenderId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      Family: {\n        Row: {\n          avatarUrl: string | null\n          created_at: string\n          description: string | null\n          id: string\n          name: string\n          tag: string\n          updated_at: string\n        }\n        Insert: {\n          avatarUrl?: string | null\n          created_at?: string\n          description?: string | null\n          id?: string\n          name: string\n          tag: string\n          updated_at?: string\n        }\n        Update: {\n          avatarUrl?: string | null\n          created_at?: string\n          description?: string | null\n          id?: string\n          name?: string\n          tag?: string\n          updated_at?: string\n        }\n        Relationships: []\n      }\n      FamilyAnnouncement: {\n        Row: {\n          authorId: string\n          content: string\n          created_at: string\n          familyId: string\n          id: string\n          updated_at: string\n        }\n        Insert: {\n          authorId: string\n          content: string\n          created_at?: string\n          familyId: string\n          id?: string\n          updated_at?: string\n        }\n        Update: {\n          authorId?: string\n          content?: string\n          created_at?: string\n          familyId?: string\n          id?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"FamilyAnnouncement_authorId_fkey\"\n            columns: [\"authorId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"FamilyAnnouncement_familyId_fkey\"\n            columns: [\"familyId\"]\n            isOneToOne: false\n            referencedRelation: \"Family\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      FamilyInvitation: {\n        Row: {\n          created_at: string\n          familyId: string\n          id: string\n          status: Database[\"public\"][\"Enums\"][\"InvitationStatus\"]\n          type: Database[\"public\"][\"Enums\"][\"InvitationType\"]\n          updated_at: string\n          userId: string\n        }\n        Insert: {\n          created_at?: string\n          familyId: string\n          id?: string\n          status?: Database[\"public\"][\"Enums\"][\"InvitationStatus\"]\n          type: Database[\"public\"][\"Enums\"][\"InvitationType\"]\n          updated_at?: string\n          userId: string\n        }\n        Update: {\n          created_at?: string\n          familyId?: string\n          id?: string\n          status?: Database[\"public\"][\"Enums\"][\"InvitationStatus\"]\n          type?: Database[\"public\"][\"Enums\"][\"InvitationType\"]\n          updated_at?: string\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"FamilyInvitation_familyId_fkey\"\n            columns: [\"familyId\"]\n            isOneToOne: false\n            referencedRelation: \"Family\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"FamilyInvitation_userId_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      FamilyMember: {\n        Row: {\n          created_at: string\n          familyId: string\n          role: Database[\"public\"][\"Enums\"][\"FamilyRole\"]\n          updated_at: string\n          userId: string\n        }\n        Insert: {\n          created_at?: string\n          familyId: string\n          role?: Database[\"public\"][\"Enums\"][\"FamilyRole\"]\n          updated_at?: string\n          userId: string\n        }\n        Update: {\n          created_at?: string\n          familyId?: string\n          role?: Database[\"public\"][\"Enums\"][\"FamilyRole\"]\n          updated_at?: string\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"FamilyMember_familyId_fkey\"\n            columns: [\"familyId\"]\n            isOneToOne: false\n            referencedRelation: \"Family\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"FamilyMember_userId_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: true\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      FleetQueue: {\n        Row: {\n          available_at: string | null\n          created_at: string | null\n          id: string\n          payload: Json\n          status: string\n        }\n        Insert: {\n          available_at?: string | null\n          created_at?: string | null\n          id?: string\n          payload: Json\n          status?: string\n        }\n        Update: {\n          available_at?: string | null\n          created_at?: string | null\n          id?: string\n          payload?: Json\n          status?: string\n        }\n        Relationships: []\n      }\n      HabitacionUsuario: {\n        Row: {\n          configuracionHabitacionId: string\n          created_at: string\n          id: string\n          nivel: number\n          propiedadId: string\n          updated_at: string\n        }\n        Insert: {\n          configuracionHabitacionId: string\n          created_at?: string\n          id?: string\n          nivel?: number\n          propiedadId: string\n          updated_at?: string\n        }\n        Update: {\n          configuracionHabitacionId?: string\n          created_at?: string\n          id?: string\n          nivel?: number\n          propiedadId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"habitacionusuario_configuracionhabitacionid_fkey\"\n            columns: [\"configuracionHabitacionId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionHabitacion\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"habitacionusuario_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"habitacionusuario_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      IncomingAttack: {\n        Row: {\n          arrivalTime: string\n          attackerId: string\n          attackerName: string\n          created_at: string\n          defenderId: string\n          id: string\n          missionId: string\n          targetProperty: string\n          totalTroops: number\n          updated_at: string\n        }\n        Insert: {\n          arrivalTime: string\n          attackerId: string\n          attackerName: string\n          created_at?: string\n          defenderId: string\n          id?: string\n          missionId: string\n          targetProperty: string\n          totalTroops: number\n          updated_at?: string\n        }\n        Update: {\n          arrivalTime?: string\n          attackerId?: string\n          attackerName?: string\n          created_at?: string\n          defenderId?: string\n          id?: string\n          missionId?: string\n          targetProperty?: string\n          totalTroops?: number\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"incomingattack_attackerid_fkey\"\n            columns: [\"attackerId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"incomingattack_defenderid_fkey\"\n            columns: [\"defenderId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"incomingattack_missionid_fkey\"\n            columns: [\"missionId\"]\n            isOneToOne: false\n            referencedRelation: \"ColaMisiones\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      LoginHistory: {\n        Row: {\n          created_at: string\n          id: string\n          ipAddress: string | null\n          loginTime: string\n          updated_at: string\n          userAgent: string | null\n          userId: string\n        }\n        Insert: {\n          created_at?: string\n          id?: string\n          ipAddress?: string | null\n          loginTime?: string\n          updated_at?: string\n          userAgent?: string | null\n          userId: string\n        }\n        Update: {\n          created_at?: string\n          id?: string\n          ipAddress?: string | null\n          loginTime?: string\n          updated_at?: string\n          userAgent?: string | null\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"LoginHistory_userId_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      Message: {\n        Row: {\n          battleReportId: string | null\n          category: Database[\"public\"][\"Enums\"][\"MessageCategory\"]\n          content: string\n          created_at: string\n          espionageReportId: string | null\n          id: string\n          isRead: boolean\n          recipientId: string\n          senderId: string | null\n          subject: string\n          updated_at: string\n        }\n        Insert: {\n          battleReportId?: string | null\n          category?: Database[\"public\"][\"Enums\"][\"MessageCategory\"]\n          content: string\n          created_at?: string\n          espionageReportId?: string | null\n          id?: string\n          isRead?: boolean\n          recipientId: string\n          senderId?: string | null\n          subject: string\n          updated_at?: string\n        }\n        Update: {\n          battleReportId?: string | null\n          category?: Database[\"public\"][\"Enums\"][\"MessageCategory\"]\n          content?: string\n          created_at?: string\n          espionageReportId?: string | null\n          id?: string\n          isRead?: boolean\n          recipientId?: string\n          senderId?: string | null\n          subject?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"fk_battle_report\"\n            columns: [\"battleReportId\"]\n            isOneToOne: false\n            referencedRelation: \"BattleReport\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"fk_espionage_report\"\n            columns: [\"espionageReportId\"]\n            isOneToOne: false\n            referencedRelation: \"EspionageReport\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"Message_recipientId_fkey\"\n            columns: [\"recipientId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"Message_senderId_fkey\"\n            columns: [\"senderId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      Propiedad: {\n        Row: {\n          alcohol: number\n          armas: number\n          barrio: number\n          ciudad: number\n          created_at: string\n          dolares: number\n          edificio: number\n          id: string\n          municion: number\n          nombre: string\n          updated_at: string\n          userId: string\n        }\n        Insert: {\n          alcohol?: number\n          armas?: number\n          barrio: number\n          ciudad: number\n          created_at?: string\n          dolares?: number\n          edificio: number\n          id?: string\n          municion?: number\n          nombre: string\n          updated_at?: string\n          userId: string\n        }\n        Update: {\n          alcohol?: number\n          armas?: number\n          barrio?: number\n          ciudad?: number\n          created_at?: string\n          dolares?: number\n          edificio?: number\n          id?: string\n          municion?: number\n          nombre?: string\n          updated_at?: string\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"propiedad_userid_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      PuntuacionUsuario: {\n        Row: {\n          created_at: string\n          puntosEntrenamientos: number\n          puntosHabitaciones: number\n          puntosHonorAtacante: number\n          puntosHonorDefensor: number\n          puntosHonorTotales: number\n          puntosTotales: number\n          puntosTropas: number\n          updated_at: string\n          userId: string\n        }\n        Insert: {\n          created_at?: string\n          puntosEntrenamientos?: number\n          puntosHabitaciones?: number\n          puntosHonorAtacante?: number\n          puntosHonorDefensor?: number\n          puntosHonorTotales?: number\n          puntosTotales?: number\n          puntosTropas?: number\n          updated_at?: string\n          userId: string\n        }\n        Update: {\n          created_at?: string\n          puntosEntrenamientos?: number\n          puntosHabitaciones?: number\n          puntosHonorAtacante?: number\n          puntosHonorDefensor?: number\n          puntosHonorTotales?: number\n          puntosTotales?: number\n          puntosTropas?: number\n          updated_at?: string\n          userId?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"puntuacionusuario_userid_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: true\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      RoomRequirement: {\n        Row: {\n          created_at: string\n          id: string\n          requiredLevel: number\n          requiredRoomId: string\n          roomId: string\n          updated_at: string\n        }\n        Insert: {\n          created_at?: string\n          id?: string\n          requiredLevel: number\n          requiredRoomId: string\n          roomId: string\n          updated_at?: string\n        }\n        Update: {\n          created_at?: string\n          id?: string\n          requiredLevel?: number\n          requiredRoomId?: string\n          roomId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"roomrequirement_requiredroomid_fkey\"\n            columns: [\"requiredRoomId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionHabitacion\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"roomrequirement_roomid_fkey\"\n            columns: [\"roomId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionHabitacion\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      TrainingRequirement: {\n        Row: {\n          created_at: string\n          id: string\n          requiredLevel: number\n          requiredTrainingId: string\n          trainingId: string\n          updated_at: string\n        }\n        Insert: {\n          created_at?: string\n          id?: string\n          requiredLevel: number\n          requiredTrainingId: string\n          trainingId: string\n          updated_at?: string\n        }\n        Update: {\n          created_at?: string\n          id?: string\n          requiredLevel?: number\n          requiredTrainingId?: string\n          trainingId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"trainingrequirement_requiredtrainingid_fkey\"\n            columns: [\"requiredTrainingId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionEntrenamiento\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"trainingrequirement_trainingid_fkey\"\n            columns: [\"trainingId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionEntrenamiento\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      TropaBonusContrincante: {\n        Row: {\n          created_at: string\n          factorPrioridad: number\n          id: string\n          tropaAtacanteId: string\n          tropaDefensoraId: string\n          updated_at: string\n        }\n        Insert: {\n          created_at?: string\n          factorPrioridad: number\n          id?: string\n          tropaAtacanteId: string\n          tropaDefensoraId: string\n          updated_at?: string\n        }\n        Update: {\n          created_at?: string\n          factorPrioridad?: number\n          id?: string\n          tropaAtacanteId?: string\n          tropaDefensoraId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"TropaBonusContrincante_tropaAtacanteId_fkey\"\n            columns: [\"tropaAtacanteId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionTropa\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"TropaBonusContrincante_tropaDefensoraId_fkey\"\n            columns: [\"tropaDefensoraId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionTropa\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      TropaSeguridadUsuario: {\n        Row: {\n          cantidad: number\n          configuracionTropaId: string\n          created_at: string\n          propiedadId: string\n          updated_at: string\n        }\n        Insert: {\n          cantidad?: number\n          configuracionTropaId: string\n          created_at?: string\n          propiedadId: string\n          updated_at?: string\n        }\n        Update: {\n          cantidad?: number\n          configuracionTropaId?: string\n          created_at?: string\n          propiedadId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"TropaSeguridadUsuario_configuracionTropaId_fkey\"\n            columns: [\"configuracionTropaId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionTropa\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"TropaSeguridadUsuario_propiedadId_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"TropaSeguridadUsuario_propiedadId_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      TropaUsuario: {\n        Row: {\n          cantidad: number\n          configuracionTropaId: string\n          created_at: string\n          propiedadId: string\n          updated_at: string\n        }\n        Insert: {\n          cantidad?: number\n          configuracionTropaId: string\n          created_at?: string\n          propiedadId: string\n          updated_at?: string\n        }\n        Update: {\n          cantidad?: number\n          configuracionTropaId?: string\n          created_at?: string\n          propiedadId?: string\n          updated_at?: string\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"tropausuario_configuraciontropaid_fkey\"\n            columns: [\"configuracionTropaId\"]\n            isOneToOne: false\n            referencedRelation: \"ConfiguracionTropa\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"tropausuario_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"Propiedad\"\n            referencedColumns: [\"id\"]\n          },\n          {\n            foreignKeyName: \"tropausuario_propiedadid_fkey\"\n            columns: [\"propiedadId\"]\n            isOneToOne: false\n            referencedRelation: \"PropiedadLive\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n      User: {\n        Row: {\n          avatarUrl: string | null\n          created_at: string\n          email: string\n          id: string\n          lastSeen: string\n          name: string\n          title: string | null\n          updated_at: string\n          username: string\n        }\n        Insert: {\n          avatarUrl?: string | null\n          created_at?: string\n          email: string\n          id?: string\n          lastSeen?: string\n          name?: string\n          title?: string | null\n          updated_at?: string\n          username: string\n        }\n        Update: {\n          avatarUrl?: string | null\n          created_at?: string\n          email?: string\n          id?: string\n          lastSeen?: string\n          name?: string\n          title?: string | null\n          updated_at?: string\n          username?: string\n        }\n        Relationships: []\n      }\n    }\n    Views: {\n      configurations_data: {\n        Row: {\n          data: Json | null\n          table_name: string | null\n        }\n        Relationships: []\n      }\n      PropiedadLive: {\n        Row: {\n          alcohol: number | null\n          armas: number | null\n          barrio: number | null\n          ciudad: number | null\n          created_at: string | null\n          dolares: number | null\n          edificio: number | null\n          id: string | null\n          municion: number | null\n          nombre: string | null\n          updated_at: string | null\n          userId: string | null\n        }\n        Relationships: [\n          {\n            foreignKeyName: \"propiedad_userid_fkey\"\n            columns: [\"userId\"]\n            isOneToOne: false\n            referencedRelation: \"User\"\n            referencedColumns: [\"id\"]\n          },\n        ]\n      }\n    }\n    Functions: {\n      _materializar_recursos_internal: {\n        Args: { p_propiedad_id: string }\n        Returns: undefined\n      }\n      accept_invitation_and_join_family: {\n        Args: { p_family_id: string; p_user_id: string }\n        Returns: undefined\n      }\n      actualizar_estado_completo_del_juego: {\n        Args: { p_user_id: string }\n        Returns: undefined\n      }\n      actualizar_puntuacion_total: {\n        Args: { p_user_id: string }\n        Returns: undefined\n      }\n      actualizar_recursos: {\n        Args: { p_propiedad_id: string }\n        Returns: undefined\n      }\n      calcular_capacidad_almacenamiento: {\n        Args: { p_propiedad_id: string }\n        Returns: {\n          cap_alcohol: number\n          cap_armas: number\n          cap_dolares: number\n          cap_municion: number\n        }[]\n      }\n      calcular_coordenadas_virtuales: {\n        Args: { b: number; c: number; e: number }\n        Returns: Json\n      }\n      calcular_coste_mision:\n        | {\n            Args: { distancia: number; sum_salarios_base: number }\n            Returns: number\n          }\n        | { Args: { distancia: number; tropas: Json }; Returns: number }\n      calcular_costo_entrenamiento: {\n        Args: {\n          costo_base_armas: number\n          costo_base_dolares: number\n          costo_base_municion: number\n          nivel_objetivo: number\n        }\n        Returns: Json\n      }\n      calcular_costo_habitacion: {\n        Args: {\n          costo_base_armas: number\n          costo_base_dolares: number\n          costo_base_municion: number\n          nivel_objetivo: number\n        }\n        Returns: Json\n      }\n      calcular_distancia: {\n        Args: {\n          destino_barrio: number\n          destino_ciudad: number\n          destino_edificio: number\n          origen_barrio: number\n          origen_ciudad: number\n          origen_edificio: number\n        }\n        Returns: number\n      }\n      calcular_distancia_exacta: {\n        Args: { destino_coords: Json; origen_id: string }\n        Returns: number\n      }\n      calcular_duracion_viaje: {\n        Args: { distancia: number; velocidad_flota: number }\n        Returns: number\n      }\n      calcular_logistica_mision: {\n        Args: { distancia: number; tropas: Json }\n        Returns: {\n          costo_total: number\n          tiempo_segundos: number\n          velocidad_minima: number\n        }[]\n      }\n      calcular_produccion_armeria: { Args: { nivel: number }; Returns: number }\n      calcular_produccion_cerveceria: {\n        Args: { nivel: number }\n        Returns: number\n      }\n      calcular_produccion_contrabando: {\n        Args: { nivel: number }\n        Returns: number\n      }\n      calcular_produccion_municion: { Args: { nivel: number }; Returns: number }\n      calcular_produccion_taberna: { Args: { nivel: number }; Returns: number }\n      calcular_puntos_entrenamientos: {\n        Args: { p_user_id: string }\n        Returns: number\n      }\n      calcular_puntos_habitaciones: {\n        Args: { p_user_id: string }\n        Returns: number\n      }\n      calcular_puntos_tropas: { Args: { p_user_id: string }; Returns: number }\n      calcular_recursos_actuales: {\n        Args: { p_propiedad_id: string }\n        Returns: {\n          alcohol: number\n          armas: number\n          dolares: number\n          municion: number\n          updated_at: string\n        }[]\n      }\n      calcular_stats_tropa:\n        | {\n            Args: { p_tropa_id: string; p_user_id: string }\n            Returns: {\n              ataque_real: number\n              capacidad_real: number\n              defensa_real: number\n              salario_real: number\n              velocidad_real: number\n            }[]\n          }\n        | {\n            Args: {\n              base_ataque: number\n              base_capacidad: number\n              base_defensa: number\n              base_salario: number\n              base_velocidad: number\n              bonus_ataque: string[]\n              bonus_defensa: string[]\n              niveles_entrenamiento: Json\n              tropa_id: string\n            }\n            Returns: Json\n          }\n      calcular_tasas_produccion: {\n        Args: { p_propiedad_id: string }\n        Returns: {\n          consumo_alcohol_hora: number\n          prod_alcohol_hora: number\n          prod_armas_hora: number\n          prod_dolares_hora_full: number\n          prod_dolares_hora_throttled: number\n          prod_municion_hora: number\n        }[]\n      }\n      calcular_tiempo_construccion: {\n        Args: {\n          habitacion_id: string\n          nivel_objetivo: number\n          nivel_oficina_jefe: number\n          tiempo_base: number\n        }\n        Returns: number\n      }\n      calcular_tiempo_entrenamiento: {\n        Args: {\n          nivel_escuela_especializacion: number\n          nivel_objetivo: number\n          tiempo_base: number\n        }\n        Returns: number\n      }\n      calcular_tiempo_reclutamiento: {\n        Args: { cantidad: number; duracion: number; nivel_campo: number }\n        Returns: number\n      }\n      calcular_velocidad_flota:\n        | {\n            Args: { p_tropas: Json }\n            Returns: {\n              error: true\n            } & \"Could not choose the best candidate function between: public.calcular_velocidad_flota(p_tropas => json), public.calcular_velocidad_flota(p_tropas => jsonb). Try renaming the parameters or the function itself in the database so function overloading can be resolved\"\n          }\n        | {\n            Args: { p_tropas: Json }\n            Returns: {\n              error: true\n            } & \"Could not choose the best candidate function between: public.calcular_velocidad_flota(p_tropas => json), public.calcular_velocidad_flota(p_tropas => jsonb). Try renaming the parameters or the function itself in the database so function overloading can be resolved\"\n          }\n      calcular_velocidad_flota_from_json: {\n        Args: { p_tropas: Json }\n        Returns: number\n      }\n      cancelar_construccion_habitacion: {\n        Args: { p_cola_id: string }\n        Returns: Json\n      }\n      check_username_availability: {\n        Args: { p_username: string }\n        Returns: boolean\n      }\n      convertir_coordenadas_virtuales: {\n        Args: { barrio: number; ciudad: number; edificio: number }\n        Returns: {\n          altura: number\n          anchura: number\n        }[]\n      }\n      create_family_and_leader: {\n        Args: {\n          p_avatar_url: string\n          p_description: string\n          p_leader_id: string\n          p_name: string\n          p_tag: string\n        }\n        Returns: {\n          avatarUrl: string | null\n          created_at: string\n          description: string | null\n          id: string\n          name: string\n          tag: string\n          updated_at: string\n        }\n        SetofOptions: {\n          from: \"*\"\n          to: \"Family\"\n          isOneToOne: true\n          isSetofReturn: false\n        }\n      }\n      enviar_mision_atomica: {\n        Args: {\n          p_destino_coords: Json\n          p_origen_id: string\n          p_tipo: string\n          p_tropas: Json\n          p_user_id: string\n        }\n        Returns: Json\n      }\n      finalizar_construcciones_para_propiedad: {\n        Args: { p_propiedad_id: string }\n        Returns: undefined\n      }\n      find_available_property_slot: {\n        Args: never\n        Returns: {\n          barrio: number\n          ciudad: number\n          edificio: number\n        }[]\n      }\n      get_email_by_username: { Args: { p_username: string }; Returns: string }\n      get_room_level: {\n        Args: { p_habitacion_id: string; p_propiedad_id: string }\n        Returns: number\n      }\n      get_schema_introspection_data: { Args: never; Returns: Json }\n      get_tropas_from_json: {\n        Args: { p_tropas_json: Json }\n        Returns: {\n          quantity: number\n          troop_id: string\n        }[]\n      }\n      incrementar_nivel_entrenamiento: {\n        Args: {\n          p_entrenamiento_id: string\n          p_nivel_destino: number\n          p_user_id: string\n        }\n        Returns: undefined\n      }\n      incrementar_nivel_habitacion:\n        | {\n            Args: {\n              p_habitacion_id: string\n              p_nivel_destino: number\n              p_propiedad_id: string\n            }\n            Returns: undefined\n          }\n        | {\n            Args: {\n              p_habitacion_id: string\n              p_nivel_destino: number\n              p_propiedad_id: string\n            }\n            Returns: undefined\n          }\n      incrementar_tropas: {\n        Args: { p_cantidad: number; p_propiedad_id: string; p_tropa_id: string }\n        Returns: undefined\n      }\n      iniciar_construccion_habitacion: {\n        Args: { p_habitacion_id: string; p_propiedad_id: string }\n        Returns: Json\n      }\n      iniciar_reclutamiento_atomico:\n        | {\n            Args: {\n              p_cantidad: number\n              p_propiedad_id: string\n              p_tipo_tropa_esperado: Database[\"public\"][\"Enums\"][\"TipoTropa\"]\n              p_tropa_id: string\n            }\n            Returns: Json\n          }\n        | {\n            Args: {\n              p_cantidad: number\n              p_propiedad_id: string\n              p_tipo_tropa_esperado: Database[\"public\"][\"Enums\"][\"TipoTropa\"]\n              p_tropa_id: string\n            }\n            Returns: Json\n          }\n      is_family_manager: { Args: { p_family_id: string }; Returns: boolean }\n      is_family_member: { Args: { p_family_id: string }; Returns: boolean }\n      is_propiedad_owner: { Args: { p_propiedad_id: string }; Returns: boolean }\n      leave_or_delete_family: {\n        Args: { p_family_id: string; p_user_id: string }\n        Returns: undefined\n      }\n      materializar_recursos: {\n        Args: { p_propiedad_id: string }\n        Returns: undefined\n      }\n      obtener_poder_militar_usuario: {\n        Args: { p_user_id: string }\n        Returns: {\n          ataque_real: number\n          cantidad_total: number\n          capacidad_real: number\n          defensa_real: number\n          nombre: string\n          salario_real: number\n          tipo: Database[\"public\"][\"Enums\"][\"TipoTropa\"]\n          tropa_id: string\n          velocidad_real: number\n        }[]\n      }\n      ocupar_y_procesar_mision: {\n        Args: { p_mission_id: string }\n        Returns: Json\n      }\n      pop_fleet_mission: {\n        Args: never\n        Returns: {\n          available_at: string\n          created_at: string\n          id: string\n          payload: Json\n          status: string\n        }[]\n      }\n      process_battle_report: {\n        Args: {\n          p_attacker_honor_gain: number\n          p_attacker_id: string\n          p_barrio: number\n          p_ciudad: number\n          p_defender_honor_gain: number\n          p_defender_id: string\n          p_defender_losses: Json\n          p_details: Json\n          p_edificio: number\n          p_mission_id: string\n          p_return_time: string\n          p_surviving_troops: Json\n          p_winner: string\n        }\n        Returns: undefined\n      }\n      process_defend_mission: {\n        Args: { p_mission_id: string }\n        Returns: undefined\n      }\n      process_transport_mission: {\n        Args: { p_mission_id: string }\n        Returns: undefined\n      }\n      spend_resources: {\n        Args: {\n          cost_armas: number\n          cost_dolares: number\n          cost_municion: number\n          p_propiedad_id: string\n        }\n        Returns: undefined\n      }\n      transfer_leadership: {\n        Args: {\n          p_family_id: string\n          p_new_leader_id: string\n          p_old_leader_id: string\n        }\n        Returns: undefined\n      }\n      update_properties_by_user_id: {\n        Args: {\n          p_property_ids: string[]\n          p_resources: Json\n          p_room_levels: Json\n          p_trainings: Json\n          p_troops_to_add: Json\n          p_user_id: string\n        }\n        Returns: Json\n      }\n      update_property_as_admin: {\n        Args: {\n          p_attack_troops: Json\n          p_defense_troops: Json\n          p_nombre: string\n          p_property_id: string\n          p_resources: Json\n          p_room_levels: Json\n        }\n        Returns: undefined\n      }\n      update_property_names: {\n        Args: {\n          p_main_property_id: string\n          p_property_updates: Json\n          p_user_id: string\n        }\n        Returns: undefined\n      }\n      validar_recursos_entrenamiento: {\n        Args: {\n          p_entrenamiento_id: string\n          p_nivel_destino: number\n          p_propiedad_id?: string\n          p_user_id: string\n        }\n        Returns: boolean\n      }\n      validar_requisitos_habitacion:\n        | {\n            Args: { p_habitacion_id: string; p_propiedad_id: string }\n            Returns: boolean\n          }\n        | {\n            Args: { p_habitacion_id: string; p_propiedad_id: string }\n            Returns: boolean\n          }\n      verify_admin_privileges: { Args: never; Returns: boolean }\n    }\n    Enums: {\n      FamilyRole: \"LEADER\" | \"CO_LEADER\" | \"MEMBER\"\n      InvitationStatus: \"PENDING\" | \"ACCEPTED\" | \"REJECTED\" | \"CANCELLED\"\n      InvitationType: \"INVITATION\" | \"REQUEST\"\n      MessageCategory:\n        | \"JUGADOR\"\n        | \"BATALLA\"\n        | \"CONSTRUCCION\"\n        | \"SISTEMA\"\n        | \"ESPIONAJE\"\n      TipoTropa: \"ATAQUE\" | \"DEFENSA\" | \"TRANSPORTE\" | \"ESPIONAJE\" | \"OCUPAR\"\n    }\n    CompositeTypes: {\n      [_ in never]: never\n    }\n  }\n}\n\ntype DatabaseWithoutInternals = Omit<Database, \"__InternalSupabase\">\n\ntype DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, \"public\">]\n\nexport type Tables<\n  DefaultSchemaTableNameOrOptions extends\n    | keyof (DefaultSchema[\"Tables\"] & DefaultSchema[\"Views\"])\n    | { schema: keyof DatabaseWithoutInternals },\n  TableName extends DefaultSchemaTableNameOrOptions extends {\n    schema: keyof DatabaseWithoutInternals\n  }\n    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Tables\"] &\n        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Views\"])\n    : never = never,\n> = DefaultSchemaTableNameOrOptions extends {\n  schema: keyof DatabaseWithoutInternals\n}\n  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Tables\"] &\n      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Views\"])[TableName] extends {\n      Row: infer R\n    }\n    ? R\n    : never\n  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema[\"Tables\"] &\n        DefaultSchema[\"Views\"])\n    ? (DefaultSchema[\"Tables\"] &\n        DefaultSchema[\"Views\"])[DefaultSchemaTableNameOrOptions] extends {\n        Row: infer R\n      }\n      ? R\n      : never\n    : never\n\nexport type TablesInsert<\n  DefaultSchemaTableNameOrOptions extends\n    | keyof DefaultSchema[\"Tables\"]\n    | { schema: keyof DatabaseWithoutInternals },\n  TableName extends DefaultSchemaTableNameOrOptions extends {\n    schema: keyof DatabaseWithoutInternals\n  }\n    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Tables\"]\n    : never = never,\n> = DefaultSchemaTableNameOrOptions extends {\n  schema: keyof DatabaseWithoutInternals\n}\n  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Tables\"][TableName] extends {\n      Insert: infer I\n    }\n    ? I\n    : never\n  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema[\"Tables\"]\n    ? DefaultSchema[\"Tables\"][DefaultSchemaTableNameOrOptions] extends {\n        Insert: infer I\n      }\n      ? I\n      : never\n    : never\n\nexport type TablesUpdate<\n  DefaultSchemaTableNameOrOptions extends\n    | keyof DefaultSchema[\"Tables\"]\n    | { schema: keyof DatabaseWithoutInternals },\n  TableName extends DefaultSchemaTableNameOrOptions extends {\n    schema: keyof DatabaseWithoutInternals\n  }\n    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Tables\"]\n    : never = never,\n> = DefaultSchemaTableNameOrOptions extends {\n  schema: keyof DatabaseWithoutInternals\n}\n  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions[\"schema\"]][\"Tables\"][TableName] extends {\n      Update: infer U\n    }\n    ? U\n    : never\n  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema[\"Tables\"]\n    ? DefaultSchema[\"Tables\"][DefaultSchemaTableNameOrOptions] extends {\n        Update: infer U\n      }\n      ? U\n      : never\n    : never\n\nexport type Enums<\n  DefaultSchemaEnumNameOrOptions extends\n    | keyof DefaultSchema[\"Enums\"]\n    | { schema: keyof DatabaseWithoutInternals },\n  EnumName extends DefaultSchemaEnumNameOrOptions extends {\n    schema: keyof DatabaseWithoutInternals\n  }\n    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions[\"schema\"]][\"Enums\"]\n    : never = never,\n> = DefaultSchemaEnumNameOrOptions extends {\n  schema: keyof DatabaseWithoutInternals\n}\n  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions[\"schema\"]][\"Enums\"][EnumName]\n  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema[\"Enums\"]\n    ? DefaultSchema[\"Enums\"][DefaultSchemaEnumNameOrOptions]\n    : never\n\nexport type CompositeTypes<\n  PublicCompositeTypeNameOrOptions extends\n    | keyof DefaultSchema[\"CompositeTypes\"]\n    | { schema: keyof DatabaseWithoutInternals },\n  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {\n    schema: keyof DatabaseWithoutInternals\n  }\n    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions[\"schema\"]][\"CompositeTypes\"]\n    : never = never,\n> = PublicCompositeTypeNameOrOptions extends {\n  schema: keyof DatabaseWithoutInternals\n}\n  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions[\"schema\"]][\"CompositeTypes\"][CompositeTypeName]\n  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema[\"CompositeTypes\"]\n    ? DefaultSchema[\"CompositeTypes\"][PublicCompositeTypeNameOrOptions]\n    : never\n\nexport const Constants = {\n  public: {\n    Enums: {\n      FamilyRole: [\"LEADER\", \"CO_LEADER\", \"MEMBER\"],\n      InvitationStatus: [\"PENDING\", \"ACCEPTED\", \"REJECTED\", \"CANCELLED\"],\n      InvitationType: [\"INVITATION\", \"REQUEST\"],\n      MessageCategory: [\n        \"JUGADOR\",\n        \"BATALLA\",\n        \"CONSTRUCCION\",\n        \"SISTEMA\",\n        \"ESPIONAJE\",\n      ],\n      TipoTropa: [\"ATAQUE\", \"DEFENSA\", \"TRANSPORTE\", \"ESPIONAJE\", \"OCUPAR\"],\n    },\n  },\n} as const\n",
    "src/types/simulation.types.ts": "// src/types/simulation.types.ts\n\nexport interface MinimalTroopConfig {\n    id: string;\n    nombre: string;\n    tipo: string;\n    ataque: number;\n    defensa: number;\n    velocidad: number;\n    capacidadCarga: number;\n    esAereo: boolean;\n}\n\nexport interface ArmyUnit {\n    config: MinimalTroopConfig;\n    cantidad: number;\n    bonus: number; // Porcentaje de bonus total\n    entrenamientoNivel: number;\n}\n\n// RESTORED LEGACY STRUCTURE FOR FRONTEND COMPATIBILITY\nexport interface BattleRoundTroopState {\n    id: string;\n    nombre: string;\n    initialQuantity: number;\n    lostQuantity: number;\n}\n\nexport interface BattleRoundSideState {\n    troops: BattleRoundTroopState[];\n    totalAttack: number;\n    totalAttackConBonus: number;\n    poderAtaquePercent: number;\n    totalDefense: number;\n}\n\nexport interface BattleRound {\n    round: number;\n    attacker: BattleRoundSideState;\n    defender: BattleRoundSideState;\n    log?: string[];\n}\n\n// Alias for compatibility if code uses BattleRoundReport\nexport type BattleRoundReport = BattleRound;\n\nexport interface ResourceCost {\n    armas: number;\n    municion: number;\n    dolares: number;\n}\n\nexport interface CombatStats {\n    attacker: {\n        troopsLost: number;\n        pointsLost: number;\n        resourcesLost: ResourceCost;\n    };\n    defender: {\n        troopsLost: number;\n        pointsLost: number;\n        resourcesLost: ResourceCost;\n    };\n}\n\nexport interface BattleSimulationResult {\n    winner: 'attacker' | 'defender' | 'draw';\n    rounds: BattleRound[];\n    attackerLosses: { [id: string]: number };\n    defenderLosses: { [id: string]: number };\n    loot: {\n        armas: number;\n        municion: number;\n        alcohol: number;\n        dolares: number;\n    };\n    xpGained: number;\n    finalStats: CombatStats;\n    finalMessage: string;\n}\n\nexport interface EspionageReportDetails {\n    resources?: {\n        armas: number;\n        municion: number;\n        alcohol: number;\n        dolares: number;\n    };\n    buildings?: {\n        name: string;\n        level: number;\n    }[];\n    troops?: {\n        name: string;\n        quantity: number;\n    }[];\n    defenses?: {\n        name: string;\n        quantity: number;\n    }[];\n    intel?: any; // Added for compatibility with espionage-list-view\n    combat?: any; // Added for compatibility with espionage-detail-view\n    detected: boolean; // If the spy was detected\n}\n\nexport interface TroopData {\n    id: string;\n    quantity: number;\n    cantidad?: number;\n}\n\nexport interface SimulationInput {\n    troops: TroopData[];\n    trainings: { id: string; level: number }[];\n    propertyCount: number;\n    defenses?: { id: string, level: number }[]; // Added to match usage in brawls/simulator\n    // 🟢 CORRECCIÓN: Se añade la propiedad que faltaba\n    buildingsLevel?: number; \n}"
  }