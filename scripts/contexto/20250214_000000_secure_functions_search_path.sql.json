{
    "filename": "20250214_000000_secure_functions_search_path.sql",
    "timestamp": "2025-02-14T00:00:00",
    "content": "-- 1. Gestión de Recursos (Lazy Calculation)\nCREATE OR REPLACE FUNCTION public.materializar_recursos(p_propiedad_id uuid)\nRETURNS void AS $$\nDECLARE\n    v_propiedad record;\n    v_delta_tiempo real;\n    v_produccion_armas real;\n    v_produccion_municion real;\n    v_produccion_alcohol real;\n    v_produccion_dolares real;\n    v_capacidad_armas bigint;\n    v_capacidad_municion bigint;\n    v_capacidad_alcohol bigint;\n    v_capacidad_dolares bigint;\n    v_nuevo_stock_armas bigint;\n    v_nuevo_stock_municion bigint;\n    v_nuevo_stock_alcohol bigint;\n    v_nuevo_stock_dolares bigint;\n    v_consumo_alcohol real;\n    v_factor_conversion_alcohol_dolares real := 1.0; -- Ajustar este valor según la configuración del juego\nBEGIN\n    -- Bloquear la fila de propiedad para evitar condiciones de carrera\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id FOR UPDATE;\n\n    -- Calcular el tiempo transcurrido desde la última actualización\n    v_delta_tiempo := EXTRACT(EPOCH FROM (NOW() - v_propiedad.ultima_recogida_recursos));\n\n    -- Si no ha pasado tiempo, salir\n    IF v_delta_tiempo <= 0 THEN\n        RETURN;\n    END IF;\n\n    -- Calcular la Tasa de Producción por Recurso\n    SELECT\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'armas' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0),\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'municion' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0),\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'alcohol' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0),\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'dolares_por_alcohol' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0)\n    INTO\n        v_produccion_armas,\n        v_produccion_municion,\n        v_produccion_alcohol,\n        v_produccion_dolares\n    FROM public.habitacion_usuario hu\n    JOIN public.configuracion_habitacion ch ON hu.habitacion_id = ch.id\n    WHERE hu.propiedad_id = p_propiedad_id;\n\n    -- Calcular Capacidad de Almacenamiento\n    SELECT\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'almacen_de_armas' THEN hu.nivel * 10000 ELSE 0 END), 0),\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'deposito_de_municion' THEN hu.nivel * 10000 ELSE 0 END), 0),\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'almacen_de_alcohol' THEN hu.nivel * 10000 ELSE 0 END), 0),\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'caja_fuerte' THEN hu.nivel * 10000 ELSE 0 END), 0)\n    INTO\n        v_capacidad_armas,\n        v_capacidad_municion,\n        v_capacidad_alcohol,\n        v_capacidad_dolares\n    FROM public.habitacion_usuario hu\n    WHERE hu.propiedad_id = p_propiedad_id;\n\n    -- Conversión Especial (Alcohol a Dólares)\n    IF v_produccion_dolares > 0 THEN\n        v_consumo_alcohol := (v_produccion_dolares / v_factor_conversion_alcohol_dolares) * v_delta_tiempo;\n        IF v_propiedad.alcohol < v_consumo_alcohol THEN\n            -- Ajustar producción de dólares si no hay suficiente alcohol\n            v_produccion_dolares := (v_propiedad.alcohol / v_delta_tiempo) * v_factor_conversion_alcohol_dolares;\n            v_propiedad.alcohol := 0;\n        ELSE\n            v_propiedad.alcohol := v_propiedad.alcohol - v_consumo_alcohol;\n        END IF;\n    END IF;\n\n    -- Actualizar Stocks\n    v_nuevo_stock_armas := LEAST(v_capacidad_armas, v_propiedad.armas + (v_produccion_armas * v_delta_tiempo));\n    v_nuevo_stock_municion := LEAST(v_capacidad_municion, v_propiedad.municion + (v_produccion_municion * v_delta_tiempo));\n    v_nuevo_stock_alcohol := LEAST(v_capacidad_alcohol, v_propiedad.alcohol + (v_produccion_alcohol * v_delta_tiempo));\n    v_nuevo_stock_dolares := LEAST(v_capacidad_dolares, v_propiedad.dolares + (v_produccion_dolares * v_delta_tiempo));\n\n    -- Actualizar la tabla de propiedad\n    UPDATE public.propiedad\n    SET\n        armas = v_nuevo_stock_armas,\n        municion = v_nuevo_stock_municion,\n        alcohol = v_nuevo_stock_alcohol,\n        dolares = v_nuevo_stock_dolares,\n        ultima_recogida_recursos = NOW()\n    WHERE id = p_propiedad_id;\n\nEND;\n$$ LANGUAGE plpgsql SET search_path = '';\n\n-- 2. Colas de Construcción\nCREATE OR REPLACE FUNCTION public.iniciar_construccion_habitacion(p_propiedad_id uuid, p_habitacion_id text)\nRETURNS json AS $$\nDECLARE\n    v_configuracion_habitacion record;\n    v_propiedad record;\n    v_costo_total_armas bigint;\n    v_costo_total_municion bigint;\n    v_costo_total_dolares bigint;\n    v_fecha_inicio timestamptz;\n    v_fecha_fin timestamptz;\n    v_duracion_final integer;\n    v_nivel_oficina smallint;\n    v_factor_velocidad real := 1.0;\n    v_cola_count integer;\n    v_nivel_destino integer;\nBEGIN\n    -- Materializar recursos\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- Obtener configuración de la habitación y datos de la propiedad\n    SELECT * INTO v_configuracion_habitacion FROM public.configuracion_habitacion WHERE id = p_habitacion_id;\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Verificar requisitos previos\n    IF EXISTS (\n        SELECT 1\n        FROM public.requisito_habitacion rh\n        WHERE rh.habitacion_id = p_habitacion_id\n        AND NOT EXISTS (\n            SELECT 1\n            FROM public.habitacion_usuario hu\n            WHERE hu.propiedad_id = p_propiedad_id\n            AND hu.habitacion_id = rh.habitacion_requerida_id\n            AND hu.nivel >= rh.nivel_requerido\n        )\n    ) THEN\n        RETURN json_build_object('error', 'Requisitos de construcción no cumplidos.');\n    END IF;\n\n    -- Verificar cola llena\n    SELECT COUNT(*) INTO v_cola_count FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id;\n    IF v_cola_count >= 5 THEN\n        RETURN json_build_object('error', 'La cola de construcción está llena.');\n    END IF;\n\n    -- Calcular costos\n    v_costo_total_armas := v_configuracion_habitacion.costo_armas;\n    v_costo_total_municion := v_configuracion_habitacion.costo_municion;\n    v_costo_total_dolares := v_configuracion_habitacion.costo_dolares;\n\n    -- Verificar recursos suficientes\n    IF v_propiedad.armas < v_costo_total_armas OR v_propiedad.municion < v_costo_total_municion OR v_propiedad.dolares < v_costo_total_dolares THEN\n        RETURN json_build_object('error', 'Recursos insuficientes.');\n    END IF;\n\n    -- Deducir recursos\n    UPDATE public.propiedad\n    SET\n        armas = armas - v_costo_total_armas,\n        municion = municion - v_costo_total_municion,\n        dolares = dolares - v_costo_total_dolares\n    WHERE id = p_propiedad_id;\n\n    -- Calcular fecha de inicio y fin\n    SELECT COALESCE(MAX(fecha_fin), NOW()) INTO v_fecha_inicio FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id;\n\n    -- Aplicar factor de velocidad de la oficina\n    SELECT nivel INTO v_nivel_oficina FROM public.habitacion_usuario WHERE propiedad_id = p_propiedad_id AND habitacion_id = 'oficina_del_jefe';\n    IF v_nivel_oficina > 0 THEN\n        v_factor_velocidad := 1.0 - (v_nivel_oficina * 0.05); -- 5% de reducción por nivel\n    END IF;\n    v_duracion_final := v_configuracion_habitacion.duracion_construccion * v_factor_velocidad;\n    v_fecha_fin := v_fecha_inicio + make_interval(secs => v_duracion_final);\n\n    -- Calcular el nivel de destino correcto\n    SELECT\n        GREATEST(\n            (SELECT COALESCE(MAX(nivel), 0) FROM public.habitacion_usuario WHERE propiedad_id = p_propiedad_id AND habitacion_id = p_habitacion_id),\n            (SELECT COALESCE(MAX(nivel_destino), 0) FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id AND habitacion_id = p_habitacion_id)\n        ) + 1\n    INTO v_nivel_destino;\n\n    -- Insertar en la cola de construcción\n    INSERT INTO public.cola_construccion (propiedad_id, habitacion_id, nivel_destino, duracion_segundos, fecha_inicio, fecha_fin)\n    VALUES (p_propiedad_id, p_habitacion_id, v_nivel_destino, v_duracion_final, v_fecha_inicio, v_fecha_fin);\n\n    RETURN json_build_object('success', true, 'fecha_inicio', v_fecha_inicio, 'fecha_fin', v_fecha_fin);\nEND;\n$$ LANGUAGE plpgsql SET search_path = '';\n\nCREATE OR REPLACE FUNCTION public.procesar_colas()\nRETURNS void AS $$\nDECLARE\n    v_item_construccion record;\n    v_item_investigacion record;\n    v_item_reclutamiento record;\nBEGIN\n    -- Procesar cola de construcción\n    FOR v_item_construccion IN SELECT * FROM public.cola_construccion WHERE fecha_fin <= NOW() LOOP\n        -- Actualizar o insertar habitación\n        IF EXISTS (SELECT 1 FROM public.habitacion_usuario WHERE propiedad_id = v_item_construccion.propiedad_id AND habitacion_id = v_item_construccion.habitacion_id) THEN\n            UPDATE public.habitacion_usuario SET nivel = nivel + 1 WHERE propiedad_id = v_item_construccion.propiedad_id AND habitacion_id = v_item_construccion.habitacion_id;\n        ELSE\n            INSERT INTO public.habitacion_usuario (propiedad_id, habitacion_id, nivel) VALUES (v_item_construccion.propiedad_id, v_item_construccion.habitacion_id, 1);\n        END IF;\n        -- Eliminar de la cola\n        DELETE FROM public.cola_construccion WHERE id = v_item_construccion.id;\n    END LOOP;\n\n    -- Procesar cola de investigación\n    FOR v_item_investigacion IN SELECT * FROM public.cola_investigacion WHERE fecha_fin <= NOW() LOOP\n        INSERT INTO public.entrenamiento_usuario (usuario_id, entrenamiento_id, nivel)\n        VALUES (v_item_investigacion.usuario_id, v_item_investigacion.entrenamiento_id, 1)\n        ON CONFLICT (usuario_id, entrenamiento_id) DO UPDATE SET nivel = public.entrenamiento_usuario.nivel + 1;\n        DELETE FROM public.cola_investigacion WHERE id = v_item_investigacion.id;\n    END LOOP;\n\n    -- Procesar cola de reclutamiento\n    FOR v_item_reclutamiento IN SELECT * FROM public.cola_reclutamiento WHERE fecha_fin <= NOW() LOOP\n        INSERT INTO public.tropa_propiedad (propiedad_id, tropa_id, cantidad)\n        VALUES (v_item_reclutamiento.propiedad_id, v_item_reclutamiento.tropa_id, v_item_reclutamiento.cantidad)\n        ON CONFLICT (propiedad_id, tropa_id) DO UPDATE SET cantidad = public.tropa_propiedad.cantidad + v_item_reclutamiento.cantidad;\n        DELETE FROM public.cola_reclutamiento WHERE id = v_item_reclutamiento.id;\n    END LOOP;\nEND;\n$$ LANGUAGE plpgsql SET search_path = '';\n\n-- 3. Entrenamiento e Investigación\nCREATE OR REPLACE FUNCTION public.iniciar_entrenamiento(p_propiedad_id uuid, p_entrenamiento_id text)\nRETURNS json AS $$\nDECLARE\n    v_configuracion_entrenamiento record;\n    v_propiedad record;\n    v_usuario_id uuid;\nBEGIN\n    -- Materializar recursos\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- Obtener usuario_id de la propiedad\n    SELECT usuario_id INTO v_usuario_id FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Validar que no haya otra investigación en curso\n    IF EXISTS (SELECT 1 FROM public.cola_investigacion WHERE propiedad_id = p_propiedad_id) THEN\n        RETURN json_build_object('error', 'Ya hay una investigación en curso.');\n    END IF;\n\n    -- Obtener configuración y datos\n    SELECT * INTO v_configuracion_entrenamiento FROM public.configuracion_entrenamiento WHERE id = p_entrenamiento_id;\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Verificar requisitos\n    IF EXISTS (\n        SELECT 1\n        FROM public.requisito_entrenamiento re\n        WHERE re.entrenamiento_id = p_entrenamiento_id\n        AND NOT EXISTS (\n            SELECT 1\n            FROM public.entrenamiento_usuario eu\n            WHERE eu.usuario_id = v_usuario_id\n            AND eu.entrenamiento_id = re.entrenamiento_requerido_id\n            AND eu.nivel >= re.nivel_requerido\n        )\n    ) THEN\n        RETURN json_build_object('error', 'Requisitos de entrenamiento no cumplidos.');\n    END IF;\n\n    -- Verificar y deducir recursos\n    IF v_propiedad.armas < v_configuracion_entrenamiento.costo_armas OR v_propiedad.municion < v_configuracion_entrenamiento.costo_municion OR v_propiedad.dolares < v_configuracion_entrenamiento.costo_dolares THEN\n        RETURN json_build_object('error', 'Recursos insuficientes.');\n    END IF;\n\n    UPDATE public.propiedad\n    SET\n        armas = armas - v_configuracion_entrenamiento.costo_armas,\n        municion = municion - v_configuracion_entrenamiento.costo_municion,\n        dolares = dolares - v_configuracion_entrenamiento.costo_dolares\n    WHERE id = p_propiedad_id;\n\n    -- Insertar en la cola de investigación\n    INSERT INTO public.cola_investigacion (usuario_id, propiedad_id, entrenamiento_id, nivel_destino, fecha_inicio, fecha_fin)\n    VALUES (v_usuario_id, p_propiedad_id, p_entrenamiento_id, (SELECT COALESCE(MAX(nivel), 0) + 1 FROM public.entrenamiento_usuario WHERE usuario_id = v_usuario_id AND entrenamiento_id = p_entrenamiento_id), NOW(), NOW() + make_interval(secs => v_configuracion_entrenamiento.duracion_entrenamiento));\n\n    RETURN json_build_object('success', true);\nEND;\n$$ LANGUAGE plpgsql SET search_path = '';\n\n-- 4. Reclutamiento de Tropas\nCREATE OR REPLACE FUNCTION public.iniciar_reclutamiento(p_propiedad_id uuid, p_tropa_id text, p_cantidad integer)\nRETURNS json AS $$\nDECLARE\n    v_configuracion_tropa record;\n    v_propiedad record;\n    v_costo_total_armas bigint;\n    v_costo_total_municion bigint;\n    v_costo_total_dolares bigint;\nBEGIN\n    -- Materializar recursos\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- Validar que no haya otro reclutamiento en curso\n    IF EXISTS (SELECT 1 FROM public.cola_reclutamiento WHERE propiedad_id = p_propiedad_id) THEN\n        RETURN json_build_object('error', 'Ya hay un reclutamiento en curso.');\n    END IF;\n\n    -- Obtener configuración y datos\n    SELECT * INTO v_configuracion_tropa FROM public.configuracion_tropa WHERE id = p_tropa_id;\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Calcular costos totales\n    v_costo_total_armas := v_configuracion_tropa.costo_armas * p_cantidad;\n    v_costo_total_municion := v_configuracion_tropa.costo_municion * p_cantidad;\n    v_costo_total_dolares := v_configuracion_tropa.costo_dolares * p_cantidad;\n\n    -- Verificar requisitos\n    IF EXISTS (\n        SELECT 1\n        FROM jsonb_each_text(v_configuracion_tropa.requisitos) AS req\n        WHERE NOT EXISTS (\n            SELECT 1\n            FROM public.habitacion_usuario hu\n            WHERE hu.propiedad_id = p_propiedad_id\n            AND hu.habitacion_id = req.key\n            AND hu.nivel >= (req.value)::integer\n        )\n    ) THEN\n        RETURN json_build_object('error', 'Requisitos de reclutamiento no cumplidos.');\n    END IF;\n\n    -- Verificar y deducir recursos\n    IF v_propiedad.armas < v_costo_total_armas OR v_propiedad.municion < v_costo_total_municion OR v_propiedad.dolares < v_costo_total_dolares THEN\n        RETURN json_build_object('error', 'Recursos insuficientes.');\n    END IF;\n\n    UPDATE public.propiedad\n    SET\n        armas = armas - v_costo_total_armas,\n        municion = municion - v_costo_total_municion,\n        dolares = dolares - v_costo_total_dolares\n    WHERE id = p_propiedad_id;\n\n    -- Insertar en la cola de reclutamiento\n    INSERT INTO public.cola_reclutamiento (propiedad_id, tropa_id, cantidad, fecha_inicio, fecha_fin)\n    VALUES (p_propiedad_id, p_tropa_id, p_cantidad, NOW(), NOW() + make_interval(secs => v_configuracion_tropa.duracion_reclutamiento * p_cantidad));\n\n    RETURN json_build_object('success', true);\nEND;\n$$ LANGUAGE plpgsql SET search_path = '';\n\n-- 5. Onboarding y Creación de Usuario\nDROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;\nDROP FUNCTION IF EXISTS public.handle_new_user();\n\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS trigger AS $$\nBEGIN\n  INSERT INTO public.usuario (id, email, nombre_usuario)\n  VALUES (new.id, new.email, new.raw_user_meta_data->>'full_name');\n  INSERT INTO public.puntuacion_usuario (usuario_id)\n  VALUES (new.id);\n  RETURN new;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';\n\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();\n\nCREATE OR REPLACE FUNCTION public.crear_propiedad_inicial(p_nombre text, p_ciudad integer, p_barrio integer, p_edificio integer)\nRETURNS json AS $$\nDECLARE\n    v_propiedad_id uuid;\nBEGIN\n    -- Verificar si el usuario ya tiene una propiedad\n    IF EXISTS (SELECT 1 FROM public.propiedad WHERE usuario_id = auth.uid()) THEN\n        RETURN json_build_object('error', 'El usuario ya tiene una propiedad.');\n    END IF;\n\n    -- Verificar unicidad de coordenadas\n    IF EXISTS (SELECT 1 FROM public.propiedad WHERE coordenada_ciudad = p_ciudad AND coordenada_barrio = p_barrio AND coordenada_edificio = p_edificio) THEN\n        RETURN json_build_object('error', 'Las coordenadas ya están ocupadas.');\n    END IF;\n\n    -- Insertar la nueva propiedad\n    INSERT INTO public.propiedad (usuario_id, nombre, coordenada_ciudad, coordenada_barrio, coordenada_edificio, armas, municion, alcohol, dolares, ultima_recogida_recursos)\n    VALUES (auth.uid(), p_nombre, p_ciudad, p_barrio, p_edificio, 500, 500, 500, 500, now())\n    RETURNING id INTO v_propiedad_id;\n\n    -- Insertar habitaciones iniciales\n    INSERT INTO public.habitacion_usuario (propiedad_id, habitacion_id, nivel)\n    VALUES\n        (v_propiedad_id, 'oficina_del_jefe', 1),\n        (v_propiedad_id, 'escuela_especializacion', 1),\n        (v_propiedad_id, 'armeria', 1),\n        (v_propiedad_id, 'deposito_de_municion', 1),\n        (v_propiedad_id, 'cerveceria', 1),\n        (v_propiedad_id, 'taberna', 1),\n        (v_propiedad_id, 'campo_de_entrenamiento', 1);\n\n    -- Actualizar el estado del primer login del usuario\n    UPDATE public.usuario SET primer_login = true WHERE id = auth.uid();\n\n    RETURN json_build_object('success', true, 'propiedad_id', v_propiedad_id);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "crear_propiedad_inicial",
            "handle_new_user",
            "iniciar_construccion_habitacion",
            "iniciar_entrenamiento",
            "iniciar_reclutamiento",
            "materializar_recursos",
            "procesar_colas"
        ]
    }
}