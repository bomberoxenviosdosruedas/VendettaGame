{
    "filename": "20250225120000_recreate_legacy_schema.sql",
    "timestamp": "2025-02-25T12:00:00",
    "content": "-- Migration script to recreate the legacy schema and populate configuration data\n-- Generated based on legacy MySQL dump and PHP configuration arrays.\n\nBEGIN;\n\n-- -----------------------------------------------------------------------------\n-- Part 1: Schema Definition (DDL)\n-- Maps legacy `mob_*` tables to modern PostgreSQL schema with snake_case and proper types.\n-- -----------------------------------------------------------------------------\n\n-- Create a schema for the game if desired, but using public for simplicity as per standard Supabase setup.\n\n-- 1. Configuration Tables (Static Data from PHP Arrays)\n-- -----------------------------------------------------------------------------\n\nCREATE TABLE IF NOT EXISTS public.config_buildings (\n    id text PRIMARY KEY, -- e.g., 'oficina', 'escuela'\n    name text NOT NULL,\n    description text,\n    cost_armaments integer NOT NULL DEFAULT 0,\n    cost_munitions integer NOT NULL DEFAULT 0,\n    cost_dollars integer NOT NULL DEFAULT 0,\n    base_duration integer NOT NULL DEFAULT 0, -- in seconds\n    base_production integer NOT NULL DEFAULT 0,\n    points numeric(10, 2) NOT NULL DEFAULT 0,\n    created_at timestamptz DEFAULT now()\n);\n\nCREATE TABLE IF NOT EXISTS public.config_research (\n    id text PRIMARY KEY, -- e.g., 'rutas', 'armas'\n    name text NOT NULL,\n    description text,\n    cost_armaments integer NOT NULL DEFAULT 0,\n    cost_munitions integer NOT NULL DEFAULT 0,\n    cost_dollars integer NOT NULL DEFAULT 0,\n    base_duration integer NOT NULL DEFAULT 0, -- in seconds\n    points numeric(10, 2) NOT NULL DEFAULT 0,\n    created_at timestamptz DEFAULT now()\n);\n\nCREATE TABLE IF NOT EXISTS public.config_units (\n    id text PRIMARY KEY, -- e.g., 'maton', 'portero'\n    name text NOT NULL,\n    description text,\n    cost_armaments integer NOT NULL DEFAULT 0,\n    cost_munitions integer NOT NULL DEFAULT 0,\n    cost_dollars integer NOT NULL DEFAULT 0,\n    base_duration integer NOT NULL DEFAULT 0, -- in seconds\n    points numeric(10, 2) NOT NULL DEFAULT 0,\n    attack integer NOT NULL DEFAULT 0,\n    defense integer NOT NULL DEFAULT 0,\n    capacity integer NOT NULL DEFAULT 0,\n    velocity integer NOT NULL DEFAULT 0,\n    salary integer NOT NULL DEFAULT 0, -- upkeep cost\n    type text CHECK (type IN ('attack', 'defense', 'special')) DEFAULT 'attack',\n    created_at timestamptz DEFAULT now()\n);\n\n-- 2. User & Profile Tables\n-- -----------------------------------------------------------------------------\n\n-- `auth.users` is managed by Supabase. We create a public profile table linked to it.\n-- Mapped from `mob_usuarios`.\n\nCREATE TABLE IF NOT EXISTS public.profiles (\n    id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,\n    username text UNIQUE NOT NULL,\n    email text, -- Optional, mostly handled by auth.users\n    legacy_id integer, -- To keep reference to old ID during migration\n    last_active_at timestamptz,\n    points_buildings numeric(15, 2) DEFAULT 0,\n    points_units numeric(15, 2) DEFAULT 0,\n    points_research numeric(15, 2) DEFAULT 0,\n    total_points numeric(15, 2) DEFAULT 0,\n    ranking_position integer,\n    is_banned boolean DEFAULT false,\n    language varchar(2) DEFAULT 'es',\n    created_at timestamptz DEFAULT now(),\n    updated_at timestamptz DEFAULT now()\n);\n\n-- 3. Game World Tables\n-- -----------------------------------------------------------------------------\n\n-- Mapped from `mob_familias`\nCREATE TABLE IF NOT EXISTS public.alliances (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    legacy_id integer,\n    name text NOT NULL,\n    tag varchar(8) NOT NULL,\n    description text,\n    logo_url text,\n    website text,\n    created_at timestamptz DEFAULT now()\n);\n\n-- Mapped from `mob_familias_miembros`\nCREATE TABLE IF NOT EXISTS public.alliance_members (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    alliance_id uuid REFERENCES public.alliances(id) ON DELETE CASCADE,\n    user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    rank_name text, -- Simplified from rank ID\n    joined_at timestamptz DEFAULT now(),\n    UNIQUE(user_id) -- User can only be in one alliance\n);\n\n-- Mapped from `mob_edificios` (Bases)\nCREATE TABLE IF NOT EXISTS public.bases (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    legacy_id integer,\n    user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    name text, -- Optional custom name\n    coord_x integer NOT NULL,\n    coord_y integer NOT NULL,\n    coord_z integer NOT NULL,\n    resources_armaments numeric(20, 2) DEFAULT 0,\n    resources_munitions numeric(20, 2) DEFAULT 0,\n    resources_alcohol numeric(20, 2) DEFAULT 0,\n    resources_dollars numeric(20, 2) DEFAULT 0,\n    points numeric(15, 2) DEFAULT 0,\n    last_updated_at timestamptz DEFAULT now(),\n    created_at timestamptz DEFAULT now(),\n    UNIQUE(coord_x, coord_y, coord_z)\n);\n\n-- Mapped from `mob_habitaciones` (Building Levels in a Base)\n-- Instead of wide table with column per building, we use a normalized EAV approach or a JSONB column.\n-- Given the requirement for strict schema, let's use a normalized table.\nCREATE TABLE IF NOT EXISTS public.base_buildings (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    base_id uuid REFERENCES public.bases(id) ON DELETE CASCADE,\n    building_id text REFERENCES public.config_buildings(id),\n    level integer NOT NULL DEFAULT 0,\n    created_at timestamptz DEFAULT now(),\n    UNIQUE(base_id, building_id)\n);\n\n-- Mapped from `mob_tropas` (Units in a Base)\nCREATE TABLE IF NOT EXISTS public.base_units (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    base_id uuid REFERENCES public.bases(id) ON DELETE CASCADE,\n    unit_id text REFERENCES public.config_units(id),\n    amount integer NOT NULL DEFAULT 0,\n    created_at timestamptz DEFAULT now(),\n    UNIQUE(base_id, unit_id)\n);\n\n-- Mapped from `mob_entrenamientos` (Research Levels per User)\nCREATE TABLE IF NOT EXISTS public.user_research (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    research_id text REFERENCES public.config_research(id),\n    level integer NOT NULL DEFAULT 0,\n    created_at timestamptz DEFAULT now(),\n    UNIQUE(user_id, research_id)\n);\n\n-- 4. Queue Tables (Construction, Training, Research)\n-- -----------------------------------------------------------------------------\n\n-- Mapped from `mob_habitaciones_nuevas`\nCREATE TABLE IF NOT EXISTS public.construction_queue (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    base_id uuid REFERENCES public.bases(id) ON DELETE CASCADE,\n    building_id text REFERENCES public.config_buildings(id),\n    target_level integer NOT NULL,\n    start_time timestamptz DEFAULT now(),\n    end_time timestamptz NOT NULL,\n    created_at timestamptz DEFAULT now()\n);\n\n-- Mapped from `mob_tropas_nuevas`\nCREATE TABLE IF NOT EXISTS public.unit_queue (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    base_id uuid REFERENCES public.bases(id) ON DELETE CASCADE,\n    unit_id text REFERENCES public.config_units(id),\n    amount integer NOT NULL,\n    start_time timestamptz DEFAULT now(),\n    end_time timestamptz NOT NULL,\n    created_at timestamptz DEFAULT now()\n);\n\n-- Mapped from `mob_entrenamientos_nuevos`\nCREATE TABLE IF NOT EXISTS public.research_queue (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    base_id uuid REFERENCES public.bases(id) ON DELETE SET NULL, -- Research happens at a base but belongs to user\n    research_id text REFERENCES public.config_research(id),\n    target_level integer NOT NULL,\n    start_time timestamptz DEFAULT now(),\n    end_time timestamptz NOT NULL,\n    created_at timestamptz DEFAULT now()\n);\n\n-- 5. Interaction Tables (Market, Messages, Map Movements)\n-- -----------------------------------------------------------------------------\n\n-- Mapped from `mob_mercado`\nCREATE TABLE IF NOT EXISTS public.market_offers (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    seller_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    resource_type text NOT NULL, -- 'arm', 'mun', 'dol', 'alc'\n    amount integer NOT NULL,\n    cost_armaments integer DEFAULT 0,\n    cost_munitions integer DEFAULT 0,\n    cost_dollars integer DEFAULT 0,\n    recipient_id uuid REFERENCES public.profiles(id), -- Null for public offer\n    created_at timestamptz DEFAULT now(),\n    expires_at timestamptz\n);\n\n-- Mapped from `mob_mensajes`\nCREATE TABLE IF NOT EXISTS public.messages (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    sender_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,\n    recipient_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    subject text,\n    body text,\n    is_read boolean DEFAULT false,\n    is_deleted_by_sender boolean DEFAULT false,\n    is_deleted_by_recipient boolean DEFAULT false,\n    created_at timestamptz DEFAULT now()\n);\n\n-- Mapped from `mob_misiones`\nCREATE TABLE IF NOT EXISTS public.map_movements (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,\n    origin_base_id uuid REFERENCES public.bases(id) ON DELETE CASCADE,\n    target_coord_x integer,\n    target_coord_y integer,\n    target_coord_z integer,\n    mission_type text NOT NULL, -- 'attack', 'transport', 'spy', etc.\n    units jsonb NOT NULL DEFAULT '{}'::jsonb, -- { \"maton\": 10, ... }\n    resources jsonb DEFAULT '{}'::jsonb, -- { \"arm\": 100, ... }\n    start_time timestamptz DEFAULT now(),\n    arrival_time timestamptz NOT NULL,\n    return_time timestamptz,\n    created_at timestamptz DEFAULT now()\n);\n\n\n-- -----------------------------------------------------------------------------\n-- Part 2: Data Population (DML)\n-- Inserts data from PHP arrays in gameconfig.php\n-- -----------------------------------------------------------------------------\n\n-- 2.1 Research (Entrenamientos)\nINSERT INTO public.config_research (id, name, cost_armaments, cost_munitions, cost_dollars, base_duration, points) VALUES\n('rutas', 'Planificacion de rutas', 500, 1200, 0, 2000, 15.5),\n('encargos', 'Planificacion de encargos', 1000, 2500, 1000, 5000, 46),\n('extorsion', 'Extorsion', 1000, 2000, 0, 3000, 26),\n('administracion', 'Administración de base', 0, 0, 5000, 14400, 76),\n('contrabando', 'Contrabando', 0, 0, 1500, 9600, 23.5),\n('espionaje', 'Espionaje', 500, 500, 300, 4200, 13),\n('seguridad', 'Seguridad', 1000, 4000, 1000, 4000, 61),\n('proteccion', 'Proteccion de grupo', 3000, 5000, 2000, 5000, 96),\n('combate', 'Combate cuerpo a cuerpo', 2000, 2000, 3000, 6200, 76),\n('armas', 'Combate de armas a corta distancia', 1000, 200, 3000, 5100, 53),\n('tiro', 'Entrenamiento de Tiro', 5000, 12000, 10000, 19200, 296),\n('explosivos', 'Fabricación de explosivos', 10000, 19500, 15000, 42000, 471),\n('guerrilla', 'Entrenamiento de guerrilla', 8000, 10000, 12000, 20000, 321),\n('psicologico', 'Entrenamiento psicologico', 2000, 5000, 16000, 26000, 301),\n('quimico', 'Entrenamiento químico', 4000, 12000, 1000, 14400, 0),\n('honor', 'Honor', 0, 0, 280000, 92000, 4201)\nON CONFLICT (id) DO NOTHING;\n\n-- 2.2 Buildings (Habitaciones)\nINSERT INTO public.config_buildings (id, name, description, cost_armaments, cost_munitions, cost_dollars, base_duration, base_production, points) VALUES\n('oficina', 'Oficina del Jefe', 'El Jefe se encuentra en esta oficina, y aquí, se toman todas las decisiones. Coordina el desarrollo y la velocidad de construcción de las otras áreas. Cuando más nivel, más rápido se desarrollan el resto.', 100, 200, 0, 900, 0, 6),\n('escuela', 'Escuela de especialización', 'Como ya dice el nombre, esta habitación permite el entrenamiento de \"los chicos\" en nuevas ténicas, permitiéndoles tener más experiencia en combate. Al igual que para la oficina de El Jefe, cuánto más rápido se haga el entrenamiento, más rápido se desarrollan las habilidades.', 1000, 1000, 0, 2000, 0, 31.75),\n('armeria', 'Armería', 'Aquí, en la Armería, como dice el nombre, se guardan armas. Serán de gran necesidad para ocupar nuevos lugares, y para entrenamientos en combate. Cuanto mejor desarrollada esté, más armas podrás hacer al mismo tiempo.', 12, 60, 0, 500, 10, 2.32),\n('municion', 'Almacén de munición', 'El almacén de munición es similar a la armería. Aquí, se manufactura la munición importante. Es necesaria, en grandes cantidades, al ocupar áreas, así como para su uso en entrenamientos. A diferencia de las armas, la munición se usa mucho más rápido.', 9, 15, 0, 600, 10, 1.39),\n('cerveceria', 'Cervecería', 'Esta habitación manufactura alcohol. Desgraciadamente (¿o afortunadamente?) está prohibido y por tanto, muy demandado por la población, así que es un negocio próspero. Sin embargo, necesitarás ciertas estrategias para poder llevarlo hasta los ciudadanos.', 20, 20, 0, 1000, 50, 1.6),\n('taberna', 'Taberna', 'En la taberna se consume alcohol. Aquí es donde traficas con Alcohol. Ten cuidado de no ser detectado por la Policia, o te saldrá caro. Dado que la taberna se supervisa batante mal, la conversión de alcohol es moderada.', 10, 50, 0, 1500, 8, 2.1),\n('contrabando', 'Contrabando', 'Mejor que la taberna funciona el contrabando, podrás vender alcohol con un impacto mucho mayor, lo que naturalmente, beneficia a la caja de los gángsters. Desgraciadamente, esta táctica es arriesgada, y mucho más costosa.', 2000, 5000, 500, 4000, 21, 136),\n('almacen_arm', 'Almacén de armas', 'En el almacén de armas, se guarda todo el armamento que no se necesita de inmediato. El proceso es automático, y se mantienen allí hasta que sean necesarias. Además, ningún enemigo podrá robártelas de este almacén.', 100, 500, 0, 9000, 0, 12),\n('deposito', 'Depósito de munición', 'El depósito de munición funciona de forma similar al almacén de armas. Se guardan cajas de munición y granadas que no se vayan a usar de inmediato. Además, aquí están más seguras, a salvo del enemigo.', 500, 600, 0, 12000, 0, 18),\n('almacen_alc', 'Almacén de alcohol', 'Ya que la destilación de alcohol es bastante sencilla, la producción es alta. Para poder almacenarlo sin perder el exceso de producción, necesitas construir un almacén de alcohol. En el mismo, estará a salvo de los enemigos.', 200, 200, 0, 8000, 0, 7),\n('caja', 'Caja fuerte', 'Después de realizar un contrabando con éxito, conseguirás una buena cantidad de dólares. Pero, ¡presta atención!. Si no quieres tirar el dinero, debes usar esta caja, para prevenir que desaparezca, y para asegurarte liquidez.', 2000, 2000, 1000, 16000, 0, 91),\n('campo', 'Campo de entrenamiento', 'Tal y como dice el nombre, en el campo de entrenamiento, tus \"chicos\" entrenarán. El mismo, dependerá según el tipo de unidades que puedas producir, por ejemplo, simples delincuentes, asesinos, profesionales, a los que tus enemigos tendrán un respeto extremo. Dependiendo del nivel, las unidades serán creadas en menor tiempo.', 1000, 2500, 0, 5600, 0, 61),\n('seguridad', 'Seguridad', 'Al igual que el entrenamiento de luchadores en el campo de entrenamiento, aquí podrás entrenar a los más jóvenes en defensa. En principio, se quedarán permanentemente, siempre en el hogar, y protegiendo sus habitaciones contra enemigos. Si tus gángsters están de vuelta, automáticamente luchan juntos.', 0, 0, 0, 6000, 0, 45),\n('torreta', 'Torreta de fuego automático', 'A fin de aliviar un poco el trabajo de los defensores, dispones de ciertas construcciones, como esta torreta de fuego automático. Técnicamente, son muy avanzadas, y en el momento en que detecten a un enemigo, abrirán fuego de golpe.', 1000, 2000, 200, 4500, 0, 57),\n('minas', 'Minas ocultas', 'Estas minas son una ayuda incluso más \"agradable\". Tus chicos las repartirán a lo largo de la casa. Cuando algún enemigo la pise sin darse cuenta... ¡Buenas noches!', 2000, 2000, 150, 3000, 0, 65.5)\nON CONFLICT (id) DO NOTHING;\n\n-- 2.3 Troops (Tropas)\nINSERT INTO public.config_units (id, name, cost_armaments, cost_munitions, cost_dollars, base_duration, points, attack, defense, capacity, velocity, salary, type) VALUES\n('maton', 'Maton', 200, 1000, 0, 1400, 6, 5, 5, 200, 1600, 1, 'attack'),\n('portero', 'Portero', 500, 8000, 0, 1600, 6, 8, 6, 400, 2000, 1, 'defense'),\n('acuchillador', 'Acuchillador', 1000, 200, 0, 2000, 4, 10, 4, 300, 2500, 1, 'attack'),\n('pistolero', 'Pistolero', 2000, 3000, 0, 1200, 21, 30, 10, 500, 2400, 2, 'attack'),\n('ocupacion', 'Tropa de Ocupacion', 20000, 10000, 20000, 344000, 251, 1, 10, 3000, 2000, 500, 'special'),\n('espia', 'Espia', 500, 200, 0, 14000, 3, 1, 1, 50, 400000, 1, 'special'),\n('porteador', 'Porteador', 300, 100, 1000, 3600, 9, 4, 6, 10000, 2400, 5, 'special'),\n('cia', 'Agente de la CIA', 7000, 10000, 2500, 17000, 87, 100, 90, 3000, 3400, 30, 'attack'),\n('fbi', 'Agente del FBI', 4000, 6000, 1000, 15500, 48, 60, 50, 2000, 3000, 20, 'attack'),\n('transportista', 'Transportista', 1000, 2000, 5000, 17200, 51, 6, 8, 40000, 5000, 10, 'special'),\n('francotirador', 'Francotirador', 4000, 500, 2000, 25000, 28, 200, 10, 1000, 6000, 20, 'attack'),\n('asesino', 'Asesino', 10000, 15000, 10000, 6000, 176, 300, 200, 2000, 6500, 50, 'attack'),\n('ninja', 'Ninja', 2000, 1000, 30000, 40000, 236, 400, 600, 5000, 8000, 60, 'attack'),\n('mercenario', 'Mercenario', 80000, 120000, 50000, 144000, 1176, 1000, 1200, 12000, 4500, 300, 'attack'),\n-- Defense specific units inferred from legacy arrays typically found in other contexts or config logic\n('centinela', 'Centinela', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 'defense'),\n('policia', 'Policia', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 'defense'),\n('guardaespaldas', 'Guardaespaldas', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 'defense'),\n('guardia', 'Guardia', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 'defense')\nON CONFLICT (id) DO NOTHING;\n\n\n-- -----------------------------------------------------------------------------\n-- Part 3: Row Level Security (RLS)\n-- -----------------------------------------------------------------------------\n\n-- Enable RLS on all tables\nALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.alliances ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.alliance_members ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.bases ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.base_buildings ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.base_units ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.user_research ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.construction_queue ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.unit_queue ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.research_queue ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.market_offers ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.map_movements ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.config_buildings ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.config_research ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.config_units ENABLE ROW LEVEL SECURITY;\n\n-- 1. Configuration Tables (Public Read)\nCREATE POLICY \"Public read config buildings\" ON public.config_buildings FOR SELECT USING (true);\nCREATE POLICY \"Public read config research\" ON public.config_research FOR SELECT USING (true);\nCREATE POLICY \"Public read config units\" ON public.config_units FOR SELECT USING (true);\n\n-- 2. Profiles\n-- Users can read all profiles (to see other players)\nCREATE POLICY \"Public read profiles\" ON public.profiles FOR SELECT USING (true);\n-- Users can update their own profile\nCREATE POLICY \"Update own profile\" ON public.profiles FOR UPDATE USING (auth.uid() = id);\n\n-- 3. Bases\n-- Users can read all bases (map view)\nCREATE POLICY \"Public read bases\" ON public.bases FOR SELECT USING (true);\n-- Users can update their own bases\nCREATE POLICY \"Update own bases\" ON public.bases FOR UPDATE USING (auth.uid() = user_id);\n\n-- 4. Private User Data (Research, Queues, Messages)\nCREATE POLICY \"Read own research\" ON public.user_research FOR SELECT USING (auth.uid() = user_id);\nCREATE POLICY \"Read own construction queue\" ON public.construction_queue FOR SELECT USING (\n    EXISTS (SELECT 1 FROM public.bases WHERE bases.id = construction_queue.base_id AND bases.user_id = auth.uid())\n);\nCREATE POLICY \"Read own unit queue\" ON public.unit_queue FOR SELECT USING (\n    EXISTS (SELECT 1 FROM public.bases WHERE bases.id = unit_queue.base_id AND bases.user_id = auth.uid())\n);\nCREATE POLICY \"Read own research queue\" ON public.research_queue FOR SELECT USING (auth.uid() = user_id);\n\n-- 5. Messages\nCREATE POLICY \"Read own messages\" ON public.messages FOR SELECT USING (auth.uid() = sender_id OR auth.uid() = recipient_id);\n\n-- 6. Market\nCREATE POLICY \"Read active market offers\" ON public.market_offers FOR SELECT USING (true);\nCREATE POLICY \"Update own market offers\" ON public.market_offers FOR UPDATE USING (auth.uid() = seller_id);\n\n-- 7. Alliances\nCREATE POLICY \"Public read alliances\" ON public.alliances FOR SELECT USING (true);\n\n-- 8. Map Movements\nCREATE POLICY \"Read own movements\" ON public.map_movements FOR SELECT USING (auth.uid() = user_id);\n-- In a real game, you might want to allow seeing incoming attacks:\nCREATE POLICY \"Read incoming movements\" ON public.map_movements FOR SELECT USING (\n    EXISTS (SELECT 1 FROM public.bases WHERE bases.id = map_movements.origin_base_id AND bases.user_id = auth.uid()) -- Outgoing\n    OR\n    EXISTS (SELECT 1 FROM public.bases WHERE bases.coord_x = map_movements.target_coord_x AND bases.coord_y = map_movements.target_coord_y AND bases.coord_z = map_movements.target_coord_z AND bases.user_id = auth.uid()) -- Incoming\n);\n\nCOMMIT;\n",
    "summary": {
        "tables_created": [
            "alliance_members",
            "alliances",
            "base_buildings",
            "base_units",
            "bases",
            "config_buildings",
            "config_research",
            "config_units",
            "construction_queue",
            "map_movements",
            "market_offers",
            "messages",
            "profiles",
            "research_queue",
            "unit_queue",
            "user_research"
        ],
        "functions_created": []
    }
}