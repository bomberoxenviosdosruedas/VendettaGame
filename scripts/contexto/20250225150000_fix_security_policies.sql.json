{
    "filename": "20250225150000_fix_security_policies.sql",
    "timestamp": "2025-02-25T15:00:00",
    "content": "-- Migration to fix security policies (RLS) for alliance_members, base_buildings, and base_units.\n-- These tables were enabled for RLS but lacked policies, creating a fail-closed or insecure state.\n\nBEGIN;\n\n-- 1. public.alliance_members\n-- -----------------------------------------------------------------------------\n-- Allow public read access (e.g., to see who is in an alliance)\nCREATE POLICY \"Public read alliance members\" ON public.alliance_members\n    FOR SELECT\n    USING (true);\n\n-- Allow users to manage their own membership (e.g., leave alliance)\n-- Note: Further policies might be needed for Alliance Leaders to manage other members.\nCREATE POLICY \"Manage own alliance membership\" ON public.alliance_members\n    FOR ALL\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id);\n\n\n-- 2. public.base_buildings\n-- -----------------------------------------------------------------------------\n-- Allow public read access (e.g., for espionage or visiting profiles)\nCREATE POLICY \"Public read base buildings\" ON public.base_buildings\n    FOR SELECT\n    USING (true);\n\n-- Allow base owners to insert, update, or delete buildings in their bases\nCREATE POLICY \"Manage own base buildings\" ON public.base_buildings\n    FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.bases\n            WHERE bases.id = base_buildings.base_id\n            AND bases.user_id = auth.uid()\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.bases\n            WHERE bases.id = base_buildings.base_id\n            AND bases.user_id = auth.uid()\n        )\n    );\n\n\n-- 3. public.base_units\n-- -----------------------------------------------------------------------------\n-- Allow public read access (e.g., for espionage)\nCREATE POLICY \"Public read base units\" ON public.base_units\n    FOR SELECT\n    USING (true);\n\n-- Allow base owners to manage units in their bases\nCREATE POLICY \"Manage own base units\" ON public.base_units\n    FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.bases\n            WHERE bases.id = base_units.base_id\n            AND bases.user_id = auth.uid()\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.bases\n            WHERE bases.id = base_units.base_id\n            AND bases.user_id = auth.uid()\n        )\n    );\n\nCOMMIT;\n",
    "summary": {
        "tables_created": [],
        "functions_created": []
    }
}