{
    "filename": "20250530000000_map_rpc.sql",
    "timestamp": "2025-05-30T00:00:00",
    "content": "-- Function to get map tiles for a specific city and district\nCREATE OR REPLACE FUNCTION public.get_map_tiles(\n    p_ciudad INTEGER,\n    p_barrio INTEGER\n)\nRETURNS TABLE (\n    propiedad_id UUID,\n    coordenada_edificio INTEGER,\n    usuario_id UUID,\n    nombre_usuario TEXT,\n    nombre_familia TEXT,\n    etiqueta_familia TEXT,\n    puntos REAL,\n    es_propia BOOLEAN\n)\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = public\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT\n        p.id AS propiedad_id,\n        p.coordenada_edificio,\n        p.usuario_id,\n        u.nombre_usuario,\n        f.nombre AS nombre_familia,\n        f.etiqueta AS etiqueta_familia,\n        COALESCE(pu.puntos_totales, 0) AS puntos,\n        (p.usuario_id = auth.uid()) AS es_propia\n    FROM\n        public.propiedad p\n    JOIN\n        public.usuario u ON p.usuario_id = u.id\n    LEFT JOIN\n        public.miembro_familia mf ON u.id = mf.usuario_id\n    LEFT JOIN\n        public.familia f ON mf.familia_id = f.id\n    LEFT JOIN\n        public.puntuacion_usuario pu ON u.id = pu.usuario_id\n    WHERE\n        p.coordenada_ciudad = p_ciudad\n        AND p.coordenada_barrio = p_barrio;\nEND;\n$$;\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "get_map_tiles"
        ]
    }
}