{
    "filename": "20250210_000001_consolidated_schema_tables.sql",
    "timestamp": "2025-02-10T00:00:00",
    "content": "-- Tipos Enumerados (Enums)\nCREATE TYPE public.estado_invitacion AS ENUM ('pendiente', 'aceptada', 'rechazada');\nCREATE TYPE public.rol_familia AS ENUM ('miembro', 'capitan', 'lider');\nCREATE TYPE public.categoria_mensaje AS ENUM ('jugador', 'familia', 'sistema', 'batalla', 'espionaje');\nCREATE TYPE public.estado_flota AS ENUM ('en_camino', 'regresando', 'estacionada', 'combatiendo');\nCREATE TYPE public.tipo_mision AS ENUM ('atacar', 'transportar', 'espiar', 'colonizar', 'recolectar');\n\n-- Usuarios y Sistema\nCREATE TABLE public.usuario (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid() REFERENCES auth.users(id) ON DELETE CASCADE,\n    nombre_usuario text NOT NULL UNIQUE,\n    email text NOT NULL UNIQUE,\n    url_avatar text,\n    nombre text DEFAULT '',\n    titulo text,\n    rol text DEFAULT 'USER',\n    primer_login boolean DEFAULT false,\n    ultimo_visto timestamptz DEFAULT now(),\n    fecha_creacion timestamptz DEFAULT now(),\n    fecha_actualizacion timestamptz DEFAULT now()\n);\n\nCREATE TABLE public.historial_acceso (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    usuario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    fecha_acceso timestamptz DEFAULT now(),\n    direccion_ip text,\n    agente_usuario text,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.puntuacion_usuario (\n    usuario_id uuid PRIMARY KEY REFERENCES public.usuario(id) ON DELETE CASCADE,\n    puntos_habitaciones real DEFAULT 0,\n    puntos_tropas real DEFAULT 0,\n    puntos_entrenamientos real DEFAULT 0,\n    puntos_totales real DEFAULT 0,\n    puntos_honor_atacante real DEFAULT 0,\n    puntos_honor_defensor real DEFAULT 0,\n    puntos_honor_totales real DEFAULT 0,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.errores_configuracion (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    usuario_id uuid,\n    mensaje_error text,\n    fecha_creacion timestamptz DEFAULT now()\n);\n\n-- Configuración (Meta-Data del Juego)\nCREATE TABLE public.configuracion_habitacion (\n    id text PRIMARY KEY,\n    nombre text NOT NULL,\n    descripcion text,\n    url_imagen text NOT NULL,\n    costo_armas bigint DEFAULT 0,\n    costo_municion bigint DEFAULT 0,\n    costo_dolares bigint DEFAULT 0,\n    duracion_construccion integer DEFAULT 0,\n    produccion_base real DEFAULT 0,\n    recurso_producido text,\n    puntos real DEFAULT 0,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.configuracion_entrenamiento (\n    id text PRIMARY KEY,\n    nombre text NOT NULL,\n    url_imagen text NOT NULL,\n    costo_armas bigint DEFAULT 0,\n    costo_municion bigint DEFAULT 0,\n    costo_dolares bigint DEFAULT 0,\n    duracion_entrenamiento integer DEFAULT 0,\n    puntos real DEFAULT 0,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.configuracion_tropa (\n    id text PRIMARY KEY,\n    nombre text NOT NULL,\n    descripcion text,\n    url_imagen text NOT NULL,\n    costo_armas bigint DEFAULT 0,\n    costo_municion bigint DEFAULT 0,\n    costo_dolares bigint DEFAULT 0,\n    duracion_reclutamiento integer DEFAULT 0,\n    ataque integer DEFAULT 0,\n    defensa integer DEFAULT 0,\n    capacidad_carga integer DEFAULT 0,\n    velocidad bigint DEFAULT 0,\n    salario integer DEFAULT 0,\n    puntos real DEFAULT 0,\n    tipo text NOT NULL,\n    requisitos jsonb,\n    bonus_ataque text[],\n    bonus_defensa text[],\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.requisito_habitacion (\n    id uuid PRIMARY KEY,\n    habitacion_id text REFERENCES public.configuracion_habitacion(id),\n    habitacion_requerida_id text REFERENCES public.configuracion_habitacion(id),\n    nivel_requerido integer\n);\n\nCREATE TABLE public.requisito_entrenamiento (\n    id uuid PRIMARY KEY,\n    entrenamiento_id text REFERENCES public.configuracion_entrenamiento(id),\n    entrenamiento_requerido_id text REFERENCES public.configuracion_entrenamiento(id),\n    nivel_requerido integer\n);\n\nCREATE TABLE public.tropa_bonus_contrincante (\n    id uuid PRIMARY KEY,\n    tropa_atacante_id text REFERENCES public.configuracion_tropa(id),\n    tropa_defensora_id text REFERENCES public.configuracion_tropa(id),\n    factor_prioridad real\n);\n\n-- Propiedades (Estado del Juego)\nCREATE TABLE public.propiedad (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    usuario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    nombre text NOT NULL,\n    coordenada_ciudad integer NOT NULL,\n    coordenada_barrio integer NOT NULL,\n    coordenada_edificio integer NOT NULL,\n    armas bigint DEFAULT 0 CHECK (armas >= 0),\n    municion bigint DEFAULT 0 CHECK (municion >= 0),\n    alcohol bigint DEFAULT 0 CHECK (alcohol >= 0),\n    dolares bigint DEFAULT 0 CHECK (dolares >= 0),\n    ultima_recogida_recursos timestamptz,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    UNIQUE (coordenada_ciudad, coordenada_barrio, coordenada_edificio)\n);\n\nCREATE TABLE public.habitacion_usuario (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    propiedad_id uuid REFERENCES public.propiedad(id) ON DELETE CASCADE,\n    habitacion_id text REFERENCES public.configuracion_habitacion(id),\n    nivel smallint DEFAULT 0,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    UNIQUE (propiedad_id, habitacion_id)\n);\n\nCREATE TABLE public.tropa_propiedad (\n    propiedad_id uuid REFERENCES public.propiedad(id) ON DELETE CASCADE,\n    tropa_id text REFERENCES public.configuracion_tropa(id),\n    cantidad integer DEFAULT 0 CHECK (cantidad >= 0),\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    PRIMARY KEY (propiedad_id, tropa_id)\n);\n\nCREATE TABLE public.tropa_seguridad_propiedad (\n    propiedad_id uuid REFERENCES public.propiedad(id) ON DELETE CASCADE,\n    tropa_id text REFERENCES public.configuracion_tropa(id),\n    cantidad integer DEFAULT 0 CHECK (cantidad >= 0),\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    PRIMARY KEY (propiedad_id, tropa_id)\n);\n\nCREATE TABLE public.entrenamiento_usuario (\n    usuario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    entrenamiento_id text REFERENCES public.configuracion_entrenamiento(id),\n    nivel integer DEFAULT 0,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    PRIMARY KEY (usuario_id, entrenamiento_id)\n);\n\n-- Colas de Procesos\nCREATE TABLE public.cola_construccion (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    propiedad_id uuid REFERENCES public.propiedad(id) ON DELETE CASCADE,\n    habitacion_id text REFERENCES public.configuracion_habitacion(id),\n    nivel_destino integer NOT NULL,\n    duracion_segundos integer NOT NULL,\n    fecha_inicio timestamptz NOT NULL,\n    fecha_fin timestamptz,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.cola_investigacion (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    usuario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    propiedad_id uuid REFERENCES public.propiedad(id),\n    entrenamiento_id text REFERENCES public.configuracion_entrenamiento(id),\n    nivel_destino integer NOT NULL,\n    fecha_inicio timestamptz NOT NULL,\n    fecha_fin timestamptz NOT NULL,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    UNIQUE (propiedad_id)\n);\n\nCREATE TABLE public.cola_reclutamiento (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    propiedad_id uuid REFERENCES public.propiedad(id) ON DELETE CASCADE,\n    tropa_id text REFERENCES public.configuracion_tropa(id),\n    cantidad integer NOT NULL,\n    fecha_inicio timestamptz NOT NULL,\n    fecha_fin timestamptz NOT NULL,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    UNIQUE (propiedad_id)\n);\n\n-- Familias y Diplomacia\nCREATE TABLE public.familia (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    nombre text NOT NULL UNIQUE,\n    etiqueta text NOT NULL UNIQUE,\n    descripcion text,\n    url_avatar text,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.miembro_familia (\n    usuario_id uuid PRIMARY KEY REFERENCES public.usuario(id) ON DELETE CASCADE,\n    familia_id uuid REFERENCES public.familia(id) ON DELETE CASCADE,\n    rol rol_familia DEFAULT 'miembro',\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.invitacion_familia (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    familia_id uuid REFERENCES public.familia(id) ON DELETE CASCADE,\n    usuario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    tipo text NOT NULL,\n    estado estado_invitacion DEFAULT 'pendiente',\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz,\n    UNIQUE (familia_id, usuario_id)\n);\n\nCREATE TABLE public.anuncio_familia (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    familia_id uuid REFERENCES public.familia(id) ON DELETE CASCADE,\n    autor_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    contenido text NOT NULL,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\n-- Sistema de Mensajería y Combate\nCREATE TABLE public.cola_misiones (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    usuario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    propiedad_origen_id uuid REFERENCES public.propiedad(id),\n    tipo_mision tipo_mision NOT NULL,\n    tropas jsonb NOT NULL,\n    recursos jsonb,\n    origen_ciudad integer NOT NULL,\n    origen_barrio integer NOT NULL,\n    origen_edificio integer NOT NULL,\n    destino_ciudad integer NOT NULL,\n    destino_barrio integer NOT NULL,\n    destino_edificio integer NOT NULL,\n    fecha_inicio timestamptz NOT NULL,\n    fecha_llegada timestamptz NOT NULL,\n    fecha_regreso timestamptz,\n    velocidad_flota integer NOT NULL,\n    duracion_viaje integer NOT NULL,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.cola_eventos_flota (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    datos jsonb NOT NULL,\n    estado text DEFAULT 'en_cola',\n    fecha_ejecucion timestamptz,\n    fecha_creacion timestamptz\n);\n\nCREATE TABLE public.informe_batalla (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    atacante_id uuid REFERENCES public.usuario(id),\n    defensor_id uuid REFERENCES public.usuario(id),\n    coordenada_ciudad integer NOT NULL,\n    coordenada_barrio integer NOT NULL,\n    coordenada_edificio integer NOT NULL,\n    ganador text NOT NULL,\n    detalles jsonb NOT NULL,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.informe_espionaje (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    atacante_id uuid REFERENCES public.usuario(id),\n    defensor_id uuid REFERENCES public.usuario(id),\n    detalles jsonb NOT NULL,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.mensaje (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    remitente_id uuid REFERENCES public.usuario(id) ON DELETE SET NULL,\n    destinatario_id uuid REFERENCES public.usuario(id) ON DELETE CASCADE,\n    asunto text NOT NULL,\n    contenido text NOT NULL,\n    categoria categoria_mensaje DEFAULT 'jugador',\n    informe_batalla_id uuid REFERENCES public.informe_batalla(id) ON DELETE SET NULL,\n    informe_espionaje_id uuid REFERENCES public.informe_espionaje(id) ON DELETE SET NULL,\n    leido boolean DEFAULT false,\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n\nCREATE TABLE public.ataque_entrante (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    defensor_id uuid REFERENCES public.usuario(id),\n    atacante_id uuid REFERENCES public.usuario(id),\n    nombre_atacante text NOT NULL,\n    propiedad_objetivo text NOT NULL,\n    total_tropas integer NOT NULL,\n    fecha_llegada timestamptz NOT NULL,\n    mision_id uuid REFERENCES public.cola_misiones(id),\n    fecha_creacion timestamptz,\n    fecha_actualizacion timestamptz\n);\n",
    "summary": {
        "tables_created": [
            "anuncio_familia",
            "ataque_entrante",
            "cola_construccion",
            "cola_eventos_flota",
            "cola_investigacion",
            "cola_misiones",
            "cola_reclutamiento",
            "configuracion_entrenamiento",
            "configuracion_habitacion",
            "configuracion_tropa",
            "entrenamiento_usuario",
            "errores_configuracion",
            "familia",
            "habitacion_usuario",
            "historial_acceso",
            "informe_batalla",
            "informe_espionaje",
            "invitacion_familia",
            "mensaje",
            "miembro_familia",
            "propiedad",
            "puntuacion_usuario",
            "requisito_entrenamiento",
            "requisito_habitacion",
            "tropa_bonus_contrincante",
            "tropa_propiedad",
            "tropa_seguridad_propiedad",
            "usuario"
        ],
        "functions_created": []
    }
}