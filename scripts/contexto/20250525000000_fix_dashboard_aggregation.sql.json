{
    "filename": "20250525000000_fix_dashboard_aggregation.sql",
    "timestamp": "2025-05-25T00:00:00",
    "content": "-- Fix for 42803: Move ORDER BY inside json_agg\n-- Replaces get_dashboard_data to correct aggregation logic\n\nCREATE OR REPLACE FUNCTION public.get_dashboard_data(p_propiedad_id uuid)\nRETURNS json AS $$\nDECLARE\n    v_propiedad record;\n    v_edificios json;\n    v_cola_construccion json;\n    v_cola_investigacion json;\n    v_cola_reclutamiento json;\n    v_produccion_armas real;\n    v_produccion_municion real;\n    v_produccion_alcohol real;\n    v_produccion_dolares real;\n    v_capacidad_armas bigint;\n    v_capacidad_municion bigint;\n    v_capacidad_alcohol bigint;\n    v_capacidad_dolares bigint;\n    v_puntuacion_usuario real;\n    v_usuario_id uuid;\nBEGIN\n    -- 0. Verificar propiedad y obtener usuario_id\n    SELECT usuario_id INTO v_usuario_id FROM public.propiedad WHERE id = p_propiedad_id;\n\n    IF v_usuario_id IS NULL THEN\n        RETURN json_build_object('error', 'Propiedad no encontrada');\n    END IF;\n\n    -- Seguridad: Verificar que el usuario sea el dueño\n    -- Nota: procesar_colas_propiedad ya verifica esto, pero get_dashboard_data podría ser llamada por otra función.\n    -- Dado que es SECURITY DEFINER, verificamos manualmente si se expone.\n    IF v_usuario_id != auth.uid() THEN\n        -- Si se llama como usuario autenticado, verificamos.\n        RETURN json_build_object('error', 'No autorizado');\n    END IF;\n\n    -- 1. Procesar colas y materializar recursos\n    PERFORM public.procesar_colas_propiedad(p_propiedad_id);\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- 2. Obtener datos de la propiedad actualizados\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- 3. Calcular producción y capacidad\n    SELECT\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'armas' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0),\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'municion' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0),\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'alcohol' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0),\n        COALESCE(SUM(CASE WHEN ch.recurso_producido = 'dolares_por_alcohol' THEN ch.produccion_base * hu.nivel ELSE 0 END), 0)\n    INTO\n        v_produccion_armas,\n        v_produccion_municion,\n        v_produccion_alcohol,\n        v_produccion_dolares\n    FROM public.habitacion_usuario hu\n    JOIN public.configuracion_habitacion ch ON hu.habitacion_id = ch.id\n    WHERE hu.propiedad_id = p_propiedad_id;\n\n    SELECT\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'almacen_de_armas' THEN hu.nivel * 10000 ELSE 0 END), 0),\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'deposito_de_municion' THEN hu.nivel * 10000 ELSE 0 END), 0),\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'almacen_de_alcohol' THEN hu.nivel * 10000 ELSE 0 END), 0),\n        10000 + COALESCE(SUM(CASE WHEN hu.habitacion_id = 'caja_fuerte' THEN hu.nivel * 10000 ELSE 0 END), 0)\n    INTO\n        v_capacidad_armas,\n        v_capacidad_municion,\n        v_capacidad_alcohol,\n        v_capacidad_dolares\n    FROM public.habitacion_usuario hu\n    WHERE hu.propiedad_id = p_propiedad_id;\n\n    -- 4. Obtener edificios (joined con configuracion para nombres)\n    SELECT json_agg(json_build_object(\n        'id', hu.habitacion_id,\n        'nivel', hu.nivel,\n        'nombre', ch.nombre\n    )) INTO v_edificios\n    FROM public.habitacion_usuario hu\n    JOIN public.configuracion_habitacion ch ON hu.habitacion_id = ch.id\n    WHERE hu.propiedad_id = p_propiedad_id;\n\n    -- 5. Obtener colas (joined con configuracion para nombres)\n    -- CORRECCION: ORDER BY movido dentro de json_agg para evitar error 42803\n    SELECT json_agg(json_build_object(\n        'id', cc.id,\n        'habitacion_id', cc.habitacion_id,\n        'nivel_destino', cc.nivel_destino,\n        'fecha_fin', cc.fecha_fin,\n        'nombre', ch.nombre\n    ) ORDER BY cc.fecha_fin) INTO v_cola_construccion\n    FROM public.cola_construccion cc\n    JOIN public.configuracion_habitacion ch ON cc.habitacion_id = ch.id\n    WHERE cc.propiedad_id = p_propiedad_id;\n\n    SELECT json_agg(json_build_object(\n        'id', ci.id,\n        'entrenamiento_id', ci.entrenamiento_id,\n        'nivel_destino', ci.nivel_destino,\n        'fecha_fin', ci.fecha_fin,\n        'nombre', ce.nombre\n    ) ORDER BY ci.fecha_fin) INTO v_cola_investigacion\n    FROM public.cola_investigacion ci\n    JOIN public.configuracion_entrenamiento ce ON ci.entrenamiento_id = ce.id\n    WHERE ci.propiedad_id = p_propiedad_id;\n\n    SELECT json_agg(json_build_object(\n        'id', cr.id,\n        'tropa_id', cr.tropa_id,\n        'cantidad', cr.cantidad,\n        'fecha_fin', cr.fecha_fin,\n        'nombre', ct.nombre\n    ) ORDER BY cr.fecha_fin) INTO v_cola_reclutamiento\n    FROM public.cola_reclutamiento cr\n    JOIN public.configuracion_tropa ct ON cr.tropa_id = ct.id\n    WHERE cr.propiedad_id = p_propiedad_id;\n\n    -- 6. Obtener puntuación de usuario\n    SELECT puntos_totales INTO v_puntuacion_usuario FROM public.puntuacion_usuario WHERE usuario_id = v_usuario_id;\n\n    -- Construir respuesta\n    RETURN json_build_object(\n        'propiedad', v_propiedad,\n        'recursos', json_build_object(\n            'armas', json_build_object('val', v_propiedad.armas, 'max', v_capacidad_armas, 'prod', v_produccion_armas),\n            'municion', json_build_object('val', v_propiedad.municion, 'max', v_capacidad_municion, 'prod', v_produccion_municion),\n            'alcohol', json_build_object('val', v_propiedad.alcohol, 'max', v_capacidad_alcohol, 'prod', v_produccion_alcohol),\n            'dolares', json_build_object('val', v_propiedad.dolares, 'max', v_capacidad_dolares, 'prod', v_produccion_dolares)\n        ),\n        'edificios', COALESCE(v_edificios, '[]'::json),\n        'colas', json_build_object(\n            'construccion', COALESCE(v_cola_construccion, '[]'::json),\n            'investigacion', COALESCE(v_cola_investigacion, '[]'::json),\n            'reclutamiento', COALESCE(v_cola_reclutamiento, '[]'::json)\n        ),\n        'puntos', COALESCE(v_puntuacion_usuario, 0)\n    );\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "get_dashboard_data"
        ]
    }
}