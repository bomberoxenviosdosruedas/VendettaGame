{
    "filename": "20250601000000_secure_rpc_search_path.sql",
    "timestamp": "2025-06-01T00:00:00",
    "content": "-- Fix RPC Security for Construction, Research, and Recruitment\n-- Reverting search_path to '' for strict security and explicit schema qualification.\n\n-- 1. Iniciar Construcción\nCREATE OR REPLACE FUNCTION public.iniciar_construccion_habitacion(p_propiedad_id uuid, p_habitacion_id text)\nRETURNS json AS $$\nDECLARE\n    v_configuracion_habitacion record;\n    v_propiedad record;\n    v_costo_total_armas bigint;\n    v_costo_total_municion bigint;\n    v_costo_total_dolares bigint;\n    v_fecha_inicio timestamptz;\n    v_fecha_fin timestamptz;\n    v_duracion_final integer;\n    v_nivel_oficina smallint;\n    v_factor_velocidad real := 1.0;\n    v_cola_count integer;\n    v_nivel_destino integer;\nBEGIN\n    -- Materializar recursos\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- Obtener configuración de la habitación y datos de la propiedad\n    SELECT * INTO v_configuracion_habitacion FROM public.configuracion_habitacion WHERE id = p_habitacion_id;\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Verificar requisitos previos\n    IF EXISTS (\n        SELECT 1\n        FROM public.requisito_habitacion rh\n        WHERE rh.habitacion_id = p_habitacion_id\n        AND NOT EXISTS (\n            SELECT 1\n            FROM public.habitacion_usuario hu\n            WHERE hu.propiedad_id = p_propiedad_id\n            AND hu.habitacion_id = rh.habitacion_requerida_id\n            AND hu.nivel >= rh.nivel_requerido\n        )\n    ) THEN\n        RETURN json_build_object('error', 'Requisitos de construcción no cumplidos.');\n    END IF;\n\n    -- Verificar cola llena\n    SELECT COUNT(*) INTO v_cola_count FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id;\n    IF v_cola_count >= 5 THEN\n        RETURN json_build_object('error', 'La cola de construcción está llena.');\n    END IF;\n\n    -- Calcular costos\n    v_costo_total_armas := v_configuracion_habitacion.costo_armas;\n    v_costo_total_municion := v_configuracion_habitacion.costo_municion;\n    v_costo_total_dolares := v_configuracion_habitacion.costo_dolares;\n\n    -- Verificar recursos suficientes\n    IF v_propiedad.armas < v_costo_total_armas OR v_propiedad.municion < v_costo_total_municion OR v_propiedad.dolares < v_costo_total_dolares THEN\n        RETURN json_build_object('error', 'Recursos insuficientes.');\n    END IF;\n\n    -- Deducir recursos\n    UPDATE public.propiedad\n    SET\n        armas = armas - v_costo_total_armas,\n        municion = municion - v_costo_total_municion,\n        dolares = dolares - v_costo_total_dolares\n    WHERE id = p_propiedad_id;\n\n    -- Calcular fecha de inicio y fin\n    SELECT COALESCE(MAX(fecha_fin), NOW()) INTO v_fecha_inicio FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id;\n\n    -- Aplicar factor de velocidad de la oficina\n    SELECT nivel INTO v_nivel_oficina FROM public.habitacion_usuario WHERE propiedad_id = p_propiedad_id AND habitacion_id = 'oficina_del_jefe';\n    IF v_nivel_oficina > 0 THEN\n        v_factor_velocidad := 1.0 - (v_nivel_oficina * 0.05); -- 5% de reducción por nivel\n    END IF;\n    v_duracion_final := v_configuracion_habitacion.duracion_construccion * v_factor_velocidad;\n    v_fecha_fin := v_fecha_inicio + make_interval(secs => v_duracion_final);\n\n    -- Calcular el nivel de destino correcto\n    SELECT\n        GREATEST(\n            (SELECT COALESCE(MAX(nivel), 0) FROM public.habitacion_usuario WHERE propiedad_id = p_propiedad_id AND habitacion_id = p_habitacion_id),\n            (SELECT COALESCE(MAX(nivel_destino), 0) FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id AND habitacion_id = p_habitacion_id)\n        ) + 1\n    INTO v_nivel_destino;\n\n    -- Insertar en la cola de construcción\n    INSERT INTO public.cola_construccion (propiedad_id, habitacion_id, nivel_destino, duracion_segundos, fecha_inicio, fecha_fin)\n    VALUES (p_propiedad_id, p_habitacion_id, v_nivel_destino, v_duracion_final, v_fecha_inicio, v_fecha_fin);\n\n    RETURN json_build_object('success', true, 'fecha_inicio', v_fecha_inicio, 'fecha_fin', v_fecha_fin);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';\n\n-- 2. Iniciar Entrenamiento\nCREATE OR REPLACE FUNCTION public.iniciar_entrenamiento(p_propiedad_id uuid, p_entrenamiento_id text)\nRETURNS json AS $$\nDECLARE\n    v_configuracion_entrenamiento record;\n    v_propiedad record;\n    v_usuario_id uuid;\nBEGIN\n    -- Materializar recursos\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- Obtener usuario_id de la propiedad\n    SELECT usuario_id INTO v_usuario_id FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Validar que no haya otra investigación en curso\n    IF EXISTS (SELECT 1 FROM public.cola_investigacion WHERE propiedad_id = p_propiedad_id) THEN\n        RETURN json_build_object('error', 'Ya hay una investigación en curso.');\n    END IF;\n\n    -- Obtener configuración y datos\n    SELECT * INTO v_configuracion_entrenamiento FROM public.configuracion_entrenamiento WHERE id = p_entrenamiento_id;\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Verificar requisitos\n    IF EXISTS (\n        SELECT 1\n        FROM public.requisito_entrenamiento re\n        WHERE re.entrenamiento_id = p_entrenamiento_id\n        AND NOT EXISTS (\n            SELECT 1\n            FROM public.entrenamiento_usuario eu\n            WHERE eu.usuario_id = v_usuario_id\n            AND eu.entrenamiento_id = re.entrenamiento_requerido_id\n            AND eu.nivel >= re.nivel_requerido\n        )\n    ) THEN\n        RETURN json_build_object('error', 'Requisitos de entrenamiento no cumplidos.');\n    END IF;\n\n    -- Verificar y deducir recursos\n    IF v_propiedad.armas < v_configuracion_entrenamiento.costo_armas OR v_propiedad.municion < v_configuracion_entrenamiento.costo_municion OR v_propiedad.dolares < v_configuracion_entrenamiento.costo_dolares THEN\n        RETURN json_build_object('error', 'Recursos insuficientes.');\n    END IF;\n\n    UPDATE public.propiedad\n    SET\n        armas = armas - v_configuracion_entrenamiento.costo_armas,\n        municion = municion - v_configuracion_entrenamiento.costo_municion,\n        dolares = dolares - v_configuracion_entrenamiento.costo_dolares\n    WHERE id = p_propiedad_id;\n\n    -- Insertar en la cola de investigación\n    INSERT INTO public.cola_investigacion (usuario_id, propiedad_id, entrenamiento_id, nivel_destino, fecha_inicio, fecha_fin)\n    VALUES (v_usuario_id, p_propiedad_id, p_entrenamiento_id, (SELECT COALESCE(MAX(nivel), 0) + 1 FROM public.entrenamiento_usuario WHERE usuario_id = v_usuario_id AND entrenamiento_id = p_entrenamiento_id), NOW(), NOW() + make_interval(secs => v_configuracion_entrenamiento.duracion_entrenamiento));\n\n    RETURN json_build_object('success', true);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';\n\n-- 3. Iniciar Reclutamiento\nCREATE OR REPLACE FUNCTION public.iniciar_reclutamiento(p_propiedad_id uuid, p_tropa_id text, p_cantidad integer)\nRETURNS json AS $$\nDECLARE\n    v_configuracion_tropa record;\n    v_propiedad record;\n    v_costo_total_armas bigint;\n    v_costo_total_municion bigint;\n    v_costo_total_dolares bigint;\nBEGIN\n    -- Materializar recursos\n    PERFORM public.materializar_recursos(p_propiedad_id);\n\n    -- Validar que no haya otro reclutamiento en curso\n    IF EXISTS (SELECT 1 FROM public.cola_reclutamiento WHERE propiedad_id = p_propiedad_id) THEN\n        RETURN json_build_object('error', 'Ya hay un reclutamiento en curso.');\n    END IF;\n\n    -- Obtener configuración y datos\n    SELECT * INTO v_configuracion_tropa FROM public.configuracion_tropa WHERE id = p_tropa_id;\n    SELECT * INTO v_propiedad FROM public.propiedad WHERE id = p_propiedad_id;\n\n    -- Calcular costos totales\n    v_costo_total_armas := v_configuracion_tropa.costo_armas * p_cantidad;\n    v_costo_total_municion := v_configuracion_tropa.costo_municion * p_cantidad;\n    v_costo_total_dolares := v_configuracion_tropa.costo_dolares * p_cantidad;\n\n    -- Verificar requisitos\n    IF EXISTS (\n        SELECT 1\n        FROM jsonb_each_text(v_configuracion_tropa.requisitos) AS req\n        WHERE NOT EXISTS (\n            SELECT 1\n            FROM public.habitacion_usuario hu\n            WHERE hu.propiedad_id = p_propiedad_id\n            AND hu.habitacion_id = req.key\n            AND hu.nivel >= (req.value)::integer\n        )\n    ) THEN\n        RETURN json_build_object('error', 'Requisitos de reclutamiento no cumplidos.');\n    END IF;\n\n    -- Verificar y deducir recursos\n    IF v_propiedad.armas < v_costo_total_armas OR v_propiedad.municion < v_costo_total_municion OR v_propiedad.dolares < v_costo_total_dolares THEN\n        RETURN json_build_object('error', 'Recursos insuficientes.');\n    END IF;\n\n    UPDATE public.propiedad\n    SET\n        armas = armas - v_costo_total_armas,\n        municion = municion - v_costo_total_municion,\n        dolares = dolares - v_costo_total_dolares\n    WHERE id = p_propiedad_id;\n\n    -- Insertar en la cola de reclutamiento\n    INSERT INTO public.cola_reclutamiento (propiedad_id, tropa_id, cantidad, fecha_inicio, fecha_fin)\n    VALUES (p_propiedad_id, p_tropa_id, p_cantidad, NOW(), NOW() + make_interval(secs => v_configuracion_tropa.duracion_reclutamiento * p_cantidad));\n\n    RETURN json_build_object('success', true);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "iniciar_construccion_habitacion",
            "iniciar_entrenamiento",
            "iniciar_reclutamiento"
        ]
    }
}