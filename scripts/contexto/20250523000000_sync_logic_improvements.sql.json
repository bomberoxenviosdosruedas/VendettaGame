{
    "filename": "20250523000000_sync_logic_improvements.sql",
    "timestamp": "2025-05-23T00:00:00",
    "content": "-- 20250523000000_sync_logic_improvements.sql\n\n-- 1. Fix: Inicializar ultima_recogida_recursos si es null para evitar bloqueo de producción\nUPDATE public.propiedad\nSET ultima_recogida_recursos = NOW()\nWHERE ultima_recogida_recursos IS NULL;\n\n-- 2. Función Lazy Update Scoped (Por Propiedad)\n-- Esta función procesa las colas SOLO para la propiedad específica, evitando iterar sobre toda la BD.\nCREATE OR REPLACE FUNCTION public.procesar_colas_propiedad(p_propiedad_id uuid)\nRETURNS void AS $$\nDECLARE\n    v_item_construccion record;\n    v_item_investigacion record;\n    v_item_reclutamiento record;\n    v_usuario_id uuid;\nBEGIN\n    -- Verificar propiedad de la propiedad\n    SELECT usuario_id INTO v_usuario_id FROM public.propiedad WHERE id = p_propiedad_id;\n\n    IF v_usuario_id IS NULL OR v_usuario_id != auth.uid() THEN\n        -- Si no existe o no es del usuario, no hacemos nada (seguridad silenciosa) o lanzamos error.\n        -- Para evitar leaks de informacion, simplemente retornamos.\n        RETURN;\n    END IF;\n\n    -- Procesar cola de construcción\n    FOR v_item_construccion IN SELECT * FROM public.cola_construccion WHERE propiedad_id = p_propiedad_id AND fecha_fin <= NOW() LOOP\n        IF EXISTS (SELECT 1 FROM public.habitacion_usuario WHERE propiedad_id = v_item_construccion.propiedad_id AND habitacion_id = v_item_construccion.habitacion_id) THEN\n            UPDATE public.habitacion_usuario SET nivel = nivel + 1 WHERE propiedad_id = v_item_construccion.propiedad_id AND habitacion_id = v_item_construccion.habitacion_id;\n        ELSE\n            INSERT INTO public.habitacion_usuario (propiedad_id, habitacion_id, nivel) VALUES (v_item_construccion.propiedad_id, v_item_construccion.habitacion_id, 1);\n        END IF;\n        DELETE FROM public.cola_construccion WHERE id = v_item_construccion.id;\n    END LOOP;\n\n    -- Procesar cola de investigación (Nota: la cola está vinculada a propiedad, el resultado a usuario)\n    FOR v_item_investigacion IN SELECT * FROM public.cola_investigacion WHERE propiedad_id = p_propiedad_id AND fecha_fin <= NOW() LOOP\n        INSERT INTO public.entrenamiento_usuario (usuario_id, entrenamiento_id, nivel)\n        VALUES (v_item_investigacion.usuario_id, v_item_investigacion.entrenamiento_id, 1)\n        ON CONFLICT (usuario_id, entrenamiento_id) DO UPDATE SET nivel = public.entrenamiento_usuario.nivel + 1;\n        DELETE FROM public.cola_investigacion WHERE id = v_item_investigacion.id;\n    END LOOP;\n\n    -- Procesar cola de reclutamiento\n    FOR v_item_reclutamiento IN SELECT * FROM public.cola_reclutamiento WHERE propiedad_id = p_propiedad_id AND fecha_fin <= NOW() LOOP\n        INSERT INTO public.tropa_propiedad (propiedad_id, tropa_id, cantidad)\n        VALUES (v_item_reclutamiento.propiedad_id, v_item_reclutamiento.tropa_id, v_item_reclutamiento.cantidad)\n        ON CONFLICT (propiedad_id, tropa_id) DO UPDATE SET cantidad = public.tropa_propiedad.cantidad + v_item_reclutamiento.cantidad;\n        DELETE FROM public.cola_reclutamiento WHERE id = v_item_reclutamiento.id;\n    END LOOP;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;\n\n\n-- 3. RPC para Iniciar Misión (Seguridad y Lógica)\nCREATE OR REPLACE FUNCTION public.iniciar_mision(\n    p_propiedad_origen_id uuid,\n    p_tipo_mision public.tipo_mision,\n    p_tropas jsonb, -- { \"tropa_id\": \"cantidad\" (como string o int) }\n    p_recursos jsonb, -- { \"armas\": 100 }\n    p_destino_ciudad integer,\n    p_destino_barrio integer,\n    p_destino_edificio integer,\n    p_velocidad_flota integer DEFAULT 100\n)\nRETURNS json AS $$\nDECLARE\n    v_propiedad_origen record;\n    v_tropa_key text;\n    v_cantidad_tropa_val jsonb;\n    v_cantidad_tropa int;\n    v_tropa_disponible int;\n    v_duracion_viaje int := 60; -- Placeholder: Calcular en base a distancia y velocidad\n    v_mission_id uuid;\nBEGIN\n    -- Verificar propiedad origen y pertenencia\n    SELECT * INTO v_propiedad_origen FROM public.propiedad WHERE id = p_propiedad_origen_id;\n\n    IF v_propiedad_origen IS NULL THEN\n        RETURN json_build_object('error', 'Propiedad no encontrada.');\n    END IF;\n\n    IF v_propiedad_origen.usuario_id != auth.uid() THEN\n         RETURN json_build_object('error', 'No eres el dueño de la propiedad de origen.');\n    END IF;\n\n    -- Validar y deducir tropas\n    -- Iteramos sobre las llaves del jsonb de tropas\n    FOR v_tropa_key IN SELECT jsonb_object_keys(p_tropas) LOOP\n        -- Obtener cantidad como entero (maneja si viene como string o numero)\n        v_cantidad_tropa := (p_tropas ->> v_tropa_key)::integer;\n\n        IF v_cantidad_tropa > 0 THEN\n            SELECT cantidad INTO v_tropa_disponible FROM public.tropa_propiedad\n            WHERE propiedad_id = p_propiedad_origen_id AND tropa_id = v_tropa_key;\n\n            IF COALESCE(v_tropa_disponible, 0) < v_cantidad_tropa THEN\n                RETURN json_build_object('error', 'Tropas insuficientes: ' || v_tropa_key);\n            END IF;\n\n            -- Deducir tropa\n            UPDATE public.tropa_propiedad\n            SET cantidad = cantidad - v_cantidad_tropa\n            WHERE propiedad_id = p_propiedad_origen_id AND tropa_id = v_tropa_key;\n        END IF;\n    END LOOP;\n\n    -- Insertar misión\n    INSERT INTO public.cola_misiones (\n        usuario_id, propiedad_origen_id, tipo_mision, tropas, recursos,\n        origen_ciudad, origen_barrio, origen_edificio,\n        destino_ciudad, destino_barrio, destino_edificio,\n        fecha_inicio, fecha_llegada, velocidad_flota, duracion_viaje\n    ) VALUES (\n        auth.uid(), p_propiedad_origen_id, p_tipo_mision, p_tropas, p_recursos,\n        v_propiedad_origen.coordenada_ciudad, v_propiedad_origen.coordenada_barrio, v_propiedad_origen.coordenada_edificio,\n        p_destino_ciudad, p_destino_barrio, p_destino_edificio,\n        NOW(), NOW() + make_interval(secs => v_duracion_viaje), p_velocidad_flota, v_duracion_viaje\n    ) RETURNING id INTO v_mission_id;\n\n    RETURN json_build_object('success', true, 'mision_id', v_mission_id);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;\n\n-- 4. Actualizar crear_propiedad_inicial para setear ultima_recogida_recursos\nCREATE OR REPLACE FUNCTION public.crear_propiedad_inicial(p_nombre text, p_ciudad integer, p_barrio integer, p_edificio integer)\nRETURNS json AS $$\nDECLARE\n    v_propiedad_id uuid;\nBEGIN\n    -- Verificar si el usuario ya tiene una propiedad\n    IF EXISTS (SELECT 1 FROM public.propiedad WHERE usuario_id = auth.uid()) THEN\n        RETURN json_build_object('error', 'El usuario ya tiene una propiedad.');\n    END IF;\n\n    -- Verificar unicidad de coordenadas\n    IF EXISTS (SELECT 1 FROM public.propiedad WHERE coordenada_ciudad = p_ciudad AND coordenada_barrio = p_barrio AND coordenada_edificio = p_edificio) THEN\n        RETURN json_build_object('error', 'Las coordenadas ya están ocupadas.');\n    END IF;\n\n    -- Insertar la nueva propiedad con timestamp inicial\n    INSERT INTO public.propiedad (usuario_id, nombre, coordenada_ciudad, coordenada_barrio, coordenada_edificio, armas, municion, alcohol, dolares, ultima_recogida_recursos)\n    VALUES (auth.uid(), p_nombre, p_ciudad, p_barrio, p_edificio, 500, 500, 500, 500, NOW())\n    RETURNING id INTO v_propiedad_id;\n\n    -- Insertar habitaciones iniciales\n    INSERT INTO public.habitacion_usuario (propiedad_id, habitacion_id, nivel)\n    VALUES\n        (v_propiedad_id, 'oficina_del_jefe', 1),\n        (v_propiedad_id, 'armeria', 1),\n        (v_propiedad_id, 'cerveceria', 1);\n\n    -- Actualizar el estado del primer login del usuario\n    UPDATE public.usuario SET primer_login = true WHERE id = auth.uid();\n\n    RETURN json_build_object('success', true, 'propiedad_id', v_propiedad_id);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "crear_propiedad_inicial",
            "iniciar_mision",
            "procesar_colas_propiedad"
        ]
    }
}