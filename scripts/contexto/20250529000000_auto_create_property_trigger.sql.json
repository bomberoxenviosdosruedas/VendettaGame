{
    "filename": "20250529000000_auto_create_property_trigger.sql",
    "timestamp": "2025-05-29T00:00:00",
    "content": "-- Migration: 20250529000000_auto_create_property_trigger.sql\n-- Description: Move property creation to handle_new_user trigger to ensure atomicity and robustness.\n\n-- 1. Refactor crear_propiedad_inicial to ensure it handles optional parameters and system execution\nCREATE OR REPLACE FUNCTION public.crear_propiedad_inicial(\n    p_nombre text DEFAULT NULL,\n    p_ciudad integer DEFAULT NULL,\n    p_barrio integer DEFAULT NULL,\n    p_edificio integer DEFAULT NULL,\n    p_usuario_id uuid DEFAULT NULL\n)\nRETURNS json AS $$\nDECLARE\n    v_propiedad_id uuid;\n    v_usuario_id uuid;\n    v_coords json;\n    v_ciudad int;\n    v_barrio int;\n    v_edificio int;\n    v_nombre text;\n    v_user_name text;\nBEGIN\n    -- Determinar usuario objetivo: param o sesi칩n\n    v_usuario_id := COALESCE(p_usuario_id, auth.uid());\n\n    IF v_usuario_id IS NULL THEN\n        RETURN json_build_object('error', 'Usuario no identificado');\n    END IF;\n\n    -- Verificar si el usuario ya tiene una propiedad\n    IF EXISTS (SELECT 1 FROM public.propiedad WHERE usuario_id = v_usuario_id) THEN\n        RETURN json_build_object('error', 'El usuario ya tiene una propiedad.');\n    END IF;\n\n    -- L칩gica de Coordenadas: Si vienen NULL, buscar libres\n    IF p_ciudad IS NULL OR p_barrio IS NULL OR p_edificio IS NULL THEN\n        v_coords := public.obtener_coordenada_libre();\n        IF v_coords->>'error' IS NOT NULL THEN\n            RETURN v_coords; -- Retornar el error de coordenadas\n        END IF;\n\n        v_ciudad := (v_coords->>'ciudad')::int;\n        v_barrio := (v_coords->>'barrio')::int;\n        v_edificio := (v_coords->>'edificio')::int;\n    ELSE\n        -- Usar las provistas\n        v_ciudad := p_ciudad;\n        v_barrio := p_barrio;\n        v_edificio := p_edificio;\n\n        -- Verificar unicidad de coordenadas provistas\n        IF EXISTS (SELECT 1 FROM public.propiedad WHERE coordenada_ciudad = v_ciudad AND coordenada_barrio = v_barrio AND coordenada_edificio = v_edificio) THEN\n            RETURN json_build_object('error', 'Las coordenadas ya est치n ocupadas.');\n        END IF;\n    END IF;\n\n    -- L칩gica de Nombre: Si viene NULL, generar\n    IF p_nombre IS NULL OR p_nombre = '' THEN\n        -- Intentar obtener nombre del usuario (corrigiendo bug de full_name que no existe en tabla usuario)\n        SELECT nombre_usuario INTO v_user_name FROM public.usuario WHERE id = v_usuario_id;\n        v_nombre := 'Base de ' || COALESCE(v_user_name, 'Operaciones');\n    ELSE\n        v_nombre := p_nombre;\n    END IF;\n\n    -- Insertar la nueva propiedad\n    INSERT INTO public.propiedad (usuario_id, nombre, coordenada_ciudad, coordenada_barrio, coordenada_edificio, armas, municion, alcohol, dolares, ultima_recogida_recursos)\n    VALUES (v_usuario_id, v_nombre, v_ciudad, v_barrio, v_edificio, 10000, 10000, 10000, 10000, NOW())\n    RETURNING id INTO v_propiedad_id;\n\n    -- Insertar habitaciones iniciales (7 edificios base)\n    INSERT INTO public.habitacion_usuario (propiedad_id, habitacion_id, nivel)\n    VALUES\n        (v_propiedad_id, 'oficina_del_jefe', 1),\n        (v_propiedad_id, 'escuela_especializacion', 1),\n        (v_propiedad_id, 'armeria', 1),\n        (v_propiedad_id, 'deposito_de_municion', 1),\n        (v_propiedad_id, 'cerveceria', 1),\n        (v_propiedad_id, 'taberna', 1),\n        (v_propiedad_id, 'campo_de_entrenamiento', 1);\n\n    -- Actualizar el estado del primer login del usuario (si aplica)\n    UPDATE public.usuario SET primer_login = true WHERE id = v_usuario_id;\n\n    RETURN json_build_object('success', true, 'propiedad_id', v_propiedad_id);\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;\n\n-- 2. Update handle_new_user to call crear_propiedad_inicial directly\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS trigger AS $$\nDECLARE\n    v_result json;\n    v_nombre_usuario text;\n    v_nombre_propiedad text;\nBEGIN\n  -- Determine username from metadata or email\n  v_nombre_usuario := COALESCE(\n      new.raw_user_meta_data->>'full_name',\n      SPLIT_PART(new.email, '@', 1) || '_' || SUBSTRING(MD5(RANDOM()::TEXT), 1, 6)\n  );\n\n  -- Insert into public.usuario\n  INSERT INTO public.usuario (id, email, nombre_usuario)\n  VALUES (\n    new.id,\n    new.email,\n    v_nombre_usuario\n  );\n\n  -- Insert into public.puntuacion_usuario\n  INSERT INTO public.puntuacion_usuario (usuario_id)\n  VALUES (new.id);\n\n  -- Create Initial Property\n  v_nombre_propiedad := 'Imperio de ' || v_nombre_usuario;\n\n  -- Call helper function\n  v_result := public.crear_propiedad_inicial(\n      p_nombre := v_nombre_propiedad,\n      p_ciudad := NULL, -- Auto-generate\n      p_barrio := NULL, -- Auto-generate\n      p_edificio := NULL, -- Auto-generate\n      p_usuario_id := new.id\n  );\n\n  -- Verify success\n  IF v_result->>'error' IS NOT NULL THEN\n      -- Raise exception to rollback user creation if property creation fails\n      RAISE EXCEPTION 'Error auto-creating property: %', v_result->>'error';\n  END IF;\n\n  RETURN new;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = '';\n\n-- 3. Cleanup: Remove the trigger on public.usuario as it is no longer needed\nDROP TRIGGER IF EXISTS trigger_crear_propiedad_automatica ON public.usuario;\nDROP FUNCTION IF EXISTS public.trigger_crear_propiedad_automatica_fn();\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "crear_propiedad_inicial",
            "handle_new_user"
        ]
    }
}