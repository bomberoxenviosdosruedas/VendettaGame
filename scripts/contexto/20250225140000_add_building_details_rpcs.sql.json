{
    "filename": "20250225140000_add_building_details_rpcs.sql",
    "timestamp": "2025-02-25T14:00:00",
    "content": "-- Migration to add RPCs for Building Details and Production Projection\n\nBEGIN;\n\n-- 1. Get Production Projection\n-- Calculates potential production for a building type for the next X levels\n-- Formula: Currently Linear (Base * Level) as placeholder for Legacy Logic.\n-- Can be updated to Exponential later without changing application code.\nCREATE OR REPLACE FUNCTION public.get_building_production_projection(\n    p_base_id uuid,\n    p_building_id text,\n    p_limit integer DEFAULT 10\n)\nRETURNS TABLE (\n    level integer,\n    production_hourly numeric,\n    resource_type text\n)\nLANGUAGE plpgsql\nSECURITY DEFINER\nSET search_path = ''\nAS $$\nDECLARE\n    v_config public.config_buildings%ROWTYPE;\n    v_current_level integer;\n    v_start_level integer;\n    v_base_prod integer;\n    v_resource_type text; -- Derived from ID or config? Config doesn't have type col in provided schema, but prompt mentions inference.\n    -- Wait, looking at legacy schema provided in 'recreate_legacy_schema.sql':\n    -- config_buildings columns: id, name, description, ..., base_production, points.\n    -- NO explicit 'resource_type' column.\n    -- The prompt says: \"Detecta el tipo de recurso basado en el nombre del edificio (armeria -> armas, taberna -> dolares...)\"\nBEGIN\n    SELECT * INTO v_config FROM public.config_buildings WHERE id = p_building_id;\n    IF NOT FOUND THEN\n        RETURN;\n    END IF;\n\n    -- Infer Resource Type logic (Hardcoded mapping for legacy parity)\n    IF p_building_id = 'armeria' THEN v_resource_type := 'armas';\n    ELSIF p_building_id = 'municion' THEN v_resource_type := 'municion';\n    ELSIF p_building_id = 'cerveceria' THEN v_resource_type := 'alcohol';\n    ELSIF p_building_id = 'taberna' THEN v_resource_type := 'dolares'; -- Production via conversion? Or direct? Prompt says \"traficas con Alcohol... beneficio a la caja\". Usually produces dollars.\n    ELSIF p_building_id = 'contrabando' THEN v_resource_type := 'dolares';\n    ELSE v_resource_type := NULL;\n    END IF;\n\n    -- If no production, return empty\n    IF v_config.base_production <= 0 THEN\n        RETURN;\n    END IF;\n\n    -- Get Current Level\n    SELECT level INTO v_current_level\n    FROM public.base_buildings\n    WHERE base_id = p_base_id AND building_id = p_building_id;\n\n    v_start_level := COALESCE(v_current_level, 0);\n\n    -- Generate Projection\n    FOR i IN 0..p_limit LOOP\n        level := v_start_level + i;\n\n        -- Formula: Base * Level (Hourly)\n        -- Note: Game uses per-second in backend typically, but prompt says \"Hora (Producción total teórica por hora)\".\n        -- If base_production is per hour? Or per second?\n        -- Schema comment says: \"base_production integer NOT NULL DEFAULT 0\".\n        -- Legacy config insert: \"armeria... base_production 10\". 10 what?\n        -- If 10/hour, it's very low. If 10/sec? Too high.\n        -- Let's assume the value in DB is \"Units per Hour\" for the display, or strictly follows legacy units.\n        -- Standard OGame/Vendetta clones usually store \"Base Production\" factor.\n        -- Let's assume: production = base_production * level * speed_factor?\n        -- For now: simple linear multiplication.\n\n        production_hourly := v_config.base_production * level;\n        resource_type := v_resource_type;\n\n        RETURN NEXT;\n    END LOOP;\nEND;\n$$;\n\nCOMMIT;\n",
    "summary": {
        "tables_created": [],
        "functions_created": [
            "get_building_production_projection"
        ]
    }
}